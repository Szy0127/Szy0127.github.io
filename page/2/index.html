<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"szy0127.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="S blog">
<meta property="og:url" content="http://szy0127.github.io/page/2/index.html">
<meta property="og:site_name" content="S blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="szy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://szy0127.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>S blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">S blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">szy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/cpp/C++20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/cpp/C++20%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">C++20高级编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-01-31 14:01:02 / Modified: 14:22:58" itemprop="dateCreated datePublished" datetime="2026-01-31T14:01:02+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>429</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="C-20高级编程"><a href="#C-20高级编程" class="headerlink" title="C++20高级编程"></a>C++20高级编程</h1><h2 id="类型与对象"><a href="#类型与对象" class="headerlink" title="类型与对象"></a>类型与对象</h2><ol>
<li><pre><code class="c++">template&lt;typename F,typename...Args&gt;
using result_of = decltype(std::declval&lt;F&gt;()(std::declval&lt;Args&gt;()...))
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. `std::pair a&#123;1,2.3&#125;` 类模板自动推导</span><br><span class="line"></span><br><span class="line">3. 运行时多态 传统面向对象编程 subtype多态 用指针 虚函数</span><br><span class="line"></span><br><span class="line">   用`std::variant` `std::visit` ad-hoc多态 性能更高 </span><br><span class="line"></span><br><span class="line">   看不同设计模式的要求</span><br><span class="line"></span><br><span class="line">   ```c++</span><br><span class="line">   struct Circle&#123;&#125;;</span><br><span class="line">   struct Rectangle&#123;&#125;;</span><br><span class="line">   double getArea(const Circle &amp;c);</span><br><span class="line">   double getArea(const Rectangle &amp;r);</span><br><span class="line">   using Shape = std::variant&lt;Circle,Rectangle&gt;;</span><br><span class="line">   double getArea(const Shape &amp;s)&#123;</span><br><span class="line">   	return std::visit(</span><br><span class="line">   		[](const auto&amp;data)&#123;</span><br><span class="line">   			return getArea(data);</span><br><span class="line">   		&#125;,s</span><br><span class="line">   	)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>查看类型-</p>
<ul>
<li><code>[[deprecated]]</code>表示弃用，可以通过编译器的警告来看</li>
<li>编译器提供的宏 <code>_PRETTY_FUNCTION_</code></li>
<li><a target="_blank" rel="noopener" href="https://cppinsights.io/">https://cppinsights.io</a></li>
</ul>
</li>
</ol>
<h2 id="编译时多态"><a href="#编译时多态" class="headerlink" title="编译时多态"></a>编译时多态</h2><ol start="5">
<li><p>函数:</p>
<ul>
<li>名称查找：ADL规则 不在作用域内的也可见</li>
<li>模板函数处理：推导 SFINAE  替换失败不会导致编译错误 只是放弃这个选择</li>
<li>重载决议：参数最匹配 转换最少；非模板优于模板</li>
</ul>
</li>
<li><p>type traits：输入类型 输出特征 变换类型</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">size_t</span> N&gt;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> fibonacci = fibonacci&lt;N<span class="number">-1</span>&gt; + fibonacci&lt;N<span class="number">-2</span>&gt;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> fibonacci&lt;<span class="number">0</span>&gt; = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> fibonacci&lt;<span class="number">1</span>&gt; = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">static_assert</span>(fibonacci&lt;<span class="number">10</span>&gt; == <span class="number">55</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[[no_unique_address]]</code>空基类优化成0字节</p>
</li>
<li><p><code>condition_t&lt;true,int,float&gt;</code> int</p>
</li>
<li><p>类型内省 通过模板偏特化拿到数组长度 函数参数类型等信息</p>
</li>
<li><p><code>enable_if</code>或标签分发 可用<code>if constexpr</code> 代替</p>
</li>
<li><p>奇异递归模板：把派生类作为基类的模板参数，让基类可用使用派生类提供的方法</p>
<p>可实现多态，避免虚函数开销</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Derived&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>&#123;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="built_in">static_cast</span>&lt;Derived&amp;&gt;(*<span class="keyword">this</span>).<span class="built_in">f_Impl</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span>: <span class="keyword">public</span> Base&lt;Derived&gt;&#123;</span><br><span class="line">    <span class="keyword">friend</span> Base;<span class="comment">//struct可以不用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f_Impl</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三路比较操作符<code>&lt;=&gt;</code> 默认强序 根据成员变量声明顺序比较</p>
</li>
<li><p><code>make_shared</code>比<code>new</code>效率高</p>
</li>
<li></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/cpp/C++1114%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/cpp/C++1114%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">C++11/14高级编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-01-31 14:01:02 / Modified: 14:22:58" itemprop="dateCreated datePublished" datetime="2026-01-31T14:01:02+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>228</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="C-11-14高级编程"><a href="#C-11-14高级编程" class="headerlink" title="C++11&#x2F;14高级编程"></a>C++11&#x2F;14高级编程</h1><ol>
<li><p>右值：临时变量，生命周期将要结束</p>
<p>可通过move延长生命周期 减少复制开销</p>
<p>完美转发：根据左值右值选择不同的重载函数</p>
</li>
<li><p><code>auto</code> 自动推断类型</p>
<p><code>decltype</code> 自动推断类型 类似<code>sizeof</code></p>
<p><code>decltype(auto)</code></p>
</li>
<li><p>大括号初始化 （生成<code>std::initializer_list</code>对象）</p>
<p>返回时也可以用大括号 会自动构造生成返回对象</p>
</li>
<li><p>基于范围for循环</p>
</li>
<li><p><code>constexpr</code> 编译器常量 可以修饰函数</p>
<p><code>const</code> 只表示只读 不表示常量 而是变量</p>
</li>
<li><p><code>static_assert</code>静态断言 </p>
</li>
<li><p>可变参数模板</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ... Args&gt;<span class="comment">//1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(Args... args)</span></span>&#123;<span class="comment">//2</span></span><br><span class="line">	<span class="built_in">g</span>(args...);<span class="comment">//3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lambda表达式<code>[]()&#123;&#125;</code></p>
<p>[]中捕获变量 声明时捕获</p>
<ul>
<li>&#x3D;拷贝所有 </li>
<li>&amp; 引用所有</li>
<li>var 拷贝某个值</li>
<li>&amp;var引用某个值</li>
<li>this</li>
</ul>
</li>
<li><p><code>thread_local</code> 修饰符 类似static  只在当前线程内修改可见</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/cpp/Effective%20Modern%20C++/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/cpp/Effective%20Modern%20C++/" class="post-title-link" itemprop="url">Effective Modern C++</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-01-31 14:01:02 / Modified: 14:22:58" itemprop="dateCreated datePublished" datetime="2026-01-31T14:01:02+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Effective-Modern-C"><a href="#Effective-Modern-C" class="headerlink" title="Effective Modern C++"></a>Effective Modern C++</h1><h2 id="型别推导"><a href="#型别推导" class="headerlink" title="型别推导"></a>型别推导</h2><ol>
<li><p>模板类型推导</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(ParamType param)</span></span>;</span><br></pre></td></tr></table></figure>

<p>模板T的类型与ParamType(修饰)是有关的</p>
<ul>
<li>无修饰：T不会带const 引用</li>
<li>参数是指针&#x2F;引用：T不带引用 如果参数修饰带const则T不带const</li>
<li>参数是万能引用(<code>T&amp;&amp;</code>)：T会和参数类型和传入的参数类型一模一样 带任何修饰  除了参数是右值的情况</li>
</ul>
</li>
<li><p><code>auto</code>的类型推导与模板一模一样</p>
<p><code>auto&amp;&amp;</code> 万能引用（带修饰  左值-&gt;左值 右值-&gt;右值）</p>
<p>直接用<code>auto</code> 不会带const 不会带引用（除非右边取地址）</p>
</li>
<li><p><code>decltype</code> 带修饰、引用、模板类型，一模一样</p>
<p><code>decltype(auto)</code>可以保证引用不被去除</p>
<p>特例：<code>decltype((x))</code>是<code>int&amp;</code></p>
</li>
<li><p><code>boost::typeindex::type_id_with_cvr&lt;decltype(x)&gt;().pretty_name()</code>可以精确地输出类型</p>
<p>IDE对于复杂类型不一定准确</p>
</li>
</ol>
<h2 id="auto"><a href="#auto" class="headerlink" title="auto"></a>auto</h2><ol start="5">
<li><p><code>auto</code>声明变量的好处：</p>
<ul>
<li><p>通过编译器优化时间空间上的处理（lambda表达式返回值是<code>std::function&lt;&gt;</code>）</p>
</li>
<li><p>避免自己搞错类型造成bug</p>
</li>
<li><p>避免const带来的额外复制开销</p>
</li>
</ul>
<p>副作用是没法一眼看出来类型  但是可以用过好的IDE缓和</p>
</li>
</ol>
<h2 id="转向现代C"><a href="#转向现代C" class="headerlink" title="转向现代C++"></a>转向现代C++</h2><ol start="6">
<li><p>某些库的实现为了时空性能会使用隐形代理，导致<code>auto</code>被推倒为应对客户隐藏的代理类</p>
<p>解决方法是使用<code>static_cast&lt;T&gt;</code>强制类型转换</p>
</li>
<li><p>大括号初始化最通用</p>
<p>某些情况下大括号小括号初始化有区别，例如<code>std::vector</code></p>
<p>可以使用auto先声明一个初始化列表 然后传入小括号</p>
</li>
<li><p><code>nullptr</code>代替0或NULL</p>
</li>
<li><p><code>using</code>替代<code>typedef</code></p>
<p>用模板推导的<code>T::type</code>声明前需要加<code>typename</code></p>
<p>模板元编程变换类型</p>
<p><code>std::remove_const_v&lt;T&gt;</code></p>
<p><code>std::remove_reference_v&lt;T&gt;</code></p>
<p><code>std::add_lvalue_reference_v&lt;T&gt;</code></p>
<p>给出一种实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">remove_reference</span>&lt;T&gt;&#123;</span><br><span class="line">	<span class="keyword">using</span> type = T;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">using</span> remove_reference_v = <span class="keyword">typename</span> remove_reference&lt;T&gt;::type </span><br></pre></td></tr></table></figure>
</li>
<li><p><code>enum class E&#123;a,b,c&#125;</code>好处</p>
<ul>
<li>限制了作用域 之后可以重名</li>
<li>强类型 不可以隐式转为int</li>
</ul>
</li>
<li><p><code>=delete</code>删除函数</p>
<ul>
<li>类的默认复制函数、拷贝构造函数</li>
<li>模板的某种特化版本</li>
<li>参数可被隐式转换的函数</li>
</ul>
</li>
<li><p><code>override</code>改写子类函数时加上，帮助编译器提示</p>
<p>在成员函数后加上<code>&amp;</code>或<code>&amp;&amp;</code>可以根据<code>(*this)</code>为左值或右值提供不同的重载实现</p>
</li>
<li><p><code>const_iterator</code> 例如<code>cbegin cend</code></p>
</li>
<li><p><code>noexcept</code>可能会被优化</p>
</li>
<li><p><code>constexpr</code>声明的变量或函数可以在编译器用 当作编译器常量 </p>
</li>
<li><p>线程安全</p>
</li>
<li><p><code>=default</code>生成类的默认移动函数（等）</p>
</li>
</ol>
<h2 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h2><p>裸指针的一些问题：无法判断是否空悬，无法判断如何析构</p>
<ol start="18">
<li><p><code>std::unique_ptr</code> 默认情况下和裸指针同样大小</p>
<p>可以自定义析构函数  但是会增加大小 自定义析构器的型别会导致智能指针型别不同 无法放在一个容器中</p>
<p>使用lambda捕获变量时更大</p>
</li>
<li><p><code>std::shared_ptr</code> 用原子操作计数 大小是裸指针的两倍</p>
<p>自定义析构器不会影响大小和型别</p>
</li>
<li><p><code>std::weak_ptr</code>解决<code>std::shared_ptr</code>环路</p>
</li>
<li><p><code>std::make_shared&lt;T&gt;()</code></p>
<ul>
<li><p>使用auto作为类型 避免重写两边T</p>
</li>
<li><p>避免new之后没有接受导致资源泄露</p>
</li>
<li><p>减小一次内存分配次数 提高性能</p>
</li>
</ul>
<p>但不支持自定义析构器，且默认用小括号初始化</p>
</li>
<li><p>Pimpl写法 需要把默认析构或其他函数的实现放在完整型别中。</p>
</li>
</ol>
<h2 id="右值引用、移动语义、完美转发"><a href="#右值引用、移动语义、完美转发" class="headerlink" title="右值引用、移动语义、完美转发"></a>右值引用、移动语义、完美转发</h2><ol start="23">
<li><code>std::move std::forward&lt;&gt;</code>只是强制类型转换</li>
<li><code>T&amp;&amp;``auto&amp;&amp;</code> 涉及类型推导时成为万能引用</li>
<li>某些情况下编译器会自行优化 用了<code>std::move</code>反而违反了优化的条件</li>
<li>重载一个万能引用的模板，可能会导致在意外地情况下匹配到</li>
<li>解决26的方法 加一个实现函数多一个参数 分派</li>
<li>引用折叠 引用的引用变为单个引用（右 右-&gt;右 其他左）</li>
<li>移动操作并不总能提高效率 需要相关型别支持移动语义</li>
<li>若干种使用完美转发的参数无法通过编译的情况<ul>
<li>大括号</li>
<li>static const 成员变量</li>
<li>重载函数</li>
<li>位域（一个变量的某些bit）</li>
</ul>
</li>
</ol>
<h2 id="lambda表达式"><a href="#lambda表达式" class="headerlink" title="lambda表达式"></a>lambda表达式</h2><ol start="31">
<li><p>引用捕获的变量离开作用域销毁后，可能导致lambda表达式内部的引用空悬</p>
<p>类里默认捕获会捕获this指针</p>
</li>
<li><p>初始化捕获<code>[a=a]</code>左边是lambda闭包作用域 右边是lambda能捕获的作用域</p>
<p>可以移动捕获</p>
</li>
<li><p>lambda实现完美转发  由于无模板T 故需要decltype</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> f = </span><br><span class="line">	[](<span class="keyword">auto</span>&amp;&amp;... params)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">func</span>(std::forward&lt;<span class="keyword">decltype</span>(params)&gt;(params)...);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用lambda表达式可以代替bind 给函数填入事先确定好的参数使用</p>
</li>
</ol>
<h2 id="并发API"><a href="#并发API" class="headerlink" title="并发API"></a>并发API</h2><ol start="35">
<li><p><code>std::async</code>相比直接开线程的好处：</p>
<ul>
<li>能够拿到返回值和异常</li>
<li>由C++标准库完成调度 避免超订 影响性能</li>
</ul>
</li>
<li><p><code>std::launch::async</code>才能保证一定开线程（并发）</p>
</li>
<li><p>必须保证创建<code>std::thread</code>的函数在任一返回路径前让其变为join或detach，否则如果这个线程引用了这个函数的局部变量 会导致意外的后果</p>
</li>
<li><p>future可能会发生阻塞 导致某些析构阻塞</p>
</li>
<li><p>线程同步的方法：</p>
<ul>
<li><p>使用<code>atomic&lt;bool&gt; flag</code> <code>while(!flag)</code>：缺点 占用资源</p>
</li>
<li><p>使用条件变量：缺点 需要一把互斥锁 两个线程必须竞争锁</p>
</li>
<li><p>使用<code>std::promise``std::future</code> 一次性通信</p>
<p>暂停：<code>p.get_future().wait()</code></p>
<p>继续：<code>p.set_value()</code></p>
</li>
</ul>
</li>
<li><p><code>std::atomic</code>多线程</p>
<p><code>volatile</code>特种内存 多条语句不会被编译器优化成一条</p>
</li>
</ol>
<h2 id="微调"><a href="#微调" class="headerlink" title="微调"></a>微调</h2><ol start="41">
<li>按值传递后用move再传入其他函数是一种30的解决方案</li>
<li><code>emplace</code>置入函数比<code>push</code>插入函数更高效（通常）</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/cpp/c++%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/cpp/c++%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">C++ Concurrency in Action</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-01-31 14:01:02 / Modified: 14:22:58" itemprop="dateCreated datePublished" datetime="2026-01-31T14:01:02+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>847</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="C-Concurrency-in-Action"><a href="#C-Concurrency-in-Action" class="headerlink" title="C++ Concurrency in Action"></a>C++ Concurrency in Action</h1><h2 id="Managing-threads"><a href="#Managing-threads" class="headerlink" title="Managing threads"></a>Managing threads</h2><ol>
<li><p><code>std::thread</code> 创建对象就会直接开始新线程。有默认构造函数 不会和任意线程绑定 需要通过move接受别的</p>
</li>
<li><p>必须使用join或者detach。 使用detach可成为守护线程，生命周期和程序一样长；为了避免exception导致没有join可以使用一个类，析构里join</p>
<p><code>std::for_each(threads.begin(),threads.end(),std::mem_fn(&amp;std::thread::join))</code></p>
</li>
<li><p><code>std::thread</code>默认copy参数，即使函数使用引用，如果要用引用需要手动加<code>std::ref</code></p>
</li>
<li><p>如果给的参数是创建线程的函数的临时变量，函数结束变量销毁可能导致线程的指针问题</p>
</li>
<li><p>如果需要用类的函数，语法为<code>std::thread(&amp;Object::f,&amp;object,a,b,c)</code> 类似<code>std::bind</code></p>
</li>
<li><p><code>std::thread</code>可以move不能copy 类似<code>std::ifstream</code> <code>std::unique_ptr</code></p>
<p>通过move转义控制权到另一个<code>std::thread</code>对象</p>
<p>当出现临时的<code>std::thread</code>对象时会隐式move</p>
<p>可以放在<code>std::vector</code>中</p>
</li>
<li><p><code>std::this_thread::get_id()</code>拿到<code>std::thread::id</code> 支持比较操作</p>
</li>
<li><p><code>std::this_thread::yield()</code>不同于sleep等信号打断或睡眠固定时间，此操作让出time slice 供cpu调度</p>
</li>
</ol>
<h2 id="Sharing-data-between-threads"><a href="#Sharing-data-between-threads" class="headerlink" title="Sharing data between threads"></a>Sharing data between threads</h2><ol start="9">
<li><p><code>std::mutex</code>有成员函数lock和unlock 但是不推荐使用 因为必须记得放锁</p>
<p>最好配合lock_guard等离开作用域自动放锁的对象一起用</p>
</li>
<li><p><code>boost::shared_lock&lt;boost::shared_mutex&gt;</code>访问只读对象，此时互斥锁会等待</p>
</li>
<li><p><code>std::lock</code>同时锁多个 避免死锁</p>
</li>
</ol>
<p><code>std::adopt_lock</code>作为参数不用等直接拿已经有的</p>
<ol start="12">
<li><p>不一定只有锁才会导致死锁，join或者wait都会，在设计时需要留意</p>
</li>
<li><p>一些避免死锁的guidelines  hierarchi  try_lock</p>
</li>
<li><p><code>std::unique_lock</code>可以用<code>std::defer_lock</code>作为第二个参数，先不拿锁，之后手动lock</p>
</li>
<li><p>锁的范围应该最小</p>
</li>
</ol>
<p><code>std::once_flag</code>配合<code>std::call_once</code>在任意多的线程中只执行一次，进行初始化的操作</p>
<ol start="16">
<li>允许多个同时读，但不允许多个写或读写一起,c++不提供，可以使用boost</li>
</ol>
<p>   读：<code>boost::shared_lock&lt;boost::shared_mutex&gt;</code></p>
<p>   写：<code>std::unique_lock&lt;boost::shared_mutex&gt;</code></p>
<h2 id="Synchronizing-concurrent-operations"><a href="#Synchronizing-concurrent-operations" class="headerlink" title="Synchronizing concurrent operations"></a>Synchronizing concurrent operations</h2><ol start="17">
<li><p><code>std::condition_variable</code> </p>
<p>wait 接受一个锁和一个lambda表达式作为参数 防止先notify再wait</p>
<p>notify_one&#x2F;notify_all 唤醒wait等待的线程</p>
</li>
<li><p><code>std::async</code>用法和<code>std::thread</code>用法一样，但不是返回线程，而是返回<code>std::future&lt;T&gt;</code></p>
<p>可以通过get方法拿到最后的返回值</p>
<p>可以增加参数 不立即执行 （实际上是否开线程不确定）</p>
</li>
<li><p><code>std::package_task&lt;&gt;</code> 接受函数作为参数，可以在适当的时候通过（）直接调用</p>
<p>get_future可以拿到future</p>
<p>想开线程执行一个函数 拿到返回值 可以先构造task 然后拿到future task传给thread执行，最后从future中拿出数据</p>
<p>返回类型可用<code>std::result_of&lt;&gt;</code></p>
</li>
<li><p><code>std::promise&lt;T&gt;</code>get_future拿到<code>std::future&lt;T&gt;</code></p>
<p>可以通过set_value在线程间传递数据</p>
</li>
<li><p>cv和future都可以wait_for&#x2F;wait_until设置timeout</p>
<p>返回<code>std::future_status</code> 可以判断timeout ready等状态</p>
</li>
</ol>
<h2 id="The-C-memory-model-and-operations-on-atomic-types"><a href="#The-C-memory-model-and-operations-on-atomic-types" class="headerlink" title="The C++ memory model and operations on atomic types"></a>The C++ memory model and operations on atomic types</h2><ol start="22">
<li><p><code>std::atomic&lt;T&gt;</code> 原子类型 有load store exchange等原子操作</p>
<p>is_lock_free判断是否需要锁保护</p>
</li>
<li><p>memory ordering 指定操作顺序 对于不同变量的操作可能是乱序的</p>
</li>
<li><p>通过原子操作可用不需要锁实现并发安全的数据结构</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/cpp/effectiveC++/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/cpp/effectiveC++/" class="post-title-link" itemprop="url">Effective C++</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-01-31 14:01:02 / Modified: 14:22:58" itemprop="dateCreated datePublished" datetime="2026-01-31T14:01:02+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>9 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Effective-C"><a href="#Effective-C" class="headerlink" title="Effective C++"></a>Effective C++</h1><h2 id="让自己习惯C"><a href="#让自己习惯C" class="headerlink" title="让自己习惯C++"></a>让自己习惯C++</h2><ol>
<li><ol>
<li>c++有4个主要的次语言</li>
</ol>
<ul>
<li>C 没有模板 异常 重载</li>
<li>C++ 类 封装 继承 多态 虚函数</li>
<li>Template 泛型</li>
<li>STL</li>
</ul>
<p>不同次语言有不同的规约，需要使用不同的处理方式（例如传值和传引用的效率）</p>
</li>
<li><p>#define 直接被替换 报错时找不到信息 并且占用内存可能反而更大</p>
<ul>
<li>const 取地址合法</li>
<li>enum 取地址不合法</li>
<li>inline</li>
</ul>
</li>
<li><p>用const修饰变量，函数等</p>
<p>返回的对象可以使用const修饰 避免 <code>if(a*b=c)</code></p>
<p>const可非const可重载</p>
<p>非const可转型为const</p>
</li>
<li><p>类的成员变量的初始化发生在进入构造函数之前，且一定按声明的顺序</p>
<p>使用初始化列表，内置类型也使用xx()的形式</p>
</li>
</ol>
<h2 id="构造-析构-赋值运算"><a href="#构造-析构-赋值运算" class="headerlink" title="构造&#x2F;析构&#x2F;赋值运算"></a>构造&#x2F;析构&#x2F;赋值运算</h2><ol start="5">
<li><p>默认构造函数会初始化基类和非静态成员变量，默认析构会自动调用析构（所以不用写），默认拷贝函数会复制每个非const对象</p>
<p>三种情况 不会生成默认拷贝函数</p>
<ul>
<li>有引用成员变量</li>
<li>有const成员变量</li>
<li>基类的拷贝函数为private</li>
</ul>
</li>
<li><p>不想使用默认的函数，可以声明为private</p>
</li>
<li><p>多态的基类的析构函数加virtual 避免用基类指针释放派生类对象出现内存泄漏</p>
<p>虚函数使用虚函数指针管理，会增加内存占用</p>
<p>如果基类的析构没有virtual 不适合派生，例如STL</p>
</li>
<li><p>在析构中catch异常，不向下传递</p>
</li>
<li><p>在派生类的构造&#x2F;析构函数调用基类的构造&#x2F;析构函数时，派生类的信息已经消失，所以在基类的构造&#x2F;析构函数中调用虚函数是无效的</p>
</li>
<li><p>为了实现连续赋值，让operator&#x3D;返回左值引用</p>
</li>
<li><p>operator&#x3D;的两个对象如果相同可能会出现删掉自己的问题 </p>
<p>解决方法如下：</p>
<ul>
<li>开头判断是否相等 如果相等直接返回    增加了取址 条件跳转 影响效率</li>
<li>调整顺序 先改再删 </li>
<li>用swap</li>
</ul>
</li>
<li><p>自定义拷贝构造函数和拷贝函数需要保证复制了每个成员变量，编译器不会提醒</p>
<ul>
<li>复制自己所有的成员变量</li>
<li>调用基类的拷贝构造函数 <code>XX::operator=(rhs)</code></li>
</ul>
<p>拷贝构造函数和拷贝函数重复的代码可用一个private的init函数来写</p>
</li>
</ol>
<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h2><p>除了内存，文件描述符，锁、连接、socket都是资源</p>
<ol start="13">
<li><p>在一个函数中，使用指针 最后delete 可能导致由于中间部分的问题而没有delete</p>
<p>使用智能指针管理，借助离开函数自动调用析构函数的机制 <code>std::auto_ptr&lt;A&gt; p(new A)</code></p>
<p>智能指针默认执行delete 而不是delete[] 无法管理数组</p>
<p>需要open close成对出现的资源 可以写在一个类中，close写在类的析构中，出现异常自动调用</p>
</li>
<li><p>资源管理类小心复制，可以直接禁止复制</p>
</li>
<li><p>虽然智能指针可以通过*或-&gt;像指针一样使用，但是<code>*A</code>与<code>std::auto_ptr&lt;A&gt;</code>类型并不相同，不能被函数接受</p>
<p>智能指针提供get方法拿到原始指针，但是这样用户会觉得麻烦</p>
<p>另一种方法是在类中定义隐式转换的函数 但这样会出现非预期的转换 造成bug</p>
</li>
<li><p>new delete ； new[]  delete[]  否则都会有bug</p>
<ul>
<li>多个构造函数用相同形式的new</li>
<li>使用typedef 注意是否是数组</li>
</ul>
</li>
<li><p>new得到的指针放入指针智能时使用独立语句，否则可能导致中间步骤的失败丢失new出来的指针</p>
</li>
</ol>
<h2 id="设计与声明"><a href="#设计与声明" class="headerlink" title="设计与声明"></a>设计与声明</h2><ol start="18">
<li><p>良好的接口不应该被误用，例如返回指针会导致没有delete&#x2F;delete两次&#x2F;错误方式delete等</p>
<p>可以返回一个智能指针，同时设置好deleter 强制让用户使用智能指针来接受</p>
<p>防止同类型的参数顺序出错，可以新声明几个类型，强制让用户使用新类型</p>
</li>
<li><p>设计class应该像设计type一样 考虑创建销毁 初始化赋值 传递 合法值 转换 操作符 接口等一系列问题</p>
</li>
<li><p>函数参数传递是按值传递，会调用构造函数，效率低，尽量使用引用传递，为了防止引用传递的后果 加const</p>
<p>这样做可以解决对象切割的问题，即使用基类对象接受派生类，依然可以正确找到派生类声明为virtual的函数</p>
<p>内置类型比较小 用引用涉及到指针反而慢， stl容器也尽量用值传递</p>
</li>
<li><p>函数的返回值也会涉及到构造与析构的浪费，但是此处并没有办法节省（除非返回值并不是函数生成的）</p>
<p>尝试方法与问题如下：</p>
<ul>
<li>栈上分配 返回引用   返回时已经销毁 拿到已经销毁的变量</li>
<li>堆上分配 返回指针   没人delete&#x2F;连续运算时丢失临时变量的指针</li>
<li>使用static     static对象只看现值 严重bug</li>
</ul>
</li>
<li><p>所有类的成员变量都应该是private 需要的话设置getter和setter通过函数访问</p>
<p>好处如下：</p>
<ul>
<li>提供的接口都是函数，统一使用括号访问</li>
<li>封装 可以随意修改实现方法</li>
<li>取消此变量后不会让客户代码与派生类代码发生破坏</li>
</ul>
</li>
<li><p>封装的内容越多，可访问内容的函数越少，改动影响的部分越少，可改动的弹性越大</p>
<p>所以在两个函数具有相同功能的时候，尽量使用non-member&#x2F;non-friend去替代member(成员)函数</p>
<p>可以使用namespace把工具函数和类放在同一区域中</p>
<p>不同的源文件不能切分类，但是可以使用同一个namespace 切分工具函数</p>
</li>
<li><p>如果一个函数的所有参数都需要类型转换，应该成为non-member</p>
<p>member函数一方是this 无法隐式转换</p>
</li>
<li><p>？ swap</p>
</li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><ol start="26">
<li><p>尽量延后变量定义式出现的时间，否则可能会由于中途的异常而没有使用却承担了构造析构的成本</p>
<p>直接给初值，而不是初始化之后再赋值</p>
<p>循环中需要的变量放在内还是外需要对比构造析构与赋值操作的时间，放内部不影响作用域及可理解性、易维护性</p>
</li>
<li><p>少转型 用新式转型替代旧式转型</p>
<p>转型不是只改变解释方式不改变数据，转型会生成代码（int和double的表示方式都不同）</p>
<ul>
<li>static_cast  强迫转型 但是在类的成员函数中转成基类调基类的函数会导致生成函数副本，使用错误的this</li>
<li>dynamic_cast 向下转型，可以通过基类派生类，但是效率不高，最好用virtual实现相同的功能</li>
</ul>
</li>
<li><p>避免返回handles（引用，指针，迭代器）</p>
<p>风险如下：</p>
<ul>
<li>操作了private成员&#x2F;声明为const的函数&#x2F;变量实际修改了内容</li>
<li>handles所指内容的主体已经被析构，造成空悬</li>
</ul>
<p>例外：string vector等容器的operator&#x3D;返回的是引用</p>
</li>
<li><p>函数需要异常安全</p>
<p>三个等级：</p>
<ul>
<li>基本：不破坏数据结构（例如资源泄露，打乱排序数组）</li>
<li>强烈：保证状态不变 可以通过copy-swap实现，及创建副本 修改在副本上 然后交换 但可能效率较低 复杂程度较高；并且，如果这个函数中调用了其他函数，但是其他函数并没有强烈的异常安全保证，自己也不行。</li>
<li>不抛异常</li>
</ul>
</li>
<li><p>inline 用函数本体替换每次调用的地方，编译时候完成，编译器会选择（太复杂或者virtual会拒绝）</p>
<ul>
<li><p>好处：减小函数调用的开销</p>
</li>
<li><p>坏处：可能增大字节码，修改后必须重新编译</p>
</li>
</ul>
</li>
<li><p>？传统的方式（.h&#x2F;.cpp）并没有编译依存最小化，仅仅修改一部分就需要全部编译</p>
<p>可通过以下两种方式解耦接口与实现：</p>
<ul>
<li>handle classes：通过组合方式，类A使用类AImpl完全其所有的函数</li>
<li>interface classes：通过继承方式，类A提供接口，全是纯虚函数，类B继承类A实现这些函数。</li>
</ul>
</li>
</ol>
<h2 id="继承与面向对象设计"><a href="#继承与面向对象设计" class="headerlink" title="继承与面向对象设计"></a>继承与面向对象设计</h2><ol start="32">
<li><p>public继承必须满足is-a的关系（里氏替换原则）</p>
</li>
<li><p>派生类函数会遮蔽基类的函数，具体情况为基类有多个重载的函数，派生类有一个同名的函数，那么基类的多个函数全被遮蔽（与virtual无关），如果是public继承则违反了is-a的关系 </p>
<p>解决方法是使用<code>using Base::f</code> 但这样会把所有的重载的f都拿到作用域中</p>
<p>如果只想用某一个，可以先用private继承，然后在同名函数中直接调用<code>Base::f()</code></p>
</li>
<li><p>区分接口继承和实现继承</p>
<p>用virtual 同时继承接口和实现，可以重写各自的实现，但问题是如果忘记重写了编译器并不会报错，而是会使用基类的函数</p>
<p>用pure virtual 可以强制让派生类提供实现，但是可能会出现相同代码</p>
<p>在基类中提供一个default版本的代码供派生类调用，但这样会多一个函数，且造成命名混乱</p>
<p>解决方法：给纯虚函数提供实现，派生类通过<code>Base::f()</code>调用此函数</p>
</li>
<li><p>？设计模式   替代virtual</p>
<p>private  virtual&#x2F;public non-virtual调用virtual</p>
</li>
<li><p>non-virtual函数不应该被重新定义</p>
</li>
<li><p>函数参数的缺省值是看静态类型的，所以virtual函数的参数缺省值只有基类起作用</p>
</li>
<li><p>复合  has-a</p>
</li>
<li><p>？private继承</p>
<p>private继承得到的接口都是private 禁止调用</p>
<p>在设计层面上无意义，只是方便实现</p>
<p>尽可能用复合而不是private继承</p>
<p>空对象也有大小</p>
</li>
<li><p>？多重继承</p>
<p>菱形继承 virtual继承</p>
</li>
</ol>
<h2 id="模板与泛型编程"><a href="#模板与泛型编程" class="headerlink" title="模板与泛型编程"></a>模板与泛型编程</h2><p>41. </p>
<p>42. </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/cpp/effectiveSTL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/cpp/effectiveSTL/" class="post-title-link" itemprop="url">effective STL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2026-01-31 14:01:02 / Modified: 14:22:58" itemprop="dateCreated datePublished" datetime="2026-01-31T14:01:02+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="effective-STL"><a href="#effective-STL" class="headerlink" title="effective STL"></a>effective STL</h1><h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><ol>
<li><p>选择容器</p>
</li>
<li><p>不同容器有不同的接口 没有办法编写独立于容器的代码</p>
</li>
<li><p>容器会默认拷贝，基类容器放入派生类会丢失信息（slicing） 解决方法是用指针</p>
<p>可以用空容器加reserve方法即拿到空间又避免创建空对象</p>
</li>
<li><p>用<code>empty()</code>代替<code>size()==0</code> 因为empty保证了常数时间而size对于某些容器不一定</p>
<p>对于list <code>splice</code>提供了常数时间的拼接 因此无法维护size是常数时间</p>
</li>
<li><p>对于区间操作，写法上避免的循环 更优雅，在效率上会优化</p>
<p>区间构造、插入、删除、赋值</p>
</li>
<li><p>编译器在分析时可能会把对象实例化分析成函数声明</p>
</li>
<li><p>使用new创建的对象需要在容器销毁前手动delete 最好的方法是用智能指针</p>
</li>
<li><p>不用auto_ptr</p>
</li>
<li><p>删除对象</p>
<table>
<thead>
<tr>
<th></th>
<th>某个值</th>
<th>某些条件</th>
</tr>
</thead>
<tbody><tr>
<td>vector string deque</td>
<td>erase-remove</td>
<td>erase-remove_if</td>
</tr>
<tr>
<td>list</td>
<td>remove</td>
<td>remove_if</td>
</tr>
<tr>
<td>set map</td>
<td>erase</td>
<td>遍历删除</td>
</tr>
</tbody></table>
<p>循环删除：迭代器+erase</p>
<ul>
<li>序列容器：用返回值更新迭代器</li>
<li>关联容器：迭代器后缀自增</li>
</ul>
</li>
<li><p>自定义allocater需要注意很多东西，例如接受的参数是T的个数，返回T*</p>
</li>
<li><p>自定义allocater的好处有 单线程时避免线程同步的开销、放入同一块堆等</p>
</li>
<li><p>STL容器并不能保证线程安全 需要自己加锁</p>
</li>
</ol>
<h2 id="vector和string"><a href="#vector和string" class="headerlink" title="vector和string"></a>vector和string</h2><ol start="13">
<li><p>用vector&#x2F;string代替动态数组 避免delete的麻烦</p>
<p>string某些实现会使用引用计数来优化，但多线程情况下会带来同步的额外开销</p>
</li>
<li><p>reserve避免不必要的重新分配空间</p>
</li>
<li><p>string的多种实现</p>
</li>
<li><p>兼容C API：</p>
<p>vector： <code>&amp;v[0]</code> 或<code>&amp;*v.begin()</code> 迭代器不是指针</p>
<p>string： <code>s.c_str()</code></p>
</li>
<li><p>删除元素后容器的最大容量并不改变，可以通过swap缩小</p>
<p><code>vector&lt;T&gt;(v).swap(v)</code></p>
</li>
<li><p><code>vector&lt;bool&gt;</code>每个bool占一个二进制位（位域思想）不满足STL标准  []返回代理对象</p>
<p>用<code>deque&lt;boo&gt;``bitset</code>替代</p>
</li>
</ol>
<h2 id="关联容器"><a href="#关联容器" class="headerlink" title="关联容器"></a>关联容器</h2><ol start="19">
<li><p>相等是数据相等 等价是自己定义的函数 成员函数与stl非成员函数方法不同</p>
</li>
<li><p>存指针需要指定比较函数 否则根据十六进制比较</p>
</li>
<li><p>比较函数需要保证让相等的值返回false 否则</p>
<p><code>!(a&lt;=b) &amp;&amp; !(b&lt;=a)</code> 在a&#x3D;b时会返回false</p>
</li>
<li><p>对于set 修改key(比较的部分)是很危险的</p>
<p>解决方法：</p>
<ul>
<li>找到对应元素 复制 修改 删除旧 插入新</li>
<li><code>const_cast&lt;T&amp;&gt;(*t).f()</code></li>
</ul>
</li>
<li><p><code>vector</code>使用二分查找的复杂度与关联容器一致，而在存储上更省空间，关联容器基于二叉树，需要额外两个指针。</p>
<p>因此vector可在每个page上放更多的对象，减少了page fault的次数 从而提高性能</p>
</li>
<li><p>[]会先插入（默认构造）再赋值 适合已经有元素的情况下使用</p>
<p>insert会构造pair再析构 适合在无元素的情况下使用</p>
</li>
<li><p>非标准散列容器</p>
</li>
</ol>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><ol start="26">
<li><p>使用iterator而不是其他的 例如const_iterator</p>
</li>
<li><p><code>advance(v.begin(),distance&lt;constIter&gt;(v.begin(),ci))</code> const_iterator去掉const</p>
</li>
<li><p><code>reverse_iterator.base()</code>拿到iterator 插入删除时注意位置</p>
</li>
<li><pre><code class="c++">ifstream inputFile(&quot;f.txt&quot;);
string fileData(
    (istreambuf_iterator&lt;char&gt;(inputFile)),
    istream_buf_iterator&lt;char&gt;()
);
</code></pre>
</li>
</ol>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><ol start="30">
<li><p><code>transform</code>对容器1的每个元素进行操作 结果放到容器2中</p>
<p><code>transform(v.begin(),v.end(),back_inserter(res),f)</code></p>
</li>
<li><p>完全排序：sort stable_sort</p>
<p>部分排序：partial_sort</p>
<p>找最前n个 不用排序：nth_element</p>
<p>满足条件的区分：partition stable_partition</p>
</li>
<li><p>remove没有办法真正删掉元素 只是改变了位置 </p>
<p>remove返回的迭代器是新的逻辑结尾 需要作为erase的第一个参数使用</p>
</li>
<li><p>如果管理的是指针 使用remove unique会导致资源泄露</p>
</li>
<li><p>有些函数只有在传入排序区间的情况下才能保证性能</p>
</li>
<li><p>默认字符串比较是大小写敏感的  可通过mismatch和tolower自己写一个忽略大小写的</p>
</li>
<li><p>copy_if</p>
</li>
<li><p>count count_if max_element</p>
<p>accumulate 自定义累加函数</p>
<p>for_each</p>
</li>
</ol>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><ol start="38">
<li><p>STL用到的函数都是按值传递的，因此需要保证小巧和单态</p>
</li>
<li><p>判别式（predicate）：返回bool的函数</p>
<p>纯函数：结果仅与参数与常数有关</p>
<p>判别式必须是纯函数 因为判别式会在某些STL函数中被复制使用</p>
</li>
<li><p><code>not1``not2</code>等函数配接器可以作用在函数外，配合find_if等函数使用</p>
<p>需要定义的函数继承<code>std::unary_function&lt;T,bool&gt;</code> 或套一层<code>ptr_fun</code></p>
</li>
<li><p>成员函数传给STL组件时使用<code>mem_fun</code> 可用于成员函数自测</p>
</li>
<li><p>让<code>less&lt;T&gt;</code>与operator&#x3D;含义相同</p>
</li>
</ol>
<h2 id="在程序中使用STL"><a href="#在程序中使用STL" class="headerlink" title="在程序中使用STL"></a>在程序中使用STL</h2><ol start="43">
<li><p>用算法避免循环 例如insert find for_each</p>
<ul>
<li>循环需要保证迭代器有效</li>
<li>算法实现者可以通过容器的实现细节提高遍历效率</li>
<li>算法名称表明意图</li>
</ul>
</li>
<li><p>选择容器的成员函数而不是普通的STL算法</p>
<p>容器的成员函数是针对容器实现的  效率和正确性都有保证</p>
</li>
<li><p>查找：</p>
<p>未排序：count 遍历所有 返回个数；find 找到第一个就返回迭代器  相等性</p>
<p>排序：lower_bound upper_bound equal_range 等价性</p>
<p>count &#x3D; equal_range + distance</p>
</li>
<li><p>STL组件传入函数对象而不是函数</p>
<p>函数对象的()方法可以内联直接被编译器使用</p>
<p>函数只能作为指针 每次都调用</p>
</li>
<li><p>使用STL算法会带来很多的嵌套调用 难以阅读 最好分步 但是仍不用循环</p>
</li>
<li><p>不同的平台可能会自动include某些头文件 因此为了方便移植 需要自己加</p>
</li>
<li><p>debug时可以用软件把很长的类型进行替换 方便看到核心的错误信息</p>
</li>
<li><p>站点</p>
</li>
</ol>
<p>​    </p>
<p>​    </p>
<p>​    </p>
<p>​    </p>
<p>​    </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2026/01/31/misc/network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/31/misc/network/" class="post-title-link" itemprop="url">Network</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2026-01-31 14:00:26" itemprop="dateCreated datePublished" datetime="2026-01-31T14:00:26+08:00">2026-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2026-02-02 00:55:43" itemprop="dateModified" datetime="2026-02-02T00:55:43+08:00">2026-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>681</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h1><h2 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h2><p>tracert 查看到目标主机经过的所有路由器及延迟</p>
<p>第n行表示第n个经过的路由器 每个测试3次</p>
<p>3n个测试每个都是独立的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">tracert i.sjtu.edu.cn</span><br><span class="line">通过最多 <span class="number">30</span> 个跃点跟踪</span><br><span class="line">到 i.sjtu.edu.cn [<span class="number">202.120</span><span class="type">.35.189</span>] 的路由:</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>     <span class="number">1</span> ms     <span class="number">1</span> ms     <span class="number">1</span> ms  <span class="number">192.168</span>.<span class="number">1.1</span></span><br><span class="line">  <span class="number">2</span>    <span class="number">11</span> ms    <span class="number">11</span> ms     <span class="number">4</span> ms  <span class="number">100.119</span>.<span class="number">0.1</span></span><br><span class="line">  <span class="number">3</span>     *        <span class="number">4</span> ms     <span class="number">3</span> ms  . [<span class="number">117.135</span><span class="type">.51.33</span>]</span><br><span class="line">  <span class="number">4</span>     <span class="number">4</span> ms     <span class="number">3</span> ms     <span class="number">3</span> ms  <span class="number">221.183</span>.<span class="number">53.229</span></span><br><span class="line">  <span class="number">5</span>     <span class="number">5</span> ms     *        *     <span class="number">221.183</span>.<span class="number">90.242</span></span><br><span class="line">  <span class="number">6</span>     <span class="number">6</span> ms     <span class="number">6</span> ms     <span class="number">6</span> ms  <span class="number">221.176</span>.<span class="number">23.98</span></span><br><span class="line">  <span class="number">7</span>     <span class="number">7</span> ms     <span class="number">7</span> ms     <span class="number">6</span> ms  <span class="number">101.4</span>.<span class="number">118.114</span></span><br><span class="line">  <span class="number">8</span>     *        *        *     请求超时。</span><br><span class="line">  <span class="number">9</span>     <span class="number">6</span> ms     <span class="number">5</span> ms     <span class="number">5</span> ms  <span class="number">202.112</span>.<span class="number">27.14</span></span><br><span class="line"> <span class="number">10</span>     <span class="number">6</span> ms     <span class="number">6</span> ms     <span class="number">5</span> ms  LAPTOP<span class="literal">-DFL6S3EU</span> [<span class="number">10.255</span><span class="type">.38.253</span>]</span><br><span class="line"> <span class="number">11</span>     <span class="number">7</span> ms     <span class="number">6</span> ms     <span class="number">6</span> ms  LAPTOP<span class="literal">-DFL6S3EU</span> [<span class="number">10.255</span><span class="type">.38.2</span>]</span><br><span class="line"> <span class="number">12</span>     <span class="number">8</span> ms    <span class="number">13</span> ms    <span class="number">11</span> ms  LAPTOP<span class="literal">-DFL6S3EU</span> [<span class="number">10.255</span><span class="type">.38.57</span>]</span><br><span class="line"> <span class="number">13</span>     *        *        *     请求超时。</span><br><span class="line"> <span class="number">14</span>     *        *        *     请求超时。</span><br><span class="line"> <span class="number">15</span>     <span class="number">6</span> ms     <span class="number">6</span> ms     <span class="number">6</span> ms  <span class="number">202.120</span>.<span class="number">35.189</span></span><br><span class="line"></span><br><span class="line">跟踪完成。</span><br></pre></td></tr></table></figure>

<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>telnet 在指定端口打开TCP连接</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">linux@LAPTOP<span class="literal">-DFL6S3EU</span>:<span class="variable">$</span> telnet <span class="number">119.3</span>.<span class="number">127.254</span> <span class="number">8080</span></span><br><span class="line">Trying <span class="number">119.3</span>.<span class="number">127.254</span>...</span><br><span class="line">Connected to <span class="number">119.3</span>.<span class="number">127.254</span>.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">GET /checkSession HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">119.3</span>.<span class="number">127.254</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span></span><br><span class="line">Vary: Origin</span><br><span class="line">Vary: Access<span class="literal">-Control-Request-Method</span></span><br><span class="line">Vary: Access<span class="literal">-Control-Request-Headers</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Transfer<span class="literal">-Encoding</span>: chunked</span><br><span class="line">Date: Thu, <span class="number">11</span> Aug <span class="number">2022</span> <span class="number">06</span>:<span class="number">42</span>:<span class="number">13</span> GMT</span><br><span class="line"></span><br><span class="line"><span class="number">47</span></span><br><span class="line">&#123;<span class="string">&quot;success&quot;</span>:false,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;登录失效，请重新登录！&quot;</span>,<span class="string">&quot;data&quot;</span>:null&#125;</span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h2><p>不同的mail server有不同的登录方式 </p>
<p>对于qq邮箱 需要拿到授权码 和qq号分别base64加密 auth login登录</p>
<p>data后可以通过from to 指定虚假的收件人 发件人</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">linux@LAPTOP<span class="literal">-DFL6S3EU</span>:/mnt/e/books/cs<span class="literal">-computer-networking</span><span class="variable">$</span> telnet smtp.qq.com <span class="number">25</span></span><br><span class="line">Trying <span class="number">2408</span>:<span class="number">8756</span>:<span class="number">2</span>cf2:<span class="number">19</span>::<span class="number">11</span>...</span><br><span class="line">Connected to smtp.qq.com.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line"><span class="number">220</span> newxmesmtplogicsvrsza31.qq.com XMail Esmtp QQ Mail Server.</span><br><span class="line">helo jjj</span><br><span class="line"><span class="number">250</span><span class="literal">-newxmesmtplogicsvrsza31</span>.qq.com<span class="literal">-11</span>.<span class="number">149.66</span>.<span class="number">240</span><span class="literal">-71806244</span></span><br><span class="line"><span class="number">250</span><span class="literal">-SIZE</span> <span class="number">73400320</span></span><br><span class="line"><span class="number">250</span> OK</span><br><span class="line">auth login</span><br><span class="line"><span class="number">334</span> VXNlcm5hbWU6</span><br><span class="line">MTc5OTg1MzUyMw==</span><br><span class="line"><span class="number">334</span> UGFzc3dvcmQ6</span><br><span class="line">YWNiaHd4dmJ5anN6ZWZmYg==</span><br><span class="line"><span class="number">235</span> Authentication successful</span><br><span class="line">mail from: &lt;<span class="number">1799853523</span>@qq.com&gt;</span><br><span class="line"><span class="number">250</span> OK</span><br><span class="line">rcpt to: &lt;<span class="number">734595697</span>@qq.com&gt;</span><br><span class="line"><span class="number">250</span> OK</span><br><span class="line"><span class="keyword">data</span></span><br><span class="line"><span class="number">354</span> <span class="keyword">End</span> <span class="keyword">data</span> with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;.</span><br><span class="line">subject: hello</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line"><span class="number">250</span> OK: queued as.</span><br><span class="line">quit</span><br><span class="line"><span class="number">221</span> Bye.</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p>DNS也算protocal 可在wireshark中捕捉到</p>
<p>nslookup</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt;nslookup i.sjtu.edu.cn</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  fe80::<span class="number">1</span></span><br><span class="line"></span><br><span class="line">非权威应答:</span><br><span class="line">名称:    i.sjtu.edu.cn</span><br><span class="line">Address:  <span class="number">202.120</span>.<span class="number">35.189</span></span><br><span class="line"></span><br><span class="line">&gt;nslookup <span class="literal">-type</span>=NS sjtu.edu.cn</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  fe80::<span class="number">1</span></span><br><span class="line"></span><br><span class="line">非权威应答:</span><br><span class="line">sjtu.edu.cn     nameserver = apple.sjtu.edu.cn</span><br><span class="line">sjtu.edu.cn     nameserver = dns.sjtu.edu.cn</span><br><span class="line"></span><br><span class="line">&gt;nslookup i.sjtu.edu.cn apple.sjtu.edu.cn</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  <span class="number">202.112</span>.<span class="number">26.43</span></span><br><span class="line"></span><br><span class="line">名称:    i.sjtu.edu.cn</span><br><span class="line">Address:  <span class="number">202.120</span>.<span class="number">35.189</span></span><br></pre></td></tr></table></figure>

<p>ipconfig</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Shen&gt;ipconfig /flushdns</span><br><span class="line"></span><br><span class="line">Windows IP 配置</span><br><span class="line"></span><br><span class="line">已成功刷新 DNS 解析缓存。</span><br><span class="line"></span><br><span class="line">C:\Users\Shen&gt;ipconfig /displaydns</span><br><span class="line"></span><br><span class="line">Windows IP 配置</span><br><span class="line"></span><br><span class="line">    <span class="number">153.109</span>.<span class="number">199.185</span>.in<span class="literal">-addr</span>.arpa</span><br><span class="line">    <span class="literal">----------------------------------------</span></span><br><span class="line">    记录名称. . . . . . . : <span class="number">153.109</span>.<span class="number">199.185</span>.in<span class="literal">-addr</span>.arpa.</span><br><span class="line">    记录类型. . . . . . . : <span class="number">12</span></span><br><span class="line">    生存时间. . . . . . . : <span class="number">516448</span></span><br><span class="line">    数据长度. . . . . . . : <span class="number">8</span></span><br><span class="line">    部分. . . . . . . . . : 答案</span><br><span class="line">    PTR 记录  . . . . . . : github.github.io</span><br></pre></td></tr></table></figure>



<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#client.py</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverName = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">serverPort = <span class="number">12000</span></span><br><span class="line">clientSocket = socket(AF_INET, SOCK_DGRAM)</span><br><span class="line">message = <span class="built_in">input</span>(<span class="string">&quot;Input lowercase sentence:&quot;</span>)</span><br><span class="line">clientSocket.sendto(message.encode(),(serverName, serverPort))</span><br><span class="line">modifiedMessage, serverAddress = clientSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line"><span class="built_in">print</span>(modifiedMessage.decode())</span><br><span class="line">clientSocket.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server.py</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverPort = <span class="number">12000</span></span><br><span class="line">serverSocket = socket(AF_INET, SOCK_DGRAM)</span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>, serverPort))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The server is ready to receive&quot;</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message, clientAddress = serverSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line">    <span class="built_in">print</span>(clientAddress)</span><br><span class="line">    modifiedMessage = message.decode().upper()</span><br><span class="line">    serverSocket.sendto(modifiedMessage.encode(), </span><br><span class="line">clientAddress)</span><br></pre></td></tr></table></figure>

<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#client.py</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverName = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">serverPort = <span class="number">12000</span></span><br><span class="line">clientSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">clientSocket.connect((serverName,serverPort))</span><br><span class="line">sentence = <span class="built_in">input</span>(<span class="string">&quot;Input lowercase sentence:&quot;</span>)</span><br><span class="line">clientSocket.send(sentence.encode())</span><br><span class="line">modifiedSentence = clientSocket.recv(<span class="number">1024</span>)</span><br><span class="line"><span class="built_in">print</span>(’From Server: ’, modifiedSentence.decode()) </span><br><span class="line">clientSocket.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server.py</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverPort = <span class="number">12000</span></span><br><span class="line">serverSocket = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>,serverPort))</span><br><span class="line">serverSocket.listen(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The server is ready to receive&quot;</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    connectionSocket, addr = serverSocket.accept()</span><br><span class="line">    sentence = connectionSocket.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    capitalizedSentence = sentence.upper()</span><br><span class="line">    connectionSocket.send(capitalizedSentence.encode()) </span><br><span class="line">    connectionSocket.close()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/virtualization/PKVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/virtualization/PKVM/" class="post-title-link" itemprop="url">PKVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:49:57 / Modified: 20:54:18" itemprop="dateCreated datePublished" datetime="2025-02-04T20:49:57+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>20 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="PKVM"><a href="#PKVM" class="headerlink" title="PKVM"></a>PKVM</h1><p>与传统的机密虚拟机区别的是 传统机密虚拟机用硬件加密保护内存 因此如果host恶意破坏 达到的只是DOS的目的</p>
<p>这并不在传统的机密虚拟机的威胁模型内</p>
<p>对于pkvm不利用硬件的机密虚拟机 必须保证页表完全在可信的EL2内完成</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/people/will/slides/kvmforum-2020-edited.pdf">https://mirrors.edge.kernel.org/pub/linux/kernel/people/will/slides/kvmforum-2020-edited.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://kvm-forum.qemu.org/2022/KVM%20forum%202022%20-%20pKVM%20deep%20dive.pdf">https://kvm-forum.qemu.org/2022/KVM%20forum%202022%20-%20pKVM%20deep%20dive.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/kvm-forum/2022/NYSM-NYD-KVM-2022.pdf">https://qemu-project.gitlab.io/kvm-forum/2022/NYSM-NYD-KVM-2022.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/836693/">https://lwn.net/Articles/836693/</a></p>
<blockquote>
<p>When a new guest is created, its memory will be unmapped from the host, which is not something that Linux can deal with.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/835342/">https://lwn.net/Articles/835342/</a></p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjlkYmNmOWZlZjk4MmYyMTU4YWIxYTkzMzQyMTcyNWNfWkt1TkpaaERZNURteFA1R2FhcFBpRnU0MzlOUXJDb1NfVG9rZW46TTByYmJSenhpb2JYUUp4YWlZcWNGa2drbnhjXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<ul>
<li>Extend world-switch code at EL2 to manage stage-2 page-tables and guest state ***</li>
<li>Install a stage-2 translation for the host kernel during boot before loading vendor modules *****</li>
<li>Message passing between host and VM ****</li>
<li>Template bootloader which accepts only signed VM images *</li>
<li>Formal verification techniques to reason about EL2 code *</li>
</ul>
<p>EL2可能会有的限制</p>
<ul>
<li>Not preemptible&#x2F;interruptible and unable to block&#x2F;schedule</li>
<li>Can access all of normal memory if mapped</li>
<li>Very limited device access; typically no console</li>
<li>Basically just context-switches EL1 and allows host kernel to run functions with elevated privilege</li>
<li>Tight coupling with host kernel</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTcxMWU3MjQ3NjRmODE0MTM0MWE4ZDgzZjNjZDVjMmZfbGZQbldPb0VRcjJndU9Nc2Q4cXJZanF1MHd1VElLRk9fVG9rZW46R2MzcGJWTTFUb1JER0N4NFo1b2NEc1Q5blZiXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<p>关于页表必须在EL2操作</p>
<blockquote>
<p>lifting the page-table code to run directly at EL2 on a non-VHE system (as we plan to to do in future</p>
<p>patches) is practically impossible due to the number of dependencies it has on the core kernel.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20200911132529.19844-1-will@kernel.org/T/#u">https://lore.kernel.org/all/20200911132529.19844-1-will@kernel.org/T/#u</a></p>
<p>percpu有什么问题 之后再看</p>
<p>保护磁盘文件</p>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/filesystems/fsverity.html">https://www.kernel.org/doc/html/latest/filesystems/fsverity.html</a></p>
<blockquote>
<p>A standard file hash could be used instead of fs-verity. However, this is inefficient if the file is large and only a small portion may be accessed. </p>
</blockquote>
<p>实际上大模型和推理框架的二进制文件只用两个hash就可以</p>
<p>VIRTIO_F_ACCESS_PLATFORM swiotlb&#x3D;force </p>
<blockquote>
<p>Expose SHARE&#x2F;UNSHARE hypercalls to the guest to update host stage-2.</p>
<p>Hook the set_memory_{decrypted,encrypted}() API to share&#x2F;unshare bounce buffer</p>
<p>pages</p>
</blockquote>
<p>SEV只需要改一个pte的bit即可加密 但是pkvm需要用hypercall 这边后续看看能否找到hook的代码 找不到手动加一下也不麻烦 参考这个</p>
<p><a target="_blank" rel="noopener" href="https://android-kvm.googlesource.com/linux/+/314641360847d8c84ceb913a4510521963eb6442%5E%21/#F5">https://android-kvm.googlesource.com/linux/+/314641360847d8c84ceb913a4510521963eb6442%5E%21/#F5</a></p>
<p><a target="_blank" rel="noopener" href="https://android-kvm.googlesource.com/linux/+/e7cf427f7b55583dd5be3752313765dd6fa4e4a1">https://android-kvm.googlesource.com/linux/+/e7cf427f7b55583dd5be3752313765dd6fa4e4a1</a></p>
<p><strong>pkvm-android-mainline-6.6 有这个代码</strong></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p><a target="_blank" rel="noopener" href="https://www.cl.cam.ac.uk/~pes20/Stuff/pkvm/notes37-2020-11-25-pkvm-code-overview.html#setup---stage-2-wrapping-the-host">https://www.cl.cam.ac.uk/~pes20/Stuff/pkvm/notes37-2020-11-25-pkvm-code-overview.html#setup---stage-2-wrapping-the-host</a></p>
<p><a target="_blank" rel="noopener" href="https://android-kvm.googlesource.com/linux/">https://android-kvm.googlesource.com/linux/</a></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDVkZGVkMmEwNjE2YzI1ZDBmNTcxYjFlZTEwMGEzNWJfa2FaS3FMWmpNRm9IdmFTRXpNbW55emhCUTNVWHB2VmdfVG9rZW46R2t6VmJaVTFpb0YwcmR4WFY2d2Nzalo5bjZlXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<h3 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFiYThkODQ5YjY2NTQ0NWI2NmZkZDFkMDc5NjY2MDJfbUVkUEU2ZGVTSzBqYlV6bDA2SlJFektPdmk2bG9pUk1fVG9rZW46VzdWZGI1b2dubzNCcUZ4ZFNIRGNHbmNpblhiXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<p>这个属性通过pkvm_getstate(kvm_pgtable_hyp_pte_prot(ctx-&gt;old));</p>
<p>放到pte中 用SW1和SW2保留位（bit55）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">pkvm_page_state</span> &#123;</span><br><span class="line">    PKVM_PAGE_OWNED         = <span class="number">0ULL</span>,</span><br><span class="line">    PKVM_PAGE_SHARED_OWNED      = KVM_PGTABLE_PROT_SW0,</span><br><span class="line">    PKVM_PAGE_SHARED_BORROWED   = KVM_PGTABLE_PROT_SW1,</span><br><span class="line">    __PKVM_PAGE_RESERVED        = KVM_PGTABLE_PROT_SW0 |</span><br><span class="line">                      KVM_PGTABLE_PROT_SW1,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Meta-states which aren&#x27;t encoded directly in the PTE&#x27;s SW bits */</span></span><br><span class="line">    PKVM_NOPAGE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="kvm页表"><a href="#kvm页表" class="headerlink" title="kvm页表"></a>kvm页表</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">kvm_pgtable_walk</span><span class="params">(<span class="keyword">struct</span> kvm_pgtable *pgt, u64 addr, u64 size,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="keyword">struct</span> kvm_pgtable_walker *walker)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walk_data</span> walk_data = &#123;</span><br><span class="line">                .start        = <span class="built_in">ALIGN_DOWN</span>(addr, PAGE_SIZE),</span><br><span class="line">                .addr        = <span class="built_in">ALIGN_DOWN</span>(addr, PAGE_SIZE),</span><br><span class="line">                .end        = <span class="built_in">PAGE_ALIGN</span>(walk_data.addr + size),</span><br><span class="line">                .walker        = walker,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">        r = <span class="built_in">kvm_pgtable_walk_begin</span>(walker);</span><br><span class="line">        <span class="keyword">if</span> (r)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">        r = _kvm_pgtable_walk(pgt, &amp;walk_data);</span><br><span class="line">        <span class="built_in">kvm_pgtable_walk_end</span>(walker);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __kvm_pgtable_visit(<span class="keyword">struct</span> kvm_pgtable_walk_data *data,</span><br><span class="line">                                      <span class="keyword">struct</span> kvm_pgtable_mm_ops *mm_ops,</span><br><span class="line">                                      <span class="type">kvm_pteref_t</span> pteref, s8 level)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_walk_flags</span> flags = data-&gt;walker-&gt;flags;</span><br><span class="line">        <span class="type">kvm_pte_t</span> *ptep = <span class="built_in">kvm_dereference_pteref</span>(data-&gt;walker, pteref);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_visit_ctx</span> ctx = &#123;</span><br><span class="line">                .ptep        = ptep,</span><br><span class="line">                .old        = <span class="built_in">READ_ONCE</span>(*ptep),</span><br><span class="line">                .arg        = data-&gt;walker-&gt;arg,</span><br><span class="line">                .mm_ops        = mm_ops,</span><br><span class="line">                .start        = data-&gt;start,</span><br><span class="line">                .addr        = data-&gt;addr,</span><br><span class="line">                .end        = data-&gt;end,</span><br><span class="line">                .level        = level,</span><br><span class="line">                .flags        = flags,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> reload = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">kvm_pteref_t</span> childp;</span><br><span class="line">        <span class="type">bool</span> table = <span class="built_in">kvm_pte_table</span>(ctx.old, level);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (table &amp;&amp; (ctx.flags &amp; KVM_PGTABLE_WALK_TABLE_PRE)) &#123;</span><br><span class="line">                ret = <span class="built_in">kvm_pgtable_visitor_cb</span>(data, &amp;ctx, KVM_PGTABLE_WALK_TABLE_PRE);</span><br><span class="line">                reload = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!table &amp;&amp; (ctx.flags &amp; KVM_PGTABLE_WALK_LEAF)) &#123;</span><br><span class="line">                ret = <span class="built_in">kvm_pgtable_visitor_cb</span>(data, &amp;ctx, KVM_PGTABLE_WALK_LEAF);</span><br><span class="line">                reload = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Reload the page table after invoking the walker callback for leaf</span></span><br><span class="line"><span class="comment">         * entries or after pre-order traversal, to allow the walker to descend</span></span><br><span class="line"><span class="comment">         * into a newly installed or replaced table.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (reload) &#123;</span><br><span class="line">                ctx.old = <span class="built_in">READ_ONCE</span>(*ptep);</span><br><span class="line">                table = <span class="built_in">kvm_pte_table</span>(ctx.old, level);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_continue</span>(data-&gt;walker, ret))</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!table) &#123;</span><br><span class="line">                data-&gt;addr = <span class="built_in">ALIGN_DOWN</span>(data-&gt;addr, <span class="built_in">kvm_granule_size</span>(level));</span><br><span class="line">                data-&gt;addr += <span class="built_in">kvm_granule_size</span>(level);</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        childp = (<span class="type">kvm_pteref_t</span>)<span class="built_in">kvm_pte_follow</span>(ctx.old, mm_ops);</span><br><span class="line">        ret = __kvm_pgtable_walk(data, mm_ops, childp, level + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_continue</span>(data-&gt;walker, ret))</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx.flags &amp; KVM_PGTABLE_WALK_TABLE_POST)</span><br><span class="line">                ret = <span class="built_in">kvm_pgtable_visitor_cb</span>(data, &amp;ctx, KVM_PGTABLE_WALK_TABLE_POST);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">kvm_pgtable_walk_continue</span>(data-&gt;walker, ret))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">kvm_pgtable_visitor_cb</span><span class="params">(<span class="keyword">struct</span> kvm_pgtable_walk_data *data,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="keyword">enum</span> kvm_pgtable_walk_flags visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walker</span> *walker = data-&gt;walker;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Ensure the appropriate lock is held (e.g. RCU lock for stage-2 MMU) */</span></span><br><span class="line">        <span class="built_in">WARN_ON_ONCE</span>(<span class="built_in">kvm_pgtable_walk_shared</span>(ctx) &amp;&amp; !<span class="built_in">kvm_pgtable_walk_lock_held</span>());</span><br><span class="line">        <span class="keyword">return</span> walker-&gt;<span class="built_in">cb</span>(ctx, visit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="donate"><a href="#donate" class="headerlink" title="donate"></a>donate</h4><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/arch/arm64/kvm/hyp/nvhe/mem_protect.c">https://github.com/torvalds/linux/blob/master/arch/arm64/kvm/hyp/nvhe/mem_protect.c</a></p>
<p>__pkvm_owner1_donate_owner2</p>
<p>把owner1的内存给owner2</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __pkvm_host_donate_hyp(u64 pfn, u64 nr_pages)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        u64 host_addr = <span class="built_in">hyp_pfn_to_phys</span>(pfn);</span><br><span class="line">        u64 hyp_addr = (u64)__hyp_va(host_addr);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">pkvm_mem_donation</span> donation = &#123;</span><br><span class="line">                .tx        = &#123;</span><br><span class="line">                        .nr_pages        = nr_pages,</span><br><span class="line">                        .initiator        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HOST,</span><br><span class="line">                                .addr        = host_addr,</span><br><span class="line">                                .host        = &#123;</span><br><span class="line">                                        .completer_addr = hyp_addr,</span><br><span class="line">                                &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        .completer        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HYP,</span><br><span class="line">                        &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">host_lock_component</span>();</span><br><span class="line">        <span class="built_in">hyp_lock_component</span>();</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">do_donate</span>(&amp;donation);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">hyp_unlock_component</span>();</span><br><span class="line">        <span class="built_in">host_unlock_component</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __pkvm_hyp_donate_host(u64 pfn, u64 nr_pages)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        u64 host_addr = <span class="built_in">hyp_pfn_to_phys</span>(pfn);</span><br><span class="line">        u64 hyp_addr = (u64)__hyp_va(host_addr);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">pkvm_mem_donation</span> donation = &#123;</span><br><span class="line">                .tx        = &#123;</span><br><span class="line">                        .nr_pages        = nr_pages,</span><br><span class="line">                        .initiator        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HYP,</span><br><span class="line">                                .addr        = hyp_addr,</span><br><span class="line">                                .hyp        = &#123;</span><br><span class="line">                                        .completer_addr = host_addr,</span><br><span class="line">                                &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        .completer        = &#123;</span><br><span class="line">                                .id        = PKVM_ID_HOST,</span><br><span class="line">                        &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">host_lock_component</span>();</span><br><span class="line">        <span class="built_in">hyp_lock_component</span>();</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">do_donate</span>(&amp;donation);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">hyp_unlock_component</span>();</span><br><span class="line">        <span class="built_in">host_unlock_component</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __do_donate(<span class="keyword">struct</span> pkvm_mem_donation *donation)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">pkvm_mem_transition</span> *tx = &amp;donation-&gt;tx;</span><br><span class="line">    u64 completer_addr;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tx-&gt;initiator.id) &#123;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HOST:</span><br><span class="line">        ret = <span class="built_in">host_initiate_donation</span>(&amp;completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HYP:</span><br><span class="line">        ret = <span class="built_in">hyp_initiate_donation</span>(&amp;completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tx-&gt;completer.id) &#123;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HOST:</span><br><span class="line">        ret = <span class="built_in">host_complete_donation</span>(completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_HYP:</span><br><span class="line">        ret = <span class="built_in">hyp_complete_donation</span>(completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PKVM_ID_GUEST:</span><br><span class="line">        ret = <span class="built_in">guest_complete_donation</span>(completer_addr, tx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_initiate_donation</span><span class="params">(u64 *completer_addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u8 owner_id = tx-&gt;completer.id;</span><br><span class="line">        u64 size = tx-&gt;nr_pages * PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        *completer_addr = tx-&gt;initiator.host.completer_addr;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_set_owner_locked</span>(tx-&gt;initiator.addr, size, owner_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">hyp_initiate_donation</span><span class="params">(u64 *completer_addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u64 size = tx-&gt;nr_pages * PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">        *completer_addr = tx-&gt;initiator.hyp.completer_addr;</span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_hyp_unmap</span>(&amp;pkvm_pgtable, tx-&gt;initiator.addr, size);</span><br><span class="line">        <span class="keyword">return</span> (ret != size) ? -EFAULT : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_complete_donation</span><span class="params">(u64 addr, <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        u64 size = tx-&gt;nr_pages * PAGE_SIZE;</span><br><span class="line">        u8 host_id = tx-&gt;completer.id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_set_owner_locked</span>(addr, size, host_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">hyp_complete_donation</span><span class="params">(u64 addr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> <span class="keyword">struct</span> pkvm_mem_transition *tx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">void</span> *start = (<span class="type">void</span> *)addr, *end = start + (tx-&gt;nr_pages * PAGE_SIZE);</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot = <span class="built_in">pkvm_mkstate</span>(PAGE_HYP, PKVM_PAGE_OWNED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pkvm_create_mappings_locked</span>(start, end, prot);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * kvm_pgtable_stage2_set_owner() - Unmap and annotate pages in the IPA space to</span></span><br><span class="line"><span class="comment"> *                  track ownership.</span></span><br><span class="line"><span class="comment"> * @pgt:    Page-table structure initialised by kvm_pgtable_stage2_init*().</span></span><br><span class="line"><span class="comment"> * @addr:   Base intermediate physical address to annotate.</span></span><br><span class="line"><span class="comment"> * @size:   Size of the annotated range.</span></span><br><span class="line"><span class="comment"> * @mc:     Cache of pre-allocated and zeroed memory from which to allocate</span></span><br><span class="line"><span class="comment"> *      page-table pages.</span></span><br><span class="line"><span class="comment"> * @owner_id:   Unique identifier for the owner of the page.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * By default, all page-tables are owned by identifier 0. This function can be</span></span><br><span class="line"><span class="comment"> * used to mark portions of the IPA space as owned by other entities. When a</span></span><br><span class="line"><span class="comment"> * stage 2 is used with identity-mappings, these annotations allow to use the</span></span><br><span class="line"><span class="comment"> * page-table data structure as a simple rmap.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: 0 on success, negative error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">host_stage2_set_owner_locked</span><span class="params">(<span class="type">phys_addr_t</span> addr, u64 size, u8 owner_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_try</span>(kvm_pgtable_stage2_set_owner, &amp;host_mmu.pgt,</span><br><span class="line">                               addr, size, &amp;host_s2_pool, owner_id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">kvm_pgtable_stage2_set_owner</span><span class="params">(<span class="keyword">struct</span> kvm_pgtable *pgt, u64 addr, u64 size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">void</span> *mc, u8 owner_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stage2_map_data</span> map_data = &#123;</span><br><span class="line">                .phys                = KVM_PHYS_INVALID,</span><br><span class="line">                .mmu                = pgt-&gt;mmu,</span><br><span class="line">                .memcache        = mc,</span><br><span class="line">                .owner_id        = owner_id,</span><br><span class="line">                .force_pte        = <span class="literal">true</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walker</span> walker = &#123;</span><br><span class="line">                .cb                = stage2_map_walker,</span><br><span class="line">                .flags                = KVM_PGTABLE_WALK_TABLE_PRE |</span><br><span class="line">                                  KVM_PGTABLE_WALK_LEAF,</span><br><span class="line">                .arg                = &amp;map_data,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (owner_id &gt; KVM_MAX_OWNER_ID)</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_walk</span>(pgt, addr, size, &amp;walker);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">stage2_map_walker</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">enum</span> kvm_pgtable_walk_flags visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stage2_map_data</span> *data = ctx-&gt;arg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (visit) &#123;</span><br><span class="line">        <span class="keyword">case</span> KVM_PGTABLE_WALK_TABLE_PRE:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">stage2_map_walk_table_pre</span>(ctx, data);</span><br><span class="line">        <span class="keyword">case</span> KVM_PGTABLE_WALK_LEAF:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">stage2_map_walk_leaf</span>(ctx, data);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">stage2_map_walker_try_leaf</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="keyword">struct</span> stage2_map_data *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">kvm_pte_t</span> <span class="keyword">new</span>;</span><br><span class="line">        u64 phys = <span class="built_in">stage2_map_walker_phys_addr</span>(ctx, data);</span><br><span class="line">        u64 granule = <span class="built_in">kvm_granule_size</span>(ctx-&gt;level);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable</span> *pgt = data-&gt;mmu-&gt;pgt;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_mm_ops</span> *mm_ops = ctx-&gt;mm_ops;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">stage2_leaf_mapping_allowed</span>(ctx, data))</span><br><span class="line">                <span class="keyword">return</span> -E2BIG;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">kvm_phys_is_valid</span>(phys))</span><br><span class="line">                <span class="keyword">new</span> = <span class="built_in">kvm_init_valid_leaf_pte</span>(phys, data-&gt;attr, ctx-&gt;level);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">new</span> = <span class="built_in">kvm_init_invalid_leaf_owner</span>(data-&gt;owner_id);</span><br><span class="line">                    -&gt;<span class="built_in">FIELD_PREP</span>(KVM_INVALID_PTE_OWNER_MASK, owner_id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Skip updating the PTE if we are trying to recreate the exact</span></span><br><span class="line"><span class="comment">         * same mapping or only change the access permissions. Instead,</span></span><br><span class="line"><span class="comment">         * the vCPU will exit one more time from guest if still needed</span></span><br><span class="line"><span class="comment">         * and then go through the path of relaxing permissions.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">stage2_pte_needs_update</span>(ctx-&gt;old, <span class="keyword">new</span>))</span><br><span class="line">                <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If we&#x27;re only changing software bits, then store them and go! */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_shared</span>(ctx) &amp;&amp;</span><br><span class="line">            !((ctx-&gt;old ^ <span class="keyword">new</span>) &amp; ~KVM_PTE_LEAF_ATTR_HI_SW)) &#123;</span><br><span class="line">                <span class="type">bool</span> old_is_counted = <span class="built_in">stage2_pte_is_counted</span>(ctx-&gt;old);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (old_is_counted != <span class="built_in">stage2_pte_is_counted</span>(<span class="keyword">new</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (old_is_counted)</span><br><span class="line">                                mm_ops-&gt;<span class="built_in">put_page</span>(ctx-&gt;ptep);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                                mm_ops-&gt;<span class="built_in">get_page</span>(ctx-&gt;ptep);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">WARN_ON_ONCE</span>(!<span class="built_in">stage2_try_set_pte</span>(ctx, <span class="keyword">new</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="keyword">if</span> (!<span class="built_in">stage2_try_break_pte</span>(ctx, data-&gt;mmu))</span><br><span class="line">                <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Perform CMOs before installation of the guest stage-2 PTE */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_skip_cmo</span>(ctx) &amp;&amp; mm_ops-&gt;dcache_clean_inval_poc &amp;&amp;</span><br><span class="line">            <span class="built_in">stage2_pte_cacheable</span>(pgt, <span class="keyword">new</span>))</span><br><span class="line">                mm_ops-&gt;<span class="built_in">dcache_clean_inval_poc</span>(<span class="built_in">kvm_pte_follow</span>(<span class="keyword">new</span>, mm_ops),</span><br><span class="line">                                               granule);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pgtable_walk_skip_cmo</span>(ctx) &amp;&amp; mm_ops-&gt;icache_inval_pou &amp;&amp;</span><br><span class="line">            <span class="built_in">stage2_pte_executable</span>(<span class="keyword">new</span>))</span><br><span class="line">                mm_ops-&gt;<span class="built_in">icache_inval_pou</span>(<span class="built_in">kvm_pte_follow</span>(<span class="keyword">new</span>, mm_ops), granule);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">stage2_make_pte</span>(ctx, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pkvm_create_mappings_locked</span><span class="params">(<span class="type">void</span> *from, <span class="type">void</span> *to, <span class="keyword">enum</span> kvm_pgtable_prot prot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start = (<span class="type">unsigned</span> <span class="type">long</span>)from;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> end = (<span class="type">unsigned</span> <span class="type">long</span>)to;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> virt_addr;</span><br><span class="line">    <span class="type">phys_addr_t</span> phys;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hyp_assert_lock_held</span>(&amp;pkvm_pgd_lock);</span><br><span class="line"></span><br><span class="line">    start = start &amp; PAGE_MASK;</span><br><span class="line">    end = <span class="built_in">PAGE_ALIGN</span>(end);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (virt_addr = start; virt_addr &lt; end; virt_addr += PAGE_SIZE) &#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">        phys = <span class="built_in">hyp_virt_to_phys</span>((<span class="type">void</span> *)virt_addr);</span><br><span class="line">        err = <span class="built_in">kvm_pgtable_hyp_map</span>(&amp;pkvm_pgtable, virt_addr, PAGE_SIZE,</span><br><span class="line">                      phys, prot);</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>移除host和加入host用的是同一个函数 pte都是INVALID 只有owner id的区别</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/807923e04a0f5c6c34dc2eb52ae544cb0e4e4e66">https://github.com/torvalds/linux/commit/807923e04a0f5c6c34dc2eb52ae544cb0e4e4e66</a></p>
<p>根据注释 这个函数就是unmap host stage2并且记录这个page的owner</p>
<p>但是如果owner是host的话为什么还要被unmap？ 因为是lazy </p>
<h3 id="Host-page-fault"><a href="#Host-page-fault" class="headerlink" title="Host page fault"></a>Host page fault</h3><p>Host mem abort 检查相应的owner id</p>
<p>pte是0表示host 非0表示非host 不能访问</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/1025c8c0c6accfcbdc8f52ca1940160f65cd87d6#diff-7969c9fdf376542af1e6061b538248f414f446349207e6460671f07cdf5fb7beR239">https://github.com/torvalds/linux/commit/1025c8c0c6accfcbdc8f52ca1940160f65cd87d6#diff-7969c9fdf376542af1e6061b538248f414f446349207e6460671f07cdf5fb7beR239</a></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=OGM5YmUxZWFlNjIxMWNjZDk0NmQyZGYzMDRiZjY3NjlfVHhhNTJrNTFvUVZVcWhkNm04VWRCOTIwUGFmZnAxVVJfVG9rZW46Q2I5NGJQamJFb1pRcTh4WHR4Y2M4a1BhbmRlXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGIyNzE5OGE4ZGU1MDk2MDgwOWQ1OWFmMzYzZDk4OWVfaEpmZmpSeDFRNE1EVmZkSEROVVJHdEVDQVJYOUh2bHNfVG9rZW46RmhmVGJ4NklSb3RwdzF4dzhyRmNyeWFCbm9kXzE3Mzg2NzMzNjg6MTczODY3Njk2OF9WNA" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">handle_host_mem_abort</span><span class="params">(<span class="keyword">struct</span> kvm_cpu_context *host_ctxt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_vcpu_fault_info</span> fault;</span><br><span class="line">    u64 esr, addr;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    esr = <span class="built_in">read_sysreg_el2</span>(SYS_ESR);</span><br><span class="line">    <span class="keyword">if</span> (!__get_fault_info(esr, &amp;fault)) &#123;</span><br><span class="line">        <span class="comment">/* Setting the address to an invalid value for use in tracing. */</span></span><br><span class="line">        addr = (u64)<span class="number">-1</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We&#x27;ve presumably raced with a page-table change which caused</span></span><br><span class="line"><span class="comment">         * AT to fail, try again.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addr = (fault.hpfar_el2 &amp; HPFAR_MASK) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    ret = <span class="built_in">host_stage2_idmap</span>(addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == -EPERM)</span><br><span class="line">        <span class="built_in">host_inject_abort</span>(host_ctxt);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">BUG_ON</span>(ret &amp;&amp; ret != -EAGAIN);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_stage2_idmap</span><span class="params">(u64 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_mem_range</span> range;</span><br><span class="line">    <span class="type">bool</span> is_memory = !!<span class="built_in">find_mem_range</span>(addr, &amp;range);</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    prot = is_memory ? PKVM_HOST_MEM_PROT : PKVM_HOST_MMIO_PROT;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">host_lock_component</span>();</span><br><span class="line">    ret = <span class="built_in">host_stage2_adjust_range</span>(addr, &amp;range);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">goto</span> unlock;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">host_stage2_idmap_locked</span>(range.start, range.end - range.start, prot);</span><br><span class="line">unlock:</span><br><span class="line">    <span class="built_in">host_unlock_component</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">host_stage2_adjust_range</span><span class="params">(u64 addr, <span class="keyword">struct</span> kvm_mem_range *range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_mem_range</span> cur;</span><br><span class="line">    <span class="type">kvm_pte_t</span> pte;</span><br><span class="line">    s8 level;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hyp_assert_lock_held</span>(&amp;host_mmu.lock);</span><br><span class="line">    ret = <span class="built_in">kvm_pgtable_get_leaf</span>(&amp;host_mmu.pgt, addr, &amp;pte, &amp;level);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">kvm_pte_valid</span>(pte))<span class="comment">//必须是invalid 这样后面map</span></span><br><span class="line">        <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pte)<span class="comment">// 必须是host自己的 否则权限出错</span></span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        u64 granule = <span class="built_in">kvm_granule_size</span>(level);</span><br><span class="line">        cur.start = <span class="built_in">ALIGN_DOWN</span>(addr, granule);</span><br><span class="line">        cur.end = cur.start + granule;</span><br><span class="line">        level++;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((level &lt;= KVM_PGTABLE_LAST_LEVEL) &amp;&amp;</span><br><span class="line">            !(<span class="built_in">kvm_level_supports_block_mapping</span>(level) &amp;&amp;</span><br><span class="line">              <span class="built_in">range_included</span>(&amp;cur, range)));</span><br><span class="line"></span><br><span class="line">    *range = cur;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __host_stage2_idmap(u64 start, u64 end,</span><br><span class="line">                      <span class="keyword">enum</span> kvm_pgtable_prot prot)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">kvm_pgtable_stage2_map</span>(&amp;host_mmu.pgt, start, end - start, start,</span><br><span class="line">                      prot, &amp;host_s2_pool, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>idmap：identity map start，end-start，start</p>
<p>Host pf一定发生在hyp memory的大块范围 （例如8G长度）</p>
<p>这里的host_stage2_adjust_range会调整到4K 或2M 或1G大页的范围</p>
<p>这里其实权限很松 mem：RWX mmio：RW</p>
<h3 id="初始化pkvm"><a href="#初始化pkvm" class="headerlink" title="初始化pkvm"></a>初始化pkvm</h3><p>arm64&#x2F;kvm&#x2F;arm.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kvm_arm_init</span><br><span class="line">    -&gt;init_hyp_mode</span><br><span class="line">        -&gt;kvm_hyp_init_protection</span><br><span class="line">            -&gt;do_pkvm_init</span><br><span class="line">                -&gt;  cpu_hyp_init_context();</span><br><span class="line">                    kvm_call_hyp_nvhe(__pkvm_init)</span><br><span class="line">module_init(kvm_arm_init);</span><br></pre></td></tr></table></figure>

<p>setup.c</p>
<p>kvm&#x2F;nvhe&#x2F;mem_protect.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__KVM_HOST_SMCCC_FUNC___pkvm_init handle___pkvm_init</span><br><span class="line">handle_host_hcall</span><br><span class="line">handle_host_hcall</span><br><span class="line">handle___pkvm_init</span><br><span class="line">__pkvm_init</span><br><span class="line">    divide_memory_pool</span><br><span class="line">        -&gt;hyp_pgt_base = hyp_early_alloc</span><br><span class="line">          host_s2_pgt_base = hyp_early_alloc</span><br><span class="line">    recreate_hyp_mappings</span><br><span class="line">        -&gt;kvm_pgtable_hyp_init(&amp;pkvm_pgtable);</span><br><span class="line">            -&gt;pgt-&gt;pgd = zalloc_page();</span><br><span class="line">          pkvm_create_mappings</span><br><span class="line">    update_nvhe_init_params</span><br><span class="line">    -&gt;&#123;for cpus</span><br><span class="line">        params-&gt;pgd_pa = __hyp_pa(pkvm_pgtable.pgd);</span><br><span class="line">    &#125;</span><br><span class="line">    __pkvm_init_switch_pgd</span><br><span class="line">        -&gt;msr ttbr0_el2, x4</span><br><span class="line">    __pkvm_init_finalise&#123;</span><br><span class="line">        kvm_host_prepare_stage2&#123;</span><br><span class="line">            __kvm_pgtable_stage2_init(&amp;host_mmu.pgt);</span><br><span class="line">                -&gt;pgt-&gt;pgd = mm_ops-&gt;zalloc_pages_exact(pgd_sz);</span><br><span class="line">            mmu-&gt;pgt = &amp;host_ammu.pgt;</span><br><span class="line">            mmu-&gt;pgd_phys = __hyp_pa(host_mmu.pgt.pgd);</span><br><span class="line">            atomic64_set(&amp;mmu-&gt;vmid.id, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        fix_host_ownership();</span><br><span class="line">            -&gt;kvm_pgtable_walk(fix_host_ownership_wakler);</span><br><span class="line">                -&gt;host_stage2_set_owner_locked</span><br><span class="line">                    -&gt;host_stage2_try(kvm_pgtable_stage2_annotate, &amp;host_mmu.pgt);</span><br><span class="line">                        -&gt;kvm_pgtable_walk(pgt, stage2_map_walker);</span><br><span class="line">        __host_enter(host_ctxt);</span><br><span class="line">            -&gt;__host_enter_restore_full</span><br><span class="line">                -&gt;eret</span><br><span class="line">    &#125;</span><br><span class="line">    unreachable</span><br></pre></td></tr></table></figure>

<h4 id="hyp-memory"><a href="#hyp-memory" class="headerlink" title="hyp_memory"></a>hyp_memory</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kvm_hyp_reserve-&gt;</span><br><span class="line">register_memblock_regions&#123;</span><br><span class="line">    for_each_mem_region(reg) &#123;</span><br><span class="line">        hyp_memory[*hyp_memblock_nr_ptr] = *reg;</span><br><span class="line">        (*hyp_memblock_nr_ptr)++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort_memblock_regions</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include/linux/memblock.<span class="function">h</span></span><br><span class="line"><span class="function"><span class="title">for</span> <span class="params">(region = memblock.memory.regions; region &lt; memblock.memory.regions + memblock.memory.cnt ; region++)</span></span></span><br></pre></td></tr></table></figure>

<p>这里应该是直接复制了kernel自己的memory block</p>
<p>用gdb跑下来 结果是0x40000000 0x200000000 (8G) 和qemu有关 只有一个region</p>
<h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">bootmem_init</span><br><span class="line">    -&gt;kvm_hyp_reserve</span><br><span class="line">        -&gt;hyp_mem_base = memblock_phys_alloc</span><br><span class="line">        </span><br><span class="line">__pkvm_init</span><br><span class="line">    -&gt;divide_memory_pool</span><br><span class="line">        -&gt;hyp_early_alloc_init(hyp_mem_base)</span><br><span class="line">          host_s2_pgt_base = hyp_early_alloc</span><br><span class="line">       </span><br><span class="line">  </span><br><span class="line">  __pkvm_init_finalise</span><br><span class="line">      -&gt;kvm_host_prepare_stage2(host_s2_pgt_base)</span><br><span class="line">          -&gt;prepare_s2_pool(pgt_pool_base)</span><br><span class="line">              -&gt;pfn = hyp_virt_to_pfn(pgt_pool_base)</span><br><span class="line">                hyp_pool_init(&amp;host_s2_pool,pfn)</span><br><span class="line">                    -&gt;phys = hyp_pfn_to_phys(pfn)</span><br><span class="line">                      pool-&gt;range_start = phys</span><br><span class="line"></span><br><span class="line">__host_stage2_idmap</span><br><span class="line">    -&gt;kvm_pgtable_stage2_map(&amp;host_mmu.pgt, &amp;host_s2_pool)</span><br><span class="line">        -&gt;map_data.memcache = mc //host_s2_pool</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">stage2_map_walk_leaf</span><br><span class="line">    -&gt;childp = mm_ops-&gt;zalloc_page(data-&gt;memcache)</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"> prepare_s2_pool</span><br><span class="line">     -&gt;host_mmu.mm_ops = host_s2_zalloc_page</span><br><span class="line">                            -&gt;hyp_alloc_pages(pool)</span><br><span class="line"> kvm_guest_prepare_stage2</span><br><span class="line">     -&gt;vm-&gt;mm_ops = guest_s2_zalloc_page</span><br><span class="line">                     -&gt;hyp_alloc_pages(&amp;current_vm-&gt;pool)</span><br><span class="line"> __pkvm_init_finalise</span><br><span class="line">     -&gt;pkvm_pgtable_mm_ops = &amp;pkvm_pgtable_mm_ops</span><br><span class="line">         = hyp_zalloc_hyp_page</span><br><span class="line">             -&gt;hyp_alloc_pages(&amp;hpool) //static struct hyp_pool pool</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line"> //guest</span><br><span class="line"> kvm_guest_prepare_stage2</span><br><span class="line">     -&gt;hyp_pool_init(&amp;vm-&gt;pool)</span><br><span class="line"> //hyp</span><br><span class="line"> __pkvm_init_finalise</span><br><span class="line">     -&gt;hyp_pool_init(&amp;hpool)</span><br></pre></td></tr></table></figure>

<h4 id="页表配置"><a href="#页表配置" class="headerlink" title="页表配置"></a>页表配置</h4><p>Hyp stage1</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">bootmem_init<span class="comment">//arm64/mm/init.c</span></span><br><span class="line"><span class="function"><span class="type">void</span> __init <span class="title">kvm_hyp_reserve</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 hyp_mem_pages = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_hyp_mode_available</span>() || <span class="built_in">is_kernel_in_hyp_mode</span>())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">kvm_get_mode</span>() != KVM_MODE_PROTECTED)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">register_memblock_regions</span>();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        *hyp_memblock_nr_ptr = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">kvm_err</span>(<span class="string">&quot;Failed to register hyp memblocks: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_s1_pgtable_pages</span>();</span><br><span class="line">    hyp_mem_pages += <span class="built_in">host_s2_pgtable_pages</span>();</span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_vm_table_pages</span>();</span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_vmemmap_pages</span>(STRUCT_HYP_PAGE_SIZE);</span><br><span class="line">    hyp_mem_pages += <span class="built_in">hyp_ffa_proxy_pages</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Try to allocate a PMD-aligned region to reduce TLB pressure once</span></span><br><span class="line"><span class="comment">     * this is unmapped from the host stage-2, and fallback to PAGE_SIZE.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    hyp_mem_size = hyp_mem_pages &lt;&lt; PAGE_SHIFT;</span><br><span class="line">    hyp_mem_base = <span class="built_in">memblock_phys_alloc</span>(<span class="built_in">ALIGN</span>(hyp_mem_size, PMD_SIZE),</span><br><span class="line">                       PMD_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (!hyp_mem_base)</span><br><span class="line">        hyp_mem_base = <span class="built_in">memblock_phys_alloc</span>(hyp_mem_size, PAGE_SIZE);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        hyp_mem_size = <span class="built_in">ALIGN</span>(hyp_mem_size, PMD_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hyp_mem_base) &#123;</span><br><span class="line">        <span class="built_in">kvm_err</span>(<span class="string">&quot;Failed to reserve hyp memory\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">kvm_info</span>(<span class="string">&quot;Reserved %lld MiB at 0x%llx\n&quot;</span>, hyp_mem_size &gt;&gt; <span class="number">20</span>,</span><br><span class="line">         hyp_mem_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__pkvm_init(hyp_mem_base,hyp_mem_size)</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">recreate_hyp_mappings</span><span class="params">(<span class="type">phys_addr_t</span> phys, <span class="type">unsigned</span> <span class="type">long</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">unsigned</span> <span class="type">long</span> *per_cpu_base,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 u32 hyp_va_bits)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">void</span> *start, *end, *virt = <span class="built_in">hyp_phys_to_virt</span>(phys);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> pgt_size = <span class="built_in">hyp_s1_pgtable_pages</span>() &lt;&lt; PAGE_SHIFT;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot;</span><br><span class="line">        <span class="type">int</span> ret, i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Recreate the hyp page-table using the early page allocator */</span></span><br><span class="line">        <span class="built_in">hyp_early_alloc_init</span>(hyp_pgt_base, pgt_size);</span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_hyp_init</span>(&amp;pkvm_pgtable, hyp_va_bits,</span><br><span class="line">                                   &amp;hyp_early_alloc_mm_ops);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">hyp_create_idmap</span>(hyp_va_bits);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">hyp_map_vectors</span>();</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">hyp_back_vmemmap</span>(<span class="built_in">hyp_virt_to_phys</span>(vmemmap_base));</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_text_start, __hyp_text_end, PAGE_HYP_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_data_start, __hyp_data_end, PAGE_HYP);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_rodata_start, __hyp_rodata_end, PAGE_HYP_RO);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(__hyp_bss_start, __hyp_bss_end, PAGE_HYP);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(virt, virt + size, PAGE_HYP);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hyp_nr_cpus; i++) &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">kvm_nvhe_init_params</span> *params = <span class="built_in">per_cpu_ptr</span>(&amp;kvm_init_params, i);</span><br><span class="line"></span><br><span class="line">                start = (<span class="type">void</span> *)<span class="built_in">kern_hyp_va</span>(per_cpu_base[i]);</span><br><span class="line">                end = start + <span class="built_in">PAGE_ALIGN</span>(hyp_percpu_size);</span><br><span class="line">                ret = <span class="built_in">pkvm_create_mappings</span>(start, end, PAGE_HYP);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">                ret = <span class="built_in">pkvm_create_stack</span>(params-&gt;stack_pa, &amp;params-&gt;stack_hyp_va);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">create_hyp_host_fp_mappings</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Map the host sections RO in the hypervisor, but transfer the</span></span><br><span class="line"><span class="comment">         * ownership from the host to the hypervisor itself to make sure they</span></span><br><span class="line"><span class="comment">         * can&#x27;t be donated or shared with another entity.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The ownership transition requires matching changes in the host</span></span><br><span class="line"><span class="comment">         * stage-2. This will be done later (see finalize_host_mappings()) once</span></span><br><span class="line"><span class="comment">         * the hyp_vmemmap is addressable.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        prot = <span class="built_in">pkvm_mkstate</span>(PAGE_HYP_RO, PKVM_PAGE_SHARED_OWNED);</span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(&amp;kvm_vgic_global_state,</span><br><span class="line">                                   &amp;kvm_vgic_global_state + <span class="number">1</span>, prot);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        start = <span class="built_in">hyp_phys_to_virt</span>(pvmfw_base);</span><br><span class="line">        end = start + pvmfw_size;</span><br><span class="line">        prot = <span class="built_in">pkvm_mkstate</span>(PAGE_HYP_RO, PKVM_PAGE_OWNED);</span><br><span class="line">        ret = <span class="built_in">pkvm_create_mappings</span>(start, end, prot);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认是OWNED 0</p>
<p>映射hyp自己的代码 和一个需要和host共享的</p>
<p>Host stage2</p>
<p>Walk hyp的stage1去对应配host的stage2</p>
<p>其中存在在hyp stage1的都标记为hyp 这样之后就不会map </p>
<p>share的立即补上map （很少）</p>
<p>原来是return kvm_pgtable_walk(&amp;pkvm_pgtable, 0, BIT(pkvm_pgtable.ia_bits), &amp;walker); 遍历全部地址范围</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">fix_host_ownership</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_pgtable_walker</span> walker = &#123;</span><br><span class="line">        .cb = fix_host_ownership_walker,</span><br><span class="line">        .flags  = KVM_PGTABLE_WALK_LEAF,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> i, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hyp_memblock_nr; i++) &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">memblock_region</span> *reg = &amp;hyp_memory[i];</span><br><span class="line">        u64 start = (u64)<span class="built_in">hyp_phys_to_virt</span>(reg-&gt;base);</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">kvm_pgtable_walk</span>(&amp;pkvm_pgtable, start, reg-&gt;size, &amp;walker);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">fix_host_ownership_walker</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kvm_pgtable_visit_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">enum</span> kvm_pgtable_walk_flags visit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">kvm_pgtable_prot</span> prot;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">pkvm_page_state</span> state;</span><br><span class="line">        <span class="type">phys_addr_t</span> phys;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">kvm_pte_valid</span>(ctx-&gt;old))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;level != (KVM_PGTABLE_MAX_LEVELS - <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        phys = <span class="built_in">kvm_pte_to_phys</span>(ctx-&gt;old);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">addr_is_memory</span>(phys))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Adjust the host stage-2 mappings to match the ownership attributes</span></span><br><span class="line"><span class="comment">         * configured in the hypervisor stage-1.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        state = <span class="built_in">pkvm_getstate</span>(<span class="built_in">kvm_pgtable_hyp_pte_prot</span>(ctx-&gt;old));</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> PKVM_PAGE_OWNED:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">host_stage2_set_owner_locked</span>(phys, PAGE_SIZE, PKVM_ID_HYP);</span><br><span class="line">        <span class="keyword">case</span> PKVM_PAGE_SHARED_OWNED:</span><br><span class="line">                prot = <span class="built_in">pkvm_mkstate</span>(PKVM_HOST_MEM_PROT, PKVM_PAGE_SHARED_BORROWED);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PKVM_PAGE_SHARED_BORROWED:</span><br><span class="line">                prot = <span class="built_in">pkvm_mkstate</span>(PKVM_HOST_MEM_PROT, PKVM_PAGE_SHARED_OWNED);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">host_stage2_idmap_locked</span>(phys, PAGE_SIZE, prot);</span><br><span class="line">            -&gt;<span class="built_in">kvm_pgtable_stage2_map</span>(&amp;host_mmu.pgt)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历的pt是pkvm_pgtable 就是hyp stage1 地址范围是kernel启动时所有memblock的地址范围</p>
<p>PAGE_OWNED表示hyp独有 因此从host stage2中移除</p>
<p>这里hyp stage1空洞的部分 host stage2是不做处理的</p>
<p>不做处理默认是属于host的 因此handle mem abort的时候会直接补上</p>
<p>gdb跑下来的结论：</p>
<ol>
<li>fix_host_ownership中host_stage2_idmap_locked确实只执行了一次 </li>
<li>正常启动以后stage2是在host上启用了的</li>
<li>host_stage2_idmap_locked会执行很多次 且每次size不是4096 应该是host pf进来的</li>
</ol>
<p>这里只是保存了通用寄存器然后eret 理论上应该返回到hvc之前的一句 即kvm_call_hyp_nvhe(__pkvm_init)之后</p>
<p>结束初始化后直接打开了host stage2翻译</p>
<p>arch&#x2F;arm64&#x2F;kvm&#x2F;hyp&#x2F;nvhe&#x2F;pkvm.c</p>
<p>arm64&#x2F;kvm&#x2F;pkvm.c</p>
<p>kvm_call_hyp_nvhe -&gt; arm_smccc_1_1_hvc 执行SMCCC_HVC_INST -&gt; hvc #0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">finalize_pkvm</span><br><span class="line">    -&gt;pkvm_drop_host_privileges</span><br><span class="line">        -&gt;on_each_cpu(_kvm_host_prot_finalize);</span><br><span class="line">            -&gt;kvm_call_hyp_nvhe(__pkvm_prot_finalize);</span><br><span class="line">                -&gt;  hcr_el2 |= HCR_VM;</span><br><span class="line">                    __load_stage2(&amp;host_mmu.arch.mmu,&amp;host_mmu.arch);</span><br><span class="line">device_initcall_sync(finalize_pkvm);</span><br></pre></td></tr></table></figure>

<p>finalize_pkvm用device_initcall_sync调用 调用链不清晰，kvm_arm_init-&gt;__pkvm_init 完成了所有的host stage2页表初始工作</p>
<h3 id="Page-fault"><a href="#Page-fault" class="headerlink" title="Page fault"></a>Page fault</h3><p>kvm&#x2F;mmu.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">kvm_handle_guest_abort&#123;</span><br><span class="line">    gfn = fault_ipa &gt;&gt; PAGE_SHIFT;</span><br><span class="line">    memslot = gfn_to_memslot(vcpu-&gt;kvm, gfn);</span><br><span class="line">    hva = gfn_to_hva_memslot_prot(memslot,gfn);</span><br><span class="line">    </span><br><span class="line">    if (is_protected_kvm_enabled())</span><br><span class="line">        pkvm_mem_abort</span><br><span class="line">            -&gt; pin_user_pages(hva, &amp;page);</span><br><span class="line">               pfn = page_to_pfn(page);</span><br><span class="line">               pkvm_host_map_guest</span><br><span class="line">                -&gt;kvm_call_hyp_nvhe(__pkvm_host_map_guest)</span><br><span class="line">                    -&gt;__pkvm_host_donate_guest&#123;</span><br><span class="line">                        initiator.id = PKVM_ID_HOST;</span><br><span class="line">                        initiator.addr = host_addr;</span><br><span class="line">                        initiator.host.completer_addr = guest_addr;</span><br><span class="line">                        completer.id = PKVM_ID_GUEST;</span><br><span class="line">                        completer.guest.phys = host_addr;</span><br><span class="line">                        -&gt;do_donate&#123;</span><br><span class="line">                            host_initiate_donation;</span><br><span class="line">                                -&gt;host_stage2_set_owner_locked</span><br><span class="line">                                    -&gt;kvm_pgtable_stage2_annotate(&amp;host_mmu.gpt)</span><br><span class="line">                                        -&gt;kvm_pgtable_walk(pgt, stage2_map_walk);//phys=KVM_PHYS_INVALID</span><br><span class="line">                            guest_complete_donation;</span><br><span class="line">                                -&gt;kvm_pgtable_stage2_map(&amp;vm-&gt;gpt,guest_addr,host_addr);</span><br><span class="line">                                    -&gt;kvm_pgtable_walk(pgt, stage2_map_walk);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">               </span><br><span class="line">    else</span><br><span class="line">        user_mem_abort</span><br><span class="line">            -&gt;kvm_pgtable_stage2_map</span><br><span class="line">                -&gt;kvm_pgtable_walk(vcpu-&gt;arch.hw_mmu-&gt;pgt,stage2_map_walker)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到guest stage2的pf EL1会调用EL2的__pkvm_host_map_guest 这里先解开host stage2映射 然后加上guest stage2映射</p>
<p>这非pkvm的情况下 直接在EL1调用kvm_pgtable_stage2_map调整好页表</p>
<p>观察调用路径可以发现，这里handler完全是在EL1处理的 run完马上退到EL1 pkvm_mem_abort-&gt;kvm_call_hyp_nvhe(__pkvm_host_map_guest)再到EL2 这么做是否相信了EL1的hypervisor？ 可以选择在guest page fault的时候不unmap host？</p>
<p>先在EL1 pin_user_page 拿到gpa</p>
<p>非pkvm get_user_page 拿到gpa</p>
<p>都是用的EL1接口 在EL1做 不知道区别是什么</p>
<p>如果EL1可以任意准备物理内存页来攻击，EL2做的</p>
<ul>
<li>检查这个内存页之前是否属于host，如果不属于就拒绝</li>
<li>从host stage2中unmap</li>
</ul>
<p>这两步能否保证guest内存的机密性和完整性？</p>
<ul>
<li>当一个内存页给guest以后 这块物理地址host永远不会访问</li>
<li>当guest主动把自己的某个物理页给host share之前 guest可以清空数据</li>
<li>guest不会被两个物理页映射到同一个ipa（host检查）</li>
<li>guest不能相信第一次使用的物理页（page fault由host决定用哪个物理页 但是hyp可以清空这些数据）内存的初始状态？读磁盘？fs-verity依赖一个root hash 是否可以存在可信的EL2代码里？guest读取 拼接 验证 如果错误就是DOS</li>
</ul>
<p>如此分析 hpa给EL1管理没有问题 只要EL2检查通过即可</p>
<h3 id="初始化VM"><a href="#初始化VM" class="headerlink" title="初始化VM"></a>初始化VM</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kvm_vcpu_ioctl <span class="comment">//virt/kvm/kvm_main.c</span></span><br><span class="line">    <span class="function">KVM_RUN </span></span><br><span class="line"><span class="function">        <span class="title">unlikely</span><span class="params">(oldpid != task_pid(current)<span class="comment">//the thread running this vcpu changed</span></span></span></span><br><span class="line"><span class="params"><span class="function">            kvm_arch_vcpu_run_pid_change</span></span></span><br><span class="line"><span class="params"><span class="function">                -&gt;<span class="keyword">if</span> (is_protected_kvm_enabled())</span></span></span><br><span class="line"><span class="params"><span class="function">                     __pkvm_create_hyp_vm</span></span></span><br><span class="line"><span class="params"><span class="function">                        -&gt;kvm_call_hyp_nvhe(__pkvm_init_vm);</span></span></span><br><span class="line"><span class="params"><span class="function">                        __pkvm_init_vm</span></span></span><br><span class="line"><span class="params"><span class="function">                        -&gt;insert_vm_table_entry</span></span></span><br><span class="line"><span class="params"><span class="function">                            -&gt;hyp_vm-&gt;kvm.arch.mmu.pgt = &amp;hyp_vm-&gt;pgt</span></span></span><br><span class="line"><span class="params"><span class="function">                        -&gt;kvm_guest_prepare_stage2</span></span></span><br><span class="line"><span class="params"><span class="function">                            -&gt;__kvm_pgtable_stage2_init</span></span></span><br><span class="line"><span class="params"><span class="function">                                -&gt;pgt-&gt;pgd = zalloc_pages_exact</span></span></span><br></pre></td></tr></table></figure>

<p>不知道为什么这里入口是kvm run</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/9d0c063a4d1d10ef8e6288899b8524413e40cfa0#diff-53d87d0b516f008da397a4b46f61c48934d55a53cc5c94686aa1d84fd8efaee4R154">KVM: arm64: Instantiate pKVM hypervisor VM and vCPU structures from EL1 · torvalds&#x2F;linux@9d0c063</a></p>
<p>非pkvm：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kvm_dev_ioctl</span><br><span class="line">kvm_dev_ioctl_create_vm</span><br><span class="line">kvm_create_vm <span class="comment">//virt/kvm/kvm_main.c</span></span><br><span class="line">    -&gt;kvm = kvm_arch_alloc_vm</span><br><span class="line">      <span class="built_in">mutex_init</span>(&amp;kvm-&gt;lock);</span><br><span class="line">    kvm_arch_init_vm</span><br><span class="line">          -&gt;<span class="built_in">pkvm_init_host_vm</span>(kvm)&#123;</span><br><span class="line">                <span class="keyword">if</span> (!(type &amp; KVM_VM_TYPE_ARM_PROTECTED))</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">is_protected_kvm_enabled</span>())</span><br><span class="line">                        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">                host_kvm-&gt;arch.pkvm.enabled = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">              </span><br><span class="line">            <span class="built_in">kvm_init_stage2_mmu</span>(kvm-&gt;arch.mmu)&#123;</span><br><span class="line">            pgt = kzalloc</span><br><span class="line">            kvm_pgtable_stage2_init</span><br><span class="line">                -&gt;pgt-&gt;pgd = zalloc_pages_exact</span><br><span class="line">            mmu-&gt;pgt = pgt;</span><br><span class="line">            mmu-&gt;pgd_phys = __pa(pgt-&gt;pgd);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>是否pkvm不希望大改目前的kvm逻辑 因此选择把入口加到了kvm_arch_vcpu_run_pid_change中？</p>
<p>具体需要看crosvm的逻辑 但是不重要 知道怎么初始化就行 可以认为这个项目只跑pvm 不需要兼容vm</p>
<p>host qemu启动指令：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/repos/qemu/build/aarch64-softmmu/qemu-system-aarch64 -M virt        \</span><br><span class="line">      -machine virtualization=<span class="literal">true</span> -machine virt,gic-version=<span class="number">3</span>  \</span><br><span class="line">      -cpu cortex-a72 -smp <span class="number">2</span> -m <span class="number">4096</span>                   \</span><br><span class="line">      -drive <span class="keyword">if</span>=pflash,format=raw,file=efi.img,readonly     \</span><br><span class="line">      -drive <span class="keyword">if</span>=pflash,format=raw,file=varstore.img         \</span><br><span class="line">      -drive <span class="keyword">if</span>=virtio,format=qcow2,file=disk.img           \</span><br><span class="line">      -device virtio-scsi-pci,id=scsi0              \</span><br><span class="line">      -object rng-random,filename=/dev/urandom,id=rng0      \</span><br><span class="line">      -device virtio-rng-pci,rng=rng0               \</span><br><span class="line">      -device virtio-net-pci,netdev=net0                \</span><br><span class="line">      -netdev user,id=net0,hostfwd=tcp::<span class="number">8022</span>-:<span class="number">22</span>            \</span><br><span class="line">      -nographic                           \</span><br><span class="line">      -kernel ~/repos/linux-pkvm-verif/arch/arm64/boot/Image -append <span class="string">&quot;earlycon nokaslr kvm-arm.mode=protected root=/dev/vda2&quot;</span> </span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>guest vmm 看crosvm</p>
<h3 id="切换"><a href="#切换" class="headerlink" title="切换"></a>切换</h3><p>hyp&#x2F;nvhe&#x2F;switch.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__pkvm_create_hyp_vm</span><br><span class="line">    -&gt;__pkvm_init_vcpu</span><br><span class="line">        -&gt;init_pkvm_hyp_vcpu</span><br><span class="line">            -&gt;vcpu.arch.hw_mmu = &amp;hyp_vm-&gt;kvm.arch.mmu; //hyp/nvhe/pkvm.c</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">kvm_vm_ioctl_create_vcpu</span><br><span class="line">    -&gt;kvm_arch_vcpu_create</span><br><span class="line">        -&gt;vcpu-&gt;arch.hw_mmu = &amp;vcpu-&gt;kvm-&gt;arch.mmu; //arm.c        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kvm_arch_vcpu_ioctl_run</span><br><span class="line">-&gt;kvm_arm_vcpu_enter_exit</span><br><span class="line">    -&gt;kvm_call_hyp_ret(__kvm_vcpu_run)</span><br><span class="line">__kvm_vcpu_run&#123;</span><br><span class="line">    __load_stage2(vcpu-&gt;arch.hw_mmu);</span><br><span class="line">    do&#123;</span><br><span class="line">        exit_code = __guest_enter(vcpu);</span><br><span class="line">    &#125;while(fixup_guest_exit(vcpu, &amp;exit_code));</span><br><span class="line">    __load_host_stage2();</span><br><span class="line">        -&gt;__load_stage2(&amp;host_mmu.arch.mmu, &amp;host_mmu.arch)</span><br><span class="line">            -&gt;write_sysreg(kvm_get_vttbr(mmu), vttbr_el2);</span><br><span class="line">                -&gt;kvm_phys_to_vttbr(mmu-&gt;pgd_phys) | mmu-&gt;vmid.id &lt;&lt; SHIFT | cnp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kvm_vm_ioctl_create_vcpu在vcpu_run之前 所以在__pkvm_create_hyp_vm之前</p>
<p>因此为传统vm准备的stage2页表等资源会被pkvm的初始化覆盖，代码执行、资源准备，但是完全没有使用？</p>
<p>开了pkvm的host支持pvm和normal vm</p>
<p>可以看到guest使用的stage2页表完全是由EL2的hyp来操作的 EL1应该是提供了一段内存 EL2会先把这段内存unmap掉 然后用于分配EL2页表</p>
<p>在x86或arm上 EPT&#x2F;stage2pt都是由kvm准备（分配内存并且map） 而并非像hm一样由用户态或sysmgr准备好然后作为参数传入 （uvmm-&gt;sysmgr-&gt;hmvirt） sysmgr是否扮演的是kvm的角色？</p>
<h3 id="hypercall共享内存"><a href="#hypercall共享内存" class="headerlink" title="hypercall共享内存"></a>hypercall共享内存</h3><h4 id="Guest"><a href="#Guest" class="headerlink" title="Guest"></a>Guest</h4><p>pkvm-android-mainline-6.6</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ARM_SMCCC_KVM_FUNC_HYP_MEMINFO</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_KVM_FUNC_HYP_MEMINFO        2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_VENDOR_HYP_KVM_HYP_MEMINFO_FUNC_ID                        \</span></span><br><span class="line"><span class="meta">        ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_SMC_64,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_OWNER_VENDOR_HYP,                        \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_KVM_FUNC_HYP_MEMINFO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>        <span class="comment">/* ARM_SMCCC_KVM_FUNC_HYP_MEMINFO */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ARM_SMCCC_KVM_FUNC_MEM_SHARE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_KVM_FUNC_MEM_SHARE        3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID                        \</span></span><br><span class="line"><span class="meta">        ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_SMC_64,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_OWNER_VENDOR_HYP,                        \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_KVM_FUNC_MEM_SHARE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>        <span class="comment">/* ARM_SMCCC_KVM_FUNC_MEM_SHARE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ARM_SMCCC_KVM_FUNC_MEM_UNSHARE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_KVM_FUNC_MEM_UNSHARE        4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID                        \</span></span><br><span class="line"><span class="meta">        ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_SMC_64,                                \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_OWNER_VENDOR_HYP,                        \</span></span><br><span class="line"><span class="meta">                           ARM_SMCCC_KVM_FUNC_MEM_UNSHARE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>        <span class="comment">/* ARM_SMCCC_KVM_FUNC_MEM_UNSHARE */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> memshare_granule_sz;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> memshare_has_range;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">mem_encrypt_active</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memshare_granule_sz;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">EXPORT_SYMBOL</span>(mem_encrypt_active);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">kvm_init_memshare_services</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">arm_smccc_res</span> res;</span><br><span class="line">        <span class="type">const</span> u32 funcs[] = &#123;</span><br><span class="line">                ARM_SMCCC_KVM_FUNC_HYP_MEMINFO,</span><br><span class="line">                ARM_SMCCC_KVM_FUNC_MEM_SHARE,</span><br><span class="line">                ARM_SMCCC_KVM_FUNC_MEM_UNSHARE,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">long</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">ARRAY_SIZE</span>(funcs); ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">kvm_arm_hyp_service_available</span>(funcs[i]))</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">arm_smccc_1_1_invoke</span>(ARM_SMCCC_VENDOR_HYP_KVM_HYP_MEMINFO_FUNC_ID,</span><br><span class="line">                             <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;res);</span><br><span class="line">        ret = (<span class="type">long</span>)res.a0;</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        memshare_has_range = !!(res.a1 &amp; KVM_FUNC_HAS_RANGE);</span><br><span class="line">        memshare_granule_sz = ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __invoke_memshare(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">int</span> numpages, <span class="type">int</span> func_id,</span><br><span class="line">                             u64 *done)</span><br><span class="line">&#123;</span><br><span class="line">        u64 size_arg = memshare_has_range ? numpages * PAGE_SIZE : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">arm_smccc_res</span> res;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">arm_smccc_1_1_invoke</span>(func_id, <span class="built_in">virt_to_phys</span>((<span class="type">void</span> *)addr),</span><br><span class="line">                             size_arg, <span class="number">0</span>, &amp;res);</span><br><span class="line">        <span class="keyword">if</span> (res.a0 != SMCCC_RET_SUCCESS)</span><br><span class="line">                <span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">        *done = memshare_has_range ? res.a1 : memshare_granule_sz;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">set_memory_xcrypted</span><span class="params">(u32 func_id, <span class="type">unsigned</span> <span class="type">long</span> start, <span class="type">int</span> numpages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!memshare_granule_sz)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">WARN_ON</span>(!<span class="built_in">PAGE_ALIGNED</span>(start)))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((PAGE_SIZE * numpages) % memshare_granule_sz)</span><br><span class="line">                <span class="keyword">return</span> -ERANGE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (numpages &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                u64 done;</span><br><span class="line">                <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">                ret = __invoke_memshare(start, numpages, func_id, &amp;done);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">WARN_ON</span>(done &gt;&gt; PAGE_SHIFT &gt; numpages);</span><br><span class="line"></span><br><span class="line">                numpages -= done &gt;&gt; PAGE_SHIFT;</span><br><span class="line">                start += done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">set_memory_encrypted</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">int</span> numpages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">set_memory_xcrypted</span>(ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID,</span><br><span class="line">                                   addr, numpages);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">set_memory_decrypted</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">int</span> numpages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">set_memory_xcrypted</span>(ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID,</span><br><span class="line">                                   addr, numpages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="host"><a href="#host" class="headerlink" title="host"></a>host</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">kvm_handle_pvm_hvc64</span><br><span class="line">pkvm_memshare_call</span><br><span class="line">__pkvm_guest_share_host</span><br><span class="line">do_share</span><br><span class="line">__do_share</span><br><span class="line">static const exit_handler_fn pvm_exit_handlers[] = &#123;</span><br><span class="line">    [0 ... ESR_ELx_EC_MAX]      = NULL,</span><br><span class="line">    [ESR_ELx_EC_HVC64]      = kvm_handle_pvm_hvc64,</span><br><span class="line">    [ESR_ELx_EC_SYS64]      = kvm_handle_pvm_sys64,</span><br><span class="line">    [ESR_ELx_EC_SVE]        = kvm_handle_pvm_restricted,</span><br><span class="line">    [ESR_ELx_EC_SME]        = kvm_handle_pvm_restricted,</span><br><span class="line">    [ESR_ELx_EC_FP_ASIMD]       = kvm_hyp_handle_fpsimd,</span><br><span class="line">    [ESR_ELx_EC_IABT_LOW]       = kvm_hyp_handle_iabt_low,</span><br><span class="line">    [ESR_ELx_EC_DABT_LOW]       = kvm_hyp_handle_dabt_low,</span><br><span class="line">    [ESR_ELx_EC_WATCHPT_LOW]    = kvm_hyp_handle_watchpt_low,</span><br><span class="line">    [ESR_ELx_EC_MOPS]       = kvm_hyp_handle_mops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_KVM_FUNC_MEM_SHARE        3</span><br><span class="line">#define ARM_SMCCC_KVM_FUNC_MEM_UNSHARE      4</span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_CALL_VAL(type, calling_convention, owner, func_num) \</span><br><span class="line">    (((type) &lt;&lt; ARM_SMCCC_TYPE_SHIFT) | \</span><br><span class="line">    ((calling_convention) &lt;&lt; ARM_SMCCC_CALL_CONV_SHIFT) | \</span><br><span class="line">    (((owner) &amp; ARM_SMCCC_OWNER_MASK) &lt;&lt; ARM_SMCCC_OWNER_SHIFT) | \</span><br><span class="line">    ((func_num) &amp; ARM_SMCCC_FUNC_MASK))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID          \</span><br><span class="line">    ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,             \</span><br><span class="line">               ARM_SMCCC_SMC_64,                \</span><br><span class="line">               ARM_SMCCC_OWNER_VENDOR_HYP,          \</span><br><span class="line">               ARM_SMCCC_KVM_FUNC_MEM_SHARE)</span><br><span class="line"></span><br><span class="line">#define ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID            \</span><br><span class="line">    ARM_SMCCC_CALL_VAL(ARM_SMCCC_FAST_CALL,             \</span><br><span class="line">               ARM_SMCCC_SMC_64,                \</span><br><span class="line">               ARM_SMCCC_OWNER_VENDOR_HYP,          \</span><br><span class="line">               ARM_SMCCC_KVM_FUNC_MEM_UNSHARE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static inline u32 smccc_get_function(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">    return vcpu_get_reg(vcpu, 0);</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line"> * vcpu_get_reg and vcpu_set_reg should always be passed a register number</span><br><span class="line"> * coming from a read of ESR_EL2. Otherwise, it may give the wrong result on</span><br><span class="line"> * AArch32 with banked registers.</span><br><span class="line"> */</span><br><span class="line">static __always_inline unsigned long vcpu_get_reg(const struct kvm_vcpu *vcpu,</span><br><span class="line">                     u8 reg_num)</span><br><span class="line">&#123;</span><br><span class="line">    return (reg_num == 31) ? 0 : vcpu_gp_regs(vcpu)-&gt;regs[reg_num];</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line"> * Handler for protected VM HVC calls.</span><br><span class="line"> *</span><br><span class="line"> * Returns true if the hypervisor has handled the exit, and control should go</span><br><span class="line"> * back to the guest, or false if it hasn&#x27;t.</span><br><span class="line"> */</span><br><span class="line">bool kvm_handle_pvm_hvc64(struct kvm_vcpu *vcpu, u64 *exit_code)</span><br><span class="line">&#123;</span><br><span class="line">    u64 val[4] = &#123; SMCCC_RET_NOT_SUPPORTED &#125;;</span><br><span class="line">    u32 fn = smccc_get_function(vcpu);</span><br><span class="line">    struct pkvm_hyp_vcpu *hyp_vcpu;</span><br><span class="line"></span><br><span class="line">    hyp_vcpu = container_of(vcpu, struct pkvm_hyp_vcpu, vcpu);</span><br><span class="line"></span><br><span class="line">    switch (fn) &#123;</span><br><span class="line">    case ARM_SMCCC_VERSION_FUNC_ID:</span><br><span class="line">        /* Nothing to be handled by the host. Go back to the guest. */</span><br><span class="line">        val[0] = ARM_SMCCC_VERSION_1_1;</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_CALL_UID_FUNC_ID:</span><br><span class="line">        val[0] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_0;</span><br><span class="line">        val[1] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_1;</span><br><span class="line">        val[2] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_2;</span><br><span class="line">        val[3] = ARM_SMCCC_VENDOR_HYP_UID_KVM_REG_3;</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_FEATURES_FUNC_ID:</span><br><span class="line">        val[0] = BIT(ARM_SMCCC_KVM_FUNC_FEATURES);</span><br><span class="line">        val[0] |= BIT(ARM_SMCCC_KVM_FUNC_HYP_MEMINFO);</span><br><span class="line">        val[0] |= BIT(ARM_SMCCC_KVM_FUNC_MEM_SHARE);</span><br><span class="line">        val[0] |= BIT(ARM_SMCCC_KVM_FUNC_MEM_UNSHARE);</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_HYP_MEMINFO_FUNC_ID:</span><br><span class="line">        if (smccc_get_arg1(vcpu) ||</span><br><span class="line">            smccc_get_arg2(vcpu) ||</span><br><span class="line">            smccc_get_arg3(vcpu)) &#123;</span><br><span class="line">            val[0] = SMCCC_RET_INVALID_PARAMETER;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            val[0] = PAGE_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_MEM_SHARE_FUNC_ID:</span><br><span class="line">        return pkvm_memshare_call(hyp_vcpu, exit_code);</span><br><span class="line">    case ARM_SMCCC_VENDOR_HYP_KVM_MEM_UNSHARE_FUNC_ID:</span><br><span class="line">        return pkvm_memunshare_call(hyp_vcpu);</span><br><span class="line">    default:</span><br><span class="line">        return pkvm_handle_psci(hyp_vcpu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    smccc_set_retval(vcpu, val[0], val[1], val[2], val[3]);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pgatble.pgd 是ttbr0_el2</p>
<p>host_mmu 是vttbr_el2 </p>
<p>如何配置host stage2？ fix_host_ownership与host pf</p>
<h3 id="kvm-call-hyp-nvhe"><a href="#kvm-call-hyp-nvhe" class="headerlink" title="kvm_call_hyp_nvhe"></a>kvm_call_hyp_nvhe</h3><p>vbar_el2的el1_sync可能为</p>
<ul>
<li>Host stage2 page fault：需要保存恢复通用寄存器</li>
<li>Host hypercall：需要x0作为返回值</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __create_hyp_private_mapping(<span class="type">phys_addr_t</span> phys_addr, <span class="type">size_t</span> size,</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">long</span> *haddr,</span><br><span class="line">                    <span class="keyword">enum</span> kvm_pgtable_prot prot)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> addr;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">kvm_host_owns_hyp_mappings</span>()) &#123;</span><br><span class="line">        addr = <span class="built_in">kvm_call_hyp_nvhe</span>(__pkvm_create_private_mapping,</span><br><span class="line">                     phys_addr, size, prot);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IS_ERR_VALUE</span>(addr))</span><br><span class="line">            <span class="keyword">return</span> addr;</span><br><span class="line">        *haddr = addr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size = <span class="built_in">PAGE_ALIGN</span>(size + <span class="built_in">offset_in_page</span>(phys_addr));</span><br><span class="line">    ret = <span class="built_in">hyp_alloc_private_va_range</span>(size, &amp;addr);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = __create_hyp_mappings(addr, size, phys_addr, prot);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    *haddr = addr + <span class="built_in">offset_in_page</span>(phys_addr);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">kvm_cpu_context</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">user_pt_regs</span> regs;   <span class="comment">/* sp = sp_el0 */</span></span><br><span class="line"></span><br><span class="line">    u64 spsr_abt;</span><br><span class="line">    u64 spsr_und;</span><br><span class="line">    u64 spsr_irq;</span><br><span class="line">    u64 spsr_fiq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">user_fpsimd_state</span> fp_regs;</span><br><span class="line"></span><br><span class="line">    u64 sys_regs[NR_SYS_REGS];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">kvm_vcpu</span> *__hyp_running_vcpu;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This pointer has to be 4kB aligned. */</span></span><br><span class="line">    u64 *vncr_array;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">user_pt_regs</span> &#123;</span><br><span class="line">    __u64       regs[<span class="number">31</span>];</span><br><span class="line">    __u64       sp;</span><br><span class="line">    __u64       pc;</span><br><span class="line">    __u64       pstate;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cpu_reg(ctxt, r)    (ctxt)-&gt;regs.regs[r]</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_REG(type, name, ctxt, reg)  \</span></span><br><span class="line"><span class="meta">                type name = (type)cpu_reg(ctxt, (reg))</span></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handle_trap</span><span class="params">(<span class="keyword">struct</span> kvm_cpu_context *host_ctxt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 esr = <span class="built_in">read_sysreg_el2</span>(SYS_ESR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">ESR_ELx_EC</span>(esr)) &#123;</span><br><span class="line">    <span class="keyword">case</span> ESR_ELx_EC_HVC64:</span><br><span class="line">        <span class="built_in">handle_host_hcall</span>(host_ctxt);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">handle___pkvm_create_private_mapping</span><span class="params">(<span class="keyword">struct</span> kvm_cpu_context *host_ctxt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">DECLARE_REG</span>(<span class="type">phys_addr_t</span>, phys, host_ctxt, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">DECLARE_REG</span>(<span class="type">size_t</span>, size, host_ctxt, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">DECLARE_REG</span>(<span class="keyword">enum</span> kvm_pgtable_prot, prot, host_ctxt, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * __pkvm_create_private_mapping() populates a pointer with the</span></span><br><span class="line"><span class="comment">     * hypervisor start address of the allocation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * However, handle___pkvm_create_private_mapping() hypercall crosses the</span></span><br><span class="line"><span class="comment">     * EL1/EL2 boundary so the pointer would not be valid in this context.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Instead pass the allocation address as the return value (or return</span></span><br><span class="line"><span class="comment">     * ERR_PTR() on failure).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> haddr;</span><br><span class="line">    <span class="type">int</span> err = __pkvm_create_private_mapping(phys, size, prot, &amp;haddr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        haddr = (<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">ERR_PTR</span>(err);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cpu_reg</span>(host_ctxt, <span class="number">1</span>) = haddr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">DEFINE</span>(CPU_USER_PT_REGS,  <span class="built_in">offsetof</span>(<span class="keyword">struct</span> kvm_cpu_context, regs));</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPU_XREG_OFFSET(x)  (CPU_USER_PT_REGS + 8*x)</span></span><br><span class="line"></span><br><span class="line">.macro save_callee_saved_regs ctxt</span><br><span class="line">    str x18,      [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">18</span>)]</span><br><span class="line">    stp x19, x20, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">19</span>)]</span><br><span class="line">    stp x21, x22, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">21</span>)]</span><br><span class="line">    stp x23, x24, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">23</span>)]</span><br><span class="line">    stp x25, x26, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">25</span>)]</span><br><span class="line">    stp x27, x28, [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">27</span>)]</span><br><span class="line">    stp x29, lr,  [\ctxt, #<span class="built_in">CPU_XREG_OFFSET</span>(<span class="number">29</span>)]</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro get_host_ctxt reg, tmp</span><br><span class="line">    adr_this_cpu \reg, kvm_host_data, \tmp</span><br><span class="line">    add \reg, \reg, #HOST_DATA_CONTEXT</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @dst: Result of per_cpu(sym, smp_processor_id()) (can be SP)</span></span><br><span class="line"><span class="comment"> * @sym: The name of the per-cpu variable</span></span><br><span class="line"><span class="comment"> * @tmp: scratch register</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro adr_this_cpu, dst, sym, tmp</span><br><span class="line">    adrp    \tmp, \sym</span><br><span class="line">    add \dst, \tmp, #:lo12:\sym</span><br><span class="line">    get_this_cpu_offset \tmp</span><br><span class="line">    add \dst, \dst, \tmp</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro  get_this_cpu_offset, dst</span><br><span class="line">    mrs \dst, tpidr_el2</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">展开后：</span><br><span class="line">adrp    x1, kvm_host_data</span><br><span class="line">add x0, x1, #:lo12:kvm_host_data</span><br><span class="line">mrs x1, tpidr_el2</span><br><span class="line">add x0, x0, x1</span><br><span class="line">add x0, x0, #HOST_DATA_CONTEXT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.macro host_el1_sync_vect</span><br><span class="line">        .align <span class="number">7</span></span><br><span class="line">.L__vect_start\@:</span><br><span class="line">        stp        x0, x1, [sp, #<span class="number">-16</span>]!</span><br><span class="line">        mrs        x0, esr_el2</span><br><span class="line">        ubfx        x0, x0, #ESR_ELx_EC_SHIFT, #ESR_ELx_EC_WIDTH</span><br><span class="line">        cmp        x0, #ESR_ELx_EC_HVC64</span><br><span class="line">        b.<span class="function">eq        __host_hvc</span></span><br><span class="line"><span class="function">        b        __host_exit</span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">SYM_FUNC_START</span><span class="params">(__host_exit)</span></span></span><br><span class="line"><span class="function">        get_host_ctxt        x0, x1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Store the host regs x2 and x3 */</span></span></span><br><span class="line"><span class="function">        stp        x2, x3,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">2</span>)</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Retrieve the host regs x0-x1 from the stack */</span></span></span><br><span class="line"><span class="function">        ldp        x2, x3, [sp], #16        <span class="comment">// x0, x1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Store the host regs x0-x1 and x4-x17 */</span></span></span><br><span class="line"><span class="function">        stp        x2, x3,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">0</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x4, x5,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">4</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x6, x7,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">6</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x8, x9,   [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">8</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x10, x11, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">10</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x12, x13, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">12</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x14, x15, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">14</span>)</span>]</span></span><br><span class="line"><span class="function">        stp        x16, x17, [x0, #<span class="title">CPU_XREG_OFFSET</span><span class="params">(<span class="number">16</span>)</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Store the host regs x18-x29, lr */</span></span></span><br><span class="line"><span class="function">        save_callee_saved_regs x0</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">/* Save the host context pointer in x29 across the function call */</span></span></span><br><span class="line"><span class="function">        mov        x29, x0</span></span><br><span class="line"><span class="function">        bl        handle_trap</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">__host_enter_restore_full:</span></span><br><span class="line"><span class="function">        /* Restore host regs x0-x17 */</span></span><br><span class="line"><span class="function">        ldp        x0, x1,   [x29, #CPU_XREG_OFFSET(<span class="number">0</span>)]</span></span><br><span class="line"><span class="function">        ldp        x2, x3,   [x29, #CPU_XREG_OFFSET(<span class="number">2</span>)]</span></span><br><span class="line"><span class="function">        ldp        x4, x5,   [x29, #CPU_XREG_OFFSET(<span class="number">4</span>)]</span></span><br><span class="line"><span class="function">        ldp        x6, x7,   [x29, #CPU_XREG_OFFSET(<span class="number">6</span>)]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        /* x0<span class="number">-7</span> are use for panic arguments */</span></span><br><span class="line"><span class="function">__host_enter_for_panic:</span></span><br><span class="line"><span class="function">        ldp        x8, x9,   [x29, #CPU_XREG_OFFSET(<span class="number">8</span>)]</span></span><br><span class="line"><span class="function">        ldp        x10, x11, [x29, #CPU_XREG_OFFSET(<span class="number">10</span>)]</span></span><br><span class="line"><span class="function">        ldp        x12, x13, [x29, #CPU_XREG_OFFSET(<span class="number">12</span>)]</span></span><br><span class="line"><span class="function">        ldp        x14, x15, [x29, #CPU_XREG_OFFSET(<span class="number">14</span>)]</span></span><br><span class="line"><span class="function">        ldp        x16, x17, [x29, #CPU_XREG_OFFSET(<span class="number">16</span>)]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        /* Restore host regs x18-x29, lr */</span></span><br><span class="line"><span class="function">        restore_callee_saved_regs x29</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        /* Do not touch any register after this! */</span></span><br><span class="line"><span class="function">__host_enter_without_restoring:</span></span><br><span class="line"><span class="function">        eret</span></span><br><span class="line"><span class="function">        sb</span></span><br><span class="line"><span class="function">SYM_FUNC_END(__host_exit)</span></span><br></pre></td></tr></table></figure>

<p>tpidr_el2硬件不会用 可以软件自己用 </p>
<p>把每个cpu一个的context存在这个寄存器中</p>
<p>handler想改寄存器 直接改内存 eret之前恢复寄存器</p>
<ul>
<li>没改 那就是最早的值 （mem abort）</li>
<li>改了 就把改完的内存值恢复到寄存器 （host hypercall）</li>
</ul>
<p>实际上可以直接在handler最后用write tpidr_el2来取代ret 不需要提供修改所有寄存器的接口</p>
<p>但是仍然需要保存恢复寄存器 只不过用的是栈</p>
<h3 id="Gdb"><a href="#Gdb" class="headerlink" title="Gdb"></a>Gdb</h3><p>b do_pkvm_init</p>
<p>hvc进入EL2 看b eq地址</p>
<p>aarch64-linux-gnu-objdump -d vmlinux &gt; arm.out</p>
<p>gdb中 0xb8dd0127f214 0xb8dd0127f000</p>
<p>vmlinux中ffff80008107f214 ffff80008107f000</p>
<p>offset 0xfffec7237fe00000 每次会变</p>
<p>ffff800081082710 &lt;__kvm_nvhe_fix_host_ownership_walker&gt;. -&gt;0xb8dd01282710</p>
<p>最后5个不变</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>kernel内存启动初始化早期拿出一块地址给EL2用 EL2有一套自己管理内存的方法库</li>
<li>一套精妙的EL2页表操作代码(kvm_pgtable_walk) 处理hyp stage1 host stage2 guest stage2</li>
<li>在valid和invalid pte上都加入bit表示owner host hyp guest</li>
<li>host stage2采用lazy mapping 发生page fault的时候到EL2补映射</li>
<li>用0表示owner是host，这样巧妙地不需要对host stage2进行自己的处理，只需要把属于hyp的设为1</li>
<li>在初始化完整后直接启用host stage2页表</li>
<li>guest的stage2 页表由kvm维护（与pkvm无关）</li>
<li>Guest的stage2页表操作从EL1提到EL2处理</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/papers/WESEE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/papers/WESEE/" class="post-title-link" itemprop="url">WESEE: Using Malicious #VC Interrupts to Break AMD SEV-SNP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:48:29 / Modified: 20:53:17" itemprop="dateCreated datePublished" datetime="2025-02-04T20:48:29+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>934</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WESEE-Using-Malicious-VC-Interrupts-to-Break-AMD-SEV-SNP"><a href="#WESEE-Using-Malicious-VC-Interrupts-to-Break-AMD-SEV-SNP" class="headerlink" title="WESEE: Using Malicious #VC Interrupts to Break AMD SEV-SNP"></a>WESEE: Using Malicious #VC Interrupts to Break AMD SEV-SNP</h1><p>IEEE S&amp;P 2024</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjMyMzI3ZjhiYTRjYmU1M2U3MTM1MzIzNTBjZjgwNzdfRW5FMzNOSmlHUkRGQkdzSnpoVlVnSm9ZTG1ZRVBUUVNfVG9rZW46TDVKNmJtTHJIb25Wb1d4RkZXTGM0NXlmbmxmXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>Linux kernel作为最广泛使用的支持CVM的guest OS，攻击面仍然很大，通过精心利用某些漏洞（如恶意中断）可以完成端到端的攻击（root shell）。</p>
<p><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25742">&gt; CVE-2024-25742</a></p>
<h2 id="Background：-VC-exception"><a href="#Background：-VC-exception" class="headerlink" title="Background：#VC exception"></a>Background：#VC exception</h2><h3 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h3><p>SEV-ES保护了寄存器，增加GHCB用于Guest-Host通信</p>
<p>当发生某些vmexit时，hypervisor需要当前guest的寄存器信息为guest提供服务</p>
<ul>
<li>cpuid</li>
<li>rdtsc</li>
<li>MMIO</li>
</ul>
<p>引入#VC exception（中断号29） 便于拷贝相应的寄存器信息</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MDBiMjgyYzM4NWEyNDYzM2Q5YjNkN2MzY2ZjNWJiNmNfRXlZUXc3Vmo4cmlaYnBUZ3h2S0paYXJkemNyQUVUcHBfVG9rZW46TzlLdmJWczNmb013NE14ZGRqcWNNamZLbktjXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>exception_number和exit_reason可以由软件配置！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">svm-&gt;vmcb-&gt;control.event_inj = user_data_npf_ex.exception_number | SVM_EVTINJ_VALID | SVM_EVTINJ_VALID_ERR | SVM_EVTINJ_TYPE_INTR;</span><br><span class="line">svm-&gt;vmcb-&gt;control.event_inj_err = user_data_npf_ex.exception_error_code;</span><br></pre></td></tr></table></figure>

<h3 id="Simple-attack"><a href="#Simple-attack" class="headerlink" title="Simple attack"></a>Simple attack</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmVjZGJjM2RmNDU4MGFjZTZmNzUwMzc2ZDViOGQ1NjVfWEQ0QXBab0Z5aTUyaDBxa3JYYmF1YVIxRjhhQ25NRzVfVG9rZW46V0dJcGJKZTdEb0JqeUx4Z2d2YmNEdUFHbjFlXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YzFhZGRlODIxYWVhYTE0NjQ0OTE4N2ExMGU1ZjcxODNfWGo0cERFWVFQWUppVEN0THhZYjNuWEFiWTllMW1FMFRfVG9rZW46WTdxN2I2TnZob0dZZUJ4dDlWNWM3WWxZbnNiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="VC-ability"><a href="#VC-ability" class="headerlink" title="VC ability"></a>VC ability</h3><ul>
<li>Chaining multiple #VC</li>
<li>Nesting #VC in non-critical section</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=Yzk1NGJkYmM5N2Q5MGFmODhhNDhiZDRiZmQzZDBhNzhfQ0tlSE1ZMUg5YTlQV0k5dmdTZnVsVW1iYjRIOEtXUTVfVG9rZW46VDVSa2J4TThEb2hVUlV4NjQwN2N3Qk55bkw3XzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NzYxYTZkYzVlYWYxNzY0YjgzMzBhN2NmODQyY2I5YjlfeTF3TUZEYkx2NkVSa2sxdDFGM2V5OHdpS3NieW5CclpfVG9rZW46Vnc2VWJKZnIxb243VDB4MjJxOWNVSFFBbnBoXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>只用vmmcall和mmio read&#x2F;write 三种情况就可以构造足够强大的attack primitives</p>
<h2 id="Attack-Primitives"><a href="#Attack-Primitives" class="headerlink" title="Attack Primitives"></a>Attack Primitives</h2><p>利用vanilla linux内vc_handler的处理逻辑配合恶意#VC中断实现更强大的功能。</p>
<h3 id="Skip-Instructions"><a href="#Skip-Instructions" class="headerlink" title="Skip Instructions"></a>Skip Instructions</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTE1ZjViOTExZDljM2MzYmNmYmI3ZDcwNDBmNmU5YjJfWnM3WklhcXN6SmFudzJ6R2lnbHRteHNXV2M2ZzVtM0NfVG9rZW46WlNmbWJiOUZib0R1cTZ4dk1JMGNpcVBsbk5mXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>guest的VC handler根据hypervisor的处理结果：</p>
<ul>
<li>OK：增加rip（执行下一行指令）</li>
<li>RETRY：不增加rip（重新执行一遍原指令）</li>
</ul>
<p>exit_reason为vmmcall，rax不进行修改，返回success</p>
<p>记为S</p>
<h3 id="Read-Write-Rax"><a href="#Read-Write-Rax" class="headerlink" title="Read&amp;Write Rax"></a>Read&amp;Write Rax</h3><ul>
<li>exit_reason为vmmcall，rax进行修改，返回success-&gt;记为 WraxS</li>
<li>利用nesting VC 跳过line8-line13，共15行汇编，(WraxS).15S &#x3D; Wrax</li>
</ul>
<h3 id="Reading-Kernel-Memory"><a href="#Reading-Kernel-Memory" class="headerlink" title="Reading Kernel Memory"></a>Reading Kernel Memory</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov [rdi], rbx</span><br></pre></td></tr></table></figure>

<p>hypervisor需要rdi指向地址的值与rbx的值</p>
<ul>
<li>并不是直接mov rbx到GHCB，而是有另一块内存（context）进行中转</li>
<li>中转的过程中会使用rax保存rbx的值所在的内存地址，然后用memcpy复制到GHCB</li>
<li>利用Wrax修改rax指向guest secret va，memcpy会把secret 拷贝到GHCB暴露给hypervisor</li>
<li>利用Wrax绕过后续的检查</li>
</ul>
<p>记为Rmem</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YmFkYTlkZGJkZjA4YzFiZDA2ZTdmODMzZTA0NDIxZTJfOWVLZGd3cDlRV0M5YWV2NkdvcUVaR21HVGxlM1czTUNfVG9rZW46SnFHdmJqY216b0gzMEt4UDRIemN3aXRnbkhiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="Writing-Kernel-Memory"><a href="#Writing-Kernel-Memory" class="headerlink" title="Writing Kernel Memory"></a>Writing Kernel Memory</h3><p>Wmem原理同Rmem</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rbx, [rdi]</span><br></pre></td></tr></table></figure>

<p>guest需要把hypervisor提供的值放到寄存器rbx中</p>
<ul>
<li>并不是直接把GHCB内存mov到rbx，而是有另一块内存（context）进行中转</li>
<li>中转的过程中会使用rax保存rbx的值所在的内存地址，然后用memcpy复制到这块地址</li>
<li>利用Wrax修改rax指向guest target va，memcpy会把hypervisor准备的恶意值拷贝到guest私有内存</li>
<li>利用Wrax绕过检查</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTA5YmNjNDUyYjQ1NmEyY2EyNjUyOTc4YzNiOWUxMGZfYkp2NEVuVUx5RmRFVHBmc2NVTG9sZ3hoSjFlZUViNDRfVG9rZW46S0JuTmJvWEpSb1o0NDd4MElnOWNzd3FpbnVkXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="Arbitrary-Code-Injection"><a href="#Arbitrary-Code-Injection" class="headerlink" title="Arbitrary Code Injection"></a>Arbitrary Code Injection</h3><p>目标：往.text section注入恶意的shellcode</p>
<ul>
<li>提前静态分析，得到内核页表基地址所在地址（不考虑地址随机化的情况下）</li>
<li>Rmem读出页表基地址（CR3的值），Wmem改页表权限</li>
</ul>
<h2 id="Problems-To-be-Solved"><a href="#Problems-To-be-Solved" class="headerlink" title="Problems To be Solved"></a>Problems To be Solved</h2><h3 id="Where-To-Inject-？"><a href="#Where-To-Inject-？" class="headerlink" title="Where To Inject ？"></a>Where To Inject ？</h3><p>绕过ASLR</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ODI1NDEwNDNhYWJhMDA0YjllMjBjMTFkN2VmOTJlOTNfOHhxSjJSRUlJZ3VLUzZVRThwTFZOdk9Hd28ydUZYTHFfVG9rZW46WDJjaGJNWUdGb2tLeE14TzRoN2NKcW1CbmhmXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<ul>
<li>kernel在地址随机化之前，早期的地址是固定的。</li>
<li>提前分析得出kernel在地址随机化之前的最后一个page地址 （0x7a753000）</li>
<li>运行时，这个page之后的page地址就可以计算出随机的PKbase</li>
</ul>
<h3 id="When-To-Inject？"><a href="#When-To-Inject？" class="headerlink" title="When To Inject？"></a>When To Inject？</h3><ul>
<li>离线采样得到page序列，同之前的攻击（Heckler等）</li>
<li>运行时hypervisor修改stage2页表权限，通过page fault得到guest正在执行的page 序列</li>
<li>直接通过guest的符号表可以找到函数对应的固定地址（同PKbase进行计算）</li>
</ul>
<h2 id="Case-studies"><a href="#Case-studies" class="headerlink" title="Case studies"></a>Case studies</h2><h3 id="Leaking-keys-from-Kernel-TLS"><a href="#Leaking-keys-from-Kernel-TLS" class="headerlink" title="Leaking keys from Kernel TLS"></a>Leaking keys from Kernel TLS</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWNiMGVhNjM3MWI0ODhhZmVhNzQwYjZlNzk3YjE5ZDVfT0pHdXQ2WFpJajZTOVgxRUV6M1VMam9QZDd0VmpIT2JfVG9rZW46WGtBSmJmNnh6b0xOdXB4bDhyV2Mxb01xbndiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<h3 id="Disabling-Firewall"><a href="#Disabling-Firewall" class="headerlink" title="Disabling Firewall"></a>Disabling Firewall</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTI3YzJlNWY5MTRkYThjYmFhMGI5ZTM3MGI0YzUxMzRfM1haVkVXbzlONnhsYTJhTEdGNE1QQTNqTTZuR0Z1eG9fVG9rZW46UnNjSWJDUTExb0VJVjV4QmxodWNacmpWbkZiXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>改16bytes</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDVjNTY2Nzc5YzY4NjQ3MTNlMDUzMDQ4MTQzNTBlYmZfSEU2eGZZRHZLT1ZtNmMzQWVpTmlGNHpVNnZXWnpNNkZfVG9rZW46TjhqM2JwekJ3bzBJNGp4MVlDN2M0dGNCbjliXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>绕过所有iptables的规则</p>
<h3 id="Gaining-a-Root-Shell-in-the-SEV-SNP-VM"><a href="#Gaining-a-Root-Shell-in-the-SEV-SNP-VM" class="headerlink" title="Gaining a Root Shell in the SEV-SNP VM"></a>Gaining a Root Shell in the SEV-SNP VM</h3><p>利用kernel API：call_usermodehelper</p>
<p>以root权限创建一个用户态进程，参数为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c rm /tmp/t; mknod /tmp/t p;</span><br><span class="line">/bin/sh 0&lt;/tmp/t \| nc -ln 8001 1&gt;/tmp/t</span><br></pre></td></tr></table></figure>

<p>创建一个root shell并通过8001端口向外通信</p>
<p>作者将这段逻辑构造为shellcode （392bytes）并注入到icmp_rcv中，可以通过ping触发</p>
<p>暂时无法在飞书文档外展示此内容</p>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><ul>
<li>SEV-SNP</li>
<li>Linux kernel v6.5.0</li>
<li>Ubuntu 20.04.6 LTS</li>
<li>QEMU v8.0.0</li>
</ul>
<h3 id="Primitives"><a href="#Primitives" class="headerlink" title="Primitives"></a>Primitives</h3><ul>
<li>216450 instruction skips&#x2F;s </li>
<li>9.25 memory reads&#x2F;s</li>
<li>8.95 memory writes&#x2F;s</li>
</ul>
<h3 id="Case-studies-1"><a href="#Case-studies-1" class="headerlink" title="Case studies"></a>Case studies</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NDAxNmM3ZTg1MjljMGNlMTMzZmNlMTI2NmRlNjc3ZTBfd0U2alJKZnFXUVh3RGs5dVlOZWpCTEt2MGNObU1UVWhfVG9rZW46UXNHOGI0WGdHb0xNNkp4TG13SWNLWDEybndjXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p>分别需要5.97 0.36 8.1s</p>
<h2 id="Defense"><a href="#Defense" class="headerlink" title="Defense"></a>Defense</h2><p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e3ef461af35a8c74f2f4ce6616491ddb355a208f">x86&#x2F;sev: Harden #VC instruction emulation somewhat</a></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YzM1ZTVlMzE1ZTIxZDcxMDMxMTkzNjZkZjQ4NDljNjFfQnhkN1BIdHFoVFRpbUtGcTg5dmxkNTU3UEpKcFh4NFZfVG9rZW46WFkzOWJBU3l6b2xtVHl4a3NRVGNBcVBDbjBnXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFjYTcwY2I5MDNmMTkzMjRiMDE3MDYyYTUzZmQ2MzdfcjJZc3BPU1pwV1NYTUlOcWY3eG1mU0QzeXN5MlMyS0xfVG9rZW46S0tXMGJTVWFFb0tBRGN4WUh4WGN1MXAxbjRlXzE3Mzg2NzMyODM6MTczODY3Njg4M19WNA" alt="img"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/papers/FetchBPF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/papers/FetchBPF/" class="post-title-link" itemprop="url">FetchBPF: Customizable Prefetching Policies in Linux with eBPF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:45:13 / Modified: 20:53:17" itemprop="dateCreated datePublished" datetime="2025-02-04T20:45:13+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>935</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="FetchBPF-Customizable-Prefetching-Policies-in-Linux-with-eBPF"><a href="#FetchBPF-Customizable-Prefetching-Policies-in-Linux-with-eBPF" class="headerlink" title="FetchBPF: Customizable Prefetching Policies in Linux with eBPF"></a>FetchBPF: Customizable Prefetching Policies in Linux with eBPF</h1><p>ATC’24</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=Mjg4YWYzNDI2Y2E2ZGNjZDliMDRhNTgwNTU1ZmZlMDJfWDFTczE1UVBzYkswT2dlQ3Y4ekdHUlhPUmp1MVpzNXJfVG9rZW46SFJSbGJyeEpBb2F1aVR4YzlEcWMzOHhabnJnXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>基于eBPF设计了一个框架，使得用户可以定制自己的memory prefetch策略</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>linux的某些策略平均表现很好，但是很难在特定的情况下取得最好的性能。</p>
<h3 id="Memory-prefetching"><a href="#Memory-prefetching" class="headerlink" title="Memory prefetching"></a>Memory prefetching</h3><p>内存压力大时，内存页会被swap out，之后需要用时，swap in会很慢</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjZmOWIyOWFhNDg0NTRhMDhlNTZhZGRlMTIyM2M5N2RfODdJWE95ZW02M0dDaGdEREJSTzg5TzhYSHBicTFzRHJfVG9rZW46UXA2R2JhdzVEb2VjYkx4cTMzdWNvc0ZBblFoXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>为了提高性能，操作系统会预测哪些swapped out的pages可能会被用到，prefetch这些pages</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjJkNGY3OGUzZDMyNDY4NDVlYTE4ZTc4OGE5MTIxNjhfZERmWmI3S001RXpLem5QdGFPVXRaUmtvU0NkMXNKckFfVG9rZW46R3RYcGJxNXFub2N2MGZ4alNxY2NJYlhKbnJmXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>一个好的prefetch策略需要兼顾Accuracy与Coverage：</p>
<ul>
<li>Coverage：cache hits &#x2F; (cache hits + cache misses) 尽可能让之后可能发生的page fault的pages都被prefetch到</li>
<li>Accuracy：cache hits &#x2F; prefetch pages 需要保证不能prefetch太多没用的page 反而拖慢了性能</li>
</ul>
<h4 id="Linux-default-prefetch-policy"><a href="#Linux-default-prefetch-policy" class="headerlink" title="Linux default prefetch policy"></a>Linux default prefetch policy</h4><ul>
<li>只考虑sequantial pattern</li>
<li>只看过去2个page fault，如果连续，则prefetch连续的后几个pages</li>
</ul>
<h4 id="SOTA-prefetch-policy"><a href="#SOTA-prefetch-policy" class="headerlink" title="SOTA prefetch policy"></a>SOTA prefetch policy</h4><ul>
<li>LEAP：ATC‘20</li>
<li>HoPP：HPCA‘23</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MWQ4M2EzZGE2MjU0Njc5NWY0MDRhOGFkMWVhNDg1NTJfRTVNY2dFZ241M3Z0Q2FIWmlIY2ljNWpaZlM3UDhVaDBfVG9rZW46T2lLbWJwa2VOb2FXQWR4Y0VmTWNxZkZSbnZiXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=N2Y4NDdlZmJlMjI5Y2E0NzY4ZGZlOTJjMDU5ZmQ1NWFfZGl5cGF1MXB2WmVqbUdNcElWTjVQUGJNeEJub290N3BfVG9rZW46QXVlM2JDdnZZbzNHSzB4NlVOOWNZSllLblFiXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h4 id="motivation"><a href="#motivation" class="headerlink" title="motivation"></a>motivation</h4><p>不同allocation pattern和不同access pattern下 各个memory prefetch policy的性能表现</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MmI4MjIyYjk4ZjI5Yjc5YTRkMTE1NzJiY2JiOGFiYTJfUklQWFZpUkFJVjZmOXNNOVVrdWFDV3dkcEViQXhzdUhfVG9rZW46QWo3QmJaZGQ2b0hVZTl4YXVJS2N6Ykg0bkpoXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<p>结论：没有一个policy会在任何条件下比其他的policy都好。需要最适合某个application，必须为这个application定制policy</p>
<h3 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h3><blockquote>
<p>eBPF 是一项革命性的技术，起源于 Linux 内核，它可以在特权上下文中（如操作系统内核）运行沙盒程序。它用于安全有效地扩展内核的功能，而无需通过更改内核源代码或加载内核模块的方式来实现。</p>
</blockquote>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MzdhY2I4MzY3NTUwZGM1YjI1MDNjYjBlOTk3MjRmOTNfUlhRWnNGMnQyWGNnOFVPMWZ1a3hnY1EyMEplSWZLMFpfVG9rZW46VTU1Y2IzQVpHb0lTaUR4QlFMT2NDVXR0bjJjXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h2 id="Strawman-design"><a href="#Strawman-design" class="headerlink" title="Strawman design"></a>Strawman design</h2><p>改linux 实现多种prefetch policy ，根据历史的memory access pattern进行动态切换</p>
<p>问题</p>
<ol>
<li>难以支持任意数量的policy</li>
<li>很难存在一个特定的policy集合 可以适应所有的access pattern</li>
<li>在linux中实现工程量大</li>
<li>需要说服linux上游接受 需要耗费更多精力和时间</li>
</ol>
<h2 id="Design-and-implementation"><a href="#Design-and-implementation" class="headerlink" title="Design and implementation"></a>Design and implementation</h2><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MjFmMTBhNDY2NWIxOGUyNGQ3MjUxMmMwM2ZlOWI2YjNfU3NrQ3ptdTI5MjhoQW96RVBtWXZkNVBmY3h3dTZmVXVfVG9rZW46U3BmTmJzRjFXb2N5cDF4MkNPZmNBWFpmbkplXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h3 id="eBPF-Hook"><a href="#eBPF-Hook" class="headerlink" title="eBPF Hook"></a>eBPF Hook</h3><ul>
<li>(A)prefetch_stats：page fault时触发，用于记录fault pages的历史信息，便于policy找到access pattern</li>
<li>(B)prefetch_policy：执行prefetch policy时触发，需要根据算法找到需要prefetch的pages并且请求prefetch 这些pages</li>
</ul>
<h3 id="Helper-Functions"><a href="#Helper-Functions" class="headerlink" title="Helper Functions"></a>Helper Functions</h3><ul>
<li>(1)bpf_prefetch_physical_page：根据物理地址发出I&#x2F;O请求</li>
<li>(2)bpf_prefetch_virtual_page：根据虚拟地址发出I&#x2F;O请求</li>
<li>(3)bpf_&lt;start&#x2F;stop&gt;_block_plug：选择性batch上两个接口发出的I&#x2F;O请求</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=OTc4MDBhYTVlODYyZGE3N2ZkYzVmZjkyYjljNDNlYmRfN0xlQ3pFZE1JTWo2Mk9kZ1RGTnJhcmFGZTZYcE9xN1RfVG9rZW46TTA4UmJ1WlJZb2xIU0F4ZVdURmNqczRPblRmXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<h3 id="Policy-example-LEAP"><a href="#Policy-example-LEAP" class="headerlink" title="Policy example(LEAP)"></a>Policy example(LEAP)</h3><ul>
<li>eBPF map: 存储memory access history</li>
<li>prefetch_stats: 在map中存入page fault地址以及与前一个page fault地址的差</li>
<li>prefetch_policy：用Boyer-Moore识别出majority stride，调用bpf_prefetch_physical_page进行prefetch</li>
</ul>
<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><h3 id="Microbenchmarks"><a href="#Microbenchmarks" class="headerlink" title="Microbenchmarks"></a>Microbenchmarks</h3><p>分配5GB array</p>
<p>Allocation patterns：</p>
<ul>
<li>Sequential allocation（sqn）</li>
<li>Random allocation（random）：模拟多个线程同时alloc pages （这种情况使用virtual address会比physical address好）</li>
</ul>
<p>Access patterns：</p>
<ul>
<li>Sequential（sqn）</li>
<li>stride（stride）：相隔3 pages</li>
<li>ladder（ladder）：increasing stride</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDY1N2ExNWVmOWI1MDE3OWViZjgzZWI2YjE1MjU5ZWRfTVNNZ0Q5SHdYNlNkSGYzaldUNnpkUk9TbGRFbm5vM0ZfVG9rZW46SDFBMmJpRWREb0VCR1R4TGtsZ2Nwd1hFbnZlXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<ul>
<li>Accuracy、Coverage： eBPF实现版本与linux kernel版本几乎完全一致</li>
<li>Execution time：eBPF带来的overhead可以忽略不计</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YjZkY2UzZTNiZDgzZTM0Yjg2MTIwNjA4OWM4MmVjODJfcUE2Z3NCQW5PVTBXV2t3dkY4WmFnZ1NwVVF3aTNTOWpfVG9rZW46QWRFbmJzblRib2UyTm14eUhVemNkSWVVbmFiXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<ul>
<li>latency大部分的开销在page retrieval （I&#x2F;O）</li>
<li>eBPF程序被JIT编译为机器指令，性能与kernel functions差别不大</li>
</ul>
<h3 id="Macrobenchmarks"><a href="#Macrobenchmarks" class="headerlink" title="Macrobenchmarks"></a>Macrobenchmarks</h3><ul>
<li>VoltDB上运行TPC-C</li>
<li>Redis’ memtier benchmark</li>
<li>Twitter dataset上运行PageRank与betweeness centrality</li>
</ul>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDc4NDQzYWNhMTExYzVjN2I3NjdjYWFlNjU4ZWRhOGNfbVl2U0ZpaVpNWG9JRU52ZzNNUXhHMmF0ZThuVEo1YUtfVG9rZW46TmZkZ2JhWWg1bzBINll4UFNsaGM2YzU4bmdwXzE3Mzg2NzMwODk6MTczODY3NjY4OV9WNA" alt="img"></p>
<ul>
<li>对比policy及与之对应的eBPF版本，仍然没有明显的性能差别</li>
<li>好的policy在可用内存少时优势更明显</li>
</ul>
<p>关于VMA policy作者的解释：这些对性能要求极高的程序耗费了大量的时间为linux的prefetch policy做了优化</p>
<p>FetchBPF希望改变这种方式，设计policy去适配application，而不是优化application的访存模式去适配policy</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>本文基于eBPF设计了框架FetchBPF，使得用户可以根据程序的访存模式自定义内存预取策略来达到最优的性能。FetchBPF框架可以在几乎没有额外性能开销的情况下达到一致的内存预取功能。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">szy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">82k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">4:59</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
