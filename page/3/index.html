<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"szy0127.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="S blog">
<meta property="og:url" content="http://szy0127.github.io/page/3/index.html">
<meta property="og:site_name" content="S blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="szy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://szy0127.github.io/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>S blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">S blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">szy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/virtualization/balloon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/virtualization/balloon/" class="post-title-link" itemprop="url">balloon</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>11 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="balloon"><a href="#balloon" class="headerlink" title="balloon"></a>balloon</h1><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li>guest使用的内核在编译时需要把config_virtio_balloon的选项打开，可以y直接编译进内核 也可以m作为模块手动加载</li>
<li>qemu启动时加入virtio-balloon选项</li>
</ul>
<p>进入虚拟机后ctrl a c进入qemu monitor</p>
<ul>
<li>info balloon查看当前balloon大小，默认为qemu启动时指定的最大内存</li>
<li>balloon xxx(mb) 调整大小</li>
</ul>
<p>显示的balloon大小为VM真实可用的内存，剩下的给host</p>
<ul>
<li>如果不加入deflate-on-oom参数，VMfree -mh显示内存为balloon大小 超过此大小触发oom killer</li>
<li>如果加入此参数，VM free -mh显示启动指定的最大参数，但是used显示分给host的值 超过balloon大小会自动调大balloon</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.linux-kvm.org/page/Projects/auto-ballooning#TODO">Projects&#x2F;auto-ballooning - KVM (linux-kvm.org)</a></p>
<p>auto balloon似乎被废弃了</p>
<p><a target="_blank" rel="noopener" href="https://www.ovirt.org/develop/projects/mom.html">MoM | oVirt</a>这个工具可能可用</p>
<p>qmp:</p>
<ul>
<li>balloon  value</li>
<li>query-balloon</li>
</ul>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>host guest1 guest2均为4G内存</p>
<ol>
<li>guest1要2G 从内存分配</li>
<li>guest2要2G swap掉guest1</li>
<li>guest1要2G swap掉guest2</li>
</ol>
<p><strong>1 正常情况  guest2要内存 host内存不够 回收 但是guest1的2G被swap</strong> 从htop中guest1的qemu 进程mem占用情况可以看出来</p>
<p>ctrl a c 输入info balloon &#x2F;balloon xxx (MB)</p>
<p>balloon后面的数字代表VM真实可用内存(不参与balloon) 这个值不能超过qemu启动分配的内存</p>
<p>balloon目前找不到合适的自动化监控，需要手动用qemu调</p>
<p><strong>2 guest2需要很多内存的时候手动进guest1的qemu monitor 调小balloon 然后reclaim会直接回收而不是swap</strong></p>
<p>balloon只会回收guest内存 不会回收host上被swap的guest的页</p>
<p><a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/1519495184466483140.html">KVM之四：内存balloon的奇妙_百度知道 (baidu.com)</a></p>
<blockquote>
<p>目前没有比较方便的、自动化的机制来管理ballooning，一般都是采用在QEMU monitor中执行balloon命令来实现ballooning的。没有对VM的有效监控，没有自动化的ballooning机制，这可能会让生产环境中实现大规模自动化部署并不很方便。</p>
</blockquote>
<p><strong>3 如果memhog后sleep 持续占用内存 那balloon会直接把这个进程kill掉 强行拿掉VM的内存</strong></p>
<p>所以用balloon和不用在结果上是有很大区别的。不用balloon host会把VM的所有内存都swap掉 不管free与否；用balloon host会强行回收VM内存 如果不够就让VMkill自己的进程 </p>
<p><strong>4 如果VM配了 swap VM会swap</strong></p>
<blockquote>
<p>如果有大量内存从VM系统中回收，Ballooning可能会降低VM操作系统运行的性能。一方面，内存的减少，可能会让VM中作为磁盘数据缓存的内存被放到气球中，从而VM中的磁盘I&#x2F;O访问会增加；另一方面，如果处理机制不够好，也可能让VM中正在运行的进程由于内存不足而执行失败。</p>
</blockquote>
<p>[<a target="_blank" rel="noopener" href="https://listman.redhat.com/archives/libvir-list/2015-December/msg00494.html">libvirt] [PATCH 2&#x2F;2] qemu: add support of optional ‘deflate-on-oom’ attribute (redhat.com)</a></p>
<p>qemu中可以加入deflate-on-oom的选项，这时候配置了balloon并不会让VM的可用内存变小，而是在VM可用内存不变的情况下增加了Used，之后不会影响VM程序的正常使用。<strong>5 当VM需要的内存大于balloon配置之后，会自动进行deflate 向host要内存 此时info balloon可以看到balloon的值被自动调大了</strong>。但是被调大之后是不会再自动缩小的</p>
<p><strong>6 VM自己swap的优先级是比deflate-on-oom的优先级高的</strong></p>
<p><strong>7 在VMlogout的时候 balloon进行回收 仍然能回收到</strong></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/14684138.html">virtio简介（二） —— virtio-balloon guest侧驱动 - Edver - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="http://ssdxiao.github.io/linux/2017/03/20/Virtio-Balloon.html">Virtio-Balloon超详细分析 (ssdxiao.github.io)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> <span class="title">virtio_balloon_driver</span> =</span> &#123;</span><br><span class="line">	.feature_table = features,</span><br><span class="line">	.feature_table_size = ARRAY_SIZE(features),</span><br><span class="line">	.driver.name =	KBUILD_MODNAME,</span><br><span class="line">	.driver.owner =	THIS_MODULE,</span><br><span class="line">	.id_table =	id_table,</span><br><span class="line">	.validate =	virtballoon_validate,</span><br><span class="line">	.probe =	virtballoon_probe,</span><br><span class="line">	.remove =	virtballoon_remove,</span><br><span class="line">	.config_changed = virtballoon_changed,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PM_SLEEP</span></span><br><span class="line">	.freeze	=	virtballoon_freeze,</span><br><span class="line">	.restore =	virtballoon_restore,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>本身暴露的接口并不多 可以认为就<code>virtballoon_changed</code>一个</p>
<p>这个内核模块是前端</p>
<p>需要qemu添加<code>-device virtio-balloon-pci</code>在宿主机上创建一个balloon后端</p>
<p>qemu monitor中的balloon指令会向VM中的驱动发送指令，从而调用<code>virtballoon_changed</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __virtio_config_changed(<span class="keyword">struct</span> virtio_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">virtio_driver</span> *<span class="title">drv</span> =</span> drv_to_virtio(dev-&gt;dev.driver);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dev-&gt;config_enabled)</span><br><span class="line">		dev-&gt;config_change_pending = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (drv &amp;&amp; drv-&gt;config_changed)</span><br><span class="line">		drv-&gt;config_changed(dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>update_balloon_size_func</code> 每次<code>virtballoon_changed</code>只会发生一次 但是调整大小的函数会触发很多次 不是一次性调整好的，并且<code>virtballoon_changed</code>是异步。如果每次update输出时间影响效率</p>
<p>内核启动时<code>vp_find_vqs_intx</code>注册<code>vp_interrupt</code> 之后向队列写入信息时会产生中断</p>
<p><code>vp_interrupt</code>-&gt;<code>vp_config_changed</code>-&gt;<code>virtio_config_changed</code>-&gt;<code>__virtio_config_changed</code></p>
<p>注册vp_interrupt的函数 追踪调用 发现是probe的init_vqs probe由virio_bus的probe调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">bind_store</span><span class="params">(<span class="keyword">struct</span> device_driver *drv, <span class="type">const</span> <span class="type">char</span> *buf,</span></span><br><span class="line"><span class="params">			  <span class="type">size_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> *<span class="title">bus</span> =</span> bus_get(drv-&gt;bus);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">int</span> err = -ENODEV;</span><br><span class="line"></span><br><span class="line">	dev = bus_find_device_by_name(bus, <span class="literal">NULL</span>, buf);</span><br><span class="line">	<span class="keyword">if</span> (dev &amp;&amp; driver_match_device(drv, dev)) &#123;</span><br><span class="line">		err = device_driver_attach(drv, dev);</span><br><span class="line">		<span class="keyword">if</span> (!err) &#123;</span><br><span class="line">			<span class="comment">/* success */</span></span><br><span class="line">			err = count;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	put_device(dev);</span><br><span class="line">	bus_put(bus);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> device *<span class="title function_">bus_find_device</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> bus_type *bus,</span></span><br><span class="line"><span class="params">			       <span class="keyword">struct</span> device *start, <span class="type">const</span> <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">			       <span class="type">int</span> (*match)(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">void</span> *data))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">sp</span> =</span> bus_to_subsys(bus);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">klist_iter</span> <span class="title">i</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sp)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	klist_iter_init_node(&amp;sp-&gt;klist_devices, &amp;i,</span><br><span class="line">			     (start ? &amp;start-&gt;p-&gt;knode_bus : <span class="literal">NULL</span>));</span><br><span class="line">	<span class="keyword">while</span> ((dev = next_device(&amp;i)))</span><br><span class="line">		<span class="keyword">if</span> (match(dev, data) &amp;&amp; get_device(dev))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	klist_iter_exit(&amp;i);</span><br><span class="line">	subsys_put(sp);</span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">device_match_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="type">void</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> sysfs_streq(dev_name(dev), name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有device维护在bus这个数据结构中</p>
<p><code>mdev_device_create</code> 创建device</p>
<p>对于qemu的info操作 似乎并不会触发内核的函数 如何通过一个接口看一下时间？</p>
<p>在update size函数中 如果无变化返回之前 加入print</p>
<p>即想查看的时候同样用修改的接口 输入一个不变的值即可</p>
<p>从结果来看比较准确且稳定</p>
<p>fill_balloon会从内核模块alloc page 表示已经拿了这个page 所以guest kernel没法用了</p>
<p>leak_balloon释放这个page</p>
<h3 id="fill"><a href="#fill" class="headerlink" title="fill"></a>fill</h3><h4 id="guest"><a href="#guest" class="headerlink" title="guest"></a>guest</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> page *<span class="title function_">balloon_page_alloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> alloc_page(balloon_mapping_gfp_mask() |</span><br><span class="line">				       __GFP_NOMEMALLOC | __GFP_NORETRY);</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="title function_">fill_balloon</span><span class="params">(<span class="keyword">struct</span> virtio_balloon *vb, <span class="type">size_t</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> num_allocated_pages;</span><br><span class="line">	<span class="type">unsigned</span> num_pfns;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	LIST_HEAD(pages);</span><br><span class="line">	num = min(num, ARRAY_SIZE(vb-&gt;pfns));</span><br><span class="line">	<span class="keyword">for</span> (num_pfns = <span class="number">0</span>; num_pfns &lt; num;</span><br><span class="line">	     num_pfns += VIRTIO_BALLOON_PAGES_PER_PAGE) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> balloon_page_alloc();</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//local list 和balloon_page_pop对应 只是一次性全部alloc而已</span></span><br><span class="line">		balloon_page_push(&amp;pages, page);</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_lock(&amp;vb-&gt;balloon_lock);</span><br><span class="line">	vb-&gt;num_pfns = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ((page = balloon_page_pop(&amp;pages))) &#123;</span><br><span class="line">        <span class="comment">//把这次拿到的page全部加入balloon中</span></span><br><span class="line">		balloon_page_enqueue(&amp;vb-&gt;vb_dev_info, page);</span><br><span class="line">		set_page_pfns(vb, vb-&gt;pfns + vb-&gt;num_pfns, page);</span><br><span class="line">		vb-&gt;num_pages += VIRTIO_BALLOON_PAGES_PER_PAGE;</span><br><span class="line">		<span class="keyword">if</span> (!virtio_has_feature(vb-&gt;vdev,</span><br><span class="line">					VIRTIO_BALLOON_F_DEFLATE_ON_OOM))</span><br><span class="line">            <span class="comment">//如果没开DEFLATE_ON_OOM guest内核可用的page是减少的</span></span><br><span class="line">			adjust_managed_page_count(page, <span class="number">-1</span>);</span><br><span class="line">		vb-&gt;num_pfns += VIRTIO_BALLOON_PAGES_PER_PAGE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	num_allocated_pages = vb-&gt;num_pfns;</span><br><span class="line">	<span class="keyword">if</span> (vb-&gt;num_pfns != <span class="number">0</span>)</span><br><span class="line">		tell_host(vb, vb-&gt;inflate_vq);</span><br><span class="line">	mutex_unlock(&amp;vb-&gt;balloon_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> num_allocated_pages;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010923083/article/details/115873669">内核内存] 伙伴系统4—alloc_pages(内存块分配)_早起的虫儿有鹰吃的博客-CSDN博客</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">tell_host</span><span class="params">(<span class="keyword">struct</span> virtio_balloon *vb, <span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> <span class="title">sg</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> len;</span><br><span class="line">	sg_init_one(&amp;sg, vb-&gt;pfns, <span class="keyword">sizeof</span>(vb-&gt;pfns[<span class="number">0</span>]) * vb-&gt;num_pfns);</span><br><span class="line">	virtqueue_add_outbuf(vq, &amp;sg, <span class="number">1</span>, vb, GFP_KERNEL);</span><br><span class="line">	virtqueue_kick(vq);</span><br><span class="line">	wait_event(vb-&gt;acked, virtqueue_get_buf(vq, &amp;len));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">virtqueue_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *_vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vring_virtqueue</span> *<span class="title">vq</span> =</span> to_vvq(_vq);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(vq-&gt;broken))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (!vq-&gt;notify(_vq)) &#123;</span><br><span class="line">		vq-&gt;broken = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">vp_notify</span><span class="params">(<span class="keyword">struct</span> virtqueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* we write the queue&#x27;s selector into the notification register to</span></span><br><span class="line"><span class="comment">	 * signal the other end */</span></span><br><span class="line">    <span class="comment">// value, addr</span></span><br><span class="line">	iowrite16(vq-&gt;index, (<span class="type">void</span> __iomem *)vq-&gt;priv);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里wait_event是一个宏 传入的第二个参数会一直被调用然后sleep</p>
<p>相当于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for(;;)&#123;</span><br><span class="line">	if (virtqueue_get_buf(vq, &amp;len))</span><br><span class="line">		break;</span><br><span class="line">	schedule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h4><p>virtio:<a target="_blank" rel="noopener" href="https://blog.csdn.net/xidianjiapei001/article/details/89293914">IO虚拟化 - virtio介绍及代码分析【转】_xidianjiapei001的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/category/1939743.html">虚拟化 - 随笔分类 - Edver - 博客园 (cnblogs.com)</a></p>
<p>virtqueue初始化过程：</p>
<p>virtio_pci_legacy_probe 初始化回调函数</p>
<p><code>virtballoon_probe</code>-&gt;<code>init_vqs</code>-&gt;<code>virtio_find_vqs</code>-&gt;<code>find_vqs(vp_find_vqs)</code>-&gt;<code>vp_find_vqs_msix</code>-&gt;<code>vp_setup_vq(setup_vq)</code>-&gt;<code>vring_create_virtqueue</code></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/14684117.html">virtio简介（三） —— virtio-balloon qemu设备创建 - Edver - 博客园 (cnblogs.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_device_realize</span><span class="params">(DeviceState *dev, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIODevice *vdev = VIRTIO_DEVICE(dev);</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(dev);</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    virtio_init(vdev, VIRTIO_ID_BALLOON, virtio_balloon_config_size(s));</span><br><span class="line"></span><br><span class="line">    ret = qemu_add_balloon_handler(virtio_balloon_to_target,</span><br><span class="line">                                   virtio_balloon_stat, s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;Only one balloon device is supported&quot;</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (virtio_has_feature(s-&gt;host_features, VIRTIO_BALLOON_F_FREE_PAGE_HINT) &amp;&amp;</span><br><span class="line">        !s-&gt;iothread) &#123;</span><br><span class="line">        error_setg(errp, <span class="string">&quot;&#x27;free-page-hint&#x27; requires &#x27;iothread&#x27; to be set&quot;</span>);</span><br><span class="line">        virtio_cleanup(vdev);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s-&gt;ivq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_handle_output);</span><br><span class="line">    s-&gt;dvq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_handle_output);</span><br><span class="line">    s-&gt;svq = virtio_add_queue(vdev, <span class="number">128</span>, virtio_balloon_receive_stats);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_queue_notify_vq</span><span class="params">(VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (vq-&gt;vring.desc &amp;&amp; vq-&gt;handle_output) &#123;</span><br><span class="line">        VirtIODevice *vdev = vq-&gt;vdev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;broken)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        trace_virtio_queue_notify(vdev, vq - vdev-&gt;vq, vq);</span><br><span class="line">        vq-&gt;handle_output(vdev, vq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(vdev-&gt;start_on_kick)) &#123;</span><br><span class="line">            virtio_set_started(vdev, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_handle_output</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(vdev);</span><br><span class="line">    VirtQueueElement *elem;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        PartiallyBalloonedPage pbp = &#123;&#125;;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> pfn;</span><br><span class="line"></span><br><span class="line">        elem = virtqueue_pop(vq, <span class="keyword">sizeof</span>(VirtQueueElement));</span><br><span class="line">        <span class="keyword">if</span> (!elem) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iov_to_buf(elem-&gt;out_sg, elem-&gt;out_num, offset, &amp;pfn, <span class="number">4</span>) == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> p = virtio_ldl_p(vdev, &amp;pfn);</span><br><span class="line">            hwaddr pa;</span><br><span class="line"></span><br><span class="line">            pa = (hwaddr) p &lt;&lt; VIRTIO_BALLOON_PFN_SHIFT;</span><br><span class="line">            offset += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            section = memory_region_find(get_system_memory(), pa,</span><br><span class="line">                                         BALLOON_PAGE_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (!section.mr) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memory_region_is_ram(section.mr) ||</span><br><span class="line">                memory_region_is_rom(section.mr) ||</span><br><span class="line">                memory_region_is_romd(section.mr)) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                memory_region_unref(section.mr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            trace_virtio_balloon_handle_output(memory_region_name(section.mr),</span><br><span class="line">                                               pa);</span><br><span class="line">            <span class="keyword">if</span> (!virtio_balloon_inhibited()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vq == s-&gt;ivq) &#123;</span><br><span class="line">                    balloon_inflate_page(s, section.mr,</span><br><span class="line">                                         section.offset_within_region, &amp;pbp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vq == s-&gt;dvq) &#123;</span><br><span class="line">                    balloon_deflate_page(s, section.mr, section.offset_within_region);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    g_assert_not_reached();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            memory_region_unref(section.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtqueue_push(vq, elem, <span class="number">0</span>);</span><br><span class="line">        virtio_notify(vdev, vq);</span><br><span class="line">        g_free(elem);</span><br><span class="line">        virtio_balloon_pbp_free(&amp;pbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>inflate操作是guest会立即把内存还给host</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">balloon_inflate_page</span><span class="params">(VirtIOBalloon *balloon,</span></span><br><span class="line"><span class="params">                                 MemoryRegion *mr, hwaddr mr_offset,</span></span><br><span class="line"><span class="params">                                 PartiallyBalloonedPage *pbp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *addr = memory_region_get_ram_ptr(mr) + mr_offset;</span><br><span class="line">    <span class="type">ram_addr_t</span> rb_offset, rb_aligned_offset, base_gpa;</span><br><span class="line">    RAMBlock *rb;</span><br><span class="line">    <span class="type">size_t</span> rb_page_size;</span><br><span class="line">    <span class="type">int</span> subpages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX is there a better way to get to the RAMBlock than via a</span></span><br><span class="line"><span class="comment">     * host address? */</span></span><br><span class="line">    rb = qemu_ram_block_from_host(addr, <span class="literal">false</span>, &amp;rb_offset);</span><br><span class="line">    rb_page_size = qemu_ram_pagesize(rb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rb_page_size == BALLOON_PAGE_SIZE) &#123;</span><br><span class="line">        <span class="comment">/* Easy case */</span></span><br><span class="line"></span><br><span class="line">        ram_block_discard_range(rb, rb_offset, rb_page_size);</span><br><span class="line">        <span class="comment">/* We ignore errors from ram_block_discard_range(), because it</span></span><br><span class="line"><span class="comment">         * has already reported them, and failing to discard a balloon</span></span><br><span class="line"><span class="comment">         * page is not fatal */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	...<span class="comment">//经过测试 基本都是easy case</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ram_block_discard_range会调madvice</p>
<blockquote>
<p>MADV_WILLNEED<br>Expect access in the near future. (Hence, it might be a good idea to read some pages ahead.)</p>
<p>MADV_DONTNEED<br>Do not expect access in the near future. (For the time being, the application is finished with the given range, so the kernel can free resources associated with it.) Subsequent accesses of pages in this range will succeed, but will result either in reloading of the memory contents from the underlying mapped file (see mmap(2)) or zero-fill-on-demand pages for mappings without an underlying file.<br>MADV_REMOVE (Since Linux 2.6.16)<br>Free up a given range of pages and its associated backing store. Currently, only shmfs&#x2F;tmpfs supports this; other file systems return with the error ENOSYS.</p>
</blockquote>
<p>经过尝试后发现 <strong>通过mmap拿的内存 madvise <code>MADV_DONTNEED</code> 是会立即被回收的</strong></p>
<p>实际上这里一定需要unmap ept 否则需要相信guest kernel不会访问已经被释放的页 但是VMM不相信VM</p>
<p>这里没有手动unmap的原因是 madvise之后 内核如果真的free page 也需要修改自己的页表 并且调用mmu notify 最终通知kvm <code>kvm_mmu_notifier_invalidate_range_start</code>host上加输出可以看到</p>
<p>mm&#x2F;madvise.c </p>
<p><code>do_madvise</code>-&gt;<code>madvise_vma_behavior</code>-&gt;<code>madvise_dontneed_free</code>-&gt;<code>madvise_dontneed_single_vma</code>-&gt;<code>zap_page_range</code>-&gt;</p>
<p><code>mmu_notifier_invalidate_range_start</code> 解kvm ept</p>
<p><code>unmap_single_vma</code> 解kernel</p>
<p>这里只是unmap 但是并没有free掉相应的物理内存(修改page元数据 还给buddy system) 那不还是用不了？</p>
<blockquote>
<p>成功执行<strong>MADV_DONTNEED</strong>操作之后，访问指定区域的语义将发生变化：后续访问这些页面将会成功，但是会导致从底层映射文件中重新填充内容(用于共享文件映射、共享匿名映射及shmem等)或者导致私有映射的零填充按需页面。因此此操作是直接将page给回收了，从对私有映射的处理来看，与swap还是略微不同的。</p>
<p>需要注意的是，当应用于共享映射时，<strong>MADV_DONTNEED</strong> 可能不会立即释放范围内的页面。内核可以自由地选择合适的时机来释放页面。然而，调用进程的常驻集大小 (RSS) 将立即减少。</p>
<p>作者：蟹蟹宁<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/965b1ed71ae4">https://www.jianshu.com/p/965b1ed71ae4</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
<h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>用的是inflate存下来的page 一模一样的</p>
<p>其实deflate是无所谓的 根据现有的所有机制 VM想用就用就行了</p>
<p>qemu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">virtio_balloon_handle_output</span><span class="params">(VirtIODevice *vdev, VirtQueue *vq)</span></span><br><span class="line">&#123;</span><br><span class="line">    VirtIOBalloon *s = VIRTIO_BALLOON(vdev);</span><br><span class="line">    VirtQueueElement *elem;</span><br><span class="line">    MemoryRegionSection section;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        PartiallyBalloonedPage pbp = &#123;&#125;;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> pfn;</span><br><span class="line"></span><br><span class="line">        elem = virtqueue_pop(vq, <span class="keyword">sizeof</span>(VirtQueueElement));</span><br><span class="line">        <span class="keyword">if</span> (!elem) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iov_to_buf(elem-&gt;out_sg, elem-&gt;out_num, offset, &amp;pfn, <span class="number">4</span>) == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> p = virtio_ldl_p(vdev, &amp;pfn);</span><br><span class="line">            hwaddr pa;</span><br><span class="line"></span><br><span class="line">            pa = (hwaddr) p &lt;&lt; VIRTIO_BALLOON_PFN_SHIFT;</span><br><span class="line">            offset += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            section = memory_region_find(get_system_memory(), pa,</span><br><span class="line">                                         BALLOON_PAGE_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (!section.mr) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memory_region_is_ram(section.mr) ||</span><br><span class="line">                memory_region_is_rom(section.mr) ||</span><br><span class="line">                memory_region_is_romd(section.mr)) &#123;</span><br><span class="line">                trace_virtio_balloon_bad_addr(pa);</span><br><span class="line">                memory_region_unref(section.mr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            trace_virtio_balloon_handle_output(memory_region_name(section.mr),</span><br><span class="line">                                               pa);</span><br><span class="line">            <span class="keyword">if</span> (!virtio_balloon_inhibited()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vq == s-&gt;ivq) &#123;</span><br><span class="line">                    balloon_inflate_page(s, section.mr,</span><br><span class="line">                                         section.offset_within_region, &amp;pbp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vq == s-&gt;dvq) &#123;</span><br><span class="line">                    balloon_deflate_page(s, section.mr, section.offset_within_region);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    g_assert_not_reached();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            memory_region_unref(section.mr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtqueue_push(vq, elem, <span class="number">0</span>);</span><br><span class="line">        virtio_notify(vdev, vq);</span><br><span class="line">        g_free(elem);</span><br><span class="line">        virtio_balloon_pbp_free(&amp;pbp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">balloon_deflate_page</span><span class="params">(VirtIOBalloon *balloon,</span></span><br><span class="line"><span class="params">                                 MemoryRegion *mr, hwaddr mr_offset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *addr = memory_region_get_ram_ptr(mr) + mr_offset;</span><br><span class="line">    <span class="type">ram_addr_t</span> rb_offset;</span><br><span class="line">    RAMBlock *rb;</span><br><span class="line">    <span class="type">size_t</span> rb_page_size;</span><br><span class="line">    <span class="type">void</span> *host_addr;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX is there a better way to get to the RAMBlock than via a</span></span><br><span class="line"><span class="comment">     * host address? */</span></span><br><span class="line">    rb = qemu_ram_block_from_host(addr, <span class="literal">false</span>, &amp;rb_offset);</span><br><span class="line">    rb_page_size = qemu_ram_pagesize(rb);</span><br><span class="line"></span><br><span class="line">    host_addr = (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)addr &amp; ~(rb_page_size - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When a page is deflated, we hint the whole host page it lives</span></span><br><span class="line"><span class="comment">     * on, since we can&#x27;t do anything smaller */</span></span><br><span class="line">    ret = qemu_madvise(host_addr, rb_page_size, QEMU_MADV_WILLNEED);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        warn_report(<span class="string">&quot;Couldn&#x27;t MADV_WILLNEED on balloon deflate: %s&quot;</span>,</span><br><span class="line">                    strerror(errno));</span><br><span class="line">        <span class="comment">/* Otherwise ignore, failing to page hint shouldn&#x27;t be fatal */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wait_event在include&#x2F;linux&#x2F;wait.h</p>
<p>___wait_event</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/V-probe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/V-probe/" class="post-title-link" itemprop="url">V-probe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="V-probe"><a href="#V-probe" class="headerlink" title="V-probe"></a>V-probe</h1><p>ATC23</p>
<h2 id="问题与目标"><a href="#问题与目标" class="headerlink" title="问题与目标"></a>问题与目标</h2><p>IO直通的DMA操作与memory overcommitment产生冲突</p>
<p>因为DMA操作需要保证内存是固定不变的  overcommitment需要动态调整</p>
<p>现有方案：</p>
<ul>
<li>IOPF：DMA会产生pagefault，依赖memory reclaim ，swap慢 balloon通信慢 hyperupcall可能回收了DMA缓冲区导致失败</li>
<li>vIOMMU coIOMMU 让hypervisor 知道VM的DMA信息 兼容性差</li>
</ul>
<p>希望</p>
<ul>
<li>保证DMA不会失败</li>
<li>不需要特殊硬件</li>
<li>不需要修改guest内核</li>
<li>性能好</li>
</ul>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>类似hyperupcall 但是用编译好的二进制</p>
<p>guest启动后动态加载</p>
<p>限制只能用rdi rax 不允许访问内存 不允许大于64bytes  不能跳转</p>
<p>关于page：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhoutaopower/article/details/87090982">Linux 内存管理窥探（5）：page 数据结构_爱洋葱的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="http://linux.laoqinren.net/kernel/memory-page/">struct page结构体 - Notes about linux and my work (laoqinren.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/573338379">linux内核那些事之struct page - 知乎 (zhihu.com)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_MAPCOUNT_OPS(uname, lname)					\</span></span><br><span class="line"><span class="meta">static __always_inline int Page##uname(struct page *page)		\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	return atomic_read(&amp;page-&gt;_mapcount) ==				\</span></span><br><span class="line"><span class="meta">				PAGE_##lname##_MAPCOUNT_VALUE;		\</span></span><br><span class="line"><span class="meta">&#125;									\</span></span><br><span class="line"><span class="meta">static __always_inline void __SetPage##uname(struct page *page)		\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	VM_BUG_ON_PAGE(atomic_read(&amp;page-&gt;_mapcount) != -1, page);	\</span></span><br><span class="line"><span class="meta">	atomic_set(&amp;page-&gt;_mapcount, PAGE_##lname##_MAPCOUNT_VALUE);	\</span></span><br><span class="line"><span class="meta">&#125;									\</span></span><br><span class="line"><span class="meta">static __always_inline void __ClearPage##uname(struct page *page)	\</span></span><br><span class="line"><span class="meta">&#123;									\</span></span><br><span class="line"><span class="meta">	VM_BUG_ON_PAGE(!Page##uname(page), page);			\</span></span><br><span class="line"><span class="meta">	atomic_set(&amp;page-&gt;_mapcount, -1);				\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PageBuddy() indicate that the page is free and in the buddy system</span></span><br><span class="line"><span class="comment"> * (see mm/page_alloc.c).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_BUDDY_MAPCOUNT_VALUE		(-128)</span></span><br><span class="line">PAGE_MAPCOUNT_OPS(Buddy, BUDDY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> page_private(page)		((page)-&gt;private)</span></span><br></pre></td></tr></table></figure>

<p>一个用于拿是否free 一个用于拿order</p>
<p>这些函数的参数都是page结构体的GVA，所以注册函数的同时需要把guest内核page存放的GPA也一同放入</p>
<p>由于代码在host上执行，不需要GVA-&gt;GPA 所以这段代码不论是GPA-&gt;HVA还是如何翻译 总能在hypervisor上解决</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> procedure MEMORYRECLAMATION</span><br><span class="line"><span class="number">2</span>: <span class="keyword">for</span> each GFN in GUEST <span class="keyword">do</span></span><br><span class="line"><span class="number">3</span>: <span class="keyword">if</span> GFN is reclaimed then</span><br><span class="line"><span class="number">4</span>: <span class="keyword">continue</span></span><br><span class="line"><span class="number">5</span>: SP ← <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">of</span> <span class="title">GFN</span> <span class="title">in</span> <span class="title">GUEST</span></span></span><br><span class="line"><span class="class">6:</span> FREE ← GUEST.PAGE_FREE(SP)</span><br><span class="line"><span class="number">7</span>: ORD ← GUEST.PAGE_ORD(SP)</span><br><span class="line"><span class="number">8</span>: <span class="keyword">if</span> FREE and ORD ≥ MIN_ORD then</span><br><span class="line"><span class="number">9</span>: Lock MUTEX</span><br><span class="line"><span class="number">10</span>: Make the <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">GPA</span> <span class="title">range</span> <span class="title">read</span>-<span class="title">only</span></span></span><br><span class="line"><span class="class">11:</span> SP′ ← <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">of</span> <span class="title">GFN</span> <span class="title">in</span> <span class="title">GUEST</span></span></span><br><span class="line"><span class="class">12:</span> FREE′ ← GUEST.PAGE_FREE(SP′)</span><br><span class="line"><span class="number">13</span>: ORD′ ← GUEST.PAGE_ORD(SP′)</span><br><span class="line"><span class="number">14</span>: <span class="keyword">if</span> FREE′ and ORD′ ≥ MIN_ORD then</span><br><span class="line"><span class="number">15</span>: GFNst ← GFN</span><br><span class="line"><span class="number">16</span>: GFNen ← GFN + (<span class="number">1</span> &lt;&lt; ORD′)</span><br><span class="line"><span class="number">17</span>: RANGE ← [GFNst, GFNen)</span><br><span class="line"><span class="number">18</span>: Unmap EPT in RANGE</span><br><span class="line"><span class="number">19</span>: Unmap IOMMU in RANGE</span><br><span class="line"><span class="number">20</span>: Add RANGE to the reclaimed <span class="built_in">set</span></span><br><span class="line"><span class="number">21</span>: Release reclaimed pages to hypervisor</span><br><span class="line"><span class="number">22</span>: Unlock MUTEX</span><br><span class="line"><span class="number">23</span>: <span class="keyword">return</span> SUCCESS</span><br><span class="line"><span class="number">24</span>: Make the <span class="keyword">struct</span> page GPA range read-write</span><br><span class="line"><span class="number">25</span>: Unlock MUTEX</span><br><span class="line"><span class="number">26</span>: <span class="keyword">return</span> FAIL</span><br></pre></td></tr></table></figure>

<p>记录到reclaimed set中 并且解除映射</p>
<p>一旦解除映射 对应的物理内存就空出来了 满足overcommitment</p>
<p>回收代码定时触发或者事件触发</p>
<p>我认为第21行需要完成两件事</p>
<ul>
<li>这里光解除映射 实际上host还是不可用 需要用host kernel的对应函数和数据结构修改  但是已经运行在host上 并且知道guest的所有信息 并不难做到(类似qemu 可用madvise) 但是否有不一致问题？</li>
<li>修改guest struct page 标记不可用 否则guest当作free仍然分配并使用 可能导致触发大量page fault和VMexit</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> procedure PAGEFAULTHANDLER</span><br><span class="line"><span class="number">2</span>: Lock MUTEX</span><br><span class="line"><span class="number">3</span>: RANGE ← GetReclaimedRange(GUEST , GPA)</span><br><span class="line"><span class="number">4</span>: PAGES ← pages reallocated <span class="keyword">for</span> RANGE</span><br><span class="line"><span class="number">5</span>: Map RANGE to PAGES in EPT</span><br><span class="line"><span class="number">6</span>: Map RANGE to PAGES in IOMMU</span><br><span class="line"><span class="number">7</span>: Remove RANGE from the reclaimed <span class="built_in">set</span></span><br><span class="line"><span class="number">8</span>: Make the <span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">GPA</span> <span class="title">range</span> <span class="title">read</span>-<span class="title">write</span></span></span><br><span class="line"><span class="class">9:</span> Unlock MUTEX</span><br><span class="line"><span class="number">10</span>: <span class="keyword">return</span></span><br><span class="line">Input: GUEST , GPA</span><br><span class="line">Output: RANGE</span><br><span class="line"><span class="number">11</span>: procedure GETRECLAIMEDRANGE</span><br><span class="line"><span class="number">12</span>: <span class="keyword">for</span> each RANGE in the reclaimed <span class="built_in">set</span> of GUEST <span class="keyword">do</span></span><br><span class="line"><span class="number">13</span>: SPst ← the start <span class="keyword">struct</span> page GPA in RANGE</span><br><span class="line"><span class="number">14</span>: SPen ← the end <span class="keyword">struct</span> page GPA in RANGE</span><br><span class="line"><span class="number">15</span>: <span class="keyword">if</span> SPst ≤ GPA ≤ SPen then</span><br><span class="line"><span class="number">16</span>: <span class="keyword">return</span> RANGE</span><br></pre></td></tr></table></figure>

<p>DMA发生page fault 需要重新拿回对应的物理内存</p>
<p>这时候从reclaimed set中寻找原来的地址判断长度 然后重新映射 保证了DMA用的HPA虽然在动态变化但是仍可用 </p>
<p>这里的两个函数应该都是加到hypervisor代码中去的(修改host内核)</p>
<p>普通的page fault和DMA的page fault都使用这个函数</p>
<p>所以具体实现上仍然需要支持IOPF的硬件  实验中作者是自己修改硬件来支持的</p>
<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h2><h3 id="host与guest"><a href="#host与guest" class="headerlink" title="host与guest"></a>host与guest</h3><p>把host需要回收的page结构体都改为read only 随后再进行检查 这样做保证了满足要求的page都不会被guest修改</p>
<h3 id="reclaim与page-fault"><a href="#reclaim与page-fault" class="headerlink" title="reclaim与page fault"></a>reclaim与page fault</h3><p>用host自己的mutex lock</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>这篇文章相当于设备直通场景下的hypercall 因此测试除了常规回收内存之外 还增加了特定的IO测试</p>
<p>例如tcp udp和redis</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不管guest怎么操作自己的数据结构 入口一定是在host的</p>
<p>必须保证host拥有guest数据结构的地址和布局 并且提供给这段代码才可以</p>
<p>代码其实是修改了host自己的reclaim和page fault逻辑自己执行 不需要VM enter和exit</p>
<p>这种方式和balloon完全不同 不需要guest自己任何参与 对guest来说 仍然认为自己有着全部内存 不知道二级页表映射已经失效了</p>
<ul>
<li>balloon：guest判断free guest标记不可用 host unmap</li>
<li>v-probe：host判断free (host标记guest不可用) host unmap</li>
</ul>
<p>v-probe就算不顺带解决IOPF的问题 从性能上单独来说也是碾压balloon的，因为通过在host访问guest数据结构绕开了virtio这个大框架</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/forward/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/forward/" class="post-title-link" itemprop="url">Operation Forwarding</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Operation-Forwarding"><a href="#Operation-Forwarding" class="headerlink" title="Operation Forwarding"></a>Operation Forwarding</h1><p>usenix security23</p>
<p>虽然使用硬件虚拟化进行了隔离 但是microVM使用的组件还是会涉及到使用host的资源</p>
<p>策略1 container components</p>
<ul>
<li>kata container 用viriofs 提供rootfs 使得guest在这个文件夹的操作会转发到host</li>
<li>firecracker用runc jailer先在host上创建文件夹 然后复制文件 作为rootfs 使得host普通用户可以通过创建microVM利用containerd的漏洞做坏事</li>
</ul>
<blockquote>
<p>however, virtiofs is designed to offer local file system semantics and high performance. The file system performance downgrades without virtiofs in Kata Containers   </p>
</blockquote>
<p>用这个是为了性能</p>
<p>策略2 device emulator</p>
<p>策略3 host kernel module</p>
<h2 id="1-kata-container-virtiofs"><a href="#1-kata-container-virtiofs" class="headerlink" title="1 kata container virtiofs"></a>1 kata container virtiofs</h2><ol>
<li><p>container 在virtiofs的共享文件夹下创建SGIDbit的可执行文件  SGID可以临时获得程序所属组的权限</p>
</li>
<li><p>guest的virtiofs-driver会把open的system call forward给host的virtiofs daemon</p>
</li>
<li><p>通过host创建文件的权限检查 因为virfiofs daemon有root为 supplemental group</p>
<blockquote>
<p>Then it checks if the creation process has the same supplemental group as the directory owner. However, according to the virtiofs daemon’s document [31], virtiofs daemon must run as the root user and has the root group in its supplemental group  </p>
</blockquote>
</li>
<li><p>成功在host的某个目录下创建一个SGID的可执行文件</p>
</li>
</ol>
<p>vm内部和host是两个世界，所以这里无论怎么样vm还是无法利用这个可执行文件完成逃逸的。但是这个文件为host留了隐患，在host同一物理机器的任何普通用户都可以以root权限执行这个可执行文件。</p>
<blockquote>
<p>a regular user can get the host root group privileges when executing the file created by the malicious container.  </p>
</blockquote>
<p>cve的描述:</p>
<blockquote>
<p> This could allow a malicious unprivileged user inside the guest to gain access to resources accessible to the root group, potentially escalating their privileges within the guest. A malicious local user in the host might also leverage this unexpected executable file created by the guest to escalate their privileges on the host system.</p>
</blockquote>
<ol>
<li>guest内部的非root用户有root权限</li>
<li>host的非root用户有root权限</li>
</ol>
<p>报告给viriofs CVE 修复：取消掉viriofs 的root group</p>
<p><a target="_blank" rel="noopener" href="https://lists.nongnu.org/archive/html/qemu-devel/2022-01/msg05364.html">https://lists.nongnu.org/archive/html/qemu-devel/2022-01/msg05364.html</a></p>
<p>这个patch是qemu的virtiofsd  直接在启动的一开始把这个进程的所有supplemental group 都清空了 </p>
<p>一个用户可以属于多个组 但是登录的时候默认是primary group</p>
<p>其他组都是supplemental group</p>
<blockquote>
<p>If we have membership of “root” supplementary group</p>
</blockquote>
<p>root group是不是只是一个形象的表达？ 实际上只有adm sudo这种group</p>
<p>如果viriofs共享的文件夹是root 那么清空了virtiofsd的root supplemental group virtiofsd本身还怎么提供服务？最早为什么必须加？涉及到viriofs的设计 不深入研究</p>
<p><strong>利用open  策略1</strong></p>
<h2 id="2-kata-container-dirty-memory-attack"><a href="#2-kata-container-dirty-memory-attack" class="headerlink" title="2 kata container dirty memory attack"></a>2 kata container dirty memory attack</h2><ol>
<li>container中<code>dd if=/dev/zero of=/mnt/test bs=1M count=4096 oflag=direct  </code>持续生成 写文件</li>
<li>viriofs共享文件夹写write  VFS-&gt;viriofs driver-&gt;host viriofs daemon 触发host写 影响host dirty memory</li>
<li>linux kernel 维护一个值 当dirty memory超过阈值后(20%) 所有进程的写操作会从write-back变成write-through 性能下降</li>
<li>当多个container做这种操作 host的io性能可以下降90%</li>
</ol>
<p><strong>利用write 策略1</strong></p>
<blockquote>
<p>Besides, one can limit dirty memory usage of the virtiofs by adding the virtiofs daemon into cgroups.  </p>
</blockquote>
<p>virtiofs daemon就一个 给哪个vm的cgroup？</p>
<p>virtiofs团队正在努力让virtiofs daemon不需要以root运行 并且不影响用户使用</p>
<p><strong>经过测试 当某个文件被删除后 这个文件的buffer 即所有的dirty page也会马上被清空 不会再占用内存 所以仅仅靠一个container是无法达成攻击的 需要多个container一起 例如10container*4G&gt;192G(server)*20%&#x3D;38.4G</strong></p>
<p>多个container持续修改同一个文件即可 这样持续生成dirty memory</p>
<p>dirty memory在代码中的定义：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gmpy/p/12657801.html">Linux 脏数据回刷参数与调优 - 广漠飘羽 - 博客园 (cnblogs.com)</a></p>
<p>可回收内存(FILE_DIRTY) &gt; 可用内存(FREE+INACTIVE_FILE+ACTIVE_FILE) * ratio 发生回收 所以大量的匿名页是不记入的</p>
<h2 id="3-kata-container-nf-conntrack-table-attack"><a href="#3-kata-container-nf-conntrack-table-attack" class="headerlink" title="3 kata container nf_conntrack table attack"></a>3 kata container nf_conntrack table attack</h2><ol>
<li>container 疯狂connect 建立tcp连接</li>
<li>host的vhost-net kernel module调用tun_sendmsg-&gt;nf_conntrack_alloc</li>
<li>达到nf_conntrack_max 类似抽象资源攻击</li>
<li>造成随机丢包   ping 50%丢包 nginx不可用</li>
</ol>
<p>这里应该攻击的就是最终使用nf_conntrack table的网络使用者 也就是同样使用vhost-net的其他容器</p>
<p><strong>connect 策略3</strong></p>
<p>kata不修复 就给了减弱攻击的做法</p>
<p><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/43205/nf-conntrack-table-full-dropping-packet/43220#43220">https://security.stackexchange.com/questions/43205/nf-conntrack-table-full-dropping-packet/43220#43220</a></p>
<p>调一些参数 比如timeout max</p>
<p>可以限制速率</p>
<p><a target="_blank" rel="noopener" href="https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/">https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/</a></p>
<h2 id="4-attack-of-vhost-net-kernel-module"><a href="#4-attack-of-vhost-net-kernel-module" class="headerlink" title="4 attack of vhost-net kernel module"></a>4 attack of vhost-net kernel module</h2><ol>
<li>container 疯狂 sendmsg&#x2F;recvmsg</li>
<li>kernel 疯狂handle_rx&#x2F;tx</li>
<li>vhost kernel worker thread使用很多cpu资源 且不计入VM使用的资源</li>
</ol>
<p>并没有显示对其他container有影响</p>
<blockquote>
<p>Specifically, a worker thread called vhost-<owner-device-emulator-process-pid> is created for each virtual machine  </p>
</blockquote>
<p><strong>sendmsg&#x2F;recvmsg 策略3</strong></p>
<p>每个VM一个 所以解决方案是把这些thread加入container的cgroup</p>
<p>实际上对于kata container 有一个sandbox_cgroup_only&#x3D;true的选项可以让vhost thread放入cgroup 但是默认是false</p>
<p>为什么这个可以让container的用户自己配置？ 那都是false不是不需要消耗资源付更多钱吗</p>
<p>可以用SRIOV</p>
<h2 id="5-firecracker-containerd-escalation"><a href="#5-firecracker-containerd-escalation" class="headerlink" title="5  firecracker-containerd escalation"></a>5  firecracker-containerd escalation</h2><p><a target="_blank" rel="noopener" href="https://github.com/firecracker-microvm/firecracker-containerd/commit/95c43cdec1b5dc92a16a732b56f482218c2b5fed">https://github.com/firecracker-microvm/firecracker-containerd/commit/95c43cdec1b5dc92a16a732b56f482218c2b5fed</a></p>
<ol>
<li><p>host 普通用户构造一个路径 申请创建microVM</p>
</li>
<li><p>firecracker-containerd是root权限运行 而代码中并没有检查参数所以涉及到的chown和create可以操作任何文件</p>
<p>并且代码使用的filepath.join会导致组合的路径逃出jail</p>
</li>
<li><p>chown可以任意修改文件权限</p>
<p>create可以任意清空文件，例如清空host的.so 让host crash</p>
</li>
</ol>
<p><strong>CreateVM 策略1</strong></p>
<p>“path&#x2F;filepath”  filepath.join 在某一个路径存在<code>/../../../</code>的情况下 最后组合的路径会把另一个前面的吃掉</p>
<p>换成”github.com&#x2F;containerd&#x2F;continuity&#x2F;fs” fs.RootPath</p>
<p>用户控制一个 可以逃出runc指定的jail路径</p>
<p><strong>CreateVM 策略1</strong></p>
<h2 id="6-firecracker-based-container-dirty-memory-attack"><a href="#6-firecracker-based-container-dirty-memory-attack" class="headerlink" title="6 firecracker-based container dirty memory attack"></a>6 firecracker-based container dirty memory attack</h2><p>类似kata container</p>
<p>但是firecracker使用的是virio-blk</p>
<p><strong>write 策略2</strong></p>
<h2 id="7-Firecracker-based-Container-Nf-conntrack-TableAttack"><a href="#7-Firecracker-based-Container-Nf-conntrack-TableAttack" class="headerlink" title="7 Firecracker-based Container Nf_conntrack TableAttack"></a>7 Firecracker-based Container Nf_conntrack TableAttack</h2><p>用virtio-net device 而不是kernel module</p>
<p>但是效果一样</p>
<p><strong>connect 策略2</strong></p>
<p>被AWS修复了  没找到怎么修复</p>
<h2 id="8-KVM-PIT-Timer-Attack"><a href="#8-KVM-PIT-Timer-Attack" class="headerlink" title="8 KVM PIT Timer Attack"></a>8 KVM PIT Timer Attack</h2><ol>
<li>guest疯狂写某写io port 触发PIT timer 且period很短</li>
<li>host调度kvm-pit线程 pit_do_work往guest插入中断</li>
<li>内核线程属于root cgroup 消耗资源不算在user space</li>
<li>cpu memory io的benchmark性能都下降</li>
</ol>
<p>个人认为这里是server的资源并不多 并且开的container太多 导致消耗大量资源的PIT thread在整体可用资源的占比变高</p>
<p><strong>outb 策略3</strong></p>
<p>qemu用HPET代替了PIT 具体实现不深入研究</p>
<p>也是一个VM一个 所以也可以放到cgroup中</p>
<p>或者直接禁用</p>
<h2 id="traditional-VM"><a href="#traditional-VM" class="headerlink" title="traditional VM"></a>traditional VM</h2><ul>
<li>dirty memory dos有效</li>
<li>nf_conntrack dos有效</li>
<li>vhost-net 有效</li>
<li>viriofs提权 有效 9pfs也有效</li>
<li>PIT 不用了 所以无效</li>
</ul>
<p>这些漏洞存在 但是普通VM不一定用 microVM定死了组件 所以一定用</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/ELISA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/ELISA/" class="post-title-link" itemprop="url">ELISA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ELISA"><a href="#ELISA" class="headerlink" title="ELISA"></a>ELISA</h1><p><a target="_blank" rel="noopener" href="https://github.com/yasukata/ELISA?tab=readme-ov-file#section-41--anywhere-page-table-apt">yasukata&#x2F;ELISA: ELISA: Exit-Less, Isolated, and Shared Access for Virtual Machines (github.com)</a></p>
<p>主要是elisa的设计实现了带隔离的共享内存 network的use case可以做到比vhost-net更好</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>虚拟机间需要共享数据</p>
<ul>
<li>共享内存 效率高 隔离性低 guest代码不可信</li>
<li>host介入 例如hypercall 隔离性好 效率低</li>
</ul>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135854799.png" alt="image-20240221135854799" style="zoom:50%;" />

<ul>
<li>share一块设备的DMA区域</li>
<li>trafficDB</li>
</ul>
<p>ELISA通过vmfunc切换EPT页表实现安全高效的资源共享</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221140438142.png" alt="image-20240221140438142" style="zoom:50%;" />

<h2 id="EPTP"><a href="#EPTP" class="headerlink" title="EPTP"></a>EPTP</h2><img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221151320704.png" alt="image-20240221151320704" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Rev-omi/p/14063037.html">第10章：VT 技术（简单了解+EPT 机制） - Rev_omi - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/sites/default/files/conference/protected-files/atc18_slides_hua.pdf">atc18_slides_hua.pdf (usenix.org)</a></p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135313661.png" alt="image-20240221135313661" style="zoom:50%;" />

<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135431450.png" alt="image-20240221135431450" style="zoom:50%;" />

<p>EPTP: EPT四级页表的root</p>
<p>传统hypervisor只需要为每个guest配置一套EPT就可以 intel允许配置512个</p>
<p>改完EPT以后 GPA-&gt;HPA映射改变 所有数据都变了 包括代码和页表</p>
<p>所以大部分都是不改的 只改需要改的部分 例如代码</p>
<ul>
<li>原本不能访问的 现在可以访问</li>
<li>代码段4k页结束以后 变到了新的代码段上了</li>
</ul>
<h2 id="challange"><a href="#challange" class="headerlink" title="challange"></a>challange</h2><p>EPT context 指每个EPTP对应的四级页表</p>
<p>需要保证guest 页表数据不变(否则会crash) 所以guest 页表GPA-&gt;HPA不能变</p>
<p> 所以guest改cr3必须下陷同步修改EPT？</p>
<p>修改EPT以后代码在哪？  理论：通过固定GVA去call vmfunc 实际：恶意guest可以控制页表和cr3 导致可以任意GVAcall 绕过判断</p>
<h2 id="design"><a href="#design" class="headerlink" title="design"></a>design</h2><p>三种EPT context</p>
<ul>
<li>default 不可信</li>
<li>gate 可信</li>
<li>sub 可信</li>
</ul>
<p>Manager VM：可信部分 方便用user-space的tool 代替了kernel的hypervisor 去配置EPT</p>
<h3 id="APT"><a href="#APT" class="headerlink" title="APT"></a>APT</h3><p>APT是为了消除CR3的trap和update开销</p>
<p>vmfunc之后 GPA-&gt;HPA映射改变 还是在guest内 因此想要执行目标代码 绕不开地址翻译</p>
<p>让所有的GPA都指向提前配置好的guest页表基地址 这样不论cr3的值是什么 都可以正确翻译</p>
<p>因此其他用到的内存 例如栈 共享变量 代码都必须在guest合法GPA之外 例如256G</p>
<h3 id="gate"><a href="#gate" class="headerlink" title="gate"></a>gate</h3><img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221135535967.png" alt="image-20240221135535967" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity20/presentation/mi">(Mostly) Exitless VM Protection from Untrusted Hypervisor through Disaggregated Nested Virtualization | USENIX</a></p>
<p>防止VM 随意切换EPTP bypass掉可信部分 用动态修改EPTP list的技术 </p>
<p>初始化情况下 EPTP list 只有default 和gate 两个entry</p>
<p>切换到gate的时候动态加入sub到EPTP list</p>
<p>sub回到default之前再把sub从EPTP list里面删了</p>
<p>dlopen加载可信代码 映射到sub EPT</p>
<p>gate隔离开def和sub 加简单的check就可以</p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>VM-&gt;虚拟网卡-&gt;qemu&#x2F;kvm-&gt;内核网桥-&gt;物理网卡</p>
<p>[KVM 介绍（4）：I&#x2F;O 设备直接分配和 SR-IOV <a target="_blank" rel="noopener" href="https://www.cnblogs.com/sammyliu/p/4548194.html">KVM PCI&#x2F;PCIe Pass-Through SR-IOV] - SammyLiu - 博客园 (cnblogs.com)</a></p>
<p>PCI passthrough 设备直通 一个网卡给一个虚拟机用</p>
<p>SRIOV也是设备直通 但是有一个网卡给多个虚拟机用的能力</p>
<p>virtual switch是sub context共享的 物理NIC的IO buffer和DMA是sub context共享的</p>
<p>vNIC的io buffer是def和sub共享的</p>
<p>virtual switch用了VALE&#x2F;mswitch netmap</p>
<p>VNIC driver是DPDK写的  user application也要用DPDK去通信</p>
<p>发包</p>
<ol>
<li>vNIC把数据放到IObuffer def和sub shared</li>
<li>vmfunc</li>
<li>virtual switch拷贝到目标NIC</li>
<li>virtual switch trigger sub中的physical NIC driver</li>
</ol>
<p>收包</p>
<ol>
<li>vNIC</li>
<li>vmfunc 进入sub</li>
<li>virtual switch拷贝到vNIC</li>
</ol>
<p>PCI passthrough不能被多个VM共用</p>
<p>转发逻辑完全可编程 和SRIOV不同 后者是硬件代码</p>
<p>测试用的benchmark都需要基于DPDK的用户进程</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fengfengdiandia/article/details/52869290">netmap 介绍-CSDN博客</a></p>
<p>网络包首发框架 映射网卡packet buffer到用户态</p>
<p><a target="_blank" rel="noopener" href="https://conferences.sigcomm.org/sigcomm/2017/files/tutorial-netmap/03-vale.pdf">03-vale.pdf (sigcomm.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://manpages.org/vale/4">man vale (4): a very fast Virtual Local Ethernet using the netmap API (manpages.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/ELISA?tab=readme-ov-file#section-71--vm-networking-system">yasukata&#x2F;ELISA: ELISA: Exit-Less, Isolated, and Shared Access for Virtual Machines (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/master/client/main.c">elisa-app-vmnet&#x2F;client&#x2F;main.c at master · yasukata&#x2F;elisa-app-vmnet (github.com)</a></p>
<ol>
<li><p>guestVM网络请求 被DPDK driver处理<a target="_blank" rel="noopener" href="https://github.com/yasukata/librte_pmd_rvif/blob/9fbd375484cef415ea61bb6b436d509dca707c87/main.c#L276-L278">librte_pmd_rvif&#x2F;main.c at 9fbd375484cef415ea61bb6b436d509dca707c87 · yasukata&#x2F;librte_pmd_rvif (github.com)</a></p>
</li>
<li><p>先拷贝数据到vNIC iobuf上 这个是def sub共享的</p>
</li>
<li><p>然后调用dpdk_rvif_io_hook<a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/4a9800ea488aa4ac9b057c3d98f04da35faefab1/client/main.c">elisa-app-vmnet&#x2F;client&#x2F;main.c at 4a9800ea488aa4ac9b057c3d98f04da35faefab1 · yasukata&#x2F;elisa-app-vmnet (github.com)</a> 其中do_io会调用elisa_gate_entry</p>
</li>
<li><p>触发vmfunc</p>
</li>
<li><p>进入sub的entry point 这里entry_function是rvs_fwd</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-vmnet/blob/4a9800ea488aa4ac9b057c3d98f04da35faefab1/server/lib/libelisa-applib-vmnet/main.c#L68">elisa-app-vmnet&#x2F;server&#x2F;lib&#x2F;libelisa-applib-vmnet&#x2F;main.c at 4a9800ea488aa4ac9b057c3d98f04da35faefab1 · yasukata&#x2F;elisa-app-vmnet (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/rvs/blob/master/rvs.c">rvs&#x2F;rvs.c at master · yasukata&#x2F;rvs (github.com)</a></p>
<p>rvs是单独实现的一个virtual switch</p>
</li>
<li><p>virtual switch主要做两件事</p>
<ul>
<li>找destination</li>
<li>拷贝数据到destination NIC的IO buffer</li>
</ul>
<p>这部分参考VALE&#x2F;mswitch实现</p>
</li>
</ol>
<h3 id="VALE"><a href="#VALE" class="headerlink" title="VALE"></a>VALE</h3><p>就是一个高性能的virtual switch</p>
<h3 id="hyperNF"><a href="#hyperNF" class="headerlink" title="hyperNF"></a>hyperNF</h3><ul>
<li>为了不增加hypervisor的TCB 把基于VALE的vswitch放在一个privilege VM中 实现转发逻辑</li>
<li>数据和代码export到hypervisor中</li>
<li>map一些数据结构给VM</li>
<li>NIC直接连接switch</li>
</ul>
<p>transmit</p>
<ol>
<li>VM 放数据到packet buffer</li>
<li>hypercall</li>
<li>VALE转发逻辑（查询dest地址 拷贝数据）</li>
<li>hypercall return</li>
</ol>
<ul>
<li>virtio&#x2F;vhost-net是通过hypervisor处理 物理NIC连的是hypervisor上的tap设备</li>
<li>elisa通过hyperNF的架构 多个VM共享物理NIC的DMA区域 例如加锁使用</li>
</ul>
<p>VALE本身就比tap快10-20倍 12年</p>
<p>hyperNF用了VALE 15年</p>
<p>发网络包的过程</p>
<ol>
<li>guest host通信</li>
<li>switch转发</li>
</ol>
<p>elisa做到的是把通信部分从vm exit变为开销更小的vmfunc 并且用自己实现的高效转发逻辑用sub EPT保护起来 同时实现了隔离性</p>
<p>baseline：</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221141207415.png" alt="image-20240221141207415" style="zoom:50%;" />



<p>elisa</p>
<img src="C:\Users\Shen\AppData\Roaming\Typora\typora-user-images\image-20240221141230092.png" alt="image-20240221141230092" style="zoom:50%;" />



<h2 id="libelisa"><a href="#libelisa" class="headerlink" title="libelisa"></a>libelisa</h2><p>最终执行流也是通过EPT映射决定的 所以如何构造EPT很关键</p>
<p>managerVM配置好EPT以后写到eptp_list 通过hypercall告诉kvm  kvm通过写vmcs配置eptp_list 然后vmfunc就可以直接用</p>
<p>elisa-util-exec会直接执行elisa__exec_init managerVM和guestVM都需要执行elisa-util-exec 这样都执行了shared的mmap</p>
<p>每个需要共享内存的guest VM作为elisa_client</p>
<ul>
<li><h4 id="elisa-server-运行在managerVM-死循环"><a href="#elisa-server-运行在managerVM-死循环" class="headerlink" title="elisa_server  运行在managerVM 死循环"></a><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/eb8a14a132fe7f9b0e7980c7a4ab3a30ef8a465f/main.c#L67"><code>elisa_server</code></a>  运行在managerVM 死循环</h4><p>由elisa-util-exec调用到elisa_server 传入elisa__server_cb  elisa__server_exit_cb</p>
<p>fork后执行server_work</p>
<p>ELISA_APPLIB_FILE&#x3D;.&#x2F;lib&#x2F;libelisa-applib-nop&#x2F;lib.so 这个文件里面只有一个entry_function</p>
<p>server_cb(elisa__server_cb)调用elisa_create_program_map_req 解析ELF把entry_function的代码段都放到base_gpa后的一页一页</p>
<p>shared_memory的指针会被放到代码段页之后的一页</p>
<p>BASE_GPA是1&lt;&lt;37 即128G</p>
<p>正常来说8G内存范围就是0-8G 超了访问硬件就会报错<br>但是对于虚拟化 有GPA-&gt;HPA翻译 超出的部分也可以被映射到合法的HPA<br>default EPT不映射超出的部分 non-default EPT映射超出的GPA到HPA</p>
<p>src_gxa表示可能是gva也可能是gpa 实际上都是gva</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(*map_req)[*map_req_cnt].dst_gpa = <span class="number">0x1000</span> * *map_req_cnt + base_gpa;</span><br><span class="line">(*map_req)[*map_req_cnt].dst_gva = (phdr.p_vaddr &amp; (~((<span class="number">1UL</span> &lt;&lt; <span class="number">12</span>) - <span class="number">1</span>))) + <span class="number">0x1000</span> * j;</span><br><span class="line">(*map_req)[*map_req_cnt].src_gxa = (phdr.p_vaddr &amp; (~((<span class="number">1UL</span> &lt;&lt; <span class="number">12</span>) - <span class="number">1</span>))) + <span class="number">0x1000</span> * j;</span><br></pre></td></tr></table></figure>

<p>server libelisa这边的BASE_GPA是256G</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__map_req[i].dst_gva = requested_gva + 0x1000 * i;</span><br><span class="line">__map_req[i].dst_gpa = BASE_GPA + 0x1000 * i;</span><br></pre></td></tr></table></figure>

<p><code>embed_addr_to_code((void *)((uintptr_t) __RUNTIME_VALUE_2 + 2), entry_function);</code></p>
<p>把entry_function的地址写到sub_context的code中</p>
<p>setup_vcpu_ept_ctx</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assert(!gva2hpa(req[i].src_gxa, &amp;hpa));</span><br><span class="line">pt_map(&amp;ctx-&gt;pt, req[i].dst_gva, req[i].dst_gpa, req[i].pt_flags, req[i].level);</span><br><span class="line">pt_map(&amp;ctx-&gt;ept, req[i].dst_gpa, hpa, req[i].ept_flags, req[i].level);</span><br></pre></td></tr></table></figure>

<p>原先src_gva-&gt;hpa 是src_gva是已经存在的一块内存区域</p>
<p>之后dst_gva-&gt;dst_gpa-&gt;hpa 即用新的guest page table和ept 可以用dst_gva访问到这块数据</p>
<p>pt_map补全页表 建立映射 pgtbl-&gt;cnt表示四级页表中所有页表的个数 pg[0]表示root页表</p>
<p>把pt页表的映射再加到EPT中</p>
<p>只是配好了一个pt和一个ept 包括gate sub用到的代码和stack</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>((<span class="type">void</span> *) ctx-&gt;apt_mem, (<span class="type">void</span> *) ctx-&gt;pt.pg[<span class="number">0</span>].va, <span class="number">0x1000</span>);</span><br><span class="line">assert(!gva2hpa((<span class="type">uint64_t</span>) ctx-&gt;apt_mem, &amp;hpa));</span><br><span class="line">pt_map(&amp;ctx-&gt;ept, ((<span class="type">uint64_t</span>) <span class="number">-1</span>) &amp; EPT_ADDR_MASK, hpa, EPT_R | EPT_W | <span class="comment">/*EPT_X | EPT_U |*/</span> EPT_MT, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<p>ept把0xfffffffff映射到apt_mem的hpa 这样ept四级页表都会有最后一项</p>
<p>ae是所有页表的最后一个位置</p>
<p>遍历ept 把512项的每一项都指向ae 即下一级页表的最后一个位置 这样最终会指向apt_mem的hpa 如果已经有指向了 则递归把下一级的指向apt_mem</p>
<p>改变整个地址空间的映射 不是遍历整个地址空间为每个va创建映射 而是直接修改page table entry即可</p>
<p>最终配置完的EPT guest自己所有的GPA都会被映射到apt_mem的HPA  存储的数据是guest page table的root page table</p>
<p>超出范围的GPA被映射到指定的位置  </p>
<p>gate EPT会被放到eptp_list的最后一个位置</p>
<p>set_rendezvous_point_eptp_list_hpa 把eptp_list记录到host</p>
<p>read等待client结束</p>
<p>配置完成后 多了两个ept  并且ept的合法GPA范围都指向了一起配置好的pt</p>
</li>
<li><h4 id="elisa-client-运行在guestVM中-配置完gate-sub-EPT-之后退出"><a href="#elisa-client-运行在guestVM中-配置完gate-sub-EPT-之后退出" class="headerlink" title="elisa_client 运行在guestVM中 配置完gate&#x2F;sub EPT 之后退出"></a><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/eb8a14a132fe7f9b0e7980c7a4ab3a30ef8a465f/main.c#L72"><code>elisa_client</code></a> 运行在guestVM中 配置完gate&#x2F;sub EPT 之后退出</h4><p> 由elisa-util-exec调用到elisa_client 传入client_cb </p>
<p>拿到vcpuid</p>
<p>client_cb 啥也不干</p>
<p><code>request_gva = (uint64_t) gate_entry_page + 0x1000;</code></p>
<p>elisa_guest_activate 写入eptp_list</p>
<p>elisa__client_work 禁止中断 elisa_gate_entry</p>
<p>____asm_impl_client 定义了elisa_gate_entry  执行vmfunc(511) 切换到gate ept</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.src_gxa = (<span class="type">uint64_t</span>) gate_ctx_page,</span><br><span class="line">.dst_gva = requested_gva + <span class="number">0x1000</span> * <span class="number">0</span>,</span><br><span class="line">.dst_gpa = BASE_GPA + <span class="number">0x1000</span> * <span class="number">0</span>,</span><br></pre></td></tr></table></figure>

<p>此使pc正好指向下一个page 这个page通过之前配置好的pt和ept 会被映射到gate_ctx_page</p>
<p>立即切换之后 并不会马上用到stack 因此可以先写一些不需要stack的汇编 然后配置rsp到事先用mmap准备好的栈位置</p>
<p>gate执行完(code page上半部分) vmfunc 切换视角 继续执行的是sub page的下半部分 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;.globl __RUNTIME_VALUE_2 \n\t&quot;</span><br><span class="line">&quot;__RUNTIME_VALUE_2: \n\t&quot;</span><br><span class="line">&quot;movabs $0x123456789abcdef0, %rax \n\t&quot; // 0x123456789abcdef0 (pointer to entry point function) is replaced at initialization</span><br><span class="line">&quot;call *%rax \n\t&quot;</span><br><span class="line">&quot;movq %rax, %rbx \n\t&quot; // save return value on rbx</span><br></pre></td></tr></table></figure>

<p>entry_function中的gva是事先准备好映射的 在shared memory例子中 shm_memory_ptr的gva和src_gva相同 gva不变 通过修改映射访问到host物理内存上的事先用mmap shared准备好的共享内存</p>
<p>entry_function的映射在<a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa-extra/blob/master/include/libelisa_extra/map.h">libelisa-extra&#x2F;include&#x2F;libelisa_extra&#x2F;map.h at master · yasukata&#x2F;libelisa-extra (github.com)</a>中建立 与shared_memory相同 src_gva&#x3D;dst_gva 不变 dst_gpa一个个往后放</p>
</li>
</ul>
<p>def和sub共享 修改def EPT？ 在启动的时候先让manager VM和guest VM通过qemu提供的共享内存</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/stray2b/article/details/128896078">qemu-kvm Hypervisor：ivshmem-CSDN博客</a></p>
<p>managerVM可以知道共享内存的地址  然后建立和guest sub的共享 达到guest def&lt;&#x3D;&gt;manager def&lt;&#x3D;&gt;guest sub共享的效果</p>
<p>gate_entry_page有三个连续的page</p>
<p>gate_ctx_page和sub_ctx_page共4个连续的page</p>
<p>这些page代码通过VM kernel加载以后 放到host真实的物理内存中</p>
<p>随后通过修改EPT 改变了guest眼中的内存布局(例如物理内存中gate_ctx_page-&gt;eptp_list-&gt;sub_ctx_pape但是GPA视角gate_ctx_page-&gt;eptp_list-&gt;stack)</p>
<p>guest vm 用户态代码<a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-app-nop/blob/master/main.c">elisa-app-nop&#x2F;main.c at master · yasukata&#x2F;elisa-app-nop (github.com)</a> 其中elisa__client_work调用elisa_gate_entry</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/elisa-util-exec/blob/master/main.c">elisa-util-exec&#x2F;main.c at master · yasukata&#x2F;elisa-util-exec (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa/blob/master/client.c">libelisa&#x2F;client.c at master · yasukata&#x2F;libelisa (github.com)</a> ____asm_impl_client 定义了elisa_gate_entry 用到vmfunc 执行这行以后去哪了？</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yasukata/libelisa/blob/master/server.c#L43">libelisa&#x2F;server.c at master · yasukata&#x2F;libelisa (github.com)</a>对应了论文中gate entry的header</p>
<p>vmfunc理论上是某个page的最后一个指令 因此non-default EPT不会再映射开始的vmfunc这个page</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/cipherH/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/cipherH/" class="post-title-link" itemprop="url">CipherH</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CipherH"><a href="#CipherH" class="headerlink" title="CipherH"></a>CipherH</h1><p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/tree/master">Sen-Deng&#x2F;CipherH at master (github.com)</a></p>
<blockquote>
<p>Recent works have illustrated the feasibility of launching ciphertext side-channel attacks against cryptographic libraries using the aforementioned threat model [33]. However, they primarily target manually identified program vulnerabilities. This work presents CIPHERH, a thorough and fully automated framework for identifying such vulnerabilities in production cryptographic libraries.  </p>
</blockquote>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p><strong>CIPHERLEAKS: Breaking Constant-time Cryptography on AMD SEV via the Ciphertext Side Channel</strong></p>
<p><strong>A Systematic Look at Ciphertext Side Channels</strong></p>
<p>VMSA page 物理地址不变  XEX</p>
<ol>
<li>建立寄存器密文&lt;-&gt;明文的映射 ：控制OVMF 的一个PEIM  触发NAE VC handler 同时观察rax明文和密文   需要可读</li>
<li>得到需要攻击的代码页地址：清空所有page 的P bit  NPF的errorcode会知道是否是代码页 再根据寄存器是否变化判断是否是目标代码页</li>
<li>以Open SSL rsa为例，bn_get_bits5的NPF可以正好从rax读到key的5bit 循环可以得到整个key</li>
</ol>
<p>缓解：</p>
<ol>
<li>减少会触发NAE导致建立映射的函数 但是治标不治本</li>
<li>函数返回值rax高位加随机数</li>
<li>用栈传递返回值或者其他寄存器</li>
<li>函数不在一个新的page开始</li>
</ol>
<p>光防VMSA没用 任意memory都可以观察</p>
<p>constant time swap可以防一些microarchitecture的side channel攻击 但是防不了比较密文</p>
<p>例如nginx  先发http请求 触发 然后清空Pbit触发NPF  然后用single-step技术</p>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>硬件防开销大</p>
<p>cipherH 软件框架 为了让加密库开发者写完代码以后自己检查一遍</p>
<blockquote>
<p>As will be introduced in §5, CIPHERH explores a hybrid approach by using dynamic taint analysis (which is scalable and rapid) to collect functions tainted on an execution trace. Then, it performs static symbolic execution toward each tainted function, covering paths that are not on the dynamic trace.  </p>
</blockquote>
<p><strong>设计并不是很难 主要用了两个工具  2.3k代码</strong></p>
<p>key是taint 访问的过程中 不可以有一块内存可以推断key是否变化 因为都是bit操作 或者n-bit操作 减少了熵</p>
<ul>
<li>DFSan  llvm</li>
<li>angr SSP’16 二进制文件反编译  得到更多的寄存器访存信息  <a target="_blank" rel="noopener" href="https://trevorsaudi.com/posts/symbolic_execution_angr_part1/">Symbolic Execution with Angr - part 1 · Trevor Saudi</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/ase18/ase18-paper_springer.pdf">ase18-paper_springer.pdf (usenix.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/DataFlowSanitizer.html">DataFlowSanitizer — Clang 19.0.0git documentation (llvm.org)</a></p>
<p>编译优化等级开相同  根据函数名可以方便找到对应关系</p>
<p>但还是有些信息不匹配的  所以第二阶段用保守方法处理</p>
<h3 id="taint-analysis"><a href="#taint-analysis" class="headerlink" title="taint analysis"></a>taint analysis</h3><p>DFSan需要用他的API加到代码里 然后编译</p>
<p>追踪数学运算、逻辑、内存访问 包括implicit</p>
<p>手动识别secret并调API  hook每个函数调用 内存访问</p>
<p>实际上secret就是RSA的一个私钥  传入最外层的函数之后 之后全可以通过自动分析得到 并不需要对算法库有修改</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/src/apps/wolfssl_case_study/test.c">CipherH&#x2F;src&#x2F;apps&#x2F;wolfssl_case_study&#x2F;test.c at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>这个阶段输出一系列函数   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get_digit_count:3</span><br><span class="line">mp_rand:65</span><br><span class="line">fp_invmod:1</span><br><span class="line">fp_div_2:1</span><br><span class="line">fp_exptmod:1</span><br><span class="line">_fp_exptmod_ct:33</span><br><span class="line">fp_montgomery_reduce:33</span><br><span class="line">wc_RsaUnPad_ex:67</span><br><span class="line">RsaUnPad:67</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/evaluation_result/wolfssl_rsa_o0/tainted_func.txt">CipherH&#x2F;evaluation_result&#x2F;wolfssl_rsa_o0&#x2F;tainted_func.txt at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>猜测最后的结果记录了函数名和对应的taint位置 包括6个参数寄存器、返回值、从内存加载</p>
<ol>
<li>任何输入 都是taint的</li>
<li>返回值是taint</li>
<li>从memory load了taint data</li>
</ol>
<p>对密码学算法库来说不需要构造很多覆盖面广的input  很多input其实涉及到的逻辑都一样</p>
<p>不过其实筛掉大部分的function  然后留下function name和taint symbol name就可以了</p>
<h3 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h3><p>符号执行阶段 从第一阶段拿到足够的信息以后 可以对每个function单独进行符号执行 if生成约束  然后根据taint信息生成一个表达式 求解</p>
<p>因为这边不加混淆 所以代码应该比较容易被逆向 比如$0x10(rsp) 就可以认为是同一个指针</p>
<p>syntactical equivalence   和angr现有的一样 保证效率</p>
<h4 id="intra"><a href="#intra" class="headerlink" title="intra"></a>intra</h4><p>遇到if 加约束</p>
<p>遇到call 直接用symbol  根据taint analysis的结果可以知道这里的symbol用普通的s还是taint的k</p>
<p>M 中的元组a,v 表示symbol v写到地址a</p>
<p>W中的元组a,v,i表示指令i把数据v写到地址a</p>
<ol>
<li>检查v是否包含key</li>
<li>是否存在a1&#x3D;a 且v1也包含key</li>
<li>放入Eq4看看是否可满足 (带上之前if导致的一系列条件)</li>
<li>SMT solver返回是否可满足 并给出例子 留给user后续手动分析</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/src/run.py">CipherH&#x2F;src&#x2F;run.py at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>hook了每次内存读写的操作  回调的时候有当前所有的状态 包括这句内存读写操作的AST</p>
<p>AST中包括symbol的表达式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">initial_state.inspect.b(<span class="string">&#x27;instruction&#x27;</span>, action=track_instr)</span><br><span class="line">initial_state.inspect.b(<span class="string">&#x27;mem_write&#x27;</span>, when=angr.BP_BEFORE,action=track_write_mem_before)</span><br><span class="line">initial_state.inspect.b(<span class="string">&#x27;mem_read&#x27;</span>, when=angr.BP_BEFORE, action=track_read_mem_before)</span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> fun_name <span class="keyword">in</span> tainted_func:</span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">128</span> == <span class="number">128</span>:</span><br><span class="line">    initial_state.regs.rdi = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">64</span> == <span class="number">64</span>:</span><br><span class="line">    initial_state.regs.rsi = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">32</span> == <span class="number">32</span>:</span><br><span class="line">    initial_state.regs.rdx = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>)           </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">16</span> == <span class="number">16</span>:</span><br><span class="line"></span><br><span class="line">    initial_state.regs.rcx = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">8</span> == <span class="number">8</span>:</span><br><span class="line">    initial_state.regs.r8 = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tainted_func[fun_name] &amp; <span class="number">4</span> == <span class="number">4</span>:</span><br><span class="line">    initial_state.regs.r9 = initial_state.solver.BVS(<span class="string">&quot;k&quot;</span>, <span class="number">64</span>) </span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = <span class="built_in">len</span>(state.ch.chain)//<span class="number">4</span></span><br><span class="line"><span class="keyword">while</span> l &gt;= <span class="number">1</span>:</span><br><span class="line">    l = l - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> state.ch.chain[<span class="number">4</span>*l+<span class="number">1</span>] <span class="keyword">is</span> state.inspect.mem_write_address:</span><br></pre></td></tr></table></figure>

<p>四个一组 循环找 所以chain就是论文中的W和M</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/level5uiharu/p/16932453.html">欢迎回来(。・∀・)ノ (cnblogs.com)</a></p>
<p>这里chain和expr应该都是AST key要么在arg0要么在arg1 </p>
<p>第一个条件是判断是否相等 第二个条件是判断换一个变量是否可以不等(把key换成另一个symbol)</p>
<p>这里虽然名字都是sol 但实际上都是两个不同的symbol 比如sol_22 sol_23</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>  temp1 == <span class="string">&#x27;__add__&#x27;</span> <span class="keyword">and</span> temp2 ==  <span class="string">&#x27;__add__&#x27;</span> :</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;k&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">0</span>]):</span><br><span class="line">    	temp3 = state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] - state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">0</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	temp3 = state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] - state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>].args[<span class="number">1</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))                                       </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;k&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(state.inspect.mem_write_expr.args[<span class="number">0</span>]):</span><br><span class="line">    	temp4 = state.inspect.mem_write_expr - state.inspect.mem_write_expr.args[<span class="number">0</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	temp4 = state.inspect.mem_write_expr - state.inspect.mem_write_expr.args[<span class="number">1</span>] + state.solver.BVS(<span class="string">&quot;sol&quot;</span>,  <span class="built_in">int</span>(b))</span><br><span class="line">    <span class="keyword">if</span> state.solver.satisfiable(extra_constraints=[state.ch.chain[<span class="number">4</span>*l+<span class="number">3</span>] == state.inspect.mem_write_expr, temp3 != temp4]):</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&quot;bug in &#123;&#125; for &#123;:x&#125; and &#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(fun_name, state.ch.chain[<span class="number">4</span>*l], state.inspect.instruction), file=f_result)                     </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里等号的含义是，是否存在某一组symbol的组合(k1 k2 k3 k4) 使得取值可以相等(64bit整数)</p>
<p>W1 W2应该表示连续两次读 (i变i+1 或f前和f后)</p>
<p><strong>ch.chain和inspect.mem_write_expr</strong>是什么？  好像后者就是前者的4l+2?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">state.ch.chain = state.ch.chain + [state.inspect.instruction]</span><br><span class="line">state.ch.chain = state.ch.chain + [state.inspect.mem_write_address]</span><br><span class="line">a = <span class="built_in">str</span>(state.inspect.mem_write_expr)</span><br><span class="line">b = a[<span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">state.ch.chain = state.ch.chain + [b]</span><br><span class="line">state.ch.chain = state.ch.chain + [state.inspect.mem_write_expr]</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://github.com/Sen-Deng/CipherH/blob/master/evaluation_result/wolfssl_rsa_o0/symbolic_exec/result.txt">CipherH&#x2F;evaluation_result&#x2F;wolfssl_rsa_o0&#x2F;symbolic_exec&#x2F;result.txt at master · Sen-Deng&#x2F;CipherH (github.com)</a></p>
<p>这个地址应该就是二进制文件里面的地址 非常精确 供之后手动分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bug in fp_rshb for 41cc2a and 41cc2a</span><br><span class="line">bug in fp_rshb for 41cc63 and 41cc63</span><br><span class="line"></span><br><span class="line">bug in _fp_exptmod_ct for 41ee25 and 41ee5c</span><br><span class="line">bug in _fp_exptmod_ct for 41ee4b and 41ee4b</span><br><span class="line">bug in _fp_exptmod_ct for 41ee5c and 41ee5c</span><br><span class="line">bug in _fp_exptmod_ct for 41f04b and 41f04b</span><br></pre></td></tr></table></figure>

<h4 id="inter"><a href="#inter" class="headerlink" title="inter"></a>inter</h4><p>同一块内存会在函数调用间被写</p>
<ul>
<li>频繁调用</li>
<li>callee至少一个参数是tainted</li>
</ul>
<p>没有加约束求解 所以可能带来false positives</p>
<blockquote>
<p>In all, during our intra-procedural analysis, we use symbolic execution to traverse each path of a tainted function Fc. During the traversal, we search for every encountered callee function and decide if any callee function F meets the aforementioned patterns. If so, we will proceed further to launch intra-procedural symbolic execution toward F, and decide if F has memory write instructions whose content is derived from its tainted parameters. If so, we would conclude that F enables ciphertext side channels, assuming multiple runs of F from Fc write secrets into the same memory address.  </p>
</blockquote>
<p>只要callee F用taint 写了内存就认为会带来side channel</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/papers/CacheWarp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/papers/CacheWarp/" class="post-title-link" itemprop="url">CacheWarp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/papers/" itemprop="url" rel="index"><span itemprop="name">papers</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>733</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CacheWarp"><a href="#CacheWarp" class="headerlink" title="CacheWarp"></a>CacheWarp</h1><p>snp用的是<a target="_blank" rel="noopener" href="https://github.com/sev-step/sev-step">sev-step&#x2F;sev-step: This repo tracks a compatible state of all sev step components and contains script to easily install everything required to setup a sev vm (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/blob/main/kernel-patch/kernel.patch">CacheWarp&#x2F;kernel-patch&#x2F;kernel.patch at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>SEV_STEP_FLAG_BASE_PFN   sev_step_page_va  和user通信地址</p>
<p>intr_interception 核心逻辑</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/blob/main/userspace-controller/cachewarp/cachewarp.c">CacheWarp&#x2F;userspace-controller&#x2F;cachewarp&#x2F;cachewarp.c at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>sev_step_kernel_sync_addr_p 和step框架通信</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sev_step_kernel_sync_addr_p = libtea_map_physical_address_range(instance, KERNEL_SYNC_PA, <span class="number">4096</span>, PROT_READ | PROT_WRITE, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">memset</span>(sev_step_kernel_sync_addr_p, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">uint16_t</span> vec[<span class="number">100</span>] = &#123;<span class="number">44</span>, <span class="number">0</span>,<span class="number">8</span>,<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="number">8</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>, <span class="number">0</span>,<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span> ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x201</span>, <span class="number">1</span>,<span class="number">0x101</span>,<span class="number">0x101</span>,<span class="number">3</span>,<span class="number">0x11</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">0x41</span>,<span class="number">0x41</span>,<span class="number">0x5</span>, <span class="number">1</span>,<span class="number">0x11</span>,<span class="number">0x21</span>,<span class="number">0x20</span>,<span class="number">1</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>, <span class="number">0x21</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x3000</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= vec[<span class="number">0</span>]; i++)</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movw %1, (%0)\n\t&quot;</span>:: <span class="string">&quot;r&quot;</span>(sev_step_kernel_sync_addr_p+<span class="number">16</span>+<span class="number">2</span>*i),<span class="string">&quot;r&quot;</span>(vec[i]):)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>vec攻击向量 和sudo的binary有关</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cispa/CacheWarp/tree/main/sudo">CacheWarp&#x2F;sudo at main · cispa&#x2F;CacheWarp (github.com)</a></p>
<p>用到libtea 是usenix security22提供的一套框架 不用自己写一大堆难懂的汇编 并且屏蔽掉平台的差异</p>
<p><a target="_blank" rel="noopener" href="https://github.com/libtea/frameworks/blob/master/libtea/src/libtea_common.c">frameworks&#x2F;libtea&#x2F;src&#x2F;libtea_common.c at master · libtea&#x2F;frameworks (github.com)</a></p>
<p>vec记录了一串数值 是step指令的序列</p>
<p>vmsa layout 记录在手册中</p>
<p><a target="_blank" rel="noopener" href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf">https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf</a></p>
<p>Table B-4. VMSA Layout, State Save Area for SEV-ES</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vmsa_paddr = svm-&gt;vmcb-&gt;control.vmsa_pa;</span><br><span class="line"></span><br><span class="line">rsp = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x1d8</span>);</span><br><span class="line">rbp = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x328</span>);</span><br><span class="line">rax = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x1f8</span>);</span><br><span class="line">rcx = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x308</span>);</span><br><span class="line">rdx_rbx = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x310</span>);</span><br><span class="line">rsi_rdi = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x330</span>);</span><br><span class="line">r8_r9   = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x340</span>);</span><br><span class="line">r10_r11 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x350</span>);</span><br><span class="line">r12_r13 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x360</span>);</span><br><span class="line">r14_r15 = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x370</span>);</span><br><span class="line">xmm = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x470</span>);</span><br><span class="line">ymm = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x570</span>);</span><br><span class="line">cs  = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x10</span>);</span><br><span class="line">ss  = *(<span class="keyword">volatile</span> u64 *)(vmsa_vaddr+<span class="number">0x20</span>);</span><br><span class="line">reg_vector = ((last_vmsa_rsp != rsp) &lt;&lt; <span class="number">0</span>) + ((last_vmsa_rbp != rbp) &lt;&lt; <span class="number">1</span>) + \</span><br><span class="line">						((last_vmsa_rax != rax) &lt;&lt; <span class="number">2</span>) 		   + ((last_vmsa_rcx != rcx) &lt;&lt; <span class="number">3</span>) + \</span><br><span class="line">						((last_vmsa_rdx_rbx != rdx_rbx) &lt;&lt; <span class="number">4</span>)  + ((last_vmsa_rsi_rdi != rsi_rdi) &lt;&lt; <span class="number">5</span>) + \</span><br><span class="line">						((last_vmsa_r8_r9 != r8_r9) &lt;&lt; <span class="number">6</span>) 	   + ((last_vmsa_r10_r11 != r10_r11) &lt;&lt; <span class="number">7</span>) + \</span><br><span class="line">						((last_vmsa_r12_r13 != r12_r13) &lt;&lt; <span class="number">8</span>)  + ((last_vmsa_r14_r15 != r14_r15) &lt;&lt; <span class="number">9</span>) + \</span><br><span class="line">						((last_vmsa_xmm != xmm) &lt;&lt; <span class="number">10</span>) 		   + ((last_vmsa_ymm != ymm) &lt;&lt; <span class="number">11</span>) + \</span><br><span class="line">						((last_vmsa_cs != cs) &lt;&lt; <span class="number">12</span>) 		   + ((last_vmsa_ss != ss) &lt;&lt; <span class="number">13</span>);</span><br><span class="line"><span class="keyword">if</span> (reg_vector != *((<span class="keyword">volatile</span> u16 *)(sev_step_page_va + PATH_OFFSET + path_index*<span class="number">2</span>))) &#123;</span><br><span class="line">						find_target = <span class="literal">false</span>;</span><br><span class="line">						printk(<span class="string">&quot;dismatch %dth Instr! the vector is 0x%x\n&quot;</span>, path_index, reg_vector);</span><br><span class="line">					&#125;</span><br></pre></td></tr></table></figure>









<p>user 先设置flag  kvm把所有页表present bit设为0 guest触发NPF</p>
<p>kvm拿到gpa 设置APIC</p>
<p>小于阈值 0step 大于阈值 &gt;&#x3D;1step</p>
<p>观察RIP看是0还是非0</p>
<p>snp增加了freshness 寄存器一样密文也会变 可以用sev-step的performance counter</p>
<p>由于vmsa的cache 导致每次context switch时间不稳定 因此用MTRR标记为不可缓存 并且用wbinvd解决AMD CPU可能stale的问题</p>
<p>NPF的作用是啥</p>
<blockquote>
<p>To ensure consistent conditions for every stepping, the hypervisor always clears the present bit of the last fault page when handling the APIC timer interrupt, i.e., an NPF is always triggered before the next APIC interrupt.  </p>
</blockquote>
<p>为了控制变量 保证时间稳定？感觉几乎没有用</p>
<ol>
<li>run的汇编每次固定apic timer 可以step</li>
<li>sev-step没有提到page fault</li>
</ol>
<p>是否只是拿个gpa 方便找pattern？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__svm_sev_es_vcpu_run(svm, spec_ctrl_intercepted, (u32*)(APIC_BASE + APIC_TMICT), apic_interval, wbnoinvd);</span><br><span class="line">SYM_FUNC_START(__svm_sev_es_vcpu_run)</span><br><span class="line">    movl %_ASM_ARG4L, (%_ASM_ARG3)</span><br></pre></td></tr></table></figure>

<p>攻击触发点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">ctrl_thread</span><span class="params">(<span class="type">void</span>* dummy)</span> &#123; </span><br><span class="line">	</span><br><span class="line">	pin_to_core(ASSIST_CORE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// hook kvm_exit_handler in the kernel </span></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;movq %1, (%0)\n&quot;</span>::<span class="string">&quot;r&quot;</span>(sev_step_kernel_sync_addr_p),<span class="string">&quot;r&quot;</span>(flag):)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Wait until the attack finishes */</span></span><br><span class="line">	<span class="keyword">while</span> (*(<span class="type">uint32_t</span>*)(sev_step_kernel_sync_addr_p)) &#123;sched_yield();&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">intr_interception</span><br><span class="line">    <span class="comment">/* Start */</span></span><br><span class="line">    <span class="keyword">if</span> (zero_stepping_time == <span class="number">0</span> &amp;&amp; non_zero_stepping_time == <span class="number">0</span>) &#123;</span><br><span class="line">        kvm_unpre_all(vcpu-&gt;kvm, svm-&gt;vmcb-&gt;control.asid);</span><br><span class="line">        svm_flush_tlb_current(vcpu);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Mark VMSA into UC will make `VMRUN` updates all vmsa state in cache */</span></span><br><span class="line">        <span class="keyword">if</span> (uc_vmsa) &#123;</span><br><span class="line">            mtrr_uc_page(vmsa_paddr, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Avoid to drop smth dirty data and freeze the system</span></span><br><span class="line"><span class="comment">			 * wbnoinvd is enough to make it reliable</span></span><br><span class="line"><span class="comment">			 * wbinvd also works, but it takes longer time</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">        <span class="keyword">if</span> (invd) &#123;</span><br><span class="line">            <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;wbnoinvd\n\t&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ssh 怎么利用page fault一起找的？</p>
<p>npf_interception intr_interception svm_vcpu_enter_exit三者关系是什么？</p>
<p>exit之后不就是NPF或者INTR 为什么急着先处理？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/misc/react-native-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/misc/react-native-note/" class="post-title-link" itemprop="url">react-native 开发记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="react-native-开发记录"><a href="#react-native-开发记录" class="headerlink" title="react-native 开发记录"></a>react-native 开发记录</h1><h2 id="react-native-项目配置"><a href="#react-native-项目配置" class="headerlink" title="react-native 项目配置"></a>react-native 项目配置</h2><ul>
<li><p>最新版0.68 要求jdk11 互联网课装好的是jdk8 所以使用0.66.4</p>
<p>用intellij自动生成是最新版的，降级：</p>
</li>
</ul>
<p><code>npm install --save react-native@0.66.4</code></p>
<ul>
<li><p>用intellij自动生成的 跑不了 会报少文件 用官网说的命令行方式新建项目<code>npx react-native init Project --version 0.66.4</code></p>
<p>然而用命令行新建的项目再用intellij打开并不能识别 所以用vscode</p>
</li>
<li><p>安卓模拟器配置：<a target="_blank" rel="noopener" href="https://reactnative.dev/docs/environment-setup">https://reactnative.dev/docs/environment-setup</a></p>
</li>
<li><p>编译运行：<code>npx react-native run-android</code> (用vscode可以终端-运行任务)</p>
</li>
<li><p>打包发给手机：(android目录下)<code>gradlew assembleRelease</code></p>
<p>apk路径：Project\android\app\build\outputs\apk\release</p>
</li>
<li><p>ios不像安卓这么容易，必须用Xcode，而Xcode又必须是mac环境</p>
</li>
</ul>
<h2 id="package"><a href="#package" class="headerlink" title="package"></a>package</h2><p>包有互相依赖关系<br><code>npm install --legacy-peer-deps</code> 避免报错</p>
<h3 id="导航"><a href="#导航" class="headerlink" title="导航"></a>导航</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;@react-navigation/native&quot;: &quot;^6.0.10&quot;,</span><br><span class="line">&quot;@react-navigation/stack&quot;: &quot;^6.2.1&quot;,</span><br></pre></td></tr></table></figure>
<p>有如下依赖包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;react-native-gesture-handler&quot;: &quot;^2.5.0&quot;,</span><br><span class="line">&quot;react-native-safe-area-context&quot;: &quot;^4.3.1&quot;,</span><br><span class="line">&quot;react-native-safe-area-view&quot;: &quot;^1.1.1&quot;,</span><br><span class="line">&quot;react-native-screens&quot;: &quot;3.13.1&quot;</span><br></pre></td></tr></table></figure>
<h3 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h3><p><code>&quot;@react-native-community/async-storage&quot;: &quot;^1.12.1&quot;</code></p>
<h3 id="antd"><a href="#antd" class="headerlink" title="antd"></a>antd</h3><p>antd-mobile不支持react native 换一个支持的</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ant-design/ant-design-mobile-rn">https://github.com/ant-design/ant-design-mobile-rn</a></p>
<p><a target="_blank" rel="noopener" href="https://rn.mobile.ant.design/">https://rn.mobile.ant.design/</a></p>
<p><code>&quot;@ant-design/react-native&quot;: &quot;5.0.0&quot;</code></p>
<p>依赖包(issue中发现)<br><code>npm install classnames rc-util fbjs</code></p>
<p>但实际上移动端的antd实现的组件并不如web端那么丰富，很多时候react-native自带的组件已经挺不错了</p>
<h3 id="webrtc"><a href="#webrtc" class="headerlink" title="webrtc"></a>webrtc</h3><p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc">https://github.com/react-native-webrtc/react-native-webrtc</a></p>
<p>下这个包会很慢，需要耐心等</p>
<p>启动有问题，不报任何错误 在issue中找到解决方法，修改安卓文件配置即可</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc/issues/1080">https://github.com/react-native-webrtc/react-native-webrtc/issues/1080</a></p>
<p>针对安卓的权限问题解决如下</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc/blob/master/Documentation/AndroidInstallation.md">https://github.com/react-native-webrtc/react-native-webrtc/blob/master/Documentation/AndroidInstallation.md</a></p>
<h3 id="simple-peer"><a href="#simple-peer" class="headerlink" title="simple peer"></a>simple peer</h3><p><a target="_blank" rel="noopener" href="https://github.com/feross/simple-peer">https://github.com/feross/simple-peer</a></p>
<p>simple-peer并没有说是支持移动端的，但是可以根据如下方法直接使用<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/66281342/simple-peer-with-react-native-webrtc">https://stackoverflow.com/questions/66281342/simple-peer-with-react-native-webrtc</a></p>
<p>遇到的问题在于，react-native-webrtc中的RTCPeerConnection还没有实现很多API，因此在使用的时候会直接报错。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-webrtc/react-native-webrtc/pull/1160">https://github.com/react-native-webrtc/react-native-webrtc/pull/1160</a><br>此PR增加API 但仍在开发中</p>
<p>若此后遇到问题，可尝试更换框架为peerjs</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Zemke/react-native-peerjs">https://github.com/Zemke/react-native-peerjs</a></p>
<p><a target="_blank" rel="noopener" href="https://peerjs.com/docs/#api">https://peerjs.com/docs/#api</a></p>
<h3 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h3><p><a target="_blank" rel="noopener" href="https://github.com/tradle/react-native-crypto">https://github.com/tradle/react-native-crypto</a></p>
<p>最后一句换成<code>node_modules\.bin\rn-nodeify --hack --install --legacy-peer-deps</code><br>默认的crypto库的方法是基于浏览器内核的，在react-native项目中会报错(例如randomBytes)，使用react-native-randombytes并不能直接解决问题。</p>
<p>安装react-native-crypto后根据教程进行配置，可以使其替代原有的crypto而不用修改其他库的源代码。(simple-peer中实例化Peer遇到此问题)</p>
<p>之后package.json中会出现很多奇奇怪怪的包</p>
<h2 id="一些错误"><a href="#一些错误" class="headerlink" title="一些错误"></a>一些错误</h2><p>出现任何错误 通用解决方案：</p>
<ol>
<li>重启metro</li>
<li>node_modules删了再装</li>
<li>重启电脑</li>
</ol>
<ul>
<li><pre><code>npm ERR! Error: read ECONNRESET
npm ERR!     at TLSWrap.onStreamRead (node:internal/stream_base_commons:217:20) &#123;
npm ERR!   errno: -4077,
npm ERR!   code: &#39;ECONNRESET&#39;,
npm ERR!   syscall: &#39;read&#39;
npm ERR! &#125;
</code></pre>
<p>这个是网络不好 可以多试几次  或者用cnpm 或者换源</p>
</li>
<li><p><code>could not get batchedbridge</code> 重启metro</p>
</li>
<li><p><code>Invariant Violation: Module AppRegistry is not a registered callable module (calling runApplication)</code>重启metro</p>
</li>
<li><p><code>npm ERR! could not determine executable to run</code>仔细看命令 npm莫名其妙会变成npx</p>
</li>
<li><p><code>module could not be found within the project or in these directories:node_modules</code> 重启metro 如果不行删了node_modules再装</p>
</li>
<li><p><code>warn No apps connected. Sending &quot;reload&quot; to all React Native apps failed. Make sure your app is running in the simulator or on a phone connected via USB. info Reloading app...</code><br>这个的原因是app本身有问题 导致一打开就会闪退 或者其他原因根本打不开 和模拟器的连接没有问题  但是找不到任何报错的信息 因此只能控制变量去看;<br>少装几个包就没这个问题了 因此是装了的包 即使代码里没有用 也会导致这个问题;具体是react-native-webrtc要求安卓的minSdkVersion 需要修改android目录下的配置文件</p>
</li>
<li><p><code>&#39;react-native&#39; 不是内部或外部命令，也不是可运行的程序 或批处理文件。</code>这个可能是uninstall的时候多删东西了 直接<code>npm install</code>就行</p>
</li>
<li><p><code>TypeError: undefined is not an object (evaluating &#39;process.version.split&#39;)</code>这个问题并没有解决</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/30654">https://github.com/facebook/react-native/issues/30654</a></p>
</li>
</ul>
<h2 id="待解决的问题"><a href="#待解决的问题" class="headerlink" title="待解决的问题"></a>待解决的问题</h2><ul>
<li><p>使用路由后导致页面卡死</p>
</li>
<li><p>某些手机下载软件后网络请求错误  可能是手机版本导致禁用了http 可能https可以解决</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32312317/article/details/80868118">React Native: TypeError: Network request failed_翻船现场的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/32931">HTTP Fetch fails with “TypeError: Network request failed” &#x3D;&gt; Resolved · Issue #32931 · facebook&#x2F;react-native (github.com)</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/misc/kubelet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/misc/kubelet/" class="post-title-link" itemprop="url">kubelet</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>11 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h1><h2 id="containerd"><a href="#containerd" class="headerlink" title="containerd"></a>containerd</h2><p><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">containerd&#x2F;getting-started.md at main · containerd&#x2F;containerd (github.com)</a></p>
<p>镜像自带，但需要安装cni，高版本没有自带的flannel，用0.9.1版本可以</p>
<h3 id="management"><a href="#management" class="headerlink" title="management"></a>management</h3><p>管理容器，考虑以下三种方法：</p>
<ol>
<li><p>containerd启动时会作为grpc server，监听在<code>unix:///run/containerd/containerd.sock</code> 可以像k8s一样作为grpc client调定义好的CRI接口。但是我们不需要考虑项目不同模块解耦，也不需要考虑支持其他的容器运行时，对于grpc的调用需要自己构造参数，太复杂，并且试了一下很难跑起来。</p>
</li>
<li><p>用exec+ctl</p>
<p>这里可以使用containerd写的nerdctl 兼容docker的命令行格式</p>
<p><a target="_blank" rel="noopener" href="https://github.com/containerd/nerdctl">containerd&#x2F;nerdctl: contaiNERD CTL - Docker-compatible CLI for containerd, with support for Compose, Rootless, eStargz, OCIcrypt, IPFS, … (github.com)</a></p>
<p>完全用cli工具技术含量不高，且需要经过nerdctl这个大框架的解析，效率不高。</p>
<p>可以做一些辅助用途，比如测试、启动pause等。核心的查看容器状态和启动容器还是用containerd的go api</p>
</li>
<li><p>containerd api</p>
<p>实在难用，官方文档一共就readme的几句话，剩下的全靠看源码+猜+看nerdctl源码如何使用</p>
</li>
</ol>
<p>这里研究出的api如下</p>
<ul>
<li>创建容器 包括配置</li>
<li>销毁容器</li>
<li>获取容器状态</li>
<li>获取容器资源信息</li>
</ul>
<h3 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h3><ul>
<li><p><code>WithMounts</code> 挂载 需要将type和options同时设为bind，否则会报<code>no such device</code>的错</p>
</li>
<li><p><code>WithDomainname</code> <code>WithHostname</code></p>
</li>
<li><p><code>WithLinuxNamespace</code>可以加入其他进程的namespace 但是需要先起task 拿到pid<code>proc/pid/ns/uts</code></p>
<p>启动pause容器后，将此pod内的所有其他容器加入到pause容器的namespace<br>观察containerd的源码可知，就算什么都不配置，默认也是使用了ipc、uts、network、mount、pid这五个命名空间隔离的<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40579389/article/details/125941366">k8s之pause容器</a>按这篇文章的意思 除了mount其他都不需要和pause隔离<br>需要修改的话 一种是自己写配置函数，另一种是使用这个api但只能一个个单独设 </p>
</li>
<li><p><code>WithProcessArgs</code> 启动命令 只有windows支持<code>ProcessCmdLine</code> 不过简单的命令使用起来效果差不多，具体可能涉及到entrypoint 和cmd的区别</p>
</li>
<li><p><code>Withenv</code>  环境变量 <code>&quot;a=c&quot;</code> </p>
</li>
<li><p><code>WithMemoryLimit</code> 单位是字节，如果容器使用内存超过这个数 会被直接kill。</p>
<p>莫名其妙会有bug，报cgroup的错，全网查不到信息，使用“30Mi” 没问题</p>
</li>
<li><p>CPU：</p>
<ul>
<li><code>WithCPUs</code> 将容器进程绑定到指定cpu执行，比如<code>0-3</code>绑定到0 1 2 3  ，<code>1</code>绑定到1</li>
<li><code>WithCPUCFS</code> 调度器，对应到nerdctl 是<code>--cpus</code> 会使用这个api，但是网上说这个参数指定cpu核，这个说法不准确，实际上如果这个值为1，会发生cpu0 和cpu1占用率都在50%的情况，即总使用量为1</li>
<li><code>WithCPUShares</code> 份额</li>
</ul>
</li>
<li><p>port: 仅作标识用，没有意义，所以没有对应api</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4b16c995990b">k8s四种port解析：nodePort、port、targetPort、containerPort - 简书 (jianshu.com)</a> </p>
</li>
<li><p><code>WithContainerLabels</code>这个功能为container提供label</p>
<p>配合<code>client.Containers(ctx,fmt.Sprintf(&quot;labels.%q==%s&quot;, &quot;pod&quot;, pod.Data.Name))</code>一起使用</p>
<p>对于apiserver维护的信息，只是自定义的container apiobject，并不是containerd的可以用来获取真实容器信息的对象，使用containerd的添加label并使用filter的方法可以很方便地拿到一个pod对应的所有containers，否则需要通过遍历容器并比较ID来判断。</p>
</li>
</ul>
<h3 id="task"><a href="#task" class="headerlink" title="task"></a>task</h3><p>containerd的api有一个docker没有的概念task</p>
<p>每个容器创建后，可以开启task，每个task对应一个进程，有对应的api，这时候才会产生新的命名空间</p>
<p>删除容器，先要killtask 然后delete task 最后delete容器</p>
<h3 id="image"><a href="#image" class="headerlink" title="image"></a>image</h3><p>containerd本身管理容器运行时，对于其他功能的提供非常少，包括拉取镜像。使用containerd提供的api只能做到从某个registry拉取，本地image是不行的，不带registry的image也是不行的。</p>
<p>通过观察nerdctl的源码可以得到以下两个扩展：</p>
<ol>
<li><code>pkg/imgutil/dockerconfigresolver/dockerconfigresolver.go/New</code>可知使用docker的resolver可以做到从不同registry(包括自己部署的)拉取镜像</li>
<li><code>pkg/imgutil/imgutil.go/GetExistingImage</code>可知containerd提供<code>NewImage</code>方法，供<code>image.Image</code>对象到<code>containerd.Image</code>的转换，这里<code>image.Image</code>可以通过<code>client.ImageService().Get(imageName)</code>来获取。虽然这里在字符串解析上也必须出现registry的部分，但是实际上不会真的pull，而是从本地获取(<code>nerdctl image list</code>可见即可)</li>
</ol>
<p>如果image在自己部署的registry中但还未被pull，这两种方法都是行不通的，需要自己创建docker resolver然后用WithResolver的配置去pull。这里图方便，解决方案为先用cli工具提前pull，随后紧接着用方法2获取到image对象</p>
<h3 id="pause"><a href="#pause" class="headerlink" title="pause"></a>pause</h3><p>用containerd api设置网络特别麻烦，因此直接用nerdctl跑pause容器，并inspect拿到pid</p>
<p>因此这里直接使用podname+”-pause”为每个pause容器命名</p>
<p>虽然containerd的container对象只能访问.ID，而nerdctl 的 <code>--name</code> 设置的是name并不是id 但还是可以通过containerd的filter+label拿到container对象</p>
<p>然而由于一开始pause容器利用nerdctl实现网络配置，nerdctl本身除了调用containerd的api外，自己有维护一个namestore，在创建容器时会 <code>aquire</code> 需要在销毁时 <code>release</code></p>
<p>所以销毁容器只调containerd的api是不够的，会导致containerd的容器已经被删掉了，但是nerdctl维护的信息还没删，导致下一次创建同名pause容器会有问题</p>
<p>解决方案可以是照nerdctl的代码找到对应的文件路径 然后照抄 <code>release</code>的代码，但这导致minik8s存在与nerdctl耦合的路径配置，较复杂 所以不如销毁pause仍用nerdctl直接实现</p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>containerd相较于docker并没有提供任何网络相关帮助，所以完全依赖CNI插件</p>
<p><code>nerdctl network ls</code> <code>nerdctl run -net host/none</code></p>
<p>CNI插件完成两个目标</p>
<ol>
<li>让每个容器(实际上就是一个pod)拥有一个虚拟网卡，使其拥有访问外网的能力</li>
<li>支持跨node(物理主机)的pod间通信</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41033724/article/details/124976813">Kubernetes容器网络及Flannel插件详解_边缘计算社区的博客-CSDN博客</a></p>
<p>思路：</p>
<ol>
<li>使用flannel插件创建网络 此时每个node都会出现<code>flannel.1</code>的虚拟网卡，可以互相通信</li>
<li>使用<code>nerdctl run -net flannel pause</code> 创建pause容器，此时ip在不同node上会在不同子网中进行分配，不会重复</li>
<li>其他容器加入pause容器的network namespace</li>
</ol>
<h3 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h3><p><a target="_blank" rel="noopener" href="https://github.com/flannel-io/flannel/blob/master/Documentation/running.md">flannel&#x2F;running.md at master · flannel-io&#x2F;flannel · GitHub</a></p>
<p>flannel目前已经支持了etcd v3版本，不需要切换v2。</p>
<p>etcd v3 v2的数据是不互通的，flanneld启动时默认会在v3里找数据</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lhang/p/17306765.html">Docker容器使用Flannel通信 - L_Hang - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_30641567/article/details/123917486">Containerd网络管理_containerd 端口映射_班婕妤的博客-CSDN博客</a></p>
<p>只有master节点通过apiserver使用etcd，kubelet部署在node上 不需要也不能管理etcd</p>
<p>只需要一个etcd 不需要集群 (flannel如果使用etcd集群会出找不到lease的bug)</p>
<p>master <code>etcd --listen-peer-urls=&quot;http://192.168.1.12:2380,http://localhost:2380&quot; --listen-client-urls=&quot;http://192.168.1.12:2379,http://localhost:2379&quot; --initial-advertise-peer-urls=&quot;http://192.168.1.12:2380,http://localhost:2380&quot; --advertise-client-urls=&quot;http://192.168.1.12:2379,http://localhost:2379&quot;</code></p>
<p>master <code>etcdctl --endpoints &quot;http://192.168.1.12:2379&quot; put /coreos.com/network/config &#39;&#123;&quot;NetWork&quot;:&quot;10.2.0.0/16&quot;,&quot;SubnetMin&quot;:&quot;10.2.1.0&quot;,&quot;SubnetMax&quot;: &quot;10.2.20.0&quot;,&quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#39;</code></p>
<p>node启动<code>./flanneld-amd64 -etcd-endpoints=http://192.168.1.12:2379 -iface=ens3</code></p>
<p>这里ens3是主机上能和外界通信的网卡，如果不设置flannel也会自动找</p>
<p>出现<code>flannel.1</code>的网卡。如果修改配置后第一次的flannel1无法消失 出现cni0 重启可以解决</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;flannel&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cniVersion&quot;</span>: <span class="string">&quot;0.3.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;flannel&quot;</span>,</span><br><span class="line">      <span class="string">&quot;delegate&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;isDefaultGateway&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;portmap&quot;</span>,</span><br><span class="line">      <span class="string">&quot;capabilities&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;portMappings&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>nerdctl run -d -v /home/test_mount:/root/test_mount --net flannel -e port=12345 mcastelino/nettools /root/test_mount/test_network</code> 测试网络可行<br>nerdctl对于网络的解析太复杂了，对于pause并没有很多额外的配置，所以直接用ctl启动pause<br>在加入pause的namespace后发现，虽然其他容器有通过虚拟网卡向外找到合适的转发接口的能力，但是并没有DNS server。这里解决方法是使用外部的<code>nerdctl cp</code>命令将首个容器(pause)的<code>/etc/resolv.conf</code> <code>/etc/hosts</code>文件复制给每个该pod下的容器<br>容器内部部署的服务 可在主机上通过容器ip+容器内端口的方式直接访问到，至此实现pod间通信、主机与pod通信，后续交给kube-proxy</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43266367/article/details/127836595">k8s网络插件之Flannel_林凡修的博客-CSDN博客</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>由于需要给pod增加dns服务，在master上使用coredns作为dns server，解决方法是在resolve.conf中第一条加入master节点的ip（必须53端口）</p>
<p>resolv.conf的逻辑是 如果前一个nameserver连接不上，才会继续向下一个nameserver查找。</p>
<p>如果前一个nameserver连接上了但是没有记录，则会直接报无记录，不会向下一个nameserver查找。</p>
<p>因此必须保证在集群网络通常的情况下，master节点必须启用coredns并且coredns除了minik8s需要的dns服务，必须包括其他通用的dns服务。</p>
<h2 id="资源监控"><a href="#资源监控" class="headerlink" title="资源监控"></a>资源监控</h2><p>参考<code>cmd/nerdctl/container_stats_linux.go</code></p>
<p>可以通过containerd的api拿到metrics对象,不过需要Unmarshal，并且对应的接口离其报错，找不到type，只能照着containerd的源码手动用反射</p>
<h3 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h3><p>是一个定值，表示占用内存大小，单位byte</p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>进程创建开始之后累计执行的时间，如果跑在2个核上，过了1s，则记为2s<br>通过与上一次获取的cpu执行时间的delta和时间delta可以计算出CPUPercent，和top展示的cpu%是一模一样的<br>CPUPercent和容器创建指定的cpu参数可对应，例如指定cpu&#x3D;1，则cpu%&#x3D;100%;cpu&#x3D;2,cpu%&#x3D;200%（两核跑满）;cpu&#x3D;500m,cpu%&#x3D;50%</p>
<h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><p>kubelet主要做三件事</p>
<ol>
<li>websocket与apiserver保持长连接，监听到pod的创建、销毁状态时进行对应的容器操作。</li>
<li>作为http server接收对于容器资源的请求，获取并计算容器资源后返回。</li>
<li>每隔一段时间检查所有容器的状态，将存在停止容器的pod的状态通过短链接更新给apiserver</li>
</ol>
<p>针对container，1是写，23是读，可能会发生冲突。例如操作2正在统计某容器资源的时候，该容器被操作1删除。</p>
<p>使用读写锁为每个pod上锁，即<code>map[string]sync.RWMutex</code> 其中key为<code>namespace-podname</code> 锁必须细粒度，因为2操作非常慢。</p>
<p>go的map本身是线程不安全的，在对于同一个pod同时拿锁时可能创建两个不同的锁，严重时可能导致对于map的修改崩溃，因此将map替换为<code>sync.Map</code>。虽然同时写map没问题，但是很可能出现t1创建完并拿完锁之后return t2再次创建并拿锁，原因是并没有另一把锁来让对于map中某个key的访问设为临界区。使用<code>sync.Map</code>提供的<code>LoadOrStore(key,value)</code>方法，它会先判断是否存在某个key，如果存在返回<code>map[key]</code>，否则设置<code>map[key]=value</code>后返回value，最后用value.lock。这个方法只是压缩代码行数到了两行，但仍然不是原子的。最好是有类似<code>tbb::concurrent_hash_map::accessor</code>之类的东西。</p>
<p>解决方法是使用一把大锁保护<code>sync.Map</code>，每次写map都需要拿锁，虽然粒度从pod变大到了整个空间，但是这里锁保护的临界区非常小，之后对于map数据结构的写，很快。</p>
<p>在和apiserver连接中断后，任务2会继续做，任务1会每5s再发起一次连接请求，任务3会按之前的频率继续做(由于get请求会失败所以拿不到pod信息)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/misc/GPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/misc/GPU/" class="post-title-link" itemprop="url">GPU</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>9 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h1><h2 id="交我算平台"><a href="#交我算平台" class="headerlink" title="交我算平台"></a>交我算平台</h2><p><a target="_blank" rel="noopener" href="https://docs.hpc.sjtu.edu.cn/job/slurm.html">Slurm 作业调度系统 — 上海交大超算平台用户手册 文档 (sjtu.edu.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.hpc.sjtu.edu.cn/job/dgx.html">AI平台使用文档 — 上海交大超算平台用户手册 文档 (sjtu.edu.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.hpc.sjtu.edu.cn/job/jobsample2.html#cuda">作业示例（开发者） — 上海交大超算平台用户手册 文档 (sjtu.edu.cn)</a></p>
<p><code>srun -p dgx2 -N 1 -n 1 --gres=gpu:1 --cpus-per-task=6 --pty /bin/bash</code>直接进计算节点</p>
<p><code>sbatch xx.slurm</code>提交</p>
<p><code>squeue</code>查看未执行</p>
<p><code>sacct</code>查看任务</p>
<h2 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h2><h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><p><code>apt-get install -y nfs-kernel-server</code></p>
<p><code>/etc/exports</code>最后<code>/minik8s-sharedata *(rw,sync,no_subtree_check)</code></p>
<p><code>/etc/init.d/nfs-kernel-server restart</code></p>
<h3 id="node"><a href="#node" class="headerlink" title="node"></a>node</h3><p><code>apt-get install -y nfs-common</code></p>
<p><code>mount master:/minik8s-sharedata /minik8s-sharedata</code></p>
<p>master节点创建的文件&#x2F;文件夹在node节点readonly</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h3 id="主机与容器"><a href="#主机与容器" class="headerlink" title="主机与容器"></a>主机与容器</h3><p>通过查询相关资料，发现job的数据是只能通过与主机挂载目录完成的。master节点提交任务，最终跑在node节点，如何共享文件。</p>
<ol>
<li>把gpu的job yaml放在master节点，cu和Makefile放在node节点，且为该node节点加上gpu标签，yaml中的nodeselector加此标签。 这种方式把node暴露给用户，不合适。</li>
<li>集群部署docker registry，master节点build一个镜像，然后node节点pull。这样可以获得上传的文件，但是无法把结果拿给master。</li>
<li>NFS。master和node通过nfs，共享<code>/minik8s-sharedata</code>文件夹</li>
</ol>
<p>yaml文件挂载容器目录与主机共享文件夹，用环境变量指定参数和gpu文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-job</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gpu</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gpu-server</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">gpu-server</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;./job.py&quot;</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">source-path</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/gpu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job-name</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gpu-matrix</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">partition</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dgx2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;N&quot;</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ntasks-per-node</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cpus-per-task</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;6&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gres</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gpu:1</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/gpu</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share-data</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/minik8s-sharedata/gpu/matrix</span></span><br></pre></td></tr></table></figure>

<p>注意这里N是个奇怪的关键字，必须加引号否则会解析错误</p>
<p>容器把用户提供的source文件夹（包括代码文件和Makefile）整个上传到hpc服务器，以job-name命名，并本地生成slurm也上传到这个目录。要求用户代码将需要生成的文件放入source&#x2F;result中，并且一定要提前创建好，slurm会将程序的标准输入输出也放入source&#x2F;result中，最后可在主机的共享文件夹中拿到结果。</p>
<p>用户可以灵活地自由添加任意源文件，只需要提供Makefile。规定的只有两点：</p>
<ol>
<li>用户代码需要把生成的文件存到同目录下result子目录中</li>
<li>用户需要配置make build和make run两个命令</li>
</ol>
<h3 id="主机与hpc服务器"><a href="#主机与hpc服务器" class="headerlink" title="主机与hpc服务器"></a>主机与hpc服务器</h3><p>交大云主机<code>ssh-keygen -t rsa</code>为本机生成rsa公私钥</p>
<p><code>ssh-copy-id stu1648@pilogin.hpc.sjtu.edu.cn</code>将交大云主机公钥添加到hpc登陆节点的authorized_keys中</p>
<p>输入密码，添加成功</p>
<p>之后ssh scp均无须密码，不需要把密码硬编码在代码中，安全</p>
<h3 id="容器与hpc服务器"><a href="#容器与hpc服务器" class="headerlink" title="容器与hpc服务器"></a>容器与hpc服务器</h3><h4 id="build"><a href="#build" class="headerlink" title="build"></a>build</h4><p>所有node节点提前build镜像</p>
<p>可以用<code>nerdctl tag gpu-server master:5000/gpu-server</code></p>
<p><code>nerdctl push/pull master:5000/gpu-server --insecure-registry</code></p>
<p>containerd的镜像与docker不共享 不可以用<code>docker build</code>（或者通过docker registry中转）</p>
<p>如果用<code>nerdctl build</code> 需要存在<code>buildctl</code>(任意路径可调用)与<code>buildkitd</code>(提前跑的后台进程)<a target="_blank" rel="noopener" href="https://github.com/moby/buildkit/">Releases · moby&#x2F;buildkit (github.com)</a></p>
<p>需要为容器创建.ssh目录放入主机的rsa私钥和known_hosts文件，便于不需要输yes和输密码</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get -y install openssh-server python3-pip vim</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip3 install paramiko scp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span>  .ssh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./id_rsa .ssh/id_rsa</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./known_hosts .ssh/known_hosts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./job.py job.py</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>nerdctl build -t gpu-server .</code></p>
<p><code>scp stu1648@data.hpc.sjtu.edu.cn:~/test_gpu.cu .</code></p>
<p>仅使用shell命令只能做到文件传输，无法向远程主机发送需要执行的指令</p>
<p>解决方法是使用expect或具有ssh功能的语言编写程序</p>
<h4 id="expect"><a href="#expect" class="headerlink" title="expect"></a>expect</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/expect -f</span></span><br><span class="line">spawn bash -c &quot;ssh stu1648@pilogin.hpc.sjtu.edu.cn&quot;</span><br><span class="line"></span><br><span class="line">set timeout 6</span><br><span class="line">expect &quot;stu1648@pilogin*&quot;</span><br><span class="line">send &quot;mkdir abc\r&quot;</span><br><span class="line">expect &quot;stu1648@pilogin*&quot;</span><br><span class="line">send &quot;exit\r&quot;</span><br><span class="line"></span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure>

<p>expect正如名字所表达的，必须对服务端返回值在有限范围内进行预测，这是做不到从服务端拿到sbatch的返回值job_id的，故根据sacct或squeue查看job情况也无法完成，只能实现比较简单的提交任务操作。</p>
<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><p>使用python，可以不需要提前编译</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> scp <span class="keyword">import</span> SCPClient</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> getenv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NREAD = <span class="number">100000</span></span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">ssh.connect(<span class="string">&quot;pilogin.hpc.sjtu.edu.cn&quot;</span>,<span class="number">22</span>,<span class="string">&quot;stu1648&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">job_submit_tag = <span class="string">&quot;Submitted batch job&quot;</span></span><br><span class="line">line_finish_tag = <span class="string">&quot;[stu1648@&quot;</span></span><br><span class="line">PENDING = <span class="string">&quot;PENDING&quot;</span></span><br><span class="line">COMPLETED = <span class="string">&quot;COMPLETED&quot;</span></span><br><span class="line">FAILED = <span class="string">&quot;FAILED&quot;</span></span><br><span class="line"></span><br><span class="line">source_path = getenv(<span class="string">&quot;source-path&quot;</span>)</span><br><span class="line">job_name = getenv(<span class="string">&quot;job-name&quot;</span>)</span><br><span class="line">partition= getenv(<span class="string">&quot;partition&quot;</span>)</span><br><span class="line">N = getenv(<span class="string">&quot;N&quot;</span>)</span><br><span class="line">ntasks_per_node = getenv(<span class="string">&quot;ntasks-per-node&quot;</span>)</span><br><span class="line">cpus_per_task = getenv(<span class="string">&quot;cpus-per-task&quot;</span>)</span><br><span class="line">gres = getenv(<span class="string">&quot;gres&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> job_name <span class="keyword">or</span> <span class="keyword">not</span> source_path:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;env error&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> source_path[-<span class="number">1</span>] == <span class="string">&quot;/&quot;</span>:</span><br><span class="line">    <span class="comment"># scp send whole source</span></span><br><span class="line">    source_path = source_path[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> partition:</span><br><span class="line">    partition = <span class="string">&quot;dgx2&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> N:</span><br><span class="line">    N = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ntasks_per_node:</span><br><span class="line">    ntasks_per_node = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> cpus_per_task:</span><br><span class="line">    cpus_per_task = <span class="number">6</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> gres:</span><br><span class="line">    gres = <span class="string">&quot;gpu:1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_slurm</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;generating slurm&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;./<span class="subst">&#123;job_name&#125;</span>.slurm&quot;</span>,<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;#!/bin/bash\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --job-name=<span class="subst">&#123;job_name&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --partition=<span class="subst">&#123;partition&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH -N <span class="subst">&#123;N&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --ntasks-per-node=<span class="subst">&#123;ntasks_per_node&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --cpus-per-task=<span class="subst">&#123;cpus_per_task&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --gres=<span class="subst">&#123;gres&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># result must exist . is the same dir as .slurm</span></span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --output=result/output.txt\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;#SBATCH --error=result/error.txt\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        f.write(<span class="string">f&quot;ulimit -s unlimited\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;ulimit -l unlimited\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        f.write(<span class="string">&quot;module load gcc/8.3.0 cuda/10.1.243-gcc-8.3.0\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        f.write(<span class="string">&quot;make build\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;make run\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_source</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;uploading source&quot;</span>)</span><br><span class="line">    scp = SCPClient(ssh.get_transport(),socket_timeout=<span class="number">16</span>)</span><br><span class="line">    scp.put(source_path,recursive=<span class="literal">True</span>,remote_path=<span class="string">f&quot;~/<span class="subst">&#123;job_name&#125;</span>&quot;</span>)</span><br><span class="line">    scp.put(<span class="string">f&quot;./<span class="subst">&#123;job_name&#125;</span>.slurm&quot;</span>,<span class="string">f&quot;~/<span class="subst">&#123;job_name&#125;</span>/<span class="subst">&#123;job_name&#125;</span>.slurm&quot;</span>)</span><br><span class="line">    scp.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_result</span>(<span class="params">job_id</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;downloading result&quot;</span>)</span><br><span class="line">    scp = SCPClient(ssh.get_transport(),socket_timeout=<span class="number">16</span>)</span><br><span class="line">    scp = SCPClient(ssh.get_transport(),socket_timeout=<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#scp.get(f&quot;~/result/&#123;job_id&#125;.out&quot;,f&quot;&#123;source_path&#125;/&#123;job_name&#125;.out&quot;)</span></span><br><span class="line">    <span class="comment">#scp.get(f&quot;~/result/&#123;job_id&#125;.err&quot;,f&quot;&#123;source_path&#125;/&#123;job_name&#125;.err&quot;)</span></span><br><span class="line">    scp.get(<span class="string">f&quot;~/<span class="subst">&#123;job_name&#125;</span>/result&quot;</span>,recursive=<span class="literal">True</span>,local_path=<span class="string">f&quot;<span class="subst">&#123;source_path&#125;</span>/&quot;</span>)</span><br><span class="line">    scp.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit_job</span>():</span><br><span class="line">    t = <span class="number">3</span></span><br><span class="line">    <span class="keyword">while</span> t:</span><br><span class="line">        s = ssh.invoke_shell()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;starting ssh&quot;</span>)</span><br><span class="line">        sleep(<span class="number">2</span>)</span><br><span class="line">        recv = s.recv(NREAD).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> recv.find(<span class="string">&quot;stu1648&quot;</span>) == -<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;start ssh failed,retrying&quot;</span>)</span><br><span class="line">            t -= <span class="number">1</span></span><br><span class="line">            sleep(<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;start ssh success&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;sending sbatch&quot;</span>)</span><br><span class="line">        s.send(<span class="string">f&quot;cd ~/<span class="subst">&#123;job_name&#125;</span> &amp;&amp; sbatch ./<span class="subst">&#123;job_name&#125;</span>.slurm\n&quot;</span>)</span><br><span class="line">        sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        recv = s.recv(NREAD).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        index = recv.find(job_submit_tag)</span><br><span class="line">        <span class="keyword">if</span> index ==-<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(recv)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;sbatch failed,retrying&quot;</span>)</span><br><span class="line">            t -= <span class="number">1</span></span><br><span class="line">            sleep(<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;sbatch success&quot;</span>)</span><br><span class="line">        job_id = recv[index+<span class="built_in">len</span>(job_submit_tag)+<span class="number">1</span>:recv.index(line_finish_tag)-<span class="number">2</span>]</span><br><span class="line">        <span class="comment">#job_id = 25099457</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;job_id=&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;start checking job status&quot;</span>)</span><br><span class="line"></span><br><span class="line">        check_status_cmd = <span class="string">f&quot;sacct | grep <span class="subst">&#123;job_id&#125;</span> | awk &#x27;&#123;&#123;print $6&#125;&#125;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            s.send(check_status_cmd+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            recv = s.recv(NREAD).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            status = recv[recv.index(check_status_cmd)+<span class="built_in">len</span>(check_status_cmd)+<span class="number">2</span>:recv.index(line_finish_tag)-<span class="number">2</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;status=&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> status.find(FAILED)!=-<span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;job failed&quot;</span>)</span><br><span class="line">                <span class="comment">#user might need error message, still get results</span></span><br><span class="line">                <span class="comment">#exit(0)</span></span><br><span class="line">                <span class="keyword">return</span> job_id</span><br><span class="line">            <span class="keyword">if</span> status.find(COMPLETED)==-<span class="number">1</span>:</span><br><span class="line">                sleep(<span class="number">10</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> job_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">generate_slurm()</span><br><span class="line">upload_source()</span><br><span class="line">job_id =  submit_job()</span><br><span class="line"><span class="keyword">if</span> job_id:</span><br><span class="line">    download_result(job_id)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;finish&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于containerd目前的使用是直接把所有容器的输出定为stdout，并没有用类似nerdctl支持-d和logs。这样会把python程序的输出都直接放到屏幕上，这样也方便观察结果，可以认为是个feature。</p>
<p>如果源数据文件比较大，scp上传需要花不少时间</p>
<h2 id="CUDA程序"><a href="#CUDA程序" class="headerlink" title="CUDA程序"></a>CUDA程序</h2><p>交我算只适合提交自己确认正确的程序，因为几乎全是pending，完全无法动态调试。每天晚上十一点之后会稍微好一点。</p>
<p><a target="_blank" rel="noopener" href="https://colab.research.google.com/github/hussain0048/C-Plus-Plus/blob/master/Basic_of_C%2B%2B.ipynb">Google Colab</a>用这个可以有cuda环境来调试</p>
<p>由于希望支持的GPU应用是有意义的，所以需要满足两点：</p>
<ol>
<li>数据量大</li>
<li>由用户自己提供输入，以文件形式获得输出</li>
</ol>
<p>故添加文件输入输出模块，并提前准备好测试数据。</p>
<p>为了编译任务快速结束以便展示并且减轻交我算平台的压力，这里还是选择只使用10000*10000的矩阵</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;files.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 10000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> size = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)N*N*<span class="keyword">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">  <span class="type">double</span> *a = (<span class="type">double</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="type">double</span> *b = (<span class="type">double</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )&#123;</span><br><span class="line">      a[row*N + col] = row;</span><br><span class="line">      b[row*N + col] = col+<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  write_values_to_file(<span class="string">&quot;matrix_a_data&quot;</span>,a,size);</span><br><span class="line">  write_values_to_file(<span class="string">&quot;matrix_b_data&quot;</span>,b,size);</span><br><span class="line"></span><br><span class="line">  read_values_from_file(<span class="string">&quot;matrix_a_data&quot;</span>,a,size);</span><br><span class="line">  read_values_from_file(<span class="string">&quot;matrix_b_data&quot;</span>,b,size);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )&#123;</span><br><span class="line">      <span class="keyword">if</span>(a[row*N + col] != row ||b[row*N + col] != col+<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;generate data success\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="矩阵加法"><a href="#矩阵加法" class="headerlink" title="矩阵加法"></a>矩阵加法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;files.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_CORRECTNESS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N  10000</span></span><br><span class="line"></span><br><span class="line">__global__ <span class="type">void</span> <span class="title function_">matrixAddGPU</span><span class="params">( <span class="type">double</span> * a, <span class="type">double</span> * b, <span class="type">double</span> * c )</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> row_begin = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> col_begin = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">  <span class="type">int</span> stride_row = gridDim.x * blockDim.x;</span><br><span class="line">  <span class="type">int</span> stride_col = gridDim.y * blockDim.y;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> row = row_begin; row &lt; N ;row += stride_row) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> col= col_begin; col&lt; N ; col+= stride_col) &#123;</span><br><span class="line">                c[row * N + col] = a[row*N+col] + b[row*N+col];</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">matrixAddCPU</span><span class="params">( <span class="type">double</span> * a, <span class="type">double</span> * b, <span class="type">double</span> * c )</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      c[row * N + col] = a[row*N+col]+b[row*N+col];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        cudaError_t cudaStatus;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> deviceId;</span><br><span class="line">  <span class="type">int</span> numberOfSMs;</span><br><span class="line"></span><br><span class="line">  cudaGetDevice(&amp;deviceId);</span><br><span class="line">  cudaDeviceGetAttribute(&amp;numberOfSMs, cudaDevAttrMultiProcessorCount, deviceId);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;SM:%d\n&quot;</span>,numberOfSMs);<span class="comment">//80</span></span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> *a, *b, *c_gpu;</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> size = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)N * N * <span class="keyword">sizeof</span> (<span class="type">double</span>); <span class="comment">// Number of bytes of an N x N matrix</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate memory</span></span><br><span class="line">  cudaMallocManaged (&amp;a, size);</span><br><span class="line">  cudaMallocManaged (&amp;b, size);</span><br><span class="line">  cudaMallocManaged (&amp;c_gpu, size);</span><br><span class="line">  read_values_from_file(<span class="string">&quot;matrix_a_data&quot;</span>, a, size);</span><br><span class="line">  read_values_from_file(<span class="string">&quot;matrix_b_data&quot;</span>, b, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//if too large,invalid configuration argument</span></span><br><span class="line">  dim3 <span class="title function_">threads_per_block</span><span class="params">(<span class="number">32</span>,<span class="number">32</span>,<span class="number">1</span>)</span>;</span><br><span class="line">  dim3 <span class="title function_">number_of_blocks</span> <span class="params">(<span class="number">16</span>*numberOfSMs,<span class="number">16</span>*numberOfSMs, <span class="number">1</span>)</span>;</span><br><span class="line">  cudaMemPrefetchAsync(a, size, deviceId);</span><br><span class="line">  cudaMemPrefetchAsync(b, size, deviceId);</span><br><span class="line">  cudaMemPrefetchAsync(c_gpu, size, deviceId);</span><br><span class="line">  matrixAddGPU &lt;&lt;&lt; number_of_blocks, threads_per_block &gt;&gt;&gt; ( a, b, c_gpu );</span><br><span class="line">        cudaStatus = cudaGetLastError();</span><br><span class="line">        <span class="keyword">if</span> (cudaStatus != cudaSuccess) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;call matrixAddGPU error: %s\n&quot;</span>, cudaGetErrorString(cudaStatus));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  cudaDeviceSynchronize(); <span class="comment">// Wait for the GPU to finish before proceeding</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the CPU version to check our work</span></span><br><span class="line">    <span class="comment">// Compare the two answers to make sure they are equal</span></span><br><span class="line">  <span class="type">bool</span> error = <span class="literal">false</span>;</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> CHECK_CORRECTNESS</span></span><br><span class="line">    <span class="type">double</span> *c_cpu;</span><br><span class="line">    cudaMallocManaged (&amp;c_cpu, size);</span><br><span class="line">    matrixAddCPU( a, b, c_cpu );</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N &amp;&amp; !error; ++row )</span><br><span class="line">      <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N &amp;&amp; !error; ++col )</span><br><span class="line">        <span class="keyword">if</span> (c_cpu[row * N + col] != c_gpu[row * N + col])</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;FOUND ERROR at c[%d][%d]\n&quot;</span>, row, col);</span><br><span class="line">          error = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    cudaFree( c_cpu );</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (!error)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Success!\n&quot;</span>);</span><br><span class="line">  write_values_to_file(<span class="string">&quot;result/matrix_c_data&quot;</span>, c_gpu, size);</span><br><span class="line">  <span class="comment">// Free all our allocated memory</span></span><br><span class="line">  cudaFree(a);</span><br><span class="line">  cudaFree(b);</span><br><span class="line">  cudaFree( c_gpu );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="矩阵乘法"><a href="#矩阵乘法" class="headerlink" title="矩阵乘法"></a>矩阵乘法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;files.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_CORRECTNESS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N  10000</span></span><br><span class="line"></span><br><span class="line">__global__ <span class="type">void</span> <span class="title function_">matrixMulGPU</span><span class="params">( <span class="type">double</span> * a, <span class="type">double</span> * b, <span class="type">double</span> * c )</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> row_begin = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> col_begin = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">  <span class="type">int</span> stride_row = gridDim.x * blockDim.x;</span><br><span class="line">  <span class="type">int</span> stride_col = gridDim.y * blockDim.y;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> row = row_begin; row &lt; N ;row += stride_row) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> col= col_begin; col&lt; N ; col+= stride_col) &#123;</span><br><span class="line">                <span class="type">double</span> val = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> k = <span class="number">0</span>; k &lt; N; ++k )&#123;</span><br><span class="line">                        val += a[row * N + k] * b[k * N + col];</span><br><span class="line">                        c[row * N + col] = val;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">matrixMulCPU</span><span class="params">( <span class="type">double</span> * a, <span class="type">double</span> * b, <span class="type">double</span> * c )</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">double</span> val = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( <span class="type">int</span> k = <span class="number">0</span>; k &lt; N; ++k )</span><br><span class="line">        val += a[row * N + k] * b[k * N + col];</span><br><span class="line">      c[row * N + col] = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        cudaError_t cudaStatus;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> deviceId;</span><br><span class="line">  <span class="type">int</span> numberOfSMs;</span><br><span class="line"></span><br><span class="line">  cudaGetDevice(&amp;deviceId);</span><br><span class="line">  cudaDeviceGetAttribute(&amp;numberOfSMs, cudaDevAttrMultiProcessorCount, deviceId);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;SM:%d\n&quot;</span>,numberOfSMs);<span class="comment">//80</span></span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> *a, *b, *c_gpu;</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> size = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)N * N * <span class="keyword">sizeof</span> (<span class="type">double</span>); <span class="comment">// Number of bytes of an N x N matrix</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate memory</span></span><br><span class="line">  cudaMallocManaged (&amp;a, size);</span><br><span class="line">  cudaMallocManaged (&amp;b, size);</span><br><span class="line">  cudaMallocManaged (&amp;c_gpu, size);</span><br><span class="line">  read_values_from_file(<span class="string">&quot;matrix_a_data&quot;</span>, a, size);</span><br><span class="line">  read_values_from_file(<span class="string">&quot;matrix_b_data&quot;</span>, b, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//if too large,invalid configuration argument</span></span><br><span class="line">  dim3 <span class="title function_">threads_per_block</span><span class="params">(<span class="number">32</span>,<span class="number">32</span>,<span class="number">1</span>)</span>;</span><br><span class="line">  dim3 <span class="title function_">number_of_blocks</span> <span class="params">(<span class="number">16</span>*numberOfSMs,<span class="number">16</span>*numberOfSMs, <span class="number">1</span>)</span>;</span><br><span class="line">  cudaMemPrefetchAsync(a, size, deviceId);</span><br><span class="line">  cudaMemPrefetchAsync(b, size, deviceId);</span><br><span class="line">  cudaMemPrefetchAsync(c_gpu, size, deviceId);</span><br><span class="line">  matrixMulGPU &lt;&lt;&lt; number_of_blocks, threads_per_block &gt;&gt;&gt; ( a, b, c_gpu );</span><br><span class="line">        cudaStatus = cudaGetLastError();</span><br><span class="line">        <span class="keyword">if</span> (cudaStatus != cudaSuccess) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;call matrixAddGPU error: %s\n&quot;</span>, cudaGetErrorString(cudaStatus));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  cudaDeviceSynchronize(); <span class="comment">// Wait for the GPU to finish before proceeding</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the CPU version to check our work</span></span><br><span class="line">    <span class="comment">// Compare the two answers to make sure they are equal</span></span><br><span class="line">  <span class="type">bool</span> error = <span class="literal">false</span>;</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> CHECK_CORRECTNESS</span></span><br><span class="line">    <span class="type">double</span> *c_cpu;</span><br><span class="line">    cudaMallocManaged (&amp;c_cpu, size);</span><br><span class="line">    matrixMulCPU( a, b, c_cpu );</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N &amp;&amp; !error; ++row )</span><br><span class="line">      <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N &amp;&amp; !error; ++col )</span><br><span class="line">        <span class="keyword">if</span> (c_cpu[row * N + col] != c_gpu[row * N + col])</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;FOUND ERROR at c[%d][%d]\n&quot;</span>, row, col);</span><br><span class="line">          error = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    cudaFree( c_cpu );</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (!error)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Success!\n&quot;</span>);</span><br><span class="line">  write_values_to_file(<span class="string">&quot;result/matrix_c_data&quot;</span>, c_gpu, size);</span><br><span class="line">  <span class="comment">// Free all our allocated memory</span></span><br><span class="line">  cudaFree(a);</span><br><span class="line">  cudaFree(b);</span><br><span class="line">  cudaFree( c_gpu );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">build:</span></span><br><span class="line">        nvcc -o matrix-mul matrix-mul.cu -I .</span><br><span class="line"><span class="section">run:</span></span><br><span class="line">        ./matrix-mul</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>-I 表示在当前目录寻找include的头文件</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://szy0127.github.io/2024/09/17/misc/CICD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="szy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="S blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | S blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/misc/CICD/" class="post-title-link" itemprop="url">CI/CD</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-17 19:48:03" itemprop="dateCreated datePublished" datetime="2024-09-17T19:48:03+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>543</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CI-CD"><a href="#CI-CD" class="headerlink" title="CI&#x2F;CD"></a>CI&#x2F;CD</h1><h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><p><a target="_blank" rel="noopener" href="https://jiuaidu.com/jianzhan/1046052/">go 覆盖测试工具介绍 - 建站教程 (jiuaidu.com)</a></p>
<p><code>go test ./...</code>可以测试目录下所有的test文件</p>
<p><code>go test minik8s/pkg/kubelet/container</code> 测试指定包下的测试文件</p>
<h3 id="gitlab-runner"><a href="#gitlab-runner" class="headerlink" title="gitlab runner"></a>gitlab runner</h3><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><p><code>docker run -d --name gitlab-runner --restart always   -v /srv/gitlab-runner/config:/etc/gitlab-runner   -v /var/run/docker.sock:/var/run/docker.sock   gitlab/gitlab-runner:v15.10.1</code></p>
<p>执行器选择docker 这里镜像需要先在主机上写Dockerfile手动构建好，然后修改<code>config.toml</code>配置文件把<code>pull_policy</code>修改为<code>if-not-present</code></p>
<p>对于简单测试没问题，但是对于CNI这种复杂的东西，即使加了privilege&#x3D;true，还是会出现和宿主机上不一样的情况。</p>
<h4 id="host"><a href="#host" class="headerlink" title="host"></a>host</h4><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/">Install GitLab Runner | GitLab</a></p>
<p>交大云主机安装二进制</p>
<p><code>nslookup www.ipads.sjtu.edu.cn</code> 安全组开放所有端口</p>
<p><code>gitlab-runner register</code> 去gitlab网页的settings&#x2F;cicd复制url和token</p>
<p>执行器选择shell 在主机上给gitlab-runner用户足够的权限</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39940674/article/details/127616784">【汇总】解决GitLab-Runner执行脚本命令无权限_gitlab-runner 提升权限_成为大佬先秃头的博客-CSDN博客</a></p>
<p>采用这种方法进行CI&#x2F;CD，gitlab-runner会在主机上的某个目录跑脚本，用的都是主机的环境</p>
<ul>
<li>优点：不需要手动配一个拥有所有环境的镜像；没有容器导致的与主机不一致，跑不起来的情况。</li>
<li>缺点：会对主机产生影响；在缺少依赖的情况下无法更换gitlab-runner所在主机。</li>
</ul>
<h3 id="gitlab-ci-yml"><a href="#gitlab-ci-yml" class="headerlink" title=".gitlab-ci.yml"></a>.gitlab-ci.yml</h3><ol>
<li><p>prepare: 设置go env，防止go test在download时超时</p>
</li>
<li><p>test：<code>go test</code> 如果测试涉及到的api需要权限，需要加sudo</p>
<p>创建多个tag为shell的runner，使test阶段并行测试 （目前一共3个）</p>
<p>需要修改手动<code>/etc/gitlab-runner/config.toml</code>的concurrent为3</p>
</li>
<li><p>build：<code>go build</code> 生成可执行文件在<code>/home/gitlab-runner/$CI_COMMIT_BRANCH/</code>目录下</p>
<p>不同分支build出的文件不会互相覆盖</p>
</li>
</ol>
<h3 id="代码同步"><a href="#代码同步" class="headerlink" title="代码同步"></a>代码同步</h3><p>同时推送到gitee和gitlab，不然无法用gitlab-runner</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hmy-666/p/17304317.html">git push origin master一次提交多个远程仓库 - 兜里还剩五块出头 - 博客园 (cnblogs.com)</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@minik8s-1:/mini-k8s# git remote -v</span><br><span class="line">origin  https://gitee.com/szy_0127/mini-k8s.git (fetch)</span><br><span class="line">origin  https://gitee.com/szy_0127/mini-k8s.git (push)</span><br><span class="line">origin  https://ipads.se.sjtu.edu.cn:2020/520021910933/minik8s.git (push)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">szy</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">69k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">4:09</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
